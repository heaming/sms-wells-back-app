<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.competence.education.mapper.WpsbOnlineLinkCourseInqrMapper">

    <select id="selectOnlineLinkCourseInqrPages" resultType="com.kyowon.sms.wells.web.competence.education.dto.WpsbOnlineLinkCourseInqrDto$SearchRes">
        SELECT T4.OG_ID
	    	 , T4.OG_CD
             , T4.OG_NM
             , T4.DGR1_LEVL_OG_NM
             , T4.DGR2_LEVL_OG_NM
             , T4.DGR3_LEVL_OG_NM
             , T4.PRTNR_NO
             , T4.PRTNR_KNM
          FROM
      	     ( SELECT S1.OG_ID
                    , S1.EDUC_CRSE_DTL_ID
                    , S1.EDUC_CRSE_TCNT
                    , S2.EDUC_CRSE_NO
                    , S3.OG_TP_CD
                    , S3.EDUC_NM
                    , S3.EDUC_SBJ_CD
                    , S2.EDUC_CRSE_CRT_BASE_YM
                    , S3.EDUC_CRSE_MAX_TCNT
                 FROM TB_PSCA_EDUC_CRSE_DTL S1
                INNER JOIN TB_PSCA_EDUC_CRSE_BAS S2
                   ON S1.EDUC_CRSE_ID = S2.EDUC_CRSE_ID
                  AND S2.DTA_DL_YN = 'N'
                INNER JOIN TB_PSCA_EDUC_SBJ_CD_MNGT_BAS S3
                   ON S3.OG_TP_CD = S2.OG_TP_CD
                  AND S3.EDUC_SBJ_CD = S2.EDUC_CRSE_NO
                  AND S3.DTA_DL_YN = 'N'
                WHERE 1=1
		  	      AND S1.DTA_DL_YN = 'N'
                  <if test='@MybatisUtils@isNotEmpty(ogTpCd)'>
                  AND S2.OG_TP_CD = #{ogTpCd}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(educSchdYm)'>
                  AND S2.EDUC_CRSE_CRT_BASE_YM = #{educSchdYm}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(educCrseId)'>
                  AND S2.EDUC_CRSE_ID = #{educCrseId}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(educDvCd)'>
                  AND S3.EDUC_DV_CD = #{educDvCd}
                  </if>
		      ) T1
         INNER JOIN TB_PSCA_EDUC_RLPPL_BAS T2
            ON T2.EDUC_CRSE_DTL_ID = T1.EDUC_CRSE_DTL_ID
      	   AND T2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_PSCA_MCPTN_EDUC_IZ T3
            ON T3.OG_TP_CD = T1.OG_TP_CD
           AND T3.EDUC_CRSE_NO = T1.EDUC_SBJ_CD
           AND T3.PRTNR_NO = T2.EDUC_RLPPL_PRTNR_NO
           AND T3.DTA_DL_YN = 'N'
           <if test='@MybatisUtils@isNotEmpty(educSchdYm)'>
           AND T3.EDUC_CRSE_CRT_BASE_YM = #{educSchdYm}
           </if>
         INNER JOIN
             ( SELECT S1.BASE_YM
                    , CASE WHEN S1.OG_TP_CD = 'E01' THEN NVL(S1.DGR3_LEVL_OG_ID, S1.OG_ID)
                           WHEN S1.OG_TP_CD = 'E03' THEN NVL(S1.DGR2_LEVL_OG_ID, S1.OG_ID)
                           ELSE S1.OG_ID ENd AS OG_ID
                    , S1.OG_TP_CD
                    , S1.OG_CD
                    , S1.OG_NM
                    , S1.DGR1_LEVL_OG_NM
                    , S1.DGR2_LEVL_OG_NM
                    , S1.DGR3_LEVL_OG_NM
                    , S1.DGR4_LEVL_OG_NM
                    , S1.DGR5_LEVL_OG_NM
                    , S2.PRTNR_NO
                    , S2.PRTNR_KNM
                 FROM TB_OGBS_MM_OG_IZ S1
                INNER JOIN TB_OGBS_MM_PRTNR_IZ S2
                   ON S2.BASE_YM = S1.BASE_YM
                  AND S2.OG_TP_CD = S1.OG_TP_CD
                  AND S2.OG_ID = S1.OG_ID
                  AND S2.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN TB_OGBS_PRTNR_BAS S3
                   ON S2.OG_TP_CD = S3.OG_TP_CD
                  AND S2.PRTNR_NO = S3.PRTNR_NO
                WHERE S1.DTA_DL_YN = 'N'
                  <if test='@MybatisUtils@isNotEmpty(educSchdYm)'>
                  AND S1.BASE_YM = #{educSchdYm}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd1)'>
                  AND S1.DGR1_LEVL_OG_ID = #{ogLevlDvCd1}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd2)'>
                  AND S1.DGR2_LEVL_OG_ID = #{ogLevlDvCd2}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd3)'>
                  AND S1.DGR3_LEVL_OG_ID = #{ogLevlDvCd3}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                  AND S2.PRTNR_NO = #{prtnrNo}
                  </if>
              ) T4
            ON T4.PRTNR_NO = T2.EDUC_RLPPL_PRTNR_NO
           AND T4.BASE_YM = T1.EDUC_CRSE_CRT_BASE_YM
           AND T4.OG_TP_CD = T1.OG_TP_CD
           AND T1.OG_ID = T4.OG_ID
         WHERE 1=1
           <if test='@MybatisUtils@isNotEmpty(educSchdYm)'>
           AND T1.EDUC_CRSE_CRT_BASE_YM = #{educSchdYm}
           </if>
           <if test="@MybatisUtils@isNotEmpty(educCpcAckmtYn) and @MybatisUtils@equals(educCpcAckmtYn, 'Y') ">
           AND T3.EDUC_CPC_ACKMT_YN = #{educCpcAckmtYn}
           </if>
    </select>
</mapper>
