<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.competence.business.mapper.WpsfRuleBaseMgtMapper">
    <select id="selectRuleBaseMgtPages" resultType="com.kyowon.sms.wells.web.competence.business.dto.WpsfRuleBaseMgtDto$SearchRes">
        SELECT T1.BZNS_SPPT_MNAL_ID      /* 영업지원매뉴얼ID */
             , T1.HGR_BZNS_SPPT_MNAL_ID  /* 상위영업지원매뉴얼ID */
             , T1.VL_STRT_DTM            /* 유효시작일시 */
             , T1.VL_END_DTM             /* 유효종료일시 */
             , T1.BZNS_SPPT_MNAL_NM      /* 영업지원매뉴얼명 */
             , T1.BZNS_SPPT_MNAL_RGST_CD /* 영업지원매뉴얼등록코드 */
             , T1.BZNS_SPPT_MNAL_CH_CN   /* 영업지원매뉴얼변경내용 */
             , T1.BZNS_SPPT_MNAL_MPBL_DV_CD
             , T1.MNAL_RGH_REL_ID        /* 매뉴얼권한관계ID */
             , T1.INQR_LV_TCNT           /* 조회단계차수 */
             , T1.EXPSR_ODR              /* 노출순서 */
             , T1.APN_FILE_DOC_ID        /* 첨부파일문서ID */
             , T1.ORG_PATH
             , T1.BZNS_SPPT_MNAL_ID||T1.HGR_BZNS_SPPT_MNAL_ID||T1.EXPSR_ODR AS UNN_KEY
             , (SELECT USR_NM FROM T_CMP_USR_ACO_M WHERE USR_ID = T1.FNL_MDFC_USR_ID AND DEL_YN = 'N') AS FNL_MDFC_USR_NM
             , TO_CHAR(TO_DATE(T1.FNL_MDFC_DTM,'YYYYMMDDHH24MISS'),'YYYY-MM-DD HH24:MI:SS') AS FNL_MDFC_DT /* 최종수정일자 [수정일] */
             , T2.FILE_UID
          FROM
             ( SELECT S1.BZNS_SPPT_MNAL_ID      /* 영업지원매뉴얼ID */
                    , S1.HGR_BZNS_SPPT_MNAL_ID  /* 상위영업지원매뉴얼ID */
                    , S1.VL_STRT_DTM            /* 유효시작일시 */
                    , S1.VL_END_DTM             /* 유효종료일시 */
                    , S1.BZNS_SPPT_MNAL_NM      /* 영업지원매뉴얼명 */
                    , S1.BZNS_SPPT_MNAL_RGST_CD /* 영업지원매뉴얼등록코드 */
                    , S1.BZNS_SPPT_MNAL_CH_CN   /* 영업지원매뉴얼변경내용 */
                    , S1.BZNS_SPPT_MNAL_MPBL_DV_CD
                    , S1.MNAL_RGH_REL_ID        /* 매뉴얼권한관계ID */
                    , S1.INQR_LV_TCNT           /* 조회단계차수 */
                    , S1.EXPSR_ODR              /* 노출순서 */
                    , S1.APN_FILE_DOC_ID        /* 첨부파일문서ID */
                    , SUBSTR(SYS_CONNECT_BY_PATH(S1.HGR_BZNS_SPPT_MNAL_ID, '.'),2)||'.'||S1.BZNS_SPPT_MNAL_ID AS ORG_PATH
                    , S1.FNL_MDFC_DTM
                    , S1.FNL_MDFC_USR_ID
                 FROM
                    ( SELECT BZNS_SPPT_MNAL_ID      /* 영업지원매뉴얼ID */
                           , HGR_BZNS_SPPT_MNAL_ID  /* 상위영업지원매뉴얼ID */
                           , VL_STRT_DTM            /* 유효시작일시 */
                           , VL_END_DTM             /* 유효종료일시 */
                           , BZNS_SPPT_MNAL_NM      /* 영업지원매뉴얼명 */
                           , BZNS_SPPT_MNAL_RGST_CD /* 영업지원매뉴얼등록코드 */
                           , BZNS_SPPT_MNAL_CH_CN   /* 영업지원매뉴얼변경내용 */
                           , BZNS_SPPT_MNAL_MPBL_DV_CD
                           , MNAL_RGH_REL_ID        /* 매뉴얼권한관계ID */
                           , INQR_LV_TCNT           /* 조회단계차수 */
                           , EXPSR_ODR /* 노출순서 */
                           , APN_FILE_DOC_ID        /* 첨부파일문서ID */
                           , FNL_MDFC_DTM
                           , FNL_MDFC_USR_ID
                        FROM TB_PSGA_BZNS_SPPT_MNAL_BAS
                       WHERE DTA_DL_YN = 'N'
                         <if test='@MybatisUtils@isNotEmpty(urgnYn) and @MybatisUtils@equals("Y", urgnYn)'>
                         AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN VL_STRT_DTM AND VL_END_DTM
                         </if>
                    ) S1
                WHERE 1=1
                START WITH S1.BZNS_SPPT_MNAL_ID = '00000'
              CONNECT BY PRIOR S1.BZNS_SPPT_MNAL_ID = S1.HGR_BZNS_SPPT_MNAL_ID
             )   T1
          LEFT OUTER JOIN T_CMD_ATTH_FILE_D T2
            ON T2.ATTH_DOC_ID = T1.APN_FILE_DOC_ID
           AND T2.DEL_YN = 'N'
         WHERE 1=1
           AND HGR_BZNS_SPPT_MNAL_ID != 'ROOT'
         ORDER BY HGR_BZNS_SPPT_MNAL_ID, EXPSR_ODR, BZNS_SPPT_MNAL_ID  ASC, VL_STRT_DTM DESC
    </select>

    <select id="selectRuleBase" resultType="com.kyowon.sms.wells.web.competence.business.dto.WpsfRuleBaseMgtDto$SearchRes">
        SELECT T1.BZNS_SPPT_MNAL_ID      /* 영업지원매뉴얼ID */
             , T1.HGR_BZNS_SPPT_MNAL_ID  /* 상위영업지원매뉴얼ID */
             , T1.VL_STRT_DTM            /* 유효시작일시 */
             , T1.VL_END_DTM             /* 유효종료일시 */
             , T1.BZNS_SPPT_MNAL_NM      /* 영업지원매뉴얼명 */
             , T1.BZNS_SPPT_MNAL_RGST_CD /* 영업지원매뉴얼등록코드 */
             , T1.BZNS_SPPT_MNAL_CH_CN   /* 영업지원매뉴얼변경내용 */
             , T1.BZNS_SPPT_MNAL_MPBL_DV_CD
             , T1.MNAL_RGH_REL_ID        /* 매뉴얼권한관계ID */
             , T1.INQR_LV_TCNT           /* 조회단계차수 */
             , T1.EXPSR_ODR              /* 노출순서 */
             , T1.APN_FILE_DOC_ID        /* 첨부파일문서ID */
             , T1.ORG_PATH
             , T1.BZNS_SPPT_MNAL_ID||T1.HGR_BZNS_SPPT_MNAL_ID||T1.EXPSR_ODR AS UNN_KEY
             , (SELECT USR_NM FROM T_CMP_USR_ACO_M WHERE USR_ID = T1.FNL_MDFC_USR_ID AND DEL_YN = 'N') AS FNL_MDFC_USR_NM
             , TO_CHAR(TO_DATE(T1.FNL_MDFC_DTM,'YYYYMMDDHH24MISS'),'YYYY-MM-DD HH24:MI:SS') AS FNL_MDFC_DT /* 최종수정일자 [수정일] */
             , T2.FILE_UID
          FROM
             ( SELECT S1.BZNS_SPPT_MNAL_ID      /* 영업지원매뉴얼ID */
                    , S1.HGR_BZNS_SPPT_MNAL_ID  /* 상위영업지원매뉴얼ID */
                    , S1.VL_STRT_DTM            /* 유효시작일시 */
                    , S1.VL_END_DTM             /* 유효종료일시 */
                    , S1.BZNS_SPPT_MNAL_NM      /* 영업지원매뉴얼명 */
                    , S1.BZNS_SPPT_MNAL_RGST_CD /* 영업지원매뉴얼등록코드 */
                    , S1.BZNS_SPPT_MNAL_CH_CN   /* 영업지원매뉴얼변경내용 */
                    , S1.BZNS_SPPT_MNAL_MPBL_DV_CD
                    , S1.MNAL_RGH_REL_ID        /* 매뉴얼권한관계ID */
                    , S1.INQR_LV_TCNT           /* 조회단계차수 */
                    , S1.EXPSR_ODR              /* 노출순서 */
                    , S1.APN_FILE_DOC_ID        /* 첨부파일문서ID */
                    , SUBSTR(SYS_CONNECT_BY_PATH(S1.HGR_BZNS_SPPT_MNAL_ID, '.'),2)||'.'||S1.BZNS_SPPT_MNAL_ID AS ORG_PATH
                    , S1.FNL_MDFC_DTM
                    , S1.FNL_MDFC_USR_ID
                 FROM
                    ( SELECT BZNS_SPPT_MNAL_ID      /* 영업지원매뉴얼ID */
                           , HGR_BZNS_SPPT_MNAL_ID  /* 상위영업지원매뉴얼ID */
                           , VL_STRT_DTM            /* 유효시작일시 */
                           , VL_END_DTM             /* 유효종료일시 */
                           , BZNS_SPPT_MNAL_NM      /* 영업지원매뉴얼명 */
                           , BZNS_SPPT_MNAL_RGST_CD /* 영업지원매뉴얼등록코드 */
                           , BZNS_SPPT_MNAL_CH_CN   /* 영업지원매뉴얼변경내용 */
                           , BZNS_SPPT_MNAL_MPBL_DV_CD
                           , MNAL_RGH_REL_ID        /* 매뉴얼권한관계ID */
                           , INQR_LV_TCNT           /* 조회단계차수 */
                           , EXPSR_ODR /* 노출순서 */
                           , APN_FILE_DOC_ID        /* 첨부파일문서ID */
                           , FNL_MDFC_DTM
                           , FNL_MDFC_USR_ID
                        FROM TB_PSGA_BZNS_SPPT_MNAL_BAS T1
                       WHERE DTA_DL_YN = 'N'
                         <if test='@MybatisUtils@isNotEmpty(urgnYn) and @MybatisUtils@equals("Y", urgnYn)'>
                         AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN VL_STRT_DTM AND VL_END_DTM
                         </if>
                         AND ( BZNS_SPPT_MNAL_MPBL_DV_CD = '1'
                               OR
                               'Y' = #{session.dataFullAuthYn}
                               OR
                               EXISTS( SELECT 1
                                         FROM TB_PSGA_BZNS_SPPT_MNAL_RGH_REL S1
                                        INNER JOIN
                                            ( SELECT C.RSB_DV_CD, C.OG_TP_CD
                                                FROM T_CMP_USR_ACO_M A
                                               INNER JOIN TB_OGBS_PRTNR_BAS B
                                                  ON A.EPNO = B.PRTNR_NO
                                               INNER JOIN TB_OGBS_MM_PRTNR_IZ C
                                                  ON B.PRTNR_NO = C.PRTNR_NO
                                                 AND B.OG_TP_CD = C.OG_TP_CD
                                                 AND C.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                                               WHERE A.EPNO = #{session.employeeIDNumber}
                                            ) S2
                                           ON S1.RSB_DV_CD = S2.RSB_DV_CD
                                          AND S1.OG_TP_CD = S2.OG_TP_CD
                                        WHERE S1.BZNS_SPPT_MNAL_ID = T1.BZNS_SPPT_MNAL_ID)
                             )
                    ) S1
                WHERE 1=1
                START WITH S1.BZNS_SPPT_MNAL_ID = '00000'
              CONNECT BY PRIOR S1.BZNS_SPPT_MNAL_ID = S1.HGR_BZNS_SPPT_MNAL_ID
             )   T1
          LEFT OUTER JOIN T_CMD_ATTH_FILE_D T2
            ON T2.ATTH_DOC_ID = T1.APN_FILE_DOC_ID
           AND T2.DEL_YN = 'N'
         WHERE 1=1
           AND HGR_BZNS_SPPT_MNAL_ID != 'ROOT'
         ORDER BY HGR_BZNS_SPPT_MNAL_ID, EXPSR_ODR, BZNS_SPPT_MNAL_ID ASC
    </select>

    <insert id="insertRuleBase">
        <selectKey keyProperty="dvo.bznsSpptMnalId" resultType="String" order="BEFORE">
            SELECT CASE WHEN #{dvo.bznsSpptMnalId} IS NULL THEN ( SELECT LPAD(MAX(BZNS_SPPT_MNAL_ID)+1,5,0) FROM TB_PSGA_BZNS_SPPT_MNAL_BAS )
                   ELSE #{dvo.bznsSpptMnalId} END
            FROM DUAL
        </selectKey>

        INSERT INTO TB_PSGA_BZNS_SPPT_MNAL_BAS (  /* 영업지원매뉴얼기본 */
              BZNS_SPPT_MNAL_ID      /* 영업지원매뉴얼ID */
            , VL_STRT_DTM            /* 유효시작일시 */
            , VL_END_DTM             /* 유효종료일시 */
            , BZNS_SPPT_MNAL_NM      /* 영업지원매뉴얼명 */
            , HGR_BZNS_SPPT_MNAL_ID  /* 상위영업지원매뉴얼ID */
            , BZNS_SPPT_MNAL_RGST_CD /* 영업지원매뉴얼등록코드 */
            , BZNS_SPPT_MNAL_CH_CN   /* 영업지원매뉴얼변경내용 */
            , BZNS_SPPT_MNAL_MPBL_DV_CD /* 영업지원매뉴얼공개구분코드 */
            , MNAL_RGH_REL_ID        /* 매뉴얼권한관계ID */
            , INQR_LV_TCNT           /* 조회단계차수 */
            , EXPSR_ODR              /* 노출순서 */
            , APN_FILE_DOC_ID        /* 첨부파일문서ID */
            , DTA_DL_YN              /* 데이터삭제여부 */
            <include refid="COMMON.insertSystemField" />
       ) VALUES (
              #{dvo.bznsSpptMnalId}
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , '99991231235959'
            , #{dvo.bznsSpptMnalNm}
            , #{dvo.hgrBznsSpptMnalId}
            , #{dvo.bznsSpptMnalRgstCd}
            , #{dvo.bznsSpptMnalChCn}
            , #{dvo.bznsSpptMnalMpblDvCd}
            , #{dvo.bznsSpptMnalId}
            , #{dvo.inqrLvTcnt}
            , #{dvo.expsrOdr}
            , #{dvo.hgrBznsSpptMnalId}||#{dvo.bznsSpptMnalId}
            , 'N'
            <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <update id="updateRuleBase">
        UPDATE TB_PSGA_BZNS_SPPT_MNAL_BAS /* 영업지원매뉴얼기본 */
           SET VL_END_DTM             = #{vlEndDtm}              /* 유효종료일시 */
             , BZNS_SPPT_MNAL_NM      = #{bznsSpptMnalNm}        /* 영업지원매뉴얼명 */
             , BZNS_SPPT_MNAL_RGST_CD = #{bznsSpptMnalRgstCd}    /* 영업지원매뉴얼등록코드 */
             , BZNS_SPPT_MNAL_CH_CN   = #{bznsSpptMnalChCn}      /* 영업지원매뉴얼변경내용 */
             , BZNS_SPPT_MNAL_MPBL_DV_CD = #{bznsSpptMnalMpblDvCd}    /* 영업지원매뉴얼공개구분코드 */
             , APN_FILE_DOC_ID        = #{apnFileDocId}          /* 첨부파일문서ID */
             , DTA_DL_YN              = #{dtaDlYn}               /* 데이터삭제여부 */
             <include refid="COMMON.updateSystemField"/>
        WHERE 1 = 1
          AND BZNS_SPPT_MNAL_ID      = #{bznsSpptMnalId}        /* 영업지원매뉴얼ID */
          AND VL_STRT_DTM            = #{vlStrtDtm}             /* 유효시작일시 */
    </update>

    <update id="updatePrevRuleBase">
        UPDATE TB_PSGA_BZNS_SPPT_MNAL_BAS /* 영업지원매뉴얼기본 */
           SET BZNS_SPPT_MNAL_RGST_CD = #{bznsSpptMnalRgstCd}
             , VL_END_DTM             = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
             <include refid="COMMON.updateSystemField"/>
        WHERE 1 = 1
          AND BZNS_SPPT_MNAL_ID      = #{bznsSpptMnalId}        /* 영업지원매뉴얼ID */
          AND HGR_BZNS_SPPT_MNAL_ID  = #{hgrBznsSpptMnalId}     /* 상위영업지원매뉴얼ID */
          AND VL_STRT_DTM            = #{vlStrtDtm}             /* 유효시작일시 */
    </update>


    <update id="updateRuleBaseEndDtm">
        UPDATE TB_PSGA_BZNS_SPPT_MNAL_BAS /* 영업지원매뉴얼기본 */
           SET VL_END_DTM             = #{vlEndDtm}              /* 유효종료일시 */
           <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND BZNS_SPPT_MNAL_ID      = #{bznsSpptMnalId}        /* 영업지원매뉴얼ID */
           AND VL_STRT_DTM            = #{vlStrtDtm}             /* 유효시작일시 */
    </update>

    <update id="updateRuleBaseTree">
        UPDATE TB_PSGA_BZNS_SPPT_MNAL_BAS /* 영업지원매뉴얼기본 */
           SET EXPSR_ODR    = #{expsrOdr}              /* 노출순서 */
             <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND BZNS_SPPT_MNAL_ID      = #{bznsSpptMnalId}        /* 영업지원매뉴얼ID */

    </update>

    <insert id="insertRuleBaseRel">
        INSERT INTO TB_PSGA_BZNS_SPPT_MNAL_RGH_REL (  /* 영업지원매뉴얼권한관계 */
              MNAL_RGH_ID
            , BZNS_SPPT_MNAL_ID     /* 영업지원매뉴얼ID */
            , VL_STRT_DTM           /* 유효시작일시 */
            , VL_END_DTM            /* 유효종료일시 */
            , OG_TP_CD              /* 조직유형코드 */
            , RSB_DV_CD             /* 직책유형코드 */
            , BZNS_SPPT_MNAL_RGH_CD /* 영업지원매뉴얼권한코드 */
            , MNAL_RGH_REL_ID       /* 매뉴얼권한관계ID */
            , DTA_DL_YN             /* 데이터삭제여부 */
            <include refid="COMMON.insertSystemField" />
          )
     SELECT ( SELECT LPAD(NVL(MAX(MNAL_RGH_ID),0)+1,5,0) FROM TB_PSGA_BZNS_SPPT_MNAL_RGH_REL ) AS MNAL_RGH_ID
          , BZNS_SPPT_MNAL_ID
          , MAX(VL_STRT_DTM)
          , MAX(VL_END_DTM)
          , #{ogTpCd}
          , #{rsbDvCd}
          , '2'
          , BZNS_SPPT_MNAL_ID
          , 'N'
          <include refid="COMMON.insertSystemFieldValue" />
       FROM TB_PSGA_BZNS_SPPT_MNAL_BAS
      WHERE BZNS_SPPT_MNAL_ID = #{bznsSpptMnalId}
      GROUP BY BZNS_SPPT_MNAL_ID
    </insert>

    <update id="deleteRuleBaseRel">
          UPDATE TB_PSGA_BZNS_SPPT_MNAL_RGH_REL /* 영업지원매뉴얼권한관계 */
           SET DTA_DL_YN             = 'Y'
            <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND BZNS_SPPT_MNAL_ID     = #{bznsSpptMnalRghCd}
    </update>

</mapper>
