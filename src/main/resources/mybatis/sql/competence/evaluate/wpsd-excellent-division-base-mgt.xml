<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.competence.evaluate.mapper.WpsdExcellentDivisionBaseMgtMapper">
    <select id="selectProductBaseMgtPages" resultType="com.kyowon.sms.wells.web.competence.evaluate.dto.WpsdExcellentDivisionBaseMgtDto$PdSearchRes">
    SELECT BASE_YM          /* 기준년월 */
         , EVL_OG_TP_CD     /* 평가조직유형코드 */
         , EVL_PD_DV_CD     /* 평가상품구분코드 */
         , PD_CD            /* 상품코드 */
         , CVT_PC           /* 환산점수 */
         , DTA_DL_YN        /* 데이터삭제여부 */
         , FST_RGST_DTM     /* 최초등록일시 */
         , FST_RGST_USR_ID  /* 최초등록사용자ID */
         , FST_RGST_PRG_ID  /* 최초등록프로그램ID */
         , FST_RGST_DEPT_ID /* 최초등록부서ID */
         , FNL_MDFC_DTM     /* 최종수정일시 */
         , FNL_MDFC_USR_ID  /* 최종수정사용자ID */
         , FNL_MDFC_PRG_ID  /* 최종수정프로그램ID */
         , FNL_MDFC_DEPT_ID /* 최종수정부서ID */
      FROM TB_PSEV_AWD_EVL_PD_BASE_BAS /* 시상평가상품기준기본 */
     WHERE DTA_DL_YN        = 'N'
       AND BASE_YM          = #{baseYm}           /* 기준년월 */
       AND EVL_OG_TP_CD     = #{evlOgTpCd}           /* 평가조직유형코드 */
       AND EVL_PD_DV_CD     = #{evlPdDvCd}        /* 평가상품구분코드 */
    </select>

    <insert id="insertProductBase">
        INSERT INTO TB_PSEV_AWD_EVL_PD_BASE_BAS (  /* 시상평가상품기준기본 */
               BASE_YM          /* 기준년월 */
             , EVL_OG_TP_CD     /* 평가조직유형코드 */
             , EVL_PD_DV_CD     /* 평가상품구분코드 */
             , PD_CD            /* 상품코드 */
             , CVT_PC           /* 환산점수 */
             , DTA_DL_YN        /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />)
        VALUES (
               #{baseYm}
             , #{evlOgTpCd}
             , #{evlPdDvCd}
             , #{pdCd}
             , #{cvtPc}
             , 'N'
             <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <update id="updateProductBase">
        UPDATE TB_PSEV_AWD_EVL_PD_BASE_BAS /* 시상평가상품기준기본 */
           SET PD_CD            = #{pdCd}             /* 상품코드 */
             , CVT_PC           = #{cvtPc}            /* 환산점수 */
            <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND BASE_YM          = #{baseYm}           /* 기준년월 */
           AND EVL_OG_TP_CD     = #{evlOgTpCd}           /* 평가조직유형코드 */
           AND EVL_PD_DV_CD     = #{evlPdDvCd}        /* 평가상품구분코드 */
    </update>

    <update id="removeProductBase">
        UPDATE TB_PSEV_AWD_EVL_PD_BASE_BAS /* 시상평가상품기준기본 */
           SET DTA_DL_YN = 'Y'
            <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND BASE_YM          = #{baseYm}           /* 기준년월 */
           AND EVL_OG_TP_CD     = #{evlOgTpCd}           /* 평가조직유형코드 */
           AND EVL_PD_DV_CD     = #{evlPdDvCd}        /* 평가상품구분코드 */
    </update>

    <select id="selectEvaluationBaseMgtPages" resultType="com.kyowon.sms.wells.web.competence.evaluate.dto.WpsdExcellentDivisionBaseMgtDto$EvlSearchRes">
		SELECT T1.BASE_YM
			 , T1.EVL_OG_TP_CD
		     , F_CMZ_CD_NM(#{session.tenantId}, 'EVL_OG_TP_CD', NVL(T1.EVL_OG_TP_CD, #{evlOgTpCd})) AS EVL_OG_TP_NM
			 , T1.AWD_EVL_ID
			 , T1.AWD_EVL_NM
			 , T1.EVL_RSB_REL_ID
			 , T1.EVL_ATC_CN
			 , T1.CTST_GRP_USE_YN
			 , T1.EVL_WTCF_USE_YN
			 , T1.AWD_EVL_GD_USE_YN
			 , T1.DTA_DL_YN
             , T1.FST_RGST_DTM
             , T1.FST_RGST_USR_ID
             , T1.FST_RGST_PRG_ID
             , T1.FST_RGST_DEPT_ID
             , T1.FNL_MDFC_DTM
             , T1.FNL_MDFC_USR_ID
             , T1.FNL_MDFC_PRG_ID
             , T1.FNL_MDFC_DEPT_ID
			 , T2.RSB_DV_NMS
		     , T2.RSB_DV_CDS
		     , T2.QLF_DV_CD
             , F_CMZ_CD_NM(#{session.tenantId}, 'QLF_DV_CD', T2.QLF_DV_CD) AS QLF_DV_NM
          FROM TB_PSEV_AWD_EVL_BASE_BAS T1 /* 시상평가기준기본 */
          LEFT OUTER JOIN
          	 ( SELECT EVL_OG_TP_CD
                    , QLF_DV_CD
					, EVL_RSB_REL_ID
          	 	    , LISTAGG(F_CMZ_CD_NM(#{session.tenantId}, 'EVL_RSB_DV_CD', EVL_RSB_DV_CD), ',') WITHIN GROUP (ORDER BY EVL_RSB_REL_ID  ) AS RSB_DV_NMS
          	        , LISTAGG(EVL_RSB_DV_CD, ',') WITHIN GROUP (ORDER BY EVL_RSB_REL_ID  ) AS RSB_DV_CDS
          	 	 FROM TB_PSEV_AWD_EVL_RSB_REL /* 시상평가직책관계 */
          	    WHERE DTA_DL_YN     = 'N'
          	      AND EVL_OG_TP_CD  = #{evlOgTpCd}
          	    GROUP BY EVL_OG_TP_CD, EVL_RSB_REL_ID, QLF_DV_CD
          	 ) T2
            ON T2.EVL_OG_TP_CD = T1.EVL_OG_TP_CD
           AND T2.EVL_RSB_REL_ID = T1.EVL_RSB_REL_ID
         WHERE 1 = 1
           AND T1.DTA_DL_YN = 'N'
           AND T1.BASE_YM = #{baseYm}
           AND T1.EVL_OG_TP_CD = #{evlOgTpCd}
		 ORDER BY T1.AWD_EVL_ID ASC
    </select>

    <insert id="insertEvaluationBase">
        <selectKey keyProperty="dvo.awdEvlId" resultType="String" order="BEFORE">
            SELECT LPAD((NVl(MAX(AWD_EVL_ID),0)+1),5,0) FROM TB_PSEV_AWD_EVL_BASE_BAS
        </selectKey>

        INSERT INTO TB_PSEV_AWD_EVL_BASE_BAS (  /* 시상평가기준기본 */
               BASE_YM
             , EVL_OG_TP_CD
             , AWD_EVL_ID
             , AWD_EVL_NM
             , EVL_RSB_REL_ID
             , EVL_ATC_CN
             , CTST_GRP_USE_YN
             , EVL_WTCF_USE_YN
             , AWD_EVL_GD_USE_YN
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField" />)
        VALUES (
               #{dvo.baseYm}
             , #{dvo.evlOgTpCd}
             , #{dvo.awdEvlId}
             , #{dvo.awdEvlNm}
             , SUBSTR(#{dvo.baseYm}, 0, 4)||'0'||#{dvo.evlOgTpCd}||#{dvo.awdEvlId}
             , #{dvo.evlAtcCn}
             , NVL(#{dvo.ctstGrpUseYn}, 'N')
             , 'N'
             , 'N'
             , 'N'
             <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <update id="updateEvaluationBase">
        UPDATE TB_PSEV_AWD_EVL_BASE_BAS /* 시상평가기준기본 */
           SET AWD_EVL_NM       = #{awdEvlNm}
             , CTST_GRP_USE_YN  = NVL(#{ctstGrpUseYn},'N')     /* 경진그룹사용여부 */
             , EVL_ATC_CN       = #{evlAtcCn}         /* 평가항목내용 */
             <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND AWD_EVL_ID       = #{awdEvlId}
    </update>

    <update id="removeEvaluationResponsibility">
        UPDATE TB_PSEV_AWD_EVL_RSB_REL
           SET DTA_DL_YN = 'Y'
               <include refid="COMMON.updateSystemField"/>
         WHERE EVL_RSB_REL_ID   =  #{evlRsbRelId}
    </update>

    <insert id="insertEvaluationResponsibility">
        <foreach item="item" collection="rsbDvCdList" separator=" " open="INSERT ALL" close="SELECT * FROM DUAL" index="idx">
            INTO TB_PSEV_AWD_EVL_RSB_REL (  /* 시상평가직책관계 */
                 EVL_OG_TP_CD     /* 평가조직유형코드 */
               , RGST_SN          /* 등록일련번호 */
               , EVL_RSB_DV_CD    /* 평가직책구분코드 */
               , QLF_DV_CD        /* 자격구분코드 */
               , EVL_RSB_REL_ID   /* 평가직책관계ID */
               , CALF_CN          /* 계산식내용 */
               , CEXP_CN          /* 조건식내용 */
               , DTA_DL_YN        /* 데이터삭제여부 */
               <include refid="COMMON.insertSystemField" />
               )
          VALUES
               ( #{evlOgTpCd}
               , (SELECT NVL(MAX(RGST_SN)+(1+#{idx}),1) FROM TB_PSEV_AWD_EVL_RSB_REL)
               , #{item}
               , #{qlfDvCd}
               , SUBSTR(#{baseYm}, 0, 4)||'0'||#{evlOgTpCd}||#{awdEvlId}
               , ( SELECT CALF_CN
                     FROM TB_PSEV_AWD_EVL_RSB_REL
                    WHERE RGST_SN = ( SELECT MAX(RGST_SN)
                                        FROM TB_PSEV_AWD_EVL_RSB_REL
                                       WHERE EVL_OG_TP_CD = #{evlOgTpCd}
                                         AND EVL_RSB_DV_CD = #{item}
                                         AND CALF_CN IS NOT NULL  ) )
               , ( SELECT CEXP_CN
                     FROM TB_PSEV_AWD_EVL_RSB_REL
                    WHERE RGST_SN = ( SELECT MAX(RGST_SN)
                                        FROM TB_PSEV_AWD_EVL_RSB_REL
                                       WHERE EVL_OG_TP_CD = #{evlOgTpCd}
                                         AND EVL_RSB_DV_CD = #{item}
                                         AND CEXP_CN IS NOT NULL  ) )
               , 'N'
               <include refid="COMMON.insertSystemFieldValue" />
               )
        </foreach>
    </insert>

    <select id="selectEvaluationDetailPages" resultType="com.kyowon.sms.wells.web.competence.evaluate.dto.WpsdExcellentDivisionBaseMgtDto$EvlDetailSearchRes">
            SELECT T1.BASE_YM          /* 기준년월 */
                 , T1.EVL_OG_TP_CD     /* 평가조직유형코드 */
                 , T1.AWD_EVL_ID       /* 시상평가ID */
                 , T1.EVL_ATC_DV_CD    /* 평가항목구분코드 */
                 , F_CMZ_CD_NM(#{session.tenantId}, 'EVL_ATC_DV_CD', T1.EVL_ATC_DV_CD) AS EVL_ATC_DV_NM
                 , T1.EVL_PD_DV_CD     /* 평가상품구분코드 */
                 , NVL(T1.EVL_BASE_UNIT_N, 0) AS EVL_BASE_UNIT_N /* 평가기준단위수 */
                 , NVL(T1.CVT_BASE_PC, 0) AS CVT_BASE_PC    /* 환산기준점수 */
                 , T1.SORT_ODR
                 , T1.DTA_DL_YN        /* 데이터삭제여부 */
                 , T2.AWD_EVL_NM
                 , T2.EVL_RSB_REL_ID
              FROM TB_PSEV_AWD_EVL_BASE_DTL T1
             INNER JOIN TB_PSEV_AWD_EVL_BASE_BAS T2
                ON T2.AWD_EVL_ID = T1.AWD_EVL_ID
               AND T2.DTA_DL_YN = 'N'
             WHERE 1 = 1
               AND T1.AWD_EVL_ID = #{awdEvlId}
               AND T1.DTA_DL_YN = 'N'
             ORDER BY T1.SORT_ODR ASC
    </select>



    <select id="selectEvaluationArticales" resultType="com.kyowon.sms.wells.web.competence.evaluate.dto.WpsdExcellentDivisionBaseMgtDto$EvlArticlesSearchRes">
        SELECT EVL_OG_TP_CD     /* 평가조직유형코드 */
             , F_CMZ_CD_NM(#{session.tenantId}, 'EVL_ATC_DV_CD', EVL_ATC_DV_CD) AS EVL_ATC_DV_NM
             , EVL_ATC_DV_CD    /* 평가항목구분코드 */
             , TRG_USE_YN       /* 목표사용여부 */
             , CALF_CN          /* 계산식내용 */
             , CEXP_CN          /* 조건식내용 */
             , EVL_ATC_CN       /* 평가항목내용 */
             , DTA_DL_YN        /* 데이터삭제여부 */
             , FST_RGST_DTM     /* 최초등록일시 */
             , FST_RGST_USR_ID  /* 최초등록사용자ID */
             , FST_RGST_PRG_ID  /* 최초등록프로그램ID */
             , FST_RGST_DEPT_ID /* 최초등록부서ID */
             , FNL_MDFC_DTM     /* 최종수정일시 */
             , FNL_MDFC_USR_ID  /* 최종수정사용자ID */
             , FNL_MDFC_PRG_ID  /* 최종수정프로그램ID */
             , FNL_MDFC_DEPT_ID /* 최종수정부서ID */
          FROM TB_PSEV_AWD_EVL_ATC_BASE_BAS /* 시상평가항목기준기본 */
         WHERE 1 = 1
           AND EVL_OG_TP_CD     = #{evlOgTpCd}        /* 평가조직유형코드 */
           AND DTA_DL_YN        ='N'
         ORDER BY EVL_ATC_DV_CD ASC
    </select>

    <select id="selectTargetBaseMgtList" resultType = "com.kyowon.sms.wells.web.competence.evaluate.dto.WpsdExcellentDivisionBaseMgtDto$TrgSearchRes">
        SELECT T1.BASE_YM
             , T1.AWD_EVL_ID
             , T1.AWD_EVL_NM
             , T1.EVL_RSB_REL_ID
             , T1.EVL_ATC_CN
             , T1.CTST_GRP_USE_YN
             , T1.EVL_WTCF_USE_YN
             , T1.AWD_EVL_GD_USE_YN
             , NVL(T2.EVL_BASE_UNIT_N,0) AS EVL_BASE_UNIT_N
             , NVL(T2.CVT_BASE_PC,0) AS CVT_BASE_PC
             , NVL(T2.SORT_ODR,0) AS SORT_ODR
             , NVL(T2.ABSLT_EVL_BASE_PC,0) AS ABSLT_EVL_BASE_PC
             , NVL(T2.PTY_EVL_MAX_PC,0) AS PTY_EVL_MAX_PC
             , NVL(T2.PTY_EVL_MIN_PC,0) AS PTY_EVL_MIN_PC
             , T2.AWD_PTY_EVL_DV_CD
             , NVL(T2.PTY_EVL_ITRV_PC,0) AS PTY_EVL_ITRV_PC
             , T3.EVL_OG_TP_CD
             , T3.EVL_ATC_DV_CD
             , F_CMZ_CD_NM(#{session.tenantId}, 'EVL_ATC_DV_CD', T2.EVL_ATC_DV_CD) AS EVL_ATC_DV_NM
             , T3.EVL_PD_DV_CD
             , T3.TRG_USE_YN
             , T4.PRTNR_NO
             , NVL(T4.TRG_BASE_PC, 0) AS TRG_BASE_PC
             , T4.CTST_GRP_CD
             , NVL(T5.PRTNR_KNM, T6.PRTNR_KNM) AS PRTNR_KNM
          FROM TB_PSEV_AWD_EVL_BASE_BAS T1
         INNER JOIN TB_PSEV_AWD_EVL_BASE_DTL T2
            ON T2.BASE_YM 		= T1.BASE_YM
           AND T2.EVL_OG_TP_CD 	= T1.EVL_OG_TP_CD
           AND T2.AWD_EVL_ID 	= T1.AWD_EVL_ID
         INNER JOIN TB_PSEV_AWD_EVL_ATC_BASE_BAS T3
            ON T3.EVL_OG_TP_CD 	= T2.EVL_OG_TP_CD
           AND T3.EVL_ATC_DV_CD = T2.EVL_ATC_DV_CD
         INNER JOIN TB_PSEV_AWD_EVL_ATC_BASE_DTL T4
            ON T4.BASE_YM 		= T2.BASE_YM
           AND T4.EVL_OG_TP_CD 	= T3.EVL_OG_TP_CD
           AND T4.EVL_ATC_DV_CD = T3.EVL_ATC_DV_CD
           AND T4.AWD_EVL_ID 	= T2.AWD_EVL_ID
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ T5
            ON T5.PRTNR_NO      = T4.PRTNR_NO
           AND T5.BASE_YM       = T4.BASE_YM
           AND T5.OG_TP_CD		= T4.EVL_OG_TP_CD
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ T6
            ON T6.PRTNR_NO      = T4.PRTNR_NO
           AND T6.BASE_YM       = T4.BASE_YM
           AND T6.OG_TP_CD		= 'HR1'
         WHERE 1 = 1
           AND T2.BASE_YM       = #{baseYm}
           AND T2.EVL_OG_TP_CD  = #{evlOgTpCd}
           AND T2.AWD_EVL_ID    = #{awdEvlId}
           AND T2.EVL_ATC_DV_CD = #{evlAtcDvCd}
		 ORDER BY T2.SORT_ODR ASC
    </select>

    <update id="updateTargetBase">
        UPDATE TB_PSEV_AWD_EVL_ATC_BASE_DTL
           SET TRG_BASE_PC   = #{trgBasePc}
             <include refid="COMMON.updateSystemField"/>
         WHERE BASE_YM       = #{baseYm}
           AND AWD_EVL_ID    = #{awdEvlId}
           AND EVL_OG_TP_CD  = #{evlOgTpCd}
           AND EVL_ATC_DV_CD = #{evlAtcDvCd}
           AND PRTNR_NO      = #{prtnrNo}
    </update>

    <select id="selectTargetList" resultType="camelMap">
        SELECT EVL_OG_TP_CD
             , EVL_RSB_DV_CD
             , RGST_SN
             , QLF_DV_CD
             , EVL_RSB_REL_ID
             , CALF_CN
             , CEXP_CN
          FROM TB_PSEV_AWD_EVL_RSB_REL
         WHERE EVL_RSB_REL_ID = #{evlRsbRelId}
           AND DTA_DL_YN = 'N'
           AND CALF_CN IS NOT NULL
    </select>

    <insert id="insertEvaluationDetail">
        INSERT INTO TB_PSEV_AWD_EVL_BASE_DTL
             ( BASE_YM
             , EVL_OG_TP_CD
             , AWD_EVL_ID
             , EVL_ATC_DV_CD
             , EVL_BASE_UNIT_N
             , CVT_BASE_PC
             , SORT_ODR
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField" />
             )
        VALUES
             ( #{baseYm}
             , #{evlOgTpCd}
             , #{awdEvlId}
             , #{evlAtcDvCd}
             , #{evlBaseUnitN}
             , #{cvtBasePc}
             , ( SELECT NVL(MAX(SORT_ODR), 0) + 1
                   FROM TB_PSEV_AWD_EVL_BASE_DTL
                  WHERE EVL_OG_TP_CD = #{evlOgTpCd}
                    AND AWD_EVL_ID = #{awdEvlId}
                )
             , 'N'
              <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <insert id="insertEvaluationArticleDetail">
        INSERT INTO TB_PSEV_AWD_EVL_ATC_BASE_DTL (  /* 시상평가항목상세 */
               BASE_YM          /* 기준년월 */
             , EVL_OG_TP_CD     /* 평가조직유형코드 */
             , AWD_EVL_ID       /* 시상평가ID */
             , EVL_ATC_DV_CD    /* 평가항목구분코드 */
             , PRTNR_NO         /* 파트너번호 */
             , EVL_PD_DV_CD     /* 평가상품구분코드 */
             , SORT_ODR         /* 정렬순서 */
             , DTA_DL_YN        /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />)
        WITH TARGET_LIST AS (
            SELECT PRTNR_NO
              FROM
                 (
                    <foreach collection="target" item="item" separator=" UNION ALL ">
                        <if test='@MybatisUtils@isNotEmpty(item.calfCn)'>
                        ${item.calfCn}
                        </if>
                        <if test='@MybatisUtils@isNotEmpty(item.cexpCn)'>
                            <where>${item.cexpCn}</where>
                        </if>
                    </foreach>
                 )
             GROUP BY PRTNR_NO
        )
        SELECT #{param.baseYm} AS BASE_YM           /* 기준년월 */
             , #{param.evlOgTpCd} AS EVL_OG_TP_CD   /* 평가조직유형코드 */
             , #{param.awdEvlId} AS AWD_EVL_ID      /* 시상평가ID */
             , #{param.evlAtcDvCd} AS EVL_ATC_DV_CD    /* 평가항목구분코드 */
             , PRTNR_NO
             , #{param.evlPdDvCd} AS EVL_PD_DV_CD
             , ( SELECT NVL(MAX(S1.SORT_ODR), 0) + 1
                   FROM TB_PSEV_AWD_EVL_ATC_BASE_DTL S1
                  WHERE S1.EVL_OG_TP_CD = #{param.evlOgTpCd}
                    AND S1.BASE_YM = #{param.baseYm}
                    AND S1.AWD_EVL_ID = #{param.awdEvlId}
                    AND S1.PRTNR_NO = T1.PRTNR_NO
                ) AS SORT_ODR
             , 'N' AS DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue" />
          FROM TARGET_LIST T1
    </insert>

    <delete id="deleteEvaluationDetail">
        UPDATE TB_PSEV_AWD_EVL_BASE_DTL
           SET DTA_DL_YN = 'Y'
           <include refid="COMMON.updateSystemField"/>
         WHERE AWD_EVL_ID = #{awdEvlId}
           AND EVL_ATC_DV_CD = #{evlAtcDvCd}
    </delete>

    <delete id="deleteEvaluationArticleDetail">
        UPDATE TB_PSEV_AWD_EVL_ATC_BASE_DTL
           SET DTA_DL_YN = 'Y'
           <include refid="COMMON.updateSystemField"/>
         WHERE AWD_EVL_ID = #{awdEvlId}
           AND EVL_ATC_DV_CD = #{evlAtcDvCd}
    </delete>

    <select id="selectMonthAwardTypeList" resultType="com.kyowon.sms.wells.web.competence.evaluate.dto.WpsdExcellentDivisionBaseMgtDto$EvlAwardRes">
        SELECT BASE_YM
             , EVL_OG_TP_CD
             , AWD_EVL_ID
             , AWD_EVL_NM
             , EVL_RSB_REL_ID
             , EVL_ATC_CN
             , CTST_GRP_USE_YN
             , EVL_WTCF_USE_YN
             , AWD_EVL_GD_USE_YN
             , DTA_DL_YN
          FROM TB_PSEV_AWD_EVL_BASE_BAS
         WHERE BASE_YM      = #{baseYm}
           AND EVL_OG_TP_CD = #{evlOgTpCd}
           AND DTA_DL_YN    = 'N'
    </select>


    <update id="removeEvaluationBase">
        UPDATE TB_PSEV_AWD_EVL_BASE_BAS
           SET DTA_DL_YN = 'Y'
               <include refid="COMMON.updateSystemField"/>
         WHERE AWD_EVL_ID = #{awdEvlId}
    </update>

    <select id="selectExcellentDivisionDeadline" resultType="com.kyowon.sms.wells.web.competence.evaluate.dto.WpsdExcellentDivisionBaseMgtDto$DeadlineSearchRes">
        SELECT #{ogTpCd} AS OG_TP_CD
             , T2.DDLN_ID
             , T2.BAS_YRMN
             , T2.START_DT
             , T2.START_HM
             , T2.FINS_DT
             , T2.FINS_HM
          FROM T_CMS_DDLN_M T1
         INNER JOIN T_CMS_DDLN_D T2
            ON T2.TENANT_ID = T1.TENANT_ID
           AND T2.DDLN_DV_ID = T1.DDLN_DV_ID
           AND T2.DEL_YN = 'N'
         WHERE 1=1
           AND T1.DEL_YN = 'N'
           AND T2.BAS_YRMN = #{basYrmn}
           AND T2.TENANT_ID = 'TNT_WELLS'
           AND T2.DDLN_DV_ID = 'DLD_'||#{ogTpCd}||'_EVL_PERF_CL'
    </select>

    <select id="selectExcellentDivisionDeadlineCount" resultType="Integer">
        SELECT COUNT(1)
          FROM T_CMS_DDLN_M T1
         INNER JOIN T_CMS_DDLN_D T2
            ON T2.TENANT_ID = T1.TENANT_ID
           AND T2.DDLN_DV_ID = T1.DDLN_DV_ID
           AND T2.DEL_YN = 'N'
         WHERE 1=1
           AND T1.DEL_YN = 'N'
           AND T2.BAS_YRMN = #{basYrmn}
           AND T2.TENANT_ID = 'TNT_WELLS'
           AND T2.DDLN_DV_ID = 'DLD_'||#{ogTpCd}||'_EVL_PERF_CL'
    </select>


    <update id="updateExcellentDivisionDeadline">
        UPDATE T_CMS_DDLN_D
           SET START_DT = #{startDt}
             , START_HM = #{startHm}
             , FINS_DT = #{finsDt}
             , FINS_HM = #{finsHm}
             <include refid="COMMON.updateSystemField"/>
         WHERE DDLN_ID = #{ddlnId}
           AND BAS_YRMN = #{basYrmn}
           AND DDLN_DV_ID = 'DLD_'||#{ogTpCd}||'_EVL_PERF_CL'
           AND TENANT_ID = #{session.tenantId}
    </update>


    <insert id="insertExcellentDivisionDeadline">
        INSERT INTO T_CMS_DDLN_D
             ( TENANT_ID
             , DDLN_ID
             , DDLN_DV_ID
             , BAS_YRMN
             , START_DT
             , START_HM
             , FINS_DT
             , FINS_HM
             , DEL_YN
             <include refid="COMMON.insertSystemField" /> )
        VALUES (
             #{session.tenantId}
             , (SELECT 'DLN_'||LPAD(ROWNUM + (SELECT MAX(SUBSTR(DDLN_ID, 5, 10)) FROM T_CMS_DDLN_D WHERE TENANT_ID = #{session.tenantId}), 5, '0') FROM DUAL)
             , 'DLD_'||#{ogTpCd}||'_EVL_PERF_CL'
             , #{basYrmn}
             , #{startDt}
             , #{startHm}
             , #{finsDt}
             , #{finsHm}
             , 'N'
             <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>



</mapper>
