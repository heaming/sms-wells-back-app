<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.competence.educations.mapper.WpsbZoomMgtMapper">

    <select id="getZooms" resultType="com.kyowon.sms.wells.web.competence.educations.dto.WpsbZoomMgtDto$SearchRes">
        SELECT A.OG_TP_CD            /* 조직유형코드 */
             , A.SV_EDUC_MNAL_ID     /* 서비스교육매뉴얼ID */
             , A.HGR_SV_EDUC_MNAL_ID /* 상위서비스교육매뉴얼ID */
             , A.SV_EDUC_MNAL_NM     /* 서비스교육매뉴얼명 */
             , A.INQR_LV_TCNT        /* 조회단계차수 */
             , A.EXPSR_ODR           /* 노출순서 */
             , A.SV_EDUC_CTG_NM      /* 서비스교육카테고리명 */
             , A.SV_EDUC_MNAL_CN     /* 서비스교육매뉴얼내용 */
             , A.RSB_DV_CD           /* 직책구분코드 */
             , A.DTA_DL_YN           /* 데이터삭제여부 */
             , A.ORG_PATH
          FROM
             ( SELECT OG_TP_CD            /* 조직유형코드 */
                    , SV_EDUC_MNAL_ID     /* 서비스교육매뉴얼ID */
                    , HGR_SV_EDUC_MNAL_ID /* 상위서비스교육매뉴얼ID */
                    , SV_EDUC_MNAL_NM     /* 서비스교육매뉴얼명 */
                    , INQR_LV_TCNT        /* 조회단계차수 */
                    , EXPSR_ODR           /* 노출순서 */
                    , SV_EDUC_CTG_NM      /* 서비스교육카테고리명 */
                    , SV_EDUC_MNAL_CN     /* 서비스교육매뉴얼내용 */
                    , RSB_DV_CD           /* 직책구분코드 */
                    , DTA_DL_YN           /* 데이터삭제여부 */
                    , SUBSTR(SYS_CONNECT_BY_PATH(SV_EDUC_MNAL_ID, '.'),2) AS ORG_PATH
                 FROM TB_PSCA_SV_EDUC_MNAL_BAS
                WHERE DTA_DL_YN = 'N'
                  <if test='@MybatisUtils@isNotEmpty(ogTpCd)'>
                  AND OG_TP_CD = #{ogTpCd}
                  </if>
                START WITH SV_EDUC_MNAL_ID = 'WELS0000000000'
              CONNECT BY PRIOR SV_EDUC_MNAL_ID = HGR_SV_EDUC_MNAL_ID )A
         WHERE 1=1
         ORDER BY HGR_SV_EDUC_MNAL_ID, EXPSR_ODR, SV_EDUC_MNAL_ID ASC
    </select>

    <insert id="insertZoom">
        <selectKey keyProperty="svEducMnalId" resultType="java.lang.String" order="BEFORE">
            SELECT CASE 4 WHEN 1 THEN RPAD((SUBSTR(BASE_EDUC_MNAL_ID, 0, 4)||LPAD(TO_NUMBER(SUBSTR(BASE_EDUC_MNAL_ID, 5,2))+1,2,0)), 14, 0)
                          WHEN 2 THEN RPAD((SUBSTR(BASE_EDUC_MNAL_ID, 0, 4)||SUBSTR(BASE_EDUC_MNAL_ID,5,2)||LPAD(TO_NUMBER(SUBSTR(BASE_EDUC_MNAL_ID, 7,2))+1,2,0)), 14, 0)
                          WHEN 3 THEN RPAD((SUBSTR(BASE_EDUC_MNAL_ID, 0, 4)||SUBSTR(BASE_EDUC_MNAL_ID,5,4)||LPAD(TO_NUMBER(SUBSTR(BASE_EDUC_MNAL_ID, 9,2))+1,2,0)), 14, 0)
                          WHEN 4 THEN RPAD((SUBSTR(BASE_EDUC_MNAL_ID, 0, 4)||SUBSTR(BASE_EDUC_MNAL_ID,5,6)||LPAD(TO_NUMBER(SUBSTR(BASE_EDUC_MNAL_ID, 11,2))+1,2,0)), 14, 0)
                   END AS SV_EDUC_MNAL_ID
              FROM
                 ( SELECT NVL((SELECT MAX(SV_EDUC_MNAL_ID) AS SV_EDUC_MNAL_ID FROM TB_PSCA_SV_EDUC_MNAL_BAS WHERE HGR_SV_EDUC_MNAL_ID = #{hgrSvEducMnalId}), #{hgrSvEducMnalId}) AS BASE_EDUC_MNAL_ID
                   FROM DUAL
                 )
        </selectKey>

        INSERT INTO TB_PSCA_SV_EDUC_MNAL_BAS (  /* 서비스교육매뉴얼기본 */
              SV_EDUC_MNAL_ID     /* 서비스교육매뉴얼ID */
            , HGR_SV_EDUC_MNAL_ID /* 상위서비스교육매뉴얼ID */
            , SV_EDUC_MNAL_NM     /* 서비스교육매뉴얼명 */
            , INQR_LV_TCNT        /* 조회단계차수 */
            , EXPSR_ODR           /* 노출순서 */
            , SV_EDUC_CTG_NM      /* 서비스교육카테고리명 */
            , SV_EDUC_MNAL_CN     /* 서비스교육매뉴얼내용 */
            , OG_TP_CD
            , RSB_DV_CD           /* 직책구분코드 */
            , DTA_DL_YN           /* 데이터삭제여부 */
            <include refid="COMMON.insertSystemField" />
        ) VALUES (
              #{svEducMnalId}
            , #{hgrSvEducMnalId}
            , #{svEducMnalNm}
            , #{inqrLvTcnt}
            , #{expsrOdr}
            , #{svEducCtgNm}
            , #{svEducMnalCn}
            , #{ogTpCd}
            , #{rsbDvCd}
            , 'N'
            <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <update id="updateZoom">
        UPDATE TB_PSCA_SV_EDUC_MNAL_BAS /* 서비스교육매뉴얼기본 */
           SET SV_EDUC_MNAL_NM     = #{svEducMnalNm}       /* 서비스교육매뉴얼명 */
             <if test='@MybatisUtils@isNotEmpty(hgrSvEducMnalId)'>
             , HGR_SV_EDUC_MNAL_ID = #{hgrSvEducMnalId}    /* 상위서비스교육매뉴얼ID */
             </if>
             <if test='@MybatisUtils@isNotEmpty(inqrLvTcnt)'>
             , INQR_LV_TCNT        = #{inqrLvTcnt}         /* 조회단계차수 */
             </if>
             <if test='@MybatisUtils@isNotEmpty(expsrOdr)'>
             , EXPSR_ODR           = #{expsrOdr}           /* 노출순서 */
             </if>
             <if test='@MybatisUtils@isNotEmpty(svEducCtgNm)'>
             , SV_EDUC_CTG_NM      = #{svEducCtgNm}        /* 서비스교육카테고리명 */
             </if>
             <if test='@MybatisUtils@isNotEmpty(svEducMnalCn)'>
             , SV_EDUC_MNAL_CN     = #{svEducMnalCn}       /* 서비스교육매뉴얼내용 */
             </if>
             <if test='@MybatisUtils@isNotEmpty(rsbDvCd)'>
             , RSB_DV_CD           = #{rsbDvCd}            /* 직책구분코드 */
             </if>
             <if test='@MybatisUtils@isNotEmpty(ogTpCd)'>
             , OG_TP_CD            = #{ogTpCd}            /* 조직유형코드 */
             </if>
             <include refid="COMMON.updateSystemField"/>
        WHERE 1 = 1
          AND SV_EDUC_MNAL_ID     = #{svEducMnalId}       /* 서비스교육매뉴얼ID */
    </update>

    <update id="removeZoom">
        UPDATE TB_PSCA_SV_EDUC_MNAL_BAS /* 서비스교육매뉴얼기본 */
           SET DTA_DL_YN      = 'Y'            /* 데이터삭제여부 */
           <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND SV_EDUC_MNAL_ID     = #{svEducMnalId}       /* 서비스교육매뉴얼ID */
    </update>
</mapper>
