<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.bilfnt.mapper.WwdaDesignationWithdrawalCustomerMgtMapper">

    <select id="selectAftnDsnWdrwCstInqrPages" resultType="com.kyowon.sms.wells.web.withdrawal.bilfnt.dto.WwdaDesignationWithdrawalCustomerMgtDto$SearchAutoFntDsnWdrwCstRes">
        SELECT 
               SCD.CNTR_NO || SCD.CNTR_SN AS CNTR 
             , CCB.CST_KNM 
             , SCD.SELL_TP_CD  
             , RAFB.DSN_WDRW_AMT    
             , RAFB.DSN_WDRW_FNT_D  
             , RAFB.FNT_YN  
             , RAFB.DP_AMT  
             , RAFB.UC_AMT  
             , RAFB.DSN_WDRW_FNT_PRD_CD 
            <!--  , OPB.PRTNR_KNM   추후에 수정 --> 
             , '김아무개' AS PRTNR_KNM <!-- 추후에 수정 -->
             , RAFB.FNL_MDFC_USR_ID 
             , RAFB.FNL_MDFC_DTM
          FROM TB_RVCL_AC_FNT_DSN_WDRW_BAS RAFB
          JOIN TB_SSCT_CNTR_DTL SCD
            ON RAFB.CNTR_NO = SCD.CNTR_NO
           AND RAFB.CNTR_SN = SCD.CNTR_SN
          JOIN TB_SSCT_CNTR_BAS SCB
            ON SCD.CNTR_NO = SCB.CNTR_NO
          JOIN TB_CUBS_CST_BAS CCB
            ON SCB.CNTR_CST_NO = CCB.CST_NO
          <!-- JOIN TB_OGBS_PRTNR_BAS OPB
            ON RAFB.FNL_MDFC_USR_ID = OPB.PRTNR_NO -->
         WHERE RAFB.DTA_DL_YN = 'N'
           AND RAFB.CNTR_NO = #{cntrNo}
           AND RAFB.CNTR_SN = #{cntrSn}
           <if test="sellTpCd != 'ALL'">
           AND SCD.SELL_TP_CD = #{sellTpCd}
           </if>
    </select>
    
   <!--  <select id="selectContractDetailInf" resultType="com.kyowon.sms.wells.web.withdrawal.bilfnt.dto.WwdaAutomaticFntDsnWdrwDto$SearchContractDetailInfRes">
        SELECT
               SCD.CNTR_NO
             , SCD.CNTR_SN
             , SCD.BASE_PD_CD
             , SCD.STPL_PTRM
             , SCD.ISTM_MCN
             , SCD.CNTR_DTL_STAT_CD
             , SCD.SELL_TP_CD
             , SCD.DSC_APY_TP_CD
             , SCD.BLG_CRP_CD
             , SCD.RVE_CRP_CD
             , SCD.PD_HCLSF_ID
             , SCD.PD_MCLSF_ID
             , SCD.PD_LCLSF_ID
             , SCD.PD_DCLSF_ID
             , SCD.STLM_TP_CD
             , SCD.CRNCY_DV_CD
             , SCD.SELL_AMT
             , SCD.CNTR_AMT
          FROM TB_SSCT_CNTR_DTL SCD
          JOIN TB_SSCT_CNTR_BAS SCB
            ON SCD.CNTR_NO = SCB.CNTR_NO
          JOIN TB_PDBS_PD_BAS PPB
            ON SCD.BASE_PD_CD = PPB.PD_CD
          JOIN TB_CUBS_CST_BAS CCB
            ON SCB.CNTR_CST_NO = CCB.CST_NO
          JOIN TB_OGBS_PRTNR_BAS OPB
            ON SCB.SELL_PRTNR_NO = OPB.PRTNR_NO
         WHERE SCD.DTA_DL_YN = 'N'
           AND SCB.DTA_DL_YN = 'N'
           AND PPB.DTA_DL_YN = 'N'
           AND CCB.DTA_DL_YN = 'N'
           AND OPB.DTA_DL_YN = 'N'
           AND SCD.CNTR_NO = #{cntrNo}
           AND SCD.CNTR_SN = #{cntrSn}
    </select> -->
    
    <select id="selectAutomaticFntOjYnConf" resultType="com.kyowon.sms.wells.web.withdrawal.bilfnt.dvo.WwdaAutomaticFntOjYnConfDvo">
        SELECT 
               SCSB.MPY_MTHD_TP_CD
             , SCSB.FNIT_APR_RS_CD
          FROM TB_SSCT_CNTR_STLM_REL SCSR
          JOIN TB_SSCT_CNTR_STLM_BAS SCSB
            ON SCSR.CNTR_STLM_ID = SCSB.CNTR_STLM_ID
         WHERE SCSR.DTL_CNTR_NO = #{cntrNo}
           AND SCSR.DTL_CNTR_SN = #{cntrSn}
    </select>
    
    <select id="selectItgWdrwRgstCstCk" resultType="Integer">
        SELECT COUNT(*)
          FROM TB_RVCL_ITG_BIL_OJ_BAS
         WHERE DTA_DL_YN = 'N'
           AND SUBOD_CNTR_NO = #{cntrNo}
           AND SUBOD_CNTR_SN = #{cntrSn}
    </select>
    
    <select id="selectBilFntAkDtl" resultType="com.kyowon.sms.wells.web.withdrawal.bilfnt.dvo.WwdaAutomaticFntOjYnConfDvo">
        SELECT BIL_NO, BIL_DTL_SN
            FROM TB_RVCL_BIL_FNT_AK_DTL
            WHERE CNTR_NO = #{cntrNo} 
              AND BIL_PLAN_SN = #{cntrSn}
    </select>
    
    <select id="selectAcFntDsnWdrwBasByPk" resultType="Integer">
        SELECT COUNT(*)
          FROM TB_RVCL_AC_FNT_DSN_WDRW_BAS
         WHERE DTA_DL_YN = 'Y'
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </select>
    
    <update id="updateAcFntDsnWdrwBasByPk">
        UPDATE TB_RVCL_AC_FNT_DSN_WDRW_BAS
           SET DTA_DL_YN = 'N'
             , VL_STRTDT = TO_CHAR(SYSDATE, 'YYYYMMDD')
             , VL_ENDDT = '99991231'
             , DSN_WDRW_AMT = ${dsnWdrwAmt}
             , DP_AMT = ${dpAmt}
             , FNT_YN = #{fntYn}
             , DSN_WDRW_FNT_D = #{dsnWdrwFntD}
             , DSN_WDRW_FNT_PRD_CD = #{dsnWdrwFntPrdCd}
             <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN = 'Y'
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </update>
    
    <update id="updateAutoFntDsnWdrwRelByPk">
        UPDATE TB_RVCL_AC_FNT_DSN_WDRW_REL
           SET DTA_DL_YN = 'N'
         WHERE DTA_DL_YN = 'Y'
           AND BIL_NO = #{bilNo}
           AND BIL_DTL_SN = #{bilDtlSn}
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </update>
    
    <select id="selectAcFntDsnWdrwBasCt" resultType="Integer">
    /* WwdaDesignationWithdrawalCustomerMgtMapper.selectAcFntDsnWdrwBasCt */
        SELECT COUNT(*)
          FROM TB_RVCL_AC_FNT_DSN_WDRW_BAS
         WHERE DTA_DL_YN = 'N'
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </select>
    
    <insert id="insertAutoFntDsnWdrwCstBas">
        INSERT INTO TB_RVCL_AC_FNT_DSN_WDRW_BAS (
               CNTR_NO
             , CNTR_SN
             , VL_STRTDT
             , VL_ENDDT
             , DSN_WDRW_AMT
             , DP_AMT
             , FNT_YN
             , DSN_WDRW_FNT_D
             , DSN_WDRW_FNT_PRD_CD
             , DTA_DL_YN
            <include refid="COMMON.insertSystemField"/>
            ) 
            VALUES 
            (
               #{cntrNo}
             , ${cntrSn}
             , TO_CHAR(SYSDATE, 'YYYYMMDD')
             , '99991231'
             , ${dsnWdrwAmt}
             , ${dpAmt}
             , #{fntYn}
             , #{dsnWdrwFntD}
             , #{dsnWdrwFntPrdCd}
             , 'N'
            <include refid="COMMON.insertSystemFieldValue" />
            )
    </insert>
    
    <insert id="insertAutoFntDsnWdrwCstHist">
        INSERT INTO TB_RVCL_AC_FNT_DSN_WDRW_HIST (
               CNTR_NO
             , CNTR_SN
             , HIST_CH_DTM
             , VL_STRTDT
             , VL_ENDDT
             , DSN_WDRW_AMT
             , DP_AMT
             , FNT_YN
             , DSN_WDRW_FNT_D
             , DSN_WDRW_FNT_PRD_CD
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField"/>
             ) SELECT 
                   CNTR_NO
                 , CNTR_SN
                 , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS HIST_CH_DTM
                 , VL_STRTDT
                 , VL_ENDDT
                 , DSN_WDRW_AMT
                 , DP_AMT
                 , FNT_YN
                 , DSN_WDRW_FNT_D
                 , DSN_WDRW_FNT_PRD_CD
                 , 'N'
                 <include refid="COMMON.insertSystemFieldValue" />
                 FROM TB_RVCL_AC_FNT_DSN_WDRW_BAS
                WHERE CNTR_NO = #{cntrNo}
                  AND CNTR_SN = #{cntrSn}
             
    </insert>
    
    <select id="selectBilFntAkCt" resultType="Integer">
        SELECT COUNT(*)
          FROM TB_RVCL_BIL_FNT_AK_DTL RBFD
          JOIN TB_RVCL_BIL_FNT_AK_BAS RBFB
            ON RBFD.BIL_NO = RBFB.BIL_NO
         WHERE RBFD.CNTR_NO = #{cntrNo}
           AND RBFD.BIL_PLAN_SN = #{cntrSn}
           AND RBFB.RGL_FNT_D = #{dsnWdrwFntD}
    </select>
    
    <insert id="insertAutoFntDsnWdrwRel">
        INSERT INTO TB_RVCL_AC_FNT_DSN_WDRW_REL (
               BIL_NO
              , BIL_DTL_SN
              , CNTR_NO
              , CNTR_SN
              , VL_STRTDT
              , VL_ENDDT
              , DTA_DL_YN
              <include refid="COMMON.insertSystemField"/>
               )
                 VALUES
                (
               #{bilNo}
              , ${bilDtlSn}
              , #{cntrNo}
              , ${cntrSn}
              , TO_CHAR(SYSDATE, 'YYYYMMDD')
              , '99991231'
              , 'N'
              <include refid="COMMON.insertSystemFieldValue" />
                 )
    </insert>
    
    <update id="updateAutoFntDsnWdrwCst">
        UPDATE TB_RVCL_AC_FNT_DSN_WDRW_BAS
           SET VL_STRTDT = TO_CHAR(SYSDATE, 'YYYYMMDD')
             , VL_ENDDT = '99991231'
             , DSN_WDRW_AMT = ${dsnWdrwAmt}
             , DP_AMT = ${dpAmt}
             , FNT_YN = #{fntYn}
             , DSN_WDRW_FNT_D = #{dsnWdrwFntD}
             , DSN_WDRW_FNT_PRD_CD = #{dsnWdrwFntPrdCd}
             <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN = 'N'
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </update>
    
    <update id="deleteAutoFntDsnWdrwCst">
        UPDATE TB_RVCL_AC_FNT_DSN_WDRW_BAS
           SET DTA_DL_YN = 'Y'
             , VL_ENDDT = TO_CHAR(SYSDATE, 'YYYYMMDD')
             <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </update>
    
    
    <update id="deleteAutoFntDsnWdrwRel">
        UPDATE TB_RVCL_AC_FNT_DSN_WDRW_REL
           SET DTA_DL_YN = 'Y'
             , VL_ENDDT = TO_CHAR(SYSDATE, 'YYYYMMDD')
             <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = ${cntrSn}
           AND BIL_NO = #{bilNo}
           AND BIL_DTL_SN = #{bilDtlSn}
    </update>

</mapper>