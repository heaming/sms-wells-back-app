<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.bilfnt.mapper.WwdaBundleWithdrawalRgstMapper">

    <select id="selectUnregistrationPsInqrPages" resultType="com.kyowon.sms.wells.web.withdrawal.bilfnt.dto.WwdaBundleWithdrawalRgstDto$SearchUnrgPsRes">
                SELECT CST_KNM
                     , PD_NM  
                     , CNTR_PD_STRTDT

                     , UNRG_RSON

                     , CNTR_SN
                     , DP_TP_CD 
                     , FNIT_APR_RS_CD 
                     , CASE WHEN ACNO_ENCR IS NULL THEN CRCDNO_ENCR ELSE ACNO_ENCR END AS ACNO_ENCR
                     , CRCDNO_ENCR
                     , FNIT_RSG_FSH_DTM
                     , DG_CNTR_NO 
                     , BNK_NM
                     , OWR_KNM    
                     , MPY_BSDT
                     , BRYY_MMDD   

                     , SDING_CNTR_NO
                     , SDING_CNTR_SN 
                     , SDING_DP_TP_CD
                     , SDING_FNIT_APR_RS_CD
                     , SDING_DG_CNTR_NO
                     , SDING_BNK_NM
                     , CASE WHEN SDING_ACNO_ENCR IS NULL THEN SDING_CRCDNO_ENCR ELSE SDING_ACNO_ENCR END AS SDING_ACNO_ENCR
                     , SDING_CRCDNO_ENCR
                     , SDING_OWR_KNM
                     , SDING_MPY_BSDT
                     , SDING_BRYY_MMDD
                  FROM (
                         SELECT CST_KNM
                     , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE PD_CD = SCD.BASE_PD_CD) AS PD_NM  
                     , CNTR_PD_STRTDT

                     , CASE WHEN T1.DP_TP_CD != T1.SUBOD_CNTR_DP_TP_CD THEN '01' /*1. 이체구분값 상이*/
                            WHEN T1.DP_TP_CD = '0102' THEN
                                CASE WHEN T1.ACNO_ENCR IS NULL THEN '02' /*2. 계좌미등록(기기)*/
                                     WHEN T1.FNIT_APR_RS_CD != 'Y' AND T1.FNIT_RSG_FSH_DTM IS NULL THEN '12' /*12. 계좌등록오류(기기)*/
                                     WHEN T1.ACNO_ENCR != T1.SUBOD_CNTR_ACNO_ENCR THEN '04' /*4.계좌정보 상이*/
                                     WHEN T1.DG_CNTR_NO IS NULL THEN '06' /*6.묶음미등록(계좌-기기)*/
                                     WHEN T1.DG_CNTR_NO != T1.BNDL_DG_CNTR_NO THEN '10' /*10.대표코드상이(계좌묶음)*/
                                END
                              WHEN T1.DP_TP_CD = '0203' THEN
                                CASE WHEN T1.CRCDNO_ENCR IS NULL THEN '03' /*3. 카드미등록(기기)*/
                                     WHEN T1.CRCDNO_ENCR != T1.SUBOD_CNTR_CRCDNO_ENCR THEN '05' /*5.카드정보 상이*/
                                     WHEN T1.DG_CNTR_NO IS NULL THEN '07' /*7.묶음출금미등록(카드-기기)*/
                                     WHEN T1.DG_CNTR_NO != T1.BNDL_DG_CNTR_NO THEN '11' /*11.대표코드상이(카드묶음)*/
                                END
                              WHEN T1.SUBOD_CNTR_DP_TP_CD = '0102' THEN 
                                CASE WHEN T1.BNDL_DG_CNTR_NO IS NULL THEN '08' /*8.묶음미등록(계좌-모종)*/
                                END 
                              WHEN T1.SUBOD_CNTR_DP_TP_CD = '0203' THEN
                                CASE WHEN T1.BNDL_DG_CNTR_NO IS NULL THEN '09' /*9.묶음출금미등록(카드-모종)*/
                                END
                             ELSE '99'
                         END UNRG_RSON

                     , T1.DG_CNTR_NO AS CNTR_SN
                     , T1.DP_TP_CD 
                     , T1.FNIT_APR_RS_CD 
                     , T1.ACNO_ENCR
                     , T1.CRCDNO_ENCR
                     , T1.FNIT_RSG_FSH_DTM
                     , T1.DG_CNTR_NO
                     , (SELECT FNIT_NM FROM TB_RVDW_FNIT_CD WHERE LPAD(T1.BNK_CD,3,0) = FNIT_CD) AS BNK_NM
                     , T1.OWR_KNM    
                     , T1.MPY_BSDT
                     , CCB.BRYY_MMDD   

                     , T1.SUBOD_CNTR_DG_CNTR_NO AS SDING_CNTR_NO 
                     , T1.SUBOD_CNTR_DG_CNTR_SN AS SDING_CNTR_SN
                     , T1.SUBOD_CNTR_DP_TP_CD AS SDING_DP_TP_CD
                     , T1.SUBOD_CNTR_FNIT_APR_RS_CD AS SDING_FNIT_APR_RS_CD
                     , T1.BNDL_DG_CNTR_NO AS SDING_DG_CNTR_NO
                     , (SELECT FNIT_NM FROM TB_RVDW_FNIT_CD WHERE LPAD(T1.SUBOD_CNTR_SUBOD_CNTR,3,0) = FNIT_CD) AS SDING_BNK_NM
                     , T1.SUBOD_CNTR_ACNO_ENCR AS SDING_ACNO_ENCR
                     , T1.SUBOD_CNTR_CRCDNO_ENCR AS SDING_CRCDNO_ENCR
                     , T1.SUBOD_CNTR_OWR_KNM AS SDING_OWR_KNM
                     , T1.SUBOD_CNTR_MPY_BSDT AS SDING_MPY_BSDT
                     , CCB.BRYY_MMDD AS SDING_BRYY_MMDD
                  FROM TB_SSCT_CNTR_BAS SCB
                  JOIN TB_CUBS_CST_BAS CCB
                    ON SCB.CNTR_CST_NO = CCB.CST_NO
                  JOIN TB_SSCT_CNTR_DTL SCD
                    ON SCB.CNTR_NO = SCD.CNTR_NO 
                  JOIN (
                         SELECT DG_CNTR.DG_CNTR_NO 
                              , DG_CNTR.DG_CNTR_SN
                              , DG_CNTR.DP_TP_CD
                              , DG_CNTR.FNIT_APR_RS_CD
                              , DG_CNTR.CRCDNO_ENCR
                              , DG_CNTR.FNIT_RSG_FSH_DTM
                              , CASE WHEN DG_CNTR.BNK_CD IS NULL THEN DG_CNTR.CDCO_CD ELSE DG_CNTR.BNK_CD END AS BNK_CD
                              , DG_CNTR.ACNO_ENCR
                              , DG_CNTR.OWR_KNM
                              , DG_CNTR.MPY_BSDT

                              , SUBOD_CNTR.DG_CNTR_NO AS BNDL_DG_CNTR_NO
                              , SUBOD_CNTR.DG_CNTR_SN AS BNDL_DG_CNTR_SN
                              , SUBOD_CNTR.SUBOD_CNTR_NO AS SUBOD_CNTR_DG_CNTR_NO
                              , SUBOD_CNTR.SUBOD_CNTR_SN AS SUBOD_CNTR_DG_CNTR_SN
                              , SUBOD_CNTR.DP_TP_CD AS SUBOD_CNTR_DP_TP_CD
                              , SUBOD_CNTR.FNIT_APR_RS_CD AS SUBOD_CNTR_FNIT_APR_RS_CD
                              , SUBOD_CNTR.CRCDNO_ENCR AS SUBOD_CNTR_CRCDNO_ENCR
                              , SUBOD_CNTR.FNIT_RSG_FSH_DTM AS SUBOD_CNTR_FNIT_RSG_FSH_DTM
                              , CASE WHEN SUBOD_CNTR.BNK_CD IS NULL THEN SUBOD_CNTR.CDCO_CD ELSE SUBOD_CNTR.BNK_CD END AS SUBOD_CNTR_SUBOD_CNTR
                              , SUBOD_CNTR.ACNO_ENCR AS SUBOD_CNTR_ACNO_ENCR
                              , SUBOD_CNTR.OWR_KNM AS SUBOD_CNTR_OWR_KNM
                              , SUBOD_CNTR.MPY_BSDT AS SUBOD_CNTR_MPY_BSDT

                           FROM (
                                 SELECT RIBB.DG_CNTR_NO
                                      , RIBB.DG_CNTR_SN
                                      , RIBB.SUBOD_CNTR_NO 
                                      , RIBB.SUBOD_CNTR_SN 
                                      , A.DP_TP_CD
                                      , A.FNIT_APR_RS_CD
                                      , A.CRCDNO_ENCR
                                      , A.FNIT_RSG_FSH_DTM
                                      , A.BNK_CD
                                      , A.CDCO_CD 
                                      , A.ACNO_ENCR
                                      , A.OWR_KNM    
                                      , A.MPY_BSDT
                                   FROM TB_SSCT_CNTR_DTL SCD
                                   JOIN TB_SSCT_CNTR_BAS SCB
                                     ON SCB.CNTR_NO = SCD.CNTR_NO 
                                    AND SCD.DTA_DL_YN = 'N'
                                    AND SCB.DTA_DL_YN = 'N'
                                   JOIN (
                                        SELECT *
                                          FROM (
                                                SELECT SCSB.CNTR_STLM_ID
                                                     , SCSB.ACNO_ENCR /* 계좌번호 암호화 */
                                                     , SCSB.CRCDNO_ENCR /* 신용카드번호 암호화 */
                                                     , SCSB.OWR_KNM
                                                     , SCSB.MPY_BSDT
                                                     , SCSB.BNK_CD 
                                                     , SCSB.CDCO_CD
                                                     , SCSB.DP_TP_CD 
                                                     , SCSB.CNTRT_REL_CD
                                                     , SCSB.CARD_EXPDT_YM
                                                     , SCSR.DTL_CNTR_NO 
                                                     , SCSR.DTL_CNTR_SN
                                                     , SCSR.CNTR_UNIT_TP_CD
                                                     , SCSB.FNIT_RSG_FSH_DTM
                                                     , SCSB.FNIT_APR_RS_CD
                                                     , ROW_NUMBER() OVER(PARTITION BY SCSR.DTL_CNTR_NO, SCSR.DTL_CNTR_SN ORDER BY SCSR.VL_STRT_DTM DESC) AS RN
                                                  FROM TB_SSCT_CNTR_STLM_REL SCSR
                                                  JOIN TB_SSCT_CNTR_STLM_BAS SCSB /* 계약결제기본 */
                                                    ON SCSR.CNTR_STLM_ID = SCSB.CNTR_STLM_ID 
                                                   AND SCSB.DTA_DL_YN = 'N'
                                                   AND SCSR.DTA_DL_YN = 'N'
                                                   AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN VL_STRT_DTM AND VL_END_DTM
                                               )
                                         WHERE RN = 1
                                      ) A
                                     ON A.DTL_CNTR_NO = SCD.CNTR_NO
                                    AND A.DTL_CNTR_SN = SCD.CNTR_SN
                                   JOIN TB_RVCL_ITG_BIL_OJ_BAS RIBB
                                     ON RIBB.SUBOD_CNTR_NO = SCD.CNTR_NO 
                                    AND RIBB.SUBOD_CNTR_SN = SCD.CNTR_SN 
                                    AND RIBB.DTA_DL_YN = 'N'
                                  WHERE RIBB.DG_CNTR_NO || RIBB.DG_CNTR_SN = RIBB.SUBOD_CNTR_NO || RIBB.SUBOD_CNTR_SN
                             ) DG_CNTR
                           JOIN (
                                 SELECT RIBB.DG_CNTR_NO
                                      , RIBB.DG_CNTR_SN
                                      , RIBB.SUBOD_CNTR_NO 
                                      , RIBB.SUBOD_CNTR_SN 
                                      , A.DP_TP_CD 
                                      , A.FNIT_APR_RS_CD
                                      , A.CRCDNO_ENCR
                                      , A.FNIT_RSG_FSH_DTM
                                      , A.BNK_CD
                                      , A.CDCO_CD 
                                      , A.ACNO_ENCR
                                      , A.OWR_KNM    
                                      , A.MPY_BSDT
                                   FROM TB_SSCT_CNTR_DTL SCD
                                   JOIN TB_SSCT_CNTR_BAS SCB
                                     ON SCB.CNTR_NO = SCD.CNTR_NO 
                                    AND SCD.DTA_DL_YN = 'N'
                                    AND SCB.DTA_DL_YN = 'N'
                                   JOIN (
                                        SELECT *
                                          FROM (
                                                SELECT SCSB.CNTR_STLM_ID
                                                     , SCSB.ACNO_ENCR /* 계좌번호 암호화 */
                                                     , SCSB.CRCDNO_ENCR /* 신용카드번호 암호화 */
                                                     , SCSB.OWR_KNM
                                                     , SCSB.MPY_BSDT
                                                     , SCSB.BNK_CD 
                                                     , SCSB.CDCO_CD
                                                     , SCSB.DP_TP_CD 
                                                     , SCSB.CNTRT_REL_CD
                                                     , SCSB.CARD_EXPDT_YM
                                                     , SCSR.DTL_CNTR_NO 
                                                     , SCSR.DTL_CNTR_SN
                                                     , SCSR.CNTR_UNIT_TP_CD
                                                     , SCSB.FNIT_RSG_FSH_DTM
                                                     , SCSB.FNIT_APR_RS_CD
                                                     , ROW_NUMBER() OVER(PARTITION BY SCSR.DTL_CNTR_NO, SCSR.DTL_CNTR_SN ORDER BY SCSR.VL_STRT_DTM DESC) AS RN
                                                  FROM TB_SSCT_CNTR_STLM_REL SCSR
                                                  JOIN TB_SSCT_CNTR_STLM_BAS SCSB /* 계약결제기본 */
                                                    ON SCSR.CNTR_STLM_ID = SCSB.CNTR_STLM_ID 
                                                   AND SCSB.DTA_DL_YN = 'N'
                                                   AND SCSR.DTA_DL_YN = 'N'
                                                   AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN VL_STRT_DTM AND VL_END_DTM
                                               )
                                         WHERE RN = 1
                                      ) A
                                     ON A.DTL_CNTR_NO = SCD.CNTR_NO
                                    AND A.DTL_CNTR_SN = SCD.CNTR_SN
                                   JOIN TB_RVCL_ITG_BIL_OJ_BAS RIBB
                                     ON RIBB.SUBOD_CNTR_NO = SCD.CNTR_NO 
                                    AND RIBB.SUBOD_CNTR_SN = SCD.CNTR_SN 
                                    AND RIBB.DTA_DL_YN = 'N'
                                  WHERE RIBB.DG_CNTR_NO || RIBB.DG_CNTR_SN != RIBB.SUBOD_CNTR_NO || RIBB.SUBOD_CNTR_SN
                             ) SUBOD_CNTR
                             ON DG_CNTR.DG_CNTR_NO = SUBOD_CNTR.DG_CNTR_NO
                            AND DG_CNTR.DG_CNTR_SN = SUBOD_CNTR.DG_CNTR_SN
                       ) T1
                    ON SCD.CNTR_NO = T1.DG_CNTR_NO
                   AND SCD.CNTR_SN = T1.DG_CNTR_SN
                 WHERE SCB.CNTR_CNFM_DTM >= '20200201000000' /*공유렌탈 시행 시작월 2020.02*/
                   <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                   AND T1.DG_CNTR_NO = #{cntrNo} 
                   AND T1.DG_CNTR_SN = #{cntrSn} 
                   </if> 
                   <if test='@MybatisUtils@isNotEmpty(cntrPdStrtdt)'>
                   AND SCD.CNTR_PD_STRTDT >= #{cntrPdStrtdt} 
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cntrPdEnddt)'>
                   AND SCD.CNTR_PD_STRTDT <![CDATA[ <= ]]> #{cntrPdEnddt}
                   </if>
                   
                  )
                WHERE 1 = 1
                <if test='@MybatisUtils@isNotEmpty(unrgRs)'>
                     <if test='@MybatisUtils@equals(unrgRs, "1")'>
                  AND UNRG_RSON NOT IN ('02','03','12','13')
                     </if>
                     <if test='@MybatisUtils@equals(unrgRs, "2")'>
                  AND UNRG_RSON IN ('02','03','12','13')
                     </if>
                </if>
                <if test="@MybatisUtils@isEmpty(unrgRs)">
                  AND (UNRG_RSON NOT IN ('02','03','12','13') OR UNRG_RSON IN ('02','03','12','13'))
                </if>
                
                
                   
    </select>
    
    <select id="selectBundleRgstRsInqrPages" resultType="com.kyowon.sms.wells.web.withdrawal.bilfnt.dto.WwdaBundleWithdrawalRgstDto$SearchRgstHistRes">
                 SELECT T1.ITG_BIL_PRTC_DTM   
                                  , T1.FNL_MDFC_USR_ID    
                                  , T1.AFTN_ITG_UNRG_RS_CD    
                                  , T1.ERR_CN 
                                  , CCB.CST_KNM 
                                  , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE PD_CD = SCD.BASE_PD_CD) AS PD_NM 
                                  , SCB.CNTR_CNFM_DTM AS CNTR_PD_STRTDT 
                                  , T1.AFTN_ITG_UNRG_RSON_CD 
                                  
                                  , T1.DG_CNTR_NO AS CNTR_SN
                                  , T1.DP_TP_CD 
                                  , T1.DG_CNTR_NO AS DG_CNTR_SN
                                  , (SELECT FNIT_NM FROM TB_RVDW_FNIT_CD WHERE LPAD(T1.BNK_CD,3,0) = FNIT_CD) AS BNK_CD 
                                  , T1.ACNO_ENCR  
                                  , T1.OWR_KNM    
                                  , T1.MPY_BSDT   
                                  , CCB.BRYY_MMDD   
                                  
                                  , T1.SUBOD_CNTR_DG_CNTR_NO AS SDING_CNTR_NO
                                  , T1.SUBOD_CNTR_DG_CNTR_SN AS SDING_CNTR_SN
                                  , T1.DP_TP_CD AS SDING_DP_TP_CD
                                  , T1.DG_CNTR_NO AS SDING_DG_CNTR_SN
                                  , (SELECT FNIT_NM FROM TB_RVDW_FNIT_CD WHERE LPAD(T1.SUBOD_CNTR_SUBOD_CNTR,3,0) = FNIT_CD) AS SDING_BNK_CD
                                  , T1.SUBOD_CNTR_ACNO_ENCR AS SDING_ACNO_ENCR   
                                  , T1.SUBOD_CNTR_OWR_KNM  AS SDING_OWR_KNM  
                                  , T1.SUBOD_CNTR_MPY_BSDT AS SDING_MPY_BSDT 
                                  , CCB.BRYY_MMDD AS SDING_BRYY_MMDD 
                              FROM TB_SSCT_CNTR_BAS SCB
                              JOIN TB_CUBS_CST_BAS CCB
                                ON SCB.CNTR_CST_NO = CCB.CST_NO
                              JOIN TB_SSCT_CNTR_DTL SCD
                                ON SCB.CNTR_NO = SCD.CNTR_NO 
                              JOIN (
                                     SELECT DG_CNTR.DG_CNTR_NO AS DG_CNTR_NO
                                          , DG_CNTR.DG_CNTR_SN AS DG_CNTR_SN
                                          , DG_CNTR.DP_TP_CD
                                          , CASE WHEN DG_CNTR.BNK_CD IS NULL THEN DG_CNTR.CDCO_CD ELSE DG_CNTR.BNK_CD END AS BNK_CD
                                          , CASE WHEN DG_CNTR.ACNO_ENCR IS NULL THEN DG_CNTR.CRCDNO_ENCR ELSE DG_CNTR.ACNO_ENCR END AS ACNO_ENCR
                                          , DG_CNTR.OWR_KNM
                                          , DG_CNTR.MPY_BSDT
                                          , DG_CNTR.ITG_BIL_PRTC_DTM
                                          , DG_CNTR.FNL_MDFC_USR_ID
                                          , DG_CNTR.AFTN_ITG_UNRG_RS_CD
                                          , DG_CNTR.AFTN_ITG_UNRG_RSON_CD
                                          , DG_CNTR.ERR_CN
                                          
                                          , SUBOD_CNTR.SUBOD_CNTR_NO AS SUBOD_CNTR_DG_CNTR_NO
                                          , SUBOD_CNTR.SUBOD_CNTR_SN AS SUBOD_CNTR_DG_CNTR_SN
                                          , SUBOD_CNTR.DP_TP_CD AS SUBOD_CNTR_DP_TP_CD
                                          , CASE WHEN SUBOD_CNTR.BNK_CD IS NULL THEN SUBOD_CNTR.CDCO_CD ELSE SUBOD_CNTR.BNK_CD END AS SUBOD_CNTR_SUBOD_CNTR
                                          , CASE WHEN SUBOD_CNTR.ACNO_ENCR IS NULL THEN SUBOD_CNTR.CRCDNO_ENCR ELSE SUBOD_CNTR.ACNO_ENCR END AS SUBOD_CNTR_ACNO_ENCR
                                          , SUBOD_CNTR.OWR_KNM AS SUBOD_CNTR_OWR_KNM
                                          , SUBOD_CNTR.MPY_BSDT AS SUBOD_CNTR_MPY_BSDT
                                          , SUBOD_CNTR.ITG_BIL_PRTC_DTM AS SUBOD_CNTR_ITG_BIL_PRTC_DTM
                                          , SUBOD_CNTR.FNL_MDFC_USR_ID AS SUBOD_CNTR_FNL_MDFC_USR_ID
                                          , SUBOD_CNTR.AFTN_ITG_UNRG_RS_CD AS SUBOD_CNTR_AFTN_ITG_UNRG_RS_CD
                                          , SUBOD_CNTR.AFTN_ITG_UNRG_RSON_CD AS SUBOD_CNTR_AFTN_ITG_UNRG_RSON_CD
                                          , SUBOD_CNTR.ERR_CN AS SUBOD_CNTR_ERR_CN
                                          
                                       FROM (
                                             SELECT RIBB.DG_CNTR_NO
                                                  , RIBB.DG_CNTR_SN
                                                  , RIBB.SUBOD_CNTR_NO 
                                                  , RIBB.SUBOD_CNTR_SN 
                                                  , A.DP_TP_CD 
                                                  , A.BNK_CD
                                                  , A.CDCO_CD 
                                                  , A.ACNO_ENCR
                                                  , A.CRCDNO_ENCR
                                                  , A.OWR_KNM    
                                                  , A.MPY_BSDT
                                                  , RIEI.ITG_BIL_PRTC_DTM   
                                                  , RIEI.FNL_MDFC_USR_ID    
                                                  , RIEI.AFTN_ITG_UNRG_RS_CD    
                                                  , RIEI.AFTN_ITG_UNRG_RSON_CD  
                                                  , RIEI.ERR_CN 
                                               FROM (
                                                     SELECT *
                                                      FROM (
                                                            SELECT SCSB.ACNO_ENCR /* 계좌번호 암호화 */
                                                                 , SCSB.CRCDNO_ENCR /* 신용카드번호 암호화 */
                                                                 , SCSB.OWR_KNM
                                                                 , SCSB.BNK_CD 
                                                                 , SCSB.CDCO_CD
                                                                 , SCSR.DTL_CNTR_NO 
                                                                 , SCSR.DTL_CNTR_SN
                                                                 , SCSB.MPY_BSDT
                                                                 , SCSB.DP_TP_CD
                                                                 , ROW_NUMBER() OVER(PARTITION BY SCSR.DTL_CNTR_NO, SCSR.DTL_CNTR_SN ORDER BY SCSR.VL_STRT_DTM DESC) AS RN
                                                              FROM TB_SSCT_CNTR_STLM_REL SCSR
                                                              JOIN TB_SSCT_CNTR_STLM_BAS SCSB /* 계약결제기본 */
                                                                ON SCSR.CNTR_STLM_ID = SCSB.CNTR_STLM_ID 
                                                               AND SCSB.DTA_DL_YN = 'N'
                                                               AND SCSR.DTA_DL_YN = 'N'
                                                               AND SCSB.DP_TP_CD IN ('0102','0203')
                                                               AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN VL_STRT_DTM AND VL_END_DTM
                                                       )
                                                 WHERE RN = 1
                                                   ) A
                                               JOIN TB_SSCT_CNTR_DTL SCD
                                                 ON A.DTL_CNTR_NO = SCD.CNTR_NO
                                                AND A.DTL_CNTR_SN = SCD.CNTR_SN
                                                AND SCD.DTA_DL_YN = 'N'
                                               JOIN TB_SSCT_CNTR_BAS SCB
                                                 ON SCB.CNTR_NO = SCD.CNTR_NO 
                                                AND SCB.DTA_DL_YN = 'N'
                                               JOIN TB_RVCL_ITG_BIL_OJ_BAS RIBB
                                                 ON RIBB.SUBOD_CNTR_NO = SCD.CNTR_NO 
                                                AND RIBB.SUBOD_CNTR_SN = SCD.CNTR_SN 
                                                AND RIBB.DTA_DL_YN = 'N'
                                    LEFT OUTER JOIN TB_RVCL_ITG_BIL_OJ_ERR_IZ RIEI
                                                 ON RIEI.DG_CNTR_NO = RIBB.DG_CNTR_NO
                                                AND RIEI.DG_CNTR_SN = RIBB.DG_CNTR_SN
                                                AND RIEI.DTA_DL_YN = 'N'
                                              WHERE RIBB.FNT_DV_CD IN ('01','02')
                                                AND RIBB.DG_CNTR_NO || RIBB.DG_CNTR_SN = RIBB.SUBOD_CNTR_NO || RIBB.SUBOD_CNTR_SN
                                                <if test='@MybatisUtils@equals(unrgRs, "01")'>
                                                AND AFTN_ITG_UNRG_RS_CD = '00'
                                                </if>
                                                <if test='@MybatisUtils@equals(unrgRs, "02")'>
                                                AND AFTN_ITG_UNRG_RS_CD != '00'
                                                </if>
                                                <if test='@MybatisUtils@isNotEmpty(cntrPdStrtdt)'>
                                                AND RIBB.FNL_MDFC_DTM >= #{cntrPdStrtdt} || '000000' 
                                                </if>
                                                <if test='@MybatisUtils@isNotEmpty(cntrPdEnddt)'>
                                                AND RIBB.FNL_MDFC_DTM <![CDATA[ <= ]]> #{cntrPdEnddt} || '000000'
                                                </if>
                                         ) DG_CNTR
                                       JOIN (
                                             SELECT RIBB.DG_CNTR_NO
                                                  , RIBB.DG_CNTR_SN
                                                  , RIBB.SUBOD_CNTR_NO 
                                                  , RIBB.SUBOD_CNTR_SN 
                                                  , A.DP_TP_CD 
                                                  , A.BNK_CD
                                                  , A.CDCO_CD 
                                                  , A.ACNO_ENCR
                                                  , A.CRCDNO_ENCR
                                                  , A.OWR_KNM    
                                                  , A.MPY_BSDT
                                                  , RIEI.ITG_BIL_PRTC_DTM   
                                                  , RIEI.FNL_MDFC_USR_ID    
                                                  , RIEI.AFTN_ITG_UNRG_RS_CD    
                                                  , RIEI.AFTN_ITG_UNRG_RSON_CD  
                                                  , RIEI.ERR_CN 
                                               FROM (
                                                     SELECT *
                                                      FROM (
                                                            SELECT SCSB.ACNO_ENCR /* 계좌번호 암호화 */
                                                                 , SCSB.CRCDNO_ENCR /* 신용카드번호 암호화 */
                                                                 , SCSB.OWR_KNM
                                                                 , SCSB.BNK_CD 
                                                                 , SCSB.CDCO_CD
                                                                 , SCSR.DTL_CNTR_NO 
                                                                 , SCSR.DTL_CNTR_SN
                                                                 , SCSB.MPY_BSDT
                                                                 , SCSB.DP_TP_CD
                                                                 , ROW_NUMBER() OVER(PARTITION BY SCSR.DTL_CNTR_NO, SCSR.DTL_CNTR_SN ORDER BY SCSR.VL_STRT_DTM DESC) AS RN
                                                              FROM TB_SSCT_CNTR_STLM_REL SCSR
                                                              JOIN TB_SSCT_CNTR_STLM_BAS SCSB /* 계약결제기본 */
                                                                ON SCSR.CNTR_STLM_ID = SCSB.CNTR_STLM_ID 
                                                               AND SCSB.DTA_DL_YN = 'N'
                                                               AND SCSR.DTA_DL_YN = 'N'
                                                               AND SCSB.DP_TP_CD IN ('0102','0203')
                                                               AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN VL_STRT_DTM AND VL_END_DTM
                                                       )
                                                 WHERE RN = 1
                                                   ) A
                                               JOIN TB_SSCT_CNTR_DTL SCD
                                                 ON A.DTL_CNTR_NO = SCD.CNTR_NO
                                                AND A.DTL_CNTR_SN = SCD.CNTR_SN
                                                AND SCD.DTA_DL_YN = 'N'
                                               JOIN TB_SSCT_CNTR_BAS SCB
                                                 ON SCB.CNTR_NO = SCD.CNTR_NO 
                                                AND SCB.DTA_DL_YN = 'N'
                                               JOIN TB_RVCL_ITG_BIL_OJ_BAS RIBB
                                                 ON RIBB.SUBOD_CNTR_NO = SCD.CNTR_NO 
                                                AND RIBB.SUBOD_CNTR_SN = SCD.CNTR_SN 
                                                AND RIBB.DTA_DL_YN = 'N'
                                    LEFT OUTER JOIN TB_RVCL_ITG_BIL_OJ_ERR_IZ RIEI
                                                 ON RIEI.SUBOD_CNTR_NO = RIBB.SUBOD_CNTR_NO
                                                AND RIEI.SUBOD_CNTR_SN = RIBB.SUBOD_CNTR_SN
                                                AND RIEI.DTA_DL_YN = 'N'
                                              WHERE RIBB.FNT_DV_CD IN ('01','02')
                                                AND RIBB.DG_CNTR_NO || RIBB.DG_CNTR_SN != RIBB.SUBOD_CNTR_NO || RIBB.SUBOD_CNTR_SN
                                                <if test='@MybatisUtils@equals(unrgRs, "01")'>
                                                AND AFTN_ITG_UNRG_RS_CD = '00'
                                                </if>
                                                <if test='@MybatisUtils@equals(unrgRs, "02")'>
                                                AND AFTN_ITG_UNRG_RS_CD != '00'
                                                </if>
                                                <if test='@MybatisUtils@isNotEmpty(cntrPdStrtdt)'>
                                                AND RIBB.FNL_MDFC_DTM >= #{cntrPdStrtdt} || '000000' 
                                                </if>
                                                <if test='@MybatisUtils@isNotEmpty(cntrPdEnddt)'>
                                                AND RIBB.FNL_MDFC_DTM <![CDATA[ <= ]]> #{cntrPdEnddt} || '000000'
                                                </if>
                                         ) SUBOD_CNTR
                                         ON DG_CNTR.DG_CNTR_NO = SUBOD_CNTR.DG_CNTR_NO
                                        AND DG_CNTR.DG_CNTR_SN = SUBOD_CNTR.DG_CNTR_SN
                                   ) T1
                                ON SCD.CNTR_NO = T1.DG_CNTR_NO
                               AND SCD.CNTR_SN = T1.DG_CNTR_SN
                             WHERE 1 = 1
                               <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                               AND T1.DG_CNTR_NO = #{cntrNo}
                               AND T1.DG_CNTR_SN = #{cntrSn}
                               </if>
    </select>
</mapper>