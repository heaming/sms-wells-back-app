<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.bilfnt.mapper.WwdaNotReceivedCheckListMapper">

    <select id="selectAftnBilNrcvListPages" resultType="com.kyowon.sms.wells.web.withdrawal.bilfnt.dto.WwdaNotReceivedCheckListDto$SearchAftnBilNrcvListRes">
        SELECT AUTO_FNT_CLSF
             , CASE WHEN BNK_CD IS NULL THEN '은행 또는 카드 값이 없음' ELSE BNK_CD END AS BNK_CD
             , CASE WHEN BNK_NM IS NULL THEN '은행 또는 카드 값이 없음' ELSE BNK_NM END AS BNK_NM
             , COUNT(*) AS CT
          FROM (
                        SELECT '자동이체(은행) 청구되었으나 미수신건' AS AUTO_FNT_CLSF
                                     , CASE WHEN SCSB.DP_TP_CD = '0102' THEN SCSB.BNK_CD ELSE SCSB.CDCO_CD END AS BNK_CD
                                     , (SELECT FNIT_NM FROM TB_RVDW_FNIT_CD WHERE LPAD(CASE WHEN SCSB.DP_TP_CD = '0102' 
                                            THEN SCSB.BNK_CD ELSE SCSB.CDCO_CD END ,3,0) = FNIT_CD)
                                            AS BNK_NM /* 은행명 */
                                  FROM TB_RVCL_BIL_FNT_AK_BAS RBFB
                                  JOIN TB_RVCL_BIL_FNT_AK_DTL RBFD
                                    ON RBFB.BIL_NO = RBFD.BIL_NO 
                                   AND RBFB.DTA_DL_YN = 'N'
                                   AND RBFD.DTA_DL_YN = 'N'
                                  JOIN TB_SSCT_CNTR_DTL SCD
                                    ON SCD.CNTR_NO = RBFD.CNTR_NO 
                                   AND SCD.CNTR_SN = RBFD.CNTR_SN 
                                   AND SCD.DTA_DL_YN = 'N'
                                  JOIN TB_SSCT_CNTR_BAS SCB
                                    ON SCD.CNTR_NO = SCB.CNTR_NO 
                                   AND SCB.DTA_DL_YN = 'N'
                                  JOIN TB_CUBS_CST_BAS CCB
                                    ON CCB.CST_NO = SCB.CNTR_CST_NO
                                   AND CCB.DTA_DL_YN = 'N'
                                  JOIN TB_SSCT_CNTR_STLM_BAS SCSB
                                    ON SCSB.CNTR_NO = SCB.CNTR_NO 
                                   AND SCSB.CST_NO = SCB.CNTR_CST_NO
                                   AND SCSB.DTA_DL_YN = 'N'
                                  <if test='@MybatisUtils@equals(fntDvCd, "01")'>
                                  JOIN TB_RVCL_AC_FNT_SEND_MTR_IZ RAFS
                                    ON RBFB.BIL_NO = RAFS.BIL_NO 
                                   AND RAFS.DTA_DL_YN = 'N'
                                  </if>
                                  <if test='@MybatisUtils@equals(fntDvCd, "02")'>
                                  JOIN TB_RVCL_CARD_FNT_SEND_MTR_IZ RCFS
                                    ON RBFB.BIL_NO = RCFS.BIL_NO 
                                   AND RCFS.DTA_DL_YN = 'N'
                                  </if>
                                 WHERE RBFB.BIL_DT = #{bilDt}
                                   AND RBFB.FNT_DV_CD = #{fntDvCd}
                                   <if test='@MybatisUtils@equals(fntDvCd, "01")'>
                                   AND RAFS.AC_FNT_RS_CD != '0000'
                                   </if>
                                   <if test='@MybatisUtils@equals(fntDvCd, "02")'>
                                   AND RCFS.CARD_FNT_RS_CD != '0000'
                                   </if>
        )   
        GROUP BY AUTO_FNT_CLSF, BNK_CD,BNK_NM

    </select>
    
    <select id="selectAftnDpNcrtCheckListPages" resultType="com.kyowon.sms.wells.web.withdrawal.bilfnt.dto.WwdaNotReceivedCheckListDto$SearchAftnDpNcrtCheckListRes">
               SELECT '자동이체(은행) 수신되었으나 입금반영 안된 건' AS AFTN_CLSF
                     , RBFD.CNTR_NO || RBFD.CNTR_SN AS CNTR_SN
                     , RBFB.BIL_DT  
                     , SCD.SELL_TP_CD 
                     , RBFD.DP_AMT  
                  FROM TB_RVCL_BIL_FNT_AK_BAS RBFB
                  JOIN TB_RVCL_BIL_FNT_AK_DTL RBFD
                    ON RBFB.BIL_NO = RBFD.BIL_NO
                   AND RBFB.DTA_DL_YN = 'N'
                   AND RBFD.DTA_DL_YN = 'N'
            <if test='@MybatisUtils@equals(fntDvCd, "01")'>
            INNER JOIN TB_RVCL_AC_FNT_SEND_MTR_IZ RAFS
                    ON RBFB.BIL_NO = RAFS.BIL_NO 
                   AND RAFS.DTA_DL_YN = 'N'
                   AND RAFS.AC_FNT_RS_CD != '0000'
            </if>
            <if test='@MybatisUtils@equals(fntDvCd, "02")'>
            INNER JOIN TB_RVCL_CARD_FNT_SEND_MTR_IZ RCFS
                    ON RBFB.BIL_NO = RCFS.BIL_NO 
                   AND RCFS.DTA_DL_YN = 'N'
                   AND RCFS.CARD_FNT_RS_CD != '0000'
            </if>
            INNER JOIN TB_SSCT_CNTR_DTL SCD
                    ON RBFD.CNTR_NO = SCD.CNTR_NO
                   AND RBFD.CNTR_SN = SCD.CNTR_SN
                   AND SCD.DTA_DL_YN = 'N'
            INNER JOIN TB_SSCT_CNTR_BAS SCB
                    ON SCD.CNTR_NO = SCB.CNTR_NO 
                   AND SCB.DTA_DL_YN = 'N'
                   AND SCB.CNTR_CAN_DTM IS NULL
       LEFT OUTER JOIN TB_RVDW_RVE_AK_DTL RRAD
                    ON RBFD.BIL_NO = RRAD.RVE_AK_OJ_DRM_NO1
                   AND RBFD.BIL_DTL_SN = RRAD.RVE_AK_OJ_DRM_NO2
                   AND RRAD.DTA_DL_YN = 'N'
                 WHERE RBFB.BIL_DT = #{bilDt}
                   AND RBFB.FNT_DV_CD = #{fntDvCd}
              ORDER BY DP_AMT DESC
    </select>
    
    <select id="selectAftnSlPerfCheckInqrPages" resultType="com.kyowon.sms.wells.web.withdrawal.bilfnt.dto.WwdaNotReceivedCheckListDto$SearchAftnSlPerfCheckInqrRes">
           /* 기준년월 = 당월(영업선수금일마감)  */
           SELECT '매출실적 입금반영 누락건(' || (SELECT CD_CNTN
                                              FROM T_CMZ_CD_D
                                             WHERE CD_ID = UPPER('SELL_TP_CD')
                                               AND DEL_YN = 'N' 
                                               AND CD_VLD_VAL = T2.SELL_TP_CD 
                                               AND TENANT_ID = #{session.tenantId}
                   ) || ')' AS SELL_TP_NM
                   , T2.DP_CL_DT
                   , T2.CNTR_NO || T2.CNTR_SN AS CNTR_SN
                   , '' AS RENTAL_NMN
                   , T1.THM_INTAM_DP_AMT
                   , T1.THM_ISTM_RFND_AMT
                   , T1.RVE_AMT
                   , ( SELECT CD_CNTN
                         FROM T_CMZ_CD_D
                        WHERE CD_ID = UPPER('DP_MES_CD')
                          AND DEL_YN = 'N' 
                          AND CD_VLD_VAL = T2.DP_MES_CD
                          AND TENANT_ID = #{session.tenantId}
                     ) AS DP_MES_CD 
               FROM (
                        SELECT CBAB.CNTR_NO, CBAB.CNTR_SN
                             , 0 AS THM_INTAM_DP_AMT
                             , 0 AS THM_ISTM_RFND_AMT
                             , SUM(RRD.RVE_AMT) AS RVE_AMT
                          FROM TB_CBCL_BZNS_ATAM_BAS CBAB
                          JOIN TB_RVDW_RVE_DTL RRD
                            ON CBAB.RVE_NO = RRD.RVE_NO 
                           AND CBAB.RVE_SN = RRD.RVE_SN 
                           AND CBAB.DTA_DL_YN = 'N'
                           AND RRD.DTA_DL_YN = 'N'
                         WHERE EXISTS ( SELECT 1
                                         FROM TB_CBCL_BZNS_ATAM_BAS CBAB
                                         JOIN TB_RVDW_RVE_DTL RRD
                                           ON CBAB.RVE_NO = RRD.RVE_NO 
                                          AND CBAB.RVE_SN = RRD.RVE_SN 
                                          AND CBAB.DTA_DL_YN = 'N'
                                          AND RRD.DTA_DL_YN = 'N'
                                        WHERE 1 = 1
                                          AND SUBSTR(CBAB.DP_CL_DT,1 , 6) = #{baseYm}
                                     GROUP BY CBAB.RVE_AMT , RRD.RVE_AMT
                                       HAVING SUM(CBAB.RVE_AMT) != SUM(RRD.RVE_AMT)
                                     )
                      GROUP BY CBAB.CNTR_NO, CBAB.CNTR_SN
                      ) T1
                JOIN (
                        SELECT CBAB.DP_CL_DT
                             , SCD.SELL_TP_CD
                             , RRAD.DP_MES_CD AS DP_MES_CD
                             , RBFB.CNTR_NO
                             , RBFB.CNTR_SN
                          FROM TB_CBCL_BZNS_ATAM_BAS CBAB
                          JOIN TB_RVDW_RVE_DTL RRD
                            ON CBAB.RVE_NO = RRD.RVE_NO 
                           AND CBAB.RVE_SN = RRD.RVE_SN 
                           AND CBAB.DTA_DL_YN = 'N'
                           AND RRD.DTA_DL_YN = 'N'
                          JOIN TB_RVCL_BIL_FNT_AK_DTL RBFB
                            ON RRD.RVE_OJ_DRM_NO1 = RBFB.BIL_NO
                           AND RRD.RVE_OJ_DRM_NO2 = RBFB.BIL_DTL_SN 
                           AND RBFB.DTA_DL_YN = 'N'
                          JOIN TB_SSCT_CNTR_DTL SCD
                            ON SCD.CNTR_NO = RRD.RVE_OJ_DRM_NO1
                           AND SCD.CNTR_SN = RRD.RVE_OJ_DRM_NO2
                           AND SCD.DTA_DL_YN = 'N'
                          JOIN TB_RVDW_RVE_AK_DTL RRAD
                            ON RRD.RVE_AK_NO = RRAD.RVE_AK_NO 
                           AND RRD.RVE_AK_SN = RRAD.RVE_AK_SN 
                           AND RRAD.DTA_DL_YN = 'N'
                        ) T2
                       ON T1.CNTR_NO = T2.CNTR_NO
                      AND T1.CNTR_SN = T2.CNTR_SN
              UNION ALL
              /* 기준년월 <![CDATA[ > ]]> 당월(계약실적월마감) */
              SELECT '매출실적 입금반영 누락건(' || (SELECT CD_CNTN
                                              FROM T_CMZ_CD_D
                                             WHERE CD_ID = UPPER('SELL_TP_CD')
                                               AND DEL_YN = 'N' 
                                               AND CD_VLD_VAL = T4.SELL_TP_CD 
                                               AND TENANT_ID = #{session.tenantId}
                   ) || ')' AS SELL_TP_NM
                   , T4.DP_CL_DT
                   , T4.CNTR_NO || T4.CNTR_SN AS CNTR_SN
                   , '' AS RENTAL_NMN
                   , T3.THM_INTAM_DP_AMT
                   , T3.THM_ISTM_RFND_AMT
                   , T3.RVE_AMT
                   , ( SELECT CD_CNTN
                         FROM T_CMZ_CD_D
                        WHERE CD_ID = UPPER('DP_MES_CD')
                          AND DEL_YN = 'N' 
                          AND CD_VLD_VAL = T4.DP_MES_CD
                          AND TENANT_ID = #{session.tenantId}
                     ) AS DP_MES_CD 
              FROM (
                    SELECT CWSM.CNTR_NO, CWSM.CNTR_SN
                         , SUM(CWSM.THM_INTAM_DP_AMT) AS THM_INTAM_DP_AMT
                         , SUM(CWSM.THM_ISTM_RFND_AMT) AS THM_ISTM_RFND_AMT
                         , SUM(RRD.RVE_AMT) AS RVE_AMT
                      FROM TB_CBCL_WELLS_SL_MM_CL_IZ CWSM
                      JOIN TB_SSCT_CNTR_DTL SCD
                        ON SCD.CNTR_NO = CWSM.CNTR_NO
                       AND SCD.CNTR_SN = CWSM.CNTR_NO
                       AND CWSM.DTA_DL_YN = 'N'
                       AND SCD.DTA_DL_YN = 'N'
                      JOIN TB_RVCL_BIL_FNT_AK_DTL RBFD
                        ON SCD.CNTR_NO = RBFD.CNTR_NO
                       AND SCD.CNTR_SN = RBFD.CNTR_SN 
                       AND RBFD.DTA_DL_YN = 'N'
                      JOIN TB_RVDW_RVE_DTL RRD
                        ON SCD.CNTR_NO = RRD.RVE_OJ_DRM_NO1 
                       AND SCD.CNTR_SN = RRD.RVE_OJ_DRM_NO2 
                       AND RRD.DTA_DL_YN = 'N'
                     WHERE EXISTS ( SELECT 1
                                     FROM TB_CBCL_WELLS_SL_MM_CL_IZ CWSM
                                     JOIN TB_SSCT_CNTR_DTL SCD
                                       ON SCD.CNTR_NO = CWSM.CNTR_NO
                                      AND SCD.CNTR_SN = CWSM.CNTR_SN
                                      AND CWSM.DTA_DL_YN = 'N'
                                     JOIN TB_RVDW_RVE_DTL RRD
                                       ON CWSM.CNTR_NO = RRD.RVE_NO 
                                      AND CWSM.CNTR_SN = RRD.RVE_SN 
                                      AND CWSM.DTA_DL_YN = 'N'
                                      AND RRD.DTA_DL_YN = 'N'
                                    WHERE CWSM.SL_CL_YM = #{baseYm}
                                 GROUP BY CWSM.THM_INTAM_DP_AMT, CWSM.THM_ISTM_RFND_AMT, RRD.RVE_AMT
                                   HAVING CWSM.THM_INTAM_DP_AMT - CWSM.THM_ISTM_RFND_AMT != SUM(RVE_AMT) 
                                 )
                  GROUP BY CWSM.CNTR_NO, CWSM.CNTR_SN
                   ) T3
              JOIN (
                    SELECT CWSM.SL_CL_DT AS DP_CL_DT
                         , SCD.SELL_TP_CD
                         , RRAD.DP_MES_CD
                         , RBFD.CNTR_NO 
                         , RBFD.CNTR_SN
                      FROM TB_CBCL_WELLS_SL_MM_CL_IZ CWSM
                      JOIN TB_SSCT_CNTR_DTL SCD
                        ON SCD.CNTR_NO = CWSM.CNTR_NO
                       AND SCD.CNTR_SN = CWSM.CNTR_NO
                       AND CWSM.DTA_DL_YN = 'N'
                       AND SCD.DTA_DL_YN = 'N'
                      JOIN TB_RVCL_BIL_FNT_AK_DTL RBFD
                        ON SCD.CNTR_NO = RBFD.CNTR_NO
                       AND SCD.CNTR_SN = RBFD.CNTR_SN 
                       AND RBFD.DTA_DL_YN = 'N'
                      JOIN TB_RVDW_RVE_DTL RRD
                        ON SCD.CNTR_NO = RRD.RVE_OJ_DRM_NO1 
                       AND SCD.CNTR_SN = RRD.RVE_OJ_DRM_NO2 
                       AND RRD.DTA_DL_YN = 'N'
                      JOIN TB_RVDW_RVE_AK_DTL RRAD
                        ON RRD.RVE_AK_NO = RRAD.RVE_AK_NO 
                       AND RRD.RVE_AK_SN = RRAD.RVE_AK_SN 
                       AND RRAD.DTA_DL_YN = 'N'
                   ) T4
                ON T3.CNTR_NO = T4.CNTR_NO
               AND T3.CNTR_SN = T4.CNTR_SN
    </select>
    
    <select id="selectAftnRsBndlErrInqrPages" resultType="com.kyowon.sms.wells.web.withdrawal.bilfnt.dto.WwdaNotReceivedCheckListDto$SearchResultBundleErrorRes">
                    SELECT MSTR_SELL_TP_CD
                         , DG_CNTR_NO
                         , MSTR_DP_TP_CD
                         , SUB_SELL_TP_CD
                         , SUBOD_CNTR_NO
                         , SUB_DP_TP_CD
                         , ERR_TYP
                      FROM (
                                SELECT MSTR_CNTR.SELL_TP_CD AS MSTR_SELL_TP_CD
                                     , RIBB.DG_CNTR_NO
                                     , MSTR_CNTR.DP_TP_CD AS MSTR_DP_TP_CD
                                     , SUB_CNTR.SELL_TP_CD AS SUB_SELL_TP_CD
                                     , RIBB.SUBOD_CNTR_NO
                                     , SUB_CNTR.DP_TP_CD AS SUB_DP_TP_CD
                                     , CASE WHEN MSTR_CNTR.ACNO_ENCR != SUB_CNTR.ACNO_ENCR OR MSTR_CNTR.CRCDNO_ENCR != SUB_CNTR.CRCDNO_ENCR
                                                 THEN (CASE WHEN #{dpTpCd} = '0102' THEN '2.계좌번호상이' || MSTR_CNTR.ACNO_ENCR || '/' || SUB_CNTR.ACNO_ENCR || ')' 
                                                            WHEN #{dpTpCd} = '0203' THEN '2.카드번호상이' || MSTR_CNTR.CRCDNO_ENCR || '/' || SUB_CNTR.CRCDNO_ENCR || ')' 
                                                       END)
                                            WHEN MSTR_CNTR.BNK_CD != SUB_CNTR.BNK_CD OR MSTR_CNTR.CDCO_CD != SUB_CNTR.CDCO_CD 
                                                 THEN (CASE WHEN #{dpTpCd} = '0102' THEN '2.은행코드상이' || (SELECT CD_CNTN
                                                                                                  FROM T_CMZ_CD_D 
                                                                                                 WHERE CD_ID = UPPER('BNK_CD')
                                                                                                   AND TENANT_ID = #{session.tenantId}
                                                                                                   AND DEL_YN = 'N'
                                                                                                   AND CD_VLD_VAL = MSTR_CNTR.BNK_CD)
                                                                                               || '/'  
                                                                                               || (SELECT CD_CNTN
                                                                                                  FROM T_CMZ_CD_D 
                                                                                                 WHERE CD_ID = UPPER('BNK_CD')
                                                                                                   AND TENANT_ID = #{session.tenantId}
                                                                                                   AND DEL_YN = 'N'
                                                                                                   AND CD_VLD_VAL = SUB_CNTR.BNK_CD)
                                                                                               || ')' 
                                                            WHEN #{dpTpCd} = '0203' THEN '2.계좌구분상이' || (SELECT CD_CNTN
                                                                                                  FROM T_CMZ_CD_D 
                                                                                                 WHERE CD_ID = UPPER('CDCO_CD')
                                                                                                   AND TENANT_ID = #{session.tenantId}
                                                                                                   AND DEL_YN = 'N'
                                                                                                   AND CD_VLD_VAL = MSTR_CNTR.CDCO_CD)
                                                                                               || '/'  
                                                                                               || (SELECT CD_CNTN
                                                                                                  FROM T_CMZ_CD_D 
                                                                                                 WHERE CD_ID = UPPER('CDCO_CD')
                                                                                                   AND TENANT_ID = #{session.tenantId}
                                                                                                   AND DEL_YN = 'N'
                                                                                                   AND CD_VLD_VAL = SUB_CNTR.CDCO_CD)
                                                                                               || ')'                                      
                                                                                              END)
                                            WHEN MSTR_CNTR.CST_NO != SUB_CNTR.CST_NO THEN '4.인증번호 상이(' || MSTR_CNTR.CST_NO || '/' || SUB_CNTR.CST_NO || ')'
                                            WHEN MSTR_CNTR.MPY_BSDT != SUB_CNTR.MPY_BSDT THEN '5.이체일자상이(' || MSTR_CNTR.MPY_BSDT || '/' || SUB_CNTR.MPY_BSDT || ')'
                                            WHEN MSTR_CNTR.DP_TP_CD != SUB_CNTR.DP_TP_CD 
                                                 THEN '6.이체구분상이(' || (
                                                                        SELECT CD_CNTN
                                                                          FROM T_CMZ_CD_D 
                                                                         WHERE CD_ID = UPPER('DP_TP_CD')
                                                                           AND TENANT_ID = #{session.tenantId}
                                                                           AND DEL_YN = 'N'
                                                                           AND CD_VLD_VAL = MSTR_CNTR.DP_TP_CD
                                                                        )
                                                                     || '/'
                                                                     || (
                                                                        SELECT CD_CNTN
                                                                          FROM T_CMZ_CD_D 
                                                                         WHERE CD_ID = UPPER('DP_TP_CD')
                                                                           AND TENANT_ID = #{session.tenantId}
                                                                           AND DEL_YN = 'N'
                                                                           AND CD_VLD_VAL = SUB_CNTR.DP_TP_CD
                                                                        )
                                                                      || ')'
                                            WHEN MSTR_CNTR.SELL_TP_CD = '3' OR SUB_CNTR.SELL_TP_CD = '3' THEN '7.멤버십주문묶음출금등록불가'
                                            WHEN MSTR_CNTR.SELL_TP_CD = '1' OR SUB_CNTR.SELL_TP_CD = '1' THEN '8.일시불주문묶음출금등록불가'
                                            WHEN MSTR_CNTR.CNTR_DTL_STAT_CD != '101' OR MSTR_CNTR.CNTR_NO IS NULL THEN '10.대표주문번호 계약종료'
                                       END AS ERR_TYP
                                  FROM TB_RVCL_ITG_BIL_OJ_BAS RIBB
                                  JOIN (
                                         SELECT SCD.CNTR_NO
                                              , SCD.CNTR_SN
                                              , SCD.SELL_TP_CD
                                              , SCSB.DP_TP_CD
                                              , SCSB.BNK_CD
                                              , SCSB.CDCO_CD
                                              , SCD.CNTR_DTL_STAT_CD
                                              , SCSB.MPY_BSDT
                                              , SCSB.CST_NO
                                              , SCSB.ACNO_ENCR
                                              , SCSB.CRCDNO_ENCR
                                           FROM TB_SSCT_CNTR_DTL SCD
                                           JOIN TB_SSCT_CNTR_BAS SCB
                                             ON SCD.CNTR_NO = SCB.CNTR_NO
                                            AND SCB.CNTR_CAN_DTM IS NULL
                                            AND SCD.DTA_DL_YN = 'N'
                                            AND SCB.DTA_DL_YN = 'N'
                                           JOIN TB_SSCT_CNTR_STLM_BAS SCSB
                                             ON SCSB.CST_NO = SCB.CNTR_CST_NO 
                                            AND SCSB.CNTR_NO = SCB.CNTR_NO  
                                            AND SCSB.DTA_DL_YN = 'N'
                                       ) MSTR_CNTR
                                    ON RIBB.DG_CNTR_NO = MSTR_CNTR.CNTR_NO
                                   AND RIBB.DG_CNTR_SN = MSTR_CNTR.CNTR_SN
                                   AND RIBB.DTA_DL_YN ='N'
                        JOIN (
                                         SELECT SCD.CNTR_NO
                                              , SCD.CNTR_SN
                                              , SCD.SELL_TP_CD
                                              , SCSB.DP_TP_CD
                                              , SCSB.BNK_CD
                                              , SCSB.CDCO_CD
                                              , SCD.CNTR_DTL_STAT_CD
                                              , SCSB.MPY_BSDT
                                              , SCSB.CST_NO
                                              , SCSB.ACNO_ENCR
                                              , SCSB.CRCDNO_ENCR
                                           FROM TB_SSCT_CNTR_DTL SCD
                                           JOIN TB_SSCT_CNTR_BAS SCB
                                             ON SCD.CNTR_NO = SCB.CNTR_NO
                                            AND SCB.CNTR_CAN_DTM IS NULL
                                            AND SCD.DTA_DL_YN = 'N'
                                            AND SCB.DTA_DL_YN = 'N'
                                           JOIN TB_SSCT_CNTR_STLM_BAS SCSB
                                             ON SCSB.CST_NO = SCB.CNTR_CST_NO 
                                            AND SCSB.CNTR_NO = SCB.CNTR_NO  
                                            AND SCSB.DTA_DL_YN = 'N'
                                       ) SUB_CNTR
                                   ON RIBB.SUBOD_CNTR_NO = SUB_CNTR.CNTR_NO
                                  AND RIBB.SUBOD_CNTR_SN = SUB_CNTR.CNTR_SN
                                  AND RIBB.DTA_DL_YN ='N'
                                WHERE RIBB.DG_CNTR_NO != RIBB.SUBOD_CNTR_NO 
                                  AND MSTR_CNTR.DP_TP_CD = #{dpTpCd}
                           ) 
                         WHERE ERR_TYP IS NOT NULL
    </select>
</mapper>