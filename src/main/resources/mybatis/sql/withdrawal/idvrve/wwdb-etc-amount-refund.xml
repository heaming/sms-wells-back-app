<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.idvrve.mapper.WwdbEtcAmountRefundMapper">
    
    <select id="selectEtcAmountRefunds" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbEtcAmountRefundDto$SearchEtcAmountRefundRes">
        SELECT 
               SCD.CNTR_NO || SCD.CNTR_SN AS CNTR_NO_SN /* 계약상세번호 */
             , CCB.CST_KNM                             /* 고객명 */ 
             , RRRB.FNL_MDFC_DTM                        /* 처리일자 */
             , RRD.PERF_DT                              /* 실적일자 */
             , SCD.CNTRW_TP_CD                          /* 업무구분 */
             , '' AS tmp1                               /* 입금종류.  1 이면 할부, 2이면 매변, 3이면 손료, 4이면 위약, 5이면 가산 */
             , '' AS tmp3                               /* 환불구분. 입금구분(CWJDIV) ='2' 환불이고 업무구분(CWJDIV)이 전집이고 환불유형(CWHFLG ) 87 이면 귀속 아니면 정상 */
             , SISI.BASE_CNTR_NO                        /* 불완전판매구분 */
             , NVL(SCD.SELL_AMT, 0) AS SELL_AMT                             /* 판매금액*/
             , NVL(RRRD.RFND_DSB_AMT, 0) AS tmp2                /* 테이블 컬럼명 확인필요. 지급금액 */
             , NVL(RRRD.RFND_DSB_AMT, 0) AS RFND_DSB_AMT                       /* 환불금액 = 환불지급금액 */
             , NVL(RRRD.RFND_DSB_PSP_INT, 0) AS RFND_DSB_PSP_INT                   /* 지연이자 환불지급지연이자 */
             , NVL(RRRD.CARD_RFND_FEE, 0) AS CARD_RFND_FEE                       /* 카드수수료 */
             , ( SELECT FNIT_NM
                   FROM TB_RVDW_FNIT_CD                 /* 금융기관코드 */
                  WHERE FNIT_CD = ( 
                                    CASE WHEN RRRD.CSH_RFND_FNIT_CD IS NULL 
                                         THEN RRRD.CARD_RFND_FNIT_CD 
                                         ELSE RRRD.CSH_RFND_FNIT_CD 
                                     END
                                  )
             ) AS CSH_CARD_RFND_FNIT_CD                 /* 은행/카드사 RFND_BNK_CDCO_CD  */
             , RRRD.CARD_RFND_CRCDNO_ENCR               /* 카드번호 */
             , RRRD.CSH_RFND_ACNO_ENCR                  /* 계좌번호 */
             , '' AS CSH_CARD_RFND_ACNO_CRCDNO_ENCR     /* 계좌/카드번호 */
             , RRRD.CSH_RFND_ACOWN_NM                   /* 예금주 */
             , SCD.ISTM_MCN                             /* 할부개월 : 계약상세.할부개월수 */
             , RRRD.CARD_RFND_CRDCD_APRNO               /* 승인번호 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
         INNER JOIN TB_RVDW_RFND_RCP_DTL RRRD           /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N' 
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
         INNER JOIN TB_SSCT_CNTR_DTL SCD                /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약일련번호 */
         INNER JOIN TB_RVDW_RVE_DTL RRD                 /* 수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND RRRD.KW_GRP_CO_CD = RRD.KW_GRP_CO_CD     /* 교원그룹회사코드 */
           AND RRRD.RVE_NO = RRD.RVE_NO                 /* 수납번호 */
         INNER JOIN TB_CUBS_CST_BAS CCB                 /* 고객기본 */
            ON CCB.DTA_DL_YN = 'N'
           AND RRRB.CST_NO = CCB.CST_NO                 /* 고객번호 */
          LEFT OUTER JOIN TB_SSCT_ICPT_SELL_IZ SISI     /* 불완전판매내역 */
            ON SISI.DTA_DL_YN = 'N'
           AND SCD.CNTR_NO = SISI.OJ_CNTR_NO                 /* 대상계약번호 */
           AND SCD.CNTR_SN = SISI.OJ_CNTR_SN                 /* 대상계약일련번호 */
         WHERE 1 = 1
           AND RRRB.FNL_MDFC_DTM BETWEEN #{startDay} AND #{endDay} /* 처리일자 */
           /* 테스트를 위해 주석. 수납상세 테이블 데이터 들어오기 전까지 주석 */
           /* AND RRD.PERF_DT BETWEEN {perfDtStartDay} AND {perfDtEndDay}           실적일자 */
           /* AND 환불구분 확인필요 */
           <if test="@MybatisUtils@isNotEmpty(baseCntrNo)">
           AND SISI.BASE_CNTR_NO = #{baseCntrNo}/* 불완전판매여부 */
           </if>
    </select>
    <select id="selectEtcAmountRefundAggregates" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbEtcAmountRefundDto$SearchEtcAmountRefundAggregateRes">
        WITH BASE AS 
           (
                SELECT RRRD.RFND_DSB_DV_CD                      /* 환불접수상세.환불지급유형코드 : 현금환불01/카드환불02/전금03 */
                     , RRRD.CARD_RFND_FNIT_CD                   /* 카드환불금융기관코드 */
                     , CASE WHEN RRRD.CARD_RFND_FNIT_CD IS NULL THEN 'CASH' /* 현금 : 환불카드사코드가 없는 금액 합계 (현금 합계) */
                            WHEN RRRD.CARD_RFND_FNIT_CD IN ('361') THEN 'BC_CARD' /* 비씨카드 */
                            WHEN RRRD.CARD_RFND_FNIT_CD IN ('381') THEN 'KB_CARD' /* 국민카드    환불카드사코드로 해당 카드 합계 */
                            WHEN RRRD.CARD_RFND_FNIT_CD IN ('365') THEN 'SS_CARD' /* 삼성카드 */
                            WHEN RRRD.CARD_RFND_FNIT_CD IN ('044', '374') THEN 'HN_CARD' /* 하나카드 */
                            WHEN RRRD.CARD_RFND_FNIT_CD IN ('366') THEN 'SH_CARD' /* 신한카드 */
                            WHEN RRRD.CARD_RFND_FNIT_CD IN ('368') THEN 'LT_CARD' /* 롯데카드 */
                            WHEN RRRD.CARD_RFND_FNIT_CD IN ('367') THEN 'HD_CARD' /* 현대카드 */
                            WHEN RRRD.CARD_RFND_FNIT_CD IN ('371') THEN 'NH_CARD' /* NH농협카드 */
                            WHEN RRRD.CARD_RFND_FNIT_CD IN ('000') THEN 'YD_CARD' /* 여민동락 : 값 확인안됨*/
                        END CARD_NAME
                     , NVL(RRRD.RFND_DSB_AMT, 0) AS RFND_DSB_AMT /* 환불지급금액 */
                     , NVL(RRRD.RFND_DDTN_AMT, 0) AS RFND_DDTN_AMT /* 환불공제금액 */
                     , NVL(RRRD.RFND_DSB_PSP_INT, 0) AS RFND_DSB_PSP_INT /* 환불지급지연이자*/
                  FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
                 INNER JOIN TB_RVDW_RFND_RCP_DTL RRRD           /* 환불접수상세 */
                    ON RRRB.DTA_DL_YN = 'N'
                   AND RRRD.DTA_DL_YN = 'N' 
                   AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
                   AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
                 /* INNER JOIN TB_SSCT_CNTR_DTL SCD                 계약상세 */  
                 LEFT OUTER JOIN TB_SSCT_CNTR_DTL SCD                /* 계약상세 */
                    ON SCD.DTA_DL_YN = 'N'
                   AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 */
                   AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약일련번호 */
                 /* INNER JOIN TB_RVDW_RVE_DTL RRD                  수납상세 */  
                 LEFT OUTER JOIN TB_RVDW_RVE_DTL RRD                 /* 수납상세 */
                    ON RRD.DTA_DL_YN = 'N'
                   AND RRRD.KW_GRP_CO_CD = RRD.KW_GRP_CO_CD     /* 교원그룹회사코드 */
                   AND RRRD.RVE_NO = RRD.RVE_NO                 /* 수납번호 */
                 /* INNER JOIN TB_CUBS_CST_BAS CCB                  고객기본 */  
                 LEFT OUTER JOIN TB_CUBS_CST_BAS CCB                 /* 고객기본 */
                    ON CCB.DTA_DL_YN = 'N'
                   AND RRRB.CST_NO = CCB.CST_NO                 /* 고객번호 */
                  LEFT OUTER JOIN TB_SSCT_ICPT_SELL_IZ SISI     /* 불완전판매내역 */
                    ON SISI.DTA_DL_YN = 'N'
                   AND SCD.CNTR_NO = SISI.OJ_CNTR_NO                 /* 대상계약번호 */
                   AND SCD.CNTR_SN = SISI.OJ_CNTR_SN                 /* 대상계약일련번호 */
                 WHERE 1 = 1
                   AND RRRB.FNL_MDFC_DTM BETWEEN #{startDay} AND #{endDay} /* 처리일자 */
                   /* 테스트를 위해 주석. 수납상세 테이블 데이터 들어오기 전까지 주석 */
                   /* AND RRD.PERF_DT BETWEEN {perfDtStartDay} AND {perfDtEndDay}           실적일자 */
                   /* AND 환불구분 확인필요 */
                   <if test="@MybatisUtils@isNotEmpty(baseCntrNo)">
                   AND SISI.BASE_CNTR_NO = #{baseCntrNo}/* 불완전판매여부 */
                   </if>
           ) ,
             RFND_DSB_AMT_SUM AS /* 환불지급금액 합계 */
           ( 
                SELECT *
                  FROM BASE
                 PIVOT (
                         SUM(RFND_DSB_AMT) AS RFND_DSB_AMT_SUM /* 환불지급금액 합계 */
                         FOR CARD_NAME IN ( 'CASH' AS CASH
                                          , 'BC_CARD' AS BC_CARD
                                          , 'KB_CARD' AS KB_CARD
                                          , 'SS_CARD' AS SS_CARD
                                          , 'HN_CARD' AS HN_CARD
                                          , 'SH_CARD' AS SH_CARD
                                          , 'LT_CARD' AS LT_CARD
                                          , 'HD_CARD' AS HD_CARD
                                          , 'NH_CARD' AS NH_CARD
                                          , 'YD_CARD' AS YD_CARD
                                          )
                       )
           ) , 
             RFND_DDTN_AMT_SUM AS /* 환불공제금액 합계 */
           ( 
               SELECT *
                 FROM BASE
                PIVOT (
                         SUM(RFND_DDTN_AMT) AS RFND_DDTN_AMT_SUM /* 환불공제금액 합계 */
                         FOR CARD_NAME IN ( 'CASH' AS CASH
                                          , 'BC_CARD' AS BC_CARD
                                          , 'KB_CARD' AS KB_CARD
                                          , 'SS_CARD' AS SS_CARD
                                          , 'HN_CARD' AS HN_CARD
                                          , 'SH_CARD' AS SH_CARD
                                          , 'LT_CARD' AS LT_CARD
                                          , 'HD_CARD' AS HD_CARD
                                          , 'NH_CARD' AS NH_CARD
                                          , 'YD_CARD' AS YD_CARD
                                          )
                       )
           ) , 
             RFND_DSB_AMT_SUM_CARD_RFND AS /* 환불지급금액 합계와 카드 (환불지급금액) 합계 */
           (
               SELECT 
                      NVL(CASH_RFND_DSB_AMT_SUM, 0) AS CASH_RFND_DSB_AMT_SUM /* 현금 환불지급금액 합계 */
                    , NVL(BC_CARD_RFND_DSB_AMT_SUM, 0) AS BC_CARD_RFND_DSB_AMT_SUM/* BC 환불지급금액 합계 */
                    , NVL(KB_CARD_RFND_DSB_AMT_SUM, 0) AS KB_CARD_RFND_DSB_AMT_SUM/* KB 환불지급금액 합계 */
                    , NVL(SS_CARD_RFND_DSB_AMT_SUM, 0) AS SS_CARD_RFND_DSB_AMT_SUM/* 삼성 환불지급금액 합계 */
                    , NVL(HN_CARD_RFND_DSB_AMT_SUM, 0) AS HN_CARD_RFND_DSB_AMT_SUM/* 하나 환불지급금액 합계 */
                    , NVL(SH_CARD_RFND_DSB_AMT_SUM, 0) AS SH_CARD_RFND_DSB_AMT_SUM/* 신한 환불지급금액 합계 */
                    , NVL(LT_CARD_RFND_DSB_AMT_SUM, 0) AS LT_CARD_RFND_DSB_AMT_SUM/* 롯데 환불지급금액 합계 */
                    , NVL(HD_CARD_RFND_DSB_AMT_SUM, 0) AS HD_CARD_RFND_DSB_AMT_SUM/* 현대 환불지급금액 합계 */
                    , NVL(NH_CARD_RFND_DSB_AMT_SUM, 0) AS NH_CARD_RFND_DSB_AMT_SUM/* 농협 환불지급금액 합계 */
                    , NVL(YD_CARD_RFND_DSB_AMT_SUM, 0) AS YD_CARD_RFND_DSB_AMT_SUM/* 여민동락 환불지급금액 합계 */
                    , (
                        NVL(BC_CARD_RFND_DSB_AMT_SUM, 0) /* BC 환불지급금액 합계 */
                        + NVL(KB_CARD_RFND_DSB_AMT_SUM, 0) /* KB 환불지급금액 합계 */
                        + NVL(SS_CARD_RFND_DSB_AMT_SUM, 0) /* 삼성 환불지급금액 합계 */
                        + NVL(HN_CARD_RFND_DSB_AMT_SUM, 0) /* 하나 환불지급금액 합계 */
                        + NVL(SH_CARD_RFND_DSB_AMT_SUM, 0) /* 신한 환불지급금액 합계 */
                        + NVL(LT_CARD_RFND_DSB_AMT_SUM, 0) /* 롯데 환불지급금액 합계 */
                        + NVL(HD_CARD_RFND_DSB_AMT_SUM, 0) /* 현대 환불지급금액 합계 */
                        + NVL(NH_CARD_RFND_DSB_AMT_SUM, 0) /* 농협 환불지급금액 합계 */
                        + NVL(YD_CARD_RFND_DSB_AMT_SUM, 0) /* 여민동락 환불지급금액 합계 */
                      ) AS CARD_RFND_DSB_AMT_SUM /* 카드 (환불지급금액) 합계 */
                 FROM RFND_DSB_AMT_SUM /* 환불지급금액 합계 */
           ) ,
             RFND_DDTN_AMT_SUM_CARD_DDTN AS /* 환불공제금액 합계와 카드 공제 */
           (
               SELECT                
                      NVL(CASH_RFND_DDTN_AMT_SUM, 0) AS CASH_RFND_DDTN_AMT_SUM/* 현금 환불공제금액 합계 */
                    , NVL(BC_CARD_RFND_DDTN_AMT_SUM, 0) AS BC_CARD_RFND_DDTN_AMT_SUM /* BC 환불공제금액 합계 */
                    , NVL(KB_CARD_RFND_DDTN_AMT_SUM, 0) AS KB_CARD_RFND_DDTN_AMT_SUM /* KB 환불공제금액 합계 */
                    , NVL(SS_CARD_RFND_DDTN_AMT_SUM, 0) AS SS_CARD_RFND_DDTN_AMT_SUM/* 삼성 환불공제금액 합계 */
                    , NVL(HN_CARD_RFND_DDTN_AMT_SUM, 0) AS HN_CARD_RFND_DDTN_AMT_SUM/* 하나 환불공제금액 합계 */
                    , NVL(SH_CARD_RFND_DDTN_AMT_SUM, 0) AS SH_CARD_RFND_DDTN_AMT_SUM/* 신한 환불공제금액 합계 */
                    , NVL(LT_CARD_RFND_DDTN_AMT_SUM, 0) AS LT_CARD_RFND_DDTN_AMT_SUM/* 롯데 환불공제금액 합계 */
                    , NVL(HD_CARD_RFND_DDTN_AMT_SUM, 0) AS HD_CARD_RFND_DDTN_AMT_SUM/* 현대 환불공제금액 합계 */
                    , NVL(NH_CARD_RFND_DDTN_AMT_SUM, 0) AS NH_CARD_RFND_DDTN_AMT_SUM/* 농협 환불공제금액 합계 */
                    , NVL(YD_CARD_RFND_DDTN_AMT_SUM, 0) AS YD_CARD_RFND_DDTN_AMT_SUM/* 여민동락 환불공제금액 합계 */
                    , (
                        NVL(BC_CARD_RFND_DDTN_AMT_SUM, 0) /* BC 환불공제금액 합계 */
                        + NVL(KB_CARD_RFND_DDTN_AMT_SUM, 0) /* KB 환불공제금액 합계 */
                        + NVL(SS_CARD_RFND_DDTN_AMT_SUM, 0) /* 삼성 환불공제금액 합계 */
                        + NVL(HN_CARD_RFND_DDTN_AMT_SUM, 0) /* 하나 환불공제금액 합계 */
                        + NVL(SH_CARD_RFND_DDTN_AMT_SUM, 0) /* 신한 환불공제금액 합계 */
                        + NVL(LT_CARD_RFND_DDTN_AMT_SUM, 0) /* 롯데 환불공제금액 합계 */
                        + NVL(HD_CARD_RFND_DDTN_AMT_SUM, 0) /* 현대 환불공제금액 합계 */
                        + NVL(NH_CARD_RFND_DDTN_AMT_SUM, 0) /* 농협 환불공제금액 합계 */
                        + NVL(YD_CARD_RFND_DDTN_AMT_SUM, 0) /* 여민동락 환불공제금액 합계 */
                      ) AS CARD_RFND_DDTN_AMT_SUM /* 카드 공제(환불공제금액 합계) */
                 FROM RFND_DDTN_AMT_SUM /* 환불공제금액 합계 */
           )
        SELECT 
               NVL(RDASCR.CASH_RFND_DSB_AMT_SUM, 0) AS CASH_RFND_DSB_AMT_SUM /* 현금 환불지급금액 합계 */
             , NVL(RDASCR.BC_CARD_RFND_DSB_AMT_SUM, 0) AS BC_CARD_RFND_DSB_AMT_SUM /* BC 환불지급금액 합계 */
             , NVL(RDASCR.KB_CARD_RFND_DSB_AMT_SUM, 0) AS KB_CARD_RFND_DSB_AMT_SUM /* KB 환불지급금액 합계 */
             , NVL(RDASCR.SS_CARD_RFND_DSB_AMT_SUM, 0) AS SS_CARD_RFND_DSB_AMT_SUM /* 삼성 환불지급금액 합계 */
             , NVL(RDASCR.HN_CARD_RFND_DSB_AMT_SUM, 0) AS HN_CARD_RFND_DSB_AMT_SUM /* 하나 환불지급금액 합계 */
             , NVL(RDASCR.SH_CARD_RFND_DSB_AMT_SUM, 0) AS SH_CARD_RFND_DSB_AMT_SUM/* 신한 환불지급금액 합계 */
             , NVL(RDASCR.LT_CARD_RFND_DSB_AMT_SUM, 0) AS LT_CARD_RFND_DSB_AMT_SUM/* 롯데 환불지급금액 합계 */
             , NVL(RDASCR.HD_CARD_RFND_DSB_AMT_SUM, 0) AS HD_CARD_RFND_DSB_AMT_SUM/* 현대 환불지급금액 합계 */
             , NVL(RDASCR.NH_CARD_RFND_DSB_AMT_SUM, 0) AS NH_CARD_RFND_DSB_AMT_SUM/* 농협 환불지급금액 합계 */
             , NVL(RDASCR.YD_CARD_RFND_DSB_AMT_SUM, 0) AS YD_CARD_RFND_DSB_AMT_SUM/* 여민동락 환불지급금액 합계 */
             , NVL(RDASCD.CARD_RFND_DDTN_AMT_SUM, 0) AS CARD_RFND_DDTN_AMT_SUM/* 카드 공제(환불공제금액 합계) */
             , ( NVL(RDASCD.CASH_RFND_DDTN_AMT_SUM, 0) + NVL(RDASCD.CARD_RFND_DDTN_AMT_SUM, 0) ) AS CASH_CARD_RFND_DDTN_AMT_SUM /* 현금계(현금 환불공제금액 합계 + 카드 공제(환불공제금액 합계))*/
             , NVL(RDASCR.CARD_RFND_DSB_AMT_SUM, 0) AS CARD_RFND_DSB_AMT_SUM/* 카드 (환불지급금액) 합계 */
             /* 확인필요: 웰스 인수 전금 */
             /* 확인필요: 웰스 할부 전금 */
             /* 확인필요: 웰스 렌탈 전금 */
             /* 확인필요: 웰스 멤버 전금 */
             , ( SELECT SUM(NVL(RFND_DSB_PSP_INT, 0))  /* 환불지급지연이자*/
                   FROM BASE
                  WHERE CARD_RFND_FNIT_CD IN ('361','381', '365', '044', '374', '366', '368', '367', '371', '000') 
                     OR CARD_RFND_FNIT_CD IS NULL
               ) AS RFND_DSB_PSP_INT_SUM /* 지연이자 합계 */
             /* 확인필요: K 머니 합계 */
             /* 확인필요: 전금 합계 */
             /* 확인필요: 환불 총계 = 현금계 +카드합계+인수전금합계+할부전금합계 */
          FROM RFND_DSB_AMT_SUM_CARD_RFND RDASCR /* 환불지급금액 합계와 카드 (환불지급금액) 합계 */
          LEFT OUTER JOIN RFND_DDTN_AMT_SUM_CARD_DDTN RDASCD /* 환불공제금액 합계와 카드 공제 (합계) */
            ON 1 = 1
    </select>
</mapper>