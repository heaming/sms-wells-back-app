<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.idvrve.mapper.WwdbMutualAidAllianceBulkDepositRegMapper">

    <select id="selectMutualAidAllianceBulkDepositRegs" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbMutualAidAllianceBulkDepositRegDto$SearchRes">
         SELECT 
                 T1.LIF_SPPT_YM /*라이프지원년월*/
               , T1.LIF_CNTR_NO /* 라이프계약번호*/  
               , T1.LIF_CNTR_SN /*라이프일련번호*/
               <choose>
                <when test='@MybatisUtils@equals(lifAlncDvCd, "30")'>
                 /*구분코드가 웰스399 일때*/
               , T1.LIF_SPPT_AMT AS AMT /*라이프지원금액*/
               , SUM(T1.LIF_SPPT_AMT) OVER (ORDER BY 1)  SUM_AMT
                </when>
                <otherwise>
                 /*구분코드가 웰스399이 아닐때*/
               , T1.WELS_DP_AMT AS AMT /*웰스입금금액*/
               , SUM(T1.WELS_DP_AMT) OVER (ORDER BY 1)  SUM_AMT
                </otherwise>
              </choose>                             
               , T1.LIF_REP_AMT /*라이프환수금액*/
               , T1.LIF_SPPT_AGG_AMT /*라이프지원누계금액*/
               , T1.WELS_CNTR_NO /*웰스계약번호*/
               , T1.WELS_CNTR_SN /*웰스계약일련번호*/
               , T1.LIF_ALNC_DV_CD /*라이프제휴구분코드*/
               , T1.FST_RGST_DTM /*입력일자*/
               , T1.FST_RGST_USR_ID /*입력담당자ID*/
            FROM TB_RVDW_LIF_RENTAL_SPPT_BAS T1 /*라이프렌탈지원기본*/
           INNER JOIN TB_SSCT_CNTR_DTL T2 /*계약상세*/
              ON T2.CNTR_NO = T1.WELS_CNTR_NO 
             AND T2.CNTR_SN = T1.WELS_CNTR_SN 
           WHERE 1 = 1 
           <if test='@MybatisUtils@isNotEmpty(lifSpptYm)'>
             AND T1.LIF_SPPT_YM = #{lifSpptYm} /*라이프지원년월*/
           </if>
           <if test='@MybatisUtils@isNotEmpty(lifAlncDvCd)'>
             AND T1.LIF_ALNC_DV_CD = #{lifAlncDvCd} /*라이프제휴구분코드*/
           </if>
           <choose>
            <when test='@MybatisUtils@equals(lifAlncDvCd, "30")'>
             /*구분코드가 웰스399 일때*/
             AND T1.LIF_SPPT_AMT > 0  /*라이프지원금액이 0보다 클때*/
            </when>
            <otherwise>
             /*구분코드가 웰스399이 아닐때*/
             AND T1.WELS_DP_AMT > 0 /*웰스입금금액이 0보다 클때*/
            </otherwise>
          </choose>
             
    </select>
    
    <select id="selectMutualAidAllianceBulkDepositRegsSum" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbMutualAidAllianceBulkDepositRegDto$SearchSumRes">
         SELECT 
                COUNT(LIF_SPPT_YM) AS COUNT_LIF
               <choose>
                <when test='@MybatisUtils@equals(lifAlncDvCd, "30")'>
                 /*구분코드가 웰스399 일때*/
               , NVL(SUM(T1.LIF_SPPT_AMT),0) AS AMT_SUM /*라이프지원금액*/
                </when>
                <otherwise>
                 /*구분코드가 웰스399이 아닐때*/
               , NVL(SUM(T1.WELS_DP_AMT),0) AS AMT_SUM /*라이프지원금액*/
                </otherwise>
              </choose>                                            
            FROM TB_RVDW_LIF_RENTAL_SPPT_BAS T1 /*라이프렌탈지원기본*/
           INNER JOIN TB_SSCT_CNTR_DTL T2 /*계약상세*/
              ON T2.CNTR_NO = T1.WELS_CNTR_NO 
             AND T2.CNTR_SN = T1.WELS_CNTR_SN 
           WHERE 1 = 1 
           <if test='@MybatisUtils@isNotEmpty(lifSpptYm)'>
             AND T1.LIF_SPPT_YM = #{lifSpptYm} /*라이프지원년월*/
           </if>
           <if test='@MybatisUtils@isNotEmpty(lifAlncDvCd)'>
             AND T1.LIF_ALNC_DV_CD = #{lifAlncDvCd} /*라이프제휴구분코드*/
           </if>
           <choose>
            <when test='@MybatisUtils@equals(lifAlncDvCd, "30")'>
             /*구분코드가 웰스399 일때*/
             AND T1.LIF_SPPT_AMT > 0  /*라이프지원금액이 0보다 클때*/
            </when>
            <otherwise>
             /*구분코드가 웰스399이 아닐때*/
             AND T1.WELS_DP_AMT > 0 /*웰스입금금액이 0보다 클때*/
            </otherwise>
          </choose>
             
    </select>
    
    
    <insert id="insertMutualAidAllianceBulkDepositReg" >
        INSERT 
          INTO TB_RVDW_LIF_RENTAL_SPPT_BAS (
               KW_GRP_CO_CD
             , LIF_SPPT_YM /* 지원년월 */
             , WELS_CNTR_NO /*웰스계약번호*/
             , WELS_CNTR_SN /*웰스계약일련번호*/
             , LIF_ALNC_PD_CD  /*상품*/
             , LIF_ALNC_PD_NM /*상품명*/
             , LIF_SPPT_AMT /*지원금액*/
             , LIF_CNTR_NO /*상조계약번호*/
             , LIF_CNTR_SN /*상조일련번호*/
             , LIF_ALNC_DV_CD /*제휴구분코드*/
             <include refid="COMMON.insertSystemField"/>
          ) VALUES (
               #{SESSION.companycode}
             , #{lifSpptYm} /* 지원년월 */
             , #{welsCntrNo} /*웰스계약번호*/
             , #{welsCntrSn}  /*웰스계약일련번호*/
             , #{lifAlncPdCd}  /*상품*/
             , #{lifAlncPdNm}  /*상품명*/
             , #{lifSpptAmt}  /*지원금액*/
             , #{lifCntrNo}  /*상조계약번호*/
             , #{lifCntrSn}  /*상조일련번호*/
             , #{lifAlncDvCd} /*제휴구분코드*/  
             <include refid="COMMON.insertSystemFieldValue" />
           )
    </insert>
</mapper>