<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.idvrve.mapper.WwdbGiroDepositMgtMapper">
    
    <select id="selectGiroDepositMgt" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbGiroDepositMgtDto$SearchRes">
        SELECT 
               /*T1.KW_GRP_CO_CD*/
               T2.KW_GRP_CO_CD
             , T1.CNTR_NO||T1.CNTR_SN AS CNTR_NO --계약번호
             , T7.CST_KNM  --고객명
             , T1.ITG_DP_NO --통합입금번호
             , T1.FNT_DT AS RVE_DT --입금일자
             , T1.RVE_DT AS PERF_DT --실적일자
             , T1.PY_AMT AS RVE_AMT--입금금액
             , T1.GIRO_FEE --수수료금액     
             , '06' AS DP_MES_CD --입금유형
             , '렌탈' AS SELL_TP_CD --판매유형
             , T1.PROCS_ERR_TP_CD --처리오류유형코드                    
             , T3.DG_CNTR_NO --대표번호
          FROM TB_RVDW_GIRO_DP_IZ T1 --입금내역
          LEFT OUTER JOIN TB_RVDW_RVE_DTL T2 --수납상세
           /* ON T1.KW_GRP_CO_CD  = T2.KW_GRP_CO_CD*/ 
            ON T1.CNTR_NO = T2.CNTR_NO 
           AND T1.CNTR_SN = T2.CNTR_SN 
           AND T2.DTA_DL_YN = 'N' 
           AND T2.DP_MES_CD = '06'
          LEFT OUTER JOIN TB_SSCT_CNTR_BAS T6  --계약기본
            ON T1.CNTR_NO = T6.CNTR_NO    
           AND T6.DTA_DL_YN = 'N' 
          LEFT OUTER JOIN TB_CUBS_CST_BAS T7 --고객기본  
            ON T7.CST_NO = T6.CNTR_CST_NO  
           AND T7.DTA_DL_YN = 'N' 
          LEFT OUTER JOIN TB_RVDW_GIRO_OCR_BNDL_BAS T3 --지로OCR묶음기본
            ON T3.CNTR_NO = T1.CNTR_NO 
           AND T3.CNTR_SN = T1.CNTR_SN 
           AND T3.GIRO_OCR_BNDL_YM = SUBSTR(T1.FNT_DT,0,6)             
           AND T3.DTA_DL_YN = 'N' 
         WHERE 1 = 1
          /* AND KW_GRP_CO_CD = {session.companyCode}*/
           AND T1.DTA_DL_YN = 'N'
            <if test='@MybatisUtils@isNotEmpty(fntDt)'>
            AND T1.FNT_DT = #{fntDt}    
            </if>
            <if test='@MybatisUtils@isNotEmpty(rveDt)'>  
            AND T1.RVE_DT = #{rveDt}
            </if>                          
            <if test='@MybatisUtils@equals(errorChk, "2")'>
            AND T1.PROCS_ERR_TP_CD = '3'
            </if>    
           ORDER BY ITG_DP_NO 
    </select>
    
    <select id="selectGiroDepositSum" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbGiroDepositMgtDto$SearchSumRes">
        SELECT 
               SUM(T1.PY_AMT) AS RVE_AMT_SUM--입금금액
             , SUM(T1.GIRO_FEE) AS GIRO_FEE_SUM --수수료금액   
          FROM TB_RVDW_GIRO_DP_IZ T1 --입금내역
          LEFT OUTER JOIN TB_RVDW_RVE_DTL T2 --수납상세
           /* ON T1.KW_GRP_CO_CD  = T2.KW_GRP_CO_CD*/ 
            ON T1.CNTR_NO = T2.CNTR_NO 
           AND T1.CNTR_SN = T2.CNTR_SN 
           AND T2.DTA_DL_YN = 'N' 
           AND T2.DP_MES_CD = '06'
          LEFT OUTER JOIN TB_SSCT_CNTR_BAS T6  --계약기본
            ON T1.CNTR_NO = T6.CNTR_NO    
           AND T6.DTA_DL_YN = 'N' 
          LEFT OUTER JOIN TB_CUBS_CST_BAS T7 --고객기본  
            ON T7.CST_NO = T6.CNTR_CST_NO  
           AND T7.DTA_DL_YN = 'N' 
          LEFT OUTER JOIN TB_RVDW_GIRO_OCR_BNDL_BAS T3 --지로OCR묶음기본
            ON T3.CNTR_NO = T1.CNTR_NO 
           AND T3.CNTR_SN = T1.CNTR_SN 
           AND T3.GIRO_OCR_BNDL_YM = SUBSTR(T1.FNT_DT,0,6)             
           AND T3.DTA_DL_YN = 'N' 
         WHERE 1 = 1
          /* AND KW_GRP_CO_CD = {session.companyCode}*/
           AND T1.DTA_DL_YN = 'N'
            <if test='@MybatisUtils@isNotEmpty(fntDt)'>
            AND T1.FNT_DT = #{fntDt}    
            </if>
            <if test='@MybatisUtils@isNotEmpty(rveDt)'>  
            AND T1.RVE_DT = #{rveDt}
            </if>                          
            <if test='@MybatisUtils@equals(errorChk, "2")'>
            AND T1.PROCS_ERR_TP_CD = '3'
            </if>               
    </select>
          
    <select id="selectGiroDepositDate" resultType="String">
        SELECT 
               TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS GIRO_DP_ULD_DTM 
          FROM DUAL
    </select>
    
    <insert id="inertGiroDeposit">
        INSERT INTO TB_RVDW_GIRO_DP_LEDG_IZ /* 지로입금 원장내역 */
        (
              GIRO_DP_ULD_DTM /*지로입금업로드일시*/
            , GIRO_DP_ULD_SN /*지로입금업로드일련번호*/              
            , GIRO_DP_MTR_DV_CD --구분코드
            , DP_SN --일련번호
            , RVE_DT --수납일자
            , FNT_DT --이체일자
            , GIRO_DP_BNK_CD --은행코드
            , BNK_BRNC_CD --은행점포코드
            , GIRO_INDX_NO --지로색인번호
            , GIRO_INQNO --지로조회번호
            , PY_AMT --납입금액
            , GIRO_RVE_DV_CD --지로수납구분코드
            , GIRO_FEE_DV_CD --지로수수료구분코드
            , RMK_CN  --비고    
            , DTA_DL_YN
            , GIRO_DP_ULD_PROCS_YN 
            <include refid="COMMON.insertSystemField"/>
         )VALUES(
              #{giroDpUldDtm} /*지로입금업로드일시*/
            , ( 
                SELECT 
                       NVL(MAX(GIRO_DP_ULD_SN),0)+1 
                  FROM TB_RVDW_GIRO_DP_LEDG_IZ
                 WHERE GIRO_DP_ULD_DTM = #{giroDpUldDtm}                   
              ) /*지로입금업로드일련번호*/  
            , #{giroDpMtrDvCd} --구분코드
            , #{dpSn} --일련번호
            , #{rveDt} --수납일자
            , #{fntDt} --이체일자
            , #{giroDpBnkCd} --은행코드
            , #{bnkBrncCd} --은행점포코드
            , #{giroIndxNo} --지로색인번호
            , #{giroInqNo} --지로조회번호
            , #{pyAmt} --납입금액
            , #{giroRveDvCd} --지로수납구분코드
            , #{giroFeeDvCd} --지로수수료구분코드
            , #{rmkCn}  --비고    
            , 'N'
            , 'N'
            <include refid="COMMON.insertSystemFieldValue" />
         )
    </insert>
    
    <update id="updateGiroDeposit">
        UPDATE TB_RVDW_GIRO_DP_LEDG_IZ
           SET GIRO_DP_ULD_PROCS_YN = 'Y'
         WHERE 1 = 1
           AND FNT_DT = #{fntDt}
           AND DTA_DL_YN = 'N'
           AND GIRO_DP_ULD_PROCS_YN = 'N'
    </update>
    
    
    <insert id="inertGiroDepositItemization">
        INSERT INTO TB_RVDW_GIRO_DP_IZ(
                  ITG_DP_NO --통합입금번호
                , GIRO_NO --지로번호
                , GIRO_DP_MTR_DV_CD --지로입금자료구분코드
                , GIRO_DP_SN --지로입금일련번호
                , FNT_DT --이체일자
                , RVE_DT --수납일자
                , GIRO_DP_BNK_CD --은행코드
                , GIRO_DP_NO --지로입금번호
                , CNTR_NO --계약번호
                , CNTR_SN --계약일련번호
                , PY_TN --납입회차
                , PY_YM --납입년월
                , PY_AMT --납입금액
                , GIRO_FEE --지로수수료
                , GIRO_RVE_DV_CD --지로수납구분코드
                , DTA_DL_YN
                /*, KW_GRP_CO_CD*/ --회사코드
                , PROCS_ERR_TP_CD --오류처리
                , ITG_DP_PROCS_YN
                <include refid="COMMON.insertSystemField"/>
                )VALUES
                (
                  #{itgDpNo}
                , #{giroNo}
                , #{giroDpMtrDvCd}
                , #{dpSn} 
                , #{fntDt}
                , #{rveDt} 
                , #{giroDpBnkCd} 
                , #{giroInqno} 
                , #{cntrNo} 
                , #{cntrSn} 
                , #{pyTn}              
                , #{pyYm}              
                , #{pyAmt}
                , #{giroFeeDvCd} 
                , #{giroRveDvCd} 
                , #{dtaDlYn}    
               /* , {session.companyCode}*/
                , #{procsErrTpCd}
                , 'N'
                 <include refid="COMMON.insertSystemFieldValue" />
                )
                                          
    </insert>
    
    <delete id="deleteGiroDepositItemization">
        DELETE       
          FROM
               TB_RVDW_GIRO_DP_IZ
         WHERE ITG_DP_PROCS_YN = 'N'    
           AND DTA_DL_YN = 'N'
           AND FNT_DT IN 
           <foreach collection="fntDt" item="code" index="index" separator="," open="(" close=")">
                      #{code}         
           </foreach>           
    </delete>
            
    <insert id="inertIntegrationItemization">
        INSERT INTO TB_RVDW_ITG_DP_BAS(
                    ITG_DP_NO --통합입금번호
                  , ITG_DP_CAN_YN --통합입금취소여부 
                  , INCMDC_YN --소득공제여부
                  , DTA_DL_YN
                 /* , KW_GRP_CO_CD*/
                  <include refid="COMMON.insertSystemField"/>
                  )VALUES(
                    #{itgDpNo}
                  , 'N'
                  , 'N'
                  , #{dtaDlYn}  
                 /* , {session.companyCode}*/
                  <include refid="COMMON.insertSystemFieldValue" />                 
                  )                  
    </insert>

    <insert id="inertIntegrationItemizationHistory">
        INSERT INTO TB_RVDW_ITG_DP_BAS_HIST (
              ITG_DP_NO --통합입금번호
            , ITG_DP_CAN_YN --통합입금취소여부 
            , INCMDC_YN --소득공제여부
            , DTA_DL_YN
            , HIST_CH_DTM
                  <include refid="COMMON.insertSystemField"/>
        ) VALUES (
              #{itgDpNo}
            , #{itgDpCanYn}
            , #{incmdcYn}
            , #{dtaDlYn} 
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') 
          <include refid="COMMON.insertSystemFieldValue" />                 
        )                  
    </insert>
    
    <select id="selectGiroDepositItemizationInfo" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dvo.WwdbGiroDepositSaveInfoDvo">
                SELECT 
                       ITG_DP_NO + ROWNUM AS ITG_DP_NO
                     , GIRO_NO  
                     , GIRO_DP_MTR_DV_CD
                     , DP_SN -- 일련번호
                     , FNT_DT --이체일자
                     , RVE_DT --수납일자
                     , GIRO_DP_BNK_CD --은행코드
                     , GIRO_INQNO --지로조회번호
                     , CNTR_NO --계약번호
                     , (SELECT NVL(MAX(CNTR_SN),0)+1 FROM TB_RVDW_GIRO_DP_IZ WHERE CNTR_NO = T1.CNTR_NO) AS CNTR_SN
                     --, LPAD(ROW_NUMBER() OVER(PARTITION BY CNTR_NO ORDER BY DP_SN DESC ),5,0) AS CNTR_SN --계약일련번호
                     , PY_TN --회차        
                     , (CASE WHEN TO_NUMBER(SUBSTR(PY_YM,1,2)) = 0  THEN 0
                             ELSE TO_NUMBER('20' || PY_YM)
                            END) AS PY_YM /*납입년월 */
                     , PY_AMT --납입금액
                     , GIRO_FEE_DV_CD --지로수수료
                     , GIRO_RVE_DV_CD --수납구분
                     , DTA_DL_YN
                     , #{session.companyCode}
                       <include refid="COMMON.insertSystemFieldValue"/>
                  FROM(
                            SELECT
                                   #{session.companyCode}||TO_CHAR(SYSDATE,'YYYYMMDD') || (SELECT LPAD(substr(max(ITG_DP_NO),-8)+1,8,0) FROM TB_RVDW_GIRO_DP_IZ) AS ITG_DP_NO
                                 , (
                                          SELECT SUBSTR(DP_SN,3,5) ||  SUBSTR(RVE_DT,1,2)
                                        FROM TB_RVDW_GIRO_DP_LEDG_IZ  /* 지로입금　원시파일 */
                                       WHERE GIRO_DP_MTR_DV_CD = '11'   /* 구분코드 */
                                         AND GIRO_DP_ULD_PROCS_YN = 'N'
                                   ) AS GIRO_NO --지로번호
                                 , GIRO_DP_MTR_DV_CD --구분코드
                                 , DP_SN -- 일련번호
                                 , FNT_DT --이체일자
                                 , RVE_DT --수납일자
                                 , GIRO_DP_BNK_CD --은행코드
                                 , GIRO_INQNO --지로조회번호                            
                                 , CASE WHEN GIRO_RVE_DV_CD IN ( 'R','A' ) OR GIRO_INQNO = ' ' THEN '0'
                                        WHEN SUBSTR(GIRO_INQNO,5,1) = '-'              THEN SUBSTR(GIRO_INQNO,1,4)
                                        WHEN SUBSTR(GIRO_INQNO,1,9) = '000000000'      THEN SUBSTR(GIRO_INQNO,10,4)
                                        ELSE 'W'||SUBSTR(GIRO_INQNO,3,11) END CNTR_NO /*계약번호     */      
--                               , CASE WHEN GIRO_RVE_DV_CD IN ( 'R','A' ) OR GIRO_INQNO = ' ' THEN '0'
--                                      WHEN SUBSTR(GIRO_INQNO,5,1) = '-'              THEN SUBSTR(GIRO_INQNO,1,4)
--                                      WHEN SUBSTR(GIRO_INQNO,1,9) = '000000000'      THEN SUBSTR(GIRO_INQNO,10,4)
--                                      ELSE SUBSTR(GIRO_INQNO,3,12) END CNTR_NO /*계약번호     */      
                                 , CASE WHEN GIRO_RVE_DV_CD IN ( 'R','A' ) OR GIRO_INQNO = ' ' THEN '0'
                                         WHEN SUBSTR(GIRO_INQNO,5,1) = '-'              THEN '0'
                                        WHEN SUBSTR(GIRO_INQNO,1,9) = '000000000'      THEN '0'
                                        ELSE SUBSTR(GIRO_INQNO,14,2) END PY_TN --납입회차     
                                 , CASE WHEN GIRO_RVE_DV_CD IN ( 'R','A' ) OR GIRO_INQNO = ' ' THEN '0'
                                        WHEN SUBSTR(GIRO_INQNO,5,1) = '-'              THEN '0'
                                        WHEN SUBSTR(GIRO_INQNO,1,9) = '000000000'      THEN '0'
                                        ELSE SUBSTR(GIRO_INQNO,16,4) END PY_YM /*납입년월     */
                                 , PY_AMT --납입금액
                                 , GIRO_FEE_DV_CD--지로수수료        
                                 , GIRO_RVE_DV_CD -- 수납구분
                                 , DTA_DL_YN
                              FROM TB_RVDW_GIRO_DP_LEDG_IZ
                             WHERE GIRO_DP_MTR_DV_CD = '22'
                               AND DTA_DL_YN = 'N'       
                               AND GIRO_DP_ULD_PROCS_YN = 'N'                          
                      ) T1  
    </select>
    
    <delete id="deleteGiroDeposit">
        DELETE FROM TB_RVDW_GIRO_DP_LEDG_IZ
    </delete>
    
    <select id="selectGiroDepositList" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbGiroDepositMgtDto$SearchDepositRes">
        SELECT
               ITG_DP_NO
             , GIRO_NO
             , GIRO_DP_MTR_DV_CD
             , GIRO_DP_SN
             , FNT_DT
             , RVE_DT
             , GIRO_DP_BNK_CD
             , GIRO_DP_NO
             , CNTR_NO
             , CNTR_SN
             , PY_TN
             , PY_YM
             , PY_AMT
             , GIRO_FEE
             , GIRO_RVE_DV_CD
             , GIRO_PRTS_DV_CD
             , PROCS_ERR_TP_CD
             , DTA_DL_YN 
          FROM TB_RVDW_GIRO_DP_IZ
         WHERE 1 = 1
           AND GIRO_NO = '3010068' /* 지로번호*/
           AND FNT_DT = #{fntDt}
           AND DTA_DL_YN = 'N'
    </select>
    
    <select id="selectGiroDepositCount" resultType="int">
        SELECT 
              COUNT(GIRO_OCR_BNDL_YM) AS CNT 
         FROM TB_RVDW_GIRO_OCR_BNDL_BAS
        WHERE 1 = 1
          AND GIRO_OCR_BNDL_YM = #{giroOcrBndlYm}
          AND DG_CNTR_NO = #{dgCntrNo}
          AND DG_CNTR_SN = #{dgCntrSn}
          AND DG_CNTR_YN = 'Y'
          AND DTA_DL_YN = 'N'
    </select>
    
    <select id="selectContractDetail" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbGiroDepositMgtDto$SearchContractDetailRes">
        SELECT
               CNTR_NO
             , CNTR_SN
             , BASE_PD_CD
             , HGR_PD_CD
             , PD_QTY
             , STPL_PTRM_UNIT_CD
             , STPL_PTRM
             , ISTM_MCN
             , CNTR_PD_STRTDT
             , CNTR_PD_ENDDT
             , CNTR_DTL_STAT_CD
             , SELL_TP_CD
             , DSC_APY_TP_CD
             , DSC_APY_DTL_CD
             , DSC_APY_DRM_VAL
             , SV_PTRM_UNIT_CD
             , SV_PRD
             , CNTRW_TP_CD
             , BLG_CRP_CD
             , RVE_CRP_CD
             , KW_GRP_CO_CD
             , BOO_SELL_TP_CD
             , PD_GD_CD
             , PD_HCLSF_ID
             , PD_MCLSF_ID
             , PD_LCLSF_ID
             , PD_DCLSF_ID
             , STLM_TP_CD
             , CRNCY_DV_CD
             , APY_EXCR
             , PD_BASE_AMT
             , FNL_AMT
             , VAT
             , SELL_AMT
             , CNTR_AMT
             , ISTM_PCAM_AMT
             , ISTM_INT_AMT
             , MM_ISTM_AMT
             , ACKMT_PERF_RT
             , ACKMT_PERF_AMT
             , CVT_PERF_AMT
             , SPP_DUEDT
             , RESUB_YN
             , RSTL_YN
             , FRISU_YN
             , FRISU_DSB_TP_CD
             , FEE_ACKMT_CT
             , FEE_ACKMT_BASE_AMT
             , FEE_FXAM_YN
             , TXINV_PBL_OJ_YN
             , SMTPL_ID
             , SMTPL_SN
             , BF_ORD_NO
             , CNTR_CH_RCP_ID
             , CNTR_CH_SN
             , CNTR_CH_DTL_RSON_CD
             , CNTR_CH_DTL_AK_CN   
         FROM TB_SSCT_CNTR_DTL
        WHERE 1 = 1
          AND CNTR_NO = #{cntrNo}
          AND CNTR_SN = #{cntrSn}   
    </select>
    
    <update id="updateGiroDepositItemization">
        UPDATE 
               TB_RVDW_GIRO_DP_IZ
           SET PROCS_ERR_TP_CD = #{procsErrTpCd} 
           <include refid="COMMON.updateSystemField"/>
         WHERE GIRO_NO = #{giroNo}
           AND FNT_DT = #{fntDt}
           AND GIRO_DP_MTR_DV_CD = #{giroDpMtrDvCd}
           AND GIRO_DP_SN = #{giroDpSn}           
    </update>
    
    <select id="selectGiroDepositSettingAmount">
        SELECT  
               NVL(SUM(DP_SE_AMT),0) AS DP_SE_AMT
          FROM TB_RVDW_GIRO_OCR_BNDL_BAS A
         INNER JOIN TB_SSCT_CNTR_DTL B
            ON A.CNTR_NO = B.CNTR_NO 
           AND A.CNTR_SN = B.CNTR_SN 
         WHERE 1 = 1
           AND GIRO_OCR_BNDL_YM = #{giroOcrBndlYm}
           AND DG_CNTR_NO = #{dgCntrNo}
           AND DG_CNTR_SN = #{dgCntrSn}
           AND A.DTA_DL_YN = 'N'
           AND B.DTA_DL_YN = 'N'
           AND B.CNTR_DTL_STAT_CD = '101'
    </select>
    
    <select id="selectGiroDepositSettingList" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbGiroDepositMgtDto$SearchDepositSettingRes">
        SELECT  
               DP_SE_AMT
             , DG_CNTR_NO
             , DG_CNTR_SN
          FROM TB_RVDW_GIRO_OCR_BNDL_BAS A
         INNER JOIN TB_SSCT_CNTR_DTL B
            ON A.CNTR_NO = B.CNTR_NO 
           AND A.CNTR_SN = B.CNTR_SN 
         WHERE 1 = 1
           AND GIRO_OCR_BNDL_YM = #{giroOcrBndlYm}
           AND DG_CNTR_NO = #{dgCntrNo}
           AND DG_CNTR_SN = #{dgCntrSn}
           AND A.DTA_DL_YN = 'N'
           AND B.DTA_DL_YN = 'N'
           AND B.CNTR_DTL_STAT_CD = '101'
    </select>

    <select id="selectBillingDocumentErrors" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbGiroDepositMgtDto$SearchErrosRes">
        SELECT     
               I1.CNTR_NO 
             , I1.CNTR_SN 
             , I1.CNTR_NO || I1.CNTR_SN AS CNTR
             , I1.ITG_DP_NO
             , T7.CST_KNM 
             , I1.PY_AMT --금액
             , I1.FNT_DT --(입금일)
             , I1.RVE_DT --(실적일)         
             , TO_CHAR(TO_DATE(I1.FNL_MDFC_DTM,'YYYYMMDDHH24MISS'),'YYYYMMDD') AS FNL_MDFC_DTM 
             , I1.FNL_MDFC_USR_ID 
             , I1.DP_ERR_PROCS_CN
          FROM TB_RVDW_GIRO_DP_IZ I1 --지로입금내역 
          LEFT OUTER JOIN TB_RVDW_RVE_DTL I2 --수납상세
            ON I2.CNTR_NO = I1.CNTR_NO 
           AND I2.CNTR_SN = I1.CNTR_SN 
           AND I2.RVE_DT = I1.FNT_DT
          LEFT OUTER JOIN TB_SSCT_CNTR_BAS T6  --계약기본
            ON I1.CNTR_NO = T6.CNTR_NO 
          LEFT OUTER JOIN TB_CUBS_CST_BAS T7 --고객기본  
            ON T7.CST_NO = T6.CNTR_CST_NO    
         WHERE 1 = 1
           AND I1.PROCS_ERR_TP_CD != '3'
           AND I1.DTA_DL_YN = 'N'
           <if test='@MybatisUtils@isNotEmpty(fntDt)'>
           AND I1.FNT_DT = #{fntDt}    
           </if>
           <if test='@MybatisUtils@isNotEmpty(rveDt)'>  
           AND I1.RVE_DT = #{rveDt}
           </if> 
         ORDER BY FNT_DT        
    </select>
    
    <update id="updateBillingDocumentErrors">
        UPDATE TB_RVDW_GIRO_DP_IZ
           SET CNTR_NO = #{cntrNo}
             , CNTR_SN =#{cntrSn}
             , PY_AMT = #{pyAmt}
             , RVE_DT = #{rveDt}
             , FNT_DT = #{fntDt}
             , DP_ERR_PROCS_CN = #{dpErrProcsCn}
             , PROCS_ERR_TP_CD = #{procsErrTpCd}
             <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND ITG_DP_NO = #{itgDpNo}  
    </update>
    
    <select id="selectDtlState" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbGiroDepositMgtDto$SearchDtlStateRes">
        SELECT   
               CNTR_NO 
             , CNTR_SN  
             , CNTR_DTL_STAT_CD --계약상태코드
        FROM TB_SSCT_CNTR_DTL 
        WHERE CNTR_NO = #{cntrNo}
          AND CNTR_SN = #{cntrSn}    
    </select>
    
    <select id="selectBillingDocumentMgtLedgerItemization" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbGiroDepositMgtDto$SearchLedgerItemizationRes">
    SELECT 
           FNT_DT
         , CHK_CNT
         , ITG_DP_PROCS_Y_CNT   
      FROM (
                SELECT  
                       FNT_DT 
                     , COUNT(RVE_DT) AS CHK_CNT /* 조회조건에 해당 하는 수납일자가 존재하는지 */
                     , SUM(CASE WHEN ITG_DP_PROCS_YN = 'Y' THEN 1 ELSE 0 END) AS ITG_DP_PROCS_Y_CNT /* 통합입금처리가 되었는지 안되었는지 확인하여 입금처리가 완료 되었으면 더한다.*/
                  FROM TB_RVDW_GIRO_DP_IZ
                 WHERE DTA_DL_YN = 'N'
                   AND FNT_DT IN 
                   <foreach collection="rveDt" item="code" index="index" separator="," open="(" close=")">
                      #{code}         
                   </foreach>
                                  /*(SELECT RVE_DT
                                     FROM TB_RVDW_GIRO_DP_LEDG_IZ
                                    WHERE DTA_DL_YN = 'N'
                                      AND GIRO_DP_ULD_PROCS_YN = 'N'
                                   GROUP BY RVE_DT)*/
                 GROUP BY FNT_DT
                 ORDER BY FNT_DT  
            )
      WHERE ROWNUM = 1            
    </select>
</mapper>