<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.idvrve.mapper.WwdbRefundApplicationMapper">

    <select id="selectRefundApplication" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundApplicationRes">
        SELECT
               RRRB.RFND_STAT_CD                                /* 환불상태 */
             , RRRB.FNL_MDFC_DTM                                /* 접수일자 */
             , SCD.CNTRW_TP_CD                                  /* 계약유형. 그리드 정의 없음. 리스, 렌탈, 멤버십, 정기배송 */
             , RRRB.CNTR_NO                                     /* 계약상세번호 */
             , RRRB.CNTR_SN
             , CCB.CST_KNM                                      /* 계약자 */
             , SCB.CNTR_CNFM_DTM                                /* 계약일자 */
             , RRD.RVE_DV_CD                                    /* 입금유형 */
             , RRD.RVE_DT                                       /* 매출일자 */
             , SCB.CNTR_CAN_DTM                                 /* 취소일자 */
             , PPB.PD_NM                                        /* 상품명 */
             , RRRD.RFND_AK_AMT                                 /* 환불요청금액(원) */
             , ( SELECT OEB.FNM
                   FROM TB_OGBS_EMP_BAS OEB
                  WHERE OEB.SAP_EMPNO = RRRD.FNL_MDFC_USR_ID
               ) AS FNM                                         /* 신청자 */
             , RRRD.FNL_MDFC_USR_ID                             /* 번호 */
             , RRRD.RFND_FSH_DT                                 /* 승인일자 */
             , RRRB.EX_RFND_RSON_CN                             /* 처리내용 */
             , RRRB.RFND_FSH_DT AS RFND_FSH_DT_TMP                 /* 지급일자 */
             , CASE WHEN RRRD.RFND_DSB_DV_CD = '01' THEN ( CASE WHEN RRRD.CSH_RFND_DV_CD = '01' THEN '5'       /* 5. 선환불 */
                                                                WHEN RRRD.CSH_RFND_DV_CD = '02' THEN '4'     /* 4. 현금환불 */
                                                                WHEN RRRD.CSH_RFND_DV_CD = '03' THEN '6'     /* 6. 카드현금 */
                                                            END
                                                         )
                    WHEN RRRD.RFND_DSB_DV_CD = '02' THEN '3'                                                 /* 3. 카드환불 */
                    WHEN RRRD.RFND_DSB_DV_CD = '03' THEN ( CASE WHEN RRRD.BLTF_RFND_DV_CD = '01' THEN '2'    /* 2. 현금전금 */
                                                                WHEN RRRD.BLTF_RFND_DV_CD = '02' THEN '1'    /* 1. 카드전금 */
                                                            END
                                                         )
                END AS RFND_DSB_DV_CD_CSH_BLTF                  /* 처리구분 */
             , RRRD.RFND_RSON_CD                                /* 환불사유 */
             , RRRD.RFND_RSON_CN                                /* 환불내용 */
             , RRRD.RFND_EVID_MTR_FILE_ID                       /* 첨부파일 */
             , RRRB.RFND_RCP_NO                                 /* 환불접수번호 */
             , RRRD.RFND_RCP_DTL_SN                             /* 환불접수상세번호 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
         INNER JOIN TB_RVDW_RFND_RCP_DTL RRRD           /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N'
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
         INNER JOIN TB_SSCT_CNTR_BAS SCB                /* 계약기본 */
            ON SCB.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCB.CNTR_NO               /* 계약번호 */
         INNER JOIN TB_SSCT_CNTR_DTL SCD                /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약상세번호 */
         /* INNER JOIN TB_PDBS_PD_BAS PPB                  상품기본 */
         LEFT JOIN TB_PDBS_PD_BAS PPB                  /* 상품기본 */
            ON PPB.DTA_DL_YN = 'N'
           AND SCD.BASE_PD_CD = PPB.PD_CD
         INNER JOIN TB_CUBS_CST_BAS CCB                 /* 고객기본 */
            ON CCB.DTA_DL_YN = 'N'
           AND RRRB.CST_NO = CCB.CST_NO                 /* 고객번호 */
         LEFT JOIN TB_RVDW_RVE_DTL RRD                 /* 수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND RRRB.KW_GRP_CO_CD = RRD.KW_GRP_CO_CD     /* 교원그룹회사코드 */
           AND RRRB.CNTR_NO = RRD.CNTR_NO               /* 계약번호 */
           AND RRRB.CNTR_SN = RRD.CNTR_SN               /* 계약일련번호 */
         WHERE 1 = 1
           <if test="@MybatisUtils@isNotEmpty(startDay) or @MybatisUtils@isNotEmpty(endDay)">
           AND RRRB.FNL_MDFC_DTM BETWEEN #{startDay} || '000000' AND #{endDay} || '235959' /* 접수일자 */
           </if>
           AND RRRB.RFND_STAT_CD = #{rfndStatCd}         /* 환불상태 : 접수(01.환불접수완료), 진행중(05.환불진행중), 반려(04.환불반려), 승인(03.환불처리완료) */
           AND RRD.DP_DV_CD = '2' /*입금구분코드 : 2(환불)*/
           AND RRD.RVE_DV_CD = #{rveDvCd} /* 수납구분코드(RVE_DV_CD)는 01.계약금, 15.기타선수금만 조회 */
           <if test="@MybatisUtils@isNotEmpty(rfndDsbDvCdCshBltf) and !@MybatisUtils@equals(rfndDsbDvCdCshBltf, 'ALL')">
           /* 처리구분   : 환불지급구분코드 (RFND_DSB_DV_CD), 현금환불구분코드 (CSH_RFND_DV_CD), 전금환불구분코드(BLTF_RFND_DV_CD) 조합으로 표시 */
           /* 1. 카드전금 : 환불지급구분코드 (RFND_DSB_DV_CD) :  03(전금) AND 전금할분구분코드 (BLTF_RFND_DV_CD) : 02(카드전금) */
           /* 2. 현금전금 : 환불지급구분코드 (RFND_DSB_DV_CD) :  03(전금) AND 전금할분구분코드 (BLTF_RFND_DV_CD) : 01(현금전금) */
           /* 3. 카드환불 : 환불지급구분코드 (RFND_DSB_DV_CD) :  02(카드환불) */
           /* 4. 현금환불 : 환불지급구분코드 (RFND_DSB_DV_CD) :  01(현금환불) AND 현금환불구분코드(CSH_RFND_DV_CD) : 02(일반환불) */
           /* 5. 선환불 : 환불지급구분코드 (RFND_DSB_DV_CD) :  01(현금환불) AND 현금환불구분코드(CSH_RFND_DV_CD) : 01(선환불) */
           /* 6. 카드현금 : 환불지급구분코드 (RFND_DSB_DV_CD) :  01(현금환불) AND 현금환불구분코드(CSH_RFND_DV_CD) : 03(카드현금)*/
           AND RRRD.RFND_DSB_DV_CD = CASE WHEN #{rfndDsbDvCdCshBltf} = '1' THEN 03
                                          WHEN #{rfndDsbDvCdCshBltf} = '2' THEN 03
                                          WHEN #{rfndDsbDvCdCshBltf} = '3' THEN 02
                                          WHEN #{rfndDsbDvCdCshBltf} = '4' THEN 01
                                          WHEN #{rfndDsbDvCdCshBltf} = '5' THEN 01
                                          WHEN #{rfndDsbDvCdCshBltf} = '6' THEN 01
                                      END
           AND RRRD.BLTF_RFND_DV_CD = CASE WHEN #{rfndDsbDvCdCshBltf} = '1' THEN 02
                                           WHEN #{rfndDsbDvCdCshBltf} = '2' THEN 01
                                           WHEN #{rfndDsbDvCdCshBltf} = '4' THEN 02
                                           WHEN #{rfndDsbDvCdCshBltf} = '5' THEN 01
                                           WHEN #{rfndDsbDvCdCshBltf} = '6' THEN 03
                                       END
           </if>
           <if test="@MybatisUtils@isNotEmpty(cntrNo)">
           AND RRRB.CNTR_NO = #{cntrNo}                 /* 계약상세번호 = 계약번호 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(cntrSn)">
           AND RRRB.CNTR_SN = #{cntrSn}                 /* 계약상세번호 = 계약일련번호 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(cstNo)">
           AND RRRB.CST_NO = #{cstNo}                    /* 고객번호 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(bzrno)">
           AND CCB.BZRNO = #{bzrno}                      /* 사업자등록번호 */
           </if>
    </select>

    <select id="selectRefundContractDetail" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundContractDetailRes">
        SELECT
               SCD.CNTR_NO                              /* 계약번호 */
             , SCD.CNTR_SN                              /* 계약일련번호 */
             , SCD.STLM_TP_CD                           /* 계약유형(일시불, 할부) */
             , SCB.COPN_DV_CD                           /* 고객유형 */
             , CCB.BZRNO                                /* 사업자번호 */
             , SCB.CNTR_CST_NO                          /* 고객번호 */
             , '' AS BZRNO_CNTR_CST_NO                  /* 사업자/고객번호 */
             , CCB.CST_KNM                              /* 계약자명 */
             , CNTR_CST_NO AS CNTR_CST_NO2                          /* 번호. 설계서에 고객번호와 번호가 동일함 */
             , SCB.CNTR_CNFM_DTM                        /* 계약일자 */
             , RRD.RVE_DT                               /* 매출일자 */
             , SCB.CNTR_CAN_DTM                         /* 취소일자 */
             , PPB.PD_NM                                /* 상품명 */
             , NVL(SCD.FNL_AMT, 0) AS FNL_AMT                              /* 주문금액 */
             , NVL(RRD.DP_AMT, 0) AS DP_AMT                              /* 입금액 */
             , NVL('', 0) AS TMP1                               /* 환불가능금액(확인필요) */
             , RRD.DP_MES_CD                            /* 입금수단코드 01.현금, 02.신용카드, 05.전금 */
             , RRD.DP_DV_CD                             /* 입금구분코드 1.입금, 2.환불, 4.전금 */
             , RRD.RVE_NO                               /* 수납번호 */
          FROM TB_SSCT_CNTR_BAS SCB                     /* 계약기본 */
         INNER JOIN TB_SSCT_CNTR_DTL SCD                /* 계약상세 */
            ON SCB.DTA_DL_YN = 'N'
           AND SCD.DTA_DL_YN = 'N'
           AND SCB.CNTR_NO = SCD.CNTR_NO                /* 계약번호 */
         INNER JOIN TB_CUBS_CST_BAS CCB                 /* 고객기본 */
            ON CCB.DTA_DL_YN = 'N'
           AND SCB.CNTR_CST_NO = CCB.CST_NO            /* 계약고객번호 = 고객번호 */
         INNER JOIN TB_RVDW_RVE_DTL RRD                /*   수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND RRD.KW_GRP_CO_CD = '2000'                /* 교원그룹회사코드 웰스 2000 */
           AND SCB.CNTR_NO = RRD.CNTR_NO                /* 계약번호 */
           AND SCD.CNTR_SN = RRD.CNTR_SN                /* 계약일련번호 */
         /* INNER JOIN TB_PDBS_PD_BAS PPB                   상품기본 */
          LEFT JOIN TB_PDBS_PD_BAS PPB                  /* 상품기본 */
            ON PPB.DTA_DL_YN = 'N'
           AND SCD.BASE_PD_CD = PPB.PD_CD               /* 기준상품코드 = 상품코드 */
         WHERE 1 = 1
           AND RRD.DP_DV_CD = '1' /* 입금구분코드 1.입금 */
           <if test="@MybatisUtils@isNotEmpty(cntrStartDay) or @MybatisUtils@isNotEmpty(cntrEndDay)">
           AND SCB.FNL_MDFC_DTM BETWEEN #{cntrStartDay} || '000000' AND #{cntrEndDay} || '235959' /* 접수일자 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(copnDvCd)">
           AND SCB.COPN_DV_CD = #{copnDvCd}             /* 고객유형 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(stlmTpCd)">
           AND SCD.STLM_TP_CD = #{stlmTpCd}             /* 계약유형 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(cntrNo)">
           AND SCD.CNTR_NO = #{cntrNo}                  /* 계약번호 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(cntrSn)">
           AND SCD.CNTR_SN = #{cntrSn}                  /* 계약일련번호 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(cntrCstNo)">
           AND SCB.CNTR_CST_NO = #{cntrCstNo}           /* 고객번호 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(bzrno)">
           AND CCB.BZRNO = #{bzrno}                     /* 사업자번호 */
           </if>
    </select>

    <select id="selectRefundPossibleAmount" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundPossibleAmountRes">
          WITH A1 AS /*주문금액*/
             (
               SELECT
                      NVL(SCD.CNTR_AMT, 0) AS CNTR_AMT/* 청약금액 = 계약상세.계약금액*/
                    , NVL(SCD.CRP_UC_AMT, 0) AS CRP_UC_AMT/* 법인미수금액 = 계약상세.법인미수금액 */
                    , NVL(SCD.MM_ISTM_AMT, 0) AS MM_ISTM_AMT/* 월할부금액_금액 = 계약상세.월할부금액 */
                    , NVL(SCD.ISTM_MCN, 0) AS ISTM_MCN /* 월할부금액_개월 = 계약상세.할부개월수 */
                    , NVL(RBFAD.BIL_NO, 0) AS BIL_NO/* 현재차월수 */
                    , NVL(RBFAD.DLQ_MCN, 0) AS DLQ_MCN/* 연체정보.연체개월 = 청구이체요청상세.연체개월수*/
                    , NVL(RBFAD.DLQ_BIL_AMT, 0) AS DLQ_BIL_AMT/* 연체정보.연체금액 = 청구이체요청상세.연체청구금액*/
                 FROM TB_SSCT_CNTR_DTL SCD /* 계약상세 */
           /* INNER JOIN TB_RVCL_BIL_FNT_AK_DTL RBFAD  청구이체요청상세 */
           LEFT JOIN TB_RVCL_BIL_FNT_AK_DTL RBFAD /* 청구이체요청상세 */
                   ON SCD.DTA_DL_YN = 'N'
                  AND RBFAD.DTA_DL_YN = 'N'
                  AND SCD.CNTR_NO = RBFAD.CNTR_NO
                  AND SCD.CNTR_SN = RBFAD.CNTR_SN
                WHERE 1 = 1
                  AND SCD.CNTR_NO = #{cntrNo}
                  AND SCD.CNTR_SN = #{cntrSn}
             )
             , A2 AS /* 주문금액 */
             (
               SELECT
                      MAX(A1.CNTR_AMT) AS CNTR_AMT /* 청약금액 = 계약상세.계약금액*/
                    , MAX(A1.CRP_UC_AMT) AS CRP_UC_AMT /* 법인미수금액 = 계약상세.법인미수금액 */
                    , MAX(A1.MM_ISTM_AMT) AS MM_ISTM_AMT/* 월할부금액_금액 = 계약상세.월할부금액 */
                    , MAX(A1.ISTM_MCN) AS ISTM_MCN /* 월할부금액_개월 = 계약상세.할부개월수 */
                    , COUNT(A1.BIL_NO) AS BIL_NO  /* 현재차월수 */
                    , MAX(A1.DLQ_MCN) AS DLQ_MCN /* 연체개월 */
                    , MAX(A1.DLQ_BIL_AMT) AS DLQ_BIL_AMT /* 연체금액*/
                 FROM A1
             )
             , B0 AS /* 입금금액 */
             (
               SELECT
                      RRD.DP_AMT
                    , RRD.DP_DV_CD
                    , RRD.RVE_DV_CD
                    , RRD.DP_CPRCNF_NO
                 FROM TB_SSCT_CNTR_DTL SCD /* 계약상세 */
           INNER JOIN TB_RVDW_RVE_DTL RRD /* 수납상세 */
                   ON SCD.DTA_DL_YN = 'N'
                  AND RRD.DTA_DL_YN = 'N'
                  AND SCD.CNTR_NO = RRD.CNTR_NO
                  AND SCD.CNTR_SN = RRD.CNTR_SN
                WHERE 1 = 1
                  AND SCD.CNTR_NO = #{cntrNo}
                  AND SCD.CNTR_SN = #{cntrSn}
             )
             , B1 AS /* 입금금액.청약인수금액 */
             (
               SELECT NVL(SUM(B0.DP_AMT), 0) AS SUBSC_TK_AMT
                 FROM B0
                WHERE 1 = 1
                  AND B0.DP_DV_CD = '1' /* 수납상세.입금구분코드 = 1.입금 */
                  AND B0.RVE_DV_CD = '01' /* 수납상세.수납구분코드 = 01.계약(청약금)*/
             )
             , B2 AS /* 입금금액.법인미수금액*/
             (
               SELECT NVL(SUM(B0.DP_AMT), 0) AS CRP_UC_AMT
                 FROM B0
           INNER JOIN TB_RVDW_DP_CPRCNF_BAS RDCB /* 입금대사기본 */
                   ON RDCB.DTA_DL_YN = 'N'
                  AND B0.DP_CPRCNF_NO = RDCB.DP_CPRCNF_NO /* 수납상세.입금대사번호 = 입금대사기본.입금대사번호 */
                WHERE 1 = 1
                  AND B0.DP_DV_CD = '1' /* 수납상세.입금구분코드 = 1.입금 */
                  AND RDCB.IA_DV_CD = '15' /* 입금대사기본.입금항목구분코드 = 15.법인미수금 */
             )
             , B3 AS /* 입금금액.할부금액 */
             (
                SELECT NVL(SUM(B0.DP_AMT), 0) AS ISTM_AMT
                  FROM B0
            INNER JOIN TB_RVDW_DP_CPRCNF_BAS RDCB /* 입금대사기본 */
                    ON RDCB.DTA_DL_YN = 'N'
                   AND B0.DP_CPRCNF_NO = RDCB.DP_CPRCNF_NO /* 수납상세.입금대사번호 = 입금대사기본.입금대사번호 */
                 WHERE 1 = 1
                   AND B0.DP_DV_CD = '1' /* 수납상세.입금구분코드 = 1.입금 */
                   AND RDCB.IA_DV_CD = '04' /* 입금대사기본.입금항목구분코드 = 04.할부금 */
             )
             , B4 AS /* 입금금액.선수금액*/
             (
                SELECT NVL(SUM(B0.DP_AMT), 0) AS PRPD_AMT
                  FROM B0
            INNER JOIN TB_RVDW_DP_CPRCNF_BAS RDCB /* 입금대사기본 */
                    ON RDCB.DTA_DL_YN = 'N'
                   AND B0.DP_CPRCNF_NO = RDCB.DP_CPRCNF_NO /* 수납상세.입금대사번호 = 입금대사기본.입금대사번호 */
                 WHERE 1 = 1
                   AND B0.DP_DV_CD = '1' /* 수납상세.입금구분코드 = 1.입금 */
                   AND RDCB.IA_DV_CD = '01' /* 입금대사기본.입금항목구분코드 = 01.선수금 */
             )
             , B5 AS /* 입금금액.입금액 */
             (
               /* (입금금액)청약/인수금액 + (입금금액)법인 미수금액 + (입금금액)할부금액 + (입금금액)선수금액 */
               SELECT ( B1.SUBSC_TK_AMT + B2.CRP_UC_AMT + B3.ISTM_AMT + B4.PRPD_AMT ) AS DP_AMT
                 FROM B1
                 JOIN B2
                   ON 1 = 1
                 JOIN B3
                   ON 1 = 1
                 JOIN B4
                   ON 1 = 1
             )
             , C1 AS /* 환불가능금액 청약/인수금액 */
             /* 환불가능 청약/인수금액 = 입금금액(청약/인수금액) - 주문금액(청약금액) */
             (
               SELECT CASE WHEN B1.SUBSC_TK_AMT - A2.CNTR_AMT > 0 THEN B1.SUBSC_TK_AMT - A2.CNTR_AMT
                      ELSE 0
                       END AS SUBSC_TK_AMT /** 청약 인수 금액 */
                 FROM B1
                 JOIN A2
                   ON 1 = 1
             )
             , C2 AS /* 환불가능금액 법인미수금액 */
             /* 환불가능 법인미수금액 = 입금금액(법인미수금액) - 주문금액(법인미수금액) */
             (
               SELECT CASE WHEN B2.CRP_UC_AMT - A2.CRP_UC_AMT > 0 THEN B2.CRP_UC_AMT - A2.CRP_UC_AMT
                      ELSE 0
                       END AS CRP_UC_AMT /** 법인 미수 금액 */
                 FROM B2
                 JOIN A2
                   ON 1 = 1
             )
             , C3 AS /* 환불가능금액 할부금액 */
             /* 환불가능 할부금액 = 입금금액(할부금액) - 주문금액(월할부금액 * 월할부개월 ) */
             (
               SELECT CASE WHEN B3.ISTM_AMT - ( A2.MM_ISTM_AMT * A2.ISTM_MCN ) > 0 THEN B3.ISTM_AMT - ( A2.MM_ISTM_AMT * A2.ISTM_MCN )
                      ELSE 0
                       END AS ISTM_AMT
                 FROM B3
                 JOIN A2
                   ON 1 = 1
             )
             , C4 AS /* 환불가능금액 선수금액 */
             /* 환불가능 선수금액 = 입금금액(할부금액) - 주문금액(월할부금액 * 월할부개월 ) */
             (
               SELECT CASE WHEN B3.ISTM_AMT - ( A2.MM_ISTM_AMT * A2.ISTM_MCN ) > 0 THEN B3.ISTM_AMT - ( A2.MM_ISTM_AMT * A2.ISTM_MCN )
                      ELSE 0
                       END AS PRPD_AMT
                 FROM B3
                 JOIN A2
                   ON 1 = 1
             )
             , C5 AS /* 환불가능금액 환불가능금액 */
             /* 환불가능금액 = (환불가능금액)청약/인수금액 + (환불가능금액)법인 미수금액 + (환불가능금액)할부금액 + (환불가능금액)선수금액 */
             (
               SELECT C1.SUBSC_TK_AMT + C2.CRP_UC_AMT + C3.ISTM_AMT + C4.PRPD_AMT AS RFND_PSB_AMT
                 FROM C1
                 JOIN C2
                   ON 1 = 1
                 JOIN C3
                   ON 1 = 1
                 JOIN C4
                   ON 1 = 1
             )
        SELECT
               A2.CNTR_AMT AS ORDER_CNTR_AMT /* 청약금액 = 계약상세.계약금액*/
             , A2.CRP_UC_AMT AS ORDER_CRP_UC_AMT /* 법인미수금액 = 계약상세.법인미수금액 */
             , A2.MM_ISTM_AMT AS ORDER_MM_ISTM_AMT /* 월할부금액_금액 = 계약상세.월할부금액 */
             , A2.ISTM_MCN AS ORDER_ISTM_MCN /* 월할부금액_개월 = 계약상세.할부개월수 */
             , A2.BIL_NO AS ORDER_BIL_NO /* 현재차월수 */
             , A2.DLQ_MCN AS ORDER_DLQ_MCN /* 연체개월 */
             , A2.DLQ_BIL_AMT AS ORDER_DLQ_BIL_AMT /* 연체금액*/
             , B1.SUBSC_TK_AMT AS DEPOSIT_SUBSC_TK_AMT /* 입금금액.청약인수금액 */
             , B2.CRP_UC_AMT AS DEPOSIT_CRP_UC_AMT /* 입금금액.법인미수금액*/
             , B3.ISTM_AMT AS DEPOSIT_ISTM_AMT /* 입금금액.할부금액 */
             , B4.PRPD_AMT AS DEPOSIT_PRPD_AMT /* 입금금액.선수금액*/
             , B5.DP_AMT AS DEPOSIT_DP_AMT /* 입금금액.입금액 */
             , C1.SUBSC_TK_AMT AS REFUND_SUBSC_TK_AMT /* 환불가능금액.청약인수금액 */
             , C2.CRP_UC_AMT AS REFUND_CRP_UC_AMT/* 환불가능금액.법인미수금액*/
             , C3.ISTM_AMT AS REFUND_ISTM_AMT/* 환불가능금액.할부금액 */
             , C4.PRPD_AMT AS REFUND_PRPD_AMT/* 환불가능금액.선수금액*/
             , C5.RFND_PSB_AMT AS REFUND_RFND_PSB_AMT/* 환불가능금액.환불가능금액 */
          FROM A2
          JOIN B1
            ON 1 = 1
          JOIN B2
            ON 1 = 1
          JOIN B3
            ON 1 = 1
          JOIN B4
            ON 1 = 1
          JOIN B5
            ON 1 = 1
          JOIN C1
            ON 1 = 1
          JOIN C2
            ON 1 = 1
          JOIN C3
            ON 1 = 1
          JOIN C4
            ON 1 = 1
          JOIN C5
            ON 1 = 1
    </select>

   <select id="selectRefundApplicationCard" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchCardRes">
        SELECT FNIT_NM /* 금융기관명 */
             , FNIT_CD /* 금융기관코드 */
          FROM TB_RVDW_FNIT_CD /* 금융기관코드 */
         WHERE FNIT_DV_CD = '2' /* 카드 */
    </select>

   <select id="selectRefundApplicationBank" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchBankRes">
        SELECT FNIT_NM /* 금융기관명 */
             , FNIT_CD /* 금융기관코드 */
          FROM TB_RVDW_FNIT_CD /* 금융기관코드 */
         WHERE FNIT_DV_CD = '1' /* 은행 */
    </select>

    <insert id="insertRefundApplication">
        <selectKey keyProperty="rfndRcpNo" resultType="java.lang.String"  order="BEFORE">
        SELECT 'RVR' || TO_CHAR(SYSDATE, 'YYYY') || LPAD(NVL(SUBSTR(MAX(RFND_RCP_NO), 8), 0) + 1, 12, '0')
          FROM TB_RVDW_RFND_RCP_BAS /* 환불접수기본 */
        </selectKey>

        INSERT
          INTO TB_RVDW_RFND_RCP_BAS /* 환불접수기본 */
             (
               KW_GRP_CO_CD         /* 교원그룹회사코드 */
             , RFND_RCP_NO          /* 환불접수번호 */
             , CST_NO               /* 고객번호 */
             , CNTR_NO              /* 계약번호 */
             , CNTR_SN              /* 계약일련번호 */
             /* , RFND_RCP_PRTNR_NO 환불접수파트너번호. 세션에서 값 확인 안됨  */
             , RFND_RCP_PH_CD       /*  환불접수경로코드 01.판매, 02.서비스, 03.채권, 04.소모품 개인적인 견해는 03.채권인데, 확인 필요함. */
             , RFND_RQDT            /* 환불요청일자 */
             , RFND_STAT_CD         /* 환불상태코드 01.환불접수완료, 02.환불전표생성완료, 03.환불처리완료, 04.환불반려, 05.환불진행중 */
             , EX_RFND_RSON_CN
             , RFND_CSH_AMT
             , RFND_CARD_AMT
             , RFND_BLTF_AMT
             , RFND_PSB_RES_AMT
             , TOT_RFND_ET_AMT
             , RFND_RVE_DT
             , RFND_PERF_DT
             , RFND_FSH_DT
             , RFND_PROCS_CN
             , DTA_DL_YN            /*데이터삭제여부*/
        <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             (
               '2000'               /* 교원그룹회사코드 1200.에듀, 2000.웰스 */
             , #{rfndRcpNo}         /* 환불접수번호 */
             , #{cstNo}             /* 고객번호 */
             , #{cntrNo}            /* 계약번호 */
             , #{cntrSn}            /* 계약일련번호 */
             /* , {rfndRcpPrtnrNo} 환불접수파트너번호. 세션에서 값 확인 안됨 */
             , '03'                 /* 환불접수경로코드. 개인적인 견해는 03.채권인데, 확인 필요함. */
             , TO_CHAR(SYSDATE, 'YYYYMMDD') /* 환불요청일자 */
             , '01'                 /* 환불상태코드 01.환불접수완료, 02.환불전표생성완료, 03.환불처리완료, 04.환불반려, 05.환불진행중 */
             , #{exRfndRsonCn}      /* 예외환불 사유 */
             , #{rfndCshAmt}        /* 현금 환불금액 */
             , #{rfndCardAmt}       /* 카드 환불금액 */
             , #{rfndBltfAmt}       /* 전금 금액 */
             , #{rfndPsbResAmt}     /* 환불가능 잔액 */
             , #{totRfndEtAmt}      /* 총환불가능 잔액 */
             , #{rfndRveDt}         /* 수납일자 */
             , #{rfndPerfDt}        /* 실적일자 */
             , #{rfndFshDt}         /* 지급일자 */
             , #{rfndProcsCn}       /* 처리내용 */
             , 'N'                  /*데이터삭제여부*/
        <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <insert id="insertRefundApplicationHistory">
        <selectKey keyProperty="rfndRcpNo" resultType="java.lang.String"  order="BEFORE">
        SELECT 'RVR' || TO_CHAR(SYSDATE, 'YYYY') || LPAD(NVL(SUBSTR(MAX(RFND_RCP_NO), 8), 0), 12, '0')
          FROM TB_RVDW_RFND_RCP_BAS /* 환불접수기본 */
        </selectKey>

        INSERT
          INTO TB_RVDW_RFND_RCP_BAS_HIST    /* 환불접수기본이력 */
             (
               KW_GRP_CO_CD                 /* 교원그룹회사코드 */
             , RFND_RCP_NO                  /* 환불접수번호 */
             , HIST_CH_DTM                  /* 이력변경일시 */
             , RVE_CO_CD                    /* 수납회사코드 */
             , CST_NO                       /* 고객번호 */
             , CNTR_NO                      /* 계약번호 */
             , CNTR_SN                      /* 계약일련번호 */
             , CNTR_CH_RCP_ID               /* 계약변경접수ID */
             , CNTR_CH_SN                   /* 계약변경일련번호 */
             , RFND_RCP_OG_TP_CD            /* 환불접수조직유형코드 */
             , RFND_RCP_PRTNR_NO            /* 환불접수파트너번호 */
             , RFND_RCP_PH_CD               /* 환불접수경로코드 */
             , RFND_RQDT                    /* 환불요청일자 */
             , RFND_FSH_DT                  /* 환불완료일자 */
             , RTNGD_FSH_DT                 /* 반품완료일자 */
             , CST_SV_ASN_NO                /* 고객서비스배정번호 */
             , RFND_CSH_AMT                 /* 환불현금금액 */
             , RFND_CARD_AMT                /* 환불카드금액 */
             , RFND_BLTF_AMT                /* 환불전금금액 */
             , RFND_DDTN_AMT                /* 환불공제금액 */
             , RFND_FEE_AMT                 /* 환불수수료금액 */
             , RFND_PSB_RES_AMT             /* 환불가능잔여금액 */
             , TOT_RFND_ET_AMT              /* 총환불예상금액 */
             , EX_RFND_RSON_CN              /* 예외환불사유내용 */
             , RFND_STAT_CD                 /* 환불상태코드 */
             , RFND_RVE_DT                  /* 환불수납일자 */
             , RFND_PERF_DT                 /* 환불실적일자 */
             , RFND_DSB_DT                  /* 환불지급일자 */
             , RFND_PROCS_CN                /* 환불처리내용 */
             , RFND_PROCS_USR_ID            /* 환불처리사용자ID */
             , DTA_DL_YN                    /*데이터삭제여부*/
        <include refid="COMMON.insertSystemField"/>
             )
        SELECT
               RRRB.KW_GRP_CO_CD            /* 교원그룹회사코드 */
             , RRRB.RFND_RCP_NO             /* 환불접수번호 */
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')                      /* 이력변경일시 */
             , RRRB.RVE_CO_CD               /* 수납회사코드 */
             , RRRB.CST_NO                  /* 고객번호 */
             , RRRB.CNTR_NO                 /* 계약번호 */
             , RRRB.CNTR_SN                 /* 계약일련번호 */
             , RRRB.CNTR_CH_RCP_ID          /* 계약변경접수ID */
             , RRRB.CNTR_CH_SN              /* 계약변경일련번호 */
             , RRRB.RFND_RCP_OG_TP_CD       /* 환불접수조직유형코드 */
             , RRRB.RFND_RCP_PRTNR_NO       /* 환불접수파트너번호 */
             , RRRB.RFND_RCP_PH_CD          /* 환불접수경로코드 */
             , RRRB.RFND_RQDT               /* 환불요청일자 */
             , RRRB.RFND_FSH_DT             /* 환불완료일자 */
             , RRRB.RTNGD_FSH_DT            /* 반품완료일자 */
             , RRRB.CST_SV_ASN_NO           /* 고객서비스배정번호 */
             , RRRB.RFND_CSH_AMT            /* 환불현금금액 */
             , RRRB.RFND_CARD_AMT           /* 환불카드금액 */
             , RRRB.RFND_BLTF_AMT           /* 환불전금금액 */
             , RRRB.RFND_DDTN_AMT           /* 환불공제금액 */
             , RRRB.RFND_FEE_AMT            /* 환불수수료금액 */
             , RRRB.RFND_PSB_RES_AMT        /* 환불가능잔여금액 */
             , RRRB.TOT_RFND_ET_AMT         /* 총환불예상금액 */
             , RRRB.EX_RFND_RSON_CN         /* 예외환불사유내용 */
             , RRRB.RFND_STAT_CD            /* 환불상태코드 */
             , RRRB.RFND_RVE_DT             /* 환불수납일자 */
             , RRRB.RFND_PERF_DT            /* 환불실적일자 */
             , RRRB.RFND_DSB_DT             /* 환불지급일자 */
             , RRRB.RFND_PROCS_CN           /* 환불처리내용 */
             , RRRB.RFND_PROCS_USR_ID       /* 환불처리사용자ID */
             , RRRB.DTA_DL_YN               /*데이터삭제여부*/
             , RRRB.FST_RGST_DTM
             , RRRB.FST_RGST_USR_ID
             , RRRB.FST_RGST_PRG_ID
             , RRRB.FST_RGST_DEPT_ID
             , RRRB.FNL_MDFC_DTM
             , RRRB.FNL_MDFC_USR_ID
             , RRRB.FNL_MDFC_PRG_ID
             , RRRB.FNL_MDFC_DEPT_ID
          FROM TB_RVDW_RFND_RCP_BAS RRRB
         WHERE RRRB.KW_GRP_CO_CD = '2000'               /* 교원그룹회사코드 1200.에듀, 2000.웰스 */
           AND RRRB.RFND_RCP_NO = #{rfndRcpNo}            /* 환불접수번호 */
    </insert>

    <insert id="insertRefundApplicationDetail">
        <selectKey keyProperty="rfndRcpNo" resultType="java.lang.String"  order="BEFORE">
        SELECT 'RVR' || TO_CHAR(SYSDATE, 'YYYY') || LPAD(NVL(SUBSTR(MAX(RFND_RCP_NO), 8), 0) + 1, 12, '0') AS rfndRcpNo
          FROM TB_RVDW_RFND_RCP_BAS /* 환불접수기본 */
        </selectKey>

        INSERT
          INTO TB_RVDW_RFND_RCP_DTL     /* 환불접수상세 */
             (
               KW_GRP_CO_CD             /* 교원그룹회사코드 */
             , RFND_RCP_NO              /* 환불접수번호 */
             , RFND_RCP_DTL_SN          /* 환불접수상세일련번호 */
             , RVE_NO                   /* 수납번호 */
             , RFND_DV_CD               /* 환불구분 */
             , RFND_DSB_DV_CD           /* 환불지급구분코드 01.현금환불, 02.카드환블, 03.전금, 04.귀속, 05.웰스당월가전손료 */
             , RFND_RSON_CN             /* 기타 환불사유 입력란*/
             <if test='@MybatisUtils@equals(rfndDsbDvCd,"01")'>
             , CSH_RFND_FNIT_CD         /* 은행구분 */
             , CSH_RFND_DV_CD           /* 현금환불구분코드 */
             , RFND_AC_DV_CD            /* 환불계좌구분코드 */
             , CSH_RFND_ACNO_ENCR       /* 계좌번호 */
             , CSH_RFND_ACOWN_NM        /* 예금주 */

             , CSH_RFND_ADRS_DV_CD      /* 수취인 */
             , CSH_RFND_DLGPS_NM        /* 대표자 확인 */
             , CARD_RFND_CRDCD_APR_STRT_DT /* 승인일 시작 */
             , CARD_RFND_CRDCD_APR_END_DT /* 승인일 종료 */
             , RFND_AK_AMT              /* 환불신청금액 */
             , RFND_DSB_AMT             /* 실지급액(원) */
             , RFND_EXP_AMT             /* 환불예정금액 */
             , RFND_RSON_CD             /* 환불사유 코드 */
             </if>
             <if test='@MybatisUtils@equals(rfndDsbDvCd,"02")'>
             , CARD_RFND_FNIT_CD        /* 카드정보.카드사코드 (카드선택시) */
             , CARD_RFND_CRCDNO_ENCR    /* 카드정보.카드번호 (카드선택시) */
             , CARD_RFND_FER            /* 카드 공제액 */
             , CARD_RFND_CRDCD_APR_STRT_DT /* 승인일 시작 */
             , CARD_RFND_CRDCD_APR_END_DT /* 승인일 종료 */
             , RFND_RSON_CD             /* 환불사유 코드 */
             </if>
             <if test='@MybatisUtils@equals(rfndDsbDvCd,"03")'>
             , BLTF_RFND_DV_CD /* 전금환불구분코드 */
             , BLTF_RFND_MB_DV_CD      /* 전금환불회원구분코드 */
             , BLTF_BF_VAC_NO_ENCR     /* 전금이전가상계좌번호암호화 */
             , BLTF_AF_VAC_NO_ENCR     /* 전금이후가상계좌번호암호화 */
             , RFND_EVID_MTR_FILE_ID    /* 증빙자료 파일첨부 */
             , RFND_AK_AMT     /* 환불요청금액 */
             </if>
             , DTA_DL_YN                /*데이터삭제여부*/
             <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             (
                '2000'                  /* 교원그룹회사코드 1200.에듀, 2000.웰스 */
             , #{rfndRcpNo}             /* 환불접수번호 */
             , (
               SELECT NVL(MAX(RRRD.RFND_RCP_DTL_SN), 0) + 1
                 FROM TB_RVDW_RFND_RCP_DTL RRRD /* 환불접수상세 */
                WHERE RRRD.RFND_RCP_NO = #{rfndRcpNo}
               )                        /* 환불접수상세일련번호 */
             , #{rveNo}                 /* 수납번호 */
             , #{rfndDvCd}              /* 환불구분 */
             , #{rfndDsbDvCd}           /* 환불지급구분코드 01.현금환불, 02.카드환블, 03.전금, 04.귀속, 05.웰스당월가전손료 */
             , #{rfndRsonCn}            /* 기타 환불사유 입력, 전금환불사유 */
             <if test='@MybatisUtils@equals(rfndDsbDvCd,"01")'>
             , #{cshRfndFnitCd}         /* 은행구분 */
             , #{cshRfndDvCd}           /* 현금환불구분코드 */
             , #{rfndAcDvCd}            /* 환불계좌구분코드 */
             , #{cshRfndAcnoEncr}       /* 계좌번호 */
             , #{cshRfndAcownNm}        /* 예금주 */
             , #{cshRfndAdrsDvCd}       /* 수취인 */
             , #{cshRfndDlgpsNm}        /* 대표자 확인 */
             , #{startDay}              /* 승인일 시작 */
             , #{endDay}                /* 승인일 종료 */
             , #{rfndAkAmt}             /* 환불신청금액 */
             , #{rfndDsbAmt}            /* 실지급액(원) */
             , #{rfndExpAmt}            /* 환불예정금액 */
             , #{rfndRsonCd}            /* 환불사유코드 */
             </if>
             <if test='@MybatisUtils@equals(rfndDsbDvCd,"02")'>
             , #{cardRfndFnitCd}        /* 카드정보.카드사코드 */
             , #{cardRfndCrcdnoEncr}    /* 카드정보.카드번호 */
             , #{cardRfndFer}           /* 카드 공제액 */
             , #{startDay}              /* 승인일 시작 */
             , #{endDay}                /* 승인일 종료 */
             , #{rfndRsonCd}            /* 환불사유코드 */
             </if>
             <if test='@MybatisUtils@equals(rfndDsbDvCd,"03")'>
             , #{bltfRfndDvCd}          /* 전금구분 */
             , #{bltfRfndMbDvCd}        /* 회원구분 */
             , #{bltfBfVacNoEncr}       /* 전금전 가상계좌 */
             , #{bltfAfVacNoEncr}       /* 전금후 가상계좌 */
             , #{rfndEvidMtrFileId}     /* 증빙자료 파일첨부 */
             , #{rfndAkAmt}            /* 전금 요청금액(원) */
             </if>
             , 'N'                      /*데이터삭제여부*/
             <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <insert id="insertRefundApplicationDetailHistory">
        <selectKey keyProperty="rfndRcpNo" resultType="java.lang.String"  order="BEFORE">
        SELECT 'RVR' || TO_CHAR(SYSDATE, 'YYYY') || LPAD(NVL(SUBSTR(MAX(RFND_RCP_NO), 8), 0) + 1, 12, '0') AS rfndRcpNo
          FROM TB_RVDW_RFND_RCP_BAS /* 환불접수기본 */
        </selectKey>
        INSERT
          INTO TB_RVDW_RFND_RCP_DTL_HIST    /* 환불접수상세이력 */
             (
               KW_GRP_CO_CD                 /* 교원그룹회사코드 */
             , RFND_RCP_NO                  /* 환불접수번호 */
             , RFND_RCP_DTL_SN              /* 환불접수상세일련번호 */
             , HIST_CH_DTM                  /* 이력변경일시 */
             , RFND_DSB_DV_CD               /* 환불지급구분코드 */
             , CSH_RFND_DV_CD               /* 현금환불구분코드 */
             , RFND_AC_DV_CD                /* 환불계좌구분코드 */
             , CSH_RFND_FNIT_CD             /* 현금환불금융기관코드 */
             , CSH_RFND_ACNO_ENCR           /* 현금환불계좌번호암호화 */
             , CSH_RFND_ACOWN_NM            /* 현금환불계좌주명 */
             , CSH_RFND_ADRS_DV_CD          /* 현금환불수취인구분코드 */
             , CSH_RFND_DLGPS_NM            /* 현금환불대표자명 */
             , CARD_RFND_FNIT_CD            /* 카드환불금융기관코드 */
             , CARD_RFND_CRDCD_APR_STRT_DT  /* 카드환불신용카드승인시작일자 */
             , CARD_RFND_CRDCD_APR_END_DT   /* 카드환불신용카드승인종료일자 */
             , CARD_RFND_CRCDNO_ENCR        /* 카드환불신용카드번호암호화 */
             , CARD_RFND_CRDCD_ISTM_MCN     /* 카드환불신용카드할부개월수 */
             , CARD_RFND_CRCDONR_NM         /* 카드환불신용카드주명 */
             , CARD_RFND_CRDCD_APRNO        /* 카드환불신용카드승인번호 */
             , CARD_RFND_CRDCD_APR_AMT      /* 카드환불신용카드승인금액 */
             , CARD_RFND_FEE                /* 카드환불수수료 */
             , CARD_RFND_FER                /* 카드환불수수료율 */
             , BLTF_RFND_DV_CD              /* 전금환불구분코드 */
             , BLTF_RFND_MB_DV_CD           /* 전금환불회원구분코드 */
             , BLTF_OJ_CNTR_NO              /* 전금대상계약번호 */
             , BLTF_OJ_CNTR_SN              /* 전금대상계약일련번호 */
             , BLTF_BF_VAC_NO_ENCR          /* 전금이전가상계좌번호암호화 */
             , BLTF_AF_VAC_NO_ENCR          /* 전금이후가상계좌번호암호화 */
             , RFND_AK_AMT                  /* 환불요청금액 */
             , RFND_DDTN_AMT                /* 환불공제금액 */
             , RFND_RSON_CD                 /* 환불사유코드 */
             , RFND_RSON_CN                 /* 환불사유내용 */
             , RFND_EXP_AMT                 /* 환불예정금액 */
             , RFND_FSH_DT                  /* 환불완료일자 */
             , RFND_DSB_AMT                 /* 환불지급금액 */
             , RFND_DSB_DUEDT               /* 환불지급예정일자 */
             , RFND_PSP_DC                  /* 환불지연일수 */
             , RFND_DSB_PSP_INT             /* 환불지급지연이자 */
             , RFND_SLIP_CRT_DT             /* 환불전표생성일자 */
             , RFND_SLPNO                   /* 환불전표번호 */
             , MLG_TP_CD                    /* 마일리지유형코드 */
             , MLG_RV_NO                    /* 마일리지적립번호 */
             , RVE_NO                       /* 수납번호 */
             , PY_AMT                       /* 납입금액 */
             , DLQ_AMT                      /* 연체금액 */
             , BOR_AMT                      /* 위약금액 */
             , DTA_DL_YN                    /* 데이터삭제여부 */
             , RFND_EVID_MTR_FILE_ID        /* 환불증빙자료파일ID */
             <include refid="COMMON.insertSystemField"/>
             )
        SELECT
               RRRD.KW_GRP_CO_CD            /* 교원그룹회사코드 */
             , RRRD.RFND_RCP_NO             /* 환불접수번호 */
             , RRRD.RFND_RCP_DTL_SN         /* 환불접수상세일련번호 */
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')                      /* 이력변경일시 */
             , RRRD.RFND_DSB_DV_CD          /* 환불지급구분코드 */
             , RRRD.CSH_RFND_DV_CD          /* 현금환불구분코드 */
             , RFND_AC_DV_CD                /* 환불계좌구분코드 */
             , RRRD.CSH_RFND_FNIT_CD        /* 현금환불금융기관코드 */
             , RRRD.CSH_RFND_ACNO_ENCR      /* 현금환불계좌번호암호화 */
             , RRRD.CSH_RFND_ACOWN_NM       /* 현금환불계좌주명 */
             , RRRD.CSH_RFND_ADRS_DV_CD     /* 현금환불수취인구분코드 */
             , RRRD.CSH_RFND_DLGPS_NM       /* 현금환불대표자명 */
             , RRRD.CARD_RFND_FNIT_CD       /* 카드환불금융기관코드 */
             , RRRD.CARD_RFND_CRDCD_APR_STRT_DT /* 카드환불신용카드승인시작일자 */
             , RRRD.CARD_RFND_CRDCD_APR_END_DT /* 카드환불신용카드승인종료일자 */
             , RRRD.CARD_RFND_CRCDNO_ENCR   /* 카드환불신용카드번호암호화 */
             , RRRD.CARD_RFND_CRDCD_ISTM_MCN /* 카드환불신용카드할부개월수 */
             , RRRD.CARD_RFND_CRCDONR_NM    /* 카드환불신용카드주명 */
             , RRRD.CARD_RFND_CRDCD_APRNO   /* 카드환불신용카드승인번호 */
             , RRRD.CARD_RFND_CRDCD_APR_AMT /* 카드환불신용카드승인금액 */
             , RRRD.CARD_RFND_FEE           /* 카드환불수수료 */
             , RRRD.CARD_RFND_FER           /* 카드환불수수료율 */
             , RRRD.BLTF_RFND_DV_CD         /* 전금환불구분코드 */
             , RRRD.BLTF_RFND_MB_DV_CD      /* 전금환불회원구분코드 */
             , RRRD.BLTF_OJ_CNTR_NO         /* 전금대상계약번호 */
             , RRRD.BLTF_OJ_CNTR_SN         /* 전금대상계약일련번호 */
             , RRRD.BLTF_BF_VAC_NO_ENCR     /* 전금이전가상계좌번호암호화 */
             , RRRD.BLTF_AF_VAC_NO_ENCR     /* 전금이후가상계좌번호암호화 */
             , RRRD.RFND_AK_AMT             /* 환불요청금액 */
             , RRRD.RFND_DDTN_AMT           /* 환불공제금액 */
             , RRRD.RFND_RSON_CD            /* 환불사유코드 */
             , RRRD.RFND_RSON_CN            /* 환불사유내용 */
             , RRRD.RFND_EXP_AMT            /* 환불예정금액 */
             , RRRD.RFND_FSH_DT             /* 환불완료일자 */
             , RRRD.RFND_DSB_AMT            /* 환불지급금액 */
             , RRRD.RFND_DSB_DUEDT          /* 환불지급예정일자 */
             , RRRD.RFND_PSP_DC             /* 환불지연일수 */
             , RRRD.RFND_DSB_PSP_INT        /* 환불지급지연이자 */
             , RRRD.RFND_SLIP_CRT_DT        /* 환불전표생성일자 */
             , RRRD.RFND_SLPNO              /* 환불전표번호 */
             , RRRD.MLG_TP_CD               /* 마일리지유형코드 */
             , RRRD.MLG_RV_NO               /* 마일리지적립번호 */
             , RRRD.RVE_NO                  /* 수납번호 */
             , RRRD.PY_AMT                  /* 납입금액 */
             , RRRD.DLQ_AMT                 /* 연체금액 */
             , RRRD.BOR_AMT                 /* 위약금액 */
             , RRRD.DTA_DL_YN               /* 데이터삭제여부. */
             , RRRD.RFND_EVID_MTR_FILE_ID   /* 환불증빙자료파일ID */
             , RRRD.FST_RGST_DTM
             , RRRD.FST_RGST_USR_ID
             , RRRD.FST_RGST_PRG_ID
             , RRRD.FST_RGST_DEPT_ID
             , RRRD.FNL_MDFC_DTM
             , RRRD.FNL_MDFC_USR_ID
             , RRRD.FNL_MDFC_PRG_ID
             , RRRD.FNL_MDFC_DEPT_ID
         FROM TB_RVDW_RFND_RCP_DTL RRRD
        WHERE RRRD.KW_GRP_CO_CD = '2000'    /* 교원그룹회사코드 1200.에듀, 2000.웰스 */
          AND RRRD.RFND_RCP_NO = #{rfndRcpNo}            /* 환불접수번호 */
          AND RRRD.RFND_RCP_DTL_SN = (
                                   SELECT MAX(RRRD.RFND_RCP_DTL_SN)
                                     FROM TB_RVDW_RFND_RCP_DTL RRRD /* 환불접수상세 */
                                    WHERE RRRD.RFND_RCP_NO = #{rfndRcpNo}
                                 )                        /* 환불접수상세일련번호 */
    </insert>

    <select id="selectRefundApplicationInfo" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$RefundBasic">
        SELECT
               RRRB.RFND_RCP_NO
             , RRRB.CNTR_NO /* 계약번호 */
             , RRRB.CNTR_SN /* 계약일련번호  */
             , RRRB.CST_NO/* 고객번호 */
             , RRRB.EX_RFND_RSON_CN /* 예외환불사유 */
             , RRRB.RFND_CSH_AMT /* 현금 환불금액 */
             , RRRB.RFND_CARD_AMT /* 카드 환불금액 */
             , RRRB.RFND_BLTF_AMT /* 전금금액 */
             , RRRB.RFND_PSB_RES_AMT /* 환불가능 잔액 */
             , RRRB.TOT_RFND_ET_AMT /* 총 환불 예상금액 */
             , RRRB.RFND_RVE_DT /* 수납일자 */
             , RRRB.RFND_PERF_DT /* 실적일자 */
             , RRRB.RFND_DSB_DT /* 지급일자 */
             , RRRB.RFND_STAT_CD /* 처리구분 (반려, 승인) */
             , RRRB.RFND_PROCS_CN /* 처리내용 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
         WHERE RRRB.DTA_DL_YN = 'N'
           AND RRRB.KW_GRP_CO_CD = '2000'   /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = #{rfndRcpNo}          /* 환불접수번호 */
    </select>

    <select id="selectRefundApplicationDetailInfo" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$RefundDetail">
        SELECT
               RRRD.RFND_RCP_NO
             , RRRD.RFND_RCP_DTL_SN
             , RRRD.RVE_NO /* 수납상세.수납번호 */
             , RRRD.RFND_DV_CD /* 환불구분 01.전체환불, 02.부분환불*/
             , RRRD.RFND_DSB_DV_CD /* (상세)환불구분(현금환불, 카드환불, 전금) */
             , RRRD.CSH_RFND_DV_CD /* 현금환불구분(선환불, 일반환불, 카드현금) */
             , RRRD.RFND_AC_DV_CD /* 환불계좌구분(기입금계좌, 신규계좌) */
             , RRRD.CSH_RFND_FNIT_CD /* 은행사코드 */
             , RRRD.CSH_RFND_ACNO_ENCR /* 계좌번호 */
             , RRRD.CSH_RFND_ACOWN_NM /* 예금주 */
             , RRRD.CSH_RFND_ADRS_DV_CD /* 수취인 코드(본인,가족,실입금자, 제3자, 대표자) */
             , RRRD.CSH_RFND_DLGPS_NM /* 대표자 확인 */
             , RRRD.RFND_AK_AMT /* 환불 신청금액/전금요청금액 */
             , RRRD.RFND_DSB_AMT /* 실지급액 */
             , RRRD.RFND_RSON_CD /* 환불사유 코드 */
             , RRRD.CARD_RFND_FNIT_CD /* 카드사코드 */
             , RRRD.CARD_RFND_CRCDNO_ENCR /* 카드번호 */
             , RRRD.CARD_RFND_FER /* 카드공제액(%) */
             , RRRD.RFND_RSON_CN /* 환불/전금 사유 */
             , RRRD.CARD_RFND_CRDCD_APR_STRT_DT AS START_DAY /* 승인(시작)일 */
             , RRRD.CARD_RFND_CRDCD_APR_END_DT AS END_DAY /* 승인(종료)일 */
             , RRRD.BLTF_RFND_DV_CD /* 전금구분(현금전금, 카드전금) */
             , RRRD.BLTF_RFND_MB_DV_CD /* 회원구분(교원키 동일회원, 제3자 회원) */
             , RRRD.BLTF_OJ_CNTR_SN /* (전금할)고객번호2 */
             , RRRD.BLTF_BF_VAC_NO_ENCR /* 전금전 가상계좌 */
             , RRRD.BLTF_AF_VAC_NO_ENCR /* 전금후 가상계좌 */
             , RRRD.RFND_EVID_MTR_FILE_ID /* 증빙자료 파일명 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
         INNER JOIN TB_RVDW_RFND_RCP_DTL RRRD           /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N'
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
         WHERE RRRB.KW_GRP_CO_CD = '2000'               /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = #{rfndRcpNo}          /* 환불접수번호 */
    </select>

    <update id="updateRefundApplication">
        UPDATE TB_RVDW_RFND_RCP_BAS
           SET EX_RFND_RSON_CN = #{exRfndRsonCn}
             , RFND_CSH_AMT = #{rfndCshAmt}/* 현금 환불금액 */
             , RFND_CARD_AMT = #{rfndCardAmt} /* 카드 환불금액 */
             , RFND_BLTF_AMT = #{rfndBltfAmt}/* 전금금액 */
             , RFND_PSB_RES_AMT = #{rfndPsbResAmt}/* 환불가능 잔액 */
             , TOT_RFND_ET_AMT = #{totRfndEtAmt}/* 총 환불 예상금액 */
             , RFND_RVE_DT = #{rfndRveDt}/* 수납일자 */
             , RFND_PERF_DT = #{rfndPerfDt}/* 실적일자 */
             , RFND_DSB_DT = #{rfndDsbDt}/* 지급일자 */
             , RFND_PROCS_CN = #{rfndProcsCn}/* 처리내용 */
         WHERE DTA_DL_YN = 'N'
           AND KW_GRP_CO_CD = '2000'   /* 교원그룹회사코드 */
           AND RFND_RCP_NO = #{rfndRcpNo}          /* 환불접수번호 */
    </update>

    <update id="updateRefundApplicationDetail">
        MERGE
         INTO TB_RVDW_RFND_RCP_DTL
        USING DUAL
           ON
            (
                  DTA_DL_YN = 'N'
              AND RFND_RCP_NO = #{rfndRcpNo}          /* 환불접수번호 */
              AND RFND_RCP_DTL_SN = #{rfndRcpDtlSn}   /* 환불접수일련번호 */
            )
         WHEN MATCHED THEN
       UPDATE
          SET RVE_NO      = #{rveNo} /* 수납상세.수납번호 */
            , RFND_DV_CD        = #{rfndDvCd} /* 환불구분 01.전체환불, 02.부분환불*/
            , RFND_DSB_DV_CD    = #{rfndDsbDvCd} /* (상세)환불구분(현금환불, 카드환불, 전금) */
            , CSH_RFND_DV_CD    = #{cshRfndDvCd} /* 현금환불구분(선환불, 일반환불, 카드현금) */
            , RFND_AC_DV_CD     = #{rfndAcDvCd} /* 환불계좌구분(기입금계좌, 신규계좌) */
            , CSH_RFND_FNIT_CD          = #{cshRfndFnitCd} /* 은행사코드 */
            , CSH_RFND_ACNO_ENCR        = #{cshRfndAcnoEncr} /* 계좌번호 */
            , CSH_RFND_ACOWN_NM         = #{cshRfndAcownNm} /* 예금주 */
            , CSH_RFND_ADRS_DV_CD       = #{cshRfndAdrsDvCd} /* 수취인 코드(본인,가족,실입금자, 제3자*/
            , CSH_RFND_DLGPS_NM         = #{cshRfndDlgpsNm} /* 대표자 확인 */
            , RFND_AK_AMT       = #{rfndAkAmt} /* 환불 신청금액/전금요청금액 */
            , RFND_DSB_AMT      = #{rfndDsbAmt} /* 실지급액 */
            , RFND_RSON_CD      = #{rfndRsonCd} /* 환불사유 코드 */
            , CARD_RFND_FNIT_CD         = #{cardRfndFnitCd} /* 카드사코드 */
            , CARD_RFND_CRCDNO_ENCR     = #{cardRfndCrcdnoEncr} /* 카드번호 */
            , CARD_RFND_FER     = #{cardRfndFer} /* 카드공제액(%) */
            , RFND_RSON_CN      = #{rfndRsonCn} /* 환불/전금 사유 */
            , CARD_RFND_CRDCD_APR_STRT_DT          = #{cardRfndCrdcdAprStrtDt As StartDay} /* 승인(시작)일 */
            , CARD_RFND_CRDCD_APR_END_DT    = #{cardRfndCrdcdAprEndDt As EndDay} /* 승인(종료)일 */
            , BLTF_RFND_DV_CD   = #{bltfRfndDvCd} /* 전금구분(현금전금, 카드전금) */
            , BLTF_RFND_MB_DV_CD        = #{bltfRfndMbDvCd} /* 회원구분(교원키 동일회원, 제3자 회원) */
            , BLTF_OJ_CNTR_SN   = #{bltfOjCntrSn} /* (전금할)고객번호2 */
            , BLTF_BF_VAC_NO_ENCR       = #{bltfBfVacNoEncr} /* 전금전 가상계좌 */
            , BLTF_AF_VAC_NO_ENCR       = #{bltfAfVacNoEncr} /* 전금후 가상계좌 */
            , RFND_EVID_MTR_FILE_ID     = #{rfndEvidMtrFileId} /* 증빙자료 파일명 */
              <include refid="COMMON.updateSystemField"/>
         WHEN NOT MATCHED THEN
       INSERT
            (
              KW_GRP_CO_CD /* 교원그룹회사코드 */
            , RFND_RCP_NO /* 환불접수번호 */
            , RFND_RCP_DTL_SN /* 환불접수상세일련번호 */
            , RFND_DSB_DV_CD /* 환불지급구분코드 */
            , CSH_RFND_DV_CD /* 현금환불구분코드 */
            , RFND_AC_DV_CD /* 환불계좌구분코드 */
            , CSH_RFND_FNIT_CD /* 현금환불금융기관코드 */
            , CSH_RFND_ACNO_ENCR /* 현금환불계좌번호암호화 */
            , CSH_RFND_ACOWN_NM /* 현금환불계좌주명 */
            , CSH_RFND_ADRS_DV_CD /* 현금환불수취인구분코드 */
            , CSH_RFND_DLGPS_NM /* 현금환불대표자명 */
            , CARD_RFND_FNIT_CD /* 카드환불금융기관코드 */
            , CARD_RFND_CRDCD_APR_STRT_DT /* 카드환불신용카드승인시작일자 */
            , CARD_RFND_CRDCD_APR_END_DT /* 카드환불신용카드승인종료일자 */
            , CARD_RFND_CRCDNO_ENCR /* 카드환불신용카드번호암호화 */
            , CARD_RFND_CRDCD_ISTM_MCN /* 카드환불신용카드할부개월수 */
            , CARD_RFND_CRCDONR_NM /* 카드환불신용카드주명 */
            , CARD_RFND_CRDCD_APRNO /* 카드환불신용카드승인번호 */
            , CARD_RFND_CRDCD_APR_AMT /* 카드환불신용카드승인금액 */
            , CARD_RFND_FEE /* 카드환불수수료 */
            , CARD_RFND_FER /* 카드환불수수료율 */
            , BLTF_RFND_DV_CD /* 전금환불구분코드 */
            , BLTF_RFND_MB_DV_CD /* 전금환불회원구분코드 */
            , BLTF_OJ_CNTR_NO /* 전금대상계약번호 */
            , BLTF_OJ_CNTR_SN /* 전금대상계약일련번호 */
            , BLTF_BF_VAC_NO_ENCR /* 전금이전가상계좌번호암호화 */
            , BLTF_AF_VAC_NO_ENCR /* 전금이후가상계좌번호암호화 */
            , RFND_AK_AMT /* 환불요청금액 */
            , RFND_DDTN_AMT /* 환불공제금액 */
            , RFND_RSON_CD /* 환불사유코드 */
            , RFND_RSON_CN /* 환불사유내용 */
            , RFND_EXP_AMT /* 환불예정금액 */
            , RFND_FSH_DT /* 환불완료일자 */
            , RFND_DSB_AMT /* 환불지급금액 */
            , RFND_DSB_DUEDT /* 환불지급예정일자 */
            , RFND_PSP_DC /* 환불지연일수 */
            , RFND_DSB_PSP_INT /* 환불지급지연이자 */
            , RFND_SLIP_CRT_DT /* 환불전표생성일자 */
            , RFND_SLPNO /* 환불전표번호 */
            , MLG_TP_CD /* 마일리지유형코드 */
            , MLG_RV_NO /* 마일리지적립번호 */
            , RVE_NO /* 수납번호 */
            , PY_AMT /* 납입금액 */
            , DLQ_AMT /* 연체금액 */
            , BOR_AMT /* 위약금액 */
            , RFND_EVID_MTR_FILE_ID /* 환불증빙자료파일ID */
            <include refid="COMMON.insertSystemField"/>
            )
       VALUES
            (
              2000 /*교원그룹회사코드*/
            , #{rfndRcpNo} /*환불접수번호*/
            , (
                SELECT NVL(MAX(RRRD.RFND_RCP_DTL_SN), 0) + 1
                  FROM TB_RVDW_RFND_RCP_DTL RRRD /* 환불접수상세 */
                 WHERE RRRD.RFND_RCP_NO = #{rfndRcpNo}
               )                        /* 환불접수상세일련번호 */
            , #{rfndDsbDvCd} /*환불지급구분코드*/
            , #{cshRfndDvCd} /*현금환불구분코드*/
            , #{rfndAcDvCd} /*환불계좌구분코드*/
            , #{cshRfndFnitCd} /*현금환불금융기관코드*/
            , #{cshRfndAcnoEncr} /*현금환불계좌번호암호화*/
            , #{cshRfndAcownNm} /*현금환불계좌주명*/
            , #{cshRfndAdrsDvCd} /*현금환불수취인구분코드*/
            , #{cshRfndDlgpsNm} /*현금환불대표자명*/
            , #{cardRfndFnitCd} /*카드환불금융기관코드*/
            , #{cardRfndCrdcdAprStrtDt} /*카드환불신용카드승인시작일자*/
            , #{cardRfndCrdcdAprEndDt} /*카드환불신용카드승인종료일자*/
            , #{cardRfndCrcdnoEncr} /*카드환불신용카드번호암호화*/
            , #{cardRfndCrdcdIstmMcn} /*카드환불신용카드할부개월수*/
            , #{cardRfndCrcdonrNm} /*카드환불신용카드주명*/
            , #{cardRfndCrdcdAprno} /*카드환불신용카드승인번호*/
            , #{cardRfndCrdcdAprAmt} /*카드환불신용카드승인금액*/
            , #{cardRfndFee} /*카드환불수수료*/
            , #{cardRfndFer} /*카드환불수수료율*/
            , #{bltfRfndDvCd} /*전금환불구분코드*/
            , #{bltfRfndMbDvCd} /*전금환불회원구분코드*/
            , #{bltfOjCntrNo} /*전금대상계약번호*/
            , #{bltfOjCntrSn} /*전금대상계약일련번호*/
            , #{bltfBfVacNoEncr} /*전금이전가상계좌번호암호화*/
            , #{bltfAfVacNoEncr} /*전금이후가상계좌번호암호화*/
            , #{rfndAkAmt} /*환불요청금액*/
            , #{rfndDdtnAmt} /*환불공제금액*/
            , #{rfndRsonCd} /*환불사유코드*/
            , #{rfndRsonCn} /*환불사유내용*/
            , #{rfndExpAmt} /*환불예정금액*/
            , #{rfndFshDt} /*환불완료일자*/
            , #{rfndDsbAmt} /*환불지급금액*/
            , #{rfndDsbDuedt} /*환불지급예정일자*/
            , #{rfndPspDc} /*환불지연일수*/
            , #{rfndDsbPspInt} /*환불지급지연이자*/
            , #{rfndSlipCrtDt} /*환불전표생성일자*/
            , #{rfndSlpno} /*환불전표번호*/
            , #{mlgTpCd} /*마일리지유형코드*/
            , #{mlgRvNo} /*마일리지적립번호*/
            , #{rveNo} /*수납번호*/
            , #{pyAmt} /*납입금액*/
            , #{dlqAmt} /*연체금액*/
            , #{borAmt} /*위약금액*/
            , #{rfndEvidMtrFileId} /*환불증빙자료파일ID*/
             <include refid="COMMON.insertSystemFieldValue"/>
            )
    </update>

    <delete id="deleteRefundApplication">
        DELETE
          FROM TB_RVDW_RFND_RCP_BAS
         WHERE KW_GRP_CO_CD = '2000'
           AND RFND_RCP_NO = #{rfndRcpNo}
    </delete>

    <select id="selectRefundApplicationDetailPartner" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundApplicationDetailPartnerRes">
        SELECT
             (
               SELECT OPB.PRTNR_KNM
                 FROM TB_OGBS_PRTNR_BAS OPB
                WHERE OPB.DTA_DL_YN = 'N'
                  AND RRRB.RFND_RCP_PRTNR_NO = OPB.PRTNR_NO
             )  AS PRTNR_KNM                    /* 신청자 */
             , RRRB.RFND_RCP_PRTNR_NO           /* 번호 */
             , RRRB.RFND_RQDT                   /* 신청일시 */
             , RRRB.RFND_STAT_CD                /* 처리상태 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB        /* 환불접수기본 */
         WHERE RRRB.KW_GRP_CO_CD = '2000'
           AND RRRB.RFND_RCP_NO = #{rfndRcpNo}  /* 환불접수번호 */
    </select>

    <select id="selectRefundApplicationDetailContract" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$Ctract">
        SELECT
               SCB.CNTR_NO /* 계약번호 */
             , SCD.SELL_TP_CD /* 주문유형 */
             , CCB.CST_KNM /* 고객명 */
             , SCSIOI.ISTLL_KNM /* 설치자명 */
             , PPB.PD_NM /* 상품명 */
             , SCB.CNTR_CST_NO /* 고객번호 */
             , CCB.BRYY_MMDD /* 생년월일 */
             , SCSB.DP_TP_CD /* 이체구분 */
             , SCSB.MPY_BSDT /* 이체일 */
             , CONB.CTT_RS_CD /* 컨텍코드 */
             , CWSCB.RENTAL_AMT /* 렌탈(개월) */
             , CWSCB.RENTAL_PTRM /* 개월 */
             , SCD.ALNCMP_CD /* 제휴 */
             , CWSCB.RENTAL_RGST_COST /* 등록비용 */
             , SRASI.DUTY_USE_MCN /* 의무약정 */
             , SRASI.IST_DT /* 설치일자 */
             , CWCSCB.SL_DT /* 매출일자 (EDU 시, WELLS 테이블 다름) */
             , SCB.CNTR_CAN_DTM /* 취소일자 */
             , SCB.CNTR_CNFM_DTM /* 완료일자 */
          FROM TB_SSCT_CNTR_BAS SCB                     /* 계약기본 */
    INNER JOIN TB_SSCT_CNTR_DTL SCD                     /* 계약상세 */
            ON SCB.DTA_DL_YN = 'N'
           AND SCD.DTA_DL_YN = 'N'
           AND SCB.CNTR_NO = SCD.CNTR_NO                /* 계약번호 */
    INNER JOIN TB_CUBS_CST_BAS CCB                      /* 고객기본 */
            ON CCB.DTA_DL_YN = 'N'
           AND SCB.CNTR_CST_NO = CCB.CST_NO             /* 계약고객번호 = 고객번호 */
    INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ SCSIOI        /* 고객서비스AS설치대상내역 */
            ON SCSIOI.DTA_DL_YN = 'N'
           AND SCB.CNTR_NO = SCSIOI.CNTR_NO
           AND SCD.CNTR_SN = SCSIOI.CNTR_SN
  /* INNER JOIN TB_PDBS_PD_BAS PPB                  상품기본 */
     LEFT JOIN TB_PDBS_PD_BAS PPB                       /* 상품기본 */
            ON PPB.DTA_DL_YN = 'N'
           AND SCD.BASE_PD_CD = PPB.PD_CD
    INNER JOIN TB_SSCT_CNTR_STLM_BAS SCSB               /* 계약결제기본 */
            ON SCSB.DTA_DL_YN = 'N'
           AND SCB.CNTR_NO = SCSB.CNTR_NO
    INNER JOIN TB_SSOP_CTT_BAS CONB                      /* 컨텍기본 */
            ON SCB.DTA_DL_YN = 'N'
           AND CONB.CTT_OJ_ID = ( SELECT MAX(CTT_OJ_ID)
                                    FROM TB_SSOP_CTT_BAS
                                   WHERE CNTR_NO = #{cntrNo} ) /* 마지막 컨텍 번호 */
           AND SCB.CNTR_NO = CONB.CNTR_NO
     LEFT JOIN TB_CBCL_WELLS_SL_CNFM_BAS CWSCB          /* WELLS매출확정기본 */
            ON CWSCB.DTA_DL_YN = 'N'
           AND SCB.CNTR_NO = CWSCB.CNTR_NO
           AND SCD.CNTR_SN = CWSCB.CNTR_SN
     LEFT JOIN TB_SSCT_RENTAL_ADN_SV_IZ SRASI           /* 렌탈부가서비스내역 */
            ON SRASI.DTA_DL_YN = 'N'
           AND SCB.CNTR_NO = SRASI.CNTR_NO
           AND SCD.CNTR_SN = SRASI.CNTR_SN
     LEFT JOIN TB_CBCL_WELLS_CNTR_STAT_CH_BAS CWCSCB    /* WELLS계약상태변경기본 */
            ON CWCSCB.DTA_DL_YN = 'N'
           AND SCB.CNTR_NO = CWCSCB.CNTR_NO
           AND SCD.CNTR_SN = CWCSCB.CNTR_SN
         WHERE 1 = 1
           AND SCB.CNTR_NO = #{cntrNo}
           AND SCD.CNTR_SN = #{cntrSn}
    </select>

    <select id="selectRefundApplicationDetailPossible" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundApplicationDetailPossibleRes">
          WITH A12 AS
             (
                SELECT
                       NVL(SUM(RRD.DP_AMT), 0) AS DP_AMT  /* 총입금 누계금액, 입금누계금액 */
                  FROM TB_SSCT_CNTR_DTL SCD      /* 계약상세 */
            INNER JOIN TB_RVDW_RVE_DTL RRD      /* 수납상세 */
                    ON SCD.DTA_DL_YN = 'N'
                   AND RRD.DTA_DL_YN = 'N'
                   AND SCD.CNTR_NO = RRD.CNTR_NO
                   AND SCD.CNTR_SN = RRD.CNTR_SN
                 WHERE 1 = 1
                   AND RRD.DP_DV_CD = 1 /* 수납상세.입금구분코드 = 입금 */
                   AND SCD.CNTR_NO = #{cntrNo}
                   AND SCD.CNTR_SN = #{cntrSn}
             )
             , B1 AS
             (
                SELECT
                       NVL(CDB.THM_OC_DLQ_AMT, 0) AS THM_OC_DLQ_AMT      /* 전월 연체금액 */
                  FROM TB_SSCT_CNTR_DTL SCD     /* 계약상세 */
            INNER JOIN TB_CBCL_DLQ_BAS CDB      /* 연체기본 */
                    ON SCD.DTA_DL_YN = 'N'
                   AND CDB.DTA_DL_YN = 'N'
                   AND SCD.CNTR_NO = CDB.CNTR_NO
                   AND SCD.CNTR_SN = CDB.CNTR_SN
                 WHERE 1 = 1
                   AND CDB.PERF_YM = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM')        /* 연체기본.실적년월 = 현재월 - 1 (=전월) */
                   AND SCD.CNTR_NO = #{cntrNo}
                   AND SCD.CNTR_SN = #{cntrSn}
             )
             , A3 AS
             (
                SELECT
                       NVL(RRD.DP_AMT, 0) AS DP_AMT      /* 당월 선수금액 */
                  FROM TB_SSCT_CNTR_DTL SCD     /* 계약상세 */
            INNER JOIN TB_RVDW_RVE_DTL RRD      /* 수납상세 */
                    ON SCD.DTA_DL_YN = 'N'
                   AND RRD.DTA_DL_YN = 'N'
                   AND SCD.CNTR_NO = RRD.CNTR_NO
                   AND SCD.CNTR_SN = RRD.CNTR_SN
                 WHERE 1 = 1
                   AND RRD.DP_DT = TO_CHAR(SYSDATE, 'YYYYMM') /* 당월 */
                   AND RRD.DP_DV_CD = 1 /* 수납상세.입금구분코드 = 입금 */
                   AND RRD.RVE_DV_CD IN ( 97, 98 ) /* 수납상세.수납구분코 IN ( 영업선수, 기타선수) */
                   AND SCD.CNTR_NO = #{cntrNo}
                   AND SCD.CNTR_SN = #{cntrSn}
             )
             , B2 AS
             (
                SELECT
                       NVL(CDB.THM_OC_DLQ_AMT, 0) AS THM_OC_DLQ_AMT      /* 당월 연체금액 */
                  FROM TB_SSCT_CNTR_DTL SCD     /* 계약상세 */
            INNER JOIN TB_CBCL_DLQ_BAS CDB      /* 연체기본 */
                    ON SCD.DTA_DL_YN = 'N'
                   AND CDB.DTA_DL_YN = 'N'
                   AND SCD.CNTR_NO = CDB.CNTR_NO
                   AND SCD.CNTR_SN = CDB.CNTR_SN
                 WHERE 1 = 1
                   AND CDB.PERF_YM = TO_CHAR(SYSDATE, 'YYYYMM')        /* 연체기본.실적년월 = 현재월 */
                   AND SCD.CNTR_NO = #{cntrNo}
                   AND SCD.CNTR_SN = #{cntrSn}
             )
             , A4 AS
             (
                SELECT
                       NVL(RRD.DP_AMT, 0) AS DP_AMT      /* 당월 입금액 */
                  FROM TB_SSCT_CNTR_DTL SCD     /* 계약상세 */
            INNER JOIN TB_RVDW_RVE_DTL RRD      /* 수납상세 */
                    ON SCD.DTA_DL_YN = 'N'
                   AND RRD.DTA_DL_YN = 'N'
                   AND SCD.CNTR_NO = RRD.CNTR_NO
                   AND SCD.CNTR_SN = RRD.CNTR_SN
                 WHERE 1 = 1
                   AND RRD.DP_DT = TO_CHAR(SYSDATE, 'YYYYMM') /* 당월 */
                   AND RRD.DP_DV_CD = 1 /* 수납상세.입금구분코드 = 입금 */
                   AND SCD.CNTR_NO = #{cntrNo}
                   AND SCD.CNTR_SN = #{cntrSn}
             )
             , C1 AS
             (
                SELECT NVL( A4.DP_AMT - B1.THM_OC_DLQ_AMT, 0) AS ABL_AMT /* 환불가능금액 */
                  FROM A4
             FULL JOIN B1
                    ON 1 = 1
             )
        SELECT
               NVL(A12.DP_AMT, 0) AS DP_AGG_AMT /* 총입금 누계금액, 입금누계금액 */
             , NVL(A12.DP_AMT, 0) AS DP_AGG_AMT2 /* 총입금 누계금액, 입금누계금액 */
             , NVL(B1.THM_OC_DLQ_AMT, 0) AS LSTMM_DLQ_AMT /* 전월 연체금액 */
             , NVL(A3.DP_AMT, 0) AS THM_PRPD_AMT /* 당월 선수금액 */
             , NVL(B2.THM_OC_DLQ_AMT, 0) AS THM_DLQ_AMT /* 당월 연체금액 */
             , NVL(A4.DP_AMT, 0) AS THM_DP_AMT /* 당월 입금액 */
             , NVL(C1.ABL_AMT, 0) AS RFND_PSB_AMT /* 환불가능금액 */
          FROM A12
     FULL JOIN B1
            ON 1 = 1
     FULL JOIN A3
            ON 1 = 1
     FULL JOIN B2
            ON 1 = 1
     FULL JOIN A4
            ON 1 = 1
     FULL JOIN C1
            ON 1 = 1
    </select>


    <select id="selectRefundApplicationDetailDeposit" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundApplicationDetailDepositRes">
        SELECT
               RRD.RVE_SN /* 입금일련번호 */
             , RRD.DP_DT /* 입금일자 */
             , RRD.PERF_DT /* 실적일자 */
             , RRRB.RFND_FSH_DT /* 지급일자 */
             , RRD.DP_DV_CD /* 입금구분 */
             , RRD.DP_AMT /* 처리금액 */
             , RRD.DP_TP_CD /* 입금유형 */
              /* 카드현금구분 */
             , CASE WHEN RRD.DP_TP_CD LIKE '01%' THEN '01'
                    WHEN RRD.DP_TP_CD LIKE '02%' THEN '02'
                    ELSE ''
                END AS CSH_CRD
             , ( SELECT RFC.FNIT_NM /* 금융기관명 */
                   FROM TB_RVDW_FNIT_CD RFC/* 금융기관코드 */
                  WHERE RFC.FNIT_CD = RIDB.FNIT_CD
             )  AS FNIT_NM /* 카드사, 은행 */
             , RIDB.CRCDNO_ENCR /* 카드번호 */
             , RIDB.CRDCD_APRNO /* 승인번호 */
             , RIDB.CRDCD_ISTM_MCN /* 할부개월수 */
             , RIDB.ACNO_ENCR /* 계좌번호 */
             , RIDB.DPR_NM /* 입금자 */
          FROM TB_SSCT_CNTR_DTL SCD     /* 계약상세 */
          JOIN TB_RVDW_RVE_DTL RRD      /* 수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND SCD.CNTR_NO = RRD.CNTR_NO
           AND SCD.CNTR_SN = RRD.CNTR_SN
          JOIN TB_RVDW_RFND_RCP_BAS RRRB /* 환불접수기본 */
            ON RRRB.DTA_DL_YN = 'N'
           AND SCD.CNTR_NO = RRRB.CNTR_NO
           AND SCD.CNTR_SN = RRRB.CNTR_SN
          JOIN TB_RVDW_ITG_DP_BAS RIDB  /* 통합입금기본 */
            ON RIDB.DTA_DL_YN = 'N'
           AND RRD.ITG_DP_NO = RIDB.ITG_DP_NO
         WHERE 1 = 1
           AND SCD.CNTR_NO = #{cntrNo}
           AND SCD.CNTR_SN = #{cntrSn}
    </select>

    <select id="selectRefundApplicationDetailPerformance" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundApplicationDetailPerformanceRes">
        SELECT
               CWSMCI.CNTR_NO /* 계약번호 */
             , CWSMCI.SL_STP_YN /* 매출중지 */
             , CWSMCI.SL_CL_YM /* 매출년월 */
             , '' AS tmp1  /* 리스차월 */
             , CWSMCI.NOM_SL_AMT /* 청구금액 */
             , CWBAB.BOR_AMT /* 위약금액 */
             , CWSMCI.FNN_LEASE_PCAM_TAM /* 리스입금액 */
             , CWSMCI.PRPD_SL_AMT /* 선수금액 */
             , CWSMCI.TOT_PCAM_UC_AMT /* 미수금액 */
             , CDB.THM_DLQ_RFND_SUM_AMT /* 연체금액 */
             , CDB.DLQ_MCN /* 연체개월 */
             , CDB.BTD_DLQ_AMT /* 기초금액 */
             , CDB.THM_OC_DLQ_AMT /* 발생금액 */
             , '' AS tmp2 /* 공제금액 */
             , CWSMCI.THM_ISTM_TOT_DP_AMT /* 입금액 */
             , CWSMCI.THM_ISTM_RFND_AMT /* 환불금액 */
             , CWSMCI.EOT_PCAM_BLAM /* 기말금액 */
          FROM TB_SSCT_CNTR_DTL SCD     /* 계약상세 */
          JOIN TB_CBCL_WELLS_SL_MM_CL_IZ CWSMCI      /* WELLS매출월마감내역 */
            ON SCD.DTA_DL_YN = 'N'
           AND CWSMCI.DTA_DL_YN = 'N'
           AND SCD.CNTR_NO = CWSMCI.CNTR_NO
           AND SCD.CNTR_SN = CWSMCI.CNTR_SN
         LEFT JOIN TB_CBCL_WELLS_BOR_AMT_BAS CWBAB      /* WELLS위약금액기본 */
            ON CWBAB.DTA_DL_YN = 'N'
           AND CWSMCI.SL_CL_YM = CWBAB.PERF_YM  /* 매출마감년월 = 실적년월 */
           AND CWSMCI.CNTR_NO = CWBAB.CNTR_NO
           AND CWSMCI.CNTR_SN = CWBAB.CNTR_SN
          JOIN TB_CBCL_DLQ_BAS CDB                    /* 연체기본 */
            ON CDB.DTA_DL_YN= 'N'
           AND CWSMCI.SL_CL_YM = CDB.PERF_YM  /* 매출마감년월 = 실적년월 */
           AND CWSMCI.CNTR_NO = CDB.CNTR_NO
           AND CWSMCI.CNTR_SN = CDB.CNTR_SN
         WHERE 1 = 1
           AND SCD.CNTR_NO = #{cntrNo}
           AND SCD.CNTR_SN = #{cntrSn}
    </select>

    <select id="selectRefundApplicationDetailApplication" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$App">
        SELECT
               RRRD.RFND_RCP_NO
             , RRRD.RFND_RCP_DTL_SN
             , RRRD.RFND_DSB_DV_CD                              /* 환불구분 */
             , CASE WHEN RRRD.RFND_DSB_DV_CD = '01' THEN ( CASE WHEN RRRD.CSH_RFND_DV_CD = '01' THEN '5'       /* 5. 선환불 */
                                                                WHEN RRRD.CSH_RFND_DV_CD = '02' THEN '4'     /* 4. 현금환불 */
                                                                WHEN RRRD.CSH_RFND_DV_CD = '03' THEN '6'     /* 6. 카드현금 */
                                                            END
                                                         )
                    WHEN RRRD.RFND_DSB_DV_CD = '02' THEN '3'                                                 /* 3. 카드환불 */
                    WHEN RRRD.RFND_DSB_DV_CD = '03' THEN ( CASE WHEN RRRD.BLTF_RFND_DV_CD = '01' THEN '2'    /* 2. 현금전금 */
                                                                WHEN RRRD.BLTF_RFND_DV_CD = '02' THEN '1'    /* 1. 카드전금 */
                                                            END
                                                         )
                END AS RFND_DSB_DV_CD_CSH_BLTF                  /* 전금구분 */

             , RRRD.BLTF_RFND_MB_DV_CD                          /* 전금환불회원구분코드 *//* 회원구분 */
             , PPB.PD_NM                                        /* 상품명 *//* 상품 */
             , RRRD.BLTF_BF_VAC_NO_ENCR                         /* 전금이전가상계좌번호암호화 *//* 전금전 가상계좌 */
             , RRRD.BLTF_AF_VAC_NO_ENCR                         /* 전금이후가상계좌번호암호화 *//* 전금후 가상계좌 */
             , RRRD.RFND_AK_AMT                                 /* 환불요청금액 *//* 전금 요청금액(원) */
             , RRRD.RFND_RSON_CN                                /* 전금사유 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB                        /* 환불접수기본 */
          JOIN TB_RVDW_RFND_RCP_DTL RRRD                        /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N'
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD            /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO              /* 환불접수번호 */
          JOIN TB_SSCT_CNTR_DTL SCD                             /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 = 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약상세번호 = 계약상세번호 */
          JOIN TB_PDBS_PD_BAS PPB                       /* 상품기본 */
            ON PPB.DTA_DL_YN = 'N'
           AND SCD.BASE_PD_CD = PPB.PD_CD
         WHERE 1 = 1
           AND RRRD.RFND_RCP_NO = #{rfndRcpNo}
           AND RRRD.RFND_RCP_DTL_SN = #{rfndRcpDtlSn}
    </select>

    <select id="selectRefundApplicationDetailReceipt" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundApplicationDetailReceiptRes">
        SELECT
               RRRB.RFND_RCP_NO
             , RRRB.RFND_CSH_AMT /* 현금 환불금액 */
             , RRRB.RFND_CARD_AMT /* 카드 환불금액 */
             , RRRB.RFND_BLTF_AMT /* 전금금액 */
             , RRRB.RFND_PSB_RES_AMT /* 환불가능 잔액 */
             , RRRB.TOT_RFND_ET_AMT /* 총 환불 예상금액 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
         WHERE RRRB.DTA_DL_YN = 'N'
           AND RRRB.KW_GRP_CO_CD = '2000'   /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = #{rfndRcpNo}          /* 환불접수번호 */
    </select>


    <select id="selectRefundApplicationDetailInfo2" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$RefundDetail">
        SELECT
               RRRD.RFND_RCP_NO
             , RRRD.RFND_RCP_DTL_SN
             , RRRD.RVE_NO /* 수납상세.수납번호 */
             , RRRD.RFND_DV_CD /* 환불구분 01.전체환불, 02.부분환불*/
             , RRRD.RFND_DSB_DV_CD /* (상세)환불구분(현금환불, 카드환불, 전금) */
             , RRRD.CSH_RFND_DV_CD /* 현금환불구분(선환불, 일반환불, 카드현금) */
             , RRRD.RFND_AC_DV_CD /* 환불계좌구분(기입금계좌, 신규계좌) */
             , RRRD.CSH_RFND_FNIT_CD /* 은행사코드 */
             , RRRD.CSH_RFND_ACNO_ENCR /* 계좌번호 */
             , RRRD.CSH_RFND_ACOWN_NM /* 예금주 */
             , RRRD.CSH_RFND_ADRS_DV_CD /* 수취인 코드(본인,가족,실입금자, 제3자, 대표자) */
             , RRRD.CSH_RFND_DLGPS_NM /* 대표자 확인 */
             , RRRD.RFND_AK_AMT /* 환불 신청금액/전금요청금액 */
             , RRRD.RFND_DSB_AMT /* 실지급액 */
             , RRRD.RFND_RSON_CD /* 환불사유 코드 */
             , RRRD.CARD_RFND_FNIT_CD /* 카드사코드 */
             , RRRD.CARD_RFND_CRCDNO_ENCR /* 카드번호 */
             , RRRD.CARD_RFND_FER /* 카드공제액(%) */
             , RRRD.RFND_RSON_CN /* 환불/전금 사유 */
             , RRRD.CARD_RFND_CRDCD_APR_STRT_DT AS START_DAY /* 승인(시작)일 */
             , RRRD.CARD_RFND_CRDCD_APR_END_DT AS END_DAY /* 승인(종료)일 */
             , RRRD.BLTF_RFND_DV_CD /* 전금구분(현금전금, 카드전금) */
             , RRRD.BLTF_RFND_MB_DV_CD /* 회원구분(교원키 동일회원, 제3자 회원) */
             , RRRD.BLTF_OJ_CNTR_SN /* (전금할)고객번호2 */
             , RRRD.BLTF_BF_VAC_NO_ENCR /* 전금전 가상계좌 */
             , RRRD.BLTF_AF_VAC_NO_ENCR /* 전금후 가상계좌 */
             , RRRD.RFND_EVID_MTR_FILE_ID /* 증빙자료 파일명 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
         INNER JOIN TB_RVDW_RFND_RCP_DTL RRRD           /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N'
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
         WHERE RRRB.KW_GRP_CO_CD = '2000'               /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = #{rfndRcpNo}          /* 환불접수번호 */
           AND RRRD.RFND_RCP_DTL_SN = #{rfndRcpDtlSn}
    </select>

    <select id="selectRefundApplicationConnectHistory" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundApplicationConnectHistoryRes">
        SELECT CTT_RCP_DTM              /* 컨택일시 */
             , CTT_CHNL_TP_CD           /* 상담경로 */
             , ( SELECT PRTNR_KNM
                   FROM TB_OGBS_PRTNR_BAS
                  WHERE PRTNR_NO = CTT_PSIC_ID
               ) AS PRTNR_KNM              /* 상담자 */
             , CTT_PSIC_ID              /* 번호 */
             , CTT_MO_CN                /* 상담내용 */
          FROM TB_SSOP_CTT_BAS          /* 컨택기본 */
         WHERE CNTR_NO = #{cntrNo}      /* 계약번호*/
    </select>
</mapper>
