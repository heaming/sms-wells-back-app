<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.idvrve.mapper.WwdbRefundApplicationMapper">

    <select id="selectRefundApplication" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundApplicationRes">
        SELECT /*+ push_pred(M2) use_nl(M2) */
               RRAB.RFND_AK_STAT_CD /* 환불상태 */
             , F_CMZ_MLNG_NM(#{session.tenantId}, 'MSG_TXT_DTL', #{session.langId}) AS RFND_AK_DTL_CD /* 환불상세 */
             , TO_CHAR(TO_DATE(RRAB.RFND_AK_DTM, 'YYYYMMDD HH24MISS'), 'YYYYMMDD') AS RFND_AK_DTM /* 접수일자 */
             , RRAB.RFND_AK_NO /* 접수번호 */
             , NVL(M2.RFND_ALLOW_AMT , 0 ) - NVL(M2.FREE_AMT , 0) AS RFND_PSB_AMT/* 환불가능금액 */
             , NVL(RRAD.RFND_CSH_AK_AMT,0) + NVL(RRAD.RFND_CARD_AK_AMT,0) + NVL(RRAD.RFND_BLTF_AK_AMT,0) AS RFND_AK_AMT
             , RRAD.CNTR_NO /* 계약기본 */
             , RRAD.CNTR_SN /* 계약상세 */
             , RRAD.CNTR_NO || RRAD.CNTR_SN AS CNTR_DTL_NO /* 계약상세번호 */
             , NVL(RRAD.RFND_CSH_AK_AMT, 0) + NVL(RRAD.CRDCD_FEE_AMT, 0) AS RFND_CSH_AK_AMT /* 현금환불금액 */
             , NVL(RRAD.RFND_CARD_AK_AMT, 0) AS RFND_CARD_AK_AMT/* 카드환불금액 */
             , NVL(RRAD.CRDCD_FEE_AMT, 0) AS CRDCD_FEE_AMT  /* 카드수수료 */
             , NVL(RRAD.RFND_BLTF_AK_AMT, 0) AS RFND_BLTF_AK_AMT /* 전금금액 */
             , F_CMZ_USR_NM(RRAD.FNL_MDFC_USR_ID) AS FNL_MDFC_USR_NM /* 신청자 */
             , RRAD.FNL_MDFC_USR_ID /* 번호 */
             , CASE WHEN RRAB.RFND_PROCS_DV_CD = '03'
                    THEN RFND_RVE_DT
                     END AS RFND_FSH_DT/* 승인일자 */
             , RRAB.RFND_PROCS_CN /* 처리내용 */
             , RRAD.RFND_RSON_CD /* 환불사유 */
             , RRAD.RFND_RSON_CN /* 환불내용 */
             , '' AS RFND_EVID_MTR_FILE_ID /* 첨부파일:환불증빙자료파일 */
             , RRAD.CST_NO
          FROM TB_RVDW_RFND_AK_BAS RRAB -- 환불요청기본
         INNER JOIN TB_RVDW_RFND_AK_DTL RRAD -- 환불요청상세
            ON RRAD.RFND_AK_NO = RRAB.RFND_AK_NO
           AND RRAD.DTA_DL_YN = 'N'
           AND RRAD.KW_GRP_CO_CD = RRAB.KW_GRP_CO_CD
<!--         INNER JOIN TB_RVDW_RFND_AK_CNTR_DTL RRACD &#45;&#45; 환불요청계약상세-->
<!--            ON RRACD.RFND_AK_NO = RRAD.RFND_AK_NO-->
<!--           AND RRACD.DTA_DL_YN = 'N'-->
          LEFT JOIN ( SELECT
                             RRD.CNTR_NO
                           , RRD.CNTR_SN
                           , RRD.CST_NO
                           , RRD.RVE_NO
                           , RRD.RVE_SN
                           , NVL(RRD.DP_AMT,0) AS DP_AMT /* 입금액 */
                           , NVL(CBCB.DLQ_ADD_AMT,0) AS DLQ_ADD_AMT  /* 연체가산금 */
                           , NVL(SCD.MM_ISTM_AMT,0) AS MM_ISTM_AMT /* 월 납부금(월 납입금) */
                           ,  NVL(CBCB.RSG_BOR_AMT,0) AS BOR_AMT /* 위약금 */
                           , (SELECT
                                     NVL(MAX(S9.SV_AMT),0)
                                FROM TB_CBCL_WELLS_SL_MM_CL_IZ S9
                               WHERE 1 = 1
                                 AND S9.CNTR_NO = SCD.CNTR_NO
                                 AND S9.CNTR_SN = SCD.CNTR_SN
                                 AND S9.DTA_DL_YN = 'N'
                              ) AS SV_AMT /* 서비스금액 */
                        FROM TB_RVDW_RVE_DTL RRD /* 수납상세 */
                       INNER JOIN TB_SSCT_CNTR_DTL SCD /* 계약상세 */
                          ON SCD.CNTR_NO = RRD.CNTR_NO
                         AND SCD.CNTR_SN = RRD.CNTR_SN
                         AND SCD.DTA_DL_YN = 'N'
                        LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS CBCB /*채권계약기본*/
                         ON CBCB.CNTR_NO = SCD.CNTR_NO
                        AND CBCB.CNTR_SN = SCD.CNTR_SN
                        AND CBCB.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
                        AND CBCB.DTA_DL_YN = 'N'
                      WHERE 1 = 1
                        AND RRD.DTA_DL_YN = 'N'
                        AND RRD.KW_GRP_CO_CD = #{session.companyCode}
                    ) T1
            ON RRAD.CNTR_NO = T1.CNTR_NO
           AND RRAD.CNTR_SN = T1.CNTR_SN
           AND RRAD.RVE_NO = T1.RVE_NO
           AND RRAD.RVE_SN = T1.RVE_SN
        LEFT OUTER JOIN ( <![CDATA[
                                    SELECT CNTR_NO
                                         , CNTR_SN
                                         , CNTR_CST_NO
                                          /*만약 계약입금액이 0보다 클경우*/
                                         ,CASE WHEN SELL_TP_CD = '1' THEN (CASE WHEN GAMT1 > 0 THEN /*상품시작일자가 있고 환불가능금액이 0 일경우 0*/
                                                                                                      CASE WHEN CNTR_PD_STRTDT IS NOT NULL AND RFND_ALLOW_AMT = 0 THEN 0
                                                                                                      /*아니면 계약금*/
                                                                                                           ELSE RFND_ALLOW_AMT
                                                                                                            END
                                                                                ELSE 0
                                                                       END)
                                                                       +
                                                                      (CASE WHEN NVL(SUMINCW51 , 0) - NVL(MM_ISTM_AMT ,0) > 0 THEN NVL(SUMINCW51 , 0) - NVL(MM_ISTM_AMT ,0)
                                                                            ELSE 0
                                                                        END)
                                                                       +
                                                                       NVL(SUMINCW52, 0)
                                            ELSE 	RFND_ALLOW_AMT
                                             END AS RFND_ALLOW_AMT
                                          , FREE_AMT
                                     FROM (
                                            SELECT /*+ push_pred(T6) */
                                                     T1.CNTR_NO
                                                   , T1.CNTR_SN
                                                   , T11.CNTR_CST_NO
                                                   , T1.MM_ISTM_AMT
                                                   , T1.SELL_TP_CD
                                                   /*일시불 환불가능금액*/
                                                    /*
                                                     * 일시불 환불금 조회 로직 순서
                                                     *
                                                     * 1) 예정일,매출일이 없는 경우 => 계약금액 전체 환불
                                                     * 2) 예정일 & 매출일이 있는경우
                                                     *   2-1) 상품변경등록 => 계약금액 전체 환불
                                                     *   2-2) 법인미수금계약 법인미수금 환불액 => 법인미수금 입금 초과금액 [법인미수금 입금합계 - 법인미수금계약금액]
                                                     */
                                                   , CASE WHEN T1.SELL_TP_CD = '1' THEN CASE WHEN T1.SPP_DUEDT IS NULL AND T1.CNTR_PD_STRTDT IS NULL THEN CASE WHEN NVL(T1.CNTR_AMT , 0 ) != 0 THEN NVL(T1.CNTR_AMT,0) + NVL(T1.CRP_UC_AMT ,0)
                                                                                                                                                               ELSE 0
                                                                                                                                                                END
                                                                               /* 2) 예정일 & 매출일이 있는경우 2-1) 상품변경등록 => 계약금액 전체 환불
                                                                                                     WHEN T1.SPP_DUEDT IS NOT NULL AND T1.CNTR_PD_STRTDT IS NOT NULL THEN T4.AMT2  */
                                                                               /*   2-2) 법인미수 초과금액*/
                                                                                    ELSE T4.GAMT2 - T1.CNTR_AMT
                                                                                     END
                                                   /*
                                                     * 렌탈 금융리스 환불금 조회 로직 순서
                                                     *
                                                     * 1.완료일 설정된 경우 => 총입금누계 - 입금대체누계 - 총가산입금액 - 등록비용(등록-할인) - 위약금액 - 소모품비
                                                     * 2.취소일 설정된 경우 => 마지막달의 선수금- 현재월 연체금
                                                     * 3.매출중지인 경우 (금융리스는 매출중지가 없으므로 L20 (렌탈) 만 조회
                                                     *   3-1)이번달 연체금액이 없으면 (선수금액 - 렌탈매출액)
                                                     *   3-2)이번달 연체금액이 있으면 (연체금액 + 매출중지액)
                                                     * 5. 선납인 경우
                                                     *   5-1)선납이 살아있는 경우
                                                     *     5-1-1)선납년월과 조회년월이 다른경우 => 환불 가능액 = 선수잔액
                                                     *     5-1-2)선납년월과 조회년월이 같은 경우 => 환불 가능액 = 선수총액 + 매출금액
                                                     *   5-2)선납이 중지된 경우 => 당월선수금 - 당월 발생 추가 매출액 = 환불 가능액
                                                     * 6. 그 외
                                                     *   6-1) 전월 선수금이 있는 경우
                                                     *     6-1-1) 당월매출액이 음수인 경우 => 전월 선수금액 + 당월 입금액 - 당월매출액
                                                     *     6-1-2) 그외 => 전월 선수금액+당월 입금액
                                                     *   6-2) 그 외
                                                     *     6-2-1) 당월매출액이 음수인 경우 => 당월 입금액 - 전월 연체금액 - 당월매출액
                                                     *     6-2-2) 그외 => 당월 입금액 - 전월 연체금액 */
                                                                                            /* 1.완료일 설정된 경우 => 총입금누계 - 입금대체누계 - 총가산입금액 - 등록비용(등록-할인) - 위약금액 - 소모품비 */
                                                           WHEN T1.SELL_TP_CD = '2' THEN CASE WHEN T2.FULPY_DT > 0 THEN NVL(T4.AMT1 , 0) - NVL(T2.SL_DP_AGG_AMT , 0) - NVL(T4.AM83 , 0) - NVL(T1.CNTR_AMT,0) -  NVL(T3.BOR_AMT,0) - NVL(T3.CSMB_COST_BOR_AMT2,0)
                                                                                       /* 2.취소일 설정된 경우 => 마지막달의 선수금- 현재월 연체금 */
                                                                                              WHEN T2.CAN_DT IS NOT NULL THEN (NVL(T2.EOT_ATAM,0) + NVL(T2.MLG_EOT_PRPD_AMT,0)) - NVL(T5.EOT_DLQ_AMT ,0)
                                                                                       /* 3.매출중지인 경우 (금융리스는 매출중지가 없으므로 L20 (렌탈) 만 조회
                                                                                       *   3-1)이번달 연체금액이 없으면 (선수금액 - 렌탈매출액) */
                                                                                              WHEN T1.SELL_TP_DTL_CD NOT IN ('22' , '24') AND NVL(T2.SL_STP_YN , 'N' ) = 'Y' AND NVL(T5.EOT_DLQ_AMT,0) = 0  THEN NVL(T5.EOT_ATAM, 0) + NVL(T5.MLG_EOT_PRPD_AMT , 0) - NVL(T5.AM16 , 0)
                                                                                       /*   3-2)이번달 연체금액이 있으면 (연체금액 + 매출중지액) */
                                                                                              WHEN T1.SELL_TP_DTL_CD NOT IN ('22' , '24') AND NVL(T2.SL_STP_YN , 'N' ) = 'Y' AND NVL(T5.EOT_DLQ_AMT,0) != 0 THEN NVL(T5.EOT_DLQ_AMT , 0)- NVL(T5.AM16 , 0)
                                                                                       /* 5. 선납인 경우
                                                                                                 *   5-1)선납이 살아있는 경우
                                                                                                 *     5-1-1)선납년월과 조회년월이 다른경우 => 환불 가능액 = 선수잔액 */
                                                                                              WHEN NVL(T5.PRPMYN,'N') = 'Y' AND NVL(T5.PRPMSTYN,'N') != 'Y' THEN NVL(T5.EOT_ATAM,0) - NVL(T5.PRM_BLAM_EOT_AMT,0)
                                                                                       /*     5-1-2)선납년월과 조회년월이 같은 경우 => 환불 가능액 = 선수총액 + 매출금액 */
                                                                                              WHEN NVL(T5.PRPMYN,'N') = 'Y' AND NVL(T5.PRPMSTYN,'N') = 'Y' THEN NVL(T5.EOT_ATAM,0) + NVL(T5.MLG_EOT_PRPD_AMT , 0) + NVL(T5.AM16 , 0)
                                                                                       /*   5-2)선납이 중지된 경우 => 당월선수금 - 당월 발생 추가 매출액 = 환불 가능액 */
                                                                                              WHEN T6.PRM_END_YM > TO_CHAR(SYSDATE , 'YYYYMMDD') AND T5.PRM_END_YM IS NULL THEN NVL(T5.EOT_ATAM,0) + NVL(T5.MLG_EOT_PRPD_AMT , 0)
                                                                                              /* 6. 그 외
                                                                                                 *   6-1) 전월 선수금이 있는 경우
                                                                                                 *     6-1-1) 당월매출액이 음수인 경우 => 전월 선수금액 + 당월 입금액 - 당월매출액 */
                                                                                              WHEN NVL(T6.EOT_ATAM,0) + NVL(T6.MLG_EOT_PRPD_AMT,0) > 0 AND NVL(T5.AM16,0) < 0 THEN NVL(T6.EOT_ATAM,0) + NVL(T6.MLG_EOT_PRPD_AMT,0) + NVL(T5.IAMT,0) - NVL(T5.AM16,0)

                                                                                            /*     6-1-2) 그외 => 전월 선수금액+당월 입금액 */
                                                                                              WHEN NVL(T6.EOT_ATAM,0) + NVL(T6.MLG_EOT_PRPD_AMT,0) > 0 THEN NVL(T6.EOT_ATAM,0) + NVL(T6.MLG_EOT_PRPD_AMT,0) + NVL(T5.IAMT,0)
                                                                                            /*   6-2) 그 외
                                                                                             *     6-2-1) 당월매출액이 음수인 경우 => 당월 입금액 - 전월 연체금액 - 당월매출액
                                                                                             *     6-2-2) 그외 => 당월 입금액 - 전월 연체금액 */
                                                                                              WHEN NVL(T5.AM16,0) < 0 THEN NVL(T5.IAMT,0) - NVL(T6.EOT_DLQ_AMT,0) - NVL(T5.AM16,0)
                                                                                              ELSE NVL(T5.IAMT,0) - NVL(T6.EOT_DLQ_AMT,0)
                                                                                               END
                                                    /*
                                                     * 멤버십, 홈케어멤버십 환불금 조회 로직 순서
                                                     *
                                                     * ********** 마지막 매출 정보가 있는 경우에만 환불금액 조회 가능 **********
                                                     *
                                                     * 1. 완료일자가 있는 경우 => 총입금누계 - 입금대체누계 - 총가산입금액 - 필터공제 = 환불 가능금액(선수금)
                                                     * 2. 탈퇴일자가 있는 경우 => 환불가능금액 (이번달 선수금)
                                                     * 3. 전월 선수금이 있는 경우 => 전월 선수금액+당월 입금액
                                                     * 4. 그 이외 => 당월 입금액 - 전월 연체금액
                                                     */
                                                                                            /* 1. 완료일자가 있는 경우 => 총입금누계 - 입금누계 - 총가산입금액 - 필터공제 = 환불 가능금액(선수금) */
                                                          WHEN T1.SELL_TP_CD = '3' THEN CASE WHEN NVL(T2.FULPY_DT,0) > 0 THEN NVL(T4.AMT1,0) - NVL(T2.SL_DP_AGG_AMT,0) - NVL(T4.AM83,0) - NVL(T3.FILT_DDCTAM ,0) --> TB_SSCT_CNTR_RSG_PROCS_IZ.FILT_DDCTAM (필터공제금액)
                                                                                            /* 2. 탈퇴일자가 있는 경우 => 환불가능금액 (이번달 선수금) */
                                                                                             WHEN NVL(T2.CAN_DT,0) > 0 THEN NVL(T5.EOT_ATAM,0)
                                                                                            /* 3. 전월 선수금이 있는 경우 => 전월 선수금액+당월 입금액 */
                                                                                             WHEN NVL(T6.EOT_ATAM,0) > 0 THEN NVL(T6.EOT_ATAM,0) + NVL(T5.IAMT,0)
                                                                                            /* 4. 그 이외 => 당월 입금액 - 전월 연체금액*/
                                                                                             ELSE NVL(T5.IAMT,0) - NVL(T6.EOT_DLQ_AMT,0)
                                                                                              END
                                                                                              /* 1. 취소인 경우
                                                                                             *   1-1) 연체가 있는 경우 => 이번달 선수금 - 이번달 연체금액 */
                                                          WHEN T1.SELL_TP_CD = '6' THEN CASE  WHEN NVL(T2.CAN_DT,0) > 0 AND NVL(T2.FULPY_DT,0) = 0 AND NVL(T5.THM_BIL_SPMT_AMT,0) > 0 THEN NVL(T5.EOT_ATAM,0) - NVL(T5.THM_BIL_SPMT_AMT,0)
                                                                                            /*   1-2) 연체가 없는 경우 => 이번달 선수금 */
                                                                                              WHEN NVL(T2.CAN_DT,0) > 0 AND NVL(T2.FULPY_DT,0) = 0 THEN NVL(T5.EOT_ATAM,0)
                                                                                            /* 2. 전월 선수금이 있는 경우 => 전월 선수금액+당월 입금액 */
                                                                                              WHEN NVL(T6.EOT_ATAM,0) > 0 THEN NVL(T6.EOT_ATAM,0) + NVL(T5.IAMT,0)
                                                                                            /* 3. 그 이외 => 당월 입금액 - 전월 연체금액 */
                                                                                              ELSE NVL(T5.IAMT,0) - NVL(T6.THM_BIL_SPMT_AMT,0)
                                                                                               END

                                                           END 	AS RFND_ALLOW_AMT /*환불가능금액*/
                                                   , T4.GAMT1 /*계약금*/
                --		                           , T4.SUMINMIN /*손료*/
                                                   , T4.SUMINCW51 /*할부금*/
                                                   , T4.SUMINCW52 /*선수금*/
                                                   , T1.SPP_DUEDT /*배송예정일*/
                                                   , T1.CNTR_PD_STRTDT /*상품시작일자*/
                                                   , NVL(T4.FREE_AMT,0) AS FREE_AMT
                                                FROM TB_SSCT_CNTR_DTL T1
                                               INNER JOIN TB_SSCT_CNTR_BAS T11
                                                  ON (    T11.CNTR_NO = T1.CNTR_NO
                                                      AND T11.DTA_DL_YN = 'N')
                                               INNER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ T2  --매출실적_최종월기준
                                                  ON (    T2.CNTR_NO = T1.CNTR_NO
                                                      AND T2.CNTR_SN = T1.CNTR_SN
                                                      AND T2.DTA_DL_YN = 'N'
                                                      AND T2.SL_CL_YM =
                                                      (
                                                                        SELECT MAX(S1.SL_CL_YM)
                                                                           FROM TB_CBCL_WELLS_SL_MM_CL_IZ S1
                                                                          WHERE 1 = 1
                                                                            AND S1.CNTR_NO = T1.CNTR_NO
                                                                            AND S1.CNTR_SN = T1.CNTR_SN
                                                                            AND S1.DTA_DL_YN = 'N')

                                                                            )
                                               LEFT OUTER JOIN TB_SSCT_CNTR_RSG_PROCS_IZ T3 /*계약해지처리내역*/
                                                 ON (    T3.CNTR_NO = T1.CNTR_NO
                                                     AND T3.CNTR_SN = T1.CNTR_SN
                                                     AND T3.DTA_DL_YN = 'N')
                                                LEFT OUTER JOIN LATERAL( SELECT SUM(CASE WHEN S1.RVE_DV_CD = '02' AND S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                         ELSE 0
                                                                                          END ) AS AM83 /*총가산금 입금액*/
                                                                              , SUM(CASE WHEN S1.DP_DV_CD IN ('1' , '3') THEN RVE_AMT
                                                                                         ELSE 0
                                                                                          END ) AS AMT1 --입금누계
                                                                              , SUM(CASE WHEN S1.RVE_DV_CD = '01' AND  S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                          ELSE -S1.RVE_AMT
                                                                                           END ) AS AMT2  --계약금 입금누계
                                                                              , SUM( CASE WHEN S1.RVE_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                          WHEN S1.RVE_DV_CD IN ('2' , '4') THEN -S1.RVE_AMT
                                                                                          ELSE 0  --계약금 미수금액
                                                                                           END ) AS GAMT1
                                                                              , SUM( CASE WHEN S1.RVE_DV_CD = '01'  AND S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                          WHEN S1.RVE_DV_CD = '01'  AND S1.DP_DV_CD IN ('2' , '4') THEN -S1.RVE_AMT
                                                                                          ELSE 0  --계약금 미수금액
                                                                                           END ) AS GAMT2
                                                                              , SUM( CASE WHEN S1.RVE_DV_CD IN ('03', '06' , '10' ,'07' ,'02', '16') AND S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                          WHEN S1.RVE_DV_CD IN ('03', '06' , '10' ,'07' ,'02', '16') AND S1.DP_DV_CD IN ('2' , '4') THEN -S1.RVE_AMT
                                                                                          ELSE 0  --할부금
                                                                                           END ) AS SUMINCW51
                --		                                                      , SUM( CASE WHEN S1.RVE_DV_CD = '10' AND S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                --		                                                                  WHEN S1.RVE_DV_CD = '10' AND S1.DP_DV_CD IN ('2' , '4') THEN -S1.RVE_AMT
                --		                                                                  ELSE 0  --손료
                --		                                                                   END ) AS SUMINMIN
                                                                              , SUM( CASE WHEN S1.RVE_DV_CD = '98' AND S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                          WHEN S1.RVE_DV_CD = '98' AND S1.DP_DV_CD IN ('2' , '4') THEN -S1.RVE_AMT
                                                                                          ELSE 0  --선수금
                                                                                           END ) AS SUMINCW52
                                                                              , SUM(CASE WHEN S1.DP_DV_CD = '3' AND S1.RVE_DV_CD = '17' THEN S1.RVE_AMT
                                                                                         ELSE 0
                                                                                         END) FREE_AMT /*수수료 금액*/
                                                                           FROM TB_RVDW_RVE_DTL S1
                                                                         WHERE 1 = 1
                                                                           AND S1.KW_GRP_CO_CD = '2000'
                                                                           AND S1.CNTR_NO = T1.CNTR_NO
                                                                           AND S1.CNTR_SN = T1.CNTR_SN
                                                                           AND S1.DTA_DL_YN = 'N' ) T4
                                                  ON 1 = 1
                                            --  --매출실적_현재월기준
                                               LEFT OUTER JOIN LATERAL ( SELECT S1.PRM_STRT_YM  	 /*(선납시작년월)*/
                                                                              , S1.PRM_END_YM  	 /*(선납종료년월)*/
                                                                              , S1.SL_CL_YM    	 /*(매출마감년월)*/
                                                                              , S2.EOT_DLQ_AMT 	 /*기말연체금액*/
                                                                              , S1.EOT_ATAM 		 /*(기말선수금)*/
                                                                              , S1.MLG_EOT_PRPD_AMT/*(마일리지기말선수금액)*/
                                                                              , S1.PRM_BLAM_EOT_AMT/*(선납잔액기말금액)*/
                                                                              , S1.THM_BIL_SPMT_AMT
                                                                              , CASE WHEN T1.SELL_TP_DTL_CD IN ('22','24') THEN S1.THM_BIL_OC_AMT - S1.THM_BIL_CTR_AMT + S1.THM_BIL_SPMT_AMT
                                                                                     ELSE S1.THM_SL_SUM_AMT /*(당월매출합계금액)*/
                                                                                      END AS AM16 /*렌탈매출*/
                                                                              , CASE WHEN SUBSTR(SL_RCOG_DT , 1 , 6) = S1.SL_CL_YM THEN S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT - S1.RENTAL_RGST_COST + (RENTAL_RGST_COST-CNTR_AMT) + MLG_DP_AMT - MLG_RFND_AMT
                                                                                     ELSE S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT + S1.MLG_DP_AMT - S1.MLG_RFND_AMT
                                                                                      END AS IAMT /*당월입금액(등록비제외)*/
                                                                              , CASE WHEN S1.PRM_STRT_YM > '000000' AND S1.SL_CL_YM BETWEEN S1.PRM_STRT_YM AND S1.PRM_END_YM THEN 'Y'
                                                                                     ELSE 'N'
                                                                                      END AS PRPMYN /*선납할인적용중인지 여부*/
                                                                              , CASE WHEN S1.PRM_STRT_YM = S1.SL_CL_YM THEN 'Y'  /*당월 선납할인 시작월인지 여부*/
                                                                                     ELSE 'N'
                                                                                      END AS PRPMSTYN
                                                                              , S1.SL_RCOG_DT /*매출인식일자*/
                                                                           FROM TB_CBCL_WELLS_SL_MM_CL_IZ S1 /*월마감*/
                                                                           LEFT OUTER JOIN TB_CBCL_DLQ_BAS S2/*연체기본*/
                                                                             ON (    S2.CNTR_NO = S1.CNTR_NO
                                                                                 AND S2.CNTR_SN = S1.CNTR_SN
                                                                                 AND S2.PERF_YM  = TO_CHAR(SYSDATE , 'YYYYMM')
                                                                                 AND S2.DTA_DL_YN = 'N' )
                                                                          WHERE 1 = 1
                                                                            AND S1.SL_CL_YM = TO_CHAR(SYSDATE , 'YYYYMM')
                                                                            AND S1.DTA_DL_YN = 'N'
                                            --  						        AND S1.SELL_TP_CD = '2'
                                                                            AND S1.CNTR_NO = T1.CNTR_NO
                                                                            AND S1.CNTR_SN = T1.CNTR_SN ) T5
                                                 ON 1 = 1
                                                --매출실적_전월기준
                                               LEFT OUTER JOIN LATERAL( SELECT S1.PRM_STRT_YM  	 /*(선납시작년월)*/
                                                                             , S1.PRM_END_YM  	 /*(선납종료년월)*/
                                                                             , S1.SL_CL_YM    	 /*(매출마감년월)*/
                                                                             , S2.EOT_DLQ_AMT 	 /*기말연체금액*/
                                                                             , S1.EOT_ATAM 		 /*(기말선수금)*/
                                                                             , S1.MLG_EOT_PRPD_AMT/*(마일리지기말선수금액)*/
                                                                             , S1.PRM_BLAM_EOT_AMT/*(선납잔액기말금액)*/
                                                                             , S1.THM_BIL_SPMT_AMT
                                                                             , S1.SL_RCOG_DT
                                                                          FROM TB_CBCL_WELLS_SL_MM_CL_IZ S1 /*월마감*/
                                                                          LEFT OUTER JOIN TB_CBCL_DLQ_BAS S2/*연체기본*/
                                                                            ON (    S2.CNTR_NO = S1.CNTR_NO
                                                                                AND S2.CNTR_SN = S1.CNTR_SN
                                                                                AND S2.PERF_YM  = TO_CHAR(ADD_MONTHS(SYSDATE , -1) , 'YYYYMM')
                                                                                AND S2.DTA_DL_YN = 'N' )
                                                                         WHERE 1 = 1
                                                                           AND S1.SL_CL_YM = TO_CHAR(ADD_MONTHS(SYSDATE , -1) , 'YYYYMM')
                                                                           AND S1.DTA_DL_YN = 'N'
                                            --  						       AND S1.SELL_TP_CD = '2'
                                                                           AND S1.CNTR_NO = T1.CNTR_NO
                                                                           AND S1.CNTR_SN = T1.CNTR_SN ) T6
                                                 ON 1 = 1
                                              WHERE 1 = 1
                  ]]>
                                              <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                                                 AND T1.CNTR_NO = #{cntrNo}
                                              </if>
                                              <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                                                 AND T1.CNTR_SN = #{cntrSn}
                                              </if>
                                              <if test='@MybatisUtils@isNotEmpty(cstNo)'>
                                                 AND T11.CNTR_CST_NO = #{cstNo}
                                              </if>
                                     )
     ) M2
           ON M2.CNTR_NO = T1.CNTR_NO
          AND M2.CNTR_SN = T1.CNTR_SN
          AND M2.CNTR_CST_NO = T1.CST_NO
         WHERE 1=1
           AND RRAB.KW_GRP_CO_CD = #{session.companyCode}
           AND RRAB.DTA_DL_YN = 'N' /* 삭제시 visible 처리 */
        <choose>
          <when test='@MybatisUtils@equals(searchDt, "01")'>  /* 접수일자 */
           AND RRAB.RFND_AK_DTM <![CDATA[>=]]> #{startDay} ||'000000'
           AND RRAB.RFND_AK_DTM <![CDATA[<=]]> #{endDay}   ||'235959'
          </when>
          <when test='@MybatisUtils@equals(searchDt, "02")'>  /* 실적일자 */
           AND RRAB.RFND_PERF_DT <![CDATA[>=]]> #{startDay}  ||'000000'
           AND RRAB.RFND_PERF_DT <![CDATA[<=]]> #{endDay}    ||'235959'
          </when>
           <when test='@MybatisUtils@equals(searchDt, "03")'> /* 처리일자 */
           AND RRAB.RFND_DSB_DT <![CDATA[>=]]> #{startDay}||'000000'
           AND RRAB.RFND_DSB_DT <![CDATA[<=]]> #{endDay}  ||'235959'
          </when>
        </choose>
        <if test='@MybatisUtils@isNotEmpty(rfndStatCd)'>
           AND RRAB.RFND_AK_STAT_CD = #{rfndStatCd}
        </if>
        <!-- 2023_12_23 rfndDsbDvCdCshBltf(처리구분) 삭제처리 -->
        <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
           AND RRAD.CNTR_NO = #{cntrNo}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
           AND RRAD.CNTR_SN = #{cntrSn}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cstNo)'>
           AND RRAD.CST_NO = #{cstNo}
        </if>
        ORDER BY RRAB.RFND_AK_DTM, RRAB.RFND_AK_NO
    </select>

    <select id="selectRefundContractDetail" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundContractDetailRes">
        SELECT A1.CNTR_NO
             , A1.CNTR_SN
             , A1.CNTR_DTL_NO
             , A1.SELL_TP_CD
             , A1.CST_NO
             , A1.PD_CD
             , A1.PD_NM
             , A1.CST_KNM
             , A1.COPN_DV_CD
             , NVL(A1.DP_AMT, 0) DP_AMT
             , NVL(A1.SELL_AMT, 0) SELL_AMT
             , NVL(G1.EOT_DLQ_ADD_AMT, 0) AS DLQ_ADD_AMT  /* 연체가산금 */
             , NVL(E1.RENTAL_AMT, 0) AS MM_ISTM_AMT /* 월 납부금(월 납입금) */
             , NVL(F1.EOT_BOR_AMT, 0) AS BOR_AMT /* 위약금 */
             , NVL(DECODE(E1.EOT_SV_AMT, 0, E2.SV_DP_SUM_AMT, E1.EOT_SV_AMT), 0) AS SV_AMT /* 서비스금액 */
             , NVL(M2.RFND_ALLOW_AMT,0) - NVL(FREE_AMT , 0) - NVL(SERVICE_AMT, 0) AS RFND_PSB_AMT
             , #{cntrStartDay} AS CNTR_START_DAY
             , #{cntrEndDay} AS CNTR_END_DAY
          FROM (
                SELECT A3.KW_GRP_CO_CD
                     , A3.CNTR_NO
                     , A3.CNTR_SN
                     , A3.CNTR_DTL_NO
                     , A3.SELL_TP_CD
                     , A3.CST_NO
                     , A3.PD_CD
                     , A3.PD_NM
                     , A3.CST_KNM
                     , A3.COPN_DV_CD
                     , SUM(CASE WHEN A3.DP_DV_CD IN ('1', '3') THEN A3.DP_AMT
                                ELSE (A3.DP_AMT*-1)
                            END ) DP_AMT
                     , SUM(A3.SELL_AMT) SELL_AMT
                     , SUM(A3.FREE_AMT) FREE_AMT
                     , SUM(A3.SERVICE_AMT) SERVICE_AMT
                  FROM (
                        SELECT A1.KW_GRP_CO_CD
                             , A1.CNTR_NO
                             , A1.CNTR_SN
                             , A1.CNTR_NO ||'-'|| A1.CNTR_SN AS CNTR_DTL_NO   /* 계약상세번호 */
                             , A1.RVE_NO
                             , C1.SELL_TP_CD /* 판매유형코드 */
                             , D1.CNTR_CST_NO AS CST_NO
                             , C1.BASE_PD_CD AS PD_CD
                             , (SELECT A2.PD_NM FROM TB_PDBS_PD_BAS A2 WHERE A2.PD_CD = C1.BASE_PD_CD) PD_NM /*상품명*/
                             , (SELECT A2.CST_KNM FROM TB_CUBS_CST_BAS A2 WHERE A2.CST_NO = D1.CNTR_CST_NO) CST_KNM   /*고객명*/
                             , (SELECT A2.COPN_DV_CD FROM TB_CUBS_CST_BAS A2 WHERE A2.CST_NO = D1.CNTR_CST_NO) COPN_DV_CD /* 법인격유형코드 (01.개인 , 02.법인 )*/
                             , A1.DP_DT   /* 입금일자 */
                             , A1.RVE_DT  /* 수납일자 */
                             , CASE WHEN A1.DP_DV_CD IN ('1', '3') AND A1.RVE_DV_CD IN ('14', '17') THEN 0
                                    ELSE A1.RVE_AMT
                                END AS DP_AMT  /* 입금금액 */
                             , A1.DP_TP_CD
                             , NVL(C1.SELL_AMT, 0) AS SELL_AMT /* 주문금액 */
                             , A1.DP_DV_CD
                             , CASE WHEN A1.DP_DV_CD IN ('1', '3') AND A1.RVE_DV_CD = '17' THEN RVE_AMT
                                    ELSE 0
                                     END FREE_AMT
                             , CASE WHEN A1.DP_DV_CD IN ('1', '3') AND A1.RVE_DV_CD = '14' THEN RVE_AMT
                                    ELSE 0
                                     END SERVICE_AMT
                          FROM TB_RVDW_RVE_DTL A1         /* 수납상세 */
                    INNER JOIN TB_SSCT_CNTR_DTL C1 /*계약상세*/
                            ON C1.CNTR_NO = A1.CNTR_NO
                           AND C1.CNTR_SN = A1.CNTR_SN
                           AND C1.DTA_DL_YN = 'N'
                    INNER JOIN TB_SSCT_CNTR_BAS D1 /*계약기본*/
                            ON D1.CNTR_NO = A1.CNTR_NO
                           AND D1.DTA_DL_YN = 'N'
                       <if test="@MybatisUtils@isNotEmpty(rfndAkNo)">
                    INNER JOIN TB_RVDW_RFND_AK_CNTR_DTL H1
                            ON H1.KW_GRP_CO_CD = A1.KW_GRP_CO_CD
                           AND H1.CNTR_NO      = A1.CNTR_NO
                           AND H1.CNTR_SN      = A1.CNTR_SN
                           AND H1.DTA_DL_YN    = 'N'
                           AND H1.RFND_AK_NO   = #{rfndAkNo}
                       </if>
                         WHERE A1.DTA_DL_YN = 'N'
                           AND A1.KW_GRP_CO_CD = '2000'
                           AND A1.RVE_DV_CD NOT IN ('98')
                           <if test="@MybatisUtils@isNotEmpty(cntrStartDay) or @MybatisUtils@isNotEmpty(cntrEndDay)">
                           AND (A1.DP_DT BETWEEN #{cntrStartDay}||'000000' AND #{cntrEndDay}||'235959' OR A1.RVE_DT BETWEEN #{cntrStartDay} AND #{cntrEndDay}) /*수납일자OR입금일자*/
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                           AND A1.CNTR_NO = #{cntrNo}                  /* 계약번호 */
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                           AND A1.CNTR_SN = #{cntrSn}                  /* 계약일련번호 */
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(cstNo)">
                           AND D1.CNTR_CST_NO = #{cstNo}               /* 고객번호 */
                           </if>
                       ) A3
                 WHERE 1=1
                   <if test="@MybatisUtils@isNotEmpty(copnDvCd)">
                   AND A3.COPN_DV_CD = #{copnDvCd}             /* 고객유형 */
                   </if>
                 GROUP BY A3.KW_GRP_CO_CD
                     , A3.CNTR_NO
                     , A3.CNTR_SN
                     , A3.CNTR_DTL_NO
                     , A3.SELL_TP_CD
                     , A3.CST_NO
                     , A3.PD_CD
                     , A3.PD_NM
                     , A3.CST_KNM
                     , A3.COPN_DV_CD
                     --, A3.RVE_NO
                     --, A3.DP_DT
                     --, A3.RVE_DT
                     --, A3.DP_TP_CD
                ) A1
     LEFT OUTER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ E1 /*월마감*/
             ON E1.SL_CL_YM = TO_CHAR(SYSDATE , 'YYYYMM')
            AND E1.CNTR_NO = A1.CNTR_NO
            AND E1.CNTR_SN = A1.CNTR_SN
            AND E1.DTA_DL_YN = 'N'
     LEFT OUTER JOIN (
                      SELECT A2.CNTR_NO
                           , A2.CNTR_SN
                           , SUM(DP_SUM_AMT) SV_DP_SUM_AMT
                        FROM TB_SVPD_SV_CS_BIL_IZ A2
                        JOIN TB_SVPD_SV_CS_DP_IZ B2
                          ON B2.DTA_DL_YN = 'N'
                         AND B2.CNTR_NO = A2.CNTR_NO
                         AND B2.CNTR_SN = A2.CNTR_SN
                         AND B2.CS_BIL_NO = A2.CS_BIL_NO
                         AND B2.CST_SV_ASN_NO = A2.CST_SV_ASN_NO
                       WHERE A2.DTA_DL_YN = 'N'
                       GROUP BY A2.CNTR_NO, A2.CNTR_SN
                     ) E2
             ON E2.CNTR_NO = A1.CNTR_NO
            AND E2.CNTR_SN = A1.CNTR_SN
     LEFT OUTER JOIN TB_CBCL_WELLS_BOR_AMT_BAS F1 /*WELLS위약금액기본*/
             ON F1.PERF_YM = TO_CHAR(SYSDATE ,'YYYYMM')
            AND F1.CNTR_NO = A1.CNTR_NO
            AND F1.CNTR_SN = A1.CNTR_SN
            AND F1.DTA_DL_YN = 'N'
     LEFT OUTER JOIN TB_CBCL_DLQ_BAS G1 /*연체기본*/
             ON G1.PERF_YM = TO_CHAR(SYSDATE ,'YYYYMM')
            AND G1.CNTR_NO = A1.CNTR_NO
            AND G1.CNTR_SN = A1.CNTR_SN
            AND G1.DTA_DL_YN = 'N'
        <if test='@MybatisUtils@isNotEmpty(crdcdNo)'>
            AND EXSITS (
                        SELECT 'X'
                          FROM TB_RVDW_RVE_DTL A2
                    LEFT OUTER JOIN TB_RVDW_ITG_DP_BAS B2
                            ON B2.DTA_DL_YN = 'N'
                           AND B2.ITG_DP_NO = A2.ITG_DP_NO
                           AND A2.CNTR_NO = A1.CNTR_NO
                           AND A2.CNTR_SN = A1.CNTR_SN
                        <if test='@MybatisUtils@equals(encr ,"01")'>
                           AND B2.CRCDNO_ENCR = #{crdcdNo} /* 카드번호 */
                        </if>
                        <if test='@MybatisUtils@equals(encr ,"02")'>
                           AND B2.ACNO_ENCR = #{acnoEncr} /* 계좌번호 */
                        </if>
                       )
        </if>
        LEFT OUTER JOIN ( <![CDATA[
                                        SELECT CNTR_NO
                                             , CNTR_SN
                                             , CNTR_CST_NO
                                              /*만약 계약입금액이 0보다 클경우*/
                                             ,CASE WHEN SELL_TP_CD = '1' THEN (CASE WHEN GAMT1 > 0 THEN /*상품시작일자가 있고 환불가능금액이 0 일경우 0*/
                                                                                                          CASE WHEN CNTR_PD_STRTDT IS NOT NULL AND RFND_ALLOW_AMT = 0 THEN 0
                                                                                                          /*아니면 계약금*/
                                                                                                               ELSE RFND_ALLOW_AMT
                                                                                                                END
                                                                                    ELSE 0
                                                                           END)
                                                                           +
                                                                          (CASE WHEN NVL(SUMINCW51 , 0) - NVL(MM_ISTM_AMT ,0) > 0 THEN NVL(SUMINCW51 , 0) - NVL(MM_ISTM_AMT ,0)
                                                                                ELSE 0
                                                                            END)
                                                                           +
                                                                           NVL(SUMINCW52, 0)
                                                ELSE 	RFND_ALLOW_AMT
                                                END AS RFND_ALLOW_AMT
                                         FROM (
                                                SELECT /*+ push_pred(T6) */
                                                         T1.CNTR_NO
                                                       , T1.CNTR_SN
                                                       , T11.CNTR_CST_NO
                                                       , T1.MM_ISTM_AMT
                                                       , T1.SELL_TP_CD
                                                       /*일시불 환불가능금액*/
                                                        /*
                                                         * 일시불 환불금 조회 로직 순서
                                                         *
                                                         * 1) 예정일,매출일이 없는 경우 => 계약금액 전체 환불
                                                         * 2) 예정일 & 매출일이 있는경우
                                                         *   2-1) 상품변경등록 => 계약금액 전체 환불
                                                         *   2-2) 법인미수금계약 법인미수금 환불액 => 법인미수금 입금 초과금액 [법인미수금 입금합계 - 법인미수금계약금액]
                                                         */
                                                       , CASE WHEN T1.SELL_TP_CD = '1' THEN CASE WHEN T1.SPP_DUEDT IS NULL AND T1.CNTR_PD_STRTDT IS NULL THEN CASE WHEN NVL(T1.CNTR_AMT , 0 ) != 0 THEN NVL(T1.CNTR_AMT,0) + NVL(T1.CRP_UC_AMT ,0)
                                                                                                                                                                   ELSE 0
                                                                                                                                                                    END
                                                                                   /* 2) 예정일 & 매출일이 있는경우 2-1) 상품변경등록 => 계약금액 전체 환불
                                                                                                         WHEN T1.SPP_DUEDT IS NOT NULL AND T1.CNTR_PD_STRTDT IS NOT NULL THEN T4.AMT2  */
                                                                                   /*   2-2) 법인미수 초과금액*/
                                                                                        ELSE T4.GAMT2 - T1.CNTR_AMT
                                                                                         END
                                                       /*
                                                         * 렌탈 금융리스 환불금 조회 로직 순서
                                                         *
                                                         * 1.완료일 설정된 경우 => 총입금누계 - 입금대체누계 - 총가산입금액 - 등록비용(등록-할인) - 위약금액 - 소모품비
                                                         * 2.취소일 설정된 경우 => 마지막달의 선수금- 현재월 연체금
                                                         * 3.매출중지인 경우 (금융리스는 매출중지가 없으므로 L20 (렌탈) 만 조회
                                                         *   3-1)이번달 연체금액이 없으면 (선수금액 - 렌탈매출액)
                                                         *   3-2)이번달 연체금액이 있으면 (연체금액 + 매출중지액)
                                                         * 5. 선납인 경우
                                                         *   5-1)선납이 살아있는 경우
                                                         *     5-1-1)선납년월과 조회년월이 다른경우 => 환불 가능액 = 선수잔액
                                                         *     5-1-2)선납년월과 조회년월이 같은 경우 => 환불 가능액 = 선수총액 + 매출금액
                                                         *   5-2)선납이 중지된 경우 => 당월선수금 - 당월 발생 추가 매출액 = 환불 가능액
                                                         * 6. 그 외
                                                         *   6-1) 전월 선수금이 있는 경우
                                                         *     6-1-1) 당월매출액이 음수인 경우 => 전월 선수금액 + 당월 입금액 - 당월매출액
                                                         *     6-1-2) 그외 => 전월 선수금액+당월 입금액
                                                         *   6-2) 그 외
                                                         *     6-2-1) 당월매출액이 음수인 경우 => 당월 입금액 - 전월 연체금액 - 당월매출액
                                                         *     6-2-2) 그외 => 당월 입금액 - 전월 연체금액 */
                                                                                                /* 1.완료일 설정된 경우 => 총입금누계 - 입금대체누계 - 총가산입금액 - 등록비용(등록-할인) - 위약금액 - 소모품비 */
                                                               WHEN T1.SELL_TP_CD = '2' THEN CASE WHEN T2.FULPY_DT > 0 THEN NVL(T4.AMT1 , 0) - NVL(T2.SL_DP_AGG_AMT , 0) - NVL(T4.AM83 , 0) - NVL(T1.CNTR_AMT,0) -  NVL(T3.BOR_AMT,0) - NVL(T3.CSMB_COST_BOR_AMT2,0)
                                                                                           /* 2.취소일 설정된 경우 => 마지막달의 선수금- 현재월 연체금 */
                                                                                                  WHEN T2.CAN_DT IS NOT NULL THEN (NVL(T2.EOT_ATAM,0) + NVL(T2.MLG_EOT_PRPD_AMT,0)) - NVL(T5.EOT_DLQ_AMT ,0)
                                                                                           /* 3.매출중지인 경우 (금융리스는 매출중지가 없으므로 L20 (렌탈) 만 조회
                                                                                           *   3-1)이번달 연체금액이 없으면 (선수금액 - 렌탈매출액) */
                                                                                                  WHEN T1.SELL_TP_DTL_CD NOT IN ('22' , '24') AND NVL(T2.SL_STP_YN , 'N' ) = 'Y' AND NVL(T5.EOT_DLQ_AMT,0) = 0  THEN NVL(T5.EOT_ATAM, 0) + NVL(T5.MLG_EOT_PRPD_AMT , 0) - NVL(T5.AM16 , 0)
                                                                                           /*   3-2)이번달 연체금액이 있으면 (연체금액 + 매출중지액) */
                                                                                                  WHEN T1.SELL_TP_DTL_CD NOT IN ('22' , '24') AND NVL(T2.SL_STP_YN , 'N' ) = 'Y' AND NVL(T5.EOT_DLQ_AMT,0) != 0 THEN NVL(T5.EOT_DLQ_AMT , 0)- NVL(T5.AM16 , 0)
                                                                                           /* 5. 선납인 경우
                                                                                                     *   5-1)선납이 살아있는 경우
                                                                                                     *     5-1-1)선납년월과 조회년월이 다른경우 => 환불 가능액 = 선수잔액 */
                                                                                                  WHEN NVL(T5.PRPMYN,'N') = 'Y' AND NVL(T5.PRPMSTYN,'N') != 'Y' THEN NVL(T5.EOT_ATAM,0) - NVL(T5.PRM_BLAM_EOT_AMT,0)
                                                                                           /*     5-1-2)선납년월과 조회년월이 같은 경우 => 환불 가능액 = 선수총액 + 매출금액 */
                                                                                                  WHEN NVL(T5.PRPMYN,'N') = 'Y' AND NVL(T5.PRPMSTYN,'N') = 'Y' THEN NVL(T5.EOT_ATAM,0) + NVL(T5.MLG_EOT_PRPD_AMT , 0) + NVL(T5.AM16 , 0)
                                                                                           /*   5-2)선납이 중지된 경우 => 당월선수금 - 당월 발생 추가 매출액 = 환불 가능액 */
                                                                                                  WHEN T6.PRM_END_YM > TO_CHAR(SYSDATE , 'YYYYMMDD') AND T5.PRM_END_YM IS NULL THEN NVL(T5.EOT_ATAM,0) + NVL(T5.MLG_EOT_PRPD_AMT , 0)
                                                                                                  /* 6. 그 외
                                                                                                     *   6-1) 전월 선수금이 있는 경우
                                                                                                     *     6-1-1) 당월매출액이 음수인 경우 => 전월 선수금액 + 당월 입금액 - 당월매출액 */
                                                                                                  WHEN NVL(T6.EOT_ATAM,0) + NVL(T6.MLG_EOT_PRPD_AMT,0) > 0 AND NVL(T5.AM16,0) < 0 THEN NVL(T6.EOT_ATAM,0) + NVL(T6.MLG_EOT_PRPD_AMT,0) + NVL(T5.IAMT,0) - NVL(T5.AM16,0)

                                                                                                /*     6-1-2) 그외 => 전월 선수금액+당월 입금액 */
                                                                                                  WHEN NVL(T6.EOT_ATAM,0) + NVL(T6.MLG_EOT_PRPD_AMT,0) > 0 THEN NVL(T6.EOT_ATAM,0) + NVL(T6.MLG_EOT_PRPD_AMT,0) + NVL(T5.IAMT,0)
                                                                                                /*   6-2) 그 외
                                                                                                 *     6-2-1) 당월매출액이 음수인 경우 => 당월 입금액 - 전월 연체금액 - 당월매출액
                                                                                                 *     6-2-2) 그외 => 당월 입금액 - 전월 연체금액 */
                                                                                                  WHEN NVL(T5.AM16,0) < 0 THEN NVL(T5.IAMT,0) - NVL(T6.EOT_DLQ_AMT,0) - NVL(T5.AM16,0)
                                                                                                  ELSE NVL(T5.IAMT,0) - NVL(T6.EOT_DLQ_AMT,0)
                                                                                                   END
                                                        /*
                                                         * 멤버십, 홈케어멤버십 환불금 조회 로직 순서
                                                         *
                                                         * ********** 마지막 매출 정보가 있는 경우에만 환불금액 조회 가능 **********
                                                         *
                                                         * 1. 완료일자가 있는 경우 => 총입금누계 - 입금대체누계 - 총가산입금액 - 필터공제 = 환불 가능금액(선수금)
                                                         * 2. 탈퇴일자가 있는 경우 => 환불가능금액 (이번달 선수금)
                                                         * 3. 전월 선수금이 있는 경우 => 전월 선수금액+당월 입금액
                                                         * 4. 그 이외 => 당월 입금액 - 전월 연체금액
                                                         */
                                                                                                /* 1. 완료일자가 있는 경우 => 총입금누계 - 입금누계 - 총가산입금액 - 필터공제 = 환불 가능금액(선수금) */
                                                              WHEN T1.SELL_TP_CD = '3' THEN CASE WHEN NVL(T2.FULPY_DT,0) > 0 THEN NVL(T4.AMT1,0) - NVL(T2.SL_DP_AGG_AMT,0) - NVL(T4.AM83,0) - NVL(T3.FILT_DDCTAM ,0) --> TB_SSCT_CNTR_RSG_PROCS_IZ.FILT_DDCTAM (필터공제금액)
                                                                                                /* 2. 탈퇴일자가 있는 경우 => 환불가능금액 (이번달 선수금) */
                                                                                                 WHEN NVL(T2.CAN_DT,0) > 0 THEN NVL(T5.EOT_ATAM,0)
                                                                                                /* 3. 전월 선수금이 있는 경우 => 전월 선수금액+당월 입금액 */
                                                                                                 WHEN NVL(T6.EOT_ATAM,0) > 0 THEN NVL(T6.EOT_ATAM,0) + NVL(T5.IAMT,0)
                                                                                                /* 4. 그 이외 => 당월 입금액 - 전월 연체금액*/
                                                                                                 ELSE NVL(T5.IAMT,0) - NVL(T6.EOT_DLQ_AMT,0)
                                                                                                  END
                                                                                                  /* 1. 취소인 경우
                                                                                                 *   1-1) 연체가 있는 경우 => 이번달 선수금 - 이번달 연체금액 */
                                                              WHEN T1.SELL_TP_CD = '6' THEN CASE  WHEN NVL(T2.CAN_DT,0) > 0 AND NVL(T2.FULPY_DT,0) = 0 AND NVL(T5.THM_BIL_SPMT_AMT,0) > 0 THEN NVL(T5.EOT_ATAM,0) - NVL(T5.THM_BIL_SPMT_AMT,0)
                                                                                                /*   1-2) 연체가 없는 경우 => 이번달 선수금 */
                                                                                                  WHEN NVL(T2.CAN_DT,0) > 0 AND NVL(T2.FULPY_DT,0) = 0 THEN NVL(T5.EOT_ATAM,0)
                                                                                                /* 2. 전월 선수금이 있는 경우 => 전월 선수금액+당월 입금액 */
                                                                                                  WHEN NVL(T6.EOT_ATAM,0) > 0 THEN NVL(T6.EOT_ATAM,0) + NVL(T5.IAMT,0)
                                                                                                /* 3. 그 이외 => 당월 입금액 - 전월 연체금액 */
                                                                                                  ELSE NVL(T5.IAMT,0) - NVL(T6.THM_BIL_SPMT_AMT,0)
                                                                                                   END

                                                               END 	AS RFND_ALLOW_AMT /*환불가능금액*/
                                                       , T4.GAMT1 /*계약금*/
                    --		                           , T4.SUMINMIN /*손료*/
                                                       , T4.SUMINCW51 /*할부금*/
                                                       , T4.SUMINCW52 /*선수금*/
                                                       , T1.SPP_DUEDT /*배송예정일*/
                                                       , T1.CNTR_PD_STRTDT /*상품시작일자*/
                                                       , T4.FREE_AMT
                                                    FROM TB_SSCT_CNTR_DTL T1
                                                   INNER JOIN TB_SSCT_CNTR_BAS T11
                                                      ON (    T11.CNTR_NO = T1.CNTR_NO
                                                          AND T11.DTA_DL_YN = 'N')
                                                   INNER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ T2  --매출실적_최종월기준
                                                      ON (    T2.CNTR_NO = T1.CNTR_NO
                                                          AND T2.CNTR_SN = T1.CNTR_SN
                                                          AND T2.DTA_DL_YN = 'N'
                                                          AND T2.SL_CL_YM =
                                                          (
                                                                            SELECT MAX(S1.SL_CL_YM)
                                                                               FROM TB_CBCL_WELLS_SL_MM_CL_IZ S1
                                                                              WHERE 1 = 1
                                                                                AND S1.CNTR_NO = T1.CNTR_NO
                                                                                AND S1.CNTR_SN = T1.CNTR_SN
                                                                                AND S1.DTA_DL_YN = 'N')

                                                                                )
                                                   LEFT OUTER JOIN TB_SSCT_CNTR_RSG_PROCS_IZ T3 /*계약해지처리내역*/
                                                     ON (    T3.CNTR_NO = T1.CNTR_NO
                                                         AND T3.CNTR_SN = T1.CNTR_SN
                                                         AND T3.DTA_DL_YN = 'N')
                                                    LEFT OUTER JOIN LATERAL( SELECT SUM(CASE WHEN S1.RVE_DV_CD = '02' AND S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                             ELSE 0
                                                                                              END ) AS AM83 /*총가산금 입금액*/
                                                                                  , SUM(CASE WHEN S1.DP_DV_CD IN ('1' , '3') THEN RVE_AMT
                                                                                             ELSE 0
                                                                                              END ) AS AMT1 --입금누계
                                                                                  , SUM(CASE WHEN S1.RVE_DV_CD = '01' AND  S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                              ELSE -S1.RVE_AMT
                                                                                               END ) AS AMT2  --계약금 입금누계
                                                                                  , SUM( CASE WHEN S1.RVE_DV_CD = '01' AND S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                              WHEN S1.RVE_DV_CD = '01' AND S1.DP_DV_CD IN ('2' , '4') THEN -S1.RVE_AMT
                                                                                              ELSE 0  --계약금 미수금액
                                                                                               END ) AS GAMT1
                                                                                  , SUM( CASE WHEN S1.RVE_DV_CD = '01'  AND S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                              WHEN S1.RVE_DV_CD = '01'  AND S1.DP_DV_CD IN ('2' , '4') THEN -S1.RVE_AMT
                                                                                              ELSE 0  --계약금 미수금액
                                                                                               END ) AS GAMT2
                                                                                  , SUM( CASE WHEN S1.RVE_DV_CD IN ('03', '06' , '10' ,'07' ,'02', '16') AND S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                              WHEN S1.RVE_DV_CD IN ('03', '06' , '10' ,'07' ,'02', '16') AND S1.DP_DV_CD IN ('2' , '4') THEN -S1.RVE_AMT
                                                                                              ELSE 0  --할부금
                                                                                               END ) AS SUMINCW51
                    --		                                                      , SUM( CASE WHEN S1.RVE_DV_CD = '10' AND S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                    --		                                                                  WHEN S1.RVE_DV_CD = '10' AND S1.DP_DV_CD IN ('2' , '4') THEN -S1.RVE_AMT
                    --		                                                                  ELSE 0  --손료
                    --		                                                                   END ) AS SUMINMIN
                                                                                  , SUM( CASE WHEN S1.RVE_DV_CD = '98' AND S1.DP_DV_CD IN ('1' , '3') THEN S1.RVE_AMT
                                                                                              WHEN S1.RVE_DV_CD = '98' AND S1.DP_DV_CD IN ('2' , '4') THEN -S1.RVE_AMT
                                                                                              ELSE 0  --선수금
                                                                                               END ) AS SUMINCW52
                                                                                  , SUM(CASE WHEN S1.DP_DV_CD = '3' AND S1.RVE_DV_CD = '17' THEN S1.RVE_AMT
                                                                                             ELSE 0
                                                                                              END) FREE_AMT /*수수료 금액*/
                                                                               FROM TB_RVDW_RVE_DTL S1
                                                                             WHERE 1 = 1
                                                                               AND S1.KW_GRP_CO_CD = '2000'
                                                                               AND S1.CNTR_NO = T1.CNTR_NO
                                                                               AND S1.CNTR_SN = T1.CNTR_SN
                                                                               AND S1.DTA_DL_YN = 'N' ) T4
                                                      ON 1 = 1
                                                --  --매출실적_현재월기준
                                                   LEFT OUTER JOIN LATERAL ( SELECT S1.PRM_STRT_YM  	 /*(선납시작년월)*/
                                                                                  , S1.PRM_END_YM  	 /*(선납종료년월)*/
                                                                                  , S1.SL_CL_YM    	 /*(매출마감년월)*/
                                                                                  , S2.EOT_DLQ_AMT 	 /*기말연체금액*/
                                                                                  , S1.EOT_ATAM 		 /*(기말선수금)*/
                                                                                  , S1.MLG_EOT_PRPD_AMT/*(마일리지기말선수금액)*/
                                                                                  , S1.PRM_BLAM_EOT_AMT/*(선납잔액기말금액)*/
                                                                                  , S1.THM_BIL_SPMT_AMT
                                                                                  , CASE WHEN T1.SELL_TP_DTL_CD IN ('22','24') THEN S1.THM_BIL_OC_AMT - S1.THM_BIL_CTR_AMT + S1.THM_BIL_SPMT_AMT
                                                                                         ELSE S1.THM_SL_SUM_AMT /*(당월매출합계금액)*/
                                                                                          END AS AM16 /*렌탈매출*/
                                                                                  , CASE WHEN SUBSTR(SL_RCOG_DT , 1 , 6) = S1.SL_CL_YM THEN S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT - S1.RENTAL_RGST_COST + (RENTAL_RGST_COST-CNTR_AMT) + MLG_DP_AMT - MLG_RFND_AMT
                                                                                         ELSE S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT + S1.MLG_DP_AMT - S1.MLG_RFND_AMT
                                                                                          END AS IAMT /*당월입금액(등록비제외)*/
                                                                                  , CASE WHEN S1.PRM_STRT_YM > '000000' AND S1.SL_CL_YM BETWEEN S1.PRM_STRT_YM AND S1.PRM_END_YM THEN 'Y'
                                                                                         ELSE 'N'
                                                                                          END AS PRPMYN /*선납할인적용중인지 여부*/
                                                                                  , CASE WHEN S1.PRM_STRT_YM = S1.SL_CL_YM THEN 'Y'  /*당월 선납할인 시작월인지 여부*/
                                                                                         ELSE 'N'
                                                                                          END AS PRPMSTYN
                                                                                  , S1.SL_RCOG_DT /*매출인식일자*/
                                                                               FROM TB_CBCL_WELLS_SL_MM_CL_IZ S1 /*월마감*/
                                                                               LEFT OUTER JOIN TB_CBCL_DLQ_BAS S2/*연체기본*/
                                                                                 ON (    S2.CNTR_NO = S1.CNTR_NO
                                                                                     AND S2.CNTR_SN = S1.CNTR_SN
                                                                                     AND S2.PERF_YM  = TO_CHAR(SYSDATE , 'YYYYMM')
                                                                                     AND S2.DTA_DL_YN = 'N' )
                                                                              WHERE 1 = 1
                                                                                AND S1.SL_CL_YM = TO_CHAR(SYSDATE , 'YYYYMM')
                                                                                AND S1.DTA_DL_YN = 'N'
                                                --  						        AND S1.SELL_TP_CD = '2'
                                                                                AND S1.CNTR_NO = T1.CNTR_NO
                                                                                AND S1.CNTR_SN = T1.CNTR_SN ) T5
                                                     ON 1 = 1
                                                    --매출실적_전월기준
                                                   LEFT OUTER JOIN LATERAL( SELECT S1.PRM_STRT_YM  	 /*(선납시작년월)*/
                                                                                 , S1.PRM_END_YM  	 /*(선납종료년월)*/
                                                                                 , S1.SL_CL_YM    	 /*(매출마감년월)*/
                                                                                 , S2.EOT_DLQ_AMT 	 /*기말연체금액*/
                                                                                 , S1.EOT_ATAM 		 /*(기말선수금)*/
                                                                                 , S1.MLG_EOT_PRPD_AMT/*(마일리지기말선수금액)*/
                                                                                 , S1.PRM_BLAM_EOT_AMT/*(선납잔액기말금액)*/
                                                                                 , S1.THM_BIL_SPMT_AMT
                                                                                 , S1.SL_RCOG_DT
                                                                              FROM TB_CBCL_WELLS_SL_MM_CL_IZ S1 /*월마감*/
                                                                              LEFT OUTER JOIN TB_CBCL_DLQ_BAS S2/*연체기본*/
                                                                                ON (    S2.CNTR_NO = S1.CNTR_NO
                                                                                    AND S2.CNTR_SN = S1.CNTR_SN
                                                                                    AND S2.PERF_YM  = TO_CHAR(ADD_MONTHS(SYSDATE , -1) , 'YYYYMM')
                                                                                    AND S2.DTA_DL_YN = 'N' )
                                                                             WHERE 1 = 1
                                                                               AND S1.SL_CL_YM = TO_CHAR(ADD_MONTHS(SYSDATE , -1) , 'YYYYMM')
                                                                               AND S1.DTA_DL_YN = 'N'
                                                --  						       AND S1.SELL_TP_CD = '2'
                                                                               AND S1.CNTR_NO = T1.CNTR_NO
                                                                               AND S1.CNTR_SN = T1.CNTR_SN ) T6
                                                     ON 1 = 1
                                                  WHERE 1 = 1
                      ]]>
                                                    <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                                                      AND T1.CNTR_NO = #{cntrNo}                  /* 계약번호 */
                                                    </if>
                                                    <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                                                      AND T1.CNTR_SN = #{cntrSn}                  /* 계약일련번호 */
                                                    </if>
                                                    <if test="@MybatisUtils@isNotEmpty(cstNo)">
                                                      AND T11.CNTR_CST_NO = #{cstNo}               /* 고객번호 */
                                                    </if>
                                         )
         ) M2
           ON M2.CNTR_NO = A1.CNTR_NO
          AND M2.CNTR_SN = A1.CNTR_SN
          AND M2.CNTR_CST_NO = A1.CST_NO
       WHERE 1=1

    </select>

    <!-- 환불기본정보조회 -->
    <select id="selectRefund" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundRes">
          SELECT T1.RFND_AK_NO /* 환불요청번호 */
               , T1.ARFND_YN /* 선환불 구분 */
               , T1.CSH_RFND_FNIT_CD /* 은행코드 */
               , T1.CSH_RFND_ACNO_ENCR /* 계좌번호 */
               , T1.CSH_RFND_ACOWN_NM /* 예금주 */
               , T1.RFND_RVE_DT /* 환불수납일자*/
               , T1.RFND_PERF_DT /* 환불실적일자*/
               , CASE WHEN T1.RFND_DSB_DT IS NULL THEN (SELECT MIN(A1.BASE_Y || A1.BASE_MM || A1.BASE_D)
                                                           FROM TB_SVPD_SV_CLND_BAS A1
                                                          WHERE A1.DTA_DL_YN = 'N'
                                                            AND A1.BASE_Y || A1.BASE_MM || A1.BASE_D <![CDATA[>=]]> TO_CHAR(SYSDATE+2, 'YYYYMMDD')
                                                            AND NVL(A1.DF_YN, 'N')   <![CDATA[<>]]> 'Y'
                                                            AND NVL(A1.PHLD_YN, 'N') <![CDATA[<>]]> 'Y'
                                                            AND A1.DOW_DV_CD NOT IN ('1', '7')
                                                        )
                      ELSE T1.RFND_DSB_DT
                  END RFND_DSB_DT /* 환불지급일자 */
               , T1.RFND_PROCS_DV_CD /* 환불처리구분코드 */
               , T1.RFND_PROCS_CN /* 환불처리내용 */
            FROM TB_RVDW_RFND_AK_BAS T1
           WHERE 1 = 1
             AND RFND_AK_NO = #{rfndAkNo}
             AND RFND_AK_STAT_CD = #{rfndAkStatCd}
    </select>

    <!-- 계약상세 조회 -->
     <select id="selectRefundBasePages" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundBaseRes">
         SELECT CNTR_NO
           FROM TB_RVDW_RVE_DTL
          WHERE 1=1
    </select>

    <!-- 환불상세 조회 -->
    <select id="selectRefundDetail" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundDetailRes">
           SELECT T1.RVE_NO
                , T1.RVE_SN
                , T1.CNTR_NO
                , T1.CNTR_SN
                , T1.CNTR_DTL_NO
                , T1.DP_DT
                , T1.DP_MES_CD
                , T1.RVE_DV_CD
                , T1.DP_AMT
                , CASE WHEN DP_DV_CD IN ('1', '3') AND RVE_DV_CD IN ('14', '17') THEN 0
                       ELSE CASE WHEN DP_DV_CD IN ('1', '3') THEN (NVL(T1.DP_AMT, 0) - NVL(RFND_AMT, 0))
                                 ELSE 0
                                  END
                        END AS RFND_PSB_BLAM  /* 입금액 => 환불가능금액 */
                , T1.DP_AMT - T1.DLQ_ADD_AMT - T1.BOR_AMT - T1.SV_AMT AS RFND_PSB_AMT /* 입금액 => 환불가능금액 */
                , T1.BLTF_ADD
                , 0 AS RFND_CSH_AK_AMT
                , 0 AS RFND_CARD_AK_AMT
                , 0 AS CRDCD_FEE_AMT
                , 0 AS RFND_BLTF_AK_AMT
                , RFND_AMT
                , NULL AS RFND_AK_NO
                , FNIT_CD
                , FNIT_NM
                , AC_CR_NO
                , NVL(CRDCD_FER , 0) AS CRDCD_FER
                , CST_NO
                , DP_TP_CD
                , DP_DV_CD
                , '' RFND_RSON_CD
                , '' RFND_RSON_CN
             FROM ( SELECT A1.RVE_NO      /* 수납번호 */
                         , A1.RVE_SN      /* 수납일련번호 */
                         , A1.CNTR_NO     /* 계약번호*/
                         , A1.CNTR_SN     /* 계약일련번호 */
                         , A1.CNTR_NO || A1.CNTR_SN AS CNTR_DTL_NO /* 계약상세번호 */
                         , A1.DP_DT               /* 입금일 */
                         , A1.DP_MES_CD           /* 입금수단 */
                         , A1.RVE_DV_CD            /* 입금유형 -> 수납유형(사양서, 설계서결과에 맞게 수정) */
                         , NVL(B1.FNIT_CD, B1.CRDCD_FNIT_CD) FNIT_CD
                         , I1.FNIT_NM
                         , NVL(B1.ACNO_ENCR, B1.CRCDNO_ENCR) AC_CR_NO
                         , NVL(H1.CRDCD_FER, 0) CRDCD_FER
                         , NVL(E1.EOT_SV_AMT , 0) AS SV_AMT /* 서비스금액 */
                         , NVL(A1.DP_AMT, 0) AS DP_AMT /* 입금액 */
                         , NVL(G1.EOT_DLQ_ADD_AMT,0) AS DLQ_ADD_AMT  /* 연체가산금 */
                         , NVL(E1.RENTAL_AMT,0) AS MM_ISTM_AMT /* 월 납부금(월 납입금) */
                         , NVL(F1.EOT_BOR_AMT,0) AS BOR_AMT /* 위약금 */
                         , D1.CNTR_CST_NO AS CST_NO
                         , '전금행추가' AS BLTF_ADD  /* 전금행추가 - 컬럼 */
                         , A1.DP_TP_CD
                         , A1.DP_DV_CD
                         , CASE WHEN A1.DP_DV_CD IN ('1', '3') THEN NVL((SELECT SUM(A2.RVE_AMT)
                                                                           FROM TB_RVDW_RVE_DTL A2
                                                                          WHERE A2.ORRVE_NO = A1.RVE_NO
                                                                            AND A2.ORRVE_SN = A1.RVE_SN
                                                                    ), 0)
                                ELSE 0
                            END RFND_AMT
                      FROM TB_RVDW_RVE_DTL A1 /* 수납상세 */
                LEFT OUTER JOIN TB_RVDW_ITG_DP_BAS B1 /* 통합입금기본 */
                        ON B1.ITG_DP_NO = A1.ITG_DP_NO
                       AND B1.DTA_DL_YN = 'N'
                       AND B1.ITG_DP_CAN_YN = 'N'
                INNER JOIN TB_SSCT_CNTR_DTL C1 /* 계약상세 */
                        ON C1.CNTR_NO = A1.CNTR_NO
                       AND C1.CNTR_SN = A1.CNTR_SN
                       AND C1.DTA_DL_YN = 'N'
                INNER JOIN TB_SSCT_CNTR_BAS D1 /*계약기본*/
                        ON D1.CNTR_NO = C1.CNTR_NO
                       AND D1.DTA_DL_YN = 'N'
                LEFT OUTER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ E1 /*월마감*/
                        ON E1.SL_CL_YM = TO_CHAR(SYSDATE , 'YYYYMM')
                       AND E1.CNTR_NO = A1.CNTR_NO
                       AND E1.CNTR_SN = A1.CNTR_SN
                       AND E1.DTA_DL_YN = 'N'
                LEFT OUTER JOIN TB_CBCL_WELLS_BOR_AMT_BAS F1 /*WELLS위약금액기본*/
                        ON F1.PERF_YM = TO_CHAR(SYSDATE ,'YYYYMM')
                       AND F1.CNTR_NO = A1.CNTR_NO
                       AND F1.CNTR_SN = A1.CNTR_SN
                       AND F1.DTA_DL_YN = 'N'
                LEFT OUTER JOIN TB_CBCL_DLQ_BAS G1 /*연체기본*/
                        ON G1.PERF_YM = TO_CHAR(SYSDATE ,'YYYYMM')
                       AND G1.CNTR_NO = A1.CNTR_NO
                       AND G1.CNTR_SN = A1.CNTR_SN
                       AND G1.DTA_DL_YN = 'N'
                LEFT OUTER JOIN TB_RVDW_FNIT_FEE_BAS H1
                        ON H1.KW_GRP_CO_CD = B1.KW_GRP_CO_CD
                       AND H1.FNIT_CD = B1.FNIT_CD
                       AND H1.FNIT_FEE_TP_CD = '2'
                       AND H1.DTA_DL_YN = 'N'
                       AND H1.VL_STRTDT <![CDATA[<=]]> A1.RVE_DT
                       AND H1.VL_ENDDT  <![CDATA[>=]]> A1.RVE_DT
                LEFT OUTER JOIN TB_RVDW_FNIT_CD I1
                        ON I1.FNIT_CD = NVL(B1.FNIT_CD, B1.CRDCD_FNIT_CD)
                       AND I1.FNIT_DV_CD = DECODE(B1.FNIT_CD, NULL, '2', '1')
                     WHERE 1 = 1
                       AND A1.DTA_DL_YN = 'N'
                       AND A1.RVE_DV_CD NOT IN ('98', '14', '17') /*기타선수, 서비스입금, 수수료*/
                       AND A1.CNTR_NO = #{cntrNo}
                       AND A1.CNTR_SN = #{cntrSn}
                      <if test="@MybatisUtils@isNotEmpty(rveNo)">
                       AND A1.RVE_NO = #{rveNo}
                      </if>
                      <if test="@MybatisUtils@isNotEmpty(cntrStartDay) or @MybatisUtils@isNotEmpty(cntrEndDay)">
                       AND (A1.DP_DT BETWEEN #{cntrStartDay}||'000000' AND #{cntrEndDay}||'235959' OR A1.RVE_DT BETWEEN #{cntrStartDay} AND #{cntrEndDay}) /*수납일자OR입금일자*/
                      </if>
                      <if test="@MybatisUtils@isNotEmpty(rveSn)">
                       AND A1.RVE_SN = #{rveSn}
                      </if>
                      <if test="@MybatisUtils@isNotEmpty(dpDt)">
                       AND A1.DP_DT = #{dpDt}
                      </if>
                     ORDER BY A1.CNTR_NO , A1.CNTR_SN ,A1.RVE_DT DESC
                 ) T1
    </select>

    <select id="selectRefundDetailPage" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundDetailRes">
           SELECT
                  T1.RVE_NO
                , T1.RVE_SN
                , T1.CNTR_NO
                , T1.CNTR_SN
                , T1.CNTR_DTL_NO
                , T1.DP_DT
                , T1.DP_MES_CD
                , T1.RVE_DV_CD
                , T1.DP_AMT
                , T1.DP_AMT - T1.DLQ_ADD_AMT - T1.MM_ISTM_AMT - T1.BOR_AMT - T1.SV_AMT AS RFND_PSB_AMT /* 입금액 => 환불가능금액 */
                , T1.BLTF_ADD
                , T1.RFND_CSH_AK_AMT + T1.CRDCD_FEE_AMT AS RFND_CSH_AK_AMT
                , T1.RFND_CARD_AK_AMT
                , T1.CRDCD_FEE_AMT
                , T1.RFND_BLTF_AK_AMT
                , T1.RFND_AMT
                , CASE WHEN DP_DV_CD IN ('1', '3') THEN (NVL(T1.DP_AMT, 0) - NVL(RFND_AMT, 0))
                       ELSE 0
                   END RFND_PSB_BLAM
                , T1.RFND_AK_NO
                , T1.FNIT_CD
                , T1.FNIT_NM
                , T1.AC_CR_NO
                , NVL(T1.CRDCD_FER , 0) AS CRDCD_FER
                , CST_NO
                , T1.DP_TP_CD
                , T1.RFND_RSON_CD
                , T1.RFND_RSON_CN
                , DP_DV_CD
             FROM ( SELECT A1.RVE_NO      /* 수납번호 */
                         , A1.RVE_SN      /* 수납일련번호 */
                         , A1.CNTR_NO     /* 계약번호*/
                         , A1.CNTR_SN     /* 계약일련번호 */
                         , A1.CNTR_NO ||'-'|| A1.CNTR_SN AS CNTR_DTL_NO /* 계약상세번호 */
                         , B1.DP_DT               /* 입금일 */
                         , B1.DP_MES_CD           /* 입금수단 */
                         , B1.RVE_DV_CD            /* 입금유형 -> 수납유형(사양서, 설계서결과에 맞게 수정) */
                         , NVL(E1.EOT_SV_AMT , 0) AS SV_AMT /* 서비스금액 */
                         , NVL(B1.DP_AMT, 0) AS DP_AMT /* 입금액 */
                         , NVL(G1.EOT_DLQ_ADD_AMT,0) AS DLQ_ADD_AMT  /* 연체가산금 */
                         , NVL(E1.RENTAL_AMT,0) AS MM_ISTM_AMT /* 월 납부금(월 납입금) */
                         , NVL(F1.EOT_BOR_AMT,0) AS BOR_AMT /* 위약금 */
                         , '전금행추가' AS BLTF_ADD  /* 전금행추가 - 컬럼 */
                         , NVL(A1.RFND_CSH_AK_AMT, 0) AS RFND_CSH_AK_AMT
                         , NVL(A1.RFND_CARD_AK_AMT, 0) AS RFND_CARD_AK_AMT
                         , NVL(A1.CRDCD_FEE_AMT, 0) AS CRDCD_FEE_AMT
                         , NVL(A1.RFND_BLTF_AK_AMT, 0) AS RFND_BLTF_AK_AMT
                         , A1.RFND_AK_NO
                         , NVL(C1.FNIT_CD, C1.CRDCD_FNIT_CD) FNIT_CD
                         , G1.FNIT_NM
                         , NVL(C1.ACNO_ENCR, C1.CRCDNO_ENCR) AC_CR_NO
                         , NVL(NVL(A1.CRDCD_FER, H1.CRDCD_FER), 0) CRDCD_FER
                         , I1.CNTR_CST_NO AS CST_NO
                         , B1.DP_TP_CD
                         , A1.RFND_RSON_CD
                         , A1.RFND_RSON_CN
                         , B1.DP_DV_CD
                         , CASE WHEN B1.DP_DV_CD IN ('1', '3') THEN NVL((SELECT SUM(A2.RVE_AMT)
                                                                           FROM TB_RVDW_RVE_DTL A2
                                                                          WHERE A2.ORRVE_NO = A1.RVE_NO
                                                                            AND A2.ORRVE_SN = A1.RVE_SN
                                                                    ), 0)
                                ELSE 0
                            END RFND_AMT
                      FROM TB_RVDW_RFND_AK_DTL A1 /* 환불요청상세 */
                 LEFT OUTER JOIN TB_RVDW_RVE_DTL B1 /* 수납상세 */
                        ON B1.KW_GRP_CO_CD = A1.KW_GRP_CO_CD
                       AND B1.RVE_NO = A1.RVE_NO
                       AND B1.RVE_SN = A1.RVE_SN
                       AND B1.CNTR_NO = A1.CNTR_NO
                       AND B1.CNTR_SN = A1.CNTR_SN
                       AND B1.DTA_DL_YN = 'N'
                LEFT OUTER JOIN TB_RVDW_ITG_DP_BAS C1 /* 통합입금기본 */
                        ON C1.ITG_DP_NO = B1.ITG_DP_NO
                       AND C1.DTA_DL_YN = 'N'
                       AND C1.ITG_DP_CAN_YN = 'N'
                INNER JOIN TB_SSCT_CNTR_DTL D1 /* 계약상세 */
                        ON D1.CNTR_NO = A1.CNTR_NO
                       AND D1.CNTR_SN = A1.CNTR_SN
                       AND D1.DTA_DL_YN = 'N'
                INNER JOIN TB_SSCT_CNTR_BAS I1 /* 계약기본 */
                        ON I1.CNTR_NO = D1.CNTR_NO
                       AND I1.DTA_DL_YN = 'N'
                LEFT OUTER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ E1 /*월마감*/
                        ON E1.SL_CL_YM = TO_CHAR(SYSDATE , 'YYYYMM')
                       AND E1.CNTR_NO = A1.CNTR_NO
                       AND E1.CNTR_SN = A1.CNTR_SN
                       AND E1.DTA_DL_YN = 'N'
                LEFT OUTER JOIN TB_CBCL_WELLS_BOR_AMT_BAS F1 /*WELLS위약금액기본*/
                        ON F1.PERF_YM = TO_CHAR(SYSDATE ,'YYYYMM')
                       AND F1.CNTR_NO = A1.CNTR_NO
                       AND F1.CNTR_SN = A1.CNTR_SN
                       AND F1.DTA_DL_YN = 'N'
                LEFT OUTER JOIN TB_CBCL_DLQ_BAS G1 /*연체기본*/
                        ON G1.PERF_YM = TO_CHAR(SYSDATE ,'YYYYMM')
                       AND G1.CNTR_NO = A1.CNTR_NO
                       AND G1.CNTR_SN = A1.CNTR_SN
                       AND G1.DTA_DL_YN = 'N'
                LEFT OUTER JOIN TB_RVDW_FNIT_FEE_BAS H1
                        ON H1.KW_GRP_CO_CD = C1.KW_GRP_CO_CD
                       AND H1.FNIT_CD = C1.FNIT_CD
                       AND H1.FNIT_FEE_TP_CD = '2'
                       AND H1.DTA_DL_YN = 'N'
                       AND H1.VL_STRTDT <![CDATA[<=]]> B1.RVE_DT
                       AND H1.VL_ENDDT  <![CDATA[>=]]> B1.RVE_DT
                LEFT OUTER JOIN TB_RVDW_FNIT_CD G1
                        ON G1.FNIT_CD = NVL(C1.FNIT_CD, C1.CRDCD_FNIT_CD)
                       AND G1.FNIT_DV_CD = DECODE(C1.FNIT_CD, NULL, '2', '1')
                     WHERE 1 = 1
                       AND A1.DTA_DL_YN = 'N'
                       AND A1.RFND_AK_NO = #{rfndAkNo}
                      <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                       AND A1.CNTR_NO = #{cntrNo}
                      </if>
                      <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                       AND A1.CNTR_SN = #{cntrSn}
                      </if>
                  ) T1
    </select>

    <!-- 전금상세 - 환불전금요청상세 조회 -->
    <select id="selectRefundBalanceTransfer" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundBalanceTransferRes">
              SELECT RRABD.CNTR_NO
                   , RRABD.CNTR_SN
                   , RRABD.CNTR_NO || RRABD.CNTR_SN AS CNTR_DTL_NO
                   , RRABD.RVE_NO /* 수납코드 */
                   , RRABD.RVE_SN
                   , RRD.DP_DT     /* 입금일자 */
                   , RRD.DP_MES_CD /* 입금수단코드 */
                   , NVL(RRD.DP_AMT, 0) AS DP_AMT /* 입금액 */
                   , RRABD.BLTF_OJ_CNTR_NO
                   , RRABD.BLTF_OJ_CNTR_SN
                   , RRABD.BLTF_OJ_CNTR_NO || RRABD.BLTF_OJ_CNTR_SN AS BLTF_OJ_CNTR_DTL_NO
                   , RRABD.RFND_BLTF_AK_AMT /* 환불전금요청금액 */
                   , SCD.SELL_TP_CD
                   , RRABD.BLTF_RFND_MB_DV_CD
                   , RRABD.RFND_EVID_MTR_FILE_ID
                   , RRABD.RFND_EVID_MTR_FILE_ID ATTH_DOC_ID
                   , (SELECT COUNT(1) FROM T_CMD_ATTH_FILE_D WHERE DEL_YN = 'N' AND TENANT_ID = #{session.tenantId} AND ATTH_DOC_ID = RRABD.RFND_EVID_MTR_FILE_ID) AS ATTH_DOC_ID_NUMBER_OF_FILES
                   , '파일찾기' AS RFND_EVID_MTR_FILE_NM
                   , RRABD.RFND_AK_NO
                   , RRABD.CST_NO
                FROM TB_RVDW_RFND_AK_BLTF_DTL RRABD
           LEFT OUTER JOIN TB_RVDW_RVE_DTL RRD
                  ON RRABD.KW_GRP_CO_CD = RRD.KW_GRP_CO_CD
                 AND RRABD.RVE_NO = RRD.RVE_NO
                 AND RRABD.RVE_SN = RRD.RVE_SN
                 AND RRABD.CNTR_NO = RRD.CNTR_NO
                 AND RRABD.CNTR_SN = RRD.CNTR_SN
                 AND RRD.DTA_DL_YN = 'N'
          INNER JOIN TB_SSCT_CNTR_DTL SCD
                  ON SCD.CNTR_NO = RRD.CNTR_NO
                 AND SCD.CNTR_SN = RRD.CNTR_SN
                 AND SCD.DTA_DL_YN = 'N'
               WHERE 1 = 1
                 AND RRABD.DTA_DL_YN = 'N'
                 AND RRABD.RFND_AK_NO = #{rfndAkNo}
                <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                 AND RRABD.CNTR_NO = #{cntrNo}
                </if>
                <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                 AND RRABD.CNTR_SN = #{cntrSn}
                </if>
    </select>

    <!-- 임시저장 시작 -->
    <select id="selectRefundPk" resultType="java.lang.String">
        SELECT 'RVR'||TO_CHAR(SYSDATE, 'YYYYMMDD')||LPAD(NVL(MAX(SUBSTR(RFND_AK_NO, -9)) + 1, 1), 9, '0') AS RFND_AK_NO
          FROM TB_RVDW_RFND_AK_BAS /* 환불요청기본 */
    </select>

    <insert id="insertRefundTempSave">
         MERGE INTO TB_RVDW_RFND_AK_BAS T1 /* 환불요청기본 */
         USING DUAL
            ON (
               T1.KW_GRP_CO_CD = #{session.companyCode}
           AND T1.RFND_AK_NO = #{rfndAkNo}
               )
          WHEN MATCHED THEN
        UPDATE
           SET T1.ARFND_YN = #{arfndYn}
             , T1.CSH_RFND_FNIT_CD = #{cshRfndFnitCd}
             , T1.CSH_RFND_ACNO_ENCR = #{cshRfndAcnoEncr}
             , T1.CSH_RFND_ACOWN_NM = #{cshRfndAcownNm}
             , T1.RFND_CSH_AK_SUM_AMT = #{rfndCshAkSumAmt}
             , T1.RFND_CARD_AK_SUM_AMT = #{rfndCardAkSumAmt}
             , T1.RFND_BLTF_AK_SUM_AMT = #{rfndBltfAkSumAmt}
             , T1.CRDCD_FEE_SUM_AMT = #{crdcdFeeSumAmt}
             , T1.RFND_AK_STAT_CD = #{rfndAkStatCd}
             , T1.RFND_RVE_DT  =  #{rveDt}
             , T1.RFND_PERF_DT  =  #{perfDt}
             , T1.RFND_DSB_DT  = #{dsbDt}
             , T1.RFND_PROCS_DV_CD = #{rfndProcsDvCd}
             , T1.RFND_PROCS_CN = #{rfndProcsCn}
             , T1.DTA_DL_YN = 'N'
           <include refid="COMMON.updateSystemField" />
         WHEN NOT MATCHED THEN
       INSERT
             (
               KW_GRP_CO_CD
             , RFND_AK_NO
             , RFND_AK_DTM
             , RFND_AK_PRTNR_OG_TP_CD
             , RFND_AK_PRTNR_NO
             , ARFND_YN
             , CSH_RFND_FNIT_CD
             , CSH_RFND_ACNO_ENCR
             , CSH_RFND_ACOWN_NM
             , RFND_CSH_AK_SUM_AMT
             , RFND_CARD_AK_SUM_AMT
             , RFND_BLTF_AK_SUM_AMT
             , CRDCD_FEE_SUM_AMT
             , RFND_AK_STAT_CD
             , RFND_RVE_DT
             , RFND_PERF_DT
             , RFND_DSB_DT
             , RFND_PROCS_DV_CD
             , RFND_PROCS_CN
             , RFND_PROCS_USR_ID
             , RVE_CO_CD
             , DTA_DL_YN            /*데이터삭제여부*/
        <include refid="COMMON.insertSystemField"/>
             ) VALUES (
               #{session.companyCode}
             , #{aftRfndAkNo}
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
             , #{rfndAkPrtnrOgTpCd}
             , #{rfndAkPrtnrNo}
             , #{arfndYn}
             , #{cshRfndFnitCd}
             , #{cshRfndAcnoEncr}
             , #{cshRfndAcownNm}
             , #{rfndCshAkSumAmt}
             , #{rfndCardAkSumAmt}
             , #{rfndBltfAkSumAmt}
             , #{crdcdFeeSumAmt}
             , #{rfndAkStatCd} /* 임시저장:00, 접수:01, 진행중:02, 승인:03, 반려:99 */
             , #{rveDt}
             , #{perfDt}
             , #{dsbDt}
             , #{rfndProcsDvCd}
             , #{rfndProcsCn}
             , #{seesion.userId}
             , #{session.companyCode}
             , 'N'
       <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <insert id="insertRefundTempSaveReqDetail">
        MERGE INTO TB_RVDW_RFND_AK_CNTR_DTL T1
        USING DUAL
           ON (
              T1.KW_GRP_CO_CD = #{session.companyCode}
          AND T1.RFND_AK_NO = #{rfndAkNo}
          AND T1.CNTR_NO = #{cntrNo}
          AND T1.CNTR_SN = #{cntrSn}
              )
         WHEN NOT MATCHED THEN
        INSERT
             (
               KW_GRP_CO_CD
             , RFND_AK_NO
             , CNTR_NO
             , CNTR_SN
             , CST_NO
             , DTA_DL_YN
           <include refid="COMMON.insertSystemField"/>
             ) VALUES (
               '2000' /* WELLS*/
             , #{aftRfndAkNo}
             , #{cntrNo}
             , #{cntrSn}
             , #{cstNo}
             , 'N'
           <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <insert id="insertRefundTempSaveDetail">
        MERGE INTO TB_RVDW_RFND_AK_DTL T1 /* 환불요청상세 */
        USING DUAL
           ON (
              T1.KW_GRP_CO_CD = #{session.companyCode}
          AND T1.RFND_AK_NO = #{rfndAkNo}
          AND T1.RVE_NO = #{rveNo}
          AND T1.RVE_SN = #{rveSn}
              )
         WHEN MATCHED THEN
       UPDATE
          SET T1.RFND_CSH_AK_AMT = NVL(#{rfndCshAkAmt}, 0) - NVL(#{crdcdFeeAmt}, 0)
            , T1.RFND_CARD_AK_AMT = #{rfndCardAkAmt}
            , T1.CRDCD_FEE_AMT = #{crdcdFeeAmt}
            , T1.RFND_BLTF_AK_AMT = #{rfndBltfAkAmt}
            , T1.RFND_RSON_CD = #{rfndRsonCd}
            , T1.RFND_RSON_CN = #{rfndRsonCn}
           <include refid="COMMON.updateSystemField" />
        WHEN NOT MATCHED THEN
      INSERT
           (
             KW_GRP_CO_CD
           , RFND_AK_NO
           , CNTR_NO
           , CNTR_SN
           , RVE_NO
           , RVE_SN
           , CST_NO
           , RFND_CSH_AK_AMT
           , RFND_CARD_AK_AMT
           , CRDCD_FEE_AMT
           , CRDCD_FER
           , RFND_BLTF_AK_AMT
           , RFND_RSON_CD
           , RFND_RSON_CN
           , DTA_DL_YN
           <include refid="COMMON.insertSystemField"/>
           ) VALUES (
             '2000'
           , #{aftRfndAkNo}
           , #{cntrNo}
           , #{cntrSn}
           , #{rveNo}
           , #{rveSn}
           , #{cstNo}
           , NVL(#{rfndCshAkAmt}, 0) - NVL(#{crdcdFeeAmt}, 0)
           , #{rfndCardAkAmt}
           , #{crdcdFeeAmt}
           , #{crdcdFer}
           , #{rfndBltfAkAmt}
           , #{rfndRsonCd}
           , #{rfndRsonCn}
           , 'N'
           <include refid="COMMON.insertSystemFieldValue"/>
           )
    </insert>

    <insert id="insertBalanceTempSaveDetail">
        MERGE INTO TB_RVDW_RFND_AK_BLTF_DTL T1 /* 전금요청상세 */
        USING DUAL
           ON (
              T1.KW_GRP_CO_CD = #{session.companyCode}
          AND T1.RFND_AK_NO = #{rfndAkNo}
          AND T1.CNTR_NO = #{cntrNo}
          AND T1.CNTR_SN = #{cntrSn}
          AND T1.RVE_NO = #{rveNo}
          AND T1.RVE_SN = #{rveSn}
          AND T1.BLTF_OJ_CNTR_NO = #{bltfOjCntrNo}
          AND T1.BLTF_OJ_CNTR_SN = #{bltfOjCntrSn}
              )
         WHEN MATCHED THEN
       UPDATE
          SET T1.RFND_BLTF_AK_AMT = #{rfndBltfAkAmt}
            , T1.BLTF_RFND_MB_DV_CD = #{bltfRfndMbDvCd}
            , T1.RFND_EVID_MTR_FILE_ID = #{rfndEvidMtrFileId}
            , T1.DTA_DL_YN = 'N' /* 조건없으면 수정하더라도 삭제하면 데이터가 안보임.*/
           <include refid="COMMON.updateSystemField" />
        WHEN NOT MATCHED THEN
      INSERT
           (
             KW_GRP_CO_CD
           , RFND_AK_NO
           , CNTR_NO
           , CNTR_SN
           , RVE_NO
           , RVE_SN
           , BLTF_OJ_CNTR_NO
           , BLTF_OJ_CNTR_SN
           , CST_NO
           , RFND_BLTF_AK_AMT
           , BLTF_RFND_DV_CD
           , BLTF_RFND_TP_CD
           , BLTF_RFND_MB_DV_CD
           , RFND_EVID_MTR_FILE_ID
           , DTA_DL_YN
           <include refid="COMMON.insertSystemField"/>
           ) VALUES (
             #{session.companyCode}
           , #{rfndAkNo} /* 행추가시 rfndAkNo는 항상있으므로 재채번할필요없음. */
           , #{cntrNo}
           , #{cntrSn}
           , #{rveNo}
           , #{rveSn}
           , #{bltfOjCntrNo}
           , #{bltfOjCntrSn}
           , #{cstNo}
           , #{rfndBltfAkAmt}
           , '01' /* 전금환불구분코드. 01:카드 , 02: 현금 */
           , '1' /* 전금환불유형코드. 1:인수금 2:할부금 */
           , #{bltfRfndMbDvCd}
           , #{rfndEvidMtrFileId}
           , 'N'
           <include refid="COMMON.insertSystemFieldValue"/>
           )
    </insert>
    <!-- 임시저장 종료-->

    <update id="deleteBalanceTempSaveDetail">
        UPDATE TB_RVDW_RFND_AK_BLTF_DTL /* 전금요청상세 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND RFND_AK_NO = #{rfndAkNo}
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND DTA_DL_YN = 'N'
    </update>

    <!-- 삭제 -->
    <update id="deleteRefundBase">
        UPDATE TB_RVDW_RFND_AK_BAS /* 환불요청기본 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND RFND_AK_NO = #{rfndAkNo}
           AND DTA_DL_YN = 'N'
    </update>
    <update id="deleteRefundCntrDetail">
        UPDATE TB_RVDW_RFND_AK_CNTR_DTL /* 환불요청계약상세 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND RFND_AK_NO = #{rfndAkNo}
           AND DTA_DL_YN = 'N'
    </update>
    <update id="deleteRefundDetail">
        UPDATE TB_RVDW_RFND_AK_DTL /* 환불요청상세 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND RFND_AK_NO = #{rfndAkNo}
           AND DTA_DL_YN = 'N'
    </update>
    <update id="deleteRefundBalanceDetail">
        UPDATE TB_RVDW_RFND_AK_BLTF_DTL /* 전금요청상세 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND RFND_AK_NO = #{rfndAkNo}
           AND DTA_DL_YN = 'N'
    </update>

    <select id="selectRefundApplicationConnectHistory" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundApplicationConnectHistoryRes">
        SELECT CTT_RCP_DTM              /* 컨택일시 */
             , CTT_CHNL_TP_CD           /* 상담경로 */
             , ( SELECT PRTNR_KNM
                   FROM TB_OGBS_PRTNR_BAS
                  WHERE PRTNR_NO = CTT_PSIC_ID
               ) AS PRTNR_KNM              /* 상담자 */
             , CTT_PSIC_ID              /* 번호 */
             , CTT_MO_CN                /* 상담내용 */
          FROM TB_SSOP_CTT_BAS          /* 컨택기본 */
         WHERE CNTR_NO = #{cntrNo}      /* 계약번호*/
    </select>

    <insert id="insertRefundReceiptBaseCash"> <!--현금-->
        INSERT INTO TB_RVDW_RFND_RCP_BAS (
               KW_GRP_CO_CD	/*교원그룹회사코드*/
        	 , RFND_RCP_NO	/*환불접수번호*/
        	 , RVE_CO_CD	/*수납회사코드*/
        	 , CST_NO	/*고객번호*/
        	 , CNTR_NO	/*계약번호*/
        	 , CNTR_SN	/*계약일련번호*/
        	 , CNTR_CH_RCP_ID	/*계약변경접수ID*/
        	 , CNTR_CH_SN	/*계약변경일련번호*/
        	 , RFND_RCP_OG_TP_CD	/*환불접수조직유형코드*/
        	 , RFND_RCP_PRTNR_NO	/*환불접수파트너번호*/
        	 , RFND_RCP_PH_CD	/*환불접수경로코드*/
        	 , RFND_RQDT	/*환불요청일자*/
        	 , RFND_FSH_DT	/*환불완료일자*/
        	 , RTNGD_FSH_DT	/*반품완료일자*/
        	 , CST_SV_ASN_NO	/*고객서비스배정번호*/
        	 , RFND_CSH_AMT	/*환불현금금액*/
        	 , RFND_CARD_AMT	/*환불카드금액*/
        	 , RFND_BLTF_AMT	/*환불전금금액*/
        	 , RFND_DDTN_AMT	/*환불공제금액*/
        	 , RFND_FEE_AMT	/*환불수수료금액*/
        	 , RFND_PSB_RES_AMT	/*환불가능잔여금액*/
        	 , TOT_RFND_ET_AMT	/*총환불예상금액*/
        	 , EX_RFND_RSON_CN	/*예외환불사유내용*/
        	 , RFND_STAT_CD	/*환불상태코드*/
        	 , RFND_RVE_DT	/*환불수납일자*/
        	 , RFND_PERF_DT	/*환불실적일자*/
        	 , RFND_DSB_DT	/*환불지급일자*/
        	 , RFND_PROCS_CN	/*환불처리내용*/
        	 , RFND_PSIC_OPN_CN	/*환불담당자의견내용*/
        	 , RFND_PSIC_RJ_RSON_CN	/*환불담당자반려사유내용*/
        	 , RFND_PROCS_USR_ID	/*환불처리사용자ID*/
             <include refid="COMMON.insertSystemField"/>
        )
        SELECT T1.KW_GRP_CO_CD												    /*교원그룹회사코드*/
             , #{rfndRcpNo}                          AS RFND_RCP_NO	            /*환불접수번호*/
             , T1.RVE_CO_CD	                                                    /*수납회사코드*/
             , T2.CST_NO	                                                    /*고객번호*/
             , T2.CNTR_NO	                                                    /*계약번호*/
             , T2.CNTR_SN	                                                    /*계약일련번호*/
             , T3.CNTR_CH_RCP_ID                     AS CNTR_CH_RCP_ID	        /*계약변경접수ID*/
             , T3.CNTR_CH_SN                         AS CNTR_CH_SN	            /*계약변경일련번호*/
             , T1.RFND_AK_PRTNR_OG_TP_CD             AS RFND_RCP_OG_TP_CD	    /*환불접수조직유형코드*/
             , T1.RFND_AK_PRTNR_NO                   AS RFND_RCP_PRTNR_NO	    /*환불접수파트너번호*/
             , #{rfndRcpPhCd}                        AS RFND_RCP_PH_CD	        /*환불접수경로코드*/
             , SUBSTR(T1.RFND_AK_DTM , 0 , 8)        AS RFND_RQDT	            /*환불요청일자*/
             , #{rfndDsbDuedt}                       AS RFND_FSH_DT	            /*환불완료일자*/
             , NULL                                  AS RTNGD_FSH_DT	        /*반품완료일자*/
             , NULL                                  AS CST_SV_ASN_NO	        /*고객서비스배정번호*/
             , T2.RFND_CSH_AK_AMT                    AS RFND_CSH_AMT	        /*환불현금금액*/
             , 0                                     AS RFND_CARD_AMT	        /*환불카드금액*/
             , 0                                     AS RFND_BLTF_AMT	        /*환불전금금액*/
             , 0                                     AS RFND_DDTN_AMT	        /*환불공제금액*/
             , T2.CRDCD_FEE_AMT                      AS RFND_FEE_AMT	        /*환불수수료금액*/
             , 0                                     AS RFND_PSB_RES_AMT	    /*환불가능잔여금액*/
             , T2.RFND_CSH_AK_AMT                    AS TOT_RFND_ET_AMT	        /*총환불예상금액*/
             , NULL                                  AS EX_RFND_RSON_CN	        /*예외환불사유내용*/
             , '01'                                  AS RFND_STAT_CD	        /*환불상태코드*/
             , #{rfndRveDt}                          AS RFND_RVE_DT	            /*환불수납일자*/
             , #{rfndPerfDt}                         AS RFND_PERF_DT	        /*환불실적일자*/
             , #{rfndDsbDt}                          AS RFND_DSB_DT	            /*환불지급일자*/
             , #{rfndProcsCn}                        AS RFND_PROCS_CN	        /*환불처리내용*/
             , NULL                                  AS RFND_PSIC_OPN_CN	    /*환불담당자의견내용*/
             , NULL                                  AS RFND_PSIC_RJ_RSON_CN	/*환불담당자반려사유내용*/
             , #{session.userId}                     AS RFND_PROCS_USR_ID	    /*환불처리사용자ID*/
             <include refid="COMMON.insertSystemFieldValue"/>
           FROM TB_RVDW_RFND_AK_BAS     T1
     INNER JOIN TB_RVDW_RFND_AK_DTL T2
             ON (    T2.KW_GRP_CO_CD = T1.KW_GRP_CO_CD
                 AND T2.RFND_AK_NO   = T1.RFND_AK_NO
                 AND T2.DTA_DL_YN    = 'N')
     INNER JOIN TB_SSCT_CNTR_DTL    T3
             ON (    T3.CNTR_NO      = T2.CNTR_NO
                 AND T3.CNTR_SN      = T2.CNTR_SN
                 AND T3.DTA_DL_YN    = 'N')
          WHERE 1 = 1
            AND T1.KW_GRP_CO_CD          = #{session.companyCode}
            AND T1.RFND_AK_NO            = #{rfndAkNo}
            AND T2.RFND_CSH_AK_AMT       >  0
            AND T1.DTA_DL_YN             = 'N'
            AND T2.CNTR_NO               = #{cntrNo}
            AND T2.CNTR_SN               = #{cntrSn}
            AND T2.RVE_NO                = #{rveNo}
            AND T2.RVE_SN                = #{rveSn}
    </insert>

    <insert id="insertRefundReceiptBaseCard"> <!--신용카드-->
        INSERT INTO TB_RVDW_RFND_RCP_BAS (
               KW_GRP_CO_CD	/*교원그룹회사코드*/
        	 , RFND_RCP_NO	/*환불접수번호*/
        	 , RVE_CO_CD	/*수납회사코드*/
        	 , CST_NO	/*고객번호*/
        	 , CNTR_NO	/*계약번호*/
        	 , CNTR_SN	/*계약일련번호*/
        	 , CNTR_CH_RCP_ID	/*계약변경접수ID*/
        	 , CNTR_CH_SN	/*계약변경일련번호*/
        	 , RFND_RCP_OG_TP_CD	/*환불접수조직유형코드*/
        	 , RFND_RCP_PRTNR_NO	/*환불접수파트너번호*/
        	 , RFND_RCP_PH_CD	/*환불접수경로코드*/
        	 , RFND_RQDT	/*환불요청일자*/
        	 , RFND_FSH_DT	/*환불완료일자*/
        	 , RTNGD_FSH_DT	/*반품완료일자*/
        	 , CST_SV_ASN_NO	/*고객서비스배정번호*/
        	 , RFND_CSH_AMT	/*환불현금금액*/
        	 , RFND_CARD_AMT	/*환불카드금액*/
        	 , RFND_BLTF_AMT	/*환불전금금액*/
        	 , RFND_DDTN_AMT	/*환불공제금액*/
        	 , RFND_FEE_AMT	/*환불수수료금액*/
        	 , RFND_PSB_RES_AMT	/*환불가능잔여금액*/
        	 , TOT_RFND_ET_AMT	/*총환불예상금액*/
        	 , EX_RFND_RSON_CN	/*예외환불사유내용*/
        	 , RFND_STAT_CD	/*환불상태코드*/
        	 , RFND_RVE_DT	/*환불수납일자*/
        	 , RFND_PERF_DT	/*환불실적일자*/
        	 , RFND_DSB_DT	/*환불지급일자*/
        	 , RFND_PROCS_CN	/*환불처리내용*/
        	 , RFND_PSIC_OPN_CN	/*환불담당자의견내용*/
        	 , RFND_PSIC_RJ_RSON_CN	/*환불담당자반려사유내용*/
        	 , RFND_PROCS_USR_ID	/*환불처리사용자ID*/
             <include refid="COMMON.insertSystemField"/>
             )
        SELECT T1.KW_GRP_CO_CD												    /*교원그룹회사코드*/
             , #{rfndRcpNo}                          AS RFND_RCP_NO	            /*환불접수번호*/
             , T1.RVE_CO_CD	                                                    /*수납회사코드*/
             , T2.CST_NO	                                                    /*고객번호*/
             , T2.CNTR_NO	                                                    /*계약번호*/
             , T2.CNTR_SN	                                                    /*계약일련번호*/
             , T3.CNTR_CH_RCP_ID                      AS CNTR_CH_RCP_ID	        /*계약변경접수ID*/
             , T3.CNTR_CH_SN                          AS CNTR_CH_SN	            /*계약변경일련번호*/
             , T1.RFND_AK_PRTNR_OG_TP_CD              AS RFND_RCP_OG_TP_CD	    /*환불접수조직유형코드*/
             , T1.RFND_AK_PRTNR_NO                    AS RFND_RCP_PRTNR_NO	    /*환불접수파트너번호*/
             , #{rfndRcpPhCd}                         AS RFND_RCP_PH_CD	        /*환불접수경로코드*/
             , SUBSTR(T1.RFND_AK_DTM , 0 , 8)         AS RFND_RQDT	            /*환불요청일자*/
             , #{rfndDsbDuedt}                        AS RFND_FSH_DT	        /*환불완료일자*/
             , NULL                                   AS RTNGD_FSH_DT	        /*반품완료일자*/
             , NULL                                   AS CST_SV_ASN_NO	        /*고객서비스배정번호*/
             , 0                                      AS RFND_CSH_AMT	        /*환불현금금액*/
             , T2.RFND_CARD_AK_AMT                    AS RFND_CARD_AMT	        /*환불카드금액*/
             , 0                                      AS RFND_BLTF_AMT	        /*환불전금금액*/
             , 0                                      AS RFND_DDTN_AMT	        /*환불공제금액*/
             , 0                                      AS RFND_FEE_AMT	        /*환불수수료금액*/
             , 0                                      AS RFND_PSB_RES_AMT	    /*환불가능잔여금액*/
             , T2.RFND_CARD_AK_AMT                    AS TOT_RFND_ET_AMT	    /*총환불예상금액*/
             , NULL                                   AS EX_RFND_RSON_CN	    /*예외환불사유내용*/
             , '01'                                   AS RFND_STAT_CD	        /*환불상태코드*/
             , #{rfndRveDt}                          AS RFND_RVE_DT	            /*환불수납일자*/
             , #{rfndPerfDt}                         AS RFND_PERF_DT	        /*환불실적일자*/
             , #{rfndDsbDt}                          AS RFND_DSB_DT	            /*환불지급일자*/
             , #{rfndProcsCn}                        AS RFND_PROCS_CN	        /*환불처리내용*/
             , NULL                                  AS RFND_PSIC_OPN_CN	    /*환불담당자의견내용*/
             , NULL                                  AS RFND_PSIC_RJ_RSON_CN	/*환불담당자반려사유내용*/
             , #{session.userId}                     AS RFND_PROCS_USR_ID	    /*환불처리사용자ID*/
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_RVDW_RFND_AK_BAS T1
    INNER JOIN TB_RVDW_RFND_AK_DTL T2
            ON (    T2.KW_GRP_CO_CD = T1.KW_GRP_CO_CD
                AND T2.RFND_AK_NO   = T1.RFND_AK_NO
                AND T2.DTA_DL_YN    = 'N')
    INNER JOIN TB_SSCT_CNTR_DTL T3
            ON (    T3.CNTR_NO      = T2.CNTR_NO
                AND T3.CNTR_SN      = T2.CNTR_SN
                AND T3.DTA_DL_YN    = 'N')
         WHERE 1 = 1
           AND T1.KW_GRP_CO_CD          = #{session.companyCode}
           AND T1.RFND_AK_NO            = #{rfndAkNo}
           AND T1.DTA_DL_YN             = 'N'
           AND T2.RFND_CARD_AK_AMT      > 0
           AND T2.CNTR_NO               = #{cntrNo}
           AND T2.CNTR_SN               = #{cntrSn}
           AND T2.RVE_NO                = #{rveNo}
           AND T2.RVE_SN                = #{rveSn}
    </insert>

    <insert id="insertRefundReceiptBaseBltf"> <!--전금-->
        INSERT INTO TB_RVDW_RFND_RCP_BAS (
               KW_GRP_CO_CD	/*교원그룹회사코드*/
        	 , RFND_RCP_NO	/*환불접수번호*/
        	 , RVE_CO_CD	/*수납회사코드*/
        	 , CST_NO	/*고객번호*/
        	 , CNTR_NO	/*계약번호*/
        	 , CNTR_SN	/*계약일련번호*/
        	 , CNTR_CH_RCP_ID	/*계약변경접수ID*/
        	 , CNTR_CH_SN	/*계약변경일련번호*/
        	 , RFND_RCP_OG_TP_CD	/*환불접수조직유형코드*/
        	 , RFND_RCP_PRTNR_NO	/*환불접수파트너번호*/
        	 , RFND_RCP_PH_CD	/*환불접수경로코드*/
        	 , RFND_RQDT	/*환불요청일자*/
        	 , RFND_FSH_DT	/*환불완료일자*/
        	 , RTNGD_FSH_DT	/*반품완료일자*/
        	 , CST_SV_ASN_NO	/*고객서비스배정번호*/
        	 , RFND_CSH_AMT	/*환불현금금액*/
        	 , RFND_CARD_AMT	/*환불카드금액*/
        	 , RFND_BLTF_AMT	/*환불전금금액*/
        	 , RFND_DDTN_AMT	/*환불공제금액*/
        	 , RFND_FEE_AMT	/*환불수수료금액*/
        	 , RFND_PSB_RES_AMT	/*환불가능잔여금액*/
        	 , TOT_RFND_ET_AMT	/*총환불예상금액*/
        	 , EX_RFND_RSON_CN	/*예외환불사유내용*/
        	 , RFND_STAT_CD	/*환불상태코드*/
        	 , RFND_RVE_DT	/*환불수납일자*/
        	 , RFND_PERF_DT	/*환불실적일자*/
        	 , RFND_DSB_DT	/*환불지급일자*/
        	 , RFND_PROCS_CN	/*환불처리내용*/
        	 , RFND_PSIC_OPN_CN	/*환불담당자의견내용*/
        	 , RFND_PSIC_RJ_RSON_CN	/*환불담당자반려사유내용*/
        	 , RFND_PROCS_USR_ID	/*환불처리사용자ID*/
             <include refid="COMMON.insertSystemField"/>
             )
        SELECT T1.KW_GRP_CO_CD												    /*교원그룹회사코드*/
             , #{rfndRcpNo}                           AS RFND_RCP_NO	            /*환불접수번호*/
             , T1.RVE_CO_CD	                                                    /*수납회사코드*/
             , T2.CST_NO	                                                    /*고객번호*/
             , T2.CNTR_NO	                                                    /*계약번호*/
             , T2.CNTR_SN	                                                    /*계약일련번호*/
             , T3.CNTR_CH_RCP_ID                      AS CNTR_CH_RCP_ID	        /*계약변경접수ID*/
             , T3.CNTR_CH_SN                          AS CNTR_CH_SN	            /*계약변경일련번호*/
             , T1.RFND_AK_PRTNR_OG_TP_CD              AS RFND_RCP_OG_TP_CD	    /*환불접수조직유형코드*/
             , T1.RFND_AK_PRTNR_NO                    AS RFND_RCP_PRTNR_NO	    /*환불접수파트너번호*/
             , NULL                                   AS RFND_RCP_PH_CD	        /*환불접수경로코드*/
             , SUBSTR(T1.RFND_AK_DTM , 0 , 8)         AS RFND_RQDT	            /*환불요청일자*/
             , #{rfndDsbDt}                           AS RFND_FSH_DT	        /*환불완료일자*/
             , NULL                                   AS RTNGD_FSH_DT	        /*반품완료일자*/
             , NULL                                   AS CST_SV_ASN_NO	        /*고객서비스배정번호*/
             , 0                                      AS RFND_CSH_AMT	        /*환불현금금액*/
             , 0                                      AS RFND_CARD_AMT	        /*환불카드금액*/
             , T2.RFND_BLTF_AK_AMT                    AS RFND_BLTF_AMT	        /*환불전금금액*/
             , 0                                      AS RFND_DDTN_AMT	        /*환불공제금액*/
             , 0                                      AS RFND_FEE_AMT	        /*환불수수료금액*/
             , 0                                      AS RFND_PSB_RES_AMT	    /*환불가능잔여금액*/
             , T2.RFND_BLTF_AK_AMT                    AS TOT_RFND_ET_AMT	    /*총환불예상금액*/
             , NULL                                   AS EX_RFND_RSON_CN	    /*예외환불사유내용*/
             , '01'                                   AS RFND_STAT_CD	        /*환불상태코드*/
             , #{rfndRveDt}                           AS RFND_RVE_DT	        /*환불수납일자*/
             , #{rfndPerfDt}                          AS RFND_PERF_DT	        /*환불실적일자*/
             , #{rfndDsbDt}                           AS RFND_DSB_DT	        /*환불지급일자*/
             , #{rfndProcsCn}                         AS RFND_PROCS_CN	        /*환불처리내용*/
             , NULL                                   AS RFND_PSIC_OPN_CN	    /*환불담당자의견내용*/
             , NULL                                   AS RFND_PSIC_RJ_RSON_CN	/*환불담당자반려사유내용*/
             , #{session.userId}                      AS RFND_PROCS_USR_ID	    /*환불처리사용자ID*/
             <include refid="COMMON.insertSystemFieldValue"/>
           FROM TB_RVDW_RFND_AK_BAS T1
     INNER JOIN TB_RVDW_RFND_AK_DTL T2
             ON (    T2.KW_GRP_CO_CD = T1.KW_GRP_CO_CD
                 AND T2.RFND_AK_NO   = T1.RFND_AK_NO
                 AND T2.DTA_DL_YN    = 'N')
     INNER JOIN TB_SSCT_CNTR_DTL    T3
             ON (    T3.CNTR_NO      = T2.CNTR_NO
                 AND T3.CNTR_SN      = T2.CNTR_SN
                 AND T3.DTA_DL_YN    = 'N')
          WHERE 1 = 1
           AND T1.KW_GRP_CO_CD          = #{session.companyCode}
           AND T1.RFND_AK_NO            = #{rfndAkNo}
           AND T1.DTA_DL_YN             = 'N'
           AND T2.RFND_BLTF_AK_AMT      > 0
           AND T2.CNTR_NO               = #{cntrNo}
           AND T2.CNTR_SN               = #{cntrSn}
           AND T2.RVE_NO                = #{rveNo}
           AND T2.RVE_SN                = #{rveSn}
    </insert>

    <insert id="insertRefundReceiptDtlCash">
        INSERT INTO TB_RVDW_RFND_RCP_DTL ( <!--현금-->
        	   KW_GRP_CO_CD					/*교원그룹회사코드*/
        	 , RFND_RCP_NO	/*환불접수번호*/
        	 , RFND_RCP_DTL_SN	/*환불접수상세일련번호*/
        	 , RFND_TP_CD	/*환불유형코드*/
        	 , RFND_DV_CD	/*환불구분코드*/
        	 , RFND_DP_KND_CD	/*환불입금종류코드*/
        	 , RFND_DSB_DV_CD	/*환불지급구분코드*/
        	 , CSH_RFND_DV_CD	/*현금환불구분코드*/
        	 , RFND_AC_DV_CD	/*환불계좌구분코드*/
        	 , RFND_RNTF_EXST_YN	/*환불손료존재여부*/
        	 , CSH_RFND_FNIT_CD	/*현금환불금융기관코드*/
        	 , CSH_RFND_ACNO_ENCR	/*현금환불계좌번호암호화*/
        	 , CSH_RFND_ACOWN_NM	/*현금환불계좌주명*/
        	 , CSH_RFND_ADRS_DV_CD	/*현금환불수취인구분코드*/
        	 , CSH_RFND_DLGPS_NM	/*현금환불대표자명*/
        	 , CARD_RFND_FNIT_CD	/*카드환불금융기관코드*/
        	 , CARD_RFND_CRDCD_APR_STRT_DT	/*카드환불신용카드승인시작일자*/
        	 , CARD_RFND_CRDCD_APR_END_DT	/*카드환불신용카드승인종료일자*/
        	 , CARD_RFND_CRCDNO_ENCR	/*카드환불신용카드번호암호화*/
        	 , CARD_RFND_CRDCD_ISTM_MCN	/*카드환불신용카드할부개월수*/
        	 , CARD_RFND_CRCDONR_NM	/*카드환불신용카드주명*/
        	 , CARD_RFND_CRDCD_APRNO	/*카드환불신용카드승인번호*/
        	 , CARD_RFND_CRDCD_APR_AMT	/*카드환불신용카드승인금액*/
        	 , CARD_RFND_FEE	/*카드환불수수료*/
        	 , CARD_RFND_FER	/*카드환불수수료율*/
        	 , BLTF_RFND_DV_CD	/*전금환불구분코드*/
        	 , BLTF_RFND_TP_CD	/*전금환불유형코드*/
        	 , BLTF_RFND_MB_DV_CD	/*전금환불회원구분코드*/
        	 , BLTF_OJ_CNTR_NO	/*전금대상계약번호*/
        	 , BLTF_OJ_CNTR_SN	/*전금대상계약일련번호*/
        	 , BLTF_BF_VAC_NO_ENCR	/*전금이전가상계좌번호암호화*/
        	 , BLTF_AF_VAC_NO_ENCR	/*전금이후가상계좌번호암호화*/
        	 , KMBRSP_RFND_AK_AMT   /*K멤버스포인트환불요청금액*/
        	 , KMBRSM_RFND_AK_AMT	/*K멤버스머니환불요청금액*/
        	 , KMBRSC_RFND_AK_AMT	/*K멤버스캐시환불요청금액*/
        	 , SMTML_RFND_AK_AMT	/*스마트마일리지환불요청금액*/
        	 , ACTML_RFND_AK_AMT	/*활동마일리지환불요청금액*/
        	 , ETC_RFND_TP_CD	/*기타환불유형코드*/
        	 , ETC_RFND_RQR_NM	/*기타환불요청자명*/
        	 , RFND_AK_AMT	/*환불요청금액*/
        	 , RFND_DDTN_AMT	/*환불공제금액*/
        	 , RFND_RSON_CD	/*환불사유코드*/
        	 , RFND_RSON_CN	/*환불사유내용*/
        	 , RFND_EXP_AMT	/*환불예정금액*/
        	 , RFND_FSH_DT	/*환불완료일자*/
        	 , RFND_DSB_AMT	/*환불지급금액*/
        	 , RFND_DSB_DUEDT	/*환불지급예정일자*/
        	 , RFND_PSP_DC	/*환불지연일수*/
        	 , RFND_DSB_PSP_INT	/*환불지급지연이자*/
        	 , RFND_SLIP_CRT_DT	/*환불전표생성일자*/
        	 , RFND_SLPNO	/*환불전표번호*/
        	 , MLG_TP_CD	/*마일리지유형코드*/
        	 , MLG_RV_NO	/*마일리지적립번호*/
        	 , ITG_DP_NO	/*통합입금번호*/
        	 , RVE_NO	/*수납번호*/
        	 , PY_AMT	/*납입금액*/
        	 , DLQ_AMT	/*연체금액*/
        	 , BOR_AMT	/*위약금액*/
        	 , RFND_EVID_MTR_FILE_ID	/*환불증빙자료파일ID*/
        	 , DPRCP_MTR_FILE_ID	/*입금증자료파일ID*/
        	 , POFAT_MTR_FILE_ID	/*위임장자료파일ID*/
        	 , IDF_MTR_FILE_ID	/*신분증자료파일ID*/
        	 , FML_REL_CRTFD_FILE_ID	/*가족관계증명서파일ID*/
             <include refid="COMMON.insertSystemField"/>
             )
        SELECT T1.KW_GRP_CO_CD					                                /*교원그룹회사코드*/
        	 , #{rfndRcpNo}                           AS RFND_RCP_NO	        /*환불접수번호*/
        	 , (SELECT NVL(MAX(RFND_RCP_DTL_SN) , 0) + 1
        	         	      FROM TB_RVDW_RFND_RCP_DTL
        	         	     WHERE KW_GRP_CO_CD = #{kwGrpCoCd}
        	         		   AND RFND_RCP_NO  = #{rfndRcpNo})	AS RFND_RCP_DTL_SN /*환불접수상세일련번호*/
        	 , '01'                                   AS RFND_TP_CD             /*환불유형코드*/
        	 , '02'                                   AS RFND_DV_CD	            /*환불구분코드*/
        	 , ''                                     AS RFND_DP_KND_CD	        /*환불입금종류코드*/
        	 , '01'                                   AS RFND_DSB_DV_CD	        /*환불지급구분코드*/
        	 , '03'                                   AS CSH_RFND_DV_CD	        /*현금환불구분코드*/
        	 , '02'                                   AS RFND_AC_DV_CD	        /*환불계좌구분코드*/
        	 , NULL                                   AS RFND_RNTF_EXST_YN	    /*환불손료존재여부*/
        	 , T1.CSH_RFND_FNIT_CD                    AS CSH_RFND_FNIT_CD	    /*현금환불금융기관코드*/
        	 , T1.CSH_RFND_ACNO_ENCR                  AS CSH_RFND_ACNO_ENCR	    /*현금환불계좌번호암호화*/
        	 , T1.CSH_RFND_ACOWN_NM                   AS CSH_RFND_ACOWN_NM	    /*현금환불계좌주명*/
        	 , '01'                                   AS CSH_RFND_ADRS_DV_CD	/*현금환불수취인구분코드*/
        	 , NULL                                   AS CSH_RFND_DLGPS_NM	    /*현금환불대표자명*/
        	 , NULL                                   AS CARD_RFND_FNIT_CD	/*카드환불금융기관코드*/
        	 , NULL                                   AS CARD_RFND_CRDCD_APR_STRT_DT	/*카드환불신용카드승인시작일자*/
        	 , NULL                                   AS CARD_RFND_CRDCD_APR_END_DT	/*카드환불신용카드승인종료일자*/
        	 , NULL                                   AS CARD_RFND_CRCDNO_ENCR	/*카드환불신용카드번호암호화*/
        	 , NULL                                   AS CARD_RFND_CRDCD_ISTM_MCN	/*카드환불신용카드할부개월수*/
        	 , NULL                                   AS CARD_RFND_CRCDONR_NM	/*카드환불신용카드주명*/
        	 , NULL                                   AS CARD_RFND_CRDCD_APRNO	/*카드환불신용카드승인번호*/
        	 , NULL                                   AS CARD_RFND_CRDCD_APR_AMT	/*카드환불신용카드승인금액*/
        	 , T2.CRDCD_FEE_AMT                       AS CARD_RFND_FEE	/*카드환불수수료*/
        	 , T2.CRDCD_FER                           AS CARD_RFND_FER	/*카드환불수수료율*/
        	 , NULL                                   AS BLTF_RFND_DV_CD	/*전금환불구분코드*/
        	 , NULL                                   AS BLTF_RFND_TP_CD	/*전금환불유형코드*/
        	 , NULL                                   AS BLTF_RFND_MB_DV_CD	/*전금환불회원구분코드*/
        	 , NULL                                   AS BLTF_OJ_CNTR_NO	/*전금대상계약번호*/
        	 , NULL                                   AS BLTF_OJ_CNTR_SN	/*전금대상계약일련번호*/
        	 , NULL                                   AS BLTF_BF_VAC_NO_ENCR	/*전금이전가상계좌번호암호화*/
        	 , NULL                                   AS BLTF_AF_VAC_NO_ENCR	/*전금이후가상계좌번호암호화*/
        	 , NULL                                   AS KMBRSP_RFND_AK_AMT   /*K멤버스포인트환불요청금액*/
        	 , NULL                                   AS KMBRSM_RFND_AK_AMT	/*K멤버스머니환불요청금액*/
        	 , NULL                                   AS KMBRSC_RFND_AK_AMT	/*K멤버스캐시환불요청금액*/
        	 , NULL                                   AS SMTML_RFND_AK_AMT	/*스마트마일리지환불요청금액*/
        	 , NULL                                   AS ACTML_RFND_AK_AMT	/*활동마일리지환불요청금액*/
        	 , NULL                                   AS ETC_RFND_TP_CD	/*기타환불유형코드*/
        	 , NULL                                   AS ETC_RFND_RQR_NM	/*기타환불요청자명*/
        	 , T2.RFND_CSH_AK_AMT                     AS RFND_AK_AMT	/*환불요청금액*/
        	 , NULL                                   AS RFND_DDTN_AMT	/*환불공제금액*/
        	 , T2.RFND_RSON_CD                        AS RFND_RSON_CD	/*환불사유코드*/
        	 , T2.RFND_RSON_CN                        AS RFND_RSON_CN	/*환불사유내용*/
        	 , T2.RFND_CSH_AK_AMT                     AS RFND_EXP_AMT	/*환불예정금액*/
        	 , #{rfndDsbDuedt}                        AS RFND_FSH_DT	/*환불완료일자*/
        	 , T2.RFND_CSH_AK_AMT                     AS RFND_DSB_AMT	/*환불지급금액*/
        	 , #{rfndDsbDuedt}                        AS RFND_DSB_DUEDT	/*환불지급예정일자*/
        	 , NULL                                   AS RFND_PSP_DC	/*환불지연일수*/
        	 , NULL                                   AS RFND_DSB_PSP_INT	/*환불지급지연이자*/
        	 , NULL                                   AS RFND_SLIP_CRT_DT	/*환불전표생성일자*/
        	 , NULL                                   AS RFND_SLPNO	/*환불전표번호*/
        	 , NULL                                   AS MLG_TP_CD	/*마일리지유형코드*/
        	 , NULL                                   AS MLG_RV_NO	/*마일리지적립번호*/
        	 , T3.ITG_DP_NO                           AS ITG_DP_NO	/*통합입금번호*/
        	 , T3.RVE_NO                              AS RVE_NO	/*수납번호*/
        	 , NULL                                   AS PY_AMT	/*납입금액*/
        	 , NULL                                   AS DLQ_AMT	/*연체금액*/
        	 , NULL                                   AS BOR_AMT	/*위약금액*/
        	 , NULL                                   AS RFND_EVID_MTR_FILE_ID	/*환불증빙자료파일ID*/
        	 , NULL                                   AS DPRCP_MTR_FILE_ID	/*입금증자료파일ID*/
        	 , NULL                                   AS POFAT_MTR_FILE_ID	/*위임장자료파일ID*/
        	 , NULL                                   AS IDF_MTR_FILE_ID	/*신분증자료파일ID*/
        	 , NULL                                   AS FML_REL_CRTFD_FILE_ID	/*가족관계증명서파일ID*/
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_RVDW_RFND_AK_BAS T1
    INNER JOIN TB_RVDW_RFND_AK_DTL      T2
            ON (    T2.KW_GRP_CO_CD = T1.KW_GRP_CO_CD
                AND T2.RFND_AK_NO   = T1.RFND_AK_NO
                AND T2.DTA_DL_YN    = 'N')
    INNER JOIN TB_RVDW_RVE_DTL          T3
            ON (    T3.KW_GRP_CO_CD = T2.KW_GRP_CO_CD
                AND T3.RVE_NO       = T2.RVE_NO
                AND T3.RVE_SN       = T2.RVE_SN
                AND T3.CNTR_NO      = T2.CNTR_NO
                AND T3.CNTR_SN      = T2.CNTR_SN
                AND T3.DTA_DL_YN    = 'N')
         WHERE 1 = 1
           AND T1.KW_GRP_CO_CD          = #{session.companyCode}
           AND T1.RFND_AK_NO            = #{rfndAkNo}
           AND T2.RFND_CSH_AK_AMT       >  0
           AND T2.CNTR_NO               = #{cntrNo}
           AND T2.CNTR_SN               = #{cntrSn}
           AND T2.RVE_NO                = #{rveNo}
           AND T2.RVE_SN                = #{rveSn}
           AND T1.DTA_DL_YN             = 'N'
    </insert>

    <insert id="insertRefundReceiptDtlCard">
        INSERT INTO TB_RVDW_RFND_RCP_DTL ( <!--카드-->
        	   KW_GRP_CO_CD					/*교원그룹회사코드*/
        	 , RFND_RCP_NO	/*환불접수번호*/
        	 , RFND_RCP_DTL_SN	/*환불접수상세일련번호*/
        	 , RFND_TP_CD	/*환불유형코드*/
        	 , RFND_DV_CD	/*환불구분코드*/
        	 , RFND_DP_KND_CD	/*환불입금종류코드*/
        	 , RFND_DSB_DV_CD	/*환불지급구분코드*/
        	 , CSH_RFND_DV_CD	/*현금환불구분코드*/
        	 , RFND_AC_DV_CD	/*환불계좌구분코드*/
        	 , RFND_RNTF_EXST_YN	/*환불손료존재여부*/
        	 , CSH_RFND_FNIT_CD	/*현금환불금융기관코드*/
        	 , CSH_RFND_ACNO_ENCR	/*현금환불계좌번호암호화*/
        	 , CSH_RFND_ACOWN_NM	/*현금환불계좌주명*/
        	 , CSH_RFND_ADRS_DV_CD	/*현금환불수취인구분코드*/
        	 , CSH_RFND_DLGPS_NM	/*현금환불대표자명*/
        	 , CARD_RFND_FNIT_CD	/*카드환불금융기관코드*/
        	 , CARD_RFND_CRDCD_APR_STRT_DT	/*카드환불신용카드승인시작일자*/
        	 , CARD_RFND_CRDCD_APR_END_DT	/*카드환불신용카드승인종료일자*/
        	 , CARD_RFND_CRCDNO_ENCR	/*카드환불신용카드번호암호화*/
        	 , CARD_RFND_CRDCD_ISTM_MCN	/*카드환불신용카드할부개월수*/
        	 , CARD_RFND_CRCDONR_NM	/*카드환불신용카드주명*/
        	 , CARD_RFND_CRDCD_APRNO	/*카드환불신용카드승인번호*/
        	 , CARD_RFND_CRDCD_APR_AMT	/*카드환불신용카드승인금액*/
        	 , CARD_RFND_FEE	/*카드환불수수료*/
        	 , CARD_RFND_FER	/*카드환불수수료율*/
        	 , BLTF_RFND_DV_CD	/*전금환불구분코드*/
        	 , BLTF_RFND_TP_CD	/*전금환불유형코드*/
        	 , BLTF_RFND_MB_DV_CD	/*전금환불회원구분코드*/
        	 , BLTF_OJ_CNTR_NO	/*전금대상계약번호*/
        	 , BLTF_OJ_CNTR_SN	/*전금대상계약일련번호*/
        	 , BLTF_BF_VAC_NO_ENCR	/*전금이전가상계좌번호암호화*/
        	 , BLTF_AF_VAC_NO_ENCR	/*전금이후가상계좌번호암호화*/
        	 , KMBRSP_RFND_AK_AMT   /*K멤버스포인트환불요청금액*/
        	 , KMBRSM_RFND_AK_AMT	/*K멤버스머니환불요청금액*/
        	 , KMBRSC_RFND_AK_AMT	/*K멤버스캐시환불요청금액*/
        	 , SMTML_RFND_AK_AMT	/*스마트마일리지환불요청금액*/
        	 , ACTML_RFND_AK_AMT	/*활동마일리지환불요청금액*/
        	 , ETC_RFND_TP_CD	/*기타환불유형코드*/
        	 , ETC_RFND_RQR_NM	/*기타환불요청자명*/
        	 , RFND_AK_AMT	/*환불요청금액*/
        	 , RFND_DDTN_AMT	/*환불공제금액*/
        	 , RFND_RSON_CD	/*환불사유코드*/
        	 , RFND_RSON_CN	/*환불사유내용*/
        	 , RFND_EXP_AMT	/*환불예정금액*/
        	 , RFND_FSH_DT	/*환불완료일자*/
        	 , RFND_DSB_AMT	/*환불지급금액*/
        	 , RFND_DSB_DUEDT	/*환불지급예정일자*/
        	 , RFND_PSP_DC	/*환불지연일수*/
        	 , RFND_DSB_PSP_INT	/*환불지급지연이자*/
        	 , RFND_SLIP_CRT_DT	/*환불전표생성일자*/
        	 , RFND_SLPNO	/*환불전표번호*/
        	 , MLG_TP_CD	/*마일리지유형코드*/
        	 , MLG_RV_NO	/*마일리지적립번호*/
        	 , ITG_DP_NO	/*통합입금번호*/
        	 , RVE_NO	/*수납번호*/
        	 , PY_AMT	/*납입금액*/
        	 , DLQ_AMT	/*연체금액*/
        	 , BOR_AMT	/*위약금액*/
        	 , RFND_EVID_MTR_FILE_ID	/*환불증빙자료파일ID*/
        	 , DPRCP_MTR_FILE_ID	/*입금증자료파일ID*/
        	 , POFAT_MTR_FILE_ID	/*위임장자료파일ID*/
        	 , IDF_MTR_FILE_ID	/*신분증자료파일ID*/
        	 , FML_REL_CRTFD_FILE_ID	/*가족관계증명서파일ID*/
             <include refid="COMMON.insertSystemField"/>
             )
        SELECT T1.KW_GRP_CO_CD					                                /*교원그룹회사코드*/
        	 , #{rfndRcpNo}                           AS RFND_RCP_NO	        /*환불접수번호*/
        	 , (SELECT NVL(MAX(RFND_RCP_DTL_SN) , 0) + 1
        	         	      FROM TB_RVDW_RFND_RCP_DTL
        	         	     WHERE KW_GRP_CO_CD = #{kwGrpCoCd}
        	         		   AND RFND_RCP_NO  = #{rfndRcpNo})	/*환불접수상세일련번호*/
        	 , '01'                                   AS RFND_TP_CD 	        /*환불유형코드*/
        	 , '02'                                   AS RFND_DV_CD	            /*환불구분코드*/
        	 , ''                                     AS RFND_DP_KND_CD	        /*환불입금종류코드*/
        	 , '02'                                   AS RFND_DSB_DV_CD	        /*환불지급구분코드*/
        	 , '03'                                   AS CSH_RFND_DV_CD	        /*현금환불구분코드*/
        	 , '02'                                   AS RFND_AC_DV_CD	        /*환불계좌구분코드*/
        	 , NULL                                   AS RFND_RNTF_EXST_YN	    /*환불손료존재여부*/
        	 , NULL                                   AS CSH_RFND_FNIT_CD	    /*현금환불금융기관코드*/
        	 , NULL                                   AS CSH_RFND_ACNO_ENCR	    /*현금환불계좌번호암호화*/
        	 , NULL                                   AS CSH_RFND_ACOWN_NM	    /*현금환불계좌주명*/
        	 , '01'                                   AS CSH_RFND_ADRS_DV_CD	/*현금환불수취인구분코드*/
        	 , NULL                                   AS CSH_RFND_DLGPS_NM	    /*현금환불대표자명*/
        	 , T4.CRDCD_FNIT_CD                       AS CARD_RFND_FNIT_CD	/*카드환불금융기관코드*/
        	 , T5.APR_DTM                             AS CARD_RFND_CRDCD_APR_STRT_DT	/*카드환불신용카드승인시작일자*/
        	 , T5.RCV_DTM                             AS CARD_RFND_CRDCD_APR_END_DT	/*카드환불신용카드승인종료일자*/
        	 , T4.CRCDNO_ENCR                         AS CARD_RFND_CRCDNO_ENCR	/*카드환불신용카드번호암호화*/
        	 , T4.CRDCD_ISTM_MCN                      AS CARD_RFND_CRDCD_ISTM_MCN	/*카드환불신용카드할부개월수*/
        	 , T4.CRCDONR_NM                          AS CARD_RFND_CRCDONR_NM	/*카드환불신용카드주명*/
        	 , T4.CRDCD_APR_DTM                       AS CARD_RFND_CRDCD_APRNO	/*카드환불신용카드승인번호*/
        	 , T2.RFND_CARD_AK_AMT                    AS CARD_RFND_CRDCD_APR_AMT	/*카드환불신용카드승인금액*/
        	 , T2.CRDCD_FEE_AMT                       AS CARD_RFND_FEE	/*카드환불수수료*/
        	 , T2.CRDCD_FER                           AS CARD_RFND_FER	/*카드환불수수료율*/
        	 , NULL                                   AS BLTF_RFND_DV_CD	/*전금환불구분코드*/
        	 , NULL                                   AS BLTF_RFND_TP_CD	/*전금환불유형코드*/
        	 , NULL                                   AS BLTF_RFND_MB_DV_CD	/*전금환불회원구분코드*/
        	 , NULL                                   AS BLTF_OJ_CNTR_NO	/*전금대상계약번호*/
        	 , NULL                                   AS BLTF_OJ_CNTR_SN	/*전금대상계약일련번호*/
        	 , NULL                                   AS BLTF_BF_VAC_NO_ENCR	/*전금이전가상계좌번호암호화*/
        	 , NULL                                   AS BLTF_AF_VAC_NO_ENCR	/*전금이후가상계좌번호암호화*/
        	 , NULL                                   AS KMBRSP_RFND_AK_AMT   /*K멤버스포인트환불요청금액*/
        	 , NULL                                   AS KMBRSM_RFND_AK_AMT	/*K멤버스머니환불요청금액*/
        	 , NULL                                   AS KMBRSC_RFND_AK_AMT	/*K멤버스캐시환불요청금액*/
        	 , NULL                                   AS SMTML_RFND_AK_AMT	/*스마트마일리지환불요청금액*/
        	 , NULL                                   AS ACTML_RFND_AK_AMT	/*활동마일리지환불요청금액*/
        	 , NULL                                   AS ETC_RFND_TP_CD	/*기타환불유형코드*/
        	 , NULL                                   AS ETC_RFND_RQR_NM	/*기타환불요청자명*/
        	 , T2.RFND_CARD_AK_AMT                    AS RFND_AK_AMT	/*환불요청금액*/
        	 , NULL                                   AS RFND_DDTN_AMT	/*환불공제금액*/
        	 , T2.RFND_RSON_CD                        AS RFND_RSON_CD	/*환불사유코드*/
        	 , T2.RFND_RSON_CN                        AS RFND_RSON_CN	/*환불사유내용*/
        	 , T2.RFND_CARD_AK_AMT                    AS RFND_EXP_AMT	/*환불예정금액*/
        	 , #{rfndDsbDuedt}                        AS RFND_FSH_DT	/*환불완료일자*/
        	 , T2.RFND_CARD_AK_AMT                    AS RFND_DSB_AMT	/*환불지급금액*/
        	 , #{rfndDsbDuedt}                        AS RFND_DSB_DUEDT	/*환불지급예정일자*/
        	 , NULL                                   AS RFND_PSP_DC	/*환불지연일수*/
        	 , NULL                                   AS RFND_DSB_PSP_INT	/*환불지급지연이자*/
        	 , NULL                                   AS RFND_SLIP_CRT_DT	/*환불전표생성일자*/
        	 , NULL                                   AS RFND_SLPNO	/*환불전표번호*/
        	 , NULL                                   AS MLG_TP_CD	/*마일리지유형코드*/
        	 , NULL                                   AS MLG_RV_NO	/*마일리지적립번호*/
        	 , T3.ITG_DP_NO                           AS ITG_DP_NO	/*통합입금번호*/
        	 , T3.RVE_NO                              AS RVE_NO	/*수납번호*/
        	 , NULL                                   AS PY_AMT	/*납입금액*/
        	 , NULL                                   AS DLQ_AMT	/*연체금액*/
        	 , NULL                                   AS BOR_AMT	/*위약금액*/
        	 , NULL                                   AS RFND_EVID_MTR_FILE_ID	/*환불증빙자료파일ID*/
        	 , NULL                                   AS DPRCP_MTR_FILE_ID	/*입금증자료파일ID*/
        	 , NULL                                   AS POFAT_MTR_FILE_ID	/*위임장자료파일ID*/
        	 , NULL                                   AS IDF_MTR_FILE_ID	/*신분증자료파일ID*/
        	 , NULL                                   AS FML_REL_CRTFD_FILE_ID	/*가족관계증명서파일ID*/
            <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_RVDW_RFND_AK_BAS T1
    INNER JOIN TB_RVDW_RFND_AK_DTL        T2
            ON (    T2.KW_GRP_CO_CD = T1.KW_GRP_CO_CD
                AND T2.RFND_AK_NO   = T1.RFND_AK_NO
                AND T2.DTA_DL_YN    = 'N')
    INNER JOIN TB_RVDW_RVE_DTL            T3
            ON (    T3.KW_GRP_CO_CD = T2.KW_GRP_CO_CD
                AND T3.RVE_NO       = T2.RVE_NO
                AND T3.RVE_SN       = T2.RVE_SN
                AND T3.CNTR_NO      = T2.CNTR_NO
                AND T3.CNTR_SN      = T2.CNTR_SN
                AND T3.DTA_DL_YN    = 'N')
    INNER JOIN TB_RVDW_ITG_DP_BAS         T4
            ON (    T4.ITG_DP_NO    = T3.ITG_DP_NO
                AND T4.DTA_DL_YN    = 'N')
     LEFT OUTER JOIN TB_RVDW_CRDCD_RTM_TRD_IZ T5
            ON (    T5.CARD_APRNO   =   T4.CARD_KND_CD
                AND T5.CRCDNO_ENCR  =   T4.CRCDNO_ENCR
                AND T5.DTA_DL_YN    = 'N')
         WHERE 1 = 1
           AND T1.KW_GRP_CO_CD          = #{session.companyCode}
           AND T1.RFND_AK_NO            = #{rfndAkNo}
           AND T2.RFND_CSH_AK_AMT       >  0
           AND T2.CNTR_NO               = #{cntrNo}
           AND T2.CNTR_SN               = #{cntrSn}
           AND T2.RVE_NO                = #{rveNo}
           AND T2.RVE_SN                = #{rveSn}
           AND T1.DTA_DL_YN             = 'N'
    </insert>

    <insert id="insertRefundReceiptDtlBltf">
        INSERT INTO TB_RVDW_RFND_RCP_DTL ( <!--전금-->
        	   KW_GRP_CO_CD					/*교원그룹회사코드*/
        	 , RFND_RCP_NO	/*환불접수번호*/
        	 , RFND_RCP_DTL_SN	/*환불접수상세일련번호*/
        	 , RFND_TP_CD	/*환불유형코드*/
        	 , RFND_DV_CD	/*환불구분코드*/
        	 , RFND_DP_KND_CD	/*환불입금종류코드*/
        	 , RFND_DSB_DV_CD	/*환불지급구분코드*/
        	 , CSH_RFND_DV_CD	/*현금환불구분코드*/
        	 , RFND_AC_DV_CD	/*환불계좌구분코드*/
        	 , RFND_RNTF_EXST_YN	/*환불손료존재여부*/
        	 , CSH_RFND_FNIT_CD	/*현금환불금융기관코드*/
        	 , CSH_RFND_ACNO_ENCR	/*현금환불계좌번호암호화*/
        	 , CSH_RFND_ACOWN_NM	/*현금환불계좌주명*/
        	 , CSH_RFND_ADRS_DV_CD	/*현금환불수취인구분코드*/
        	 , CSH_RFND_DLGPS_NM	/*현금환불대표자명*/
        	 , CARD_RFND_FNIT_CD	/*카드환불금융기관코드*/
        	 , CARD_RFND_CRDCD_APR_STRT_DT	/*카드환불신용카드승인시작일자*/
        	 , CARD_RFND_CRDCD_APR_END_DT	/*카드환불신용카드승인종료일자*/
        	 , CARD_RFND_CRCDNO_ENCR	/*카드환불신용카드번호암호화*/
        	 , CARD_RFND_CRDCD_ISTM_MCN	/*카드환불신용카드할부개월수*/
        	 , CARD_RFND_CRCDONR_NM	/*카드환불신용카드주명*/
        	 , CARD_RFND_CRDCD_APRNO	/*카드환불신용카드승인번호*/
        	 , CARD_RFND_CRDCD_APR_AMT	/*카드환불신용카드승인금액*/
        	 , CARD_RFND_FEE	/*카드환불수수료*/
        	 , CARD_RFND_FER	/*카드환불수수료율*/
        	 , BLTF_RFND_DV_CD	/*전금환불구분코드*/
        	 , BLTF_RFND_TP_CD	/*전금환불유형코드*/
        	 , BLTF_RFND_MB_DV_CD	/*전금환불회원구분코드*/
        	 , BLTF_OJ_CNTR_NO	/*전금대상계약번호*/
        	 , BLTF_OJ_CNTR_SN	/*전금대상계약일련번호*/
        	 , BLTF_BF_VAC_NO_ENCR	/*전금이전가상계좌번호암호화*/
        	 , BLTF_AF_VAC_NO_ENCR	/*전금이후가상계좌번호암호화*/
        	 , KMBRSP_RFND_AK_AMT   /*K멤버스포인트환불요청금액*/
        	 , KMBRSM_RFND_AK_AMT	/*K멤버스머니환불요청금액*/
        	 , KMBRSC_RFND_AK_AMT	/*K멤버스캐시환불요청금액*/
        	 , SMTML_RFND_AK_AMT	/*스마트마일리지환불요청금액*/
        	 , ACTML_RFND_AK_AMT	/*활동마일리지환불요청금액*/
        	 , ETC_RFND_TP_CD	/*기타환불유형코드*/
        	 , ETC_RFND_RQR_NM	/*기타환불요청자명*/
        	 , RFND_AK_AMT	/*환불요청금액*/
        	 , RFND_DDTN_AMT	/*환불공제금액*/
        	 , RFND_RSON_CD	/*환불사유코드*/
        	 , RFND_RSON_CN	/*환불사유내용*/
        	 , RFND_EXP_AMT	/*환불예정금액*/
        	 , RFND_FSH_DT	/*환불완료일자*/
        	 , RFND_DSB_AMT	/*환불지급금액*/
        	 , RFND_DSB_DUEDT	/*환불지급예정일자*/
        	 , RFND_PSP_DC	/*환불지연일수*/
        	 , RFND_DSB_PSP_INT	/*환불지급지연이자*/
        	 , RFND_SLIP_CRT_DT	/*환불전표생성일자*/
        	 , RFND_SLPNO	/*환불전표번호*/
        	 , MLG_TP_CD	/*마일리지유형코드*/
        	 , MLG_RV_NO	/*마일리지적립번호*/
        	 , ITG_DP_NO	/*통합입금번호*/
        	 , RVE_NO	/*수납번호*/
        	 , PY_AMT	/*납입금액*/
        	 , DLQ_AMT	/*연체금액*/
        	 , BOR_AMT	/*위약금액*/
        	 , RFND_EVID_MTR_FILE_ID	/*환불증빙자료파일ID*/
        	 , DPRCP_MTR_FILE_ID	/*입금증자료파일ID*/
        	 , POFAT_MTR_FILE_ID	/*위임장자료파일ID*/
        	 , IDF_MTR_FILE_ID	/*신분증자료파일ID*/
        	 , FML_REL_CRTFD_FILE_ID	/*가족관계증명서파일ID*/
             <include refid="COMMON.insertSystemField"/>
             )
        SELECT T1.KW_GRP_CO_CD					                                /*교원그룹회사코드*/
        	 , #{rfndRcpNo}                           AS RFND_RCP_NO	        /*환불접수번호*/
        	 , ROWNUM                                 AS RFND_RCP_DTL_SN	/*환불접수상세일련번호*/
        	 , '01'                                   AS RFND_TP_CD 	        /*환불유형코드*/
        	 , '02'                                   AS RFND_DV_CD	            /*환불구분코드*/
        	 , ''                                     AS RFND_DP_KND_CD	        /*환불입금종류코드*/
        	 , '03'                                   AS RFND_DSB_DV_CD	        /*환불지급구분코드*/
        	 , '03'                                   AS CSH_RFND_DV_CD	        /*현금환불구분코드*/
        	 , '02'                                   AS RFND_AC_DV_CD	        /*환불계좌구분코드*/
        	 , 'N'                                    AS RFND_RNTF_EXST_YN	    /*환불손료존재여부*/
        	 , NULL                                   AS CSH_RFND_FNIT_CD	    /*현금환불금융기관코드*/
        	 , NULL                                   AS CSH_RFND_ACNO_ENCR	    /*현금환불계좌번호암호화*/
        	 , NULL                                   AS CSH_RFND_ACOWN_NM	    /*현금환불계좌주명*/
        	 , NULL                                   AS CSH_RFND_ADRS_DV_CD	/*현금환불수취인구분코드*/
        	 , NULL                                   AS CSH_RFND_DLGPS_NM	    /*현금환불대표자명*/
        	 , NULL                                   AS CARD_RFND_FNIT_CD	/*카드환불금융기관코드*/
        	 , NULL                                   AS CARD_RFND_CRDCD_APR_STRT_DT	/*카드환불신용카드승인시작일자*/
        	 , NULL                                   AS CARD_RFND_CRDCD_APR_END_DT	/*카드환불신용카드승인종료일자*/
        	 , NULL                                   AS CARD_RFND_CRCDNO_ENCR	/*카드환불신용카드번호암호화*/
        	 , NULL                                   AS CARD_RFND_CRDCD_ISTM_MCN	/*카드환불신용카드할부개월수*/
        	 , NULL                                   AS CARD_RFND_CRCDONR_NM	/*카드환불신용카드주명*/
        	 , NULL                                   AS CARD_RFND_CRDCD_APRNO	/*카드환불신용카드승인번호*/
        	 , NULL                                   AS CARD_RFND_CRDCD_APR_AMT	/*카드환불신용카드승인금액*/
        	 , NULL                                   AS CARD_RFND_FEE	/*카드환불수수료*/
        	 , NULL                                   AS CARD_RFND_FER	/*카드환불수수료율*/
        	 , T4.BLTF_RFND_DV_CD                     AS BLTF_RFND_DV_CD	/*전금환불구분코드*/
        	 , T4.BLTF_RFND_TP_CD                     AS BLTF_RFND_TP_CD	/*전금환불유형코드*/
        	 , T4.BLTF_RFND_MB_DV_CD                  AS BLTF_RFND_MB_DV_CD	/*전금환불회원구분코드*/
        	 , T4.BLTF_OJ_CNTR_NO                     AS BLTF_OJ_CNTR_NO	/*전금대상계약번호*/
        	 , T4.BLTF_OJ_CNTR_SN                     AS BLTF_OJ_CNTR_SN	/*전금대상계약일련번호*/
        	 , NULL                                   AS BLTF_BF_VAC_NO_ENCR	/*전금이전가상계좌번호암호화*/
        	 , T1.CSH_RFND_ACNO_ENCR                  AS BLTF_AF_VAC_NO_ENCR	/*전금이후가상계좌번호암호화*/
        	 , NULL                                   AS KMBRSP_RFND_AK_AMT   /*K멤버스포인트환불요청금액*/
        	 , NULL                                   AS KMBRSM_RFND_AK_AMT	/*K멤버스머니환불요청금액*/
        	 , NULL                                   AS KMBRSC_RFND_AK_AMT	/*K멤버스캐시환불요청금액*/
        	 , NULL                                   AS SMTML_RFND_AK_AMT	/*스마트마일리지환불요청금액*/
        	 , NULL                                   AS ACTML_RFND_AK_AMT	/*활동마일리지환불요청금액*/
        	 , NULL                                   AS ETC_RFND_TP_CD	/*기타환불유형코드*/
        	 , NULL                                   AS ETC_RFND_RQR_NM	/*기타환불요청자명*/
        	 , T4.RFND_BLTF_AK_AMT                    AS RFND_AK_AMT	/*환불요청금액*/
        	 , NULL                                   AS RFND_DDTN_AMT	/*환불공제금액*/
        	 , T2.RFND_RSON_CD                        AS RFND_RSON_CD	/*환불사유코드*/
        	 , T2.RFND_RSON_CN                        AS RFND_RSON_CN	/*환불사유내용*/
        	 , T4.RFND_BLTF_AK_AMT                    AS RFND_EXP_AMT	/*환불예정금액*/
        	 , #{rfndDsbDuedt}                        AS RFND_FSH_DT	/*환불완료일자*/
        	 , T4.RFND_BLTF_AK_AMT                    AS RFND_DSB_AMT	/*환불지급금액*/
         	 , #{rfndDsbDuedt}                        AS RFND_DSB_DUEDT	/*환불지급예정일자*/
        	 , NULL                                   AS RFND_PSP_DC	/*환불지연일수*/
        	 , NULL                                   AS RFND_DSB_PSP_INT	/*환불지급지연이자*/
        	 , NULL                                   AS RFND_SLIP_CRT_DT	/*환불전표생성일자*/
        	 , NULL                                   AS RFND_SLPNO	/*환불전표번호*/
        	 , NULL                                   AS MLG_TP_CD	/*마일리지유형코드*/
        	 , NULL                                   AS MLG_RV_NO	/*마일리지적립번호*/
        	 , T3.ITG_DP_NO                           AS ITG_DP_NO	/*통합입금번호*/
        	 , T3.RVE_NO                              AS RVE_NO	/*수납번호*/
        	 , NULL                                   AS PY_AMT	/*납입금액*/
        	 , NULL                                   AS DLQ_AMT	/*연체금액*/
        	 , NULL                                   AS BOR_AMT	/*위약금액*/
        	 , T4.RFND_EVID_MTR_FILE_ID               AS RFND_EVID_MTR_FILE_ID	/*환불증빙자료파일ID*/
        	 , NULL                                   AS DPRCP_MTR_FILE_ID	/*입금증자료파일ID*/
        	 , NULL                                   AS POFAT_MTR_FILE_ID	/*위임장자료파일ID*/
        	 , NULL                                   AS IDF_MTR_FILE_ID	/*신분증자료파일ID*/
        	 , NULL                                   AS FML_REL_CRTFD_FILE_ID	/*가족관계증명서파일ID*/
            <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_RVDW_RFND_AK_BAS T1
    INNER JOIN TB_RVDW_RFND_AK_DTL        T2
            ON (    T2.KW_GRP_CO_CD = T1.KW_GRP_CO_CD
                AND T2.RFND_AK_NO   = T1.RFND_AK_NO
                AND T2.DTA_DL_YN    = 'N')
    INNER JOIN TB_RVDW_RVE_DTL            T3
            ON (    T3.KW_GRP_CO_CD = T2.KW_GRP_CO_CD
                AND T3.RVE_NO       = T2.RVE_NO
                AND T3.RVE_SN       = T2.RVE_SN
                AND T3.CNTR_NO      = T2.CNTR_NO
                AND T3.CNTR_SN      = T2.CNTR_SN
                AND T3.DTA_DL_YN    = 'N')
    INNER JOIN TB_RVDW_RFND_AK_BLTF_DTL   T4
            ON (    T4.KW_GRP_CO_CD = T2.KW_GRP_CO_CD
                AND T4.RFND_AK_NO   = T2.RFND_AK_NO
                AND T4.CNTR_NO      = T2.CNTR_NO
                AND T4.CNTR_SN      = T2.CNTR_SN
                AND T4.RVE_NO       = T2.RVE_NO
                AND T4.RVE_SN       = T2.RVE_SN )
         WHERE 1 = 1
           AND T1.KW_GRP_CO_CD          = #{session.companyCode}
           AND T1.RFND_AK_NO            = #{rfndAkNo}
           AND T2.RFND_BLTF_AK_AMT      >  0
           AND T2.CNTR_NO               = #{cntrNo}
           AND T2.CNTR_SN               = #{cntrSn}
           AND T2.RVE_NO                = #{rveNo}
           AND T2.RVE_SN                = #{rveSn}
           AND T1.DTA_DL_YN             = 'N'
    </insert>

    <update id="updateRefundStatus">
        UPDATE TB_RVDW_RFND_AK_BAS
               SET RFND_AK_STAT_CD  = #{procsDv}
                 , RFND_PROCS_DV_CD = #{procsDv}
               <include refid="COMMON.updateSystemField" />
         WHERE 1 = 1
           AND KW_GRP_CO_CD = #{session.companyCode}
           AND RFND_AK_NO   = #{rfndAkNo}
           AND DTA_DL_YN    = 'N'
    </update>

    <insert id="insertRefundReceiptBaseHistory">
        INSERT INTO TB_RVDW_RFND_RCP_BAS_HIST (
        	   KW_GRP_CO_CD	/*교원그룹회사코드*/
        	 , RFND_RCP_NO	/*환불접수번호*/
        	 , HIST_CH_DTM
        	 , RVE_CO_CD	/*수납회사코드*/
        	 , CST_NO	/*고객번호*/
        	 , CNTR_NO	/*계약번호*/
        	 , CNTR_SN	/*계약일련번호*/
        	 , CNTR_CH_RCP_ID	/*계약변경접수ID*/
        	 , CNTR_CH_SN	/*계약변경일련번호*/
        	 , RFND_RCP_OG_TP_CD	/*환불접수조직유형코드*/
        	 , RFND_RCP_PRTNR_NO	/*환불접수파트너번호*/
        	 , RFND_RCP_PH_CD	/*환불접수경로코드*/
        	 , RFND_RQDT	/*환불요청일자*/
        	 , RFND_FSH_DT	/*환불완료일자*/
        	 , RTNGD_FSH_DT	/*반품완료일자*/
        	 , CST_SV_ASN_NO	/*고객서비스배정번호*/
        	 , RFND_CSH_AMT	/*환불현금금액*/
        	 , RFND_CARD_AMT	/*환불카드금액*/
        	 , RFND_BLTF_AMT	/*환불전금금액*/
        	 , RFND_DDTN_AMT	/*환불공제금액*/
        	 , RFND_FEE_AMT	/*환불수수료금액*/
        	 , RFND_PSB_RES_AMT	/*환불가능잔여금액*/
        	 , TOT_RFND_ET_AMT	/*총환불예상금액*/
        	 , EX_RFND_RSON_CN	/*예외환불사유내용*/
        	 , RFND_STAT_CD	/*환불상태코드*/
        	 , RFND_RVE_DT	/*환불수납일자*/
        	 , RFND_PERF_DT	/*환불실적일자*/
        	 , RFND_DSB_DT	/*환불지급일자*/
        	 , RFND_PROCS_CN	/*환불처리내용*/
        	 , RFND_PSIC_OPN_CN	/*환불담당자의견내용*/
        	 , RFND_PSIC_RJ_RSON_CN	/*환불담당자반려사유내용*/
        	 , RFND_PROCS_USR_ID	/*환불처리사용자ID*/
             <include refid="COMMON.insertSystemField"/>
             )
        SELECT KW_GRP_CO_CD	/*교원그룹회사코드*/
        	 , RFND_RCP_NO	/*환불접수번호*/
        	 , TO_CHAR(SYSDATE , 'YYYYMMDDHH24MISS') AS HIST_CH_DTM
        	 , RVE_CO_CD	/*수납회사코드*/
        	 , CST_NO	/*고객번호*/
        	 , CNTR_NO	/*계약번호*/
        	 , CNTR_SN	/*계약일련번호*/
        	 , CNTR_CH_RCP_ID	/*계약변경접수ID*/
        	 , CNTR_CH_SN	/*계약변경일련번호*/
        	 , RFND_RCP_OG_TP_CD	/*환불접수조직유형코드*/
        	 , RFND_RCP_PRTNR_NO	/*환불접수파트너번호*/
        	 , RFND_RCP_PH_CD	/*환불접수경로코드*/
        	 , RFND_RQDT	/*환불요청일자*/
        	 , RFND_FSH_DT	/*환불완료일자*/
        	 , RTNGD_FSH_DT	/*반품완료일자*/
        	 , CST_SV_ASN_NO	/*고객서비스배정번호*/
        	 , RFND_CSH_AMT	/*환불현금금액*/
        	 , RFND_CARD_AMT	/*환불카드금액*/
        	 , RFND_BLTF_AMT	/*환불전금금액*/
        	 , RFND_DDTN_AMT	/*환불공제금액*/
        	 , RFND_FEE_AMT	/*환불수수료금액*/
        	 , RFND_PSB_RES_AMT	/*환불가능잔여금액*/
        	 , TOT_RFND_ET_AMT	/*총환불예상금액*/
        	 , EX_RFND_RSON_CN	/*예외환불사유내용*/
        	 , RFND_STAT_CD	/*환불상태코드*/
        	 , RFND_RVE_DT	/*환불수납일자*/
        	 , RFND_PERF_DT	/*환불실적일자*/
        	 , RFND_DSB_DT	/*환불지급일자*/
        	 , RFND_PROCS_CN	/*환불처리내용*/
        	 , RFND_PSIC_OPN_CN	/*환불담당자의견내용*/
        	 , RFND_PSIC_RJ_RSON_CN	/*환불담당자반려사유내용*/
        	 , RFND_PROCS_USR_ID	/*환불처리사용자ID*/
            <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_RVDW_RFND_RCP_BAS
         WHERE 1 = 1
           AND KW_GRP_CO_CD = #{kwGrpCoCd}
           AND RFND_RCP_NO = #{rfndRcpNo}
    </insert>

    <insert id="insertRefundReceiptDtlHistory">
        INSERT INTO TB_RVDW_RFND_RCP_DTL_HIST (
         	   KW_GRP_CO_CD					/*교원그룹회사코드*/
        	 , RFND_RCP_NO	/*환불접수번호*/
        	 , RFND_RCP_DTL_SN	/*환불접수상세일련번호*/
        	 , HIST_CH_DTM
        	 , RFND_TP_CD	/*환불유형코드*/
        	 , RFND_DV_CD	/*환불구분코드*/
        	 , RFND_DP_KND_CD	/*환불입금종류코드*/
        	 , RFND_DSB_DV_CD	/*환불지급구분코드*/
        	 , CSH_RFND_DV_CD	/*현금환불구분코드*/
        	 , RFND_AC_DV_CD	/*환불계좌구분코드*/
        	 , RFND_RNTF_EXST_YN	/*환불손료존재여부*/
        	 , CSH_RFND_FNIT_CD	/*현금환불금융기관코드*/
        	 , CSH_RFND_ACNO_ENCR	/*현금환불계좌번호암호화*/
        	 , CSH_RFND_ACOWN_NM	/*현금환불계좌주명*/
        	 , CSH_RFND_ADRS_DV_CD	/*현금환불수취인구분코드*/
        	 , CSH_RFND_DLGPS_NM	/*현금환불대표자명*/
        	 , CARD_RFND_FNIT_CD	/*카드환불금융기관코드*/
        	 , CARD_RFND_CRDCD_APR_STRT_DT	/*카드환불신용카드승인시작일자*/
        	 , CARD_RFND_CRDCD_APR_END_DT	/*카드환불신용카드승인종료일자*/
        	 , CARD_RFND_CRCDNO_ENCR	/*카드환불신용카드번호암호화*/
        	 , CARD_RFND_CRDCD_ISTM_MCN	/*카드환불신용카드할부개월수*/
        	 , CARD_RFND_CRCDONR_NM	/*카드환불신용카드주명*/
        	 , CARD_RFND_CRDCD_APRNO	/*카드환불신용카드승인번호*/
        	 , CARD_RFND_CRDCD_APR_AMT	/*카드환불신용카드승인금액*/
        	 , CARD_RFND_FEE	/*카드환불수수료*/
        	 , CARD_RFND_FER	/*카드환불수수료율*/
        	 , BLTF_RFND_DV_CD	/*전금환불구분코드*/
        	 , BLTF_RFND_TP_CD	/*전금환불유형코드*/
        	 , BLTF_RFND_MB_DV_CD	/*전금환불회원구분코드*/
        	 , BLTF_OJ_CNTR_NO	/*전금대상계약번호*/
        	 , BLTF_OJ_CNTR_SN	/*전금대상계약일련번호*/
        	 , BLTF_BF_VAC_NO_ENCR	/*전금이전가상계좌번호암호화*/
        	 , BLTF_AF_VAC_NO_ENCR	/*전금이후가상계좌번호암호화*/
        	 , KMBRSP_RFND_AK_AMT   /*K멤버스포인트환불요청금액*/
        	 , KMBRSM_RFND_AK_AMT	/*K멤버스머니환불요청금액*/
        	 , KMBRSC_RFND_AK_AMT	/*K멤버스캐시환불요청금액*/
        	 , SMTML_RFND_AK_AMT	/*스마트마일리지환불요청금액*/
        	 , ACTML_RFND_AK_AMT	/*활동마일리지환불요청금액*/
        	 , ETC_RFND_TP_CD	/*기타환불유형코드*/
        	 , ETC_RFND_RQR_NM	/*기타환불요청자명*/
        	 , RFND_AK_AMT	/*환불요청금액*/
        	 , RFND_DDTN_AMT	/*환불공제금액*/
        	 , RFND_RSON_CD	/*환불사유코드*/
        	 , RFND_RSON_CN	/*환불사유내용*/
        	 , RFND_EXP_AMT	/*환불예정금액*/
        	 , RFND_FSH_DT	/*환불완료일자*/
        	 , RFND_DSB_AMT	/*환불지급금액*/
        	 , RFND_DSB_DUEDT	/*환불지급예정일자*/
        	 , RFND_PSP_DC	/*환불지연일수*/
        	 , RFND_DSB_PSP_INT	/*환불지급지연이자*/
        	 , RFND_SLIP_CRT_DT	/*환불전표생성일자*/
        	 , RFND_SLPNO	/*환불전표번호*/
        	 , MLG_TP_CD	/*마일리지유형코드*/
        	 , MLG_RV_NO	/*마일리지적립번호*/
        	 , ITG_DP_NO	/*통합입금번호*/
        	 , RVE_NO	/*수납번호*/
        	 , PY_AMT	/*납입금액*/
        	 , DLQ_AMT	/*연체금액*/
        	 , BOR_AMT	/*위약금액*/
        	 , RFND_EVID_MTR_FILE_ID	/*환불증빙자료파일ID*/
        	 , DPRCP_MTR_FILE_ID	/*입금증자료파일ID*/
        	 , POFAT_MTR_FILE_ID	/*위임장자료파일ID*/
        	 , IDF_MTR_FILE_ID	/*신분증자료파일ID*/
        	 , FML_REL_CRTFD_FILE_ID	/*가족관계증명서파일ID*/
             <include refid="COMMON.insertSystemField"/>
             )
        SELECT KW_GRP_CO_CD					/*교원그룹회사코드*/
        	 , RFND_RCP_NO	/*환불접수번호*/
        	 , RFND_RCP_DTL_SN	/*환불접수상세일련번호*/
        	 , TO_CHAR(SYSDATE , 'YYYYMMDDHH24MISS') AS HIST_CH_DTM
        	 , RFND_TP_CD	/*환불유형코드*/
        	 , RFND_DV_CD	/*환불구분코드*/
        	 , RFND_DP_KND_CD	/*환불입금종류코드*/
        	 , RFND_DSB_DV_CD	/*환불지급구분코드*/
        	 , CSH_RFND_DV_CD	/*현금환불구분코드*/
        	 , RFND_AC_DV_CD	/*환불계좌구분코드*/
        	 , RFND_RNTF_EXST_YN	/*환불손료존재여부*/
        	 , CSH_RFND_FNIT_CD	/*현금환불금융기관코드*/
        	 , CSH_RFND_ACNO_ENCR	/*현금환불계좌번호암호화*/
        	 , CSH_RFND_ACOWN_NM	/*현금환불계좌주명*/
        	 , CSH_RFND_ADRS_DV_CD	/*현금환불수취인구분코드*/
        	 , CSH_RFND_DLGPS_NM	/*현금환불대표자명*/
        	 , CARD_RFND_FNIT_CD	/*카드환불금융기관코드*/
        	 , CARD_RFND_CRDCD_APR_STRT_DT	/*카드환불신용카드승인시작일자*/
        	 , CARD_RFND_CRDCD_APR_END_DT	/*카드환불신용카드승인종료일자*/
        	 , CARD_RFND_CRCDNO_ENCR	/*카드환불신용카드번호암호화*/
        	 , CARD_RFND_CRDCD_ISTM_MCN	/*카드환불신용카드할부개월수*/
        	 , CARD_RFND_CRCDONR_NM	/*카드환불신용카드주명*/
        	 , CARD_RFND_CRDCD_APRNO	/*카드환불신용카드승인번호*/
        	 , CARD_RFND_CRDCD_APR_AMT	/*카드환불신용카드승인금액*/
        	 , CARD_RFND_FEE	/*카드환불수수료*/
        	 , CARD_RFND_FER	/*카드환불수수료율*/
        	 , BLTF_RFND_DV_CD	/*전금환불구분코드*/
        	 , BLTF_RFND_TP_CD	/*전금환불유형코드*/
        	 , BLTF_RFND_MB_DV_CD	/*전금환불회원구분코드*/
        	 , BLTF_OJ_CNTR_NO	/*전금대상계약번호*/
        	 , BLTF_OJ_CNTR_SN	/*전금대상계약일련번호*/
        	 , BLTF_BF_VAC_NO_ENCR	/*전금이전가상계좌번호암호화*/
        	 , BLTF_AF_VAC_NO_ENCR	/*전금이후가상계좌번호암호화*/
        	 , KMBRSP_RFND_AK_AMT   /*K멤버스포인트환불요청금액*/
        	 , KMBRSM_RFND_AK_AMT	/*K멤버스머니환불요청금액*/
        	 , KMBRSC_RFND_AK_AMT	/*K멤버스캐시환불요청금액*/
        	 , SMTML_RFND_AK_AMT	/*스마트마일리지환불요청금액*/
        	 , ACTML_RFND_AK_AMT	/*활동마일리지환불요청금액*/
        	 , ETC_RFND_TP_CD	/*기타환불유형코드*/
        	 , ETC_RFND_RQR_NM	/*기타환불요청자명*/
        	 , RFND_AK_AMT	/*환불요청금액*/
        	 , RFND_DDTN_AMT	/*환불공제금액*/
        	 , RFND_RSON_CD	/*환불사유코드*/
        	 , RFND_RSON_CN	/*환불사유내용*/
        	 , RFND_EXP_AMT	/*환불예정금액*/
        	 , RFND_FSH_DT	/*환불완료일자*/
        	 , RFND_DSB_AMT	/*환불지급금액*/
        	 , RFND_DSB_DUEDT	/*환불지급예정일자*/
        	 , RFND_PSP_DC	/*환불지연일수*/
        	 , RFND_DSB_PSP_INT	/*환불지급지연이자*/
        	 , RFND_SLIP_CRT_DT	/*환불전표생성일자*/
        	 , RFND_SLPNO	/*환불전표번호*/
        	 , MLG_TP_CD	/*마일리지유형코드*/
        	 , MLG_RV_NO	/*마일리지적립번호*/
        	 , ITG_DP_NO	/*통합입금번호*/
        	 , RVE_NO	/*수납번호*/
        	 , PY_AMT	/*납입금액*/
        	 , DLQ_AMT	/*연체금액*/
        	 , BOR_AMT	/*위약금액*/
        	 , RFND_EVID_MTR_FILE_ID	/*환불증빙자료파일ID*/
        	 , DPRCP_MTR_FILE_ID	/*입금증자료파일ID*/
        	 , POFAT_MTR_FILE_ID	/*위임장자료파일ID*/
        	 , IDF_MTR_FILE_ID	/*신분증자료파일ID*/
        	 , FML_REL_CRTFD_FILE_ID	/*가족관계증명서파일ID*/
            <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_RVDW_RFND_RCP_DTL
         WHERE 1 = 1
           AND KW_GRP_CO_CD = #{kwGrpCoCd}
           AND RFND_RCP_NO = #{rfndRcpNo}
    </insert>

</mapper>
