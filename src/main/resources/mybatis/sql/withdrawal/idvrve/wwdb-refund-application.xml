<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.idvrve.mapper.WwdbRefundApplicationMapper">

    <select id="selectRefundApplication" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundApplicationRes">
        SELECT RRAB.RFND_AK_STAT_CD /* 환불상태 */
             , '상세' AS RFND_AK_DTL_CD /* 환불상세 */
             , TO_CHAR(TO_DATE(RRAB.RFND_AK_DTM, 'YYYYMMDD HH24MISS'), 'YYYYMMDD') AS RFND_AK_DTM /* 접수일자 */
             , RRAB.RFND_AK_NO /* 접수번호 */
             , T1.DP_AMT - T1.DLQ_ADD_AMT - T1.MM_ISTM_AMT - T1.BOR_AMT - T1.SV_AMT AS RFND_PSB_AMT/* 환불가능금액 */
             , NVL(RRAD.RFND_CSH_AK_AMT,0) + NVL(RRAD.RFND_CARD_AK_AMT,0) +  NVL(RRAD.CRDCD_FEE_AMT, 0) + NVL(RRAD.RFND_BLTF_AK_AMT,0) AS RFND_AK_AMT
             , RRAD.CNTR_NO /* 계약기본 */
             , RRAD.CNTR_SN /* 계약상세 */
             , RRAD.CNTR_NO || RRAD.CNTR_SN AS CNTR_DTL_NO /* 계약상세번호 */
             , NVL(RRAD.RFND_CSH_AK_AMT, 0) AS RFND_CSH_AK_AMT /* 현금환불금액 */
             , NVL(RRAD.RFND_CARD_AK_AMT, 0) AS RFND_CARD_AK_AMT/* 카드환불금액 */
             , NVL(RRAD.CRDCD_FEE_AMT, 0) AS CRDCD_FEE_AMT  /* 카드수수료 */
             , NVL(RRAD.RFND_BLTF_AK_AMT, 0) AS RFND_BLTF_AK_AMT /* 전금금액 */
             , F_CMZ_USR_NM(RRAD.FNL_MDFC_USR_ID) AS FNL_MDFC_USR_NM /* 신청자 */
             , RRAD.FNL_MDFC_USR_ID /* 번호 */
             , RRRB.RFND_FSH_DT /* 승인일자 */
             , RRRB.RFND_PROCS_CN /* 처리내용 */
             , RRAD.RFND_RSON_CD /* 환불사유 */
             , RRAD.RFND_RSON_CN /* 환불내용 */
             , RRRD.RFND_EVID_MTR_FILE_ID /* 첨부파일:환불증빙자료파일 */
          FROM TB_RVDW_RFND_AK_BAS RRAB -- 환불요청기본
         INNER JOIN TB_RVDW_RFND_AK_DTL RRAD -- 환불요청상세
            ON RRAD.RFND_AK_NO = RRAB.RFND_AK_NO
           AND RRAD.DTA_DL_YN = 'N'
<!--         INNER JOIN TB_RVDW_RFND_AK_CNTR_DTL RRACD &#45;&#45; 환불요청계약상세-->
<!--            ON RRACD.RFND_AK_NO = RRAD.RFND_AK_NO-->
<!--           AND RRACD.DTA_DL_YN = 'N'-->
          LEFT JOIN ( SELECT
                             RRD.CNTR_NO
                           , RRD.CNTR_SN
                           , RRD.RVE_NO
                           , RRD.RVE_SN
                           , NVL(RRD.DP_AMT,0) AS DP_AMT /* 입금액 */
                           , NVL(CBCB.DLQ_ADD_AMT,0) AS DLQ_ADD_AMT  /* 연체가산금 */
                           , NVL(SCD.MM_ISTM_AMT,0) AS MM_ISTM_AMT /* 월 납부금(월 납입금) */
                           ,  NVL(CBCB.RSG_BOR_AMT,0) AS BOR_AMT /* 위약금 */
                           , (SELECT
                                     NVL(MAX(S9.SV_AMT),0)
                                FROM TB_CBCL_WELLS_SL_MM_CL_IZ S9
                               WHERE 1 = 1
                                 AND S9.CNTR_NO = SCD.CNTR_NO
                                 AND S9.CNTR_SN = SCD.CNTR_SN
                                 AND S9.DTA_DL_YN = 'N'
                              ) AS SV_AMT /* 서비스금액 */
                        FROM TB_RVDW_RVE_DTL RRD /* 수납상세 */
                       INNER JOIN TB_SSCT_CNTR_DTL SCD /* 계약상세 */
                          ON SCD.CNTR_NO = RRD.CNTR_NO
                         AND SCD.CNTR_SN = RRD.CNTR_SN
                         AND SCD.DTA_DL_YN = 'N'
                        LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS CBCB /*채권계약기본*/
                         ON CBCB.CNTR_NO = SCD.CNTR_NO
                        AND CBCB.CNTR_SN = SCD.CNTR_SN
                        AND CBCB.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
                        AND CBCB.DTA_DL_YN = 'N'
                      WHERE 1 = 1
                        AND RRD.DTA_DL_YN = 'N'
                    ) T1
            ON RRAD.CNTR_NO = T1.CNTR_NO
           AND RRAD.CNTR_SN = T1.CNTR_SN
           AND RRAD.RVE_NO = T1.RVE_NO
           AND RRAD.RVE_SN = T1.RVE_SN
          LEFT JOIN TB_RVDW_RFND_RCP_BAS RRRB -- 환불접수기본
            ON RRRB.CNTR_NO = RRAD.CNTR_NO
           AND RRRB.CNTR_SN = RRAD.CNTR_SN
           AND RRRB.DTA_DL_YN = 'N'
          LEFT JOIN TB_RVDW_RFND_RCP_DTL RRRD -- 환불접수상세 /* 요청 Main, 접수 Sub 이므로 LEFT JOIN*/
            ON RRRD.RFND_RCP_NO = RRRB.RFND_RCP_NO
           AND RRRD.DTA_DL_YN = 'N'
         WHERE 1=1
           AND RRAB.DTA_DL_YN = 'N' /* 삭제시 visible 처리 */
        <choose>
          <when test='@MybatisUtils@equals(searchDt, "01")'>  /* 접수일자 */
           AND SUBSTR(RRAB.RFND_AK_DTM, 0, 8) <![CDATA[>=]]> #{startDay}
           AND SUBSTR(RRAB.RFND_AK_DTM, 0, 8) <![CDATA[<=]]> #{endDay}
          </when>
          <when test='@MybatisUtils@equals(searchDt, "02")'>  /* 실적일자 */
           AND SUBSTR(RRRB.RFND_PERF_DT, 0, 8) <![CDATA[>=]]> #{startDay}
           AND SUBSTR(RRRB.RFND_PERF_DT, 0, 8) <![CDATA[<=]]> #{endDay}
          </when>
           <when test='@MybatisUtils@equals(searchDt, "03")'> /* 처리일자 */
           AND SUBSTR(RRRB.RFND_FSH_DT, 0, 8) <![CDATA[>=]]> #{startDay}
           AND SUBSTR(RRRB.RFND_FSH_DT, 0, 8) <![CDATA[<=]]> #{endDay}
          </when>
        </choose>
        <if test='@MybatisUtils@isNotEmpty(rfndStatCd)'>
           AND RRAB.RFND_AK_STAT_CD = #{rfndStatCd}
        </if>
        <if test='@MybatisUtils@isNotEmpty(rfndDsbDvCdCshBltf) and rfndDsbDvCdCshBltf != "ALL" and rfndDsbDvCdCshBltf != "all"'>
           AND RRAB.RFND_PROCS_DV_CD = #{rfndDsbDvCdCshBltf}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
           AND RRAD.CNTR_NO = #{cntrNo}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
           AND RRAD.CNTR_SN = #{cntrSn}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cstNo)'>
           AND RRAD.CST_NO = #{cstNo}
        </if>
        ORDER BY RRAB.RFND_AK_DTM, RRAB.RFND_AK_NO
    </select>

    <select id="selectRefundContractDetail" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundContractDetailRes">
        SELECT T2.CNTR_NO
             , T2.CNTR_SN
             , T2.CNTR_DTL_NO
             , T2.SELL_TP_CD
             , T2.CST_NO
             , SUM(T2.RFND_PSB_AMT) AS RFND_PSB_AMT
             , T2.PD_CD
             , T2.PD_NM
             , T2.CST_KNM
             , SUM(T2.DP_AMT) AS DP_AMT
             , SUM(T2.DLQ_ADD_AMT) AS DLQ_ADD_AMT
             , SUM(T2.MM_ISTM_AMT) AS MM_ISTM_AMT
             , SUM(T2.BOR_AMT) AS BOR_AMT
             , SUM(T2.SV_AMT) AS SV_AMT
             , SUM(T2.SELL_AMT) AS SELL_AMT
          FROM (
                 SELECT T1.CNTR_NO
                      , T1.CNTR_SN
                      , T1.CNTR_DTL_NO
                      , T1.SELL_TP_CD
                      , T1.CST_NO
                      , (T1.DP_AMT - T1.MM_ISTM_AMT - T1.DLQ_ADD_AMT - T1.BOR_AMT - T1.SV_AMT) AS RFND_PSB_AMT
                      , T1.PD_CD
                      , T1.PD_NM
                      , T1.CST_KNM
                      , T1.DP_AMT
                      , T1.DLQ_ADD_AMT
                      , T1.MM_ISTM_AMT
                      , T1.BOR_AMT
                      , T1.SV_AMT
                      , T1.SELL_AMT
                  FROM ( SELECT
                                 RRD.CNTR_NO
                               , RRD.CNTR_SN
                               , RRD.CNTR_NO ||'-'|| RRD.CNTR_SN AS CNTR_DTL_NO /* 계약상세번호 */
                               , RRD.RVE_NO
                               , SCD.SELL_TP_CD /* 판매유형코드 */
                               , SCB.CNTR_CST_NO AS CST_NO
                               , SCD.BASE_PD_CD AS PD_CD
                               , PPB.PD_NM /*상품명*/
                               , CCB.CST_KNM /*고객명*/
                               , CCB.COPN_DV_CD      /* 법인격유형코드 (01.개인 , 02.법인 )*/
                               , RRD.DP_DT    /* 입금일자 */
                               , RRD.RVE_DT   /* 수납일자 */
                               , RRD.DP_AMT                              /* 입금금액 */
                               , NVL(CBCB.DLQ_ADD_AMT,0) AS DLQ_ADD_AMT  /* 연체가산금 */
                               , NVL(CWSMCI.RENTAL_AMT,0) AS MM_ISTM_AMT /* 월 납부금(월 납입금) */
                               , NVL(CBCB.RSG_BOR_AMT,0) AS BOR_AMT /* 위약금 */
                               , NVL(CWSMCI.SV_AMT , 0) AS SV_AMT /* 서비스금액 */
                               , NVL(SCD.SELL_AMT, 0) AS SELL_AMT /* 주문금액 */
                               , RRAD.CRCDNO_ENCR /* 검색조건(카드번호) */
                               , RRAD.ACNO_ENCR /* 검색조건(계좌번호) */
                            FROM TB_RVDW_RVE_DTL RRD      /* 수납상세 */
                           INNER JOIN TB_RVDW_RVE_AK_DTL RRAD /* 수납요청상세 */
                              ON RRAD.RVE_AK_NO = RRD.RVE_AK_NO
                             AND RRAD.RVE_AK_SN = RRD.RVE_AK_SN
                             AND RRAD.DTA_DL_YN = 'N'
                           INNER JOIN TB_SSCT_CNTR_DTL SCD /*계약상세*/
                              ON SCD.CNTR_NO = RRD.CNTR_NO
                             AND SCD.CNTR_SN = RRD.CNTR_SN
                             AND SCD.DTA_DL_YN = 'N'
                           INNER JOIN TB_SSCT_CNTR_BAS SCB /*계약기본*/
                              ON SCB.CNTR_NO = SCD.CNTR_NO
                             AND SCB.DTA_DL_YN = 'N'
                            LEFT OUTER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ CWSMCI /*월마감*/
                              ON CWSMCI.CNTR_NO = RRD.CNTR_NO
                             AND CWSMCI.CNTR_SN = RRD.CNTR_SN
                             AND CWSMCI.DTA_DL_YN = 'N'
                             AND CWSMCI.SL_CL_YM = TO_CHAR(SYSDATE , 'YYYYMM')
                           INNER JOIN TB_PDBS_PD_BAS PPB  /*상품기본*/
                              ON PPB.PD_CD = SCD.BASE_PD_CD
                             AND PPB.DTA_DL_YN = 'N'
                            LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS CBCB /*채권계약기본*/
                              ON CBCB.CNTR_NO = SCD.CNTR_NO
                             AND CBCB.CNTR_SN = SCD.CNTR_SN
                             AND CBCB.BASE_YM = TO_CHAR(SYSDATE ,'YYYYMM')
                             AND CBCB.DTA_DL_YN = 'N'
                           INNER JOIN TB_CUBS_CST_BAS CCB /*고객기본*/
                              ON CCB.CST_NO = SCB.CNTR_CST_NO
                             AND CCB.DTA_DL_YN = 'N'
                        <if test="@MybatisUtils@isNotEmpty(rfndAkNo)">
                           INNER JOIN TB_RVDW_RFND_AK_CNTR_DTL RRACD
                              ON RRACD.KW_GRP_CO_CD = RRD.KW_GRP_CO_CD
                             AND RRACD.CNTR_NO      = RRD.CNTR_NO
                             AND RRACD.CNTR_SN      = RRD.CNTR_SN
                             AND RRACD.DTA_DL_YN    = 'N'
                             AND RRACD.RFND_AK_NO   = #{rfndAkNo}
                           WHERE 1 = 1
                             AND RRD.DTA_DL_YN ='N'
                        </if>
                         ) T1
                  WHERE 1 = 1
                    <!--           AND RRD.DP_DV_CD IN ('2','4') /* 입금구분코드 2.환불 , 4.전금환불 */-->
                    <if test="@MybatisUtils@isNotEmpty(cntrStartDay) or @MybatisUtils@isNotEmpty(cntrEndDay)">
                    AND (T1.CNTR_NO, T1.CNTR_SN) IN (SELECT CNTR_NO, CNTR_SN
                                                       FROM TB_RVDW_RVE_DTL RVE
                                                      WHERE RVE.DP_DT BETWEEN #{cntrStartDay} AND #{cntrEndDay} ) /* 수납일자 */
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(copnDvCd)">
                    AND T1.COPN_DV_CD = #{copnDvCd}             /* 고객유형 */
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                    AND T1.CNTR_NO = #{cntrNo}                  /* 계약번호 */
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                    AND T1.CNTR_SN = #{cntrSn}                  /* 계약일련번호 */
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(cstNo)">
                    AND T1.CST_NO = #{cstNo}               /* 고객번호 */
                    </if>
                    <choose>
                     <when test="@MybatisUtils@equals(encr ,'01') and @MybatisUtils@isNotEmpty(crdcdNo)">
                    AND T1.CRCDNO_ENCR = #{crdcdNo} /* 카드번호 */
                     </when>
                     <when test="@MybatisUtils@equals(encr ,'02') and @MybatisUtils@isNotEmpty(acnoEncr)">
                    AND T1.ACNO_ENCR = #{acnoEncr} /* 계좌번호 */
                     </when>
                   </choose>
                ) T2
          WHERE 1 = 1
          GROUP BY T2.CNTR_NO
                 , T2.CNTR_SN
                 , T2.CNTR_DTL_NO
                 , T2.SELL_TP_CD
                 , T2.CST_NO
                 , T2.PD_CD
                 , T2.PD_NM
                 , T2.CST_KNM
    </select>

    <!-- 환불기본정보조회 -->
    <select id="selectRefund" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundRes">
          SELECT T1.RFND_AK_NO /* 환불요청번호 */
               , T1.ARFND_YN /* 선환불 구분 */
               , T1.CSH_RFND_FNIT_CD /* 은행코드 */
               , T1.CSH_RFND_ACNO_ENCR /* 계좌번호 */
               , T1.CSH_RFND_ACOWN_NM /* 예금주 */
               , T1.RFND_RVE_DT /* 환불수납일자*/
               , T1.RFND_PERF_DT /* 환불실적일자*/
               , T1.RFND_DSB_DT /* 환불지급일자 */
               , T1.RFND_PROCS_DV_CD /* 환불처리구분코드 */
               , T1.RFND_PROCS_CN /* 환불처리내용 */
            FROM TB_RVDW_RFND_AK_BAS T1
           WHERE 1 = 1
             AND RFND_AK_NO = #{rfndAkNo}
             AND RFND_AK_STAT_CD = #{rfndAkStatCd}
    </select>

    <!-- TODO: 계약상세 조회 -->
     <select id="selectRefundBasePages" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundBaseRes">
         SELECT CNTR_NO
           FROM TB_RVDW_RVE_DTL
          WHERE 1=1
    </select>


    <!-- TODO: 환불상세 조회 -->
    <select id="selectRefundDetail" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundDetailRes">
           SELECT T1.RVE_NO
                , T1.RVE_SN
                , T1.CNTR_NO
                , T1.CNTR_SN
                , T1.CNTR_DTL_NO
                , T1.DP_DT
                , T1.DP_MES_CD
                , T1.RVE_DV_CD
                , T1.DP_AMT
                , T1.DP_AMT - T1.DLQ_ADD_AMT - T1.MM_ISTM_AMT - T1.BOR_AMT - T1.SV_AMT AS RFND_PSB_AMT /* 입금액 => 환불가능금액 */
                , T1.BLTF_ADD
                , 0 AS RFND_CSH_AK_AMT
                , 0 AS RFND_CARD_AK_AMT
                , 0 AS CRDCD_FEE_AMT
                , 0 AS RFND_BLTF_AK_AMT
                , NULL AS RFND_AK_NO
                , FNIT_CD
                , NVL(CRDCD_FER , 0) AS CRDCD_FER
                , CST_NO
             FROM ( SELECT RRD.RVE_NO      /* 수납번호 */
                         , RRD.RVE_SN      /* 수납일련번호 */
                         , RRD.CNTR_NO     /* 계약번호*/
                         , RRD.CNTR_SN     /* 계약일련번호 */
                         , RRD.CNTR_NO || RRD.CNTR_SN AS CNTR_DTL_NO /* 계약상세번호 */
                         , RRD.DP_DT               /* 입금일 */
                         , RRD.DP_MES_CD           /* 입금수단 */
                         , RRD.RVE_DV_CD            /* 입금유형 -> 수납유형(사양서, 설계서결과에 맞게 수정) */
                         , RRAD.FNIT_CD
                         , RFFB.CRDCD_FER
                         , (SELECT
                                   NVL(MAX(S9.SV_AMT),0)
                              FROM TB_CBCL_WELLS_SL_MM_CL_IZ S9
                             WHERE 1 = 1
                               AND S9.CNTR_NO = SCD.CNTR_NO
                               AND S9.CNTR_SN = SCD.CNTR_SN
                               AND S9.DTA_DL_YN = 'N'
                           ) AS SV_AMT /* 서비스금액 */
                         , NVL(RRD.DP_AMT, 0) AS DP_AMT /* 입금액 */
                         , NVL(CBCB.DLQ_ADD_AMT,0) AS DLQ_ADD_AMT  /* 연체가산금 */
                         , NVL(SCD.MM_ISTM_AMT,0) AS MM_ISTM_AMT /* 월 납부금(월 납입금) */
                         , NVL(CBCB.RSG_BOR_AMT,0) AS BOR_AMT /* 위약금 */
                         , SCB.CNTR_CST_NO AS CST_NO
<!--                         , NVL(RRAD.CRDCD_FER, 0) AS CRDCD_FER   /* 카드수수료율 */-->
                         , '전금행추가' AS BLTF_ADD  /* 전금행추가 - 컬럼 */
                      FROM TB_RVDW_RVE_DTL RRD /* 수납상세 */
                     INNER JOIN TB_RVDW_RVE_AK_DTL RRAD
                        ON RRAD.KW_GRP_CO_CD = RRD.KW_GRP_CO_CD
                       AND RRAD.RVE_AK_NO = RRD.RVE_AK_NO
                       AND RRAD.RVE_AK_SN = RRD.RVE_AK_SN
                       AND RRAD.DTA_DL_YN = 'N'
                     INNER JOIN TB_SSCT_CNTR_DTL SCD /* 계약상세 */
                        ON SCD.CNTR_NO = RRD.CNTR_NO
                       AND SCD.CNTR_SN = RRD.CNTR_SN
                       AND SCD.DTA_DL_YN = 'N'
                     INNER JOIN TB_SSCT_CNTR_BAS SCB /*계약기본*/
                        ON SCB.CNTR_NO = SCD.CNTR_NO
                       AND SCB.DTA_DL_YN = 'N'
                      LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS CBCB /*채권계약기본*/
                        ON CBCB.CNTR_NO = SCD.CNTR_NO
                       AND CBCB.CNTR_SN = SCD.CNTR_SN
                       AND CBCB.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
                       AND CBCB.DTA_DL_YN = 'N'
                      LEFT OUTER JOIN TB_RVDW_FNIT_FEE_BAS RFFB
                        ON RFFB.KW_GRP_CO_CD = RRAD.KW_GRP_CO_CD
                       AND RFFB.FNIT_CD = RRAD.FNIT_CD
                       AND RFFB.FNIT_FEE_TP_CD = '2'
                       AND RFFB.DTA_DL_YN = 'N'
                       AND RFFB.VL_STRTDT  <![CDATA[<=]]> RRD.RVE_DT
                       AND RFFB.VL_ENDDT   >=   RRD.RVE_DT
                     WHERE 1 = 1
                       AND RRD.DTA_DL_YN = 'N'
                       AND RRD.CNTR_NO = #{cntrNo}
                       AND RRD.CNTR_SN = #{cntrSn}
                      <if test="@MybatisUtils@isNotEmpty(rveNo)">
                       AND RRD.RVE_NO = #{rveNo}
                      </if>
                      <if test="@MybatisUtils@isNotEmpty(rveSn)">
                       AND RRD.RVE_SN = #{rveSn}
                      </if>
                      <if test="@MybatisUtils@isNotEmpty(dpDt)">
                       AND RRD.DP_DT = #{dpDt}
                      </if>
                     ORDER BY RRD.CNTR_NO , RRD.CNTR_SN ,RRD.RVE_DT
                 ) T1
    </select>

    <select id="selectRefundDetailPage" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundDetailRes">
           SELECT
                  T1.RVE_NO
                , T1.RVE_SN
                , T1.CNTR_NO
                , T1.CNTR_SN
                , T1.CNTR_DTL_NO
                , T1.DP_DT
                , T1.DP_MES_CD
                , T1.RVE_DV_CD
                , T1.DP_AMT
                , T1.DP_AMT - T1.DLQ_ADD_AMT - T1.MM_ISTM_AMT - T1.BOR_AMT - T1.SV_AMT AS RFND_PSB_AMT /* 입금액 => 환불가능금액 */
                , T1.BLTF_ADD
                , T1.RFND_CSH_AK_AMT
                , T1.RFND_CARD_AK_AMT
                , T1.CRDCD_FEE_AMT
                , T1.RFND_BLTF_AK_AMT
                , T1.RFND_AK_NO
                , T1.FNIT_CD
                , NVL(T1.CRDCD_FER , 0) AS CRDCD_FER
                , CST_NO
             FROM ( SELECT RRD.RVE_NO      /* 수납번호 */
                         , RRD.RVE_SN      /* 수납일련번호 */
                         , RRAD.CNTR_NO     /* 계약번호*/
                         , RRAD.CNTR_SN     /* 계약일련번호 */
                         , RRAD.CNTR_NO || RRAD.CNTR_SN AS CNTR_DTL_NO /* 계약상세번호 */
                         , RRD.DP_DT               /* 입금일 */
                         , RRD.DP_MES_CD           /* 입금수단 */
                         , RRD.RVE_DV_CD            /* 입금유형 -> 수납유형(사양서, 설계서결과에 맞게 수정) */
                         , (SELECT
                                   NVL(MAX(S9.SV_AMT),0)
                              FROM TB_CBCL_WELLS_SL_MM_CL_IZ S9
                             WHERE 1 = 1
                               AND S9.CNTR_NO = SCD.CNTR_NO
                               AND S9.CNTR_SN = SCD.CNTR_SN
                               AND S9.DTA_DL_YN = 'N'
                           ) AS SV_AMT /* 서비스금액 */
                         , NVL(RRD.DP_AMT, 0) AS DP_AMT /* 입금액 */
                         , NVL(CBCB.DLQ_ADD_AMT,0) AS DLQ_ADD_AMT  /* 연체가산금 */
                         , NVL(SCD.MM_ISTM_AMT,0) AS MM_ISTM_AMT /* 월 납부금(월 납입금) */
                         , NVL(CBCB.RSG_BOR_AMT,0) AS BOR_AMT /* 위약금 */
<!--                         , NVL(RRAD.CRDCD_FER, 0) AS CRDCD_FER   /* 카드수수료율 */-->
                         , '전금행추가' AS BLTF_ADD  /* 전금행추가 - 컬럼 */
                         , NVL(RRAD.RFND_CSH_AK_AMT, 0) AS RFND_CSH_AK_AMT
                         , NVL(RRAD.RFND_CARD_AK_AMT, 0) AS RFND_CARD_AK_AMT
                         , NVL(RRAD.CRDCD_FEE_AMT, 0) AS CRDCD_FEE_AMT
                         , NVL(RRAD.RFND_BLTF_AK_AMT, 0) AS RFND_BLTF_AK_AMT
                         , RRAD.RFND_AK_NO
                         , RRKD.FNIT_CD
                         , RFFB.CRDCD_FER
                         , SCB.CNTR_CST_NO AS CST_NO
                      FROM TB_RVDW_RFND_AK_DTL RRAD /* 환불요청상세 */
                     INNER JOIN TB_RVDW_RVE_DTL RRD /* 수납상세 */
                        ON RRD.CNTR_NO = RRAD.CNTR_NO
                       AND RRD.CNTR_SN = RRAD.CNTR_SN
                       AND RRD.RVE_NO = RRAD.RVE_NO
                       AND RRD.RVE_SN = RRAD.RVE_SN
                       AND RRAD.DTA_DL_YN = 'N'
                     INNER JOIN TB_RVDW_RVE_AK_DTL RRKD
                        ON RRKD.KW_GRP_CO_CD = RRD.KW_GRP_CO_CD
                       AND RRKD.RVE_AK_NO = RRD.RVE_AK_NO
                       AND RRKD.RVE_AK_SN = RRD.RVE_AK_SN
                       AND RRKD.DTA_DL_YN = 'N'
                     INNER JOIN TB_SSCT_CNTR_DTL SCD /* 계약상세 */
                        ON SCD.CNTR_NO = RRD.CNTR_NO
                       AND SCD.CNTR_SN = RRD.CNTR_SN
                       AND SCD.DTA_DL_YN = 'N'
                     INNER JOIN TB_SSCT_CNTR_BAS SCB /* 계약기본 */
                        ON SCB.CNTR_NO = SCD.CNTR_NO
                       AND SCB.DTA_DL_YN = 'N'
                      LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS CBCB /*채권계약기본*/
                        ON CBCB.CNTR_NO = SCD.CNTR_NO
                       AND CBCB.CNTR_SN = SCD.CNTR_SN
                       AND CBCB.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
                       AND CBCB.DTA_DL_YN = 'N'
                      LEFT OUTER JOIN TB_RVDW_FNIT_FEE_BAS RFFB
                        ON RFFB.KW_GRP_CO_CD = RRKD.KW_GRP_CO_CD
                       AND RFFB.FNIT_CD = RRKD.FNIT_CD
                       AND RFFB.FNIT_FEE_TP_CD = '2'
                       AND RFFB.DTA_DL_YN = 'N'
                       AND RFFB.VL_STRTDT  <![CDATA[<=]]> RRD.RVE_DT
                       AND RFFB.VL_ENDDT   >=   RRD.RVE_DT
                     WHERE 1 = 1
                       AND RRD.DTA_DL_YN = 'N'
                       AND RRAD.RFND_AK_NO = #{rfndAkNo}
                      <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                       AND RRAD.CNTR_NO = #{cntrNo}
                      </if>
                      <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                       AND RRAD.CNTR_SN = #{cntrSn}
                      </if>
                  ) T1
    </select>

    <!-- TODO: 전금상세 - 환불전금요청상세 조회 -->
    <select id="selectRefundBalanceTransfer" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundBalanceTransferRes">
              SELECT RRABD.CNTR_NO
                   , RRABD.CNTR_SN
                   , RRABD.CNTR_NO || RRABD.CNTR_SN AS CNTR_DTL_NO
                   , RRABD.RVE_NO /* 수납코드 */
                   , RRABD.RVE_SN
                   , RRD.DP_DT     /* 입금일자 */
                   , RRD.DP_MES_CD /* 입금수단코드 */
                   , NVL(RRD.DP_AMT, 0) AS DP_AMT /* 입금액 */
                   , RRABD.BLTF_OJ_CNTR_NO
                   , RRABD.BLTF_OJ_CNTR_SN
                   , RRABD.BLTF_OJ_CNTR_NO || RRABD.BLTF_OJ_CNTR_SN AS BLTF_OJ_CNTR_DTL_NO
                   , RRABD.RFND_BLTF_AK_AMT /* 환불전금요청금액 */
                   , SCD.SELL_TP_CD
                   , RRABD.BLTF_RFND_MB_DV_CD
                   , RRABD.RFND_EVID_MTR_FILE_ID
                   , '파일찾기' AS RFND_EVID_MTR_FILE_NM
                   , RRABD.RFND_AK_NO
                FROM TB_RVDW_RFND_AK_BLTF_DTL RRABD
               INNER JOIN TB_RVDW_RVE_DTL RRD
                  ON RRABD.CNTR_NO = RRD.CNTR_NO
                 AND RRABD.CNTR_SN = RRD.CNTR_SN
                 AND RRD.RVE_NO = RRABD.RVE_NO
                 AND RRD.RVE_SN = RRABD.RVE_SN
                 AND RRD.DTA_DL_YN = 'N'
               INNER JOIN TB_SSCT_CNTR_DTL SCD
                  ON SCD.CNTR_NO = RRD.CNTR_NO
                 AND SCD.CNTR_SN = RRD.CNTR_SN
                 AND SCD.DTA_DL_YN = 'N'
               WHERE 1 = 1
                 AND RRABD.DTA_DL_YN = 'N'
                 AND RRABD.RFND_AK_NO = #{rfndAkNo}
                <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                 AND RRABD.CNTR_NO = #{cntrNo}
                </if>
                <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                 AND RRABD.CNTR_SN = #{cntrSn}
                </if>
    </select>




    <!-- TODO: 임시저장 -->
    <select id="selectRefundPk" resultType="java.lang.String">
        SELECT 'RVR' || TO_CHAR(SYSDATE, 'YYYY') || LPAD(NVL(MAX(SUBSTR(RFND_AK_NO , 9)),0) + 1,12,'0') AS RFND_AK_NO
          FROM TB_RVDW_RFND_AK_BAS /* 환불요청기본 */
    </select>

    <insert id="insertRefundTempSave">
         MERGE INTO TB_RVDW_RFND_AK_BAS T1 /* 환불요청기본 */
         USING DUAL
            ON (
                T1.KW_GRP_CO_CD = #{session.companyCode}
            AND T1.RFND_AK_NO = #{rfndAkNo}
               )
          WHEN MATCHED THEN
        UPDATE
           SET T1.ARFND_YN = #{arfndYn}
             , T1.CSH_RFND_FNIT_CD = #{cshRfndFnitCd}
             , T1.CSH_RFND_ACNO_ENCR = #{cshRfndAcnoEncr}
             , T1.CSH_RFND_ACOWN_NM = #{cshRfndAcownNm}
             , T1.RFND_CSH_AK_SUM_AMT = #{rfndCshAkSumAmt}
             , T1.RFND_CARD_AK_SUM_AMT = #{rfndCardAkSumAmt}
             , T1.RFND_BLTF_AK_SUM_AMT = #{rfndBltfAkSumAmt}
             , T1.CRDCD_FEE_SUM_AMT = #{crdcdFeeSumAmt}
             , T1.RFND_AK_STAT_CD = #{rfndAkStatCd}
             , T1.RFND_RVE_DT  =  #{rveDt}
             , T1.RFND_PERF_DT  =  #{perfDt}
             , T1.RFND_DSB_DT  = #{dsbDt}
             , T1.RFND_PROCS_DV_CD = #{rfndProcsDvCd}
             , T1.RFND_PROCS_CN = #{rfndProcsCn}
             , T1.DTA_DL_YN = 'N'
           <include refid="COMMON.updateSystemField" />
         WHEN NOT MATCHED THEN
       INSERT
             (
               KW_GRP_CO_CD
             , RFND_AK_NO
             , RFND_AK_DTM
             , RFND_AK_PRTNR_OG_TP_CD
             , RFND_AK_PRTNR_NO
             , ARFND_YN
             , CSH_RFND_FNIT_CD
             , CSH_RFND_ACNO_ENCR
             , CSH_RFND_ACOWN_NM
             , RFND_CSH_AK_SUM_AMT
             , RFND_CARD_AK_SUM_AMT
             , RFND_BLTF_AK_SUM_AMT
             , CRDCD_FEE_SUM_AMT
             , RFND_AK_STAT_CD
             , RFND_RVE_DT
             , RFND_PERF_DT
             , RFND_DSB_DT
             , RFND_PROCS_DV_CD
             , RFND_PROCS_CN
             , RFND_PROCS_USR_ID
             , RVE_CO_CD
             , DTA_DL_YN            /*데이터삭제여부*/
        <include refid="COMMON.insertSystemField"/>
             ) VALUES (
               #{session.companyCode}
             , #{aftRfndAkNo}
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
             , #{rfndAkPrtnrOgTpCd}
             , #{rfndAkPrtnrNo}
             , #{arfndYn}
             , #{cshRfndFnitCd}
             , #{cshRfndAcnoEncr}
             , #{cshRfndAcownNm}
             , #{rfndCshAkSumAmt}
             , #{rfndCardAkSumAmt}
             , #{rfndBltfAkSumAmt}
             , #{crdcdFeeSumAmt}
             , #{rfndAkStatCd} /* 임시저장:00, 접수:01, 진행중:02, 승인:03, 반려:99 */
             , #{rveDt}
             , #{perfDt}
             , #{dsbDt}
             , #{rfndProcsDvCd}
             , #{rfndProcsCn}
             , #{seesion.userId}
             , #{session.companyCode}
             , 'N'
       <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <insert id="insertRefundTempSaveReqDetail">
        MERGE INTO TB_RVDW_RFND_AK_CNTR_DTL T1 /* */
        USING DUAL
            ON (
                T1.KW_GRP_CO_CD = #{session.companyCode}
            AND T1.RFND_AK_NO = #{rfndAkNo}
            AND T1.CNTR_NO = #{cntrNo}
            AND T1.CNTR_SN = #{cntrSn}
               )
          WHEN MATCHED THEN
        UPDATE
           SET DTA_DL_YN = 'N' /* 수정되는 데이터 없어보여서 수정데이터 삽입X */
         <include refid="COMMON.updateSystemField" />
          WHEN NOT MATCHED THEN
         INSERT
               (
                 KW_GRP_CO_CD
               , RFND_AK_NO
               , CNTR_NO
               , CNTR_SN
               , CST_NO
               , DTA_DL_YN
             <include refid="COMMON.insertSystemField"/>
               ) VALUES (
                 '2000' /* WELLS*/
               , #{aftRfndAkNo}
               , #{cntrNo}
               , #{cntrSn}
               , #{cstNo}
               , 'N'
             <include refid="COMMON.insertSystemFieldValue"/>
               )
    </insert>


    <insert id="insertRefundTempSaveDetail">
        MERGE INTO TB_RVDW_RFND_AK_DTL T1 /* 환불요청상세 */
        USING DUAL
           ON (
                T1.KW_GRP_CO_CD = #{session.companyCode}
            AND T1.RFND_AK_NO = #{rfndAkNo}
            AND T1.RVE_NO = #{rveNo}
            AND T1.RVE_SN = #{rveSn}
              )
         WHEN MATCHED THEN
       UPDATE
          SET T1.CSH_RFND_DV_CD = '02' <!-- TODO: #{rfndDvCd} 01:선환불, 02:일반환불, 03:카드현금-->
            , T1.RFND_CSH_AK_AMT = #{rfndCshAkAmt}
            , T1.RFND_CARD_AK_AMT = #{rfndCardAkAmt}
            , T1.CRDCD_FEE_AMT = #{crdcdFeeAmt}
            , T1.RFND_BLTF_AK_AMT = #{rfndBltfAkAmt}
            , T1.RFND_RSON_CD = #{rfndRsonCd}
            , T1.RFND_RSON_CN = #{rfndRsonCn}
           <include refid="COMMON.updateSystemField" />
        WHEN NOT MATCHED THEN
      INSERT
             (
               KW_GRP_CO_CD
             , RFND_AK_NO
             , CNTR_NO
             , CNTR_SN
             , RVE_NO
             , RVE_SN
             , CST_NO
             , RFND_DV_CD
             , RFND_DSB_DV_CD
             , CSH_RFND_DV_CD
             , RFND_CSH_AK_AMT
             , RFND_CARD_AK_AMT
             , CRDCD_FEE_AMT
             , CRDCD_FER
             , RFND_BLTF_AK_AMT
             , RFND_RSON_CD
             , RFND_RSON_CN
             , DTA_DL_YN
       <include refid="COMMON.insertSystemField"/>
             ) VALUES (
               '2000'
             , #{aftRfndAkNo}
             , #{cntrNo}
             , #{cntrSn}
             , #{rveNo}
             , #{rveSn}
             , #{cstNo}
             , '02' /* 환불구분코드 01:전체, 02:부분*/
             , '01' /* 환불지급구분코드 01~08 매 환불마다 구분해야할듯함. */
             , '02' /* 01: 선환불 , 02: 일반환불, 03: 카드현금 */
             , #{rfndCshAkAmt}
             , #{rfndCardAkAmt}
             , #{crdcdFeeAmt}
             , #{crdcdFer}
             , #{rfndBltfAkAmt}
             , #{rfndRsonCd}
             , #{rfndRsonCn}
             , 'N'
       <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <insert id="insertBalanceTempSaveDetail">
        MERGE INTO TB_RVDW_RFND_AK_BLTF_DTL T1 /* 전금요청상세 */
        USING DUAL
           ON (
                T1.KW_GRP_CO_CD = #{session.companyCode}
            AND T1.RFND_AK_NO = #{rfndAkNo}
            AND T1.CNTR_NO = #{cntrNo}
            AND T1.CNTR_SN = #{cntrSn}
            AND T1.RVE_NO = #{rveNo}
            AND T1.RVE_SN = #{rveSn}
              )
         WHEN MATCHED THEN
       UPDATE
          SET T1.RFND_BLTF_AK_AMT = #{rfndBltfAkAmt}
            , T1.BLTF_OJ_CNTR_NO = #{bltfOjCntrNo}
            , T1.BLTF_OJ_CNTR_SN = #{bltfOjCntrSn}
            , T1.BLTF_RFND_MB_DV_CD = #{bltfRfndMbDvCd}
            , T1.RFND_EVID_MTR_FILE_ID = #{rfndEvidMtrFileId}
            , T1.DTA_DL_YN = 'N' /* 조건없으면 수정하더라도 삭제하면 데이터가 안보임.*/
           <include refid="COMMON.updateSystemField" />
        WHEN NOT MATCHED THEN
        INSERT
             (
               KW_GRP_CO_CD
             , RFND_AK_NO
             , CNTR_NO
             , CNTR_SN
             , RVE_NO
             , RVE_SN
             , BLTF_OJ_CNTR_NO
             , BLTF_OJ_CNTR_SN
             , CST_NO
             , RFND_BLTF_AK_AMT
             , BLTF_RFND_DV_CD
             , BLTF_RFND_TP_CD
             , BLTF_RFND_MB_DV_CD
             , RFND_EVID_MTR_FILE_ID
             , DTA_DL_YN
        <include refid="COMMON.insertSystemField"/>
             ) VALUES (
               #{session.companyCode}
             , #{rfndAkNo} /* 행추가시 rfndAkNo는 항상있으므로 재채번할필요없음. */
             , #{cntrNo}
             , #{cntrSn}
             , #{rveNo}
             , #{rveSn}
             , #{bltfOjCntrNo}
             , #{bltfOjCntrSn}
             , #{cstNo}
             , #{rfndBltfAkAmt}
             , '01' /* 전금환불구분코드. 01:카드 , 02: 현금 */
             , '1' /* 전금환불유형코드. 1:인수금 2:할부금 */
             , #{bltfRfndMbDvCd}
             , #{rfndEvidMtrFileId}
             , 'N'
        <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>
    <!-- TODO: INSERT END-->

    <update id="deleteBalanceTempSaveDetail">
        UPDATE TB_RVDW_RFND_AK_BLTF_DTL /* 전금요청상세 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND RFND_AK_NO = #{rfndAkNo}
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND DTA_DL_YN = 'N'
    </update>
    <!-- TODO: 임시저장 -->

    <!-- TODO: 삭제 -->
    <update id="deleteRefundBase">
        UPDATE TB_RVDW_RFND_AK_BAS /* 환불요청기본 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND RFND_AK_NO = #{rfndAkNo}
           AND DTA_DL_YN = 'N'
    </update>
    <update id="deleteRefundCntrDetail">
        UPDATE TB_RVDW_RFND_AK_CNTR_DTL /* 환불요청계약상세 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND RFND_AK_NO = #{rfndAkNo}
           AND DTA_DL_YN = 'N'
    </update>
    <update id="deleteRefundDetail">
        UPDATE TB_RVDW_RFND_AK_DTL /* 환불요청상세 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND RFND_AK_NO = #{rfndAkNo}
           AND DTA_DL_YN = 'N'
    </update>
    <update id="deleteRefundBalanceDetail">
        UPDATE TB_RVDW_RFND_AK_BLTF_DTL /* 전금요청상세 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND RFND_AK_NO = #{rfndAkNo}
           AND DTA_DL_YN = 'N'
    </update>

    <select id="selectRefundApplicationConnectHistory" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundApplicationDto$SearchRefundApplicationConnectHistoryRes">
        SELECT CTT_RCP_DTM              /* 컨택일시 */
             , CTT_CHNL_TP_CD           /* 상담경로 */
             , ( SELECT PRTNR_KNM
                   FROM TB_OGBS_PRTNR_BAS
                  WHERE PRTNR_NO = CTT_PSIC_ID
               ) AS PRTNR_KNM              /* 상담자 */
             , CTT_PSIC_ID              /* 번호 */
             , CTT_MO_CN                /* 상담내용 */
          FROM TB_SSOP_CTT_BAS          /* 컨택기본 */
         WHERE CNTR_NO = #{cntrNo}      /* 계약번호*/
    </select>
</mapper>
