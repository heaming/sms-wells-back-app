<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.idvrve.mapper.WwdbContractRefundMapper">

    <select id="selectContractRefunds" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbContractRefundDto$SearchContractRefundRes">
        <include refid="selectRefundsInfo"/>
    </select>

    <select id="selectContractRefundSummary"
            resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbContractRefundDto$SearchContractRefundSummaryRes">
        SELECT COUNT(1) AS CNT_CST_KNM
             , SUM(SELL_AMT) AS TOT_SELL_AMT
             , SUM(DSB_AMT) AS TOT_DSB_AMT
             , SUM(RFND_DSB_AMT) AS  TOT_RFND_DSB_AMT
             , SUM(RFND_DSB_PSP_INT) AS TOT_RFND_DSB_PSP_INT
             , SUM(CARD_RFND_FEE) AS TOT_CARD_RFND_FEE
          FROM (
                <include refid="selectRefundsInfo"/>
               )
    </select>

    <select id="selectContractRefundAggregates" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbContractRefundDto$SearchContractRefundAggregateRes">
        SELECT SUM(CASE WHEN DP_MES_CD = '01' THEN RVE_AMT ELSE 0 END ) AS CASH_RFND_DSB_AMT_SUM /*현금환불*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '02' AND CARD_RFND_FNIT_CD = '361' THEN ON_RFND_DSB_AMT ELSE 0 END) AS BC_CARD_RFND_DSB_AMT_SUM /*비씨카드*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '02' AND CARD_RFND_FNIT_CD = '381' THEN ON_RFND_DSB_AMT ELSE 0 END) AS KB_CARD_RFND_DSB_AMT_SUM 	/*국민카드*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '02' AND CARD_RFND_FNIT_CD = '365' THEN ON_RFND_DSB_AMT ELSE 0 END) AS SS_CARD_RFND_DSB_AMT_SUM     /*삼성카드*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '02' AND CARD_RFND_FNIT_CD = '374' THEN ON_RFND_DSB_AMT ELSE 0 END) AS HN_CARD_RFND_DSB_AMT_SUM 	/*하나카드*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '02' AND CARD_RFND_FNIT_CD = '366' THEN ON_RFND_DSB_AMT ELSE 0 END) AS SH_CARD_RFND_DSB_AMT_SUM 	/*신한카드*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '02' AND CARD_RFND_FNIT_CD = '368' THEN ON_RFND_DSB_AMT ELSE 0 END) AS LT_CARD_RFND_DSB_AMT_SUM 	/*롯데카드*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '02' AND CARD_RFND_FNIT_CD = '367' THEN ON_RFND_DSB_AMT ELSE 0 END) AS HD_CARD_RFND_DSB_AMT_SUM 	/*현대카드*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '02' AND CARD_RFND_FNIT_CD = '371' THEN ON_RFND_DSB_AMT ELSE 0 END) AS NH_CARD_RFND_DSB_AMT_SUM 	/*NH농협*/
           , SUM(CASE WHEN DP_TP_CD = '0202' THEN RVE_AMT ELSE 0 END )  AS YD_CARD_RFND_DSB_AMT_SUM /*여민카드*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '01'  THEN CARD_RFND_FEE ELSE 0 END )	AS CARD_RFND_DDTN_AMT_SUM	/*카드 공제*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '04' THEN ON_RFND_DSB_AMT ELSE 0 END ) AS BLNG_AMT		/*회사 귀속*/
           , SUM(CASE WHEN (RFND_DSB_DV_CD = '01' OR CSH_RFND_DV_CD = '03') THEN NVL(DSB_AMT,0) - NVL(CARD_RFND_AMT , 0)  ELSE 0 END) AS CASH_CARD_RFND_DDTN_AMT_SUM	/*현금계(현금+카드공제)*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '02' THEN ON_RFND_DSB_AMT ELSE 0 END) AS CARD_RFND_DSB_AMT_SUM			/*카드 합계*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '03' AND BLTF_RFND_TP_CD = '01' AND CNTRW_TP_CD != '5' THEN ON_RFND_DSB_AMT ELSE 0 END ) AS TK_MRNT_BLTF_SUM		/*인수 월세 전금*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '03' AND BLTF_RFND_TP_CD = '01' AND CNTRW_TP_CD = '5' THEN ON_RFND_DSB_AMT ELSE 0 END ) AS TK_HCR_BLTF_SUM		/*인수 홈케어 전금*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '03' AND BLTF_RFND_TP_CD = '01' THEN ON_RFND_DSB_AMT ELSE 0 END	) AS TK_BLTF_RESULT_SUM 	/*인수전금 계*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '03' AND BLTF_RFND_TP_CD = '02' THEN ON_RFND_DSB_AMT ELSE 0 END	) AS ISTM_BLTF_SUM	/*할부전금(웰스)*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '03' AND BLTF_RFND_TP_CD = '02' THEN ON_RFND_DSB_AMT ELSE 0 END	) AS ISTM_BLTF_RESULT_SUM	/*할부전금 계*/
           , NVL(SUM(RFND_DSB_PSP_INT),0) AS RFND_DSB_PSP_INT_SUM		/*지연이자*/
           , SUM(CASE WHEN DP_MES_CD = '06' THEN RVE_AMT ELSE 0 END) AS POINT_SUM		/*K 포인트*/
           , SUM(CASE WHEN RFND_DSB_DV_CD = '03' THEN ON_RFND_DSB_AMT ELSE 0 END ) AS RFND_BLTF_SUM		/*전금 합계*/
           , SUM(RVE_AMT) AS RF_TOTAL_SUM  /*총계*/
        FROM (
              <include refid="selectRefundsInfo"/>
             )
    </select>

    <sql id="selectRefundsInfo">
        SELECT T1.RVE_NO
             , T1.RVE_SN
             , T3.RFND_RCP_NO
             , T3.RFND_RCP_DTL_SN
             , CASE WHEN T1.DP_DV_CD = '2' THEN T1.CNTR_NO
                    WHEN T1.DP_DV_CD = '4' THEN T3.BLTF_OJ_CNTR_NO
                     END AS CNTR_NO /*계약번호*/
             , CASE WHEN T1.DP_DV_CD = '2' THEN T1.CNTR_SN
                    WHEN T1.DP_DV_CD = '4' THEN T3.BLTF_OJ_CNTR_SN
                     END AS CNTR_SN /*계약일련번호*/
             , CASE WHEN T1.DP_DV_CD = '2' THEN T1.CNTR_NO || '-' || T1.CNTR_SN
                    WHEN T1.DP_DV_CD = '4' THEN T3.BLTF_OJ_CNTR_NO || '-' || BLTF_OJ_CNTR_SN
                     END AS CNTR_DTL_NO /*계약상세번호*/
             , (SELECT S1.CST_KNM
                  FROM TB_CUBS_CST_BAS S1                 /* 고객기본 */
                 WHERE S1.DTA_DL_YN = 'N'
                   AND S1.CST_NO =  (CASE WHEN T1.DP_DV_CD = '2' THEN T1.CST_NO
                                          WHEN T1.DP_DV_CD = '4' THEN T3.BLTF_OJ_CST_NO
                                           END ) ) AS CST_KNM  /* 고객명 */
             , T1.RVE_DT AS RFND_RVE_DT /*처리일자*/
             , T1.PERF_DT AS RFND_PERF_DT /*실적일자*/
             , CASE WHEN T2.CNTRW_TP_CD = '5' THEN '홈케어'
                    ELSE '웰스'
                END CNTRW_TP_CD /*업무구분*/
             , '' AS tmp1                  /* 테이블 컬럼명 확인필요. 출력구분 */
             , NVL(T2.SELL_AMT,0) AS SELL_AMT 	/*판매금액*/
             , CASE WHEN T3.RFND_DSB_DV_CD = '01' THEN NVL(T1.RVE_AMT,0) + NVL(T3.CARD_RFND_FEE,0)
                    ELSE NVL(T1.RVE_AMT,0)
                     END AS DSB_AMT 		/*지급금액*/
             , CASE WHEN T3.RFND_DSB_DV_CD = '01' THEN NVL(T1.RVE_AMT,0) + NVL(T3.CARD_RFND_FEE,0)
                    ELSE NVL(T1.RVE_AMT,0)
                     END AS RFND_DSB_AMT 		/*지급금액*/
             , NVL(T3.RFND_DSB_PSP_INT,0) AS RFND_DSB_PSP_INT	/*지연이자*/
             , CASE WHEN T3.RFND_DSB_DV_CD = '01' THEN NVL(T3.CARD_RFND_FEE,0)
                    ELSE 0
                     END AS CARD_RFND_FEE		/*카드수수료*/
             , ( SELECT FNIT_NM
                   FROM TB_RVDW_FNIT_CD                 /* 금융기관코드 */
                  WHERE FNIT_CD = (  CASE WHEN T3.CSH_RFND_FNIT_CD IS NULL
                                          THEN T3.CARD_RFND_FNIT_CD
                                          ELSE T3.CSH_RFND_FNIT_CD
                                      END
                                  ) ) AS CSH_CARD_RFND_FNIT_CD                 /* 은행/카드사 RFND_BNK_CDCO_CD  */
             , T3.CSH_RFND_ACNO_ENCR		/*계좌번호*/
             , T3.CARD_RFND_CRCDNO_ENCR	/*카드번호*/
             , '' AS CSH_CARD_RFND_ACNO_CRCDNO_ENCR     /* 계좌/카드번호 */
             , NVL(T3.CSH_RFND_ACOWN_NM , T3.CARD_RFND_CRCDONR_NM ) AS CSH_RFND_ACOWN_NM	 /*예금주*/
             , T3.CARD_RFND_CRDCD_ISTM_MCN AS ISTM_MCN	/*할부개월*/
             , T3.CARD_RFND_CRDCD_APRNO AS CARD_RFND_CRDCD_APRNO	/*승인번호*/

             , T1.RVE_AMT
             , T3.RFND_DSB_DV_CD
             , T1.DP_MES_CD
             , T1.DP_TP_CD
             , T3.BLTF_RFND_TP_CD
             , T3.CSH_RFND_DV_CD
             , T3.CARD_RFND_FNIT_CD
             , NVL(T1.RVE_AMT,0) AS ON_RFND_DSB_AMT
             , CASE WHEN T3.RFND_DSB_DV_CD = '02' THEN RFND_DSB_AMT ELSE 0 END AS CARD_RFND_AMT
          FROM TB_RVDW_RVE_DTL T1
         INNER JOIN TB_SSCT_CNTR_DTL T2
            ON (    T2.CNTR_NO = T1.CNTR_NO
                AND T2.CNTR_SN = T1.CNTR_SN
                AND T2.DTA_DL_YN = 'N' )
         LEFT OUTER JOIN (SELECT S1.KW_GRP_CO_CD
                               , S1.RFND_RCP_NO
                               , S1.RFND_RCP_DTL_SN
                               , S1.RFND_DSB_PSP_INT
                               , S1.CARD_RFND_FEE
                               , S1.CSH_RFND_FNIT_CD
                               , S1.CARD_RFND_FNIT_CD
                               , S1.CSH_RFND_ACNO_ENCR
                               , S1.CARD_RFND_CRCDNO_ENCR
                               , S1.CARD_RFND_CRDCD_APRNO
                               , S1.CSH_RFND_ACOWN_NM
                               , S1.CARD_RFND_CRCDONR_NM
                               , S1.CARD_RFND_CRDCD_ISTM_MCN
                               , S1.RFND_DSB_AMT
                               , S1.CSH_RFND_DV_CD
                               , S1.BLTF_RFND_TP_CD
                               , S1.BLTF_OJ_CNTR_SN
                               , S1.BLTF_OJ_CNTR_NO
                               , S1.RFND_DSB_DV_CD
                               , (SELECT SS1.CNTR_CST_NO
                                    FROM TB_SSCT_CNTR_BAS SS1
                                   WHERE 1 = 1
                                     AND SS1.CNTR_NO = S1.BLTF_OJ_CNTR_NO
                                     AND SS1.DTA_DL_YN = 'N' ) AS BLTF_OJ_CST_NO
                            FROM TB_RVDW_RFND_RCP_DTL S1
                           INNER JOIN TB_RVDW_RFND_RCP_BAS S2
                              ON (    S2.KW_GRP_CO_CD = S1.KW_GRP_CO_CD
                                  AND S2.RFND_RCP_NO = S1.RFND_RCP_NO
                                  AND S2.DTA_DL_YN = 'N'
                                  AND S2.RFND_RVE_DT  <![CDATA[>=]]> #{startDay}
                                  AND S2.RFND_RVE_DT  <![CDATA[<=]]> #{endDay}
                                  <if test="@MybatisUtils@isNotEmpty(perfDtStartDay)">
                                  AND S2.RFND_PERF_DT <![CDATA[>=]]> #{perfDtStartDay}
                                  </if>
                                  <if test="@MybatisUtils@isNotEmpty(perfDtEndDay)">
                                  AND S2.RFND_PERF_DT <![CDATA[<=]]> #{perfDtEndDay}
                                  </if>
                                  AND S2.RFND_STAT_CD = '03'
                                  )
                            WHERE 1 = 1
                              AND S1.DTA_DL_YN = 'N') T3
            ON (    T3.KW_GRP_CO_CD = T1.KW_GRP_CO_CD
                AND T3.RFND_RCP_NO = T1.RVE_OJ_DRM_NO1)
         WHERE 1 = 1
           AND T1.RVE_DT  <![CDATA[>=]]> #{startDay}
           AND T1.RVE_DT  <![CDATA[<=]]> #{endDay}
          <if test="@MybatisUtils@isNotEmpty(perfDtStartDay)">
           AND T1.PERF_DT <![CDATA[>=]]> #{perfDtStartDay}
          </if>
          <if test="@MybatisUtils@isNotEmpty(perfDtEndDay)">
           AND T1.PERF_DT <![CDATA[<=]]> #{perfDtEndDay}
          </if>
           AND T1.KW_GRP_CO_CD = '2000'
<!--           AND T1.DP_DV_CD IN ('2')-->
           AND T1.DP_DV_CD IN ('2','4')
           AND T1.RVE_DV_CD = '01'
           AND T1.DP_TP_CD NOT IN ('0204' , '0103')
           AND T1.PROCS_DV_CD = '1'
          <if test="@MybatisUtils@isNotEmpty(cntrwTpCd) and cntrwTpCd != 'all' and cntrwTpCd != 'ALL'">
              <choose>
                  <when test="@MybatisUtils@equals(cntrwTpCd, '1')">
              AND T2.CNTRW_TP_CD != 5           /* 업무구분 계약서유형코드 */
                  </when>
                  <otherwise>
              AND T2.CNTRW_TP_CD = 5           /* 업무구분 계약서유형코드 */
                  </otherwise>
              </choose>

          </if>
         ORDER BY T1.RVE_DT , T1.PERF_DT, T1.CNTR_NO , T1.CNTR_SN
    </sql>
</mapper>
