<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.idvrve.mapper.WwdbRefundCurrentStatusMapper">
    
    <select id="selectRefundHistory" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundCurrentStatusDto$SearchRefundHistoryRes">
        SELECT 
               RRD.CNTR_NO                              /* 계약번호 테스트용 RRD가 NULL이어서 RRRB로 바꿈*/
             , RRD.CNTR_SN                              /* 계약일련번호 테스트용 RRD가 NULL이어서 RRRB로 바꿈*/
             , CCB.CST_KNM                              /* 고객명 */
             , SCD.SELL_TP_CD                           /* 판매유형 */
             , NVL(SUM(RRD.DP_AMT), 0) AS DP_AMT        /* 입금총액 */
             , NVL(SUM(RRD.RVE_AMT), 0) AS RVE_AMT      /* 지급금액 */
             , NVL(SUM(RRRD.RFND_DSB_AMT), 0) AS RFND_DSB_AMT                       /* 환불금액 */
             , NVL(SUM(RRRD.RFND_DSB_PSP_INT), 0) AS RFND_DSB_PSP_INT                   /* 지연이자 */
             , NVL(SUM(RRRD.RFND_DDTN_AMT), 0) AS RFND_DDTN_AMT                      /* 카드공제 */
             , RRRD.CSH_RFND_FNIT_CD                    
             , ( SELECT RFC.FNIT_NM
                   FROM TB_RVDW_FNIT_CD RFC /* 금융기관코드 */
                  WHERE RFC.FNIT_CD = RRRD.CSH_RFND_FNIT_CD
             ) AS CSH_FNIT_NM                           /* 은행사 */
             , RRRD.CARD_RFND_FNIT_CD                   
             , ( SELECT RFC.FNIT_NM
                   FROM TB_RVDW_FNIT_CD RFC /* 금융기관코드 */
                  WHERE RFC.FNIT_CD = RRRD.CARD_RFND_FNIT_CD
             ) AS CARD_FNIT_NM                          /* 카드사 */
             , RRRD.CSH_RFND_ACNO_ENCR                  /* 계좌번호 */
             , RRRD.CARD_RFND_CRCDNO_ENCR               /* 카드번호 */
             , RRRD.CSH_RFND_ACOWN_NM                   /* 예금주 현금 */
             , RRRD.CARD_RFND_CRDCD_APRNO               /* 예금주 카드 */
             , '' AS TMP1                               /* 판매유형. 알수 없음으로 작성되어 있음. */
             , RRD.RVE_DV_CD                            /* 입금유형 */
             , RRRB.CST_NO                              /* 전금고객번호 */
             , '' AS TMP2                               /* 전금고객명. 작성되어 있지 않음. 전금고객번호가 잘못잘성되어 있는 것으로 판단되어 고객명으로 사용하지 않음.*/ 
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
          JOIN TB_RVDW_RFND_RCP_DTL RRRD                /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N' 
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
          JOIN TB_SSCT_CNTR_DTL SCD                     /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 = 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약상세번호 = 계약상세번호 */
          JOIN TB_RVDW_RVE_DTL RRD                      /* 수납상세 테스트용 LEFT JOIN*/
            ON RRD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = RRD.RVE_OJ_DRM_NO1        /* 환불접수기본.계약번호 = 수납상세.수납대상식별번호1 */
           AND RRRB.CNTR_SN = RRD.RVE_OJ_DRM_NO2        /* 환불접수기본.계약일련번호 = 수납상세.수납대상식별번호2 */
          JOIN TB_CUBS_CST_BAS CCB                      /* 고객기본 */
            ON CCB.DTA_DL_YN = 'N'
           AND RRRB.CST_NO = CCB.CST_NO                 /* 고객번호 = 고객번호 */
         WHERE 1 = 1
          AND RRD.DP_DV_CD = 2                         /* 수납상세.입금구분코드 = 환불. 테스트용 임시 주석*/
          AND RRD.RVE_DT BETWEEN #{rveDtStart} || '000000' AND #{rveDtFinish} || '235959'  /* 수납상세.수납일자 BETWEEN 시작일 AND 종료일 = 환불일자 테스트용 임시 주석*/
          AND RRD.PERF_DT BETWEEN #{perfDtStart} || '000000' AND #{perfDtFinish} || '235959'  /* 수납상세.실적일자 BETWEEN 시작일 AND 종료일 = 실적일자 테스트용 임시 주석*/
           <if test='@MybatisUtils@isNotEmpty(rfndDsbDvCd)'>
              <choose>
                <when test='@MybatisUtils@equals(rfndDsbDvCd,"04")'>                 
           AND RRRD.RFND_DSB_DV_CD = '04'               /* 환불접수상세.환불지급구분코드 = 04.귀속 */
                </when>
                <otherwise>
           AND RRRD.RFND_DSB_DV_CD != '04'               /* 환불접수상세.환불지급구분코드 != 04.귀속 */
                </otherwise>
              </choose>
            </if>
            <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
              <choose>
                <when test='@MybatisUtils@equals(sellTpCd,"2")'>
           AND SCD.SELL_TP_CD IN ( 2 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"3")'>
           AND SCD.SELL_TP_CD IN ( 3 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"6")'>
           AND SCD.SELL_TP_CD IN ( 6 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <otherwise>
                </otherwise>
              </choose>
            </if>
          /* AND 판매유형상세 는 알수 없다고 작성되어 있음. */
            <choose>
             <when test='@MybatisUtils@equals(rveDvCd,"09")'>
           AND RRD.RVE_DV_CD = '09'                     /* 수납상세.수납구분코드 = 09.대손이관 = 대손구분 테스트용 임시주석 */
             </when>
             <otherwise>
           AND RRD.RVE_DV_CD != '09'                    /* 수납상세.수납구분코드 != 09.대손이관 = 일반 테스트용 임시주석*/
             </otherwise>
            </choose>
            <if test='@MybatisUtils@isNotEmpty(dpMesCd)'> /* 수납상세.입금구분코드 조건 없음 = 전체 */
              <choose>
                <when test='@MybatisUtils@equals(dpMesCd,"07")'>
           AND RRD.DP_MES_CD = '07'                     /* 수납상세.입금구분코드 = 07.포인트 */
                </when>
                <otherwise>
           AND RRD.DP_MES_CD != '07'                    /* 수납상세.입금구분코드 != 07.포인트 제외 */
                </otherwise>
              </choose>
            </if>
      GROUP BY RRD.CNTR_NO                          /* 계약번호 테스트용 RRD가 NULL이어서 RRRB로 바꿈*/
             , RRD.CNTR_SN                             /* 계약일련번호 테스트용 RRD가 NULL이어서 RRRB로 바꿈*/
             , CCB.CST_KNM                              /* 고객명 */
             , SCD.SELL_TP_CD                           /* 판매유형 */
             , RRRD.CSH_RFND_FNIT_CD                    /* 은행사 */
             , RRRD.CARD_RFND_FNIT_CD                   /* 카드사 */
             , RRRD.CSH_RFND_ACNO_ENCR                  /* 계좌번호 */
             , RRRD.CARD_RFND_CRCDNO_ENCR               /* 카드번호 */
             , RRRD.CSH_RFND_ACOWN_NM                   /* 예금주 현금 */
             , RRRD.CARD_RFND_CRDCD_APRNO               /* 예금주 카드 */
             /* , TMP1                                   판매유형 */
             , RRD.RVE_DV_CD                            /* 입금유형 */
             , RRRB.CST_NO                              /* 전금고객번호 */ 
             /* , TMP2                                   전금고객명 */
    </select>
    
    <select id="selectCardRefundHistory" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundCurrentStatusDto$SearchCardRefundHistoryRes">
        SELECT '21' AS REFUND_DIVISION
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  AS RFND_DSB_AMT /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DDTN_AMT ELSE 0 END), 0) AS RFND_DDTN_AMT /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS BC_RFND_DSB_AMT /* 비씨 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS KB_RFND_DSB_AMT /* 국민 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HN_RFND_DSB_AMT /* 외환 대신 하나 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS SH_RFND_DSB_AMT /* 신한 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS SS_RFND_DSB_AMT /* 삼성 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HD_RFND_DSB_AMT /* 현대 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LT_RFND_DSB_AMT /* 롯데 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS NH_RFND_DSB_AMT /* 농협 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DDTN_AMT ELSE 0 END), 0)  /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 비씨 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 국민 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 외환 대신 하나 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 신한 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 삼성 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 현대 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 롯데 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)   /* 농협 */
                AS SUM_RFND_DSB_DDTN_AMT /* 환불총계 = 현금+카드공제+비씨+국민+외환+신한+삼성+현대+롯데+농협 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 비씨 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 국민 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 외환 대신 하나 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 신한 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 삼성 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 현대 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 롯데 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)   /* 농협 */
                AS SUM_RFND_DSB_PSP_INT /* 지연이자 = 현금+카드공제+비씨+국민+외환+신한+삼성+현대+롯데+농협 */ 
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
          JOIN TB_RVDW_RFND_RCP_DTL RRRD                /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N' 
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
          JOIN TB_SSCT_CNTR_DTL SCD                     /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 = 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약상세번호 = 계약상세번호 */
          JOIN TB_RVDW_RVE_DTL RRD                      /* 수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = RRD.RVE_OJ_DRM_NO1        /* 환불접수기본.계약번호 = 수납상세.수납대상식별번호1 */
           AND RRRB.CNTR_SN = RRD.RVE_OJ_DRM_NO2        /* 환불접수기본.계약일련번호 = 수납상세.수납대상식별번호2 */
         WHERE 1 = 1
           AND RRD.DP_DV_CD = '2' /* 수납상세.입금구분코드 = 2.환불*/
           AND SCD.SELL_TP_DTL_CD = '21' /* 계약상세.판매유형상세코드 = 21.일반렌탈 */
           AND RRD.RVE_DT BETWEEN #{rveDtStart} || '000000' AND #{rveDtFinish} || '235959' /* 수납상세.수납일자 BETWEEN 시작일 AND 종료일 = 환불일자 */
           AND RRD.PERF_DT BETWEEN #{perfDtStart} || '000000' AND #{perfDtFinish} || '235959' /* 수납상세.실적일자 BETWEEN 시작일 AND 종료일 = 실적일자 */
           <if test='@MybatisUtils@isNotEmpty(rfndDsbDvCd)'>
              <choose>
                <when test='@MybatisUtils@equals(rfndDsbDvCd,"04")'>                 
           AND RRRD.RFND_DSB_DV_CD = '04'               /* 환불접수상세.환불지급구분코드 = 04.귀속 */
                </when>
                <otherwise>
           AND RRRD.RFND_DSB_DV_CD != '04'               /* 환불접수상세.환불지급구분코드 != 04.귀속 */
                </otherwise>
              </choose>
            </if>
            <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
              <choose>
                <when test='@MybatisUtils@equals(sellTpCd,"2")'>
           AND SCD.SELL_TP_CD IN ( 2 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"3")'>
           AND SCD.SELL_TP_CD IN ( 3 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"6")'>
           AND SCD.SELL_TP_CD IN ( 6 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <otherwise>
                </otherwise>
              </choose>
            </if>
          /* AND 판매유형상세 는 알수 없다고 작성되어 있음. */
            <choose>
             <when test='@MybatisUtils@equals(rveDvCd,"09")'>
           AND RRD.RVE_DV_CD = '09'                     /* 수납상세.수납구분코드 = 09.대손이관 = 대손구분 */
             </when>
             <otherwise>
           AND RRD.RVE_DV_CD != '09'                    /* 수납상세.수납구분코드 != 09.대손이관 = 일반 */
             </otherwise>
            </choose>
            <if test='@MybatisUtils@isNotEmpty(dpMesCd)'> /* 수납상세.입금구분코드 조건 없음 = 전체 */
              <choose>
                <when test='@MybatisUtils@equals(dpMesCd,"07")'>
           AND RRD.DP_MES_CD = '07'                     /* 수납상세.입금구분코드 = 07.포인트 */
                </when>
                <otherwise>
           AND RRD.DP_MES_CD != '07'                    /* 수납상세.입금구분코드 != 07.포인트 제외 */
                </otherwise>
              </choose>
            </if>
         UNION ALL
        SELECT '22' AS REFUND_DIVISION
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  AS RFND_DSB_AMT /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DDTN_AMT ELSE 0 END), 0) AS RFND_DDTN_AMT /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS BC_RFND_DSB_AMT /* 비씨 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS KB_RFND_DSB_AMT /* 국민 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HN_RFND_DSB_AMT /* 외환 대신 하나 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS SH_RFND_DSB_AMT /* 신한 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS SS_RFND_DSB_AMT /* 삼성 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HD_RFND_DSB_AMT /* 현대 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LT_RFND_DSB_AMT /* 롯데 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS NH_RFND_DSB_AMT /* 농협 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DDTN_AMT ELSE 0 END), 0)  /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 비씨 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 국민 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 외환 대신 하나 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 신한 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 삼성 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 현대 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 롯데 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)   /* 농협 */
                AS SUM_RFND_DSB_DDTN_AMT /* 환불총계 = 현금+카드공제+비씨+국민+외환+신한+삼성+현대+롯데+농협 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 비씨 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 국민 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 외환 대신 하나 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 신한 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 삼성 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 현대 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 롯데 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)   /* 농협 */
                AS SUM_RFND_DSB_PSP_INT /* 지연이자 = 현금+카드공제+비씨+국민+외환+신한+삼성+현대+롯데+농협 */ 
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
          JOIN TB_RVDW_RFND_RCP_DTL RRRD                /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N' 
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
          JOIN TB_SSCT_CNTR_DTL SCD                     /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 = 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약상세번호 = 계약상세번호 */
          JOIN TB_RVDW_RVE_DTL RRD                      /* 수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = RRD.RVE_OJ_DRM_NO1        /* 환불접수기본.계약번호 = 수납상세.수납대상식별번호1 */
           AND RRRB.CNTR_SN = RRD.RVE_OJ_DRM_NO2        /* 환불접수기본.계약일련번호 = 수납상세.수납대상식별번호2 */
         WHERE 1 = 1
           AND RRD.DP_DV_CD = '2' /* 수납상세.입금구분코드 = 2.환불*/
           AND SCD.SELL_TP_DTL_CD = '22' /* 계약상세.판매유형상세코드 = 22.리스 */
           AND RRD.RVE_DT BETWEEN #{rveDtStart} || '000000' AND #{rveDtFinish} || '235959' /* 수납상세.수납일자 BETWEEN 시작일 AND 종료일 = 환불일자 */
           AND RRD.PERF_DT BETWEEN #{perfDtStart} || '000000' AND #{perfDtFinish} || '235959' /* 수납상세.실적일자 BETWEEN 시작일 AND 종료일 = 실적일자 */
           <if test='@MybatisUtils@isNotEmpty(rfndDsbDvCd)'>
              <choose>
                <when test='@MybatisUtils@equals(rfndDsbDvCd,"04")'>                 
           AND RRRD.RFND_DSB_DV_CD = '04'               /* 환불접수상세.환불지급구분코드 = 04.귀속 */
                </when>
                <otherwise>
           AND RRRD.RFND_DSB_DV_CD != '04'               /* 환불접수상세.환불지급구분코드 != 04.귀속 */
                </otherwise>
              </choose>
            </if>
            <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
              <choose>
                <when test='@MybatisUtils@equals(sellTpCd,"2")'>
           AND SCD.SELL_TP_CD IN ( 2 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"3")'>
           AND SCD.SELL_TP_CD IN ( 3 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"6")'>
           AND SCD.SELL_TP_CD IN ( 6 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <otherwise>
                </otherwise>
              </choose>
            </if>
          /* AND 판매유형상세 는 알수 없다고 작성되어 있음. */
            <choose>
             <when test='@MybatisUtils@equals(rveDvCd,"09")'>
           AND RRD.RVE_DV_CD = '09'                     /* 수납상세.수납구분코드 = 09.대손이관 = 대손구분 */
             </when>
             <otherwise>
           AND RRD.RVE_DV_CD != '09'                    /* 수납상세.수납구분코드 != 09.대손이관 = 일반 */
             </otherwise>
            </choose>
            <if test='@MybatisUtils@isNotEmpty(dpMesCd)'> /* 수납상세.입금구분코드 조건 없음 = 전체 */
              <choose>
                <when test='@MybatisUtils@equals(dpMesCd,"07")'>
           AND RRD.DP_MES_CD = '07'                     /* 수납상세.입금구분코드 = 07.포인트 */
                </when>
                <otherwise>
           AND RRD.DP_MES_CD != '07'                    /* 수납상세.입금구분코드 != 07.포인트 제외 */
                </otherwise>
              </choose>
            </if>
         UNION ALL
        SELECT '24' AS REFUND_DIVISION
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  AS RFND_DSB_AMT /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DDTN_AMT ELSE 0 END), 0) AS RFND_DDTN_AMT /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS BC_RFND_DSB_AMT /* 비씨 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS KB_RFND_DSB_AMT /* 국민 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HN_RFND_DSB_AMT /* 외환 대신 하나 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS SH_RFND_DSB_AMT /* 신한 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS SS_RFND_DSB_AMT /* 삼성 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HD_RFND_DSB_AMT /* 현대 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LT_RFND_DSB_AMT /* 롯데 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS NH_RFND_DSB_AMT /* 농협 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DDTN_AMT ELSE 0 END), 0)  /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 비씨 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 국민 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 외환 대신 하나 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 신한 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 삼성 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 현대 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 롯데 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)   /* 농협 */
                AS SUM_RFND_DSB_DDTN_AMT /* 환불총계 = 현금+카드공제+비씨+국민+외환+신한+삼성+현대+롯데+농협 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 비씨 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 국민 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 외환 대신 하나 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 신한 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 삼성 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 현대 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 롯데 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)   /* 농협 */
                AS SUM_RFND_DSB_PSP_INT /* 지연이자 = 현금+카드공제+비씨+국민+외환+신한+삼성+현대+롯데+농협 */ 
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
          JOIN TB_RVDW_RFND_RCP_DTL RRRD                /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N' 
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
          JOIN TB_SSCT_CNTR_DTL SCD                     /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 = 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약상세번호 = 계약상세번호 */
          JOIN TB_RVDW_RVE_DTL RRD                      /* 수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = RRD.RVE_OJ_DRM_NO1        /* 환불접수기본.계약번호 = 수납상세.수납대상식별번호1 */
           AND RRRB.CNTR_SN = RRD.RVE_OJ_DRM_NO2        /* 환불접수기본.계약일련번호 = 수납상세.수납대상식별번호2 */
         WHERE 1 = 1
           AND RRD.DP_DV_CD = '2' /* 수납상세.입금구분코드 = 2.환불*/
           AND SCD.SELL_TP_DTL_CD = '24' /* 계약상세.판매유형상세코드 = 24.환경리스 */
           AND RRD.RVE_DT BETWEEN #{rveDtStart} || '000000' AND #{rveDtFinish} || '235959' /* 수납상세.수납일자 BETWEEN 시작일 AND 종료일 = 환불일자 */
           AND RRD.PERF_DT BETWEEN #{perfDtStart} || '000000' AND #{perfDtFinish} || '235959' /* 수납상세.실적일자 BETWEEN 시작일 AND 종료일 = 실적일자 */
           <if test='@MybatisUtils@isNotEmpty(rfndDsbDvCd)'>
              <choose>
                <when test='@MybatisUtils@equals(rfndDsbDvCd,"04")'>                 
           AND RRRD.RFND_DSB_DV_CD = '04'               /* 환불접수상세.환불지급구분코드 = 04.귀속 */
                </when>
                <otherwise>
           AND RRRD.RFND_DSB_DV_CD != '04'               /* 환불접수상세.환불지급구분코드 != 04.귀속 */
                </otherwise>
              </choose>
            </if>
            <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
              <choose>
                <when test='@MybatisUtils@equals(sellTpCd,"2")'>
           AND SCD.SELL_TP_CD IN ( 2 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"3")'>
           AND SCD.SELL_TP_CD IN ( 3 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"6")'>
           AND SCD.SELL_TP_CD IN ( 6 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <otherwise>
                </otherwise>
              </choose>
            </if>
          /* AND 판매유형상세 는 알수 없다고 작성되어 있음. */
            <choose>
             <when test='@MybatisUtils@equals(rveDvCd,"09")'>
           AND RRD.RVE_DV_CD = '09'                     /* 수납상세.수납구분코드 = 09.대손이관 = 대손구분 */
             </when>
             <otherwise>
           AND RRD.RVE_DV_CD != '09'                    /* 수납상세.수납구분코드 != 09.대손이관 = 일반 */
             </otherwise>
            </choose>
            <if test='@MybatisUtils@isNotEmpty(dpMesCd)'> /* 수납상세.입금구분코드 조건 없음 = 전체 */
              <choose>
                <when test='@MybatisUtils@equals(dpMesCd,"07")'>
           AND RRD.DP_MES_CD = '07'                     /* 수납상세.입금구분코드 = 07.포인트 */
                </when>
                <otherwise>
           AND RRD.DP_MES_CD != '07'                    /* 수납상세.입금구분코드 != 07.포인트 제외 */
                </otherwise>
              </choose>
            </if>
         UNION ALL 
        SELECT '25' AS REFUND_DIVISION
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  AS RFND_DSB_AMT /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DDTN_AMT ELSE 0 END), 0) AS RFND_DDTN_AMT /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS BC_RFND_DSB_AMT /* 비씨 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS KB_RFND_DSB_AMT /* 국민 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HN_RFND_DSB_AMT /* 외환 대신 하나 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS SH_RFND_DSB_AMT /* 신한 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS SS_RFND_DSB_AMT /* 삼성 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HD_RFND_DSB_AMT /* 현대 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LT_RFND_DSB_AMT /* 롯데 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS NH_RFND_DSB_AMT /* 농협 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DDTN_AMT ELSE 0 END), 0)  /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 비씨 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 국민 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 외환 대신 하나 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 신한 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 삼성 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 현대 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 롯데 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)   /* 농협 */
                AS SUM_RFND_DSB_DDTN_AMT /* 환불총계 = 현금+카드공제+비씨+국민+외환+신한+삼성+현대+롯데+농협 */
             , NVL(SUM(CASE WHEN RRD.DP_MES_CD = '01' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 현금 = 수납상세.입금수단코드 = 01.현금 = 현금지급금액  */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 카드공제 = 수납상세.입금수단코드 = 02.카드 의 공제금액 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '361' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 비씨 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '381' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 국민 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD IN ( '374', '044' ) THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 외환 대신 하나 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '366' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 신한 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '365' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 삼성 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '367' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 현대 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '368' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)  /* 롯데 */
               + NVL(SUM(CASE WHEN RRD.DP_MES_CD = '02' AND RRRD.CARD_RFND_FNIT_CD = '371' THEN RRRD.RFND_DSB_PSP_INT ELSE 0 END), 0)   /* 농협 */
                AS SUM_RFND_DSB_PSP_INT /* 지연이자 = 현금+카드공제+비씨+국민+외환+신한+삼성+현대+롯데+농협 */ 
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
          JOIN TB_RVDW_RFND_RCP_DTL RRRD                /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N' 
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
          JOIN TB_SSCT_CNTR_DTL SCD                     /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 = 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약상세번호 = 계약상세번호 */
          JOIN TB_RVDW_RVE_DTL RRD                      /* 수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = RRD.RVE_OJ_DRM_NO1        /* 환불접수기본.계약번호 = 수납상세.수납대상식별번호1 */
           AND RRRB.CNTR_SN = RRD.RVE_OJ_DRM_NO2        /* 환불접수기본.계약일련번호 = 수납상세.수납대상식별번호2 */
         WHERE 1 = 1
           AND RRD.DP_DV_CD = '2' /* 수납상세.입금구분코드 = 2.환불*/
           AND SCD.SELL_TP_DTL_CD = '25' /* 계약상세.판매유형상세코드 = 25.장기할부 */
           AND RRD.RVE_DT BETWEEN #{rveDtStart} || '000000' AND #{rveDtFinish} || '235959' /* 수납상세.수납일자 BETWEEN 시작일 AND 종료일 = 환불일자 */
           AND RRD.PERF_DT BETWEEN #{perfDtStart} || '000000' AND #{perfDtFinish} || '235959' /* 수납상세.실적일자 BETWEEN 시작일 AND 종료일 = 실적일자 */
           <if test='@MybatisUtils@isNotEmpty(rfndDsbDvCd)'>
              <choose>
                <when test='@MybatisUtils@equals(rfndDsbDvCd,"04")'>                 
           AND RRRD.RFND_DSB_DV_CD = '04'               /* 환불접수상세.환불지급구분코드 = 04.귀속 */
                </when>
                <otherwise>
           AND RRRD.RFND_DSB_DV_CD != '04'               /* 환불접수상세.환불지급구분코드 != 04.귀속 */
                </otherwise>
              </choose>
            </if>
            <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
              <choose>
                <when test='@MybatisUtils@equals(sellTpCd,"2")'>
           AND SCD.SELL_TP_CD IN ( 2 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"3")'>
           AND SCD.SELL_TP_CD IN ( 3 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"6")'>
           AND SCD.SELL_TP_CD IN ( 6 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <otherwise>
                </otherwise>
              </choose>
            </if>
          /* AND 판매유형상세 는 알수 없다고 작성되어 있음. */
            <choose>
             <when test='@MybatisUtils@equals(rveDvCd,"09")'>
           AND RRD.RVE_DV_CD = '09'                     /* 수납상세.수납구분코드 = 09.대손이관 = 대손구분 */
             </when>
             <otherwise>
           AND RRD.RVE_DV_CD != '09'                    /* 수납상세.수납구분코드 != 09.대손이관 = 일반 */
             </otherwise>
            </choose>
            <if test='@MybatisUtils@isNotEmpty(dpMesCd)'> /* 수납상세.입금구분코드 조건 없음 = 전체 */
              <choose>
                <when test='@MybatisUtils@equals(dpMesCd,"07")'>
           AND RRD.DP_MES_CD = '07'                     /* 수납상세.입금구분코드 = 07.포인트 */
                </when>
                <otherwise>
           AND RRD.DP_MES_CD != '07'                    /* 수납상세.입금구분코드 != 07.포인트 제외 */
                </otherwise>
              </choose>
            </if>
    </select>
    
    <select id="selectBalanceTransferRefundHistory" resultType="com.kyowon.sms.wells.web.withdrawal.idvrve.dto.WwdbRefundCurrentStatusDto$SearchBalanceTransferRefundHistoryRes">
        SELECT '21' AS REFUND_DIVISION
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '3' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS RT_RFND_DSB_AMT /* 렌탈 = 계약상세.계약서유형코드 = 3  */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '9' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LS_RFND_DSB_AMT /* 리스 = 계약상세.계약서유형코드 = 9 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS EL_RFND_DSB_AMT /* 환경리스 = 계약상세.계약서유형코드 = - */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '4' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS MB_RFND_DSB_AMT /* 멤버십 = 계약상세.계약서유형코드 = 4 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '5' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HC_RFND_DSB_AMT /* 홈케어멤버십 = 계약상세.계약서유형코드 = 5 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '8' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LN_RFND_DSB_AMT /* 장기할부 = 계약상세.계약서유형코드 = 8 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LM_RFND_DSB_AMT /* 할부금 = 계약상세.계약서유형코드 = - */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS KM_RFND_DSB_AMT /* K머니 = 계약상세.계약서유형코드 = - */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '7' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS RG_RFND_DSB_AMT /* 정기배송 = 계약상세.계약서유형코드 = 7 */
             , ( NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '3' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 렌탈 = 계약상세.계약서유형코드 = 3 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '9' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 리스 = 계약상세.계약서유형코드 = 9 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 환경리스 = 계약상세.계약서유형코드 = - */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '4' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 멤버십 = 계약상세.계약서유형코드 = 4 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '5' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 홈케어멤버십 = 계약상세.계약서유형코드 = 5 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '8' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 장기할부 = 계약상세.계약서유형코드 = 8 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 할부금 = 계약상세.계약서유형코드 = - */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* K머니 = 계약상세.계약서유형코드 = -*/
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '7' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 정기배송 = 계약상세.계약서유형코드 = 7 */
             ) AS SUM_RFND_DSB_AMT/* 전금합계 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
          JOIN TB_RVDW_RFND_RCP_DTL RRRD                /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N' 
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
          JOIN TB_SSCT_CNTR_DTL SCD                     /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 = 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약상세번호 = 계약상세번호 */
          JOIN TB_RVDW_RVE_DTL RRD                      /* 수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = RRD.RVE_OJ_DRM_NO1        /* 환불접수기본.계약번호 = 수납상세.수납대상식별번호1 */
           AND RRRB.CNTR_SN = RRD.RVE_OJ_DRM_NO2        /* 환불접수기본.계약일련번호 = 수납상세.수납대상식별번호2 */
         WHERE 1 = 1
           AND RRD.DP_DV_CD = '2' /* 수납상세.입금구분코드 = 2.환불*/
           AND RRD.DP_MES_CD = '05' /* 수납상세.입금수단코드 = 05.전금 */
           AND SCD.SELL_TP_DTL_CD = '21' /* 계약상세.판매유형상세코드 = 일반렌탈 21.일반렌탈, 22.리스, 24.환경리스, 25.장기할부  */
           AND RRD.RVE_DT BETWEEN #{rveDtStart} || '000000' AND #{rveDtFinish} || '235959' /* 수납상세.수납일자 BETWEEN 시작일 AND 종료일 = 환불일자 */
           AND RRD.PERF_DT BETWEEN #{perfDtStart} || '000000' AND #{perfDtFinish} || '235959' /* 수납상세.실적일자 BETWEEN 시작일 AND 종료일 = 실적일자 */
           <if test='@MybatisUtils@isNotEmpty(rfndDsbDvCd)'>
              <choose>
                <when test='@MybatisUtils@equals(rfndDsbDvCd,"04")'>                 
           AND RRRD.RFND_DSB_DV_CD = '04'               /* 환불접수상세.환불지급구분코드 = 04.귀속 */
                </when>
                <otherwise>
           AND RRRD.RFND_DSB_DV_CD != '04'               /* 환불접수상세.환불지급구분코드 != 04.귀속 */
                </otherwise>
              </choose>
            </if>
            <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
              <choose>
                <when test='@MybatisUtils@equals(sellTpCd,"2")'>
           AND SCD.SELL_TP_CD IN ( 2 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"3")'>
           AND SCD.SELL_TP_CD IN ( 3 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"6")'>
           AND SCD.SELL_TP_CD IN ( 6 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <otherwise>
                </otherwise>
              </choose>
            </if>
          /* AND 판매유형상세 는 알수 없다고 작성되어 있음. */
            <choose>
             <when test='@MybatisUtils@equals(rveDvCd,"09")'>
           AND RRD.RVE_DV_CD = '09'                     /* 수납상세.수납구분코드 = 09.대손이관 = 대손구분 */
             </when>
             <otherwise>
           AND RRD.RVE_DV_CD != '09'                    /* 수납상세.수납구분코드 != 09.대손이관 = 일반 */
             </otherwise>
            </choose>
            <if test='@MybatisUtils@isNotEmpty(dpMesCd)'> /* 수납상세.입금구분코드 조건 없음 = 전체 */
              <choose>
                <when test='@MybatisUtils@equals(dpMesCd,"07")'>
           AND RRD.DP_MES_CD = '07'                     /* 수납상세.입금구분코드 = 07.포인트 */
                </when>
                <otherwise>
           AND RRD.DP_MES_CD != '07'                    /* 수납상세.입금구분코드 != 07.포인트 제외 */
                </otherwise>
              </choose>
            </if>
         UNION ALL 
        SELECT '22' AS REFUND_DIVISION
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '3' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS RT_RFND_DSB_AMT /* 렌탈 = 계약상세.계약서유형코드 = 3  */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '9' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LS_RFND_DSB_AMT /* 리스 = 계약상세.계약서유형코드 = 9 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS EL_RFND_DSB_AMT /* 환경리스 = 계약상세.계약서유형코드 = - */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '4' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS MB_RFND_DSB_AMT /* 멤버십 = 계약상세.계약서유형코드 = 4 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '5' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HC_RFND_DSB_AMT /* 홈케어멤버십 = 계약상세.계약서유형코드 = 5 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '8' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LN_RFND_DSB_AMT /* 장기할부 = 계약상세.계약서유형코드 = 8 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LM_RFND_DSB_AMT /* 할부금 = 계약상세.계약서유형코드 = - */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS KM_RFND_DSB_AMT /* K머니 = 계약상세.계약서유형코드 = - */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '7' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS RG_RFND_DSB_AMT /* 정기배송 = 계약상세.계약서유형코드 = 7 */
             , ( NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '3' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 렌탈 = 계약상세.계약서유형코드 = 3 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '9' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 리스 = 계약상세.계약서유형코드 = 9 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 환경리스 = 계약상세.계약서유형코드 = - */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '4' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 멤버십 = 계약상세.계약서유형코드 = 4 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '5' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 홈케어멤버십 = 계약상세.계약서유형코드 = 5 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '8' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 장기할부 = 계약상세.계약서유형코드 = 8 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 할부금 = 계약상세.계약서유형코드 = - */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* K머니 = 계약상세.계약서유형코드 = -*/
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '7' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 정기배송 = 계약상세.계약서유형코드 = 7 */
             ) AS SUM_RFND_DSB_AMT/* 전금합계 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
          JOIN TB_RVDW_RFND_RCP_DTL RRRD                /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N' 
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
          JOIN TB_SSCT_CNTR_DTL SCD                     /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 = 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약상세번호 = 계약상세번호 */
          JOIN TB_RVDW_RVE_DTL RRD                      /* 수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = RRD.RVE_OJ_DRM_NO1        /* 환불접수기본.계약번호 = 수납상세.수납대상식별번호1 */
           AND RRRB.CNTR_SN = RRD.RVE_OJ_DRM_NO2        /* 환불접수기본.계약일련번호 = 수납상세.수납대상식별번호2 */
         WHERE 1 = 1
           AND RRD.DP_DV_CD = '2' /* 수납상세.입금구분코드 = 2.환불*/
           AND RRD.DP_MES_CD = '05' /* 수납상세.입금수단코드 = 05.전금 */
           AND SCD.SELL_TP_DTL_CD = '22' /* 계약상세.판매유형상세코드 = 리스 21.일반렌탈, 22.리스, 24.환경리스, 25.장기할부  */
           AND RRD.RVE_DT BETWEEN #{rveDtStart} || '000000' AND #{rveDtFinish} || '235959' /* 수납상세.수납일자 BETWEEN 시작일 AND 종료일 = 환불일자 */
           AND RRD.PERF_DT BETWEEN #{perfDtStart} || '000000' AND #{perfDtFinish} || '235959' /* 수납상세.실적일자 BETWEEN 시작일 AND 종료일 = 실적일자 */
           <if test='@MybatisUtils@isNotEmpty(rfndDsbDvCd)'>
              <choose>
                <when test='@MybatisUtils@equals(rfndDsbDvCd,"04")'>                 
           AND RRRD.RFND_DSB_DV_CD = '04'               /* 환불접수상세.환불지급구분코드 = 04.귀속 */
                </when>
                <otherwise>
           AND RRRD.RFND_DSB_DV_CD != '04'               /* 환불접수상세.환불지급구분코드 != 04.귀속 */
                </otherwise>
              </choose>
            </if>
            <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
              <choose>
                <when test='@MybatisUtils@equals(sellTpCd,"2")'>
           AND SCD.SELL_TP_CD IN ( 2 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"3")'>
           AND SCD.SELL_TP_CD IN ( 3 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"6")'>
           AND SCD.SELL_TP_CD IN ( 6 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <otherwise>
                </otherwise>
              </choose>
            </if>
          /* AND 판매유형상세 는 알수 없다고 작성되어 있음. */
            <choose>
             <when test='@MybatisUtils@equals(rveDvCd,"09")'>
           AND RRD.RVE_DV_CD = '09'                     /* 수납상세.수납구분코드 = 09.대손이관 = 대손구분 */
             </when>
             <otherwise>
           AND RRD.RVE_DV_CD != '09'                    /* 수납상세.수납구분코드 != 09.대손이관 = 일반 */
             </otherwise>
            </choose>
            <if test='@MybatisUtils@isNotEmpty(dpMesCd)'> /* 수납상세.입금구분코드 조건 없음 = 전체 */
              <choose>
                <when test='@MybatisUtils@equals(dpMesCd,"07")'>
           AND RRD.DP_MES_CD = '07'                     /* 수납상세.입금구분코드 = 07.포인트 */
                </when>
                <otherwise>
           AND RRD.DP_MES_CD != '07'                    /* 수납상세.입금구분코드 != 07.포인트 제외 */
                </otherwise>
              </choose>
            </if>
         UNION ALL
        SELECT '24' AS REFUND_DIVISION
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '3' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS RT_RFND_DSB_AMT /* 렌탈 = 계약상세.계약서유형코드 = 3  */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '9' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LS_RFND_DSB_AMT /* 리스 = 계약상세.계약서유형코드 = 9 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS EL_RFND_DSB_AMT /* 환경리스 = 계약상세.계약서유형코드 = - */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '4' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS MB_RFND_DSB_AMT /* 멤버십 = 계약상세.계약서유형코드 = 4 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '5' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HC_RFND_DSB_AMT /* 홈케어멤버십 = 계약상세.계약서유형코드 = 5 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '8' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LN_RFND_DSB_AMT /* 장기할부 = 계약상세.계약서유형코드 = 8 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LM_RFND_DSB_AMT /* 할부금 = 계약상세.계약서유형코드 = - */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS KM_RFND_DSB_AMT /* K머니 = 계약상세.계약서유형코드 = - */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '7' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS RG_RFND_DSB_AMT /* 정기배송 = 계약상세.계약서유형코드 = 7 */
             , ( NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '3' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 렌탈 = 계약상세.계약서유형코드 = 3 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '9' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 리스 = 계약상세.계약서유형코드 = 9 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 환경리스 = 계약상세.계약서유형코드 = - */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '4' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 멤버십 = 계약상세.계약서유형코드 = 4 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '5' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 홈케어멤버십 = 계약상세.계약서유형코드 = 5 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '8' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 장기할부 = 계약상세.계약서유형코드 = 8 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 할부금 = 계약상세.계약서유형코드 = - */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* K머니 = 계약상세.계약서유형코드 = -*/
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '7' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 정기배송 = 계약상세.계약서유형코드 = 7 */
             ) AS SUM_RFND_DSB_AMT/* 전금합계 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
          JOIN TB_RVDW_RFND_RCP_DTL RRRD                /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N' 
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
          JOIN TB_SSCT_CNTR_DTL SCD                     /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 = 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약상세번호 = 계약상세번호 */
          JOIN TB_RVDW_RVE_DTL RRD                      /* 수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = RRD.RVE_OJ_DRM_NO1        /* 환불접수기본.계약번호 = 수납상세.수납대상식별번호1 */
           AND RRRB.CNTR_SN = RRD.RVE_OJ_DRM_NO2        /* 환불접수기본.계약일련번호 = 수납상세.수납대상식별번호2 */
         WHERE 1 = 1
           AND RRD.DP_DV_CD = '2' /* 수납상세.입금구분코드 = 2.환불*/
           AND RRD.DP_MES_CD = '05' /* 수납상세.입금수단코드 = 05.전금 */
           AND SCD.SELL_TP_DTL_CD = '24' /* 계약상세.판매유형상세코드 = 환경리스 21.일반렌탈, 22.리스, 24.환경리스, 25.장기할부  */
           AND RRD.RVE_DT BETWEEN #{rveDtStart} || '000000' AND #{rveDtFinish} || '235959' /* 수납상세.수납일자 BETWEEN 시작일 AND 종료일 = 환불일자 */
           AND RRD.PERF_DT BETWEEN #{perfDtStart} || '000000' AND #{perfDtFinish} || '235959' /* 수납상세.실적일자 BETWEEN 시작일 AND 종료일 = 실적일자 */
           <if test='@MybatisUtils@isNotEmpty(rfndDsbDvCd)'>
              <choose>
                <when test='@MybatisUtils@equals(rfndDsbDvCd,"04")'>                 
           AND RRRD.RFND_DSB_DV_CD = '04'               /* 환불접수상세.환불지급구분코드 = 04.귀속 */
                </when>
                <otherwise>
           AND RRRD.RFND_DSB_DV_CD != '04'               /* 환불접수상세.환불지급구분코드 != 04.귀속 */
                </otherwise>
              </choose>
            </if>
            <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
              <choose>
                <when test='@MybatisUtils@equals(sellTpCd,"2")'>
           AND SCD.SELL_TP_CD IN ( 2 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"3")'>
           AND SCD.SELL_TP_CD IN ( 3 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"6")'>
           AND SCD.SELL_TP_CD IN ( 6 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <otherwise>
                </otherwise>
              </choose>
            </if>
          /* AND 판매유형상세 는 알수 없다고 작성되어 있음. */
            <choose>
             <when test='@MybatisUtils@equals(rveDvCd,"09")'>
           AND RRD.RVE_DV_CD = '09'                     /* 수납상세.수납구분코드 = 09.대손이관 = 대손구분 */
             </when>
             <otherwise>
           AND RRD.RVE_DV_CD != '09'                    /* 수납상세.수납구분코드 != 09.대손이관 = 일반 */
             </otherwise>
            </choose>
            <if test='@MybatisUtils@isNotEmpty(dpMesCd)'> /* 수납상세.입금구분코드 조건 없음 = 전체 */
              <choose>
                <when test='@MybatisUtils@equals(dpMesCd,"07")'>
           AND RRD.DP_MES_CD = '07'                     /* 수납상세.입금구분코드 = 07.포인트 */
                </when>
                <otherwise>
           AND RRD.DP_MES_CD != '07'                    /* 수납상세.입금구분코드 != 07.포인트 제외 */
                </otherwise>
              </choose>
            </if>
         UNION ALL
        SELECT '25' AS REFUND_DIVISION
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '3' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS RT_RFND_DSB_AMT /* 렌탈 = 계약상세.계약서유형코드  */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '9' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LS_RFND_DSB_AMT /* 리스 = 계약상세.계약서유형코드  */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS EL_RFND_DSB_AMT /* 환경리스 = 계약상세.계약서유형코드  */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '4' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS MB_RFND_DSB_AMT /* 멤버십 = 계약상세.계약서유형코드  */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '5' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS HC_RFND_DSB_AMT /* 홈케어멤버십 = 계약상세.계약서유형코드  */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '8' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LN_RFND_DSB_AMT /* 장기할부 = 계약상세.계약서유형코드  */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS LM_RFND_DSB_AMT /* 할부금 = 계약상세.계약서유형코드  */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS KM_RFND_DSB_AMT /* K머니 = 계약상세.계약서유형코드 */
             , NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '7' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0) AS RG_RFND_DSB_AMT /* 정기배송 = 계약상세.계약서유형코드  */
             , ( NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '3' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 렌탈 = 계약상세.계약서유형코드  */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '9' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 리스 = 계약상세.계약서유형코드  */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 환경리스 = 계약상세.계약서유형코드  */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '4' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 멤버십 = 계약상세.계약서유형코드  */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '5' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 홈케어멤버십 = 계약상세.계약서유형코드  */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '8' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 장기할부 = 계약상세.계약서유형코드  */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 할부금 = 계약상세.계약서유형코드  */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '-' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* K머니 = 계약상세.계약서유형코드 */
               + NVL(SUM(CASE WHEN SCD.CNTRW_TP_CD = '7' THEN RRRD.RFND_DSB_AMT ELSE 0 END), 0)  /* 정기배송 = 계약상세.계약서유형코드  */
             ) AS SUM_RFND_DSB_AMT/* 전금합계 */
          FROM TB_RVDW_RFND_RCP_BAS RRRB                /* 환불접수기본 */
          JOIN TB_RVDW_RFND_RCP_DTL RRRD                /* 환불접수상세 */
            ON RRRB.DTA_DL_YN = 'N'
           AND RRRD.DTA_DL_YN = 'N' 
           AND RRRB.KW_GRP_CO_CD = RRRD.KW_GRP_CO_CD    /* 교원그룹회사코드 */
           AND RRRB.RFND_RCP_NO = RRRD.RFND_RCP_NO      /* 환불접수번호 */
          JOIN TB_SSCT_CNTR_DTL SCD                     /* 계약상세 */
            ON SCD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = SCD.CNTR_NO               /* 계약번호 = 계약번호 */
           AND RRRB.CNTR_SN = SCD.CNTR_SN               /* 계약상세번호 = 계약상세번호 */
          JOIN TB_RVDW_RVE_DTL RRD                      /* 수납상세 */
            ON RRD.DTA_DL_YN = 'N'
           AND RRRB.CNTR_NO = RRD.RVE_OJ_DRM_NO1        /* 환불접수기본.계약번호 = 수납상세.수납대상식별번호1 */
           AND RRRB.CNTR_SN = RRD.RVE_OJ_DRM_NO2        /* 환불접수기본.계약일련번호 = 수납상세.수납대상식별번호2 */
         WHERE 1 = 1
           AND RRD.DP_DV_CD = '2' /* 수납상세.입금구분코드 = 2.환불*/
           AND RRD.DP_MES_CD = '05' /* 수납상세.입금수단코드 = 05.전금 */
           AND SCD.SELL_TP_DTL_CD = '25' /* 계약상세.판매유형상세코드 = 장기할부 21.일반렌탈, 22.리스, 24.환경리스, 25.장기할부  */
           AND RRD.RVE_DT BETWEEN #{rveDtStart} || '000000' AND #{rveDtFinish} || '235959' /* 수납상세.수납일자 BETWEEN 시작일 AND 종료일 = 환불일자 */
           AND RRD.PERF_DT BETWEEN #{perfDtStart} || '000000' AND #{perfDtFinish} || '235959' /* 수납상세.실적일자 BETWEEN 시작일 AND 종료일 = 실적일자 */
           <if test='@MybatisUtils@isNotEmpty(rfndDsbDvCd)'>
              <choose>
                <when test='@MybatisUtils@equals(rfndDsbDvCd,"04")'>                 
           AND RRRD.RFND_DSB_DV_CD = '04'               /* 환불접수상세.환불지급구분코드 = 04.귀속 */
                </when>
                <otherwise>
           AND RRRD.RFND_DSB_DV_CD != '04'               /* 환불접수상세.환불지급구분코드 != 04.귀속 */
                </otherwise>
              </choose>
            </if>
            <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
              <choose>
                <when test='@MybatisUtils@equals(sellTpCd,"2")'>
           AND SCD.SELL_TP_CD IN ( 2 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"3")'>
           AND SCD.SELL_TP_CD IN ( 3 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <when test='@MybatisUtils@equals(sellTpCd,"6")'>
           AND SCD.SELL_TP_CD IN ( 6 )             /* 계약상세.판매유형코드 = 2.렌탈/리스, 3.멤버십, 6.정기배송 */
                </when>
                <otherwise>
                </otherwise>
              </choose>
            </if>
          /* AND 판매유형상세 는 알수 없다고 작성되어 있음. */
            <choose>
             <when test='@MybatisUtils@equals(rveDvCd,"09")'>
           AND RRD.RVE_DV_CD = '09'                     /* 수납상세.수납구분코드 = 09.대손이관 = 대손구분 */
             </when>
             <otherwise>
           AND RRD.RVE_DV_CD != '09'                    /* 수납상세.수납구분코드 != 09.대손이관 = 일반 */
             </otherwise>
            </choose>
            <if test='@MybatisUtils@isNotEmpty(dpMesCd)'> /* 수납상세.입금구분코드 조건 없음 = 전체 */
              <choose>
                <when test='@MybatisUtils@equals(dpMesCd,"07")'>
           AND RRD.DP_MES_CD = '07'                     /* 수납상세.입금구분코드 = 07.포인트 */
                </when>
                <otherwise>
           AND RRD.DP_MES_CD != '07'                    /* 수납상세.입금구분코드 != 07.포인트 제외 */
                </otherwise>
              </choose>
            </if>
    </select>
</mapper>