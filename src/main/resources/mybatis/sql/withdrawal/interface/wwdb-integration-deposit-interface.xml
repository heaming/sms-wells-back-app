<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.interfaces.mapper.WwdbIntegrationDepositInterfaceMapper">

    <select id="selectIntegrationDepositCompanyCode" resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dto.WwdbIntegrationDepositInterfaceDto$SearchCompanyCodeRes">
        SELECT A1.CD_VLD_VAL AS KW_GRP_CO_CD
             , B1.MLNG_CNTN AS KW_GRP_CO_CD_NM
          FROM T_CMZ_CD_D A1
         INNER JOIN T_CMZ_MLNG_D B1
            ON B1.MLNG_ID = A1.CD_DTL_MLNG_ID
           AND B1.TENANT_ID = A1.TENANT_ID
           AND B1.LNG_ID = 'ko'
           AND B1.DEL_YN = 'N'
         WHERE A1.DEL_YN = 'N'
           AND A1.CD_ID = 'KW_GRP_CO_CD'
           AND A1.TENANT_ID = #{tenantId}
    </select>

    <select id="selectIntegrationDepositDepoCode" resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dto.WwdbIntegrationDepositInterfaceDto$SearchDepoCodeRes">
        SELECT A1.CD_VLD_VAL AS DP_TP_CD
             , B1.MLNG_CNTN AS DP_TP_CD_NM
          FROM T_CMZ_CD_D A1
         INNER JOIN T_CMZ_MLNG_D B1
            ON B1.MLNG_ID = A1.CD_DTL_MLNG_ID
           AND B1.LNG_ID = 'ko'
           AND B1.DEL_YN = 'N'
           AND B1.TENANT_ID = A1.TENANT_ID
         WHERE A1.DEL_YN = 'N'
           AND A1.CD_ID = 'DP_TP_CD'
           AND A1.TENANT_ID = #{tenantId}
    </select>

    <select id="selectIntegrationDepositDetailTrades" resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dto.WwdbIntegrationDepositInterfaceDto$SearchDetailTradeRes">
        SELECT SUBSTR(A.DP_DTM, 1, 8) AS DP_DT
             , SUBSTR(A.DP_DTM, 9, 6) AS DP_HMS
             , A.DP_DV_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'DP_DV_CD', A.DP_DV_CD) AS DP_DV_NM
             , A.CRDCD_ISTM_MCN as ISTM_MCN
             , B.CNTR_NO
             , B.CNTR_NO || B.CNTR_SN AS CNTR_DTL_NO
             , D.CST_KNM AS CST_NM
             , A.DP_AMT
             , A.DP_CPRCNF_AMT
             , A.CAN_AMT
             , A.RFND_AMT
          FROM TB_RVDW_ITG_DP_BAS A
          LEFT OUTER JOIN TB_RVDW_DP_CPRCNF_BAS B
            ON B.ITG_DP_NO = A.ITG_DP_NO
          LEFT OUTER JOIN TB_SSCT_CNTR_CST_REL C
            ON C.DTL_CNTR_NO = B.CNTR_NO
           AND C.DTL_CNTR_SN = B.CNTR_SN
          LEFT OUTER JOIN TB_CUBS_CST_BAS D
            ON D.CST_NO = C.CST_NO
         WHERE A.ITG_DP_NO = #{itgDpNo}
    </select>

    <select id="selectIntegrationDepositItemizations" resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dto.WwdbIntegrationDepositInterfaceDto$SearchItemizationRes">
        SELECT M.*
          FROM (
                SELECT SUBSTR(A.DP_DTM, 1, 8) AS DP_DT
                     , SUBSTR(A.DP_DTM, 9, 6) AS DP_HMS
                     , A.DP_TP_CD
                     , CASE WHEN #{cnoTp} = '1' THEN A.ACNO_ENCR
                            WHEN #{cnoTp} = '2' THEN A.CRCDNO_ENCR
                            ELSE ''
                        END AS CNO
                     , A.FNIT_CD
                     , B.FNIT_NM
                     , A.CRDCD_APRNO AS CARD_APRNO
                     , A.CRDCD_ISTM_MCN AS ISTM_MCN
                     , A.DPR_NM
                     , A.DP_AMT
                     , A.DP_CPRCNF_AMT
                     , A.CAN_AMT
                     , A.RFND_AMT
                     , A.DP_BLAM
                     , A.DP_AMT - DP_CPRCNF_AMT AS OVR_AMT
                     , A.ITG_DP_NO
                     , A.RVE_CD
                     , D.RVE_NM
                     , A.PRTNR_NO
                     , C.PRTNR_KNM AS PRTNR_NM
                     , A.KW_GRP_CO_CD
                     , F_CMZ_CD_NM('TNT_WELLS', 'KW_GRP_CO_CD', A.KW_GRP_CO_CD) AS KW_GRP_CO_NM
                  FROM TB_RVDW_ITG_DP_BAS A
                  LEFT OUTER JOIN TB_RVDW_FNIT_CD B
                    ON B.FNIT_CD = A.FNIT_CD
                   AND A.DTA_DL_YN = 'N'
                  LEFT OUTER JOIN TB_OGBS_PRTNR_BAS C
                    ON C.OG_TP_CD = A.OG_TP_CD
                   AND C.PRTNR_NO = A.PRTNR_NO
                  LEFT OUTER JOIN TB_RVDW_RVE_CD D
                    ON D.KW_GRP_CO_CD = A.KW_GRP_CO_CD
                   AND D.RVE_CD = A.RVE_CD
          ) M
         WHERE 1 = 1
           <if test='@MybatisUtils@isNotEmpty(CNO)'>
           AND M.CNO = #{cno}
           </if>
           <if test='@MybatisUtils@isNotEmpty(RVE_CD)'>
           AND M.RVE_CD = #{rveCd}
           </if>
           <if test='@MybatisUtils@isNotEmpty(KW_GRP_CO_CD)'>
           AND M.KW_GRP_CO_CD = #{kwGrpCoCd}
           </if>
           <if test='@MybatisUtils@isNotEmpty(DP_BLAM_YN) and @MybatisUtils@equals(DP_BLAM_YN, "Y")'>
           AND M.DP_BLAM > 0
           </if>
           <if test='@MybatisUtils@isNotEmpty(DP_DT_ST) and @MybatisUtils@isNotEmpty(DP_DT_ED)'>
           AND (M.DP_DT BETWEEN #{dpDtSt} AND #{dpDtEd})
           </if>
           <if test='@MybatisUtils@isNotEmpty(DP_TP_CD)'>
           AND M.DP_TP_CD = #{dpTpCd}
           </if>
    </select>
</mapper>
