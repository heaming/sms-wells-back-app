<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.interfaces.mapper.WwdaAutoTransferInterfaceMapper">

    <select id="selectPaymentAndWithdrawalItemizations"
            resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dto.WwdaAutoTransferInterfaceDto$SearchPaymentAndWithdrawalRes">
          SELECT D1.SELL_TP_CD /*출력값-판매유형코드*/
               , B1.CNTR_NO /*출력값-계약번호*/
               , B1.CNTR_SN /*출력값-계약일련번호*/
               , F1.CST_KNM CNTRT_NM /*출력값-계약자명*/
               , A1.RGL_FNT_D FNT_STPL_D /*츌력값-이체약정일*/
               , B1.FNL_BIL_AMT /*출력값-최종청구금액*/
               , B1.DP_AMT /*출력값-입금금액*/
               , B1.DP_DT /*출력값-입금일자*/
               , H1.OWR_KNM /*출력값-소유자한글명*/
            <choose>
                <when test='@MybatisUtils@isEmpty(fntDvCd)'>
               , (SELECT A2.FNIT_NM
                    FROM TB_RVDW_FNIT_CD A2
                   WHERE A2.FNIT_DV_CD = CASE WHEN C1.DV_CD = 'AC' THEN '1'
                                              WHEN C1.DV_CD = 'CA' THEN '2'
                                          END
                     AND A2.FNIT_CD = LPAD(C1.FNIT_CD,3,0)
                 ) FNIT_NM /*출력값-금융기관명*/
               , C1.FNT_RS_CD AFTN_RS_CD /*출력값-자동이체결과코드*/
               , C1.ACNO_CDNO ACNO_CDNO /*출력값-계좌카드번호*/
               , (
                  SELECT B2.AFTN_RS_NM
                    FROM TB_RVDW_AFTN_RS_CD B2 /*자동이체결과코드*/
                   WHERE B2.AFTN_RS_DV_CD = CASE WHEN C1.DV_CD = 'AC' THEN '1'
                                                 WHEN C1.DV_CD = 'CA' THEN '9'
                                             END
                     AND B2.AFTN_RS_CD = C1.FNT_RS_CD
                 ) AFTN_RS_NM /*출력값-자동이체결과명*/
                </when>
                <otherwise>
               , (SELECT A2.FNIT_NM
                    FROM TB_RVDW_FNIT_CD A2
                   WHERE A2.FNIT_DV_CD = CASE WHEN #{fntDvCd} = '01' THEN '1'
                                              WHEN #{fntDvCd} = '02' THEN '2'
                                          END
                    <if test='@MybatisUtils@equals(fntDvCd, "01")'>
                     AND A2.FNIT_CD = LPAD(C1.BNK_CD, 3, 0)
                    </if>
                    <if test='@MybatisUtils@equals(fntDvCd, "02")'>
                     AND A2.FNIT_CD = LPAD(C1.CDCO_CD, 3, 0)
                    </if>
                 ) FNIT_NM /*출력값-금융기관명*/
               <if test='@MybatisUtils@equals(fntDvCd, "01")'>
               , C1.AC_FNT_RS_CD AFTN_RS_CD /*출력값-자동이체결과코드*/
               , C1.ACNO_ENCR ACNO_CDNO /*출력값-계좌카드번호*/
               </if>
               <if test='@MybatisUtils@equals(fntDvCd, "02")'>
               , C1.CARD_FNT_RS_CD AFTN_RS_CD /*출력값-자동이체결과코드*/
               , C1.CRCDNO_ENCR ACNO_CDNO /*출력값-계좌카드번호*/
               </if>
               , (
                  SELECT B2.AFTN_RS_NM
                    FROM TB_RVDW_AFTN_RS_CD B2 /*자동이체결과코드*/
                   WHERE B2.AFTN_RS_DV_CD = CASE WHEN #{fntDvCd} = '01' THEN '1'
                                                 WHEN #{fntDvCd} = '02' THEN '9'
                                             END
                    <if test='@MybatisUtils@equals(fntDvCd, "01")'>
                     AND B2.AFTN_RS_CD = C1.AC_FNT_RS_CD
                    </if>
                    <if test='@MybatisUtils@equals(fntDvCd, "02")'>
                     AND B2.AFTN_RS_CD = C1.CARD_FNT_RS_CD
                    </if>
                 ) AFTN_RS_NM /*출력값-자동이체결과명*/
                </otherwise>
            </choose>
			   , TO_CHAR(TO_DATE(A1.FNL_MDFC_DTM,'YYYYMMDDHH24MISS'), 'YYYYMMDD') AS CH_DT /*변경일자*/
			   , TO_CHAR(TO_DATE(A1.FNL_MDFC_DTM,'YYYYMMDDHH24MISS'), 'HH24MISS') AS CH_HH /*변경시간*/
			   , F_CMZ_USR_NM(A1.FST_RGST_USR_ID) AS FST_RGST_USR_NM /*등록자명*/
			   , (SELECT X.EPNO
                      FROM T_CMP_USR_ACO_M X
                     WHERE X.USR_ID = A1.FST_RGST_USR_ID
                       AND X.DEL_YN = 'N'
                    ) AS FST_RGST_USR_EPNO  /*등록자사번*/
			   , F_CMZ_USR_NM(A1.FNL_MDFC_USR_ID) AS FNL_MDFC_USR_NM /*수정자명*/
			   , (SELECT X.EPNO
                      FROM T_CMP_USR_ACO_M X
                     WHERE X.USR_ID = A1.FNL_MDFC_USR_ID
                       AND X.DEL_YN = 'N'
                    ) AS FNL_MDFC_USR_EPNO  /*수정사사번*/
            FROM TB_RVCL_BIL_FNT_AK_BAS A1 /*청구이체요청기본*/
            JOIN TB_RVCL_BIL_FNT_AK_DTL B1 /*청구이체요청상세*/
              ON B1.DTA_DL_YN = 'N'
             AND B1.BIL_NO = A1.BIL_NO
        <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
             AND B1.CNTR_NO = #{cntrNo} /*입력값-계약번호*/
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
             AND B1.CNTR_SN = #{cntrSn} /*입력값-계약일련번호*/
        </if>
            <choose>
                <when test='@MybatisUtils@isEmpty(fntDvCd)'>
                    JOIN (
                          SELECT 'AC' DV_CD
                               , C2.AC_FNT_RS_CD AS FNT_RS_CD/*출력값-자동이체결과코드*/
                               , C2.BNK_CD AS FNIT_CD
                               , C2.ACNO_ENCR AS ACNO_CDNO /*출력값-계좌카드번호*/
                               , C2.BIL_NO
                            FROM TB_RVCL_AC_FNT_SEND_MTR_IZ C2 /*계좌이체송신내역*/
                           WHERE C2.DTA_DL_YN = 'N'
                            <if test='@MybatisUtils@isNotEmpty(acnoCdno)'>
                             AND C2.ACNO_ENCR = #{acnoCdno} /*입력값-계좌카드번호*/
                            </if>
                           UNION ALL
                          SELECT 'CA' DV_CD
                               , C2.CARD_FNT_RS_CD AS FNT_RS_CD/*출력값-자동이체결과코드*/
                               , C2.CDCO_CD AS FNIT_CD
                               , C2.CRCDNO_ENCR AS ACNO_CDNO /*출력값-계좌카드번호*/
                               , C2.BIL_NO
                            FROM TB_RVCL_CARD_FNT_SEND_MTR_IZ C2 /*카드이체송신자료내역*/
                           WHERE C2.DTA_DL_YN = 'N'
                            <if test='@MybatisUtils@isNotEmpty(acnoCdno)'>
                             AND C2.CRCDNO_ENCR = #{acnoCdno} /*입력값-계좌카드번호*/
                            </if>
                         ) C1
                      ON C1.BIL_NO = A1.BIL_NO
                </when>
                <otherwise>
                <if test='@MybatisUtils@equals(fntDvCd, "01")'>
                     /*이체구분코드가 01인 경우 */
                    JOIN TB_RVCL_AC_FNT_SEND_MTR_IZ C1 /*계좌이체송신내역*/
                      ON C1.DTA_DL_YN = 'N'
                     AND C1.BIL_NO = A1.BIL_NO
                     AND C1.ACNO_ENCR = #{acnoCdno} /*입력값-계좌카드번호*/
                </if>
                <if test='@MybatisUtils@equals(fntDvCd, "02")'>
                     /*이체구분코드가 02인 경우 */
                    JOIN TB_RVCL_CARD_FNT_SEND_MTR_IZ C1 /*카드이체송신자료내역*/
                      ON C1.DTA_DL_YN = 'N'
                     AND C1.BIL_NO = A1.BIL_NO
                     AND C1.CRCDNO_ENCR = #{acnoCdno} /*입력값-계좌카드번호*/
                </if>
                </otherwise>
            </choose>
            JOIN TB_SSCT_CNTR_DTL D1 /*계약상세*/
              ON D1.DTA_DL_YN = 'N'
             AND D1.CNTR_NO = B1.CNTR_NO
             AND D1.CNTR_SN = B1.CNTR_SN
            JOIN TB_SSCT_CNTR_BAS E1 /*계약기본*/
              ON E1.DTA_DL_YN = 'N'
             AND E1.CNTR_NO = B1.CNTR_NO
            JOIN TB_CUBS_CST_BAS F1 /*고객기본*/
              ON F1.CST_NO = E1.CNTR_CST_NO
            JOIN TB_SSCT_CNTR_STLM_REL G1 /*계약결제관계*/
              ON G1.DTA_DL_YN = 'N'
             AND G1.DTL_CNTR_NO = B1.CNTR_NO
             AND G1.DTL_CNTR_SN = B1.CNTR_SN
            JOIN TB_SSCT_CNTR_STLM_BAS H1 /*계약결제기본*/
              ON H1.DTA_DL_YN = 'N'
             AND H1.CNTR_STLM_ID = G1.CNTR_STLM_REL_ID
           WHERE A1.DTA_DL_YN = 'N'
        <if test='@MybatisUtils@isNotEmpty(fntDvCd)'>
             AND A1.FNT_DV_CD = #{fntDvCd} /*입력값-이체구분코드*/
        </if>
        ORDER BY B1.DP_DT DESC
    </select>

    <select id="selectChangeItemizations"
            resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dto.WwdaAutoTransferInterfaceDto$SearchChangeRes">
        SELECT A1.DTL_CNTR_NO CNTR_NO /*출력값-계약번호*/
             , A1.DTL_CNTR_SN CNTR_SN /*출력값-계약일련번호*/
             , D1.SELL_TP_CD /*출력값-판매유형코드*/
             , F1.CST_KNM CNTRT_NM /*출력값-계약자명*/
             , B1.MPY_BSDT FNT_STPL_D /*출력값-이체약정일*/
             , B1.OWR_KNM /*출력값-소유자한글명*/
            <choose>
                <when test='@MybatisUtils@isEmpty(fntDvCd)'>
                   , (
                      SELECT A2.FNIT_NM
                        FROM TB_RVDW_FNIT_CD A2
                       WHERE A2.FNIT_DV_CD = CASE WHEN C1.FNT_DV = 'AC' THEN '1'
                                                  WHEN C1.FNT_DV = 'CA' THEN '9'
                                              END
                         AND 1 = CASE WHEN C1.FNT_DV = 'AC' AND A2.FNIT_CD = LPAD(B1.BNK_CD, 3, 0)  THEN 1
                                      WHEN C1.FNT_DV = 'CA' AND A2.FNIT_CD = LPAD(B1.CDCO_CD, 3, 0) THEN 1
                                  END
                     ) FNIT_NM /*출력값-금융기관명*/
                    , C1.FNT_RS_CD AFTN_RS_CD /*출력값-자동이체결과코드*/
                    , C1.AC_CR_ENCR ACNO_CDNO /*출력값-계좌카드번호*/
                    , (
                        SELECT B2.AFTN_RS_NM
                        FROM TB_RVDW_AFTN_RS_CD B2 /*자동이체결과코드*/
                       WHERE B2.AFTN_RS_DV_CD = CASE WHEN C1.FNT_DV = 'AC' THEN '1'
                                                     WHEN C1.FNT_DV = 'CA' THEN '9'
                                                 END
                         AND B2.AFTN_RS_CD = C1.FNT_RS_CD
                      ) AFTN_RS_NM /*출력값-자동이체결과명*/
                </when>
                <otherwise>
                   , (
                      SELECT A2.FNIT_NM
                        FROM TB_RVDW_FNIT_CD A2
                       WHERE A2.FNIT_DV_CD = CASE WHEN #{fntDvCd} = '01' THEN '1'
                                                  WHEN #{fntDvCd} = '02' THEN '2'
                                              END
                         AND A2.FNIT_CD = CASE WHEN #{fntDvCd} = '01' THEN LPAD(B1.BNK_CD, 3, 0)
                                               WHEN #{fntDvCd} = '02' THEN LPAD(B1.CDCO_CD, 3, 0)
                                           END
                     ) FNIT_NM /*출력값-금융기관명*/
                   <if test='@MybatisUtils@equals(fntDvCd, "01")'>
                   , C1.AC_FNT_RS_CD AFTN_RS_CD /*출력값-자동이체결과코드*/
                   , C1.ACNO_ENCR ACNO_CDNO /*출력값-계좌카드번호*/
                   </if>
                   <if test='@MybatisUtils@equals(fntDvCd, "02")'>
                   , C1.CARD_FNT_RS_CD AFTN_RS_CD /*출력값-자동이체결과코드*/
                   , C1.CRCDNO_ENCR ACNO_CDNO /*출력값-계좌카드번호*/
                   </if>
                  , (
                      SELECT B2.AFTN_RS_NM
                        FROM TB_RVDW_AFTN_RS_CD B2 /*자동이체결과코드*/
                       WHERE B2.AFTN_RS_DV_CD = CASE WHEN #{fntDvCd} = '01' THEN '1'
                                                     WHEN #{fntDvCd} = '02' THEN '9'
                                                 END
                        <if test='@MybatisUtils@equals(fntDvCd, "01")'>
                         AND B2.AFTN_RS_CD = C1.AC_FNT_RS_CD
                        </if>
                        <if test='@MybatisUtils@equals(fntDvCd, "02")'>
                         AND B2.AFTN_RS_CD = C1.CARD_FNT_RS_CD
                        </if>
                   ) AFTN_RS_NM /*출력값-자동이체결과명*/
                </otherwise>
            </choose>
			 , TO_CHAR(TO_DATE(B1.HIST_STRT_DTM,'YYYYMMDDHH24MISS'), 'YYYYMMDD') AS CH_DT /*변경일자*/
			 , TO_CHAR(TO_DATE(B1.HIST_STRT_DTM,'YYYYMMDDHH24MISS'), 'HH24MISS') AS CH_HH /*변경시간*/
			 , F_CMZ_USR_NM(B1.FST_RGST_USR_ID) AS FST_RGST_USR_NM /*등록자명*/
			 , (SELECT X.EPNO
                    FROM T_CMP_USR_ACO_M X
                   WHERE X.USR_ID = B1.FST_RGST_USR_ID
                     AND X.DEL_YN = 'N'
                  ) AS FST_RGST_USR_EPNO  /*등록자사번*/
			 , F_CMZ_USR_NM(B1.FNL_MDFC_USR_ID) AS FNL_MDFC_USR_NM /*수정자명*/
			 , (SELECT X.EPNO
                    FROM T_CMP_USR_ACO_M X
                   WHERE X.USR_ID = B1.FNL_MDFC_USR_ID
                     AND X.DEL_YN = 'N'
                  ) AS FNL_MDFC_USR_EPNO  /*수정사사번*/
          FROM TB_SSCT_CNTR_STLM_REL A1 /*계약결제관계*/
          JOIN TB_SSCT_CNTR_STLM_CH_HIST B1 /*계약결제변경이력*/
            ON B1.DTA_DL_YN = 'N'
           AND B1.CNTR_STLM_ID = A1.CNTR_STLM_ID
        <choose>
            <when test='@MybatisUtils@isEmpty(fntDvCd)'>
                  JOIN (
                        SELECT C2.CNTR_NO
                             , C2.CNTR_SN
                             , A2.AC_FNT_RS_CD FNT_RS_CD
                             , A2.ACNO_ENCR AC_CR_ENCR
                             , 'AC' AS FNT_DV
                             , ROW_NUMBER() OVER(PARTITION BY C2.CNTR_NO, C2.CNTR_SN ORDER BY B2.BIL_DT DESC) AS ROW_NUM
                          FROM TB_RVCL_AC_FNT_SEND_MTR_IZ A2
                          JOIN TB_RVCL_BIL_FNT_AK_BAS B2
                            ON B2.DTA_DL_YN = 'N'
                           AND B2.BIL_NO = A2.BIL_NO
                          JOIN TB_RVCL_BIL_FNT_AK_DTL C2
                            ON C2.DTA_DL_YN = 'N'
                           AND C2.BIL_NO = B2.BIL_NO
                         WHERE A2.DTA_DL_YN = 'N'
                           <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                           AND C2.CNTR_NO = #{cntrNo} /*입력값-계약번호*/
                           </if>
                           <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                           AND C2.CNTR_SN = #{cntrSn} /*입력값-계약번호*/
                           </if>
                        UNION ALL
                        SELECT C2.CNTR_NO
                             , C2.CNTR_SN
                             , A2.CARD_FNT_RS_CD FNT_RS_CD
                             , A2.CRCDNO_ENCR AC_CR_ENCR
                             , 'CA' AS FNT_DV
                             , ROW_NUMBER() OVER(PARTITION BY C2.CNTR_NO, C2.CNTR_SN ORDER BY B2.BIL_DT DESC) AS ROW_NUM
                          FROM TB_RVCL_CARD_FNT_SEND_MTR_IZ A2
                          JOIN TB_RVCL_BIL_FNT_AK_BAS B2
                            ON B2.DTA_DL_YN = 'N'
                           AND B2.BIL_NO = A2.BIL_NO
                          JOIN TB_RVCL_BIL_FNT_AK_DTL C2
                            ON C2.DTA_DL_YN = 'N'
                           AND C2.BIL_NO = B2.BIL_NO
                         WHERE A2.DTA_DL_YN = 'N'
                           <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                           AND C2.CNTR_NO = #{cntrNo} /*입력값-계약번호*/
                           </if>
                           <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                           AND C2.CNTR_SN = #{cntrSn} /*입력값-계약번호*/
                           </if>
                       ) C1
                    ON C1.CNTR_NO = A1.DTL_CNTR_NO
                   AND C1.CNTR_SN = A1.DTL_CNTR_SN
                   AND C1.ROW_NUM = 1
            </when>
            <otherwise>
                <if test='@MybatisUtils@equals(fntDvCd, "01")'>
                  JOIN (
                        SELECT C2.CNTR_NO
                             , C2.CNTR_SN
                             , A2.AC_FNT_RS_CD
                             , A2.ACNO_ENCR
                             , ROW_NUMBER() OVER(PARTITION BY C2.CNTR_NO, C2.CNTR_SN ORDER BY B2.BIL_DT DESC) AS ROW_NUM
                          FROM TB_RVCL_AC_FNT_SEND_MTR_IZ A2
                          JOIN TB_RVCL_BIL_FNT_AK_BAS B2
                            ON B2.DTA_DL_YN = 'N'
                           AND B2.BIL_NO = A2.BIL_NO
                          JOIN TB_RVCL_BIL_FNT_AK_DTL C2
                            ON C2.DTA_DL_YN = 'N'
                           AND C2.BIL_NO = B2.BIL_NO
                         WHERE A2.DTA_DL_YN = 'N'
                           AND A2.ACNO_ENCR = #{acnoCdno} /*입력값-계좌카드번호*/
                           <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                           AND C2.CNTR_NO = #{cntrNo} /*입력값-계약번호*/
                           </if>
                           <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                           AND C2.CNTR_SN = #{cntrSn} /*입력값-계약번호*/
                           </if>
                       ) C1
                    ON C1.CNTR_NO = A1.DTL_CNTR_NO
                   AND C1.CNTR_SN = A1.DTL_CNTR_SN
                   AND C1.ROW_NUM = 1
                </if>
                <if test='@MybatisUtils@equals(fntDvCd, "02")'>
                  JOIN (
                        SELECT C2.CNTR_NO
                             , C2.CNTR_SN
                             , A2.CARD_FNT_RS_CD
                             , A2.CRCDNO_ENCR
                             , ROW_NUMBER() OVER(PARTITION BY C2.CNTR_NO, C2.CNTR_SN ORDER BY B2.BIL_DT DESC) AS ROW_NUM
                          FROM TB_RVCL_CARD_FNT_SEND_MTR_IZ A2
                          JOIN TB_RVCL_BIL_FNT_AK_BAS B2
                            ON B2.DTA_DL_YN = 'N'
                           AND B2.BIL_NO = A2.BIL_NO
                          JOIN TB_RVCL_BIL_FNT_AK_DTL C2
                            ON C2.DTA_DL_YN = 'N'
                           AND C2.BIL_NO = B2.BIL_NO
                         WHERE A2.DTA_DL_YN = 'N'
                           AND A2.CRCDNO_ENCR = #{acnoCdno} /*입력값-계좌카드번호*/
                           <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                           AND C2.CNTR_NO = #{cntrNo} /*입력값-계약번호*/
                           </if>
                           <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                           AND C2.CNTR_SN = #{cntrSn} /*입력값-계약번호*/
                           </if>
                       ) C1
                    ON C1.CNTR_NO = A1.DTL_CNTR_NO
                   AND C1.CNTR_SN = A1.DTL_CNTR_SN
                   AND C1.ROW_NUM = 1
                </if>
            </otherwise>
        </choose>
          JOIN TB_SSCT_CNTR_DTL D1 /*계약상세*/
            ON D1.DTA_DL_YN = 'N'
           AND D1.CNTR_NO = A1.DTL_CNTR_NO
           AND D1.CNTR_SN = A1.DTL_CNTR_SN
          JOIN TB_SSCT_CNTR_BAS E1 /*계약기본*/
            ON E1.DTA_DL_YN = 'N'
           AND E1.CNTR_NO = A1.DTL_CNTR_NO
          JOIN TB_CUBS_CST_BAS F1 /*고객기본*/
            ON F1.CST_NO = E1.CNTR_CST_NO
         WHERE A1.DTA_DL_YN = 'N'
           <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
           AND A1.DTL_CNTR_NO = #{cntrNo} /*입력값-계약번호*/
           </if>
           <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
           AND A1.DTL_CNTR_SN = #{cntrSn} /*입력값-계약번호*/
           </if>
           <if test='@MybatisUtils@isNotEmpty(fntDvCd)'>
           AND A1.DP_TP_CD = DECODE(#{fntDvCd}, '01', '0102', '0203') /*입력값-이체구분코드*/
           </if>
        ORDER BY B1.MPY_BSDT DESC
    </select>

    <select id="selectObjectItemizations"
            resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dvo.WwdaAutoTransferObjectItemizationInterfaceDvo">
        SELECT DISTINCT
               CNTR_STLM_ID /*계약결제ID*/
             , CST_NO /*고객번호*/
             , SELL_TP_CD /*판매유형코드*/
             , SELL_TP_CD_NM /*판매유형코드명*/
             , CNTR_NO /*계약번호*/
             , CNTR_SN /*계약일련번호*/
             , CNTRT_NM /*계약자명*/
             , PD_NM /*상품명*/
             , ISTLL_KNM /*설치자한글명*/
             , FNT_DV_CD /*이체구분코드*/
             , FNT_DV_CD_NM /*이체구분코드명*/
             , FNIT_NM /*금융기관명*/
             , ACNO_CDNO /*계좌카드번호*/
             , OWR_KNM /*소유자한글명*/
             , FNT_STPL_D /*이체약정일*/
             , DG_YN /*대표여부*/
             , BNDL_CNTR_YN /*묶음계약여부*/
             , DG_CNTR_NO /*대표계약번호*/
             , DG_CNTR_SN /*대표계약일련번호*/
             , IST_DT /*설치일자*/
             , IST_ADDR /*설치주소*/
          FROM (
                SELECT D1.CNTR_STLM_ID AS CNTR_STLM_ID /*계약결제ID*/
                     , B1.CNTR_CST_NO AS CST_NO/*고객번호*/
                     , A1.SELL_TP_CD AS SELL_TP_CD /*판매유형코드*/
                     , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', A1.SELL_TP_CD) AS SELL_TP_CD_NM /*판매유형코드명*/
                     , A1.CNTR_NO /*계약번호*/
                     , A1.CNTR_SN /*계약일련번호*/
                     , NVL((SELECT A2.CST_KNM
                              FROM TB_CUBS_CST_BAS A2 /*고객기본*/
                             WHERE A2.CST_NO = B1.CNTR_CST_NO
                               AND A2.DTA_DL_YN = 'N'
                           ), B1.CNTR_CST_NM
                       ) AS CNTRT_NM /*계약자명*/
                     , (SELECT A2.PD_NM
                          FROM TB_PDBS_PD_BAS A2 /*상품기본*/
                         WHERE A2.DTA_DL_YN = 'N'
                           AND A2.PD_CD = A1.BASE_PD_CD
                       ) AS PD_NM /*상품명*/
                     , (SELECT B2.RCGVP_KNM
                          FROM TB_SSCT_CNTR_ADR_REL A2 /* 계약주소관계 */
                          JOIN TB_SSCT_CNTR_ADRPC_BAS B2 /* 계약주소지기본 */
                            ON B2.CNTR_ADRPC_ID = A2.CNTR_ADRPC_ID
                           AND B2.DTA_DL_YN = 'N'
                         WHERE A2.DTL_CNTR_NO = A1.CNTR_NO
                           AND A2.DTL_CNTR_SN = A1.CNTR_SN
                           AND A2.DTA_DL_YN = 'N'
                           AND A2.ADRPC_TP_CD IN ('2','3')
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN A2.VL_STRT_DTM AND A2.VL_END_DTM
                       ) AS ISTLL_KNM /*설치자한글명*/
                     , CASE WHEN D1.DP_TP_CD = '0102' THEN '01'
                            WHEN D1.DP_TP_CD = '0203' THEN '02'
                        END AS FNT_DV_CD /*이체구분코드*/
                     , F_CMZ_CD_NM('TNT_WELLS', 'FNT_DV_CD', CASE WHEN D1.DP_TP_CD = '0102' THEN '01'
                                                                   WHEN D1.DP_TP_CD = '0203' THEN '02'
                                                               END
                       ) AS FNT_DV_CD_NM /*이체구분코드명*/
                     , (SELECT A2.FNIT_NM
                          FROM TB_RVDW_FNIT_CD A2 /*금융기관코드*/
                         WHERE A2.FNIT_CD = CASE WHEN D1.DP_TP_CD = '0102' THEN D1.BNK_CD
                                                 WHEN D1.DP_TP_CD = '0203' THEN D1.CDCO_CD
                                             END
                       ) AS FNIT_NM /*금융기관명*/
                     , CASE WHEN D1.DP_TP_CD = '0102' THEN D1.ACNO_ENCR
                            WHEN D1.DP_TP_CD = '0203' THEN D1.CRCDNO_ENCR
                        END AS ACNO_CDNO /*계좌카드번호*/
                     , D1.OWR_KNM AS OWR_KNM /*소유자한글명*/
                     , D1.MPY_BSDT AS FNT_STPL_D /*이체약정일*/
                     , (SELECT A2.DG_YN
                          FROM TB_RVCL_ITG_BIL_OJ_BAS A2
                         WHERE A2.DTA_DL_YN = 'N'
                           AND A2.SUBOD_CNTR_NO = A1.CNTR_NO
                           AND A2.SUBOD_CNTR_SN = A1.CNTR_SN
                       ) AS DG_YN /*대표여부*/
                     , NVL((SELECT CASE WHEN COUNT(1) > 0 THEN 'Y' ELSE 'N' END
                          FROM TB_RVCL_ITG_BIL_OJ_BAS A2
                         WHERE A2.DTA_DL_YN = 'N'
                           AND A2.SUBOD_CNTR_NO = A1.CNTR_NO
                           AND A2.SUBOD_CNTR_SN = A1.CNTR_SN
                       ), 'N') AS BNDL_CNTR_YN /*묶음계약여부*/
                     , (SELECT A2.DG_CNTR_NO
                          FROM TB_RVCL_ITG_BIL_OJ_BAS A2
                         WHERE A2.DTA_DL_YN = 'N'
                           AND A2.SUBOD_CNTR_NO = A1.CNTR_NO
                           AND A2.SUBOD_CNTR_SN = A1.CNTR_SN
                       ) AS DG_CNTR_NO /*대표계약번호*/
                     , (SELECT A2.DG_CNTR_SN
                          FROM TB_RVCL_ITG_BIL_OJ_BAS A2
                         WHERE A2.DTA_DL_YN = 'N'
                           AND A2.SUBOD_CNTR_NO = A1.CNTR_NO
                           AND A2.SUBOD_CNTR_SN = A1.CNTR_SN
                       ) AS DG_CNTR_SN /*대표계약일련번호*/
                     , (SELECT A2.IST_DT
                          FROM TB_SSCT_CNTR_WELLS_DTL A2
                         WHERE A2.DTA_DL_YN = 'N'
                           AND A2.CNTR_NO = A1.CNTR_NO
                           AND A2.CNTR_SN = A1.CNTR_SN
                       ) AS IST_DT /*설치일자*/
                     , (SELECT C2.NEW_ADR_ZIP || ' ' || C2.RNADR || C2.RDADR
                          FROM TB_SSCT_CNTR_ADR_REL A2 /* 계약주소관계 */
                          JOIN TB_SSCT_CNTR_ADRPC_BAS B2 /* 계약주소지기본 */
                            ON B2.CNTR_ADRPC_ID = A2.CNTR_ADRPC_ID
                           AND B2.DTA_DL_YN = 'N'
                          JOIN TB_GBCO_ADR_BAS C2 /*주소기본*/
                            ON C2.DTA_DL_YN = 'N'
                           AND C2.ADR_ID = B2.ADR_ID
                         WHERE A2.DTL_CNTR_NO = A1.CNTR_NO
                           AND A2.DTL_CNTR_SN = A1.CNTR_SN
                           AND A2.DTA_DL_YN = 'N'
                           AND A2.ADRPC_TP_CD IN ('2','3')
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN A2.VL_STRT_DTM AND A2.VL_END_DTM
                       ) AS IST_ADDR /*설치주소*/
                     , TO_CHAR(ADD_MONTHS(TO_DATE((SELECT A2.IST_DT
                                                     FROM TB_SSCT_CNTR_WELLS_DTL A2
                                                    WHERE A2.DTA_DL_YN = 'N'
                                                      AND A2.CNTR_NO = A1.CNTR_NO
                                                      AND A2.CNTR_SN = A1.CNTR_SN
                                                  )
                                                 ), A1.CNTR_PTRM)
                        ,'YYYYMMDD') AS CNTR_PTRM
                     , E1.CAN_DT
                     , A1.CNTR_PD_ENDDT
                     , F1.CNTR_REL_DTL_CD
                     , NVL(E1.MM_ISTM_AMT, 0) AS MM_ISTM_AMT
                     , E1.FULPY_DT
                  FROM TB_SSCT_CNTR_DTL A1 /*계약상세*/
                  JOIN TB_SSCT_CNTR_BAS B1 /*계약기본*/
                    ON B1.DTA_DL_YN = 'N'
                   AND B1.CNTR_NO = A1.CNTR_NO
                  JOIN TB_SSCT_CNTR_STLM_REL C1 /*계약결제관계*/
                    ON C1.DTA_DL_YN = 'N'
                   AND C1.DTL_CNTR_NO = A1.CNTR_NO
                   AND C1.DTL_CNTR_SN = A1.CNTR_SN
                   AND C1.VL_END_DTM = '99991231235959'
                  JOIN TB_SSCT_CNTR_STLM_BAS D1 /*계약결제기본*/
                    ON D1.DTA_DL_YN = 'N'
                   AND D1.CNTR_STLM_ID = C1.CNTR_STLM_ID
            LEFT OUTER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ E1 /*WELLS매출월마감내역*/
                    ON E1.DTA_DL_YN = 'N'
                   AND E1.SL_CL_YM = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM')
                   AND E1.CNTR_NO = A1.CNTR_NO
                   AND E1.CNTR_SN = A1.CNTR_SN
            LEFT OUTER JOIN TB_SSCT_CNTR_REL F1
                    ON F1.DTA_DL_YN = 'N'
                   AND F1.BASE_DTL_CNTR_NO = A1.CNTR_NO
                   AND F1.BASE_DTL_CNTR_SN = A1.CNTR_SN
                   AND F1.VL_END_DTM = '99991231235959'
                 WHERE 1=1
                   AND A1.CNTR_DTL_STAT_CD NOT IN ('301', '302', '303', '401')
                   AND C1.DP_TP_CD IN ('0102', '0203')
                   AND B1.CNTR_CST_NO = #{cstNo} /*고객번호*/
                <if test='@MybatisUtils@isNotEmpty(sellTps)'>
                   AND A1.SELL_TP_CD IN
                        <foreach collection="sellTps" item="item" open='(' close=')' separator=', '>
                            <if test='@MybatisUtils@isNotEmpty(item)'>
                             #{item}
                            </if>
                        </foreach> /*판매유형코드*/
                </if>
                   AND 1 = CASE WHEN A1.SELL_TP_CD = '1' AND A1.MM_ISTM_AMT > 0
                                                         AND A1.CNTR_PD_STRTDT IS NOT NULL
                                                         AND A1.ISTM_MCN - ( MONTHS_BETWEEN(TO_DATE(TO_CHAR(SYSDATE, 'YYYYMM')||'01', 'YYYYMMDD'), TO_DATE(SUBSTR(A1.CNTR_PD_STRTDT, 1, 6)||'01', 'YYYYMMDD')) - 1 ) > 0 THEN 1
                                WHEN A1.SELL_TP_CD = '1' THEN 2
                                ELSE 1
                            END
               )
         WHERE 1=1
        <if test='@MybatisUtils@isNotEmpty(excdYn01) and @MybatisUtils@equals(excdYn01, "Y")'>
            /* 렌탈취소건 제외 처리 */
           AND 1 = CASE WHEN SELL_TP_CD = '2' AND CAN_DT IS NOT NULL THEN 2 ELSE 1 END
        </if>
        <if test='@MybatisUtils@isNotEmpty(excdYn02) and @MybatisUtils@equals(excdYn02, "Y")'>
            /* 린탈만료건 제외 처리 */
           AND 1 = CASE WHEN SELL_TP_CD = '2' AND CNTR_PTRM <![CDATA[<]]> TO_CHAR(SYSDATE, 'YYYYMMDD') THEN 2 ELSE 1 END
        </if>
        <if test='@MybatisUtils@isNotEmpty(excdYn03) and @MybatisUtils@equals(excdYn03, "Y")'>
            /* 멤버십탈퇴건 제외 처리 */
           AND 1 = CASE WHEN SELL_TP_CD = '3' AND CNTR_PD_ENDDT IS NOT NULL THEN 2 ELSE 1 END
        </if>
        <if test='@MybatisUtils@isNotEmpty(excdYn04) and @MybatisUtils@equals(excdYn04, "Y")'>
            /* 정기배송취소건 제외 처리 */
           AND 1 = CASE WHEN SELL_TP_CD = '6' AND CNTR_REL_DTL_CD = '216' THEN 2
                        WHEN SELL_TP_CD = '6' AND CNTR_PD_ENDDT IS NOT NULL THEN 2
                        ELSE 1
                    END
        </if>
        <if test='@MybatisUtils@isNotEmpty(excdYn05) and @MybatisUtils@equals(excdYn05, "Y")'>
            /* 할부취소건 제외 처리 */
           AND 1 = CASE WHEN SELL_TP_CD = '1' AND MM_ISTM_AMT <![CDATA[>]]> 0 AND FULPY_DT IS NULL THEN 2
                        ELSE 1
                    END
        </if>

    </select>

    <select id="selectInfos"
            resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dvo.WwdaAutoTransferInfoInterfaceDvo">
        SELECT CASE WHEN B1.DP_TP_CD = '0102' THEN '01'
                    WHEN B1.DP_TP_CD = '0203' THEN '02'
                END FNT_DV_CD /*출력값-이체구분코드*/
             , F_CMZ_CD_NM(#{session.tenantId}, 'FNT_DV_CD', CASE WHEN B1.DP_TP_CD = '0102' THEN '01'
                                                                  WHEN B1.DP_TP_CD = '0203' THEN '02'
                                                              END
               ) FNT_DV_CD_NM  /*이체구분코드명*/
             , CASE WHEN B1.DP_TP_CD = '0102' THEN B1.BNK_CD
                    WHEN B1.DP_TP_CD = '0203' THEN B1.CDCO_CD
                END FNIT_CD /*출력값-금융기관코드*/
             , (SELECT A2.FNIT_NM
                  FROM TB_RVDW_FNIT_CD A2
                 WHERE A2.FNIT_DV_CD = CASE WHEN B1.DP_TP_CD = '0102' THEN '1'
                                            WHEN B1.DP_TP_CD = '0203' THEN '2'
                                        END
                   AND A2.FNIT_CD = CASE WHEN B1.DP_TP_CD = '0102' THEN LPAD(B1.BNK_CD, 3, 0)
                                         WHEN B1.DP_TP_CD = '0203' THEN LPAD(B1.CDCO_CD, 3, 0)
                                     END
               ) FNIT_NM /*출력값-금융기관명*/
             , CASE WHEN B1.DP_TP_CD = '0102' THEN B1.ACNO_ENCR
                    WHEN B1.DP_TP_CD = '0203' THEN B1.CRCDNO_ENCR
                END ACNO_CDNO /*출력값-계좌카드번호*/
             , B1.OWR_KNM /*출력값-소유자한글명*/
             , B1.MPY_BSDT FNT_STPL_D /*출력값-이체약정일*/
             , B1.CARD_EXPDT_YM /*출력값-카드유효기간년월*/
             , E1.COPN_DV_CD /*출력값-법인격구분코드*/
             , CASE WHEN E1.COPN_DV_CD = '1' THEN E1.BRYY_MMDD
                    WHEN E1.COPN_DV_CD = '2' THEN E1.BZRNO
                END COPN_DV_DRM_VAL /*출력값-법인격구분식별값*/
             , E1.CRAL_LOCARA_TNO
             , E1.MEXNO_ENCR
             , E1.CRAL_IDV_TNO
             , '' MPNO /*휴대전화번호*/
             , CASE WHEN B1.DP_TP_CD = '0102' THEN B1.AC_FNT_IMPS_CD
                    WHEN B1.DP_TP_CD = '0203' THEN B1.CARD_FNT_IMPS_CD
                END AFTN_RS_CD /*출력값-자동이체결과코드*/
             , (
                SELECT B2.AFTN_RS_NM
                  FROM TB_RVDW_AFTN_RS_CD B2 /*자동이체결과코드*/
                 WHERE (
                        CASE WHEN B1.DP_TP_CD = '0102' AND B2.AFTN_RS_DV_CD IN ('1') THEN 1
                             WHEN B1.DP_TP_CD = '0203' AND B2.AFTN_RS_DV_CD IN ('9') THEN 1
                             ELSE 0
                         END
                       ) = 1
                   AND B2.AFTN_RS_CD = CASE WHEN B1.DP_TP_CD = '0102' THEN B1.AC_FNT_IMPS_CD
                                            WHEN B1.DP_TP_CD = '0203' THEN B1.CARD_FNT_IMPS_CD
                                        END
               ) AFTN_RS_NM /*출력값-자동이체결과명*/
          FROM TB_SSCT_CNTR_STLM_REL A1
          JOIN TB_SSCT_CNTR_STLM_BAS B1
            ON B1.DTA_DL_YN = 'N'
           AND B1.CNTR_STLM_ID = A1.CNTR_STLM_ID
          JOIN TB_SSCT_CNTR_BAS D1
            ON D1.DTA_DL_YN = 'N'
           AND D1.CNTR_NO = A1.DTL_CNTR_NO
          JOIN TB_CUBS_CST_BAS E1
            ON E1.DTA_DL_YN = 'N'
           AND E1.CST_NO = D1.CNTR_CST_NO
         WHERE A1.DTA_DL_YN = 'N'
           AND A1.DTL_CNTR_NO = #{cntrNo} /*입력값-계약번호*/
           AND A1.DTL_CNTR_SN = #{cntrSn} /*입력값-계약일련번호*/
           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN A1.VL_STRT_DTM AND A1.VL_END_DTM
    </select>

    <select id="selectCorporatePersonalityDivisions"
            resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dto.WwdaAutoTransferInterfaceDto$SearchCorporatePersonalityDivisionRes">
          SELECT A1.CD_VLD_VAL COPN_DV_CD
               , B1.MLNG_CNTN  COPN_DV_CD_NM
            FROM T_CMZ_CD_D A1
            JOIN T_CMZ_MLNG_D B1
              ON B1.DEL_YN = 'N'
             AND B1.MLNG_ID = A1.CD_DTL_MLNG_ID
             AND B1.LNG_ID = 'ko'
             AND B1.TENANT_ID = #{session.tenantId}
           WHERE A1.CD_ID = 'COPN_DV_CD'
             AND A1.TENANT_ID = #{session.tenantId}
        <if test="@MybatisUtils@isNotEmpty(copnDvCd)">
             AND A1.CD_VLD_VAL = #{copnDvCd} /*입력값-이체구분*/
        </if>
    </select>

    <select id="selectFinancialInstitutionCodes"
            resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dto.WwdaAutoTransferInterfaceDto$SearchFinancialInstitutionCodeRes">
        SELECT MT.FNIT_CD
             , MT.FNIT_NM
          FROM TB_RVDW_FNIT_CD MT
         WHERE 1 = 1
           AND MT.FNIT_DG_CD_YN = 'Y'
           AND MT.FNIT_DV_CD    = 1
           AND MT.DTA_DL_YN     = 'N'
           AND MT.KFTC_CD_YN    = 'Y'
           AND MT.FNIT_CD       IN (SELECT FNIT_CD
                                       FROM TB_RVDW_FNIT_FEE_BAS LT
                                      WHERE LT.FNIT_CD        = MT.FNIT_CD
                                        AND LT.DTA_DL_YN      = 'N'
                                        AND LT.FNIT_FEE_TP_CD = '4' /* 금융기관수수료유형코드(1 - 가상계좌, 2 - 신용카드, 3 - 카드자동이체, 4 - 현금자동이체) */
                                        AND LT.VNCO_DV_CD     IN ('002', '003') /* VAN사구분코드(002 - 세틀뱅크, 003 - KICC, 001 - 금결원) */
                                        AND LT.VL_STRTDT <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
                                        AND LT.VL_ENDDT  <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDD') )
        <if test="@MybatisUtils@isNotEmpty(fnitCd)">
          AND MT.FNIT_CD     = #{fnitCd} <!-- VAN사구분코드(002 - 세틀뱅크, 003 - KICC, 001 - 금결원) -->
        </if>
        ORDER BY MT.FNIT_CD
    </select>

    <select id="selectBundleInfos"
            resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dto.WwdaAutoTransferInterfaceDto$SearchBundleInfoRes">
          SELECT A1.CNTR_CST_NO CST_NO /*고객번호*/
               , B1.CNTR_NO /*계약번호*/
               , B1.CNTR_SN /*계약일련번호*/
               , (
                  SELECT A2.CST_KNM
                    FROM TB_CUBS_CST_BAS A2
                   WHERE A2.CST_NO = A1.CNTR_CST_NO
                 ) CNTRT_NM /*계약자명*/
               , (
                  SELECT A2.PD_NM
                    FROM TB_PDBS_PD_BAS A2
                   WHERE A2.PD_CD = B1.BASE_PD_CD
                 ) PD_NM /*상품명*/
               , (SELECT B.RCGVP_KNM
                    FROM TB_SSCT_CNTR_ADR_REL A
                    JOIN TB_SSCT_CNTR_ADRPC_BAS B
                      ON B.DTA_DL_YN = 'N'
                     AND B.CNTR_ADRPC_ID = A.CNTR_ADRPC_ID
                   WHERE A.ADRPC_TP_CD IN ('2', '3')
                     AND A.DTL_CNTR_NO = B1.CNTR_NO
                     AND A.DTL_CNTR_SN = B1.CNTR_SN
                     AND A.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                     AND A.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                 ) ISTLL_KNM /*설치자한글명*/
               , CASE WHEN D1.DP_TP_CD = '0102' THEN '01'
                      WHEN D1.DP_TP_CD = '0203' THEN '02'
                  END FNT_DV_CD /*이체구분코드*/
               , F_CMZ_CD_NM('TNT_BASE', 'DP_TP_CD', D1.DP_TP_CD) FNT_DV_CD_NM /*이체구분코드명*/
               , (
                  SELECT A2.FNIT_NM
                    FROM TB_RVDW_FNIT_CD A2
                   WHERE A2.FNIT_CD = CASE WHEN D1.DP_TP_CD = '0102' THEN LPAD(D1.BNK_CD, 3, 0)
                                           WHEN D1.DP_TP_CD = '0203' THEN LPAD(D1.CDCO_CD, 3, 0)
                                       END
                     AND A2.FNIT_DV_CD = CASE WHEN D1.DP_TP_CD = '0102' THEN '1'
                                              WHEN D1.DP_TP_CD = '0203' THEN '2'
                                         END
                 ) FNIT_NM /*금융기관명*/
               , CASE WHEN D1.DP_TP_CD = '0102' THEN D1.ACNO_ENCR
                      WHEN D1.DP_TP_CD = '0203' THEN D1.CRCDNO_ENCR
                  END ACNO_CDNO /*계좌카드번호*/
               , D1.OWR_KNM /*소유자한글명*/
               , D1.MPY_BSDT FNT_STPL_D /*이체약정일*/
               , NVL(C1.DG_YN, 'N') DG_YN /*대표여부*/
               , DECODE(C1.ITG_BIL_OJ_ID,  NULL, 'N', 'Y') BNDL_YN /*묶음여부*/
               , NVL(C1.DG_CNTR_NO, '없음') DG_CNTR_NO /*대표계약번호*/
               , C1.DG_CNTR_SN /*대표계약일련번호*/
               , (SELECT IST_DT FROM TB_SSCT_CNTR_WELLS_DTL A WHERE A.DTA_DL_YN = 'N' AND A.CNTR_NO = B1.CNTR_NO AND A.CNTR_SN = B1.CNTR_SN) IST_DT /*설치일자*/
               , C1.FNL_MDFC_DTM MDFC_DT /*수정일자*/
               , C1.FNL_MDFC_USR_ID /*수정담당자ID*/
               , (
                  SELECT A2.CST_KNM
                    FROM TB_CUBS_CST_BAS A2
                   WHERE A2.CST_NO = C1.FNL_MDFC_USR_ID
                 ) MDFC_PSIC_NM /*수정담당자명*/
            FROM TB_SSCT_CNTR_BAS A1 /*계약기본*/
            JOIN TB_SSCT_CNTR_DTL B1 /*계약상세*/
              ON B1.DTA_DL_YN = 'N'
             AND B1.CNTR_NO = A1.CNTR_NO
      LEFT OUTER JOIN TB_RVCL_ITG_BIL_OJ_BAS C1 /*통합청구대상기본*/
              ON C1.DTA_DL_YN = 'N'
             AND C1.SUBOD_CNTR_NO = B1.CNTR_NO
             AND C1.SUBOD_CNTR_SN = B1.CNTR_SN
            JOIN (
                   SELECT D2.DTL_CNTR_NO CNTR_NO
                        , D2.DTL_CNTR_SN CNTR_SN
                        , D2.DP_TP_CD
                        , D3.BNK_CD
                        , D3.ACNO_ENCR
                        , D3.CRCDNO_ENCR
                        , D3.CDCO_CD
                        , D3.OWR_KNM
                        , D3.MPY_BSDT
                        , ROW_NUMBER() OVER(PARTITION BY D2.DTL_CNTR_NO, D2.DTL_CNTR_SN ORDER BY D2.VL_STRT_DTM DESC) AS RN
                     FROM TB_SSCT_CNTR_STLM_REL D2
                     JOIN TB_SSCT_CNTR_STLM_BAS D3 /* 계약결제기본 */
                       ON D3.CNTR_STLM_ID = D2.CNTR_STLM_ID
                      AND D3.DTA_DL_YN = 'N'
                    WHERE D2.DTA_DL_YN = 'N'
                      AND D2.VL_END_DTM = '99991231235959'
                 ) D1  /*계약결제기본*/
              ON D1.RN = 1
             AND D1.CNTR_NO = B1.CNTR_NO
             AND D1.CNTR_SN = B1.CNTR_SN
           WHERE A1.DTA_DL_YN = 'N'
             AND A1.CNTR_CAN_DTM IS NULL
             AND A1.CNTR_CST_NO = #{cstNo}
             AND B1.CNTR_DTL_STAT_CD NOT IN ('301', '302', '303', '401')
             AND D1.DP_TP_CD = CASE WHEN #{fntDvCd} = '01' THEN '0102'
                                    WHEN #{fntDvCd} = '02' THEN '0203'
                                END
    </select>

    <select id="selectEvidenceInfos"
            resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dvo.WwdaAutoTransferInfoEvidenceInfoInterfaceDvo">
           SELECT TO_CHAR(TO_DATE(A1.CNTR_CH_RCP_DTM, 'YYYYMMDDHH24MISS'), 'YYYYMMDD') RCT_DT /*접수일자*/
                , TO_CHAR(TO_DATE(A1.CNTR_CH_RCP_DTM, 'YYYYMMDDHH24MISS'), 'HH24MISS') RCT_TM /*접수시간*/
                , F1.EPNO AS CH_RCP_USR_ID /*변경접수사용자ID*/
                , F1.USR_NM AS PSIC_NM /*담당자명*/
                , B1.DTL_CNTR_NO CNTR_NO /*계약번호*/
                , B1.DTL_CNTR_SN CNTR_SN /*계약일련번호*/
                , (
                   SELECT A2.SELL_TP_CD
                     FROM TB_SSCT_CNTR_DTL A2
                    WHERE A2.DTA_DL_YN = 'N'
                      AND A2.CNTR_NO = B1.DTL_CNTR_NO
                      AND A2.CNTR_SN = B1.DTL_CNTR_SN
                  ) SELL_TP_CD /*판매유형코드*/
                , (
                   SELECT B2.PD_NM
                     FROM TB_SSCT_CNTR_DTL A2
                     JOIN TB_PDBS_PD_BAS B2
                       ON B2.PD_CD = A2.BASE_PD_CD
                    WHERE A2.DTA_DL_YN = 'N'
                      AND A2.CNTR_NO = B1.DTL_CNTR_NO
                      AND A2.CNTR_SN = B1.DTL_CNTR_SN
                  ) PD_NM /*상품명*/
                , D1.FNT_EVID_DRM_VAL
                , CASE WHEN D1.FNT_EVID_DRM_VAL != 'P0100' AND D1.FNT_EVID_DRM_VAL != 'P01nullnullnullnull' THEN SUBSTR(D1.FNT_EVID_DRM_VAL,4,3) || '-' || SUBSTR(D1.FNT_EVID_DRM_VAL,7,4) || '-' || SUBSTR(D1.FNT_EVID_DRM_VAL,11,4)
                       ELSE ''
                  END AS MPNO /*휴대전화번호*/

<!--                , SUBSTR(D1.FNT_EVID_DRM_VAL,4,3) AS CRAL_LOCARA_TNO /*휴대지역전화번호*/-->
<!--                , SUBSTR(D1.FNT_EVID_DRM_VAL,7,4) AS MEXNO_ENCR /*휴대전화국번호암호화*/-->
<!--                , SUBSTR(D1.FNT_EVID_DRM_VAL,11,4) AS CRAL_IDV_TNO /*휴대개별전화번호*/-->
<!--                , '' MPNO /*휴대전화번호*/-->
                , (
                   SELECT AA1.FNIT_NM
                     FROM (
                   SELECT C2.FNIT_NM
                        , ROW_NUMBER() OVER(PARTITION BY A2.DTL_CNTR_NO, A2.DTL_CNTR_SN ORDER BY A2.VL_STRT_DTM DESC) AS RN
                     FROM TB_SSCT_CNTR_STLM_REL A2
                     JOIN TB_SSCT_CNTR_STLM_BAS B2
                       ON B2.DTA_DL_YN = 'N'
                      AND B2.CNTR_STLM_ID = A2.BF_CNTR_STLM_ID
                     JOIN TB_RVDW_FNIT_CD C2
                       ON C2.FNIT_CD = B2.BNK_CD
                    WHERE A2.CNTR_STLM_ID = D1.CNTR_STLM_ID
                      AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN A2.VL_STRT_DTM AND A2.VL_END_DTM
                      AND A2.VL_END_DTM = '99991231235959'
                      AND C2.FNIT_CD = CASE WHEN B2.DP_TP_CD = '0102' THEN LPAD(B2.BNK_CD, 3, 0)
                                            WHEN B2.DP_TP_CD = '0203' THEN LPAD(B2.CDCO_CD, 3, 0)
                                        END
                      AND C2.FNIT_DV_CD = CASE WHEN B2.DP_TP_CD = '0102' THEN '1'
                                               WHEN B2.DP_TP_CD = '0203' THEN '2'
                                           END
                      AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN C2.VL_STRTDT AND C2.VL_ENDDT
                  ) AA1
                  WHERE AA1.RN = 1
                  ) BFCH_FNIT_NM /*변경전금융기관명*/
                , (
                   SELECT AA1.BFCH_ACNO_CDNO
                     FROM (
                   SELECT CASE WHEN A2.DP_TP_CD = '0102' THEN B2.ACNO_ENCR
                               WHEN A2.DP_TP_CD = '0203' THEN B2.CRCDNO_ENCR
                           END BFCH_ACNO_CDNO
                        , ROW_NUMBER() OVER(PARTITION BY A2.DTL_CNTR_NO, A2.DTL_CNTR_SN ORDER BY A2.VL_STRT_DTM DESC) AS RN
                     FROM TB_SSCT_CNTR_STLM_REL A2
                     JOIN TB_SSCT_CNTR_STLM_BAS B2
                       ON B2.DTA_DL_YN = 'N'
                      AND B2.CNTR_STLM_ID = A2.BF_CNTR_STLM_ID
                     JOIN TB_RVDW_FNIT_CD C2
                       ON C2.FNIT_CD = B2.BNK_CD
                    WHERE A2.CNTR_STLM_ID = D1.CNTR_STLM_ID
                      AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN A2.VL_STRT_DTM AND A2.VL_END_DTM
                      AND A2.VL_END_DTM = '99991231235959'
                  ) AA1
                  WHERE AA1.RN = 1
                  ) BFCH_ACNO_CDNO /*변경전계좌카드번호*/
                , (
                   SELECT AA1.OWR_KNM
                     FROM (
                   SELECT B2.OWR_KNM
                        , ROW_NUMBER() OVER(PARTITION BY A2.DTL_CNTR_NO, A2.DTL_CNTR_SN ORDER BY A2.VL_STRT_DTM DESC) AS RN
                     FROM TB_SSCT_CNTR_STLM_REL A2
                     JOIN TB_SSCT_CNTR_STLM_BAS B2
                       ON B2.DTA_DL_YN = 'N'
                      AND B2.CNTR_STLM_ID = A2.BF_CNTR_STLM_ID
                     JOIN TB_RVDW_FNIT_CD C2
                       ON C2.FNIT_CD = B2.BNK_CD
                    WHERE A2.CNTR_STLM_ID = D1.CNTR_STLM_ID
                      AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN A2.VL_STRT_DTM AND A2.VL_END_DTM
                      AND A2.VL_END_DTM = '99991231235959'
                  )AA1
                  WHERE AA1.RN = 1
                  ) BFCH_OWR_KNM /*변경전소유자한글명*/
                , (
                   SELECT A2.FNIT_NM
                     FROM TB_RVDW_FNIT_CD A2
                    WHERE A2.FNIT_CD = CASE WHEN D1.DP_TP_CD = '0102' THEN LPAD(D1.BNK_CD, 3, 0)
                                            WHEN D1.DP_TP_CD = '0203' THEN LPAD(D1.CDCO_CD, 3, 0)
                                        END
                      AND A2.FNIT_DV_CD = CASE WHEN D1.DP_TP_CD = '0102' THEN '1'
                                               WHEN D1.DP_TP_CD = '0203' THEN '2'
                                           END
                      AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN A2.VL_STRTDT AND A2.VL_ENDDT
                  ) AFCH_FNIT_NM /*변경후금융기관명*/
                , CASE WHEN D1.DP_TP_CD = '0102' THEN D1.ACNO_ENCR
                       WHEN D1.DP_TP_CD = '0203' THEN D1.CRCDNO_ENCR
                   END AFCH_ACNO_CDNO /*변경후계좌카드번호*/
                , D1.OWR_KNM AFCH_OWR_KNM /*변경후소유자한글명*/
                , D1.MPY_BSDT FNT_STPL_D /*이체약정일*/
                , E1.TRS_DTM AFTN_EVID_FSH_DT /*자동이체증빙완료일자*/
                , CASE WHEN E1.TRS_DTM IS NOT NULL THEN 'Y' ELSE 'N' END AFTN_EVID_FSH_YN /*자동이체증빙완료여부*/
                , F_CMZ_CD_NM(#{session.tenantId}, 'FNIT_APR_RS_CD', D1.FNIT_APR_RS_CD) AS FNIT_APR_RS_CD /*금융기관승인결과코드명*/
                , F_CMZ_CD_NM(#{session.tenantId}, 'SELL_TP_CD', (
                                                                  SELECT A2.SELL_TP_CD
                                                                    FROM TB_SSCT_CNTR_DTL A2
                                                                   WHERE A2.DTA_DL_YN = 'N'
                                                                     AND A2.CNTR_NO = B1.DTL_CNTR_NO
                                                                     AND A2.CNTR_SN = B1.DTL_CNTR_SN
                                                                 )
                  ) SELL_TP_CD_NM /*판매유형코드명*/
             FROM TB_SSCT_CNTR_CH_RCP_BAS A1 /*계약변경접수기본*/
       LEFT OUTER JOIN TB_SSCT_CNTR_CH_RCP_DTL B1 /*계약변경접수상세*/
               ON (B1.CNTR_CH_RCP_ID = A1.CNTR_CH_RCP_ID)
       LEFT OUTER JOIN TB_SSCT_CNTR_STLM_BAS D1 /*계약결제기본*/
               ON (D1.CNTR_STLM_ID = B1.CNTR_STLM_ID)
       LEFT OUTER JOIN (
                   SELECT E1.CNTR_NO
                        , E1.CNTR_SN
                        , E1.APR_DT
                        , E1.BNK_CD
                        , E1.TRS_DTM
                        , ROW_NUMBER() OVER ( PARTITION BY E1.CNTR_NO, E1.CNTR_SN ORDER BY E1.APR_DT DESC ) RN
                     FROM TB_RVCL_AC_FNT_EVID_MTRS_IZ E1
                    WHERE E1.DTA_DL_YN = 'N'
                  ) E1
               ON (    E1.RN = 1
                   AND E1.CNTR_NO = B1.DTL_CNTR_NO
                   AND E1.CNTR_SN = B1.DTL_CNTR_SN
                   AND E1.APR_DT = TO_CHAR(TO_DATE(A1.CNTR_CH_RCP_DTM, 'YYYYMMDDHH24MISS'), 'YYYYMMDD')
                   AND E1.BNK_CD = D1.BNK_CD
                  )
       LEFT OUTER JOIN T_CMP_USR_ACO_M F1
              ON F1.USR_ID = A1.CH_RCP_USR_ID
           WHERE 1=1
             AND A1.CNTR_CH_TP_CD = '301' /*자동이체변경*/
        <if test='@MybatisUtils@isNotEmpty(rctDt)'>
             AND A1.CNTR_CH_RCP_DTM BETWEEN #{rctDt}||'000000' AND #{rctDt}||'235959'
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
             AND B1.DTL_CNTR_NO = #{cntrNo}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
             AND B1.DTL_CNTR_SN = #{cntrSn}
        </if>
        <if test='@MybatisUtils@isNotEmpty(chRcpUsrId)'>
             AND (
                   SELECT EPNO
                     FROM T_CMP_USR_ACO_M
                     WHERE USR_ID = A1.CH_RCP_USR_ID
                  ) = #{chRcpUsrId}
        </if>
        <if test='@MybatisUtils@equals(evidFshYn, "Y")'>
             AND E1.TRS_DTM IS NOT NULL
        </if>
        <if test='@MybatisUtils@equals(evidFshYn, "N")'>
             AND E1.TRS_DTM IS NULL
        </if>
        <if test='@MybatisUtils@isNotEmpty(owrKnm)'>
             AND D1.OWR_KNM LIKE '%'||#{owrKnm}||'%'
        </if>
    </select>

    <select id="selectBankCode" resultType="string">
        SELECT FNIT_NM
          FROM TB_RVDW_FNIT_CD A1
         WHERE A1.DTA_DL_YN = 'N'
           AND A1.FNIT_DV_CD = '1'
           AND A1.FNIT_CD = #{fnitCd}
           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN A1.VL_STRTDT || '000000' AND A1.VL_ENDDT||'235959'
    </select>

    <select id="selectBillingSchedule" resultType="string">
        SELECT BIL_SCHD_NO
          FROM TB_RVCL_BIL_SCHD_BAS A1
         WHERE A1.DTA_DL_YN = 'N'
           AND A1.BIL_TP_CD = '1'
           AND A1.BIL_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND A1.RGL_FNT_D = SUBSTR(#{mpyBsdt}, -2)
    </select>

    <select id="selectBillingScheduleReceive" resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dvo.WwdaBillingScheduleReceiveInterfaceDvo">
        SELECT CASE WHEN A1.RVE_DT IS NULL THEN 'Y' ELSE 'N' END RVE_DT
          FROM TB_RVCL_BIL_FNT_AK_BAS A1
          JOIN TB_RVCL_BIL_FNT_AK_DTL B1
            ON B1.DTA_DL_YN = 'N'
           AND B1.BIL_NO = A1.BIL_NO
           AND B1.CNTR_NO = #{cntrNo}
           AND B1.CNTR_SN = #{cntrSn}
         WHERE A1.DTA_DL_YN = 'N'
         ORDER BY A1.FST_RGST_DTM DESC
         FETCH FIRST 1 ROWS ONLY
    </select>

    <select id="selectContractInfo" resultType="com.kyowon.sms.wells.web.withdrawal.interfaces.dvo.WwdaBillingScheduleReceiveInterfaceDvo">
        SELECT A1.SELL_PRTNR_NO
          FROM TB_SSCT_CNTR_BAS A1
         WHERE A1.DTA_DL_YN = 'N'
           AND A1.CNTR_NO = #{cntrNo}
    </select>

    <select id="selectAutomaticTransferResultCodeName" resultType="string">
        SELECT A1.AFTN_RS_NM
          FROM TB_RVDW_AFTN_RS_CD A1
         WHERE A1.DTA_DL_YN = 'N'
        <if test='@MybatisUtils@equals(searchDv, "VAC")'>
           AND A1.AFTN_RS_DV_CD = '6' /*자동이체결과구분코드*/
        </if>
        <if test='@MybatisUtils@equals(searchDv, "CARD")'>
           AND A1.AFTN_RS_DV_CD = '9' /*자동이체결과구분코드*/
        </if>
           AND A1.AFTN_RS_CD  = #{fntRsCd} /*계좌이체결과코드*/
    </select>
</mapper>
