<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.pchssl.mapper.WwdcSalesControlMapper">

    <select id="selectSalesControl"
            resultType="com.kyowon.sms.wells.web.withdrawal.pchssl.dto.WwdcSalesControlDto$SearchSalesControlRes">
         SELECT T1.CNTR_NO /* 계약번호 */
              , T1.CNTR_SN /* 계약일련번호 */
              , T1.CNTR_NO || T1.CNTR_SN AS CNTR_DTL_NO /* 계약상세번호 */
              , T5.CST_KNM /* 고객명(한글) */
              , T1.SL_CTR_STRT_YM /* 조정시작년월 */
              , T1.SL_CTR_END_YM /* 조정종료년월 */
              , T4.PD_CD /* 제품코드 */
              , T4.PD_NM /* 제품명 */
              
              , T1.SL_CTR_SELL_TP_CD /* 매출조정판매유형*/
              , T1.SL_CTR_MTR_DV_CD /* 매출조정자료구분코드 */
              , T1.SL_CTR_MTR_TP_CD /* 매출조정자료유형코드 */
              , T1.SL_CTR_DV_CD /* 매출조정구분코드 */
              , T1.SL_CTR_TP_CD /* 매출조정유형코드 */
              , T1.SL_CTR_DSC_TP_CD /* 매출조정할인유형코드 */
              , T1.CAN_AF_OJ_YN /* 취소후적용 - default N */
              , T1.SL_CTR_AMT /* 매출조정금액 */
              , T1.SL_CTR_WO_EXMP_AMT /* 매출전액면제금액 */
              , T1.SL_CTR_PTRM_EXMP_AMT /* 매출조정기간면제금액 */
              , T1.SL_CTR_RMK_CN /* 조정비고내용 - 사유 */
              
              , T1.SL_CTR_PRCSDT /* 등록일자 */
              
              , (SELECT USR_NM 
                   FROM T_CMP_USR_ACO_M
                  WHERE login_id = T1.FNL_MDFC_USR_ID
                 ) USR_NM
              , T1.FNL_MDFC_USR_ID /* 유저번호 */
           FROM TB_RVDW_SL_CTR_BAS T1 /* 매출조정기본 */
           JOIN TB_SSCT_CNTR_BAS T2  /* 계약기본 */
             ON T1.CNTR_NO = T2.CNTR_NO
            AND T1.DTA_DL_YN = 'N'
            AND T2.DTA_DL_YN = 'N'
      LEFT JOIN TB_CBCL_WELLS_SL_CNFM_BAS T11
             ON T11.CNTR_NO = T1.CNTR_NO
            AND T11.CNTR_SN = T1.CNTR_SN
            AND T11.DTA_DL_YN = 'N'
           JOIN TB_SSCT_CNTR_DTL T3 /* 계약상세 */
             ON T2.CNTR_NO =  T3.CNTR_NO 
            AND T3.DTA_DL_YN = 'N'
           JOIN TB_PDBS_PD_BAS T4 /* 상품기본 */
             ON T3.BASE_PD_CD = T4.PD_CD 
           JOIN TB_CUBS_CST_BAS T5  /* 고객기본 */
             ON T2.CNTR_CST_NO = T5.CST_NO
            AND T5.DTA_DL_YN = 'N'
          WHERE 1=1
           <if test='@MybatisUtils@isNotEmpty(sellTp) and sellTp != "ALL" and sellTp != "all"'>
            AND T1.SL_CTR_SELL_TP_CD = #{sellTp}
           </if>
           <if test='@MybatisUtils@isNotEmpty(perfStrtDtm)'>
            AND T11.CNTR_STRTDT <![CDATA[>=]]> #{perfStrtDtm} /* 매출계약시작일시기준 */
           </if>
           <if test='@MybatisUtils@isNotEmpty(perfFshDtm)'>
            AND T11.CNTR_STRTDT <![CDATA[ <= ]]> #{perfFshDtm} /* 매출계약시작일시기준 */
           </if>
           
           <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
            AND T1.CNTR_NO = #{cntrNo}
           </if>
           <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
            AND T1.CNTR_SN = #{cntrSn}
           </if>
           
           <if test='@MybatisUtils@isNotEmpty(ctrTp) and ctrTp != "all" and ctrTp != "ALL"'>
            AND T1.SL_CTR_DSC_TP_CD = #{ctrTp}
           </if>
           <if test='@MybatisUtils@isNotEmpty(mtrDv) and mtrDv != "all" and mtrDv != "ALL"'>
            AND T1.SL_CTR_MTR_DV_CD = #{mtrDv}
           </if>
           <if test='@MybatisUtils@isNotEmpty(ctrDv) and ctrDv != "all" and ctrDv != "ALL"'>
            AND T1.SL_CTR_DV_CD = #{ctrDv}
           </if>
           
           <if test='@MybatisUtils@isNotEmpty(dsc) and dsc != "all" and dsc != "ALL"'>
            AND T1.SL_CTR_TP_CD = #{dsc}
           </if>
           <if test='@MybatisUtils@isNotEmpty(fstRgstUsrId)'>
            AND T1.FNL_MDFC_USR_ID = #{fstRgstUsrId}
           </if>
           <if test='@MybatisUtils@isNotEmpty(rgstStrtDtm)'>
            AND T1.SL_CTR_PRCSDT <![CDATA[>=]]> #{slCtrPrcsStrtDt}
           </if>
           <if test='@MybatisUtils@isNotEmpty(rgstFshDtm)'>
            AND T1.SL_CTR_PRCSDT <![CDATA[ <= ]]> #{slCtrPrcsFshDt}
           </if>
    </select>
    
    <select id="selectSalesControlCount" resultType="Integer">
         SELECT COUNT(1)
           FROM TB_RVDW_SL_CTR_BAS T1 /* 매출조정기본 */
          WHERE 1=1
            AND CNTR_NO = #{cntrNo}
            AND SL_CTR_STRT_YM = #{slCtrStrtYm}
            AND SL_CTR_MTR_DV_CD = #{slCtrMtrDvCd}
            AND SL_CTR_SELL_TP_CD = #{slCtrSellTpCd}
    </select>
    
    
    <insert id="insertSalesControl">
        INSERT INTO TB_RVDW_SL_CTR_BAS ( /* 매출조정기본 */
               CNTR_NO /* 계약번호 */
             , CNTR_SN /* 계약일련번호 */
             , SL_CTR_SELL_TP_CD /* 매출조정판매유형코드 */
             , SL_CTR_MTR_DV_CD /* 매출조정자료구분코드 */
             , SL_CTR_MTR_TP_CD /* 매출조정자료유형코드 */
             , SL_CTR_STRT_YM /* 매출조정시작년월 */
             , SL_CTR_END_YM /* 매출조정종료년월 */
             , SL_CTR_DV_CD /* 매출조정구분코드 */
             , SL_CTR_TP_CD /* 매출조정유형코드 */
             , SL_CTR_DSC_TP_CD /* 매출조정할인유형코드 */
             , CAN_AF_OJ_YN /* 취소이후대상여부 */
             , SL_CTR_AMT /* 매출조정금액 */
             , SL_CTR_WO_EXMP_AMT /* 매출조정전체면제금액 */
             , SL_CTR_PTRM_EXMP_AMT /* 매출조정기간면제금액 */
             , SL_CTR_RMK_CN /* 매출조정비고내용 */
             , SL_CTR_PROCS_YN /* 매출조정처리여부 */
             , SL_CTR_PRCSDT /* 매출조정처리일자 */
             , DTA_DL_YN /* 데이터삭제여부*/
        <include refid="COMMON.insertSystemField"/>
        ) VALUES (
               #{cntrNo} /* 계약번호 */
             , #{cntrSn} /* 계약일련번호 */
             , #{slCtrSellTpCd} /* 매출조정판매유형코드 */
             , #{slCtrMtrDvCd} /* 매출조정자료구분코드 */
             , #{slCtrMtrTpCd} /* 매출조정자료유형코드 */
             , #{slCtrStrtYm} /* 매출조정시작년월 */
             , #{slCtrEndYm} /* 매출조정종료년월 */
             , #{slCtrDvCd} /* 매출조정구분코드 */
             , #{slCtrTpCd} /* 매출조정유형코드 */
             , #{slCtrDscTpCd} /* 매출조정할인유형코드 */
             , #{canAfOjYn} /* 취소이후대상여부 */
             , #{slCtrAmt} /* 매출조정금액 */
             , #{slCtrWoExmpAmt} /* 매출조정전체면제금액 */
             , #{slCtrPtrmExmpAmt} /* 매출조정기간면제금액 */
             , #{slCtrRmkCn} /* 매출조정비고내용 */
             , #{slCtrProcsYn} /* 매출조정처리여부 */
             , #{slCtrPrcsdt} /* 매출조정처리일자 */
             , 'N' /* 데이터삭제여부*/
        <include refid="COMMON.insertSystemFieldValue" />
        )
    </insert>
    
    
    <insert id="insertSalesControlHistory">
        INSERT INTO TB_RVDW_SL_CTR_BAS_HIST ( /* 매출조정이력기본 */
               CNTR_NO /* 계약번호 */
             , CNTR_SN /* 계약일련번호 */
             , SL_CTR_SELL_TP_CD /* 매출조정판매유형코드 */
             , SL_CTR_MTR_DV_CD /* 매출조정자료구분코드 */
             , SL_CTR_MTR_TP_CD /* 매출조정자료유형코드 */
             , SL_CTR_STRT_YM /* 매출조정시작년월 */
             , SL_CTR_CH_SN /* 매출조정변경일련번호 : default 1 */
             , SL_CTR_END_YM /* 매출조정종료년월 */
             , SL_CTR_DV_CD /* 매출조정구분코드 */
             , SL_CTR_TP_CD /* 매출조정유형코드 */
             , SL_CTR_DSC_TP_CD /* 매출조정할인유형코드 */
             , CAN_AF_OJ_YN /* 취소이후대상여부 */
             , SL_CTR_AMT /* 매출조정금액 */
             , SL_CTR_WO_EXMP_AMT /* 매출조정전체면제금액 */
             , SL_CTR_PTRM_EXMP_AMT /* 매출조정기간면제금액 */
             , SL_CTR_RMK_CN /* 매출조정비고내용 */
             , SL_CTR_PROCS_YN /* 매출조정처리여부 */
             , SL_CTR_PRCSDT /* 매출조정처리일자 */
             , DTA_DL_YN /* 데이터삭제여부*/
        <include refid="COMMON.insertSystemField"/>
        ) VALUES (
               #{cntrNo} /* 계약번호 */
             , #{cntrSn} /* 계약일련번호 */
             , #{slCtrSellTpCd} /* 매출조정판매유형코드 */
             , #{slCtrMtrDvCd} /* 매출조정자료구분코드 */
             , #{slCtrMtrTpCd} /* 매출조정자료유형코드 */
             , #{slCtrStrtYm} /* 매출조정시작년월 */
             , 1
             , #{slCtrEndYm} /* 매출조정종료년월 */
             , #{slCtrDvCd} /* 매출조정구분코드 */
             , #{slCtrTpCd} /* 매출조정유형코드 */
             , #{slCtrDscTpCd} /* 매출조정할인유형코드 */
             , #{canAfOjYn} /* 취소이후대상여부 */
             , #{slCtrAmt} /* 매출조정금액 */
             , #{slCtrWoExmpAmt} /* 매출조정전체면제금액 */
             , #{slCtrPtrmExmpAmt} /* 매출조정기간면제금액 */
             , #{slCtrRmkCn} /* 매출조정비고내용 */
             , #{slCtrProcsYn} /* 매출조정처리여부 */
             , #{slCtrPrcsdt} /* 매출조정처리일자 */
             , 'N' /* 데이터삭제여부*/
        <include refid="COMMON.insertSystemFieldValue" />
        )
    </insert>
    
    
    <update id="updateSalesControl">
        UPDATE TB_RVDW_SL_CTR_BAS  /* 매출조정T */
           SET SL_CTR_MTR_DV_CD = #{slCtrMtrDvCd} /* 매출조정자료구분코드 */
             , SL_CTR_SELL_TP_CD = #{slCtrSellTpCd} /* 매출조정판매유형코드 */
             , SL_CTR_DV_CD = #{slCtrDvCd} /* 매출조정구분코드 */
             , SL_CTR_TP_CD = #{slCtrTpCd} /* 매출조정유형코드 */
             , SL_CTR_DSC_TP_CD = #{slCtrDscTpCd} /* 매출조정할인유형코드 */
             , CAN_AF_OJ_YN = #{canAfOjYn} /* 취소이후대상여부 */
             , SL_CTR_RMK_CN = #{slCtrRmkCn} /* 매출조정비고내용 */
            <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND DTA_DL_YN = 'N' 
    </update>
    
    <update id="updateSalesControlHistory">
        UPDATE TB_RVDW_SL_CTR_BAS_HIST  /* 매출조정이력T */
           SET SL_CTR_MTR_DV_CD = #{slCtrMtrDvCd} /* 매출조정자료구분코드 */
             , SL_CTR_SELL_TP_CD = #{slCtrSellTpCd} /* 매출조정판매유형코드 */
             , SL_CTR_DV_CD = #{slCtrDvCd} /* 매출조정구분코드 */
             , SL_CTR_TP_CD = #{slCtrTpCd} /* 매출조정유형코드 */
             , SL_CTR_DSC_TP_CD = #{slCtrDscTpCd} /* 매출조정할인유형코드 */
             , CAN_AF_OJ_YN = #{canAfOjYn} /* 취소이후대상여부 */
             , SL_CTR_RMK_CN = #{slCtrRmkCn} /* 매출조정비고내용 */
            <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND DTA_DL_YN = 'N' 
    </update>
    
    
    <update id="updateSalesConfirm"> 
        UPDATE TB_CBCL_WELLS_SL_CNFM_BAS /* 매출확정T */
           SET SL_CTR_AMT = #{slCtrAmt} /* 매출조정금액 */
          <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND DTA_DL_YN = 'N'
    </update>
    
    
    <update id="deleteSalesControl">
        UPDATE TB_RVDW_SL_CTR_BAS /* 매출조정 */
           SET DTA_DL_YN = 'Y'
          <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND SL_CTR_SELL_TP_CD = #{slCtrSellTpCd}
           AND SL_CTR_MTR_DV_CD = #{slCtrMtrDvCd}
           AND SL_CTR_MTR_TP_CD = #{slCtrMtrTpCd}
           AND SL_CTR_STRT_YM = #{slCtrStrtYm}
    </update>
</mapper>
