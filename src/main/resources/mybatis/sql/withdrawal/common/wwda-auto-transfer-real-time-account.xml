<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.withdrawal.common.mapper.WwdaAutoTransferRealTimeAccountMapper">
    
    <select id="selectBankCode" resultType="string">
            SELECT FNIT_CD
              FROM TB_RVDW_FNIT_CD
             WHERE DTA_DL_YN ='N'
               AND FNIT_CD = #{bnkCd}
               AND FNIT_DV_CD = '1' /*은행*/ 
               AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN VL_STRTDT AND  VL_ENDDT
    </select>
    
    <select id="selectEntrepreneurNo" resultType="string">
            SELECT BZRNO
            FROM TB_CUBS_CST_BAS
           WHERE DTA_DL_YN = 'N'
             AND BZRNO = #{copnDvDrmVal}
    </select>
    
    <select id="selectAcFntRtmAkAprAskSerialMax" resultType="string">
            SELECT NVL(MAX(TO_NUMBER(AK_SN)), 0) + 1 AS AK_SN 
              FROM TB_RVCL_AC_FNT_RTM_AK_APR_IZ /* 계좌이체실시간요청승인내역 */
             WHERE RQDT = TO_CHAR(SYSDATE, 'YYYYMMDD')
    </select>
    
    <insert id="insertExtxMaterialIz"  >
            INSERT INTO TB_RVCL_AC_FNT_RTM_AK_APR_IZ (  /* 계좌이체실시간요청승인내역 */
                  RQDT                /* 요청일자 */
                , AK_SN               /* 요청일련번호 */
                , COPN_DV_CD          /* 법인격구분코드 */
                , COPN_DV_DRM_VAL     /* 법인격구분식별값 */
                , AC_FNT_APR_AK_DV_CD /* 계좌이체승인요청구분코드 */
                , BNK_CD              /* 은행코드 */
                , ACNO_ENCR           /* 계좌번호암호화 */
                , TRS_DTM             /* 전송일시 */
                , DTA_DL_YN           /* 데이터삭제여부 */
                <include refid="COMMON.insertSystemField" />)
            VALUES (
                  TO_CHAR(SYSDATE, 'YYYYMMDD') /* 요청일자 */
                , #{akSn}
                , #{copnDvCd}
                , #{copnDvDrmVal}
                , '0' /* 계좌이체승인요청구분코드 */
                , #{bnkCd}
                , #{acnoEncr}
                , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') /* 전송일시 */
                , 'N'
                <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>
    
    <insert id="insertExtxMaterialHis">
            INSERT INTO TB_RVCL_AC_FNT_RTM_AK_APR_HIST (  /* 계좌이체실시간요청승인이력 */
                  RQDT                /* 요청일자 */
                , AK_SN               /* 요청일련번호 */
                , HIST_CH_DTM         /* 이력변경일시 */
                , COPN_DV_CD          /* 법인격구분코드 */
                , COPN_DV_DRM_VAL     /* 법인격구분식별값 */
                , AC_FNT_APR_AK_DV_CD /* 계좌이체승인요청구분코드 */
                , BNK_CD              /* 은행코드 */
                , ACNO_ENCR           /* 계좌번호암호화 */
                , TRS_DTM             /* 전송일시 */
                , DTA_DL_YN           /* 데이터삭제여부 */
                <include refid="COMMON.insertSystemField" />)
            VALUES (
                  TO_CHAR(SYSDATE, 'YYYYMMDD') /* 요청일자 */
                , #{akSn}
                , TO_CHAR(SYSDATE, 'YYYYMMDD') /* 이력변경일시 */
                , #{copnDvCd}
                , #{copnDvDrmVal}
                , '0' /* 계좌이체승인요청구분코드 */
                , #{bnkCd}
                , #{acnoEncr}
                , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') /* 전송일시 */
                , 'N'
                <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>
    
    <select id="selectReceiveResultCheck" resultType="com.kyowon.sms.wells.web.withdrawal.common.dvo.WwdaAutoTransferRealTimeAccountCheckDvo">
            SELECT AC_FNT_RS_CD /*계좌이체결과코드*/
                 , ACHLDR_NM /*예금주명*/
              FROM TB_RVCL_AC_FNT_RTM_AK_APR_IZ /*계좌이체실시간요청승인내역*/
             WHERE DTA_DL_YN ='N'
               AND RQDT = #{rqdt}
               AND AK_SN = #{akSn}
    </select>
    
    <insert id="insertResultConfirmationProcessingHis">
            INSERT INTO TB_RVCL_AC_FNT_RTM_AK_APR_HIST (
                  RQDT                /* 요청일자 */
                , AK_SN               /* 요청일련번호 */
                , HIST_CH_DTM         /* 이력변경일시 */
                , PYER_NO             /* 납부자번호 */
                , COPN_DV_CD          /* 법인격구분코드 */
                , COPN_DV_DRM_VAL     /* 법인격구분식별값 */
                , AC_FNT_APR_AK_DV_CD /* 계좌이체승인요청구분코드 */
                , AC_FNT_MTR_DV_CD    /* 계좌이체자료구분코드 */
                , FNT_EVID_BIZ_DV_CD  /* 이체증빙업무구분코드 */
                , BNK_CD              /* 은행코드 */
                , ACNO_ENCR           /* 계좌번호암호화 */
                , ACHLDR_NM           /* 예금주명 */
                , FNT_STPL_D          /* 이체약정일 */
                , EVIKY_VAL           /* 증빙키값 */
                , TRS_DTM             /* 전송일시 */
                , RCV_DTM             /* 수신일시 */
                , AC_FNT_RS_CD        /* 계좌이체결과코드 */
                , CNTR_NO             /* 계약번호 */
                , CNTR_SN             /* 계약일련번호 */
                , DTA_DL_YN           /* 데이터삭제여부 */
                <include refid="COMMON.insertSystemField" />
                ) 
               SELECT RQDT                /* 요청일자 */
                    , AK_SN               /* 요청일련번호 */
                    , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                    , PYER_NO             /* 납부자번호 */
                    , COPN_DV_CD          /* 법인격구분코드 */
                    , COPN_DV_DRM_VAL     /* 법인격구분식별값 */
                    , AC_FNT_APR_AK_DV_CD /* 계좌이체승인요청구분코드 */
                    , AC_FNT_MTR_DV_CD    /* 계좌이체자료구분코드 */
                    , FNT_EVID_BIZ_DV_CD  /* 이체증빙업무구분코드 */
                    , BNK_CD              /* 은행코드 */
                    , ACNO_ENCR           /* 계좌번호암호화 */
                    , ACHLDR_NM           /* 예금주명 */
                    , FNT_STPL_D          /* 이체약정일 */
                    , EVIKY_VAL           /* 증빙키값 */
                    , TRS_DTM             /* 전송일시 */
                    , RCV_DTM             /* 수신일시 */
                    , 'Z902'              /* 계좌이체결과코드 */
                    , CNTR_NO             /* 계약번호 */
                    , CNTR_SN             /* 계약일련번호 */
                    , DTA_DL_YN           /* 데이터삭제여부 */
                    <include refid="COMMON.insertSystemFieldValue" /> 
                FROM TB_RVCL_AC_FNT_RTM_AK_APR_IZ
               WHERE DTA_DL_YN = 'N'
                 AND RQDT = #{rqdt}
                 AND AK_SN = #{akSn}
    </insert>
    
    <update id="updateResultConfirmationProcessingIz">
            UPDATE TB_RVCL_AC_FNT_RTM_AK_APR_IZ
               SET AC_FNT_RS_CD = 'Z902'
                 <include refid="COMMON.updateSystemField"/> 
             WHERE DTA_DL_YN = 'N'
               AND RQDT = #{rqdt}
               AND AK_SN = #{akSn}
    </update>
    
    <select id="selectAcFntImpsCdNmCheck" resultType="String">
        SELECT AFTN_RS_NM
          FROM TB_RVDW_AFTN_RS_CD
         WHERE DTA_DL_YN ='N'
           AND AFTN_RS_DV_CD = '2'
           AND AFTN_RS_CD = #{acFntImpsCd}
    </select>
    
    <select id="selectRealTimeAnAccountChange" resultType="com.kyowon.sms.wells.web.withdrawal.common.dvo.WwdaRealTimeAnAccountChangeResultDvo">
             SELECT RFC.FNIT_CD
                  , RAFR.AK_SN
                  , RAFR.ACNO_ENCR
                  , RAFR.BNK_CD 
               FROM TB_RVCL_AC_FNT_RTM_AK_APR_IZ RAFR
               JOIN TB_RVDW_FNIT_CD RFC
                 ON RAFR.BNK_CD = RFC.FNIT_CD 
                AND RAFR.DTA_DL_YN = 'N'
                AND RFC.DTA_DL_YN = 'N'
               JOIN TB_RVCL_AFTN_BNK_ETXT_INF_BAS RABB
                 ON RAFR.BNK_CD = RABB.BNK_CD 
                AND RABB.DTA_DL_YN = 'N'
              WHERE RFC.FNIT_DV_CD = '1'
                AND RABB.RVE_CO_CD = CASE WHEN #{sysDvCd} = 'W' THEN '20' ELSE 'J0' END
                AND LPAD(RABB.VNCO_DV_CD, 3, 0) = '002'
                AND RAFR.RQDT = #{rqdt}
                AND RAFR.AK_SN = #{akSn}
    </select>
    
    <update id="updateAcEftnAcFntRtmAkAprIz">
            UPDATE TB_RVCL_AC_FNT_RTM_AK_APR_IZ
               SET RCV_DTM = TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS')
                 , AC_FNT_RS_CD = #{rplyCd}
                 , ACHLDR_NM = #{depsPrsnNm}
                 <include refid="COMMON.updateSystemField"/> 
             WHERE DTA_DL_YN = 'N'
               AND RQDT = #{rqdt}
               AND AK_SN = #{userDealNo}
    </update>
    
    <insert id="insertAcEftnAcFntRtmAkAprHist">
            INSERT INTO TB_RVCL_AC_FNT_RTM_AK_APR_HIST (
                  RQDT                /* 요청일자 */
                , AK_SN               /* 요청일련번호 */
                , HIST_CH_DTM         /* 이력변경일시 */
                , PYER_NO             /* 납부자번호 */
                , COPN_DV_CD          /* 법인격구분코드 */
                , COPN_DV_DRM_VAL     /* 법인격구분식별값 */
                , AC_FNT_APR_AK_DV_CD /* 계좌이체승인요청구분코드 */
                , AC_FNT_MTR_DV_CD    /* 계좌이체자료구분코드 */
                , FNT_EVID_BIZ_DV_CD  /* 이체증빙업무구분코드 */
                , BNK_CD              /* 은행코드 */
                , ACNO_ENCR           /* 계좌번호암호화 */
                , ACHLDR_NM           /* 예금주명 */
                , FNT_STPL_D          /* 이체약정일 */
                , EVIKY_VAL           /* 증빙키값 */
                , TRS_DTM             /* 전송일시 */
                , RCV_DTM             /* 수신일시 */
                , AC_FNT_RS_CD        /* 계좌이체결과코드 */
                , CNTR_NO             /* 계약번호 */
                , CNTR_SN             /* 계약일련번호 */
                , DTA_DL_YN           /* 데이터삭제여부 */
                <include refid="COMMON.insertSystemField" />
                ) 
                SELECT RQDT                /* 요청일자 */
                        , AK_SN               /* 요청일련번호 */
                        , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                        , PYER_NO             /* 납부자번호 */
                        , COPN_DV_CD          /* 법인격구분코드 */
                        , COPN_DV_DRM_VAL     /* 법인격구분식별값 */
                        , AC_FNT_APR_AK_DV_CD /* 계좌이체승인요청구분코드 */
                        , AC_FNT_MTR_DV_CD    /* 계좌이체자료구분코드 */
                        , FNT_EVID_BIZ_DV_CD  /* 이체증빙업무구분코드 */
                        , BNK_CD              /* 은행코드 */
                        , ACNO_ENCR           /* 계좌번호암호화 */
                        , ACHLDR_NM           /* 예금주명 */
                        , FNT_STPL_D          /* 이체약정일 */
                        , EVIKY_VAL           /* 증빙키값 */
                        , TRS_DTM             /* 전송일시 */
                        , RCV_DTM             /* 수신일시 */
                        , AC_FNT_RS_CD        /* 계좌이체결과코드 */
                        , CNTR_NO             /* 계약번호 */
                        , CNTR_SN             /* 계약일련번호 */
                        , DTA_DL_YN           /* 데이터삭제여부 */
                        <include refid="COMMON.insertSystemFieldValue" /> 
                    FROM TB_RVCL_AC_FNT_RTM_AK_APR_IZ
                   WHERE DTA_DL_YN = 'N'
                     AND RQDT = #{rqdt}
                     AND AK_SN = #{userDealNo}
    </insert>
</mapper>