<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.closing.sales.mapper.WdcbLossRentFeeClearingMapper">
    <select id="selectLossRentFee" resultType="int">
        -- WELLS위약금액기본 Table의 분실손료 존재여부 확인
        SELECT LS_RNTF /*분실손료*/
          FROM TB_CBCL_WELLS_BOR_AMT_BAS /*WELLS위약금액기본*/
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND PERF_YM = TO_CHAR(SYSDATE, 'YYYYMM')
    </select>

    <insert id="insertLossRentFee">
        -- WELLS위약금액기본이력 Table 생성
        INSERT INTO TB_CBCL_WELLS_BOR_AMT_BAS_HIST /*WELLS위약금액기본이력*/
        (
             PERF_YM
			,CNTR_NO
			,CNTR_SN
			,BOR_AMT_SN
			,CCAM_CMPT_RQDT
			,CCAM_CMPT_CLTN_DT
			,RES_RTLFE_BOR_AMT
			,RGST_COST_DSC_BOR_AMT
			,RENTAL_DSC_BOR_AMT
			,CSMB_COST_BOR_AMT
			,RSTL_BOR_AMT
			,P_BOR_AMT
			,REQD_CS_BOR_AMT
			,LS_RNTF
			,BOR_AMT
			,REQD_DT
			,KW_GRP_CO_CD
			,RVE_NO
			,RVE_SN
			,DP_DV_CD
			,DP_MES_CD
			,DP_TP_CD
			,RVE_DV_CD
			,RVE_CD
			,RVE_DT
			,PERF_DT
			,RVE_AMT
			,BTD_BOR_AMT
			,OC_BOR_AMT
			,DP_CCAM_SUM_AMT
			,RFND_CCAM_SUM_AMT
			,CTR_CCAM_SUM_AMT
			,OVR_CTR_BOR_AMT
			,SPMT_CCAM_SUM_AMT
			,EOT_BOR_AMT
			,DTA_DL_YN
        <include refid="COMMON.insertSystemField"/>
        )
        SELECT PERF_YM
                ,CNTR_NO
                ,CNTR_SN
                ,BOR_AMT_SN + 1 AS BOR_AMT_SN
                ,CCAM_CMPT_RQDT
                ,CCAM_CMPT_CLTN_DT
                ,RES_RTLFE_BOR_AMT
                ,RGST_COST_DSC_BOR_AMT
                ,RENTAL_DSC_BOR_AMT
                ,CSMB_COST_BOR_AMT
                ,RSTL_BOR_AMT
                ,P_BOR_AMT
                ,REQD_CS_BOR_AMT
                , 0 AS LS_RNTF/*분실손료*/
                , BOR_AMT/*위약금액*/
                , #{reqdDt} AS REQD_DT/*철거일자*/
                , KW_GRP_CO_CD
                ,RVE_NO
                ,RVE_SN
                ,DP_DV_CD
                ,DP_MES_CD
                ,DP_TP_CD
                ,RVE_DV_CD
                ,RVE_CD
                ,RVE_DT
                ,PERF_DT
                ,RVE_AMT
                ,BTD_BOR_AMT
                ,OC_BOR_AMT
                ,DP_CCAM_SUM_AMT
                ,RFND_CCAM_SUM_AMT
                ,CTR_CCAM_SUM_AMT
                ,OVR_CTR_BOR_AMT
                ,SPMT_CCAM_SUM_AMT
                ,EOT_BOR_AMT
                ,DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_CBCL_WELLS_BOR_AMT_BAS_HIST /*WELLS위약금액기본이력*/
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND BOR_AMT_SN = (SELECT MAX(BOR_AMT_SN)
                               FROM TB_CBCL_WELLS_BOR_AMT_BAS_HIST /*WELLS위약금액기본이력*/
                              WHERE CNTR_NO = #{cntrNo}
                                AND CNTR_SN = #{cntrSn})
    </insert>

    <update id="updateLossRentFee">
        -- WELLS위약금액기본 Table 수정
        UPDATE TB_CBCL_WELLS_BOR_AMT_BAS                           /*WELLS위약금액기본*/
           SET LS_RNTF = 0                                         /*분실손료*/
             , EOT_BOR_AMT = EOT_BOR_AMT - LS_RNTF               /*위약금잔여금액    */
             <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </update>

</mapper>
