<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.closing.sales.mapper.WdcbProductSalesDetailMapper">

    <select id="selectProductSalesSinglePaymentDetails" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbProductSalesDetailDto$SearchSingleRes">
        SELECT B4.CD_CNTN AS SELL_TP_CD                        /* 판매유형명 */
             , B5.CD_CNTN AS SELL_TP_DTL_CD                    /* 판매유형상세명 */
             , B1.PD_CD                                        /* 상품코드 */
             , B2.PD_NM                                        /* 상품명 */
             , B6.CD_CNTN AS SELL_INFLW_CHNL_DTL_CD            /* 판매유입채널상세명 */
             , B1.SL_RCOG_DT                                   /* 매출인식일자 */
             , B1.CNTR_NO || '-' || B1.CNTR_SN AS CNTR_DTL_NO  /* 계약상세번호 */
             , B1.CNTR_NO                                      /* 계약번호 */
             , B1.CNTR_SN                                      /* 계약일련번호 */
             , B3.CST_KNM                                      /* 고객명 */
             , B7.SAP_PD_DV_NM AS SAP_PD_DV_CD                 /* SAP상품구분코드명 */
             , B1.SELL_QTY                                     /* 판매수량-정상매출 */
             , B1.SELL_AMT                                     /* 매출금액-정상매출 */
             , B1.SELL_AMT - B1.SELL_AMT_VAT AS SELL_SPL_AMT   /* 공급가액-정상매출 */
             , B1.SELL_AMT_VAT                                 /* 부가세-정상매출 */
             , 0 AS PVDA_AMT                                   /* 현할차-정상매출 */
             , B1.CH_QTY                                       /* 판매수량-매출변경 */
             , B1.SL_CH_AMT                                    /* 매출금액-매출변경 */
             , B1.SL_CH_AMT - B1.CH_VAT AS CH_SPL_AMT          /* 공급가액-매출변경 */
             , B1.CH_VAT                                       /* 부가세-매출변경 */
             , 0 AS CH_PVDA_AMT                                /* 현할차-매출변경 */
             , B1.CAN_QTY                                      /* 판매수량-매출취소 */
             , B1.SL_CAN_AMT                                   /* 매출금액-매출취소 */
             , B1.SL_CAN_AMT - B1.CAN_VAT AS CAN_SPL_AMT       /* 공급가액-매출취소 */
             , B1.CAN_VAT                                      /* 부가세-매출취소 */
             , 0 AS CAN_PVDA_AMT                               /* 현할차-매출취소 */
             , B1.TOT_QTY                                      /* 판매수량-매출합계 */
             , B1.TOT_AMT                                      /* 매출금액-매출합계 */
             , B1.TOT_AMT - B1.TOT_VAT AS TOT_SPL_AMT          /* 공급가액-매출합계 */
             , B1.TOT_VAT                                      /* 부가세-매출합계 */
             , 0 AS TOT_PVDA_AMT                               /* 현할차-매출합계 */
          FROM (SELECT A1.CNTR_NO
                     , A1.CNTR_SN
                     , A1.CST_NO
                     , A1.PD_CD
                     , A1.SELL_TP_CD
                     , A1.SELL_TP_DTL_CD
                     , A1.SELL_INFLW_CHNL_DTL_CD
                     , A1.SL_RCOG_DT
                     , A1.SAP_PD_DV_CD
                     , NVL(SUM(A1.SL_QTY), 0) AS SELL_QTY
                     , NVL(SUM(A1.THM_SL_SUM_AMT), 0) - NVL(SUM(A1.SL_CH_AMT), 0) + NVL(SUM(A1.SL_CTR_AMT), 0) + NVL(SUM(A1.SL_CAN_AMT), 0) AS SELL_AMT
                     , NVL(SUM(A1.SL_SUM_VAT), 0) - NVL(SUM(A1.SL_CH_AMT), 0) + NVL(SUM(A1.CAN_VAT), 0) AS SELL_AMT_VAT
                     , NVL(SUM(A1.CH_QTY), 0) AS CH_QTY
                     , NVL(SUM(A1.SL_CH_AMT) ,0) - NVL(SUM(A1.SL_CTR_AMT), 0) AS SL_CH_AMT
                     , NVL(SUM(A1.CH_VAT), 0) AS CH_VAT
                     , NVL(SUM(A1.CAN_QTY), 0) AS CAN_QTY
                     , NVL(SUM(A1.SL_CAN_AMT), 0) AS SL_CAN_AMT
                     , NVL(SUM(A1.CAN_VAT), 0) AS CAN_VAT
                     , NVL(SUM(A1.SL_QTY), 0) + NVL(SUM(A1.CH_QTY), 0) - NVL(SUM(A1.CAN_QTY), 0) AS TOT_QTY
                     , NVL(SUM(A1.THM_SL_SUM_AMT), 0) AS TOT_AMT
                     , NVL(SUM(A1.SL_SUM_VAT), 0) AS TOT_VAT
                  FROM TB_CBCL_WELLS_SL_MM_CL_IZ A1  /* WELLS매출월마감내역 */
                 WHERE A1.SL_RCOG_DT BETWEEN #{baseDtmnFrom} AND #{baseDtmnTo}
                   AND A1.SL_RCOG_DT LIKE A1.SL_CL_YM || '%'
                   AND A1.SELL_TP_CD = '1'
                   <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                   AND A1.SELL_TP_DTL_CD = #{sellTpDtlCd}
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(sellChnlDtl) and !@MybatisUtils@equals(sellChnlDtl, 'ALL')">
                   AND A1.SELL_INFLW_CHNL_DTL_CD = #{sellChnlDtl}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                   AND A1.CNTR_NO = #{cntrNo}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                   AND A1.CNTR_SN = #{cntrSn}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cstNo)'>
                   AND A1.CST_NO = #{cstNo}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(sapPdDvCd)'>
                   AND A1.SAP_PD_DV_CD = #{sapPdDvCd}
                   </if>
                 GROUP BY A1.CNTR_NO
                        , A1.CNTR_SN
                        , A1.CST_NO
                        , A1.PD_CD
                        , A1.SELL_TP_CD
                        , A1.SELL_TP_DTL_CD
                        , A1.SELL_INFLW_CHNL_DTL_CD
                        , A1.SL_RCOG_DT
                        , A1.SAP_PD_DV_CD
                ) B1
          LEFT OUTER JOIN TB_PDBS_PD_BAS B2  /* 상품기본 */
            ON B2.PD_CD = B1.PD_CD
           AND B2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS B3  /* 고객기본 */
            ON B3.CST_NO = B1.CST_NO
           AND B3.NUSD_RSON_CD IS NULL
           AND B3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN T_CMZ_CD_D B4  /* 코드상세 */
            ON B4.TENANT_ID = #{session.tenantId}
           AND B4.CD_ID = 'SELL_TP_CD'
           AND B4.CD_VLD_VAL = B1.SELL_TP_CD
          LEFT OUTER JOIN T_CMZ_CD_D B5  /* 코드상세 */
            ON B5.TENANT_ID = #{session.tenantId}
           AND B5.CD_ID = 'SELL_TP_DTL_CD'
           AND B5.CD_VLD_VAL = B1.SELL_TP_DTL_CD
          LEFT OUTER JOIN T_CMZ_CD_D B6  /* 코드상세 */
            ON B6.TENANT_ID = #{session.tenantId}
           AND B6.CD_ID = 'SELL_CHNL_DTL_CD'
           AND B6.CD_VLD_VAL = B1.SELL_INFLW_CHNL_DTL_CD
          LEFT OUTER JOIN TB_CBCL_SAP_PD_DV_CD B7  /* SAP상품구분코드 */
            ON B7.SAP_PD_DV_CD = B1.SAP_PD_DV_CD
           AND B7.SAP_PD_ATC_CD = '00'
           AND B7.SAP_PD_ATC_SN = 1
           AND B7.SAP_BZ_TERY_CD = '1210'
         ORDER BY B1.SL_RCOG_DT
                , B1.CNTR_NO
                , B1.CNTR_SN
    </select>

    <select id="selectProductSalesRegularDeliveryDetails" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbProductSalesDetailDto$SearchSingleRes">
        SELECT B4.CD_CNTN AS SELL_TP_CD                        /* 판매유형명 */
             , B5.CD_CNTN AS SELL_TP_DTL_CD                    /* 판매유형상세명 */
             , B1.PD_CD                                        /* 상품코드 */
             , B2.PD_NM                                        /* 상품명 */
             , B6.CD_CNTN AS SELL_INFLW_CHNL_DTL_CD            /* 판매유입채널상세명 */
             , B1.SL_RCOG_DT                                   /* 매출인식일자 */
             , B1.CNTR_NO || '-' || B1.CNTR_SN AS CNTR_DTL_NO  /* 계약상세번호 */
             , B1.CNTR_NO                                      /* 계약번호 */
             , B1.CNTR_SN                                      /* 계약일련번호 */
             , B3.CST_KNM                                      /* 고객명 */
             , B7.SAP_PD_DV_NM AS SAP_PD_DV_CD                 /* SAP상품구분코드명 */
             , B1.SELL_QTY                                     /* 판매수량-정상매출 */
             , B1.SELL_AMT                                     /* 매출금액-정상매출 */
             , B1.SELL_AMT - B1.SELL_AMT_VAT AS SELL_SPL_AMT   /* 공급가액-정상매출 */
             , B1.SELL_AMT_VAT                                 /* 부가세-정상매출 */
             , 0 AS PVDA_AMT                                   /* 현할차-정상매출 */
             , B1.CH_QTY                                       /* 판매수량-매출변경 */
             , B1.SL_CH_AMT                                    /* 매출금액-매출변경 */
             , B1.SL_CH_AMT - B1.CH_VAT AS CH_SPL_AMT          /* 공급가액-매출변경 */
             , B1.CH_VAT                                       /* 부가세-매출변경 */
             , 0 AS CH_PVDA_AMT                                /* 현할차-매출변경 */
             , B1.CAN_QTY                                      /* 판매수량-매출취소 */
             , B1.SL_CAN_AMT                                   /* 매출금액-매출취소 */
             , B1.SL_CAN_AMT - B1.CAN_VAT AS CAN_SPL_AMT       /* 공급가액-매출취소 */
             , B1.CAN_VAT                                      /* 부가세-매출취소 */
             , 0 AS CAN_PVDA_AMT                               /* 현할차-매출취소 */
             , B1.TOT_QTY                                      /* 판매수량-매출합계 */
             , B1.TOT_AMT                                      /* 매출금액-매출합계 */
             , B1.TOT_AMT - B1.TOT_VAT AS TOT_SPL_AMT          /* 공급가액-매출합계 */
             , B1.TOT_VAT                                      /* 부가세-매출합계 */
             , 0 AS TOT_PVDA_AMT                               /* 현할차-매출합계 */
          FROM (SELECT A1.CNTR_NO
                     , A1.CNTR_SN
                     , A1.CST_NO
                     , A1.PD_CD
                     , A1.SELL_TP_CD
                     , A1.SELL_TP_DTL_CD
                     , A1.SELL_INFLW_CHNL_DTL_CD
                     , A1.SL_RCOG_DT
                     , A1.SAP_PD_DV_CD
                     , NVL(SUM(CASE WHEN A1.NOM_SL_AMT != 0 THEN A1.SL_QTY END), 0) AS SELL_QTY
                     , NVL(SUM(A1.THM_SL_SUM_AMT), 0) + NVL(SUM(A1.SL_CTR_AMT), 0) + NVL(SUM(A1.SL_CAN_AMT), 0) AS SELL_AMT
                     , NVL(SUM(CASE WHEN A1.NOM_SL_AMT != 0 THEN A1.SL_SUM_VAT END), 0) + NVL(SUM(A1.CAN_VAT), 0) AS SELL_AMT_VAT
                     , NVL(SUM(CASE WHEN NVL(A1.NOM_SL_AMT, 0) = 0 AND NVL(A1.SL_CAN_AMT, 0) = 0 AND A1.THM_SL_SUM_AMT != 0
                                    THEN A1.SL_QTY
                                    WHEN NVL(A1.NOM_SL_AMT, 0) = 0 AND A1.CAN_DT IS NOT NULL AND NVL(A1.CAN_QTY, 0) = 0
                                    THEN A1.SL_QTY END) ,0) AS CH_QTY
                     , -1 * NVL(SUM(A1.SL_CTR_AMT), 0) AS SL_CH_AMT
                     , NVL(SUM(CASE WHEN A1.NOM_SL_AMT = 0 AND A1.SL_CTR_AMT != 0
                                    THEN A1.SL_SUM_VAT END), 0) + NVL(SUM(A1.CAN_VAT), 0) AS CH_VAT
                     , NVL(SUM(CASE WHEN A1.NOM_SL_AMT = 0 AND A1.SL_CTR_AMT != 0
                                    THEN A1.PVDA_AMT END), 0) AS CH_PVDA_AMT
                     , NVL(SUM(A1.CAN_QTY), 0) AS CAN_QTY
                     , NVL(SUM(A1.SL_CAN_AMT), 0) AS SL_CAN_AMT
                     , NVL(SUM(A1.CAN_VAT), 0) AS CAN_VAT
                     , NVL(SUM(A1.SL_QTY), 0) - NVL(SUM(A1.CAN_QTY), 0) AS TOT_QTY
                     , NVL(SUM(A1.THM_SL_SUM_AMT), 0) + NVL(SUM(A1.PVDA_AMT), 0) AS TOT_AMT
                     , NVL(SUM(A1.SL_SUM_VAT), 0) AS TOT_VAT
                  FROM TB_CBCL_WELLS_SL_MM_CL_IZ A1  /* WELLS매출월마감내역 */
                 WHERE A1.SL_RCOG_DT BETWEEN #{baseDtmnFrom} AND #{baseDtmnTo}
                   AND A1.SL_RCOG_DT LIKE A1.SL_CL_YM || '%'
                   AND A1.SELL_TP_CD = '6'
                   <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                   AND A1.SELL_TP_DTL_CD = #{sellTpDtlCd}
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(sellChnlDtl) and !@MybatisUtils@equals(sellChnlDtl, 'ALL')">
                   AND A1.SELL_INFLW_CHNL_DTL_CD = #{sellChnlDtl}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                   AND A1.CNTR_NO = #{cntrNo}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                   AND A1.CNTR_SN = #{cntrSn}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cstNo)'>
                   AND A1.CST_NO = #{cstNo}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(sapPdDvCd)'>
                   AND A1.SAP_PD_DV_CD = #{sapPdDvCd}
                   </if>
                 GROUP BY A1.CNTR_NO
                        , A1.CNTR_SN
                        , A1.CST_NO
                        , A1.PD_CD
                        , A1.SELL_TP_CD
                        , A1.SELL_TP_DTL_CD
                        , A1.SELL_INFLW_CHNL_DTL_CD
                        , A1.SL_RCOG_DT
                        , A1.SAP_PD_DV_CD
                 UNION ALL
                SELECT A2.CNTR_NO
                     , A2.CNTR_SN
                     , A2.CST_NO
                     , A2.PD_CD
                     , A2.SELL_TP_CD
                     , A2.SELL_TP_DTL_CD
                     , A2.SELL_INFLW_CHNL_DTL_CD
                     , A2.SL_RCOG_DT
                     , A2.SAP_PD_DV_CD
                     , NVL(SUM(CASE WHEN A2.NOM_SL_AMT != 0 THEN A2.SL_QTY END), 0) AS SELL_QTY
                     , NVL(SUM(A2.THM_SL_SUM_AMT), 0) + NVL(SUM(A2.SL_CTR_AMT), 0) + NVL(SUM(A2.SL_CAN_AMT), 0) AS SELL_AMT
                     , NVL(SUM(CASE WHEN A2.NOM_SL_AMT != 0 THEN A2.SL_SUM_VAT END), 0) + NVL(SUM(A2.CAN_VAT), 0) AS SELL_AMT_VAT
                     , NVL(SUM(CASE WHEN NVL(A2.NOM_SL_AMT, 0) = 0 AND NVL(A2.SL_CAN_AMT, 0) = 0 AND A2.THM_SL_SUM_AMT != 0
                                    THEN A2.SL_QTY
                                    WHEN NVL(A2.NOM_SL_AMT, 0) = 0 AND A2.CAN_DT IS NOT NULL AND NVL(A2.CAN_QTY, 0) = 0
                                    THEN A2.SL_QTY END) ,0) AS CH_QTY
                     , -1 * NVL(SUM(A2.SL_CTR_AMT), 0) AS SL_CH_AMT
                     , NVL(SUM(CASE WHEN A2.NOM_SL_AMT = 0 AND A2.SL_CTR_AMT != 0
                                    THEN A2.SL_SUM_VAT END), 0) + NVL(SUM(A2.CAN_VAT), 0) AS CH_VAT
                     , NVL(SUM(CASE WHEN A2.NOM_SL_AMT = 0 AND A2.SL_CTR_AMT != 0
                                    THEN A2.PVDA_AMT END), 0) AS CH_PVDA_AMT
                     , NVL(SUM(A2.CAN_QTY), 0) AS CAN_QTY
                     , NVL(SUM(A2.SL_CAN_AMT), 0) AS SL_CAN_AMT
                     , NVL(SUM(A2.CAN_VAT), 0) AS CAN_VAT
                     , NVL(SUM(A2.SL_QTY), 0) - NVL(SUM(A2.CAN_QTY), 0) AS TOT_QTY
                     , NVL(SUM(A2.THM_SL_SUM_AMT), 0) + NVL(SUM(A2.PVDA_AMT), 0) AS TOT_AMT
                     , NVL(SUM(A2.SL_SUM_VAT), 0) AS TOT_VAT
                  FROM TB_CBCL_WELLS_SL_MM_CL_IZ A2  /* WELLS매출월마감내역 */
                 INNER JOIN
                      (SELECT DISTINCT Z1.CNTR_NO
                            , Z1.CNTR_SN
                         FROM TB_SSCT_CNTR_PD_REL Z1  /* 계약상품관계 */
                        INNER JOIN TB_PDBS_PD_BAS Z2  /* 상품기본 */
                           ON Z2.PD_CD = Z1.BASE_PD_CD
                          AND Z2.DTA_DL_YN = 'N'
                        INNER JOIN TB_PDBS_PD_CLSF_BAS Z3  /* 상품분류기본 */
                           ON Z3.PD_CLSF_ID = Z2.PD_CLSF_ID
                          AND Z3.REF_PD_CLSF_VAL IN ('05003002','0A003002')  /*원두제외*/
                          AND Z3.DTA_DL_YN = 'N'
                        WHERE Z1.DTA_DL_YN = 'N'
                      ) A3
                   ON A3.CNTR_NO = A2.CNTR_NO
                  AND A3.CNTR_SN = A2.CNTR_SN
                 WHERE A2.SL_RCOG_DT BETWEEN #{baseDtmnFrom} AND #{baseDtmnTo}
                   AND A2.SL_RCOG_DT LIKE A2.SL_CL_YM || '%'
                   AND A2.SELL_TP_CD = '2'
                   <if test="@MybatisUtils@isNotEmpty(sellChnlDtl) and !@MybatisUtils@equals(sellChnlDtl, 'ALL')">
                   AND A2.SELL_INFLW_CHNL_DTL_CD = #{sellChnlDtl}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                   AND A2.CNTR_NO = #{cntrNo}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                   AND A2.CNTR_SN = #{cntrSn}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cstNo)'>
                   AND A2.CST_NO = #{cstNo}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(sapPdDvCd)'>
                   AND A2.SAP_PD_DV_CD = #{sapPdDvCd}
                   </if>
                 GROUP BY A2.CNTR_NO
                        , A2.CNTR_SN
                        , A2.CST_NO
                        , A2.PD_CD
                        , A2.SELL_TP_CD
                        , A2.SELL_TP_DTL_CD
                        , A2.SELL_INFLW_CHNL_DTL_CD
                        , A2.SL_RCOG_DT
                        , A2.SAP_PD_DV_CD
                ) B1
          LEFT OUTER JOIN TB_PDBS_PD_BAS B2  /* 상품기본 */
            ON B2.PD_CD = B1.PD_CD
           AND B2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS B3  /* 고객기본 */
            ON B3.CST_NO = B1.CST_NO
           AND B3.NUSD_RSON_CD IS NULL
           AND B3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN T_CMZ_CD_D B4  /* 코드상세 */
            ON B4.TENANT_ID = #{session.tenantId}
           AND B4.CD_ID = 'SELL_TP_CD'
           AND B4.CD_VLD_VAL = B1.SELL_TP_CD
          LEFT OUTER JOIN T_CMZ_CD_D B5  /* 코드상세 */
            ON B5.TENANT_ID = #{session.tenantId}
           AND B5.CD_ID = 'SELL_TP_DTL_CD'
           AND B5.CD_VLD_VAL = B1.SELL_TP_DTL_CD
          LEFT OUTER JOIN T_CMZ_CD_D B6  /* 코드상세 */
            ON B6.TENANT_ID =#{session.tenantId}
           AND B6.CD_ID = 'SELL_CHNL_DTL_CD'
           AND B6.CD_VLD_VAL = B1.SELL_INFLW_CHNL_DTL_CD
          LEFT OUTER JOIN TB_CBCL_SAP_PD_DV_CD B7  /* SAP상품구분코드 */
            ON B7.SAP_PD_DV_CD = B1.SAP_PD_DV_CD
           AND B7.SAP_PD_ATC_CD = '00'
           AND B7.SAP_PD_ATC_SN = 1
           AND B7.SAP_BZ_TERY_CD = '1210'
         ORDER BY B1.SL_RCOG_DT
                , B1.CNTR_NO
                , B1.CNTR_SN
    </select>

    <select id="selectProductSalesLeaseDetails" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbProductSalesDetailDto$SearchSingleRes">
        SELECT B4.CD_CNTN AS SELL_TP_CD                        /* 판매유형명 */
             , B5.CD_CNTN AS SELL_TP_DTL_CD                    /* 판매유형상세명 */
             , B1.PD_CD                                        /* 상품코드 */
             , B2.PD_NM                                        /* 상품명 */
             , B6.CD_CNTN AS SELL_INFLW_CHNL_DTL_CD            /* 판매유입채널상세명 */
             , B1.SL_RCOG_DT                                   /* 매출인식일자 */
             , B1.CNTR_NO || '-' || B1.CNTR_SN AS CNTR_DTL_NO  /* 계약상세번호 */
             , B1.CNTR_NO                                      /* 계약번호 */
             , B1.CNTR_SN                                      /* 계약일련번호 */
             , B3.CST_KNM                                      /* 고객명 */
             , B7.SAP_PD_DV_NM AS SAP_PD_DV_CD                 /* SAP상품구분코드명 */
             , B1.SELL_QTY                                     /* 판매수량-정상매출 */
             , B1.SELL_AMT                                     /* 매출금액-정상매출 */
             , B1.SELL_AMT - B1.SELL_AMT_VAT AS SELL_SPL_AMT   /* 공급가액-정상매출 */
             , B1.SELL_AMT_VAT                                 /* 부가세-정상매출 */
             , B1.PVDA_AMT                                     /* 현할차-정상매출 */
             , B1.CH_QTY                                       /* 판매수량-매출변경 */
             , B1.SL_CH_AMT                                    /* 매출금액-매출변경 */
             , B1.SL_CH_AMT - B1.CH_VAT AS CH_SPL_AMT          /* 공급가액-매출변경 */
             , B1.CH_VAT                                       /* 부가세-매출변경 */
             , B1.CH_PVDA_AMT                                  /* 현할차-매출변경 */
             , B1.CAN_QTY                                      /* 판매수량-매출취소 */
             , B1.SL_CAN_AMT                                   /* 매출금액-매출취소 */
             , B1.SL_CAN_AMT - B1.CAN_VAT AS CAN_SPL_AMT       /* 공급가액-매출취소 */
             , B1.CAN_VAT                                      /* 부가세-매출취소 */
             , B1.CAN_PVDA_AMT                                 /* 현할차-매출취소 */
             , B1.TOT_QTY                                      /* 판매수량-매출합계 */
             , B1.TOT_AMT                                      /* 매출금액-매출합계 */
             , B1.TOT_AMT - B1.TOT_VAT AS TOT_SPL_AMT          /* 공급가액-매출합계 */
             , B1.TOT_VAT                                      /* 부가세-매출합계 */
             , B1.TOT_PVDA_AMT                                 /* 현할차-매출합계 */
          FROM (SELECT A1.CNTR_NO
                     , A1.CNTR_SN
                     , A1.CST_NO
                     , A1.PD_CD
                     , A1.SELL_TP_CD
                     , A1.SELL_TP_DTL_CD
                     , A1.SELL_INFLW_CHNL_DTL_CD
                     , A1.SL_RCOG_DT
                     , A1.SAP_PD_DV_CD
                     , NVL(SUM(CASE WHEN A1.NOM_SL_AMT != 0 THEN A1.SL_QTY END), 0) AS SELL_QTY
                     , NVL(SUM(A1.THM_SL_SUM_AMT), 0) + NVL(SUM(A1.SL_CTR_AMT), 0) + NVL(SUM(A1.SL_CAN_AMT), 0) AS SELL_AMT
                     , NVL(SUM(CASE WHEN A1.NOM_SL_AMT != 0 THEN A1.SL_SUM_VAT END), 0) + NVL(SUM(A1.CAN_VAT), 0) AS SELL_AMT_VAT
                     , NVL(SUM(CASE WHEN A1.NOM_SL_AMT != 0 THEN A1.PVDA_AMT END), 0) AS PVDA_AMT
                     , NVL(SUM(CASE WHEN NVL(A1.NOM_SL_AMT, 0) = 0 AND NVL(A1.SL_CAN_AMT, 0) = 0 AND A1.THM_SL_SUM_AMT != 0
                                    THEN A1.SL_QTY
                                    WHEN NVL(A1.NOM_SL_AMT, 0) = 0 AND A1.CAN_DT IS NOT NULL AND NVL(A1.CAN_QTY, 0) = 0
                                    THEN A1.SL_QTY END) ,0) AS CH_QTY
                     , -1 * NVL(SUM(A1.SL_CTR_AMT), 0) AS SL_CH_AMT
                     , NVL(SUM(CASE WHEN A1.NOM_SL_AMT = 0 AND A1.SL_CTR_AMT != 0
                                    THEN A1.SL_SUM_VAT END), 0) + NVL(SUM(A1.CAN_VAT), 0) AS CH_VAT
                     , NVL(SUM(CASE WHEN A1.NOM_SL_AMT = 0 AND A1.SL_CTR_AMT != 0
                                    THEN A1.PVDA_AMT END), 0) AS CH_PVDA_AMT
                     , NVL(SUM(A1.CAN_QTY), 0) AS CAN_QTY
                     , NVL(SUM(A1.SL_CAN_AMT), 0) AS SL_CAN_AMT
                     , NVL(SUM(A1.CAN_VAT), 0) AS CAN_VAT
                     , NVL(SUM(CASE WHEN A1.NOM_SL_AMT = 0 AND A1.SL_CTR_AMT = 0 AND A1.SL_CAN_AMT !=0
                                    THEN -1 * A1.PVDA_AMT END), 0) AS CAN_PVDA_AMT
                     , NVL(SUM(A1.SL_QTY), 0) - NVL(SUM(A1.CAN_QTY), 0) AS TOT_QTY
                     , NVL(SUM(A1.THM_SL_SUM_AMT), 0) + NVL(SUM(A1.PVDA_AMT), 0) AS TOT_AMT
                     , NVL(SUM(A1.SL_SUM_VAT), 0) AS TOT_VAT
                     , NVL(SUM(A1.PVDA_AMT), 0) AS TOT_PVDA_AMT
                  FROM TB_CBCL_WELLS_SL_MM_CL_IZ A1  /* WELLS매출월마감내역 */
                 WHERE A1.SL_RCOG_DT BETWEEN #{baseDtmnFrom} AND #{baseDtmnTo}
                   AND A1.SL_RCOG_DT LIKE A1.SL_CL_YM || '%'
                   AND A1.SELL_TP_CD = '2'
                   AND A1.SELL_TP_DTL_CD IN ('22', '24', '25', '26')
                   <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                   AND A1.SELL_TP_DTL_CD = #{sellTpDtlCd}
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(sellChnlDtl) and !@MybatisUtils@equals(sellChnlDtl, 'ALL')">
                   AND A1.SELL_INFLW_CHNL_DTL_CD = #{sellChnlDtl}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                   AND A1.CNTR_NO = #{cntrNo}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                   AND A1.CNTR_SN = #{cntrSn}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cstNo)'>
                   AND A1.CST_NO = #{cstNo}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(sapPdDvCd)'>
                   AND A1.SAP_PD_DV_CD = #{sapPdDvCd}
                   </if>
                 GROUP BY A1.CNTR_NO
                        , A1.CNTR_SN
                        , A1.CST_NO
                        , A1.PD_CD
                        , A1.SELL_TP_CD
                        , A1.SELL_TP_DTL_CD
                        , A1.SELL_INFLW_CHNL_DTL_CD
                        , A1.SL_RCOG_DT
                        , A1.SAP_PD_DV_CD
                ) B1
          LEFT OUTER JOIN TB_PDBS_PD_BAS B2  /* 상품기본 */
            ON B2.PD_CD = B1.PD_CD
           AND B2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS B3  /* 고객기본 */
            ON B3.CST_NO = B1.CST_NO
           AND B3.NUSD_RSON_CD IS NULL
           AND B3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN T_CMZ_CD_D B4  /* 코드상세 */
            ON B4.TENANT_ID = #{session.tenantId}
           AND B4.CD_ID = 'SELL_TP_CD'
           AND B4.CD_VLD_VAL = B1.SELL_TP_CD
          LEFT OUTER JOIN T_CMZ_CD_D B5  /* 코드상세 */
            ON B5.TENANT_ID = #{session.tenantId}
           AND B5.CD_ID = 'SELL_TP_DTL_CD'
           AND B5.CD_VLD_VAL = B1.SELL_TP_DTL_CD
          LEFT OUTER JOIN T_CMZ_CD_D B6  /* 코드상세 */
            ON B6.TENANT_ID =#{session.tenantId}
           AND B6.CD_ID = 'SELL_CHNL_DTL_CD'
           AND B6.CD_VLD_VAL = B1.SELL_INFLW_CHNL_DTL_CD
          LEFT OUTER JOIN TB_CBCL_SAP_PD_DV_CD B7  /* SAP상품구분코드 */
            ON B7.SAP_PD_DV_CD = B1.SAP_PD_DV_CD
           AND B7.SAP_PD_ATC_CD = '00'
           AND B7.SAP_PD_ATC_SN = 1
           AND B7.SAP_BZ_TERY_CD = '1210'
         ORDER BY B1.SL_RCOG_DT
                , B1.CNTR_NO
                , B1.CNTR_SN
    </select>

    <select id="selectProductSalesRentalDetails" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbProductSalesDetailDto$SearchRentalRes">
        /* WELLS 상품별매출현황 상세 (렌탈) */
        SELECT B4.CD_CNTN AS SELL_TP_CD                                                               /* 판매유형명 */
             , B5.CD_CNTN AS SELL_TP_DTL_CD                                                           /* 판매유형상세명 */
             , B1.PD_CD                                                                               /* 상품코드 */
             , B2.PD_NM                                                                               /* 상품명 */
             , B6.CD_CNTN AS SELL_INFLW_CHNL_DTL_CD                                                   /* 판매유입채널상세명 */
             , B1.SL_RCOG_DT                                                                          /* 매출인식일자 */
             , B1.CNTR_NO || '-' || B1.CNTR_SN AS CNTR_DTL_NO                                         /* 계약상세번호 */
             , B1.CNTR_NO                                                                             /* 계약번호 */
             , B1.CNTR_SN                                                                             /* 계약일련번호 */
             , B3.CST_KNM                                                                             /* 고객명 */
             , B7.SAP_PD_DV_NM AS SAP_PD_DV_CD                                                        /* SAP상품구분코드명 */
             , B1.RENTAL_RGST_COST                                                                    /* 매출금액-등록비 */
             , B1.RENTAL_RGST_COST - B1.RENTAL_RGST_COST_VAT AS RENTAL_RGST_COST_SPL                  /* 공급가액-등록비 */
             , B1.RENTAL_RGST_COST_VAT                                                                /* 부가세-등록비 */
             , B1.NOM_SL_AMT                                                                          /* 매출금액-렌탈료 */
             , B1.NOM_SL_AMT - B1.VAT AS SPL_AMT                                                      /* 공급가액-렌탈료 */
             , B1.VAT                                                                                 /* 부가세-렌탈료 */
             , B1.RENTAL_RGST_COST + B1.NOM_SL_AMT AS TOT_SL_AMT                                      /* 매출금액-매출합계 */
             , B1.RENTAL_RGST_COST - B1.RENTAL_RGST_COST_VAT + B1.NOM_SL_AMT - B1.VAT AS TOT_SPL_AMT  /* 공급가액-매출합계 */
             , B1.RENTAL_RGST_COST_VAT + B1.VAT AS TOT_VAT                                            /* 부가세-매출합계 */
          FROM (SELECT A1.CNTR_NO
                     , A1.CNTR_SN
                     , A1.CST_NO
                     , A1.PD_CD
                     , A1.SELL_TP_CD
                     , A1.SELL_TP_DTL_CD
                     , A1.SELL_INFLW_CHNL_DTL_CD
                     , A1.SL_RCOG_DT
                     , A1.SAP_PD_DV_CD
                     , NVL(SUM(CASE WHEN A1.RENTAL_TN = 0 THEN A1.RENTAL_RGST_COST END), 0) AS RENTAL_RGST_COST
                     , NVL(SUM(CASE WHEN A1.RENTAL_TN = 0 THEN A1.RENTAL_RGST_COST_VAT END), 0) AS RENTAL_RGST_COST_VAT
                     , NVL(SUM(A1.THM_SL_SUM_AMT), 0) AS NOM_SL_AMT
                     , NVL(SUM(A1.SL_SUM_VAT), 0) AS VAT
                 FROM TB_CBCL_WELLS_SL_MM_CL_IZ A1  /* WELLS매출춸마감내역 */
                 LEFT OUTER JOIN
                      (SELECT Z1.CNTR_NO
                            , Z1.CNTR_SN
                         FROM TB_SSCT_CNTR_PD_REL Z1  /* 계약상품관계 */
                        INNER JOIN TB_PDBS_PD_BAS Z2  /* 상품기본 */
                           ON Z2.PD_CD = Z1.BASE_PD_CD
                          AND Z2.DTA_DL_YN = 'N'
                        INNER JOIN TB_PDBS_PD_CLSF_BAS Z3  /* 상품분류기본 */
                           ON Z3.PD_CLSF_ID = Z2.PD_CLSF_ID
                          AND Z3.REF_PD_CLSF_VAL IN ('05003002','0A003002')  /*원두제외*/
                          AND Z3.DTA_DL_YN = 'N'
                        WHERE Z1.DTA_DL_YN = 'N'
                      ) A3
                   ON A3.CNTR_NO = A1.CNTR_NO
                  AND A3.CNTR_SN = A1.CNTR_SN
                WHERE A1.SL_RCOG_DT BETWEEN #{baseDtmnFrom} AND #{baseDtmnTo}
                  AND A1.SL_RCOG_DT LIKE A1.SL_CL_YM || '%'
                  AND A1.SELL_TP_CD = '2'
                  AND A1.SELL_TP_DTL_CD IN ('21', '23')
                  AND A3.CNTR_NO IS NULL
                  AND A3.CNTR_SN IS NULL
                  <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                  AND A1.SELL_TP_DTL_CD = #{sellTpDtlCd}
                  </if>
                  <if test="@MybatisUtils@isNotEmpty(sellChnlDtl) and !@MybatisUtils@equals(sellChnlDtl, 'ALL')">
                  AND A1.SELL_INFLW_CHNL_DTL_CD = #{sellChnlDtl}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                  AND A1.CNTR_NO = #{cntrNo}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                  AND A1.CNTR_SN = #{cntrSn}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(cstNo)'>
                  AND A1.CST_NO = #{cstNo}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(sapPdDvCd)'>
                  AND A1.SAP_PD_DV_CD = #{sapPdDvCd}
                  </if>
                GROUP BY A1.CNTR_NO
                       , A1.CNTR_SN
                       , A1.CST_NO
                       , A1.PD_CD
                       , A1.SELL_TP_CD
                       , A1.SELL_TP_DTL_CD
                       , A1.SELL_INFLW_CHNL_DTL_CD
                       , A1.SL_RCOG_DT
                       , A1.SL_RCOG_DT
                       , A1.SAP_PD_DV_CD
               ) B1
          LEFT OUTER JOIN TB_PDBS_PD_BAS B2  /* 상품기본 */
            ON B2.PD_CD = B1.PD_CD
           AND B2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS B3  /* 고객기본 */
            ON B3.CST_NO = B1.CST_NO
           AND B3.NUSD_RSON_CD IS NULL
           AND B3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN T_CMZ_CD_D B4  /* 코드상세 */
            ON B4.TENANT_ID = #{session.tenantId}
           AND B4.CD_ID = 'SELL_TP_CD'
           AND B4.CD_VLD_VAL = B1.SELL_TP_CD
          LEFT OUTER JOIN T_CMZ_CD_D B5  /* 코드상세 */
            ON B5.TENANT_ID = #{session.tenantId}
           AND B5.CD_ID = 'SELL_TP_DTL_CD'
           AND B5.CD_VLD_VAL = B1.SELL_TP_DTL_CD
          LEFT OUTER JOIN T_CMZ_CD_D B6  /* 코드상세 */
            ON B6.TENANT_ID = #{session.tenantId}
           AND B6.CD_ID = 'SELL_CHNL_DTL_CD'
           AND B6.CD_VLD_VAL = B1.SELL_INFLW_CHNL_DTL_CD
          LEFT OUTER JOIN TB_CBCL_SAP_PD_DV_CD B7  /* SAP상품구분코드 */
            ON B7.SAP_PD_DV_CD = B1.SAP_PD_DV_CD
           AND B7.SAP_PD_ATC_CD = '00'
           AND B7.SAP_PD_ATC_SN = 1
           AND B7.SAP_BZ_TERY_CD = '1210'
         ORDER BY B1.SL_RCOG_DT
                , B1.CNTR_NO
                , B1.CNTR_SN
    </select>

    <select id="selectProductSalesMembershipDetails" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbProductSalesDetailDto$SearchMembershipRes">
        SELECT B4.CD_CNTN AS SELL_TP_CD                                   /* 판매유형명 */
             , B5.CD_CNTN AS SELL_TP_DTL_CD                               /* 판매유형상세명 */
             , B1.PD_CD                                                   /* 상품코드 */
             , B2.PD_NM                                                   /* 상품명 */
             , B6.CD_CNTN AS SELL_INFLW_CHNL_DTL_CD                       /* 판매유입채널상세명 */
             , B1.SL_RCOG_DT                                              /* 매출인식일자 */
             , B1.CNTR_NO || '-' || B1.CNTR_SN AS CNTR_DTL_NO             /* 계약상세번호 */
             , B1.CNTR_NO                                                 /* 계약번호 */
             , B1.CNTR_SN                                                 /* 계약일련번호 */
             , B3.CST_KNM                                                 /* 고객명 */
             , B7.SAP_PD_DV_NM AS SAP_PD_DV_CD                            /* SAP상품구분코드명 */
             , B1.SELL_AMT                                                /* 매출금액-회비 */
             , B1.SELL_AMT - B1.SELL_AMT_VAT AS SELL_SPL_AMT              /* 공급가액-회비 */
             , B1.SELL_AMT_VAT                                            /* 부가세-회비 */
             , B1.FIL_SELL_AMT                                            /* 매출금액-필터 */
             , B1.FIL_SELL_AMT - B1.FIL_SELL_AMT_VAT AS FIL_SELL_SPL_AMT  /* 공급가액-필터 */
             , B1.FIL_SELL_AMT_VAT                                        /* 부가세-필터 */
             , B1.TOT_SELL_AMT                                            /* 매출금액-매출합계 */
             , B1.TOT_SELL_AMT - B1.TOT_SELL_AMT_VAT AS TOT_SELL_SPL_AMT  /* 공급가액-매출합계 */
             , B1.TOT_SELL_AMT_VAT                                        /* 부가세-매출합계 */
          FROM (SELECT A1.CNTR_NO
                     , A1.CNTR_SN
                     , A1.CST_NO
                     , A1.PD_CD
                     , A1.SELL_TP_CD
                     , A1.SELL_TP_DTL_CD
                     , A1.SELL_INFLW_CHNL_DTL_CD
                     , A1.SL_RCOG_DT
                     , A1.SAP_PD_DV_CD
                     , NVL(SUM(A1.THM_SL_SUM_AMT), 0) AS SELL_AMT
                     , NVL(SUM(A1.SL_SUM_VAT), 0) AS SELL_AMT_VAT
                     , 0 AS FIL_SELL_AMT
                     , 0 AS FIL_SELL_AMT_VAT
                     , NVL(SUM(A1.THM_SL_SUM_AMT), 0) AS TOT_SELL_AMT
                     , NVL(SUM(A1.SL_SUM_VAT), 0) AS TOT_SELL_AMT_VAT
                  FROM TB_CBCL_WELLS_SL_MM_CL_IZ A1  /* WELLS매출월마감내역 */
                 WHERE A1.SL_RCOG_DT BETWEEN #{baseDtmnFrom} AND #{baseDtmnTo}
                   AND A1.SL_RCOG_DT LIKE A1.SL_CL_YM || '%'
                   AND A1.SELL_TP_CD = '3'
                   <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                   AND A1.SELL_TP_DTL_CD = #{sellTpDtlCd}
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(sellChnlDtl) and !@MybatisUtils@equals(sellChnlDtl, 'ALL')">
                   AND A1.SELL_INFLW_CHNL_DTL_CD = #{sellChnlDtl}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                   AND A1.CNTR_NO = #{cntrNo}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                   AND A1.CNTR_SN = #{cntrSn}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(cstNo)'>
                   AND A1.CST_NO = #{cstNo}
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(sapPdDvCd)'>
                   AND A1.SAP_PD_DV_CD = #{sapPdDvCd}
                   </if>
                 GROUP BY A1.CNTR_NO
                        , A1.CNTR_SN
                        , A1.CST_NO
                        , A1.PD_CD
                        , A1.SELL_TP_CD
                        , A1.SELL_TP_DTL_CD
                        , A1.SELL_INFLW_CHNL_DTL_CD
                        , A1.SL_RCOG_DT
                        , A1.SAP_PD_DV_CD
                ) B1
          LEFT OUTER JOIN TB_PDBS_PD_BAS B2  /* 상품기본 */
            ON B2.PD_CD = B1.PD_CD
           AND B2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS B3  /* 고객기본 */
            ON B3.CST_NO = B1.CST_NO
           AND B3.NUSD_RSON_CD IS NULL
           AND B3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN T_CMZ_CD_D B4  /* 코드상세 */
            ON B4.TENANT_ID = #{session.tenantId}
           AND B4.CD_ID = 'SELL_TP_CD'
           AND B4.CD_VLD_VAL = B1.SELL_TP_CD
          LEFT OUTER JOIN T_CMZ_CD_D B5  /* 코드상세 */
            ON B5.TENANT_ID = #{session.tenantId}
           AND B5.CD_ID = 'SELL_TP_DTL_CD'
           AND B5.CD_VLD_VAL = B1.SELL_TP_DTL_CD
          LEFT OUTER JOIN T_CMZ_CD_D B6  /* 코드상세 */
            ON B6.TENANT_ID =#{session.tenantId}
           AND B6.CD_ID = 'SELL_CHNL_DTL_CD'
           AND B6.CD_VLD_VAL = B1.SELL_INFLW_CHNL_DTL_CD
          LEFT OUTER JOIN TB_CBCL_SAP_PD_DV_CD B7  /* SAP상품구분코드 */
            ON B7.SAP_PD_DV_CD = B1.SAP_PD_DV_CD
           AND B7.SAP_PD_ATC_CD = '00'
           AND B7.SAP_PD_ATC_SN = 1
           AND B7.SAP_BZ_TERY_CD = '1210'
         ORDER BY B1.SL_RCOG_DT
                , B1.CNTR_NO
                , B1.CNTR_SN
    </select>

    <select id="selectRentalBulkExcelDownload" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbProductSalesDetailDto$SearchRentalRes" fetchSize="1000">
        SELECT B4.CD_CNTN AS SELL_TP_CD                                                               /* 판매유형명 */
             , B5.CD_CNTN AS SELL_TP_DTL_CD                                                           /* 판매유형상세명 */
             , B1.PD_CD                                                                               /* 상품코드 */
             , B2.PD_NM                                                                               /* 상품명 */
             , B6.CD_CNTN AS SELL_INFLW_CHNL_DTL_CD                                                   /* 판매유입채널상세명 */
             , B1.SL_RCOG_DT                                                                          /* 매출인식일자 */
             , B1.CNTR_NO || '-' || B1.CNTR_SN AS CNTR_DTL_NO                                         /* 계약상세번호 */
             , B1.CNTR_NO                                                                             /* 계약번호 */
             , B1.CNTR_SN                                                                             /* 계약일련번호 */
             , B3.CST_KNM                                                                             /* 고객명 */
             , B7.SAP_PD_DV_NM AS SAP_PD_DV_CD                                                        /* SAP상품구분코드명 */
             , B1.RENTAL_RGST_COST                                                                    /* 매출금액-등록비 */
             , B1.RENTAL_RGST_COST - B1.RENTAL_RGST_COST_VAT AS RENTAL_RGST_COST_SPL                  /* 공급가액-등록비 */
             , B1.RENTAL_RGST_COST_VAT                                                                /* 부가세-등록비 */
             , B1.NOM_SL_AMT                                                                          /* 매출금액-렌탈료 */
             , B1.NOM_SL_AMT - B1.VAT AS SPL_AMT                                                      /* 공급가액-렌탈료 */
             , B1.VAT                                                                                 /* 부가세-렌탈료 */
             , B1.RENTAL_RGST_COST + B1.NOM_SL_AMT AS TOT_SL_AMT                                      /* 매출금액-매출합계 */
             , B1.RENTAL_RGST_COST - B1.RENTAL_RGST_COST_VAT + B1.NOM_SL_AMT - B1.VAT AS TOT_SPL_AMT  /* 공급가액-매출합계 */
             , B1.RENTAL_RGST_COST_VAT + B1.VAT AS TOT_VAT                                            /* 부가세-매출합계 */
          FROM (SELECT A1.CNTR_NO
                     , A1.CNTR_SN
                     , A1.CST_NO
                     , A1.PD_CD
                     , A1.SELL_TP_CD
                     , A1.SELL_TP_DTL_CD
                     , A1.SELL_INFLW_CHNL_DTL_CD
                     , A1.SL_RCOG_DT
                     , A1.SAP_PD_DV_CD
                     , NVL(SUM(CASE WHEN A1.RENTAL_TN = 0 THEN A1.CNTR_AMT END), 0) AS RENTAL_RGST_COST
                     , NVL(SUM(CASE WHEN A1.RENTAL_TN = 0 THEN A1.RENTAL_RGST_COST_VAT END), 0) AS RENTAL_RGST_COST_VAT
                     , NVL(SUM(A1.THM_SL_SUM_AMT), 0) AS NOM_SL_AMT
                     , NVL(SUM(A1.SL_SUM_VAT), 0) AS VAT
                 FROM TB_CBCL_WELLS_SL_MM_CL_IZ A1  /* WELLS매출춸마감내역 */
                 LEFT OUTER JOIN
                      (SELECT Z1.CNTR_NO
                            , Z1.CNTR_SN
                         FROM TB_SSCT_CNTR_PD_REL Z1  /* 계약상품관계 */
                        INNER JOIN TB_PDBS_PD_BAS Z2  /* 상품기본 */
                           ON Z2.PD_CD = Z1.BASE_PD_CD
                          AND Z2.DTA_DL_YN = 'N'
                        INNER JOIN TB_PDBS_PD_CLSF_BAS Z3  /* 상품분류기본 */
                           ON Z3.PD_CLSF_ID = Z2.PD_CLSF_ID
                          AND Z3.REF_PD_CLSF_VAL IN ('05003002','0A003002')  /*원두제외*/
                          AND Z3.DTA_DL_YN = 'N'
                        WHERE Z1.DTA_DL_YN = 'N'
                      ) A3
                   ON A3.CNTR_NO = A1.CNTR_NO
                  AND A3.CNTR_SN = A1.CNTR_SN
                WHERE A1.SL_RCOG_DT BETWEEN #{baseDtmnFrom} AND #{baseDtmnTo}
                  AND A1.SL_RCOG_DT LIKE A1.SL_CL_YM || '%'
                  AND A1.SELL_TP_CD = '2'
                  AND A1.SELL_TP_DTL_CD IN ('21', '23')
                  AND A3.CNTR_NO IS NULL
                  AND A3.CNTR_SN IS NULL
                  <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                  AND A1.SELL_TP_DTL_CD = #{sellTpDtlCd}
                  </if>
                  <if test="@MybatisUtils@isNotEmpty(sellChnlDtl) and !@MybatisUtils@equals(sellChnlDtl, 'ALL')">
                  AND A1.SELL_INFLW_CHNL_DTL_CD = #{sellChnlDtl}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
                  AND A1.CNTR_NO = #{cntrNo}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
                  AND A1.CNTR_SN = #{cntrSn}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(cstNo)'>
                  AND A1.CST_NO = #{cstNo}
                  </if>
                  <if test='@MybatisUtils@isNotEmpty(sapPdDvCd)'>
                  AND A1.SAP_PD_DV_CD = #{sapPdDvCd}
                  </if>
                GROUP BY A1.CNTR_NO
                       , A1.CNTR_SN
                       , A1.CST_NO
                       , A1.PD_CD
                       , A1.SELL_TP_CD
                       , A1.SELL_TP_DTL_CD
                       , A1.SELL_INFLW_CHNL_DTL_CD
                       , A1.SL_RCOG_DT
                       , A1.SL_RCOG_DT
                       , A1.SAP_PD_DV_CD
               ) B1
          LEFT OUTER JOIN TB_PDBS_PD_BAS B2  /* 상품기본 */
            ON B2.PD_CD = B1.PD_CD
           AND B2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS B3  /* 고객기본 */
            ON B3.CST_NO = B1.CST_NO
           AND B3.NUSD_RSON_CD IS NULL
           AND B3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN T_CMZ_CD_D B4  /* 코드상세 */
            ON B4.TENANT_ID = #{session.tenantId}
           AND B4.CD_ID = 'SELL_TP_CD'
           AND B4.CD_VLD_VAL = B1.SELL_TP_CD
          LEFT OUTER JOIN T_CMZ_CD_D B5  /* 코드상세 */
            ON B5.TENANT_ID = #{session.tenantId}
           AND B5.CD_ID = 'SELL_TP_DTL_CD'
           AND B5.CD_VLD_VAL = B1.SELL_TP_DTL_CD
          LEFT OUTER JOIN T_CMZ_CD_D B6  /* 코드상세 */
            ON B6.TENANT_ID = #{session.tenantId}
           AND B6.CD_ID = 'SELL_CHNL_DTL_CD'
           AND B6.CD_VLD_VAL = B1.SELL_INFLW_CHNL_DTL_CD
          LEFT OUTER JOIN TB_CBCL_SAP_PD_DV_CD B7  /* SAP상품구분코드 */
            ON B7.SAP_PD_DV_CD = B1.SAP_PD_DV_CD
           AND B7.SAP_PD_ATC_CD = '00'
           AND B7.SAP_PD_ATC_SN = 1
           AND B7.SAP_BZ_TERY_CD = '1210'
         ORDER BY B1.SL_RCOG_DT
                , B1.CNTR_NO
                , B1.CNTR_SN
    </select>

</mapper>
