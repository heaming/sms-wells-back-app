<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.closing.sales.mapper.WdcbAdvancedSellFeeReplaceMapper">
    <select id="selectAggregateLists" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbAdvancedSellFeeReplaceDto$SearchAggregateRes">
        SELECT OG_TP_CD  /*조직유형코드*/
             , SELL_TP_CD  /*판매유형코드*/
             , SELL_TP_DTL_CD  /*판매유형상세*/
             , PD_HCLSF_NM     /*상품대분류*/
             , PD_MCLSF_NM     /*상품중분류*/
             , BASE_YM   /*기준년월*/
             , SUM(SL_AMT) AS SL_AMT      /*매출금액*/
             , SUM(FEE_OC_AMT) AS  FEE_OC_AMT  /*수수료발생금액*/
             , FEE_OC_YM    /*수수료발생년월*/
             , PIA_CS_YN    /*선급대상여부*/
             , SUM(PIA_SELL_FEE_CRDOVR_RES_AMT) AS PIA_SELL_FEE_CRDOVR_RES_AMT   /*선급판매수수료이월잔액*/
             , SUM(PIA_FEE_OC_AMT) AS PIA_FEE_OC_AMT  /*선급수수료발생금액*/
             , SUM(CS_RPLC_AMT) AS CS_RPLC_AMT     /*비용대체금액*/
             , SUM(CS_RPLC_AMT_CANC_BLAM) AS CS_RPLC_AMT_CANC_BLAM  /*비용대체금액 (취소분 잔액) - 취소건 선급잔액 */
             , CASE WHEN PIA_CS_YN = 'Y' THEN SUM(CS_RPLC_AMT + CS_RPLC_AMT_CANC_BLAM)
                    ELSE SUM(TTRM_CS_AMT) END AS TTRM_CS_AMT /*당기비용인식액*/
             , CASE WHEN PIA_CS_YN = 'Y' THEN SUM(PIA_SELL_FEE_CRDOVR_RES_AMT + PIA_FEE_OC_AMT - CS_RPLC_AMT - CS_RPLC_AMT_CANC_BLAM)
                    ELSE SUM(PIA_FEE_EOT_BLAM) END AS PIA_FEE_EOT_BLAM  /*선급수수료기말잔액*/
          FROM (
                 SELECT OG_TP_CD  /*조직유형코드*/
                      , SELL_TP_CD  /*판매유형코드*/
                      , SELL_TP_DTL_CD  /*판매유형상세*/
                      , '' AS PD_HCLSF_NM   /*상품대분류*/
                      , '' AS PD_MCLSF_NM   /*상품중분류*/
                      , BASE_YM   /*기준년월*/
                      , MIN(SL_AMT) AS SL_AMT      /*매출금액*/
                      , SUM(FEE_OC_AMT) AS FEE_OC_AMT  /*수수료발생금액*/
                      , FEE_OC_YM    /*수수료발생년월*/
                      , PIA_CS_YN    /*선급대상여부*/
                      , SUM(PIA_SELL_FEE_CRDOVR_RES_AMT) AS PIA_SELL_FEE_CRDOVR_RES_AMT   /*선급판매수수료이월잔액*/
                      , SUM(FEE_OC_AMT) AS PIA_FEE_OC_AMT  /*선급수수료발생금액 - 이테이블의 금액은 모두 선급대상*/
                      , CASE WHEN CNTR_PD_ENDDT IS NULL OR SUBSTR(CNTR_PD_ENDDT,1,6) != #{baseYm} THEN SUM(CS_RPLC_AMT)
                             ELSE 0 END AS CS_RPLC_AMT   /*비용대체금액:종료일이 없거나, 해당월 종료가 아닌 경우 대상*/
                      , CASE WHEN SUBSTR(CNTR_PD_ENDDT,1,6) = #{baseYm} THEN SUM(CS_RPLC_AMT)
                             ELSE 0 END AS CS_RPLC_AMT_CANC_BLAM  /*비용대체금액 (취소분 잔액) */
                      , 0 AS TTRM_CS_AMT
                      , 0 AS PIA_FEE_EOT_BLAM
                  FROM TB_CBCL_PIA_FEE_CS_RPLC_BAS T1 /*선급판매수수료 비용대체기본*/
                 WHERE BASE_YM   = #{baseYm}   /*기준년월*/
                   AND FEE_TCNT = #{feeTcnt}
                    <if test="@MybatisUtils@isNotEmpty(ogTpCd) and !@MybatisUtils@equals(ogTpCd, 'ALL')">
                   AND OG_TP_CD  = #{ogTpCd}   /*조직유형*/
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(sellTpCd) and !@MybatisUtils@equals(sellTpCd, 'ALL')">
                   AND SELL_TP_CD = #{sellTpCd}   /*판매유형*/
                        <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                        AND SELL_TP_DTL_CD = #{sellTpDtlCd}   /*판매유형상세*/
                        </if>
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(pdHclsfId) and !@MybatisUtils@equals(pdHclsfId, 'ALL')">
                   AND PD_HCLSF_ID = #{pdHclsfId}     /*상품대분류*/
                        <if test="@MybatisUtils@isNotEmpty(pdMclsfId) and !@MybatisUtils@equals(pdMclsfId, 'ALL')">
                   AND PD_MCLSF_ID = #{pdMclsfId}   /*상품중분류*/
                        </if>
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(piaCsYn) and !@MybatisUtils@equals(piaCsYn, 'ALL')">
                   AND PIA_CS_YN = #{piaCsYn}  /*선급대상여부*/
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                   AND CNTR_NO   = #{cntrNo}   /*계약번호*/
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                   AND CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                    </if>
                  GROUP BY CNTR_NO
                      , CNTR_SN
                      , OG_TP_CD
                      , SELL_TP_CD
                      , SELL_TP_DTL_CD
                      , BASE_YM
                      , FEE_OC_YM
                      , PIA_CS_YN
                      , CNTR_PD_ENDDT
                 UNION ALL
                 /*선급비대상건*/
                SELECT T2.OG_TP_CD  /*조직유형코드*/
                     , T4.SELL_TP_CD  /*판매유형코드*/
                     , T4.SELL_TP_DTL_CD  /*판매유형상세*/
                     , '' AS PD_HCLSF_NM   /*상품대분류*/
                     , '' AS PD_MCLSF_NM    /*상품중분류*/
                     , T2.BASE_YM   /*기준년월*/
                     , MIN(T4.SL_AMT) AS SL_AMT      /*매출금액*/
                     , SUM(T2.FEE_CTR_CNFM_AMT) AS FEE_OC_AMT   /*수수료발생금액*/
                     , T2.OJ_DSB_YM AS FEE_OC_YM    /*수수료발생년월*/
                     , 'N' AS PIA_CS_YN    /*선급대상여부*/
                     , 0 AS PIA_SELL_FEE_CRDOVR_RES_AMT
                     , 0 AS PIA_FEE_OC_AMT
                     , 0 AS CS_RPLC_AMT
                     , 0 AS CS_RPLC_AMT_CANC_BLAM
                     , SUM(T2.FEE_CTR_CNFM_AMT) AS TTRM_CS_AMT
                     , 0 AS PIA_FEE_EOT_BLAM  /*선급수수료기말잔액. 취소된 경우는 0*/
                  FROM TB_FEAM_FEE_CALC_CNTR_DTL_IZ T2  /*수수료계산계약상세내역*/
            INNER JOIN TB_FEAM_FEE_BASE_DTL T3 /*수수료기준상세*/
                    ON T2.FEE_CD = T3.FEE_CD
                   AND T2.BASE_YM BETWEEN T3.APY_STRT_YM AND T3.APY_END_YM
            INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS T4
                    ON T2.CNTR_NO = T4.CNTR_NO
                   AND T2.CNTR_SN = T4.CNTR_SN
                   AND T2.BASE_YM = SUBSTR(T4.SL_RCOG_DT, 1, 6)  /*매출월이랑 수수료기준년월 */
                 WHERE 1 = 1
                   AND T2.BASE_YM = #{baseYm}
                   AND T2.FEE_TCNT_DV_CD = '01'
                   AND T2.FEE_CALC_TP_CD = '01' -- 수수료
                   AND T3.PIA_FEE_OJ_YN = 'N'
                   AND T4.SELL_TP_DTL_CD IN ('11','12','13','22','24','25','26','34')  /*선급비대상 판매유형상세 - WELLS만 해당*/
                    <if test="@MybatisUtils@isNotEmpty(ogTpCd) and !@MybatisUtils@equals(ogTpCd, 'ALL')">
                   AND T2.OG_TP_CD      = #{ogTpCd}   /*조직유형*/
                    </if>
                   AND T3.PIA_FEE_OJ_YN <![CDATA[<>]]> 'Y'     /*선급대상 Y가 아닌거. (웰스는 판매유형 더 뒤져야함)*/
                    <if test="@MybatisUtils@isNotEmpty(piaCsYn) and !@MybatisUtils@equals(piaCsYn, 'ALL')">
                   AND T3.PIA_FEE_OJ_YN = #{piaCsYn}     /*Y가 들어오더라도 바로위의조건에서 걸려서 안나옴. N 인건이나 전체일떄만 나오게함*/
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(sellTpCd) and !@MybatisUtils@equals(sellTpCd, 'ALL')">
                   AND T4.SELL_TP_CD = #{sellTpCd}   /*판매유형*/
                        <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                   AND T4.SELL_TP_DTL_CD = #{sellTpDtlCd}   /*판매유형상세*/
                        </if>
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(pdHclsfId) and !@MybatisUtils@equals(pdHclsfId, 'ALL')">
                   AND T4.PD_HCLSF_ID = #{pdHclsfId}     /*상품대분류*/
                        <if test="@MybatisUtils@isNotEmpty(pdMclsfId) and !@MybatisUtils@equals(pdMclsfId, 'ALL')">
                   AND T4.PD_MCLSF_ID = #{pdMclsfId}   /*상품중분류*/
                        </if>
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                   AND T2.CNTR_NO   = #{cntrNo}   /*계약번호*/
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                   AND T2.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(feeCd) and !@MybatisUtils@equals(feeCd, 'ALL')">
                   AND T2.FEE_CD    = #{feeCd}    /*수수료코드(구분)*/
                    </if>
                 GROUP BY T2.CNTR_NO
                     , T2.CNTR_SN
                     , T2.OG_TP_CD
                     , T4.SELL_TP_CD
                     , T4.SELL_TP_DTL_CD
                     , T2.BASE_YM
                     , T2.OJ_DSB_YM
             )
      GROUP BY OG_TP_CD     /*조직유형코드*/
             , SELL_TP_CD   /*판매유형*/
             , SELL_TP_DTL_CD /*판매유형상세*/
             , PD_HCLSF_NM
             , PD_MCLSF_NM
             , BASE_YM      /*기준년월*/
             , FEE_OC_YM    /*수수료발생년월*/
             , PIA_CS_YN    /*선급대상여부*/
         ORDER BY OG_TP_CD
             , SELL_TP_CD
             , SELL_TP_DTL_CD
    </select>

    <select id="selectAggregateSummary" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbAdvancedSellFeeReplaceDto$SearchAggregateSummaryRes">
        SELECT SUM(SL_AMT) AS SL_AMT /*매출금액*/
             , SUM(FEE_OC_AMT) AS FEE_OC_AMT /*수수료발생금액*/
             , PIA_CS_YN /*선급대상여부*/
             , SUM(PIA_SELL_FEE_CRDOVR_RES_AMT) AS PIA_SELL_FEE_CRDOVR_RES_AMT /*선급판매수수료이월잔액*/
             , SUM(PIA_FEE_OC_AMT) AS PIA_FEE_OC_AMT /*선급수수료발생금액 - 이테이블의 금액은 모두 선급대상*/
             , SUM(CS_RPLC_AMT) AS CS_RPLC_AMT /*비용대체금액:종료일이 없거나, 해당월 종료가 아닌 경우 대상*/
             , SUM(CS_RPLC_AMT_CANC_BLAM) AS CS_RPLC_AMT_CANC_BLAM /*비용대체금액 (취소분 잔액) - 취소건 선급잔액 */
             , SUM(CS_RPLC_AMT + CS_RPLC_AMT_CANC_BLAM) AS TTRM_CS_AMT /*당기비용인식액 - 취소인경우 전체 선급수수료발생금액에서 비용대체누계금액을 빼면 남은 수수료금액. 정상경우는 이번달 비용대체금액 */
             , SUM(PIA_SELL_FEE_CRDOVR_RES_AMT + PIA_FEE_OC_AMT - CS_RPLC_AMT - CS_RPLC_AMT_CANC_BLAM) AS PIA_FEE_EOT_BLAM /*선급수수료기말잔액. 취소된 경우는 0*/
          FROM (
                SELECT BASE_YM
                     , OG_TP_CD
                     , SELL_TP_CD
                     , SELL_TP_DTL_CD
                     , PD_HCLSF_ID
                     , PD_MCLSF_ID
                     , PIA_CS_YN
                     , CNTR_NO
                     , CNTR_SN
                     , MIN(SL_AMT) AS SL_AMT
                     , SUM(FEE_OC_AMT) AS FEE_OC_AMT
                     , SUM(PIA_SELL_FEE_CRDOVR_RES_AMT) AS PIA_SELL_FEE_CRDOVR_RES_AMT
                     , SUM(FEE_OC_AMT) AS PIA_FEE_OC_AMT
                     , CASE WHEN CNTR_PD_ENDDT IS NULL OR SUBSTR(CNTR_PD_ENDDT,1,6) != #{baseYm} THEN SUM(CS_RPLC_AMT)
                            ELSE 0 END AS CS_RPLC_AMT
                     , CASE WHEN SUBSTR(CNTR_PD_ENDDT,1,6) = #{baseYm} THEN SUM(CS_RPLC_AMT)
                            ELSE 0 END AS CS_RPLC_AMT_CANC_BLAM
                  FROM TB_CBCL_PIA_FEE_CS_RPLC_BAS A1 /*선급판매수수료 비용대체기본*/
                  WHERE FEE_TCNT = #{feeTcnt}
                  GROUP BY CNTR_NO
                     , CNTR_SN
                     , BASE_YM
                     , OG_TP_CD
                     , SELL_TP_CD
                     , SELL_TP_DTL_CD
                     , PD_HCLSF_ID
                     , PD_MCLSF_ID
                     , PIA_CS_YN
                     , CNTR_PD_ENDDT
               ) T1
         WHERE BASE_YM   = #{baseYm}   /*기준년월*/
            <if test="@MybatisUtils@isNotEmpty(ogTpCd) and !@MybatisUtils@equals(ogTpCd, 'ALL')">
           AND OG_TP_CD  = #{ogTpCd}   /*조직유형*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(sellTpCd) and !@MybatisUtils@equals(sellTpCd, 'ALL')">
           AND SELL_TP_CD = #{sellTpCd}   /*판매유형*/
                <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
           AND SELL_TP_DTL_CD = #{sellTpDtlCd}   /*판매유형상세*/
                </if>
            </if>
            <if test="@MybatisUtils@isNotEmpty(pdHclsfId) and !@MybatisUtils@equals(pdHclsfId, 'ALL')">
           AND PD_HCLSF_ID = #{pdHclsfId}     /*상품대분류*/
                <if test="@MybatisUtils@isNotEmpty(pdMclsfId) and !@MybatisUtils@equals(pdMclsfId, 'ALL')">
           AND PD_MCLSF_ID = #{pdMclsfId}   /*상품중분류*/
                </if>
            </if>
            <if test="@MybatisUtils@isNotEmpty(piaCsYn) and !@MybatisUtils@equals(piaCsYn, 'ALL')">
           AND PIA_CS_YN = #{piaCsYn}  /*선급대상여부*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(cntrNo)">
           AND CNTR_NO   = #{cntrNo}   /*계약번호*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(cntrSn)">
           AND CNTR_SN   = #{cntrSn}   /*계약상세번호*/
            </if>
         GROUP BY PIA_CS_YN
         UNION ALL
      /*선급비대상건*/
        SELECT SUM(SL_AMT) AS SL_AMT
             , SUM(FEE_OC_AMT) AS FEE_OC_AMT
             , 'N' AS PIA_CS_YN
             , 0 AS PIA_SELL_FEE_CRDOVR_RES_AMT
             , 0 AS PIA_FEE_OC_AMT
             , 0 AS CS_RPLC_AMT
             , 0 AS CS_RPLC_AMT_CANC_BLAM
             , SUM(TTRM_CS_AMT) AS TTRM_CS_AMT
             , 0 AS PIA_FEE_EOT_BLAM
          FROM (
                SELECT NVL(MAX(T4.SL_AMT),0) AS SL_AMT     /*매출금액*/
                     , NVL(SUM(T2.FEE_CTR_CNFM_AMT),0) AS FEE_OC_AMT   /*수수료발생금액*/
                     , 'N' AS PIA_CS_YN    /*선급대상여부*/
                     , 0 AS PIA_SELL_FEE_CRDOVR_RES_AMT
                     , 0 AS PIA_FEE_OC_AMT
                     , 0 AS CS_RPLC_AMT
                     , 0 AS CS_RPLC_AMT_CANC_BLAM
                     , NVL(SUM(T2.FEE_CTR_CNFM_AMT),0) AS TTRM_CS_AMT
                     , 0 AS PIA_FEE_EOT_BLAM  /*선급수수료기말잔액. 취소된 경우는 0*/
                  FROM TB_FEAM_FEE_CALC_CNTR_DTL_IZ T2  /*수수료계산계약상세내역*/
                 INNER JOIN TB_FEAM_FEE_BASE_DTL T3 /*수수료기준상세*/
                    ON T2.FEE_CD = T3.FEE_CD
                   AND T2.BASE_YM BETWEEN T3.APY_STRT_YM AND T3.APY_END_YM
                 INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS T4
                    ON T2.CNTR_NO = T4.CNTR_NO
                   AND T2.CNTR_SN = T4.CNTR_SN
                   AND T2.BASE_YM = SUBSTR(T4.SL_RCOG_DT, 1, 6)  /*매출월이랑 수수료기준년월 */
                 WHERE 1 = 1
                   AND T2.BASE_YM = #{baseYm}
                   AND T2.FEE_TCNT_DV_CD = '01'
                   AND T2.FEE_CALC_TP_CD = '01' -- 수수료
                   AND T3.PIA_FEE_OJ_YN = 'N'
                   AND T4.SELL_TP_DTL_CD IN ('11','12','13','22','24','25','26','34')  /*선급비대상 판매유형상세 - WELLS만 해당*/
                <if test="@MybatisUtils@isNotEmpty(ogTpCd) and !@MybatisUtils@equals(ogTpCd, 'ALL')">
                   AND T2.OG_TP_CD = #{ogTpCd}   /*조직유형*/
                </if>
                   AND T3.PIA_FEE_OJ_YN <![CDATA[<>]]> 'Y'     /*선급대상 Y가 아닌거. (웰스는 판매유형 더 뒤져야함)*/
                <if test="@MybatisUtils@isNotEmpty(piaCsYn) and !@MybatisUtils@equals(piaCsYn, 'ALL')">
                   AND T3.PIA_FEE_OJ_YN = #{piaCsYn}     /*Y가 들어오더라도 바로위의조건에서 걸려서 안나옴. N 인건이나 전체일떄만 나오게함*/
                </if>
                <if test="@MybatisUtils@isNotEmpty(sellTpCd) and !@MybatisUtils@equals(sellTpCd, 'ALL')">
                   AND T4.SELL_TP_CD = #{sellTpCd}   /*판매유형*/
                    <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                   AND T4.SELL_TP_DTL_CD = #{sellTpDtlCd}   /*판매유형상세*/
                    </if>
                </if>
                <if test="@MybatisUtils@isNotEmpty(pdHclsfId) and !@MybatisUtils@equals(pdHclsfId, 'ALL')">
                   AND T4.PD_HCLSF_ID = #{pdHclsfId}     /*상품대분류*/
                    <if test="@MybatisUtils@isNotEmpty(pdMclsfId) and !@MybatisUtils@equals(pdMclsfId, 'ALL')">
                   AND T4.PD_MCLSF_ID = #{pdMclsfId}   /*상품중분류*/
                    </if>
                 </if>
                <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                   AND T2.CNTR_NO   = #{cntrNo}   /*계약번호*/
                </if>
                <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                   AND T2.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                </if>
                <if test="@MybatisUtils@isNotEmpty(feeCd) and !@MybatisUtils@equals(feeCd, 'ALL')">
                   AND T2.FEE_CD    = #{feeCd}    /*수수료코드(구분)*/
                </if>
                GROUP BY T2.CNTR_NO
                    , T2.CNTR_SN
               ) X
    </select>

    <select id="selectDtlLists" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbAdvancedSellFeeReplaceDto$SearchRes" fetchSize="5000">
        SELECT OG_TP_CD  /*조직유형코드*/
             , SELL_TP_CD  /*판매유형코드*/
             , SELL_TP_DTL_CD  /*판매유형상세*/
             , (SELECT MAX(PD_CLSF_NM) FROM TB_PDBS_PD_CLSF_BAS WHERE PD_CLSF_ID = T1.PD_HCLSF_ID) AS PD_HCLSF_NM   /*상품대분류*/
             , (SELECT MAX(PD_CLSF_NM) FROM TB_PDBS_PD_CLSF_BAS WHERE PD_CLSF_ID = T1.PD_MCLSF_ID) AS PD_MCLSF_NM    /*상품중분류*/
             , BASE_YM   /*기준년월*/
             , CNTR_NO || '-' || CNTR_SN AS CNTR_NO  /*계약상세번호*/
             , (SELECT MAX(PD_CD) FROM TB_CBCL_WELLS_SL_CNFM_BAS WHERE CNTR_NO = T1.CNTR_NO AND CNTR_SN = T1.CNTR_SN) AS PD_CD  /*상품코드*/
             , (SELECT MAX(PD_NM) FROM TB_PDBS_PD_BAS WHERE PD_CD = (SELECT MAX(PD_CD) FROM TB_CBCL_WELLS_SL_CNFM_BAS WHERE CNTR_NO = T1.CNTR_NO AND CNTR_SN = T1.CNTR_SN)) AS PD_NM /*상품명*/
             , FEE_OC_AMT   /*수수료발생금액*/
             , PIA_CS_YN    /*선급대상여부*/
             , FEE_OC_YM    /*수수료발생년월*/
             , FEE_OC_AMT AS PIA_FEE_OC_AMT  /*선급수수료발생금액 - 이테이블의 금액은 모두 선급대상*/
             , SL_RCOG_DT  /*매출일자*/
             , STPL_TN AS PASG_TN    /*경과회차*/
             , (SELECT X.STPL_PTRM FROM TB_SSCT_CNTR_DTL X WHERE X.CNTR_NO = T1.CNTR_NO AND X.CNTR_SN = T1.CNTR_SN) AS STPL_TN  /*약정회차*/
             , SL_AMT      /*매출금액*/
             , CNTR_PD_ENDDT  /*계약상품종료일자 - 계약취소일자 (계약취소인지 매출취소인지는 확정을 해야함 서비스에서 정해서 값을 내릴것임.*/
             , CS_RPLC_YM     /*비용대체년월*/
             , CS_RPLC_AMT    /*비용대체금액*/
             , CASE WHEN 'N' = #{feeChk}   /*수수료구분 상세에 미체크 했을때 수수료코드 안보여줄것임 */
                    THEN ''
                    ELSE (SELECT SRN_MARK_FEE_NM FROM TB_FEAM_FEE_BASE_DTL
                          WHERE FEE_CD = T1.FEE_CD
                          AND FEE_BASE_STAT_CD = '02'
                          AND T1.BASE_YM BETWEEN APY_STRT_YM AND APY_END_YM
                          AND ROWNUM = 1) END AS FEE_NM        /*수수료코드(구분)*/
             , DP_SLIP_TRS_NO  /*입금전표전송번호*/
             , SAP_SLPNO       /*선급판매수수료전표번호*/
             , CS_RPLC_AMT AS TTRM_CS_AMT  /*당기비용인식액 - 취소인경우 전체 선급수수료발생금액에서 비용대체누계금액을 빼면 남은 수수료금액. 정상경우는 이번달 비용대체금액 */
             , CS_RPLC_AGG_AMT   /*비용대체누계금액*/
             , PIA_SELL_FEE_CRDOVR_RES_AMT + FEE_OC_AMT - CS_RPLC_AMT AS PIA_FEE_EOT_BLAM  /*선급수수료기말잔액. 취소된 경우는 0*/
             , SUBSTR(FNL_MDFC_DTM,1,8) AS FNL_MDFC_DTM  /*처리일자*/
             , (SELECT MAX(USR_NM) FROM T_CMP_USR_ACO_M WHERE USR_ID = T1.FNL_MDFC_USR_ID) AS USR_NM  /*사용자명*/
          FROM TB_CBCL_PIA_FEE_CS_RPLC_BAS T1 /*선급판매수수료 비용대체기본*/
         WHERE BASE_YM   = #{baseYm}   /*기준년월*/
           AND FEE_TCNT = #{feeTcnt}
           <if test="@MybatisUtils@isNotEmpty(ogTpCd) and !@MybatisUtils@equals(ogTpCd, 'ALL')">
           AND OG_TP_CD  = #{ogTpCd}   /*조직유형*/
           </if>
           <if test="@MybatisUtils@isNotEmpty(sellTpCd) and !@MybatisUtils@equals(sellTpCd, 'ALL')">
           AND SELL_TP_CD = #{sellTpCd}   /*판매유형*/
               <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
               AND SELL_TP_DTL_CD = #{sellTpDtlCd}   /*판매유형상세*/
               </if>
           </if>
           <if test="@MybatisUtils@isNotEmpty(pdHclsfId) and !@MybatisUtils@equals(pdHclsfId, 'ALL')">
           AND PD_HCLSF_ID = #{pdHclsfId}     /*상품대분류*/
               <if test="@MybatisUtils@isNotEmpty(pdMclsfId) and !@MybatisUtils@equals(pdMclsfId, 'ALL')">
               AND PD_MCLSF_ID = #{pdMclsfId}   /*상품중분류*/
               </if>
           </if>
           <if test="@MybatisUtils@isNotEmpty(piaCsYn) and !@MybatisUtils@equals(piaCsYn, 'ALL')">
           AND PIA_CS_YN = #{piaCsYn}  /*선급대상여부*/
           </if>
           <if test="@MybatisUtils@isNotEmpty(cntrNo)">
           AND CNTR_NO   = #{cntrNo}   /*계약번호*/
           </if>
           <if test="@MybatisUtils@isNotEmpty(cntrSn)">
           AND CNTR_SN   = #{cntrSn}   /*계약상세번호*/
           </if>
           <if test="@MybatisUtils@isNotEmpty(feeCd) and !@MybatisUtils@equals(feeCd, 'ALL')">
           AND FEE_CD    = #{feeCd}    /*수수료코드(구분)*/
           </if>
        UNION ALL
        /*선급비대상건*/
        SELECT T2.OG_TP_CD  /*조직유형코드*/
             , T4.SELL_TP_CD  /*판매유형코드*/
             , T4.SELL_TP_DTL_CD  /*판매유형상세*/
             , (SELECT MAX(PD_CLSF_NM) FROM TB_PDBS_PD_CLSF_BAS WHERE PD_CLSF_ID = T4.PD_HCLSF_ID) AS PD_HCLSF_NM   /*상품대분류*/
             , (SELECT MAX(PD_CLSF_NM) FROM TB_PDBS_PD_CLSF_BAS WHERE PD_CLSF_ID = T4.PD_MCLSF_ID) AS PD_MCLSF_NM    /*상품중분류*/
             , T2.BASE_YM   /*기준년월*/
             , T2.CNTR_NO || '-' || T2.CNTR_SN AS CNTR_NO  /*계약상세번호*/
             , (SELECT MAX(PD_CD) FROM TB_CBCL_WELLS_SL_CNFM_BAS WHERE CNTR_NO = T2.CNTR_NO AND CNTR_SN = T2.CNTR_SN) AS PD_CD  /*상품코드*/
             , (SELECT MAX(PD_NM) FROM TB_PDBS_PD_BAS WHERE PD_CD = (SELECT MAX(PD_CD) FROM TB_CBCL_WELLS_SL_CNFM_BAS WHERE CNTR_NO = T2.CNTR_NO AND CNTR_SN = T2.CNTR_SN) ) AS PD_NM /*상품명*/
             , T2.FEE_CTR_CNFM_AMT AS FEE_OC_AMT   /*수수료발생금액*/
             , 'N' AS PIA_CS_YN    /*선급대상여부*/
             , T2.OJ_DSB_YM AS FEE_OC_YM    /*수수료발생년월*/
             , 0  AS PIA_FEE_OC_AMT  /*선급수수료발생금액 - 이테이블의 금액은 모두 선급대상*/
             , '' AS SL_RCOG_DT  /*매출일자*/
             , 0  AS PASG_TN     /*경과회차*/
             , 0  AS STPL_TN     /*약정회차*/
             , 0  AS SL_AMT      /*매출금액*/
             , '' AS CNTR_PD_ENDDT  /*계약상품종료일자 - 계약취소일자 (계약취소인지 매출취소인지는 확정을 해야함 서비스에서 정해서 값을 내릴것임.*/
             , '' AS CS_RPLC_YM     /*비용대체년월*/
             , 0 AS CS_RPLC_AMT    /*비용대체금액*/
             , CASE WHEN 'N' = #{feeChk}   /*수수료구분 상세에 미체크 했을때 */
                    THEN ''
                    ELSE (SELECT SRN_MARK_FEE_NM FROM TB_FEAM_FEE_BASE_DTL
                          WHERE FEE_CD = T2.FEE_CD
                          AND FEE_BASE_STAT_CD = '02'
                          AND T2.BASE_YM BETWEEN APY_STRT_YM AND APY_END_YM
                          AND ROWNUM = 1) END  AS FEE_NM        /*수수료코드(구분)*/
             , '' AS DP_SLIP_TRS_NO  /*입금전표전송번호*/
             , '' AS SAP_SLPNO       /*선급판매수수료전표번호*/
             , T2.FEE_CTR_CNFM_AMT  AS TTRM_CS_AMT  /*당기비용인식액 - 취소인경우 전체 선급수수료발생금액에서 비용대체누계금액을 빼면 남은 수수료금액. 정상경우는 이번달 비용대체금액 */
             , 0 AS CS_RPLC_AGG_AMT   /*비용대체누계금액*/
             , 0 AS PIA_FEE_EOT_BLAM  /*선급수수료기말잔액. 취소된 경우는 0*/
             , SUBSTR(T2.FNL_MDFC_DTM,1,8) AS FNL_MDFC_DTM  /*처리일자*/
             , (SELECT MAX(USR_NM) FROM T_CMP_USR_ACO_M WHERE USR_ID = T2.FNL_MDFC_USR_ID) AS USR_NM  /*사용자명*/
          FROM TB_FEAM_FEE_CALC_CNTR_DTL_IZ T2  /*수수료계산계약상세내역*/
    INNER JOIN TB_FEAM_FEE_BASE_DTL T3 /*수수료기준상세*/
            ON T2.FEE_CD = T3.FEE_CD
           AND T2.BASE_YM BETWEEN T3.APY_STRT_YM AND T3.APY_END_YM
    INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS T4
            ON T2.CNTR_NO = T4.CNTR_NO
           AND T2.CNTR_SN = T4.CNTR_SN
           AND T2.BASE_YM = SUBSTR(T4.SL_RCOG_DT, 1, 6)  /*매출월이랑 수수료기준년월 */
         WHERE 1 = 1
           AND T2.BASE_YM = #{baseYm}
           AND T2.FEE_TCNT_DV_CD = '01'
           AND T2.FEE_CALC_TP_CD = '01' -- 수수료
           AND T3.PIA_FEE_OJ_YN = 'N'
           AND T4.SELL_TP_DTL_CD IN ('11','12','13','22','24','25','26','34')  /*선급비대상 판매유형상세 - WELLS만 해당*/
           <if test="@MybatisUtils@isNotEmpty(ogTpCd) and !@MybatisUtils@equals(ogTpCd, 'ALL')">
           AND T2.OG_TP_CD  = #{ogTpCd}   /*조직유형*/
           </if>
           AND T3.PIA_FEE_OJ_YN <![CDATA[<>]]> 'Y'     /*선급대상 Y가 아닌거. (웰스는 판매유형 더 뒤져야함)*/
           <if test="@MybatisUtils@isNotEmpty(piaCsYn) and !@MybatisUtils@equals(piaCsYn, 'ALL')">
           AND T3.PIA_FEE_OJ_YN = #{piaCsYn}     /*Y가 들어오더라도 바로위의조건에서 걸려서 안나옴. N 인건이나 전체일떄만 나오게함*/
           </if>
           <if test="@MybatisUtils@isNotEmpty(sellTpCd) and !@MybatisUtils@equals(sellTpCd, 'ALL')">
           AND T4.SELL_TP_CD = #{sellTpCd}   /*판매유형*/
               <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
               AND T4.SELL_TP_DTL_CD = #{sellTpDtlCd}   /*판매유형상세*/
               </if>
           </if>
           <if test="@MybatisUtils@isNotEmpty(pdHclsfId) and !@MybatisUtils@equals(pdHclsfId, 'ALL')">
           AND T4.PD_HCLSF_ID = #{pdHclsfId}     /*상품대분류*/
               <if test="@MybatisUtils@isNotEmpty(pdMclsfId) and !@MybatisUtils@equals(pdMclsfId, 'ALL')">
               AND T4.PD_MCLSF_ID = #{pdMclsfId}   /*상품중분류*/
               </if>
           </if>
           <if test="@MybatisUtils@isNotEmpty(cntrNo)">
           AND T2.CNTR_NO   = #{cntrNo}   /*계약번호*/
           </if>
           <if test="@MybatisUtils@isNotEmpty(cntrSn)">
           AND T2.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
           </if>
           <if test="@MybatisUtils@isNotEmpty(feeCd) and !@MybatisUtils@equals(feeCd, 'ALL')">
           AND T2.FEE_CD    = #{feeCd}    /*수수료코드(구분)*/
           </if>
    </select>

    <select id="selectDtlSummary" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbAdvancedSellFeeReplaceDto$SearchDtlSummaryRes">
         SELECT PIA_CS_YN    /*선급대상여부*/
              , '' AS SL_AMT     /*매출금액*/
              , NVL(SUM(CS_RPLC_AMT), 0) AS CS_RPLC_AMT    /*비용대체금액*/
              , NVL(SUM(FEE_OC_AMT), 0) AS FEE_OC_AMT
              , NVL(SUM(FEE_OC_AMT), 0) AS PIA_FEE_OC_AMT
              , NVL(SUM(CS_RPLC_AMT), 0)  AS TTRM_CS_AMT  /*당기비용인식액 - 취소인경우 전체 선급수수료발생금액에서 비용대체누계금액을 빼면 남은 수수료금액. 정상경우는 이번달 비용대체금액 */
              , NVL(SUM(CS_RPLC_AGG_AMT), 0) AS CS_RPLC_AGG_AMT   /*비용대체누계금액*/
              , NVL(SUM(FEE_OC_AMT), 0) + NVL(SUM(PIA_SELL_FEE_CRDOVR_RES_AMT), 0) - NVL(SUM(CS_RPLC_AMT), 0) AS PIA_FEE_EOT_BLAM  /*선급수수료기말잔액. 취소된 경우는 0*/
           FROM TB_CBCL_PIA_FEE_CS_RPLC_BAS T1 /*선급판매수수료 비용대체기본*/
          WHERE BASE_YM   = #{baseYm}   /*기준년월*/
            AND FEE_TCNT = #{feeTcnt}
            <if test="@MybatisUtils@isNotEmpty(ogTpCd) and !@MybatisUtils@equals(ogTpCd, 'ALL')">
            AND OG_TP_CD  = #{ogTpCd}   /*조직유형*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(sellTpCd) and !@MybatisUtils@equals(sellTpCd, 'ALL')">
            AND SELL_TP_CD = #{sellTpCd}   /*판매유형*/
                <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                AND SELL_TP_DTL_CD = #{sellTpDtlCd}   /*판매유형상세*/
                </if>
            </if>
            <if test="@MybatisUtils@isNotEmpty(pdHclsfId) and !@MybatisUtils@equals(pdHclsfId, 'ALL')">
            AND PD_HCLSF_ID = #{pdHclsfId}     /*상품대분류*/
                <if test="@MybatisUtils@isNotEmpty(pdMclsfId) and !@MybatisUtils@equals(pdMclsfId, 'ALL')">
                AND PD_MCLSF_ID = #{pdMclsfId}   /*상품중분류*/
                </if>
            </if>
            <if test="@MybatisUtils@isNotEmpty(piaCsYn) and !@MybatisUtils@equals(piaCsYn, 'ALL')">
            AND PIA_CS_YN = #{piaCsYn}  /*선급대상여부*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(cntrNo)">
            AND CNTR_NO   = #{cntrNo}   /*계약번호*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(cntrSn)">
            AND CNTR_SN   = #{cntrSn}   /*계약상세번호*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(feeCd) and !@MybatisUtils@equals(feeCd, 'ALL')">
            AND FEE_CD    = #{feeCd}    /*수수료코드(구분)*/
            </if>
       GROUP BY PIA_CS_YN
       UNION ALL
       /*선급비대상건*/
       SELECT 'N' AS PIA_CS_YN    /*선급대상여부*/
            , '' AS SL_AMT      /*매출금액*/
            , 0 AS CS_RPLC_AMT    /*비용대체금액*/
            , NVL(SUM(T2.FEE_CTR_CNFM_AMT),0) AS FEE_OC_AMT  /*수수료발생금액*/
            , 0 AS PIA_FEE_OC_AMT
            , NVL(SUM(T2.FEE_CTR_CNFM_AMT),0) AS TTRM_CS_AMT  /*당기비용인식액 - 취소인경우 전체 선급수수료발생금액에서 비용대체누계금액을 빼면 남은 수수료금액. 정상경우는 이번달 비용대체금액 */
            , 0 AS CS_RPLC_AGG_AMT   /*비용대체누계금액*/
            , 0 AS PIA_FEE_EOT_BLAM  /*선급수수료기말잔액. 취소된 경우는 0*/
         FROM TB_FEAM_FEE_CALC_CNTR_DTL_IZ T2  /*수수료계산계약상세내역*/
   INNER JOIN TB_FEAM_FEE_BASE_DTL T3 /*수수료기준상세*/
           ON T2.FEE_CD = T3.FEE_CD
          AND T2.BASE_YM BETWEEN T3.APY_STRT_YM AND T3.APY_END_YM
   INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS T4
           ON T2.CNTR_NO = T4.CNTR_NO
          AND T2.CNTR_SN = T4.CNTR_SN
          AND T2.BASE_YM = SUBSTR(T4.SL_RCOG_DT, 1, 6)  /*매출월이랑 수수료기준년월 */
        WHERE 1 = 1
          AND T2.BASE_YM = #{baseYm}
          AND T2.FEE_TCNT_DV_CD = '01'
          AND T2.FEE_CALC_TP_CD = '01' -- 수수료
          AND T3.PIA_FEE_OJ_YN = 'N'
          AND T4.SELL_TP_DTL_CD IN ('11','12','13','22','24','25','26','34')  /*선급비대상 판매유형상세 - WELLS만 해당*/
          <if test="@MybatisUtils@isNotEmpty(ogTpCd) and !@MybatisUtils@equals(ogTpCd, 'ALL')">
          AND T2.OG_TP_CD  = #{ogTpCd}   /*조직유형*/
          </if>
          AND T3.PIA_FEE_OJ_YN <![CDATA[<>]]> 'Y'     /*선급대상 Y가 아닌거. (웰스는 판매유형 더 뒤져야함)*/
          <if test="@MybatisUtils@isNotEmpty(piaCsYn) and !@MybatisUtils@equals(piaCsYn, 'ALL')">
          AND T3.PIA_FEE_OJ_YN = #{piaCsYn}     /*Y가 들어오더라도 바로위의조건에서 걸려서 안나옴. N 인건이나 전체일떄만 나오게함*/
          </if>
          <if test="@MybatisUtils@isNotEmpty(sellTpCd) and !@MybatisUtils@equals(sellTpCd, 'ALL')">
          AND T4.SELL_TP_CD = #{sellTpCd}   /*판매유형*/
              <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
              AND T4.SELL_TP_DTL_CD = #{sellTpDtlCd}   /*판매유형상세*/
              </if>
          </if>
          <if test="@MybatisUtils@isNotEmpty(pdHclsfId) and !@MybatisUtils@equals(pdHclsfId, 'ALL')">
          AND T4.PD_HCLSF_ID     = #{pdHclsfId}     /*상품대분류*/
              <if test="@MybatisUtils@isNotEmpty(pdMclsfId) and !@MybatisUtils@equals(pdMclsfId, 'ALL')">
              AND T4.PD_MCLSF_ID = #{pdMclsfId}   /*상품중분류*/
              </if>
          </if>
          <if test="@MybatisUtils@isNotEmpty(cntrNo)">
          AND T2.CNTR_NO = #{cntrNo}   /*계약번호*/
          </if>
          <if test="@MybatisUtils@isNotEmpty(cntrSn)">
          AND T2.CNTR_SN = #{cntrSn}   /*계약상세번호*/
          </if>
          <if test="@MybatisUtils@isNotEmpty(feeCd) and !@MybatisUtils@equals(feeCd, 'ALL')">
          AND T2.FEE_CD  = #{feeCd}    /*수수료코드(구분)*/
          </if>
    </select>

    <select id="selectDivideLists" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbAdvancedSellFeeReplaceDto$SearchDivideRes">
        WITH T AS
            (
            SELECT CNTR_NO, CNTR_SN
                  ,SELL_TP_CD  /*판매유형*/
                  ,SELL_TP_DTL_CD  /*판매유형상세*/
                  ,(SELECT MAX(PD_CLSF_NM) FROM TB_PDBS_PD_CLSF_BAS WHERE PD_CLSF_ID = T1.PD_HCLSF_ID) AS PD_HCLSF_NM   /*상품대분류*/
                  ,(SELECT MAX(PD_CLSF_NM) FROM TB_PDBS_PD_CLSF_BAS WHERE PD_CLSF_ID = T1.PD_MCLSF_ID) AS PD_MCLSF_NM   /*상품중분류*/
                  ,BASE_YM      /*기준년월*/
                  ,FEE_OC_YM    /*수수료발생년월*/
                  ,NVL(SUM(PIA_SELL_FEE_CRDOVR_RES_AMT),0) AS PIA_SELL_FEE_CRDOVR_BLAM   /*선급판매수수료이월잔액*/
                  ,NVL(SUM(FEE_OC_AMT),0)  AS PIA_FEE_OC_AMT  /*선급수수료발생금액*/
                  ,NVL(SUM(CS_RPLC_AMT),0) AS CS_RPLC_AMT             /*비용대체금액*/
                  ,NVL(SUM(CS_RPLC_BLAM),0) AS PIA_FEE_EOT_BLAM    /*비용대체잔액*/
              FROM TB_CBCL_PIA_FEE_CS_RPLC_BAS T1
             WHERE 1=1
             AND FEE_TCNT = #{feeTcnt}
             <if test="@MybatisUtils@isNotEmpty(ogTpCd) and !@MybatisUtils@equals(ogTpCd, 'ALL')">
             AND OG_TP_CD  = #{ogTpCd}   /*조직유형*/
             </if>
             <if test="@MybatisUtils@isNotEmpty(piaCsYn) and !@MybatisUtils@equals(piaCsYn, 'ALL')">
             AND PIA_CS_YN = #{piaCsYn}  /*선급대상여부*/
             </if>
             <if test="@MybatisUtils@isNotEmpty(sellTpCd) and !@MybatisUtils@equals(sellTpCd, 'ALL')">
             AND SELL_TP_CD = #{sellTpCd}   /*판매유형*/
                 <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                 AND SELL_TP_DTL_CD = #{sellTpDtlCd}   /*판매유형상세*/
                 </if>
             </if>
             <if test="@MybatisUtils@isNotEmpty(pdHclsfId) and !@MybatisUtils@equals(pdHclsfId, 'ALL')">
             AND PD_HCLSF_ID = #{pdHclsfId}     /*상품대분류*/
                 <if test="@MybatisUtils@isNotEmpty(pdMclsfId) and !@MybatisUtils@equals(pdMclsfId, 'ALL')">
                 AND PD_MCLSF_ID = #{pdMclsfId}   /*상품중분류*/
                 </if>
             </if>
             <if test="@MybatisUtils@isNotEmpty(cntrNo)">
             AND CNTR_NO   = #{cntrNo}   /*계약번호*/
             </if>
             <if test="@MybatisUtils@isNotEmpty(cntrSn)">
             AND CNTR_SN   = #{cntrSn}   /*계약상세번호*/
             </if>
             <if test="@MybatisUtils@isNotEmpty(feeCd) and !@MybatisUtils@equals(feeCd, 'ALL')">
             AND FEE_CD    = #{feeCd}    /*수수료코드(구분)*/
             </if>
            GROUP BY SELL_TP_CD, SELL_TP_DTL_CD, BASE_YM, FEE_OC_YM, CNTR_NO, CNTR_SN, PD_HCLSF_ID,PD_MCLSF_ID
            )
            /*첫번째 셀렉트 - 해당년월의 이전에 발생한 수수료의 비용대체금액. 수수료는 발생하지 않은것으로 봄. */
            SELECT SELL_TP_CD
                  ,SELL_TP_DTL_CD
                  ,PD_HCLSF_NM
                  ,PD_MCLSF_NM
                  ,MAX(BF_BASE_YM) AS BASE_YM
                  ,SUM(PIA_SELL_FEE_CRDOVR_BLAM) AS PIA_SELL_FEE_CRDOVR_RES_AMT
                  ,SUM(PIA_FEE_OC_AMT) AS PIA_FEE_OC_AMT
                  ,SUM(CS_RPLC_AMT1) AS CS_RPLC_AMT1
                  ,SUM(CS_RPLC_AMT2) AS CS_RPLC_AMT2
                  ,SUM(CS_RPLC_AMT3) AS CS_RPLC_AMT3
                  ,SUM(CS_RPLC_AMT4) AS CS_RPLC_AMT4
                  ,SUM(CS_RPLC_AMT5) AS CS_RPLC_AMT5
                  ,SUM(CS_RPLC_AMT6) AS CS_RPLC_AMT6
                  ,SUM(CS_RPLC_AMT7) AS CS_RPLC_AMT7
                  ,SUM(CS_RPLC_AMT8) AS CS_RPLC_AMT8
                  ,SUM(CS_RPLC_AMT9) AS CS_RPLC_AMT9
                  ,SUM(CS_RPLC_AMT10) AS CS_RPLC_AMT10
                  ,SUM(CS_RPLC_AMT11) AS CS_RPLC_AMT11
                  ,SUM(CS_RPLC_AMT12) AS CS_RPLC_AMT12
                  ,SUM(CS_RPLC_AMT1+CS_RPLC_AMT2+CS_RPLC_AMT3+CS_RPLC_AMT4+CS_RPLC_AMT5
                  +CS_RPLC_AMT6+CS_RPLC_AMT7+CS_RPLC_AMT8+CS_RPLC_AMT9+CS_RPLC_AMT10
                  +CS_RPLC_AMT11+CS_RPLC_AMT12) AS CS_RPLC_AMT_TOT
                  ,SUM(PIA_FEE_EOT_BLAM) AS PIA_FEE_EOT_BLAM
              FROM (
                  /*계약번호별로 금액을 만듬. */
                  SELECT CNTR_NO
                        ,CNTR_SN
                        ,MAX(SELL_TP_CD) AS SELL_TP_CD
                        ,MAX(SELL_TP_DTL_CD) AS SELL_TP_DTL_CD
                        ,MAX(PD_HCLSF_NM) AS PD_HCLSF_NM
                        ,MAX(PD_MCLSF_NM) AS PD_MCLSF_NM
                        ,MAX(BF_BASE_YM) AS BF_BASE_YM
                        ,MAX(PIA_SELL_FEE_CRDOVR_BLAM) AS PIA_SELL_FEE_CRDOVR_BLAM
                        ,0 AS PIA_FEE_OC_AMT
                        ,SUM(CS_RPLC_AMT1) AS CS_RPLC_AMT1
                        ,SUM(CS_RPLC_AMT2) AS CS_RPLC_AMT2
                        ,SUM(CS_RPLC_AMT3) AS CS_RPLC_AMT3
                        ,SUM(CS_RPLC_AMT4) AS CS_RPLC_AMT4
                        ,SUM(CS_RPLC_AMT5) AS CS_RPLC_AMT5
                        ,SUM(CS_RPLC_AMT6) AS CS_RPLC_AMT6
                        ,SUM(CS_RPLC_AMT7) AS CS_RPLC_AMT7
                        ,SUM(CS_RPLC_AMT8) AS CS_RPLC_AMT8
                        ,SUM(CS_RPLC_AMT9) AS CS_RPLC_AMT9
                        ,SUM(CS_RPLC_AMT10) AS CS_RPLC_AMT10
                        ,SUM(CS_RPLC_AMT11) AS CS_RPLC_AMT11
                        ,SUM(CS_RPLC_AMT12) AS CS_RPLC_AMT12
                        ,MIN(PIA_FEE_EOT_BLAM) AS PIA_FEE_EOT_BLAM
                    FROM (
                        SELECT CNTR_NO
                              ,CNTR_SN
                              ,MAX(SELL_TP_CD) AS SELL_TP_CD  /*판매유형*/
                              ,MAX(SELL_TP_DTL_CD) AS SELL_TP_DTL_CD
                              ,MAX(PD_HCLSF_NM) AS PD_HCLSF_NM
                              ,MAX(PD_MCLSF_NM) AS PD_MCLSF_NM
                              ,BASE_YM   /*기준년월 : 수수료대체년월*/
                              ,SUBSTR(BASE_YM,1,4) || ' 이전' AS BF_BASE_YM   /*기준년월*/
                              ,MAX(PIA_SELL_FEE_CRDOVR_BLAM) AS PIA_SELL_FEE_CRDOVR_BLAM   /*선급판매수수료이월잔액 - MAX를 하는 이유는 이전년도에 넘어온 계약별 최초월 가져오는내용*/
                              ,0  AS PIA_FEE_OC_AMT    /*선급수수료발생금액 - 이전꺼는 이거 필요없음. */
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '01'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT1     /*1월비용대체*/
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '02'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT2     /*2월비용대체*/
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '03'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT3     /*3월비용대체*/
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '04'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT4     /*4월비용대체*/
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '05'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT5     /*5월비용대체*/
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '06'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT6     /*6월비용대체*/
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '07'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT7     /*7월비용대체*/
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '08'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT8     /*8월비용대체*/
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '09'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT9     /*9월비용대체*/
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '10'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT10     /*10월비용대체*/
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '11'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT11     /*11월비용대체*/
                              ,CASE WHEN SUBSTR(BASE_YM,5,2) = '12'
                                    THEN SUM(CS_RPLC_AMT)
                                    ELSE 0 END  AS CS_RPLC_AMT12     /*12월비용대체*/
                              --,SUM(CS_RPLC_AMT) AS CS_RPLC_AMT_TOT   /*합계*/
                              ,MIN(PIA_FEE_EOT_BLAM) AS PIA_FEE_EOT_BLAM
                          FROM T
                         WHERE SUBSTR(BASE_YM,1,4) = #{baseYm}    /*비용대체년월이 검색년월인거*/
                           AND SUBSTR(FEE_OC_YM,1,4) <![CDATA[<]]> #{baseYm}  /*수수료발생년월이 이전년인거*/
                        GROUP BY CNTR_NO, CNTR_SN, BASE_YM
                     ) GROUP BY CNTR_NO  ,CNTR_SN
              )
                GROUP BY SELL_TP_CD ,SELL_TP_DTL_CD ,PD_HCLSF_NM ,PD_MCLSF_NM
                UNION ALL
                /*해당년도에 월별로 새로 생성된 수수료 */
                SELECT SELL_TP_CD
                      ,SELL_TP_DTL_CD
                      ,PD_HCLSF_NM
                      ,PD_MCLSF_NM
                      ,FEE_OC_YM AS BASE_YM
                      ,SUM(PIA_SELL_FEE_CRDOVR_BLAM) AS PIA_SELL_FEE_CRDOVR_RES_AMT
                      ,SUM(PIA_FEE_OC_AMT) AS PIA_FEE_OC_AMT
                      ,SUM(CS_RPLC_AMT1) AS CS_RPLC_AMT1
                      ,SUM(CS_RPLC_AMT2) AS CS_RPLC_AMT2
                      ,SUM(CS_RPLC_AMT3) AS CS_RPLC_AMT3
                      ,SUM(CS_RPLC_AMT4) AS CS_RPLC_AMT4
                      ,SUM(CS_RPLC_AMT5) AS CS_RPLC_AMT5
                      ,SUM(CS_RPLC_AMT6) AS CS_RPLC_AMT6
                      ,SUM(CS_RPLC_AMT7) AS CS_RPLC_AMT7
                      ,SUM(CS_RPLC_AMT8) AS CS_RPLC_AMT8
                      ,SUM(CS_RPLC_AMT9) AS CS_RPLC_AMT9
                      ,SUM(CS_RPLC_AMT10) AS CS_RPLC_AMT10
                      ,SUM(CS_RPLC_AMT11) AS CS_RPLC_AMT11
                      ,SUM(CS_RPLC_AMT12) AS CS_RPLC_AMT12
                      ,SUM(CS_RPLC_AMT1+CS_RPLC_AMT2+CS_RPLC_AMT3+CS_RPLC_AMT4+CS_RPLC_AMT5
                           +CS_RPLC_AMT6+CS_RPLC_AMT7+CS_RPLC_AMT8+CS_RPLC_AMT9+CS_RPLC_AMT10
                           +CS_RPLC_AMT11+CS_RPLC_AMT12) AS CS_RPLC_AMT_TOT
                      ,SUM(PIA_FEE_EOT_BLAM) AS PIA_FEE_EOT_BLAM
                  FROM (
                      SELECT CNTR_NO
                            ,CNTR_SN
                            ,MAX(SELL_TP_CD) AS SELL_TP_CD  /*판매유형*/
                            ,MAX(SELL_TP_DTL_CD) AS SELL_TP_DTL_CD
                            ,MAX(PD_HCLSF_NM) AS PD_HCLSF_NM
                            ,MAX(PD_MCLSF_NM) AS PD_MCLSF_NM
                            ,FEE_OC_YM
                            ,MAX(PIA_SELL_FEE_CRDOVR_BLAM) AS PIA_SELL_FEE_CRDOVR_BLAM
                            ,MAX(PIA_FEE_OC_AMT) AS PIA_FEE_OC_AMT
                            ,SUM(CS_RPLC_AMT1) AS CS_RPLC_AMT1
                            ,SUM(CS_RPLC_AMT2) AS CS_RPLC_AMT2
                            ,SUM(CS_RPLC_AMT3) AS CS_RPLC_AMT3
                            ,SUM(CS_RPLC_AMT4) AS CS_RPLC_AMT4
                            ,SUM(CS_RPLC_AMT5) AS CS_RPLC_AMT5
                            ,SUM(CS_RPLC_AMT6) AS CS_RPLC_AMT6
                            ,SUM(CS_RPLC_AMT7) AS CS_RPLC_AMT7
                            ,SUM(CS_RPLC_AMT8) AS CS_RPLC_AMT8
                            ,SUM(CS_RPLC_AMT9) AS CS_RPLC_AMT9
                            ,SUM(CS_RPLC_AMT10) AS CS_RPLC_AMT10
                            ,SUM(CS_RPLC_AMT11) AS CS_RPLC_AMT11
                            ,SUM(CS_RPLC_AMT12) AS CS_RPLC_AMT12
                            ,MIN(PIA_FEE_EOT_BLAM) AS PIA_FEE_EOT_BLAM
                        FROM (
                            SELECT CNTR_NO, CNTR_SN
                                  ,SELL_TP_CD
                                  ,SELL_TP_DTL_CD
                                  ,PD_HCLSF_NM
                                  ,PD_MCLSF_NM
                                  ,FEE_OC_YM  /*수수료발생년월*/
                                  ,0 AS PIA_SELL_FEE_CRDOVR_BLAM    /*선급판매수수료이월잔액*/
                                  ,MAX(PIA_FEE_OC_AMT) AS PIA_FEE_OC_AMT
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '01' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '01'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT1     /*1월비용대체*/
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '02' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '02'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT2     /*2월비용대체*/
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '03' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '03'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT3     /*3월비용대체*/
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '04' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '04'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT4     /*4월비용대체*/
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '05' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '05'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT5     /*5월비용대체*/
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '06' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '06'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT6     /*6월비용대체*/
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '07' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '07'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT7     /*7월비용대체*/
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '08' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '08'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT8     /*8월비용대체*/
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '09' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '09'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT9     /*9월비용대체*/
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '10' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '10'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT10     /*10월비용대체*/
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '11' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '11'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT11     /*11월비용대체*/
                                  ,CASE WHEN SUBSTR(BASE_YM,5,2) = '12' AND SUBSTR(BASE_YM,5,2) <![CDATA[<=]]> '12'
                                        THEN SUM(CS_RPLC_AMT)
                                        ELSE 0 END  AS CS_RPLC_AMT12     /*12월비용대체*/
                                  ,MIN(PIA_FEE_EOT_BLAM) AS PIA_FEE_EOT_BLAM
                             FROM T
                            WHERE SUBSTR(BASE_YM,1,4) = #{baseYm}
                              AND SUBSTR(FEE_OC_YM,1,4) = #{baseYm}
                            GROUP BY CNTR_NO, CNTR_SN, SELL_TP_CD ,SELL_TP_DTL_CD ,PD_HCLSF_NM ,PD_MCLSF_NM , BASE_YM, FEE_OC_YM
                         ) GROUP BY CNTR_NO, CNTR_SN, FEE_OC_YM
                 ) GROUP BY SELL_TP_CD ,SELL_TP_DTL_CD ,PD_HCLSF_NM ,PD_MCLSF_NM , FEE_OC_YM
                  ORDER BY SELL_TP_CD ,SELL_TP_DTL_CD ,PD_HCLSF_NM ,PD_MCLSF_NM , BASE_YM
    </select>

    <select id="selectFeeGubunCodes" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbAdvancedSellFeeReplaceDto$SearchCodeRes">
        SELECT T1.FEE_CD AS CODE_ID
             , T1.FEE_CD || '(' || FEE_NM || ')' AS CODE_NAME   /*수수료명*/
             , 2 AS SEQ
          FROM TB_FEAM_FEE_CD T1
         INNER JOIN TB_FEAM_FEE_BASE_DTL T2
            ON T1.FEE_CD = T2.FEE_CD
         WHERE 1 = 1
           AND T1.DTA_DL_YN = 'N'
           AND T2.DTA_DL_YN = 'N'
           AND TO_CHAR(SYSDATE,'YYYYMM') BETWEEN T2.APY_STRT_YM AND T2.APY_END_YM
           AND T2.FEE_BASE_STAT_CD = '02'
         ORDER BY CODE_ID
    </select>

    <select id="selectPop" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbAdvancedSellFeeReplaceDto$SearchPopRes">
        SELECT KW_GRP_CO_CD
              ,TO_CHAR(LAST_DAY( TO_DATE(#{currentMonth} , 'YYYYMM') ),'YYYYMMDD') AS SLIP_FTRM_DT
              ,TO_CHAR(SUM(FEE_OC_AMT), 'FM999,999,999,999,990') AS FEE_OC_AMT   /*선급한매수수료총액*/
              ,TO_CHAR(SUM(CS_RPLC_AMT), 'FM999,999,999,999,990') AS CS_RPLC_AMT   /*비용대체총액*/
              ,substr(#{currentMonth}, 1,4) || '년' || substr(#{currentMonth}, 5,2) || '월 선급판매수수료' AS PIA_SELL_FEE_SMRY   /*적요*/
              ,MAX(DP_SLIP_TRS_NO) AS DP_SLPNO   /*전표번호*/
          FROM TB_CBCL_PIA_FEE_CS_RPLC_BAS T1 /*선급판매수수료 비용대체기본*/
         WHERE BASE_YM = #{currentMonth}
           AND KW_GRP_CO_CD = #{kwGrpCoCd}
      GROUP BY KW_GRP_CO_CD
    </select>

    <update id="updatePop">
        UPDATE TB_CBCL_PIA_FEE_CS_RPLC_BAS
           SET PIA_SELL_FEE_SMRY = #{piaSellFeeSmry}
               <include refid="COMMON.updateSystemField"/>
         WHERE BASE_YM = #{baseYm}
           AND KW_GRP_CO_CD = #{kwGrpCoCd}
    </update>
</mapper>
