<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.closing.sales.mapper.WdcbSalesPerformanceDetailMapper">
    <select id="selectMembershipSalesDetail" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbSalesPerformanceDetailDto$SearchMembershipRes">
        SELECT /*1.고객 기본정보*/
               C.CST_KNM                                     /*고객명*/
             , A.CNTR_NO || '-' || A.CNTR_SN AS CNTR_DTL_NO  /*계약상세번호*/
             , A.SL_CL_YM                                    /*매출년월*/
               /*2.계약제품*/
             , F.PD_CD  /*상품코드*/
             , F.PD_NM  /*상품명*/
             , B.SV_PRD  /*주기*/
             , CASE WHEN D.BASE_PD_CD = '4350' THEN    --상품코드 '4350'
                       CASE WHEN D.PD_USWY_CD IN (0,1) THEN '황사필터('||D.PD_USWY_CD||')'   --TB_FEAM_WELS_SV_PERF_IZ  PD_USWY_CD
                            WHEN D.PD_USWY_CD = 2 THEN '항바이러스('||D.PD_USWY_CD||')'
                            ELSE                       '일반('||D.PD_USWY_CD||')'
                        END
                    WHEN D.BASE_PD_CD = '4415' THEN
                       CASE WHEN D.PD_USWY_CD = 0 THEN '구분없음('||D.PD_USWY_CD||')'
                            WHEN D.PD_USWY_CD IN (1,3) THEN '일반('||D.PD_USWY_CD||')'
                            WHEN D.PD_USWY_CD IN (2) THEN '대형법인('||D.PD_USWY_CD||')'
                            WHEN D.PD_USWY_CD IN (4) THEN '대형법인2('||D.PD_USWY_CD||')'
                            WHEN D.PD_USWY_CD IN (5) THEN '홈케어('||D.PD_USWY_CD||')'
                            ELSE ''
                        END
                    WHEN F.PD_CD = '4' /* 4:연수기 */ THEN
                        CASE WHEN D.PD_USWY_CD = 0 THEN '일반('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD = 1 THEN '특별('||D.PD_USWY_CD||')'
                             ELSE                       '특특별('||D.PD_USWY_CD||')'
                         END
                    WHEN F.PD_CD = 'F' /* F:안마의자 */ THEN
                        CASE WHEN D.PD_USWY_CD = 1 THEN '일반('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD = 2 THEN '특별('||D.PD_USWY_CD||')'
                             ELSE ''
                         END
                    ELSE
                        CASE WHEN D.PD_USWY_CD = 0 THEN '구분없음('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD IN (1,3) THEN '일반('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD IN (2,4) THEN '업소용('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD IN (5) THEN '홈케어('||D.PD_USWY_CD||')'
                             ELSE ''
                         END
                END                         AS LCIUSE_NM
             , A.CNTR_DT      AS CNTR_DT             /*계약일자*/
             , A.SL_RCOG_DT   AS SL_RCOG_DT          /*매출일자*/
             , A.RENTAL_RGST_COST  AS RENTAL_RGST_COST /*월회비*/
             , A.DSC_AMT AS DSC_AMT                   /*할인금액*/
             , A.CAN_DT AS CAN_DT                     /*취소일자*/
               /*3.선납사항*/
             , A.PRM_TN AS PRM_TN                    /*선납회차*/
             , A.PRM_MCN||'개월' AS PRM_MCN /*선납개월*/
             , A.PRM_STRT_Y||A.PRM_STRT_MM          AS LCPS_YRMN    /*선납시작년월*/
             , A.PRM_END_Y||A.PRM_END_MM            AS LCPE_YRMN    /*선납종료년월*/
             , A.PRM_DSCR||'%'||A.PRM_DSC_AMT       AS PRM_DSCR                /*선납할인율 선납할인금액*/
             , 0 AS LCPMO1 --A.LCPMO1||'개월'||A.LCPAM1  /*선납금액1*/
             , 0 AS LCPMO2 --A.LCPMO2||'개월'||A.LCPAM2  /*선납금액2*/
             , A.TOT_PRM_AMT  /*선납총액*/

               /*4.매출사항 */
             , A.RENTAL_TN --A.RENTAL_TN||'/'||A.LCVCNT  /*가입차월/방문차월*/
             , A.RENTAL_DC||'/'||A.SL_DC AS RENTAL_DC /*가입일수/매출일수*/
             , '' AS LCENT_DT --CASE WHEN A.LCENTY = 0 THEN '' ELSE A.LCENTY || DIGITS(A.LCENTM) || DIGITS(A.LCENTD) END AS LCENT_DT /*가입일자*/
             , A.NOM_SL_AMT  /*정상매출*/
             , A.NOM_DSC_AMT  /*정상할인*/
             , '' AS LCOUT_DT --CASE WHEN A.LCOUTY = 0 THEN '' ELSE A.LCOUTY || DIGITS(A.LCOUTM) || DIGITS(A.LCOUTD) END AS LCOUT_DT /*탈퇴일자*/
             , A.SPMT_SL_AMT  /*추가매출*/
             , A.SPMT_DSC_AMT  /*추가할인*/
             , '' AS LCWAN_DT --CASE WHEN A.LCWANY = 0 THEN '' ELSE A.LCWANY || DIGITS(A.LCWANM) || DIGITS(A.LCWAND) END AS LCWAN_DT /*완료일자*/

             , A.THM_SL_SUM_AMT  /*매출합계*/
             , A.SL_SUM_VAT  /*매출합계VAT */
             , A.SL_CTR_AMT  /*매출조정*/

             , A.DSC_AGG_AMT  /*할인누계*/
             , A.CTR_AGG_AMT  /*조정누계*/
             , A.SL_AGG_AMT  /*매출누계*/
               /*5.입금사항*/
             , A.PRM_BLAM_BTD_AMT  /*선납잔액*/
             , A.PRM_DP_AMT  /*선납입금*/
             , A.PRM_RFND_AMT  /*선납환불*/

             , A.PRM_RPLC_AMT  /*선납대체*/
             , A.PRM_SL_AMT  /*선납매출*/
             , A.PRM_EXP_AMT  /*선납예정금액*/

             , A.BTD_ATAM  /*선수기초*/
             , A.THM_ATAM_DP_AMT  /*선수입금*/
             , A.THM_ATAM_RFND_AMT  /*선수환불*/

             , A.OVR_CTR_DP_AMT  /*선수대체*/
             , A.PRPD_SL_AMT  /*선수매출*/
             , A.EOT_ATAM  /*선수잔액*/

             , A.SL_BND_ALRPY_AMT  /*매출입금*/
             , A.SL_DP_AGG_AMT  /*매출입금누계*/
             , A.THM_UC_BLAM  /*미수금액*/

               /*6.공제사항*/(TODO: 나중에 추가할 것)
             , 0 AS LCAM51 --A.LCAM51  /*할인매출*/
             , 0 AS LCAM53 --A.LCAM53  /*할인입금*/
             , 0 AS LCAM55 --A.LCAM55  /*할인미수*/

             , 0 AS LCAM61 --A.LCAM61  /*필터매출*/
             , 0 AS LCAM63 --A.LCAM63  /*필터입금*/
             , 0 AS LCAM65 --A.LCAM65  /*필터미수*/
               /*7.연체가산*/
             , NVL(G.BTD_DLQ_AMT,0) AS BTD_DLQ_AMT  /*가산금기초*/
             , NVL(G.THM_OC_DLQ_ADD_AMT,0) AS THM_OC_DLQ_ADD_AMT  -- 당월발생연체가산금
             , NVL(G.THM_CTR_DLQ_ADD_AMT,0) AS THM_CTR_DLQ_ADD_AMT -- 당월공제연체가산금
             , NVL(G.THM_DLQ_ADD_DP_SUM_AMT,0) AS THM_DLQ_ADD_DP_SUM_AMT --당월입금연체가산금
             , NVL(G.THM_DLQ_ADD_RFND_SUM_AMT,0) AS THM_DLQ_ADD_RFND_SUM_AMT -- 당월환불연체가산금
             , NVL(G.EOT_DLQ_ADD_AMT,0) AS EOT_DLQ_ADD_AMT --기말잔액연체가산금
               /*8.연체사항*/
             , '' AS LCVIS_DT --A.LCVMON||'/'||CASE WHEN A.LCVISY = 0 THEN '' ELSE A.LCVISY || DIGITS(A.LCVISM) || DIGITS(A.LCVISD) END AS LCVIS_DT /*방문주기 방문년월일*/
             , G.DLQ_MCN||'/'||G.DLQ_ACU_MCN AS DLQ_MCN /*연체개월/누계*/
             , G.EOT_DLQ_AMT  /*연체금액*/

               (TODO: 나중에 추가할 것)
             , 0 AS LCAM67 --A.LCAM67   /*대손금액*/
             , 0 AS LCAM68 --A.LCAM68   /*대손－입금누계, 대손 입금 = LCAM68-LCAM69*/
             , 0 AS LCAM69 --A.LCAM69   /*대손－환불누계, 대손 입금 = LCAM68-LCAM69*/

               /*--집금사항*/
             , H.ACTCS_DT  AS ACTCS_DT /*수임일자*/
             , F_CMZ_CD_NM(#{session.tenantCd}, 'CLCTAM_DV_CD', H.CLCTAM_DV_CD) AS CLCTAM_DV_NM        /*집금구분명*/
             , T.PRTNR_KNM               AS PRTNR_KNM/*집금자명*/
             , T.PRTNR_NO   /*집금자코드*/
          FROM TB_CBCL_WELLS_SL_MM_CL_IZ A
         INNER JOIN TB_SSCT_CNTR_DTL B --계약상세
            ON B.CNTR_NO = A.CNTR_NO
           AND B.CNTR_SN = A.CNTR_SN
           AND B.SELL_TP_CD = A.SELL_TP_CD
           AND B.SELL_TP_DTL_CD = A.SELL_TP_DTL_CD
          LEFT OUTER JOIN TB_CUBS_CST_BAS C
            ON A.CST_NO = C.CST_NO
          LEFT OUTER JOIN TB_FEAM_WELS_SV_PERF_IZ D --웰스 서비스 실적
            ON A.SL_CL_YM = D.BASE_YM
           AND A.CNTR_NO  = D.CNTR_NO
           AND A.CNTR_SN  = D.CNTR_SN
          LEFT OUTER JOIN TB_SSCT_RENTAL_RSTL_IZ E --렌탈 재약정
            ON A.CNTR_NO = E.CNTR_NO
           AND A.CNTR_SN = E.CNTR_SN
          LEFT OUTER JOIN TB_PDBS_PD_BAS F --상품기본
            ON B.BASE_PD_CD = F.PD_CD
          LEFT OUTER JOIN TB_CBCL_DLQ_BAS G  --연체기본
            ON A.CNTR_NO = G.CNTR_NO
           AND A.CNTR_SN = G.CNTR_SN
           AND A.SL_CL_YM = G.PERF_YM
          LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS H /*채권기본*/
            ON A.CNTR_NO = H.CNTR_NO
           AND A.CNTR_SN = H.CNTR_SN
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ T
            ON H.CLCTAM_PRTNR_NO = T.PRTNR_NO
           AND T.OG_TP_CD = 'BND'
           AND T.DTA_DL_YN = 'N'
           AND T.BASE_YM = TO_CHAR(ADD_MONTHS(TO_DATE(A.SL_CL_YM, 'YYYYMM'), -1), 'YYYYMM')
          LEFT OUTER JOIN TB_SSCT_RENTAL_ADN_SV_IZ LC70 --렌탈 부가서비스 내역
            ON LC70.CNTR_NO = A.CNTR_NO
           AND LC70.CNTR_SN = A.CNTR_SN
           AND LC70.ADN_SV_DV_CD = '01'
           AND LC70.ADN_SV_SN = '1'
         WHERE 1=1
           AND A.CNTR_NO || A.CNTR_SN = #{cntrDtlNo}
           AND A.SL_CL_YM = #{slClYm}
           AND A.SELL_TP_CD = '3'
           AND A.SELL_TP_DTL_CD IN ('31','32','33','34')
         ORDER BY SUBSTR(A.SL_CL_YM,1,4) DESC,SUBSTR(A.SL_CL_YM,5,2) DESC
        FETCH FIRST 1 ROWS ONLY
    </select>

    <select id="selectLeaseSalesDetail" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbSalesPerformanceDetailDto$SearchLeaseRes">
        -- 리스(W-CL-U-0038P07    매출실적현황-리스매출 상세내역)
        SELECT /*1.고객 기본정보*/
               C.CST_KNM                                     /*고객명*/
             , A.CNTR_NO || '-' || A.CNTR_SN AS CNTR_DTL_NO  /*계약상세번호*/
             , A.SL_CL_YM AS SL_CL_YM                        /*매출년월*/

               /*2.계약제품*/
             , F.PD_CD  /*상품코드*/
             , F.PD_NM  /*상품명*/
             , A.CNTR_DT      AS CNTR_DT /*계약일자*/
             , A.SL_RCOG_DT   AS SL_RCOG_DT /*매출일자*/
             , B.SV_PRD  /*주기*/
             , CASE WHEN D.BASE_PD_CD = '4350' THEN    --상품코드 '4350'
                        CASE WHEN D.PD_USWY_CD IN (0,1) THEN '황사필터('||D.PD_USWY_CD||')'   --TB_FEAM_WELS_SV_PERF_IZ  PD_USWY_CD
                             WHEN D.PD_USWY_CD = 2 THEN '항바이러스('||D.PD_USWY_CD||')'
                             ELSE                       '일반('||D.PD_USWY_CD||')'
                         END
                    WHEN D.BASE_PD_CD = '4415' THEN
                        CASE WHEN D.PD_USWY_CD = 0 THEN '구분없음('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD IN (1,3) THEN '일반('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD IN (2) THEN '대형법인('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD IN (4) THEN '대형법인2('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD IN (5) THEN '홈케어('||D.PD_USWY_CD||')'
                             ELSE ''
                         END
                    WHEN F.PD_CD = '4' /* 4:연수기 */ THEN
                        CASE WHEN D.PD_USWY_CD = 0 THEN '일반('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD = 1 THEN '특별('||D.PD_USWY_CD||')'
                             ELSE                       '특특별('||D.PD_USWY_CD||')'
                         END
                    WHEN F.PD_CD = 'F' /* F:안마의자 */ THEN
                        CASE WHEN D.PD_USWY_CD = 1 THEN '일반('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD = 2 THEN '특별('||D.PD_USWY_CD||')'
                             ELSE ''
                         END
                    ELSE
                        CASE WHEN D.PD_USWY_CD = 0 THEN '구분없음('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD IN (1,3) THEN '일반('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD IN (2,4) THEN '업소용('||D.PD_USWY_CD||')'
                             WHEN D.PD_USWY_CD IN (5) THEN '홈케어('||D.PD_USWY_CD||')'
                             ELSE ''
                         END
                END                         AS LCIUSE_NM
             , A.RENTAL_RGST_COST||'(DC'||A.DSC_AMT||')' AS RENTAL_RGST_COST /*등록비*/
             , A.ISTM_AMT AS ISTM_AMT  /*렌탈/리스총액*/
             , A.RENTAL_PTRM||'개월'||A.RENTAL_AMT||'(DC'||A.RENTAL_DSC_AMT||')' AS RENTAL_PTRM  /*렌탈1/리스기간1 렌탈금액1 렌탈할인1*/
             , A.SV_AMT AS SV_AMT  /*서비스료*/

               /*3.매출사항*/
             , A.RENTAL_TN||'/'||A.RENTAL_DC||'-'||A.SL_DC AS RENTAL_TN /*리스차월*/
             , A.RENTAL_DC  /*사용일수*/
             , A.CAN_DT          AS CAN_DT /*취소일자*/

             , A.NOM_SL_AMT     /*원금매출*/
             -- , A.NOM_INT_AMT /*이자매출*/
             , A.FSH_DT         /*완료일자*/
             , A.SL_AGG_AMT     /*원금누계*/
             -- , A.INT_AGG_AMT  /*이자누계*/
             , A.DSC_AGG_AMT + A.INT_DSC_AGG_AMT + A.INT_SPMT_AGG_AMT AS DSC_AGG_AMT /*할인누계*/
             , A.CTR_AGG_AMT + A.INT_CTR_AGG_AMT AS CTR_AGG_AMT  /*조정누계*/

               /*4.청구사항(TODO: 나중에 추가할 것)*/
             , 0 AS LCMAM1 -- LCMAM1+LCMAM1+LCSAM1  /*기초금액*/
             , 0 AS LCMAM2 -- LCMAM2+LCCAM2+LCSAM2  /*발생금액*/
             , 0 AS LCMAM3 -- LCMAM3+LCCAM1+LCSAM3  /*입금금액*/
             , 0 AS LCMAM4 -- LCMAM5+LCCAM5+LCSAM5  /*추가금액*/
             , 0 AS LCMAM5 -- LCMAM4+LCCAM4+LCSAM4  /*조정금액*/
             , 0 AS LCMAM6 -- LCMAM6+LCCAM6+LCSAM6  /*기말금액*/
             , 0 AS LCMAM7   /*채권조정금액*/
             , 0 AS LCMAM8   /*채권기말금액*/
             , 0 AS LCMAM9   /*기초금액*/

               /*5.취소사항(TODO: 나중에 추가할 것)*/
             , 0 AS LCMAM10  /*위약금*/
             , 0 AS LCMAM11  /*분실손료*/

               /*6.선수사항*/
             , A.BTD_ATAM + A.MLG_BTD_PRPD_AMT       AS LCAM31  /*기초금액*/
             , A.THM_ATAM_DP_AMT + A.MLG_DP_AMT      AS LCAM32  /*선수입금*/
             , A.THM_ATAM_RFND_AMT + A.MLG_RFND_AMT  AS LCAM33  /*선수환불*/

             , A.PRM_SL_AMT + A.PRPD_SL_AMT + A.MLG_SL_AMT   AS LCAM35  /*매출대체*/
             , A.OVR_CTR_DP_AMT AS OVR_CTR_DP_AMT                       /*선수대체*/
             , A.EOT_ATAM + A.MLG_EOT_PRPD_AMT AS LCAM3T               /*선수총액*/

             , A.MLG_EOT_PRPD_AMT  /*PR잔액*/
             , A.EOT_ATAM          /*선수잔액*/

               /*7.연체가산*/
             , NVL(G.BTD_DLQ_AMT,0) AS BTD_DLQ_AMT   /*가산금기초*/
             , NVL(G.THM_OC_DLQ_ADD_AMT,0) AS THM_OC_DLQ_ADD_AMT  /*당월발생연체가산금*/
             , NVL(G.THM_CTR_DLQ_ADD_AMT,0) AS THM_CTR_DLQ_ADD_AMT  /*당월공제연체가산금*/
             , NVL(G.THM_DLQ_ADD_DP_SUM_AMT,0) AS THM_DLQ_ADD_DP_SUM_AMT  /*당월입금연체가산금*/
             , NVL(G.THM_DLQ_ADD_RFND_SUM_AMT,0) AS THM_DLQ_ADD_RFND_SUM_AMT /*당월환불연체가산금*/
             , NVL(G.EOT_DLQ_ADD_AMT,0) AS EOT_DLQ_ADD_AMT   /*기말잔액연체가산금*/

               /*8.연체사항(TODO: 나중에 추가할 것)*/
             , 0 AS LCCNT1 --A.LCCNT1  /*유지수당*/
             , 0 AS LCCNT2 --A.LCCNT2  /*유지수당누계*/
             , G.DLQ_MCN||'/'||G.DLQ_ACU_MCN AS DLQ_MCN /*연체개월/누계*/
             , G.EOT_DLQ_AMT  /*연체금액*/

             , H.ACTCS_DT  AS ACTCS_DT /*수임일자*/
             , F_CMZ_CD_NM(#{session.tenantCd}, 'CLCTAM_DV_CD', H.CLCTAM_DV_CD) AS CLCTAM_DV_NM        /*집금구분명*/
             , T.PRTNR_KNM               AS PRTNR_KNM/*집금자명*/
             , T.PRTNR_NO   /*집금자코드*/
             , '' AS LCSND_DT -- CASE WHEN A.LCSNDY = 0 THEN '' ELSE A.LCSNDY || DIGITS(A.LCSNDM) END                        AS LCSND_DT /*발송년월(장기채권발송년월)*/
          FROM TB_CBCL_WELLS_SL_MM_CL_IZ A
         INNER JOIN TB_SSCT_CNTR_DTL B  /*계약상세*/
            ON B.CNTR_NO = A.CNTR_NO
           AND B.CNTR_SN = A.CNTR_SN
           AND B.SELL_TP_CD = A.SELL_TP_CD
           AND B.SELL_TP_DTL_CD = A.SELL_TP_DTL_CD
          LEFT OUTER JOIN TB_CUBS_CST_BAS C
            ON A.CST_NO = C.CST_NO
          LEFT OUTER JOIN TB_FEAM_WELS_SV_PERF_IZ D  /*웰스 서비스 실적*/
            ON A.SL_CL_YM = D.BASE_YM
           AND A.CNTR_NO  = D.CNTR_NO
           AND A.CNTR_SN  = D.CNTR_SN
          LEFT OUTER JOIN TB_SSCT_RENTAL_RSTL_IZ E --렌탈 재약정
            ON A.CNTR_NO = E.CNTR_NO
           AND A.CNTR_SN = E.CNTR_SN
          LEFT OUTER JOIN TB_PDBS_PD_BAS F --상품기본
            ON B.BASE_PD_CD = F.PD_CD
          LEFT OUTER JOIN TB_CBCL_DLQ_BAS G  --연체기본
            ON A.CNTR_NO = G.CNTR_NO
           AND A.CNTR_SN = G.CNTR_SN
           AND A.SL_CL_YM = G.PERF_YM
          LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS H /*채권기본*/
            ON A.CNTR_NO = H.CNTR_NO
           AND A.CNTR_SN = H.CNTR_SN
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ T
            ON H.CLCTAM_PRTNR_NO = T.PRTNR_NO
           AND T.OG_TP_CD = 'BND'
           AND T.DTA_DL_YN = 'N'
           AND T.BASE_YM = TO_CHAR(ADD_MONTHS(TO_DATE(A.SL_CL_YM, 'YYYYMM'), -1), 'YYYYMM')
          LEFT OUTER JOIN TB_SSCT_RENTAL_ADN_SV_IZ LC70 --렌탈 부가서비스 내역
            ON LC70.CNTR_NO = A.CNTR_NO
           AND LC70.CNTR_SN = A.CNTR_SN
           AND LC70.ADN_SV_DV_CD = '01'
           AND LC70.ADN_SV_SN = '1'
         WHERE 1=1
           AND A.CNTR_NO || A.CNTR_SN = #{cntrDtlNo}
           AND A.SL_CL_YM = #{slClYm}
           AND A.SELL_TP_CD = '2'
           AND A.SELL_TP_DTL_CD IN ('22','24','25','26')
         ORDER BY SUBSTR(A.SL_CL_YM,1,4) DESC,SUBSTR(A.SL_CL_YM,5,2) DESC
         FETCH FIRST 1 ROWS ONLY
    </select>

    <select id="selectRentalSalesDetail" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbSalesPerformanceDetailDto$SearchRentalRes">
        WITH W1 AS (SELECT A.CNTR_NO
                         , A.CNTR_SN
                         , A.BASE_PD_CD
                         , A.OJ_PD_CD
                         , A.PD_REL_TP_CD
                         , B.SV_PD_TP_CD
                         , B.PD_NM
                      FROM TB_SSCT_CNTR_PD_REL A -- 계약상품관계
                     INNER JOIN TB_PDBS_PD_BAS B -- 상품기본
                        ON B.PD_CD = A.OJ_PD_CD -- 상품코드 = 대상상품코드
                       AND B.DTA_DL_YN = 'N' -- 데이터삭제여부
                     WHERE TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN A.VL_STRT_DTM AND A.VL_END_DTM
                       AND A.CNTR_NO || A.CNTR_SN = #{cntrDtlNo})
           , W2 AS (SELECT *
                      FROM TB_CBCL_BZNS_ATAM_BAS -- 영업선수
                     WHERE CNTR_NO || CNTR_SN = #{cntrDtlNo}
                       AND SUBSTR(DP_CL_DT, 1, 6) = #{slClYm}
                       AND DTA_DL_YN = 'N')
        SELECT *
          FROM (SELECT
        ----------------------------------------------------------------
        -- 고객기본정보
        ----------------------------------------------------------------
                       T1.CST_NO AS CST_NO -- 고객번호
                     , (SELECT CST_KNM FROM TB_CUBS_CST_BAS WHERE CST_NO = T1.CST_NO AND DTA_DL_YN = 'N') AS CST_KNM -- 고객명
                     , T1.CNTR_NO || '-' || T1.CNTR_SN AS CNTR_DTL_NO -- 계약상세번호
                     , T1.SL_CL_YM AS SL_CL_YM -- 매출년월
        ----------------------------------------------------------------
        -- 계약제품
        ----------------------------------------------------------------
                     , T1.SELL_TP_CD AS SELL_TP_CD     -- 판매유형
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = T1.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
                     , T1.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'SELL_TP_DTL_CD' AND CD_VLD_VAL = T1.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
                     , (CASE WHEN T1.SELL_TP_DTL_CD IN ('21', '23') THEN 'N'
                             ELSE 'Y'
                              END) AS ISLEASE -- 리스여부
                     , T3.BASE_PD_CD AS PD_CD -- 상품코드
                     , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE PD_CD = T3.BASE_PD_CD) AS PD_NM -- 상품명
                     , (CASE WHEN T1.SELL_TP_DTL_CD NOT IN ('21', '23') THEN ''
                             ELSE CASE WHEN (T11.IST_DT IS NOT NULL AND T11.IST_DT <![CDATA[<>]]> '') AND
                                           (T11.REQD_DT IS NOT NULL AND T11.REQD_DT <![CDATA[<>]]> '') AND
                                           (SUBSTR(T11.REQD_DT, 1, 6) <![CDATA[<]]> T1.SL_CL_YM) THEN ''
                                       WHEN T11.PDCT_PD_CD = 'WP07120084' THEN '가압Q'
                                       WHEN T11.PDCT_PD_CD = 'WP07120085' THEN '가압M'
                                       ELSE ''
                                        END
                              END) AS ADN_SV -- 부가서비스정보
                     , T1.CNTR_DT AS CNTR_DT -- 접수일(LC50.LCCRTY) ASIS 계약일자
                     , CASE WHEN T1.SELL_TP_CD IN ('6', '9') THEN SUBSTR(T1.SPP_DTM, 1, 8) -- 정기배송('6'), 필터('9') : 배송일자, 나머지는 설치일자가 매출일자임
                            ELSE SUBSTR(T1.IST_DTM, 1, 8)
                             END AS LCSLE_DT -- 매출일자
                     , T3.SV_PRD AS SV_PRD -- 주기(개월)
                     , (SELECT CASE WHEN BB.OJ_PD_CD = 'WM02100167' -- AS-IS : LC50.LCICDE = '4350' 공기청정기KW-A05W2
                                    THEN CASE WHEN CC.SV_PD_TP_CD IN ('1', '3') 	THEN '황사필터('||CC.SV_PD_TP_CD||')'
                                              WHEN CC.SV_PD_TP_CD = '2' 			THEN '항바이러스('||CC.SV_PD_TP_CD||')'
                                              ELSE '일반('||CC.SV_PD_TP_CD||')'
                                               END
                                    WHEN BB.OJ_PD_CD = 'WM03100203' -- AS-IS : LC50.LCICDE = '4415' 비데(BK750RWA)
                                    THEN CASE WHEN CC.SV_PD_TP_CD = '0' 			THEN '구분없음('||CC.SV_PD_TP_CD||')'
                                              WHEN CC.SV_PD_TP_CD IN ('1', '3') 	THEN '일반('||CC.SV_PD_TP_CD||')'
                                              WHEN CC.SV_PD_TP_CD = '2' 			THEN '대형법인('||CC.SV_PD_TP_CD||')'
                                              WHEN CC.SV_PD_TP_CD = '4' 			THEN '대형법인2('||CC.SV_PD_TP_CD||')'
                                              WHEN CC.SV_PD_TP_CD = '5' 			THEN '홈케어('||CC.SV_PD_TP_CD||')'
                                              ELSE (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'SV_TP_CD' AND CD_VLD_VAL = CC.SV_PD_TP_CD) || '(' || CC.SV_PD_TP_CD || ')'
                                               END
                                    WHEN T3.PD_MCLSF_ID = 'PDC000000000059' -- AS-IS : KA11.KAETC2 = '4' 연수기
                                    THEN CASE WHEN CC.SV_PD_TP_CD = '0' 			THEN '일반('||CC.SV_PD_TP_CD||')'
                                              WHEN CC.SV_PD_TP_CD = '1' 			THEN '특별('||CC.SV_PD_TP_CD||')'
                                              ELSE ''
                                               END
                                    WHEN T3.PD_MCLSF_ID = 'PDC000000000063' -- AS-IS : KA11.KAETC2 = 'F' 안마의자
                                    THEN CASE WHEN CC.SV_PD_TP_CD = '0' 			THEN '일반('||CC.SV_PD_TP_CD||')'
                                              WHEN CC.SV_PD_TP_CD = '1' 			THEN '특별('||CC.SV_PD_TP_CD||')'
                                              ELSE ''
                                               END
                                    ELSE CASE WHEN CC.SV_PD_TP_CD = '0' 			THEN '구분없음'||CC.SV_PD_TP_CD||')'
                                              WHEN CC.SV_PD_TP_CD IN ('1', '3') 	THEN '일반('||CC.SV_PD_TP_CD||')'
                                              WHEN CC.SV_PD_TP_CD IN ('2', '4') 	THEN '업소용('||CC.SV_PD_TP_CD||')'
                                              WHEN CC.SV_PD_TP_CD = '5' 			THEN '홈케어('||CC.SV_PD_TP_CD||')'
                                              WHEN CC.SV_PD_TP_CD = '6' 			THEN '조리수밸브('||CC.SV_PD_TP_CD||')'
                                              ELSE (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'SV_TP_CD' AND CD_VLD_VAL = CC.SV_PD_TP_CD) || '(' || CC.SV_PD_TP_CD || ')'
                                               END
                                     END
                          FROM (SELECT BASE_PD_CD FROM W1 WHERE CNTR_NO = T1.CNTR_NO AND CNTR_SN = T1.CNTR_SN AND ROWNUM = 1) AA
                          LEFT OUTER JOIN (SELECT BASE_PD_CD, OJ_PD_CD, SV_PD_TP_CD FROM W1 WHERE CNTR_NO = T1.CNTR_NO AND CNTR_SN = T1.CNTR_SN AND PD_REL_TP_CD = '05' AND ROWNUM = 1) BB -- 05 : 기준상품 - 제품 관계
                            ON BB.BASE_PD_CD = AA.BASE_PD_CD
                          LEFT OUTER JOIN (SELECT BASE_PD_CD, OJ_PD_CD, SV_PD_TP_CD FROM W1 WHERE CNTR_NO = T1.CNTR_NO AND CNTR_SN = T1.CNTR_SN AND PD_REL_TP_CD = '03' AND ROWNUM = 1) CC -- 03 : 기준상품 - 서비스 관계
                            ON CC.BASE_PD_CD = AA.BASE_PD_CD) AS SV_TP_CD_NM -- 용도구분명
                     , T1.RENTAL_RGST_COST AS RENTAL_RGST_COST -- 렌탈등록비(LC50.LCTAMT)
                     , T1.DSC_AMT AS DSC_AMT -- 등록비할인금액(LC50.LCRAMT)
                     , T3.CNTR_TAM AS CNTR_TAM -- 렌탈총액
                     , T1.RENTAL_PTRM AS RENTAL_PTRM -- 렌탈기간1(LC50.LCMON1)
                     , T1.RENTAL_AMT AS RENTAL_AMT -- 월 렌탈/리스금액1(LC50.LCAMT1)
                     , T1.RENTAL_DSC_AMT AS RENTAL_DSC_AMT -- 월 렌탈할인금액1(LC50.LCRAM1)
                     , T1.RENTAL_PTRM2 AS RENTAL_PTRM2 -- 렌탈기간2(LC50.LCMON2)
                     , T1.RENTAL_AMT2 AS RENTAL_AMT2 -- 월 렌탈/리스금액2(LC50.LCAMT2)
                     , T1.RENTAL_DSC_AMT2 AS RENTAL_DSC_AMT2 -- 월 렌탈할인금액2(LC50.LCRAM2)
                     , T1.SV_AMT AS SV_AMT -- 서비스료(LC50.LCSMT1)
                     , NVL((SELECT SUM(NVL(STPL_DSC_AMT, 0))
                              FROM TB_SSCT_RENTAL_RSTL_IZ
                             WHERE CNTR_NO = T1.CNTR_NO
                               AND CNTR_SN = T1.CNTR_SN
                               AND SUBSTR(STPL_ENDDT, 1, 6) > T1.SL_CL_YM
                               AND RSTL_STAT_CD ='020' -- 확정
                               AND DTA_DL_YN ='N'), 0) AS STPL_DSC_AMT -- 재약정할인금액(LC50.LCRAM3)
         --------------------------------------------------------------
         -- 선납사항
         --------------------------------------------------------------
                     , T1.PRM_TN AS PRM_TN -- 회차
                     , T1.PRM_MCN AS PRM_MCN-- 선납개월
                     , T1.PRM_STRT_Y || '-' || PRM_STRT_MM AS PRM_STRT_YM -- 선납시작년월
                     , T1.PRM_END_Y || '-' || PRM_END_MM AS PRM_END_YM-- 선납종료년월
                     , T1.PRM_DSCR AS PRM_DSCR -- 할인율
                     , T1.PRM_DSC_AMT AS PRM_DSC_AMT -- 할인금액
                     , 0 AS PRM_AMT1 -- 선납금액1 @TO-DO 컬럼 추가 또는 입금데이터 확인 필요(LCPAM1)
                     , 0 AS PRM_MCN1 --선납기간1 @TO-DO 컬럼 추가 또는 입금데이터 확인 필요(LCPMO1)
                     , T1.TOT_PRM_AMT AS TOT_PRM_AMT -- 총액
                     , '선납만료컨택담당명' AS CTT_PSIC_NM -- 선납만료컨택담당 @TO-DO
                     , '번호' AS CTT_PSIC_ID -- 선납만료컨택담당 @TO-DO
         ----------------------------------------------------------
         -- 매출사항
         ----------------------------------------------------------
                     , T1.RENTAL_TN AS RENTAL_TN -- 렌탈차월
                     , T1.RENTAL_DC AS RENTAL_DC -- 렌탈일수
                     , T1.SL_DC AS SL_DC -- 매출일수
                     , (SELECT PD_USE_DC FROM TB_SSCT_CNTR_RSG_PROCS_IZ WHERE CNTR_NO = T1.CNTR_NO AND CNTR_SN = T1.CNTR_SN) AS USE_DC -- 사용일수 LC50.LCCDAY
                     , T1.CAN_DT AS CAN_DT -- 취소일자(LC50.LCCANY)
                     , T1.NOM_SL_AMT AS NOM_SL_AMT -- 정상매출금액
                     , T1.NOM_DSC_AMT AS NOM_DSC_AMT -- 정상할인금액
                     , T1.FSH_DT AS FSH_DT -- 완료일자(LC50.LCWANY)
                     , T1.SPMT_SL_AMT AS SPMT_SL_AMT-- 추가매출금액
                     , T1.SPMT_DSC_AMT AS SPMT_DSC_AMT -- 추가할인금액
                     , T1.SL_CTR_AMT AS SL_CTR_AMT -- 매출조정금액
                     , T1.THM_SL_SUM_AMT AS THM_SL_SUM_AMT -- 매출금액
                     , T1.SL_SUM_VAT AS SL_SUM_VAT -- 매출VAT
                     , T1.SL_AGG_AMT AS SL_AGG_AMT -- 매출누계금액
                     , T1.INT_AGG_AMT AS INT_AGG_AMT -- 이자누계액
                     , T1.SL_AGG_AMT + T1.INT_AGG_AMT AS SUM_SL_AGG_AMT
                     , CASE WHEN T1.SELL_TP_DTL_CD NOT IN ('21', '23') THEN T1.DSC_AGG_AMT + T1.INT_DSC_AGG_AMT + T1.INT_SPMT_AGG_AMT -- 할인누계금액 + 이자할인누계금액 + 이자추가누계금액(LC50.LCAM18 + LC50.LCCM18 + LC50.LCCM20)
                            ELSE T1.DSC_AGG_AMT
                             END AS SUM_DSC_AGG_AMT -- 할인누계액
                     , T1.INT_DSC_AGG_AMT AS INT_DSC_AGG_AMT -- 이자할인누계금액
                     , CASE WHEN T1.SELL_TP_DTL_CD NOT IN ('21', '23') THEN T1.CTR_AGG_AMT + T1.INT_CTR_AGG_AMT -- 조정누계금액 + 이자조정누계금액(LC50.LCAM19 + LC50.LCCM19)
                            ELSE T1.CTR_AGG_AMT
                             END AS SUM_CTR_AGG_AMT -- 조정누계액
                     , T1.INT_CTR_AGG_AMT AS INT_CTR_AGG_AMT -- 이자조정누계금
                     , NVL((SELECT NVL(UC_AMT, 0)
                              FROM TB_CBCL_SL_BND_ALRPY_BAS -- 채권반제
                             WHERE BASE_YM = T1.SL_CL_YM
                               AND CNTR_NO = T1.CNTR_NO
                               AND CNTR_SN = T1.CNTR_SN
                               AND DTA_DL_YN = 'N'), 0) AS UC_AMT-- 매출잔액
         ----------------------------------------------------------------
         -- 선납선수
         ----------------------------------------------------------------
                     , CASE WHEN T1.SELL_TP_DTL_CD NOT IN ('21', '23') THEN 0 + T1.BTD_ATAM + T1.MLG_BTD_PRPD_AMT -- 리스면 : 0 +  LC50.LCAM31(기초선수금) + LC50.LCAM71(마일리지기초선수금액)
                            ELSE T1.PRM_BLAM_BTD_AMT + T1.BTD_ATAM + T1.MLG_BTD_PRPD_AMT -- 렌탈이면 : LC50.LCAM21(선납잔액기초금액) +  LC50.LCAM31(기초선수금) + LC50.LCAM71(마일리지기초선수금액)
                             END AS BTD_ATAM -- 기초금액
                     , CASE WHEN T1.SELL_TP_DTL_CD NOT IN ('21', '23') THEN T1.THM_ATAM_DP_AMT + T1.MLG_DP_AMT -- 리스면 : LC50.LCAM32(당월선수금입금금액) + LC50.LCAM72(마일리지입금금액)
                            ELSE T1.THM_ATAM_DP_AMT -- 렌탈이면 : LC50.LCAM32(당월선수금입금금액)
                             END AS ATAM_DP_AMT --선수입금액
                     , CASE WHEN T1.SELL_TP_DTL_CD NOT IN ('21', '23') THEN T1.THM_ATAM_RFND_AMT + T1.MLG_RFND_AMT -- 리스면 : LC50.LCAM33(당월선수금환불금액) + LC50.LCAM73(마일리지환불금액)
                            ELSE T1.THM_ATAM_RFND_AMT -- 렌탈이면 : LC50.LCAM33(당월선수금환불금액)
                             END AS ATAM_RFND_AMT --선수환불금액
                     , CASE WHEN T1.SELL_TP_DTL_CD NOT IN ('21', '23') THEN T1.PRPD_SL_AMT + 0 /*선수이자매출*/ + T1.MLG_SL_AMT -- LC50.LCAM35(선수매출금액) + LC50.LCCM35(선수이자매출) + LC50.LCAM74(마일리지매출금액) @TO-DO LC50.LCCM35(선수이자매출) 컬럼 추가 필요
                            ELSE T1.PRM_SL_AMT + 0 /*선수이자매출*/ + T1.MLG_SL_AMT -- LC50.LCAM25(선납매출금액) + LC50.LCCM35(선수이자매출) + LC50.LCAM74(마일리지매출금액)
                             END AS ATAM_SL_AMT -- 매출대체금액
                     , T1.SL_BND_ALRPY_AMT AS SL_BND_ALRPY_AMT -- 매출입금액(LC50.LCAM38)
                     , T1.SL_DP_AGG_AMT AS SL_DP_AGG_AMT -- 매출입금누계(LC50.LCAM39)
                     , T1.INT_DP_AMT AS  INT_DP_AMT -- 이자입금(LC50.LCCM38)
                     , T1.INT_DP_AGG_AMT AS INT_DP_AGG_AMT -- 이자입금누계(LC50.LCCM39)
                     , T1.SL_DP_AGG_AMT + T1.INT_DP_AGG_AMT AS SUM_SL_DP_AGG_AMT -- 입금누계
                     , T1.THM_UC_BLAM  AS THM_UC_BLAM -- 미수금액(LC50.LCMAMT)
                     , T1.OVR_CTR_DP_AMT AS OVR_CTR_DP_AMT -- 선수대체금액(LC50.LCAM34)
                     , T1.EOT_ATAM + T1.MLG_EOT_PRPD_AMT AS ATAM_TOT_AMT -- 선수총액 (LCAM36 선수기말 + LCAM75 포인트기말)
                     , T1.PRM_BLAM_EOT_AMT AS PRM_BLAM_EOT_AMT -- 선납잔액
                     , T1.MLG_EOT_PRPD_AMT AS MLG_EOT_PRPD_AMT -- PR잔액
                     , T1.EOT_ATAM AS EOT_ATAM-- 선수잔액
         ----------------------------------------------------------------
         -- 청구사항(ASIS 원금, 이자, 서비스 개별관리 → TOBE 통합) @TO-DO 테이블 컬럼 추가 필요
         ----------------------------------------------------------------
                     , 0 AS BIL_BTD_AMT -- 기초금액
                     , 0 AS BIL_SL_AMT -- 발생금액
                     , NVL((SELECT SUM(NVL(RVE_AMT, 0)) FROM W2 WHERE DP_DV_CD = '1'), 0) - NVL((SELECT SUM(NVL(RVE_AMT, 0)) FROM W2 WHERE DP_DV_CD = '2'), 0) AS BIL_DP_AMT -- 입금금액(입금 - 환불)
                     , 0 AS BIL_ADD_AMT -- 추가금액
                     , 0 AS BIL_ADJ_AMT -- 조정금액
                     , 0 AS BIL_EOT_AMT -- 기말금액
         ----------------------------------------------------------------
         -- 위약금
         ----------------------------------------------------------------
                     , NVL(T10.BTD_BOR_AMT,0) AS BTD_BOR_AMT -- 위약금기초금액
                     , NVL(T10.OC_BOR_AMT,0) AS OC_BOR_AMT -- 위약금발생금액
                     , NVL(T10.LS_RNTF,0) AS LS_RNTF -- 분실손료
                     , NVL(T10.DP_CCAM_SUM_AMT - T10.RFND_CCAM_SUM_AMT,0) AS BOR_DP_AMT -- 위약금입금액
                     , NVL(T10.CTR_CCAM_SUM_AMT + T10.SPMT_CCAM_SUM_AMT,0) AS BOR_ADJ_AMT -- 위약금공제금액
                     , NVL(T10.EOT_BOR_AMT,0) AS EOT_BOR_AMT -- 위약금기말금액
         ----------------------------------------------------------------
         -- 연체가산
         ----------------------------------------------------------------
                     , NVL(T6.BTD_DLQ_ADD_AMT, 0) AS BTD_DLQ_ADD_AMT --가산금기초금액
                     , NVL(T6.THM_OC_DLQ_ADD_AMT, 0) AS THM_OC_DLQ_ADD_AMT -- 당월가산금발생금액
                     , NVL(T6.THM_CTR_DLQ_ADD_AMT, 0) AS THM_CTR_DLQ_ADD_AMT -- 당월조정연체가산금액
                     , NVL(T6.THM_DLQ_ADD_DP_SUM_AMT, 0) AS THM_DLQ_ADD_DP_SUM_AMT -- 당월연체가산입금합계금액
                     , NVL(T6.THM_DLQ_ADD_RFND_SUM_AMT, 0) AS THM_DLQ_ADD_RFND_SUM_AMT -- 당월연체가산환불합계금액
                     , NVL(T6.EOT_DLQ_ADD_AMT, 0) AS EOT_DLQ_ADD_AMT -- 기말연체가산금액
         ----------------------------------------------------------------
         -- 연체사항
         ----------------------------------------------------------------
                     , '' AS KEEP_AW_AMT -- 유지수당 LC50.LCCNT1 * ASIS 월마감시 0 셋팅
                     , '' AS KEEP_AW_TOT_AMT -- 유지수당누계금액 LC50.LCCNT2 * ASIS 월마감시 0 셋팅
                     , T6.DLQ_MCN AS DLQ_MCN -- 연체개월
                     , T6.DLQ_ACU_MCN AS DLQ_ACU_MCN -- 연체누적개월수
                     , NVL(T6.EOT_DLQ_AMT, 0) AS EOT_DLQ_AMT -- 연체금액(C50.LCDAMT)
                     , (SELECT NVL(SUM(NVL(DFA_AMT, 0)), 0) FROM TB_CBBO_DFA_IZ WHERE CNTR_NO = T1.CNTR_NO AND CNTR_SN = T1.CNTR_SN AND DTA_DL_YN = 'N') AS DFA_AMT -- 대손금액
                     , NVL((SELECT SUM(NVL(RVE_AMT, 0)) FROM W2 WHERE DP_DV_CD IN ('1', '3') AND RVE_DV_CD = '09'), 0)
                       - NVL((SELECT SUM(NVL(RVE_AMT, 0)) FROM W2 WHERE DP_DV_CD IN ('2', '4') AND RVE_DV_CD = '09'), 0) AS DFA_DP_AMT -- 대손입금액(CW5400P.CWAMT1)
                     , T1.SL_STP_YN AS SL_STP_YN -- 매출중지여부
                     , TRUNC(T1.SL_STP_AMT * 0.3,-1) AS SL_STP_AMT -- 매출중지금액(LC50.LCAM96)
                     , T9.ACTCS_DT AS ACTCS_DT -- 수임일자
                     , T30.RCP_AOFFCE_CD AS RCP_AOFFCE_CD -- 접수사무소코드
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'RCP_AOFFCE_CD' AND CD_VLD_VAL = T30.RCP_AOFFCE_CD) AS RCP_AOFFCE_CD_NM -- 접수사무소명 @TO-DO 사무소명이 집금담당자의 근무지정보이면 집금파트너상세 Table.집금상담사근무지코드(CLCTAM_CSLR_WRKP_CD)를 읽어야 함
                     , T9.CLCTAM_DV_CD AS CLCTAM_DV_CD -- 집금구분코드
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'CLCTAM_DV_CD' AND CD_VLD_VAL = T9.CLCTAM_DV_CD) AS CLCTAM_DV_CD_NM -- 집금구분코드명
                     , T9.CLCTAM_PRTNR_NO AS CLCTAM_PRTNR_NO -- 집금파트너번호
                     , ( SELECT NVL(MAX(PRTNR_KNM), '') FROM TB_CBBO_CLCTAM_PRTNR_DTL WHERE PRTNR_NO  = T9.CLCTAM_PRTNR_NO ) AS CLCTAM_PRTNR_NM -- 집금파트너이름
                     , T30.CLCO_TF_DT AS CLCO_TF_DT -- 발송년월
         ----------------------------------------------------------------
         -- 기타정보
         ----------------------------------------------------------------
                     , '만료유형' AS EXN_TP -- 만료유형(LC31.LCMGU2) @TO-DO 계약에서 코드 확인해주기로 함(앱코드만 존재)
                     , T5.REDF_DT AS REDF_DT -- 되물림일자(LC503.LCSMLY)
                     , T5.ADSB_DT AS ADSB_DT -- 재지급일자(LC503.LCSJGY)
                     , T3.ALNCMP_CD AS ALNCMP_CD -- 제휴사코드(LC31.LCETC8)
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'ALNCMP_CD' AND CD_VLD_VAL = T3.ALNCMP_CD) AS ALNCMP_CD_NM -- 제휴구분명
                     , T3.SELL_DSC_DV_CD AS SELL_DSC_DV_CD -- 할인구분(LC31.LCETC3)
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'RENTAL_DSC_DV_CD' AND CD_VLD_VAL = T3.SELL_DSC_DV_CD) AS SELL_DSC_DV_CD_NM -- 할인구분명
                     , CAST(TRUNC(T3.STPL_PTRM / 12) AS INT) || '년 약정' AS STPL_PTRM -- 약정기간(LC31.LCGUB3)
                     , T8.DP_TP_CD AS DP_TP_CD -- 이체구분코드(LC31.LCCHK1)
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'DP_TP_CD' AND CD_VLD_VAL = T8.DP_TP_CD) AS DP_TP_CD_NM
                     , T8.MPY_BSDT AS MPY_BSDT -- 이체일자
                     , T8.FNIT_APR_RS_CD AS FNIT_APR_RS_CD -- 금융기관승인결과코드
                  FROM TB_CBCL_WELLS_SL_MM_CL_IZ T1  -- WELLS매출월마감내역
                  LEFT OUTER JOIN TB_SSCT_CNTR_BAS T2 -- 계약기본
                    ON T1.CNTR_NO = T2.CNTR_NO
                 INNER JOIN TB_SSCT_CNTR_DTL T3 -- 계약상세
                    ON T3.CNTR_NO = T1.CNTR_NO
                   AND T3.CNTR_SN = T1.CNTR_SN
                  LEFT OUTER JOIN TB_PDBS_PD_BAS T4 --상품기본
                    ON T4.PD_CD = T1.PD_CD
                  LEFT OUTER JOIN TB_CBCL_REDF_ADSB_BAS T5 --되물림재지급기본
                    ON T5.CNTR_NO = T1.CNTR_NO
                   AND T5.CNTR_SN = T1.CNTR_SN
                  LEFT OUTER JOIN TB_CBCL_DLQ_BAS T6 --연체기본
                    ON T6.PERF_YM = T1.SL_CL_YM
                   AND T6.CNTR_NO = T1.CNTR_NO
                   AND T6.CNTR_SN = T1.CNTR_SN
                  LEFT OUTER JOIN TB_SSCT_CNTR_STLM_REL T7 --계약결재관계
                    ON T7.DTL_CNTR_NO = T1.CNTR_NO
                   AND T7.DTL_CNTR_SN = T1.CNTR_SN
                   AND T7.DTA_DL_YN = 'N'
                   AND SUBSTR(T7.VL_STRT_DTM, 1, 6) <![CDATA[<=]]> T1.SL_CL_YM
                   AND SUBSTR(T7.VL_END_DTM, 1, 6) >= T1.SL_CL_YM
                  LEFT OUTER JOIN TB_SSCT_CNTR_STLM_BAS T8 -- 계약결제기본
                    ON T8.CNTR_STLM_ID = T7.CNTR_STLM_ID
                  LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS T9 --채권계약기본
                    ON T9.CNTR_NO = T1.CNTR_NO
                   AND T9.CNTR_SN = T1.CNTR_SN
                   AND T9.BASE_YM = T1.SL_CL_YM
                  LEFT OUTER JOIN TB_CBCL_WELLS_BOR_AMT_BAS T10 -- WELLS위약금액기본
                    ON T10.PERF_YM = T1.SL_CL_YM
                   AND T10.CNTR_NO = T1.CNTR_NO
                   AND T10.CNTR_SN = T1.CNTR_SN
                   AND T10.DTA_DL_YN = 'N'
                  LEFT OUTER JOIN TB_SSCT_RENTAL_ADN_SV_IZ T11 -- 렌탈부가서비스내역
                    ON T11.CNTR_NO = T1.CNTR_NO
                   AND T11.CNTR_SN = T1.CNTR_SN
                   AND T11.ADN_SV_DV_CD = '01'
                   AND T11.ADN_SV_SN = 1
                  LEFT OUTER JOIN LATERAL (SELECT *
                                             FROM (SELECT T1.SL_CL_YM, T1.CNTR_NO, T1.CNTR_SN, RCP_AOFFCE_CD, CLCO_TF_DT
                                             FROM TB_CBBO_WELLS_BND_CLCO_SEND_IZ -- Wells채권추심사송신내역
                                            WHERE CST_NO = SUBSTR(T1.CNTR_NO, 2) || LPAD(T1.CNTR_SN, 3, '0')
                                              AND BASE_YM = T1.SL_CL_YM
                                              AND BZ_HDQ_DV_CD = '20'
                                              AND DTA_DL_YN = 'N'
                                            ORDER BY SEND_SN DESC)
                 WHERE ROWNUM = 1) T30
                    ON T30.SL_CL_YM = T1.SL_CL_YM
                   AND T30.CNTR_NO = T1.CNTR_NO
                   AND T30.CNTR_SN = T1.CNTR_SN
                 WHERE T1.CNTR_NO || T1.CNTR_SN = #{cntrDtlNo}
                   <if test='@MybatisUtils@isNotEmpty(slClYm)'>
                   AND T1.SL_CL_YM = #{slClYm}
                   </if>
                   AND T1.SELL_TP_CD = '2'
                 ORDER BY T1.SL_CL_YM DESC)
         WHERE ROWNUM = 1
    </select>

    <select id="selectRegularShippingDetail" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbSalesPerformanceDetailDto$SearchRegularRes">
        -----------------------------------------------------
        -- 정기배송 매출상세
        -----------------------------------------------------
        <!-- 계약정보 참고 쿼리<select id="selectOrderRegularShippingsPages" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dvo.WctaOrderDetailRglrDlvrPagesDvo"> -->
        SELECT *
          FROM (SELECT
        ----------------------------------------------------------------
        -- 고객기본정보
        ----------------------------------------------------------------
                       T1.CST_NO AS CST_NO -- 고객번호
                     , (SELECT CST_KNM FROM TB_CUBS_CST_BAS WHERE CST_NO = T1.CST_NO AND DTA_DL_YN = 'N') AS CST_KNM -- 고객명
                     , T1.CNTR_NO || '-' || T1.CNTR_SN AS CNTR_DTL_NO -- 계약상세번호
                     , T1.SL_CL_YM AS SL_CL_YM -- 매출년월
        ----------------------------------------------------------------
        -- 계약제품
        ----------------------------------------------------------------
                     , T1.SELL_TP_CD AS SELL_TP_CD     -- 판매유형
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = T1.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
                     , T1.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'SELL_TP_DTL_CD' AND CD_VLD_VAL = T1.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
                     , T1.PD_CD AS PD_CD -- 상품코드
                     , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE PD_CD = T1.PD_CD) AS PD_NM -- 상품명
                     , CASE WHEN T25.HGR_PD_CD IS NOT NULL THEN 'Y' ELSE 'N' END AS RCP_PKG_YN                  /* 접수기준-패키지 여부 (LD3000P@LCPKYN) 맵핑없어서 패키지코드존재여부로 체크함 TODO.재문의 확인필요 */
                     , T25.HGR_PD_CD AS RCP_PKG_CD                                                              /* 접수기준-(패키지 번호:LCPKAG)*/
                     , T25.PD_NM AS RCP_PKG_NM                                                                  /* 접수기준-(패키지명:LCPKAG_NM) */
                     , CASE WHEN T11.HGR_PD_CD IS NOT NULL THEN 'Y' ELSE 'N' END AS PKG_YN                      /* 현재기준-패키지 여부 (LD3000P@LCST07) 맵핑없어서 패키지코드존재여부로 체크함 TODO.재문의 확인필요 */
                     --, T24.PD_CLSF_NM AS PKGCLSF_NM                                                             /* 현재기준-(패키지군:LCST10,LCST10_NM)  맵핑없음. TODO.재문의 제품분류명으로 대체가 맞는가? 함축됨*/
                     , T11.HGR_PD_CD AS PKG_CD                                                                  /* 현재기준-(패키지 번호:LCST12)*/
                     , T24.PD_NM AS PKG_NM                                                                      /* 현재기준-(패키지명:LCST12_NM) */
                     , CASE WHEN T11.HGR_PD_CD IS NOT NULL THEN '패키지'
                            ELSE '개별'
                             END AS PKG_TP_NM  /*패키지 유형 명*/
                     , T14.SELL_TP_CD ||'.' || (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = T14.SELL_TP_CD) AS MCHN_SELL_TP_NM /* 기기정보-판매유형(원주문) (업무구분:LCJTYP,LCJTYP_NM) */
                     , T14.CNTR_NO      AS MCHN_CNTR_NO                                         /* 기기정보-계약번호  ORYRCD*/
                     , T14.CNTR_SN      AS MCHN_CNTR_SN                                         /* 기기정보-계약번호일련번호 ORYRCD(LCJYER-LCJCOD) */
                     , T16.RCGVP_KNM    AS MCHN_RCGVP_KNM                                       /* 기기정보- 수령자한글명 ORCNAM(LCCNAM) */
                     , T14.BASE_PD_CD   AS MCHN_PD_CD                                           /* 기기정보- 기기상품 - ORICDE(LCICDE) */
                     , T16.PD_NM        AS MCHN_PD_NM                                           /* 기기정보- 기기상품명 - ORINA3 (LCICDE,KAINA1) */
                     --, F_CMZ_CD_NM('TNT_WELLS', 'SV_TP_CD', T16.SV_PD_TP_CD) AS MCHN_SV_TP_NM   /* 용도구분 - 상품의 서비스유형 (용도구분명:ORIUSE_NM, LCIUSE) */
                     --, T14.SV_PRD       AS MCHN_SV_PRD              /* 기기정보- 서비스주기 (관리주기:ORIMON, LCIMON)*/
                     --, T16.PD_MCLSF_NM  AS MCHN_PD_MCLSF_NM         /* 기기정보-상품중분류 기기종류:LCPRD1_NM, LCPRD1 (웰스팜, 커피머신) */
                     --, F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_DTL_CD', T11.SELL_TP_DTL_CD) AS MCHN_PD_MCLSF_NM   /* 기기정보-상품중분류 기기종류:LCPRD1_NM, LCPRD1 (웰스팜, 커피머신) */
                     --, T16.PD_DCLSF_NM  AS MCHN_PD_LCLSF_NM         /* 기기정보-상품소분류 기기구분:LCPRD2_NM , LCPRD2*/
                     --, F_CMZ_CD_NM('TNT_WELLS', 'PD_TP_CD', T4.PD_TP_CD) AS PD_TP_CM           /* 상품유형코드(C:복합-패키지) - 제품선택유형(LCST09)*/
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'RGLR_SPP_PRC_DV_CD' AND CD_VLD_VAL = T9.PD_PRP_VAL13) AS RGLR_SPP_PRC_DV_CD           /* 판매유형(LD30.LCST05) - 결합/분리*/
                     , T1.SELL_AMT AS SELL_AMT --판매금액
                     , T1.RENTAL_AMT AS RENTAL_AMT --추가금액
                     , T1.DSC_AMT AS DSC_AMT --할인금액
                     , CASE WHEN T11.STLM_TP_CD = '2' -- 할부
                            THEN (NVL(T1.SELL_AMT, 0) + NVL(T1.RENTAL_AMT, 0) - NVL(T1.DSC_AMT, 0)) / T11.SV_PRD
                            ELSE 0
                             END AS MM_ISTM_AMT --월청구금액
                     , T1.CNTR_DT AS CNTR_DT -- 접수일자
                     , (SELECT MIN(SUBSTR(SPP_DTM, 1, 8))
                          FROM TB_CBCL_WELLS_SL_MM_CL_IZ
                         WHERE CNTR_NO = T1.CNTR_NO
                           AND CNTR_SN = T1.CNTR_SN
                           AND SPP_DTM IS NOT NULL AND SPP_DTM <![CDATA[<>]]> '') AS SPP_DT --최초배송일자
                     , CASE WHEN T1.SELL_TP_CD IN ('6', '9') THEN SUBSTR(T1.SPP_DTM, 1, 8) -- 정기배송('6'), 필터('9') : 배송일자, 나머지는 설치일자가 매출일자임
                            ELSE SUBSTR(T1.IST_DTM, 1, 8)
                             END AS LCSLE_DT -- 매출일자
        --------------------------------------------------------------
        -- 매출사항
        --------------------------------------------------------------
                     , CASE WHEN MOD(T31.SL_PERIOD, T11.SV_PRD) = 0 THEN 'Y' ELSE '' END AS SL_OCC_YM --매출발생월(LD50.LCDFLG)
                     , '' AS SPP_YN --배송여부 @TO-DO
                     , T1.RENTAL_TN AS RENTAL_TN --진행차월
                     , T1.SPP_TN AS SPP_TN -- 배송차월
                     , T1.RENTAL_DC AS RENTAL_DC --사용일수(일)
                     , T1.CAN_DT AS CAN_DT -- 취소일자
                     , T1.NOM_SL_AMT AS NOM_SL_AMT --정상매출금액
                     , T1.NOM_DSC_AMT AS NOM_DSC_AMT--정상할인금액
                     , T1.FSH_DT AS FSH_DT -- 완료일자 @TO-DO 이행 반영 필요
                     , T1.SPMT_SL_AMT AS SPMT_SL_AMT --추가매출금액
                     , T1.SPMT_DSC_AMT AS SPMT_DSC_AMT--추가할인금액
                     , T1.SL_CTR_AMT AS SL_CTR_AMT --매출조정금액
                     , T1.THM_SL_SUM_AMT AS THM_SL_SUM_AMT -- 매출금액
                     , T1.SL_SUM_VAT AS SL_SUM_VAT -- 매출VAT
                     , T1.SL_AGG_AMT AS SL_AGG_AMT -- 매출누계금액
                     , T1.DSC_AGG_AMT AS DSC_AGG_AMT --할인누계금액
                     , T1.CTR_AGG_AMT AS CTR_AGG_AMT --조정누계금액
                     , NVL((SELECT NVL(UC_AMT, 0)
                              FROM TB_CBCL_SL_BND_ALRPY_BAS -- 채권반제
                             WHERE BASE_YM = T1.SL_CL_YM
                               AND CNTR_NO = T1.CNTR_NO
                               AND CNTR_SN = T1.CNTR_SN
                               AND DTA_DL_YN = 'N'), 0) AS UC_AMT-- 매출잔액
        --------------------------------------------------------------
        -- 선수금액
        --------------------------------------------------------------
                     , T1.BTD_ATAM AS BTD_ATAM --기초금액
                     , T1.THM_ATAM_DP_AMT AS THM_ATAM_DP_AMT --선수입금액
                     , T1.THM_ATAM_RFND_AMT AS THM_ATAM_RFND_AMT --선수환불금액
                     , T1.PRPD_SL_AMT AS PRPD_SL_AMT --매출대체금액
                     , T1.SL_BND_ALRPY_AMT AS SL_BND_ALRPY_AMT --매출입금액
                     , T1.SL_DP_AGG_AMT AS SL_DP_AGG_AMT --입금누계금액
                     , T1.OVR_CTR_DP_AMT AS OVR_CTR_DP_AMT --선수대체금액
                     , T1.EOT_ATAM AS EOT_ATAM --선수잔액
                     , T1.THM_UC_BLAM AS THM_UC_BLAM --미수총액
                     , NVL(T5.EOT_DLQ_AMT, 0) AS EOT_DLQ_AMT --연체금액
        --------------------------------------------------------------
        -- 청구미수
        --------------------------------------------------------------
                     , T1.BTD_UC_AMT AS BTD_UC_AMT --기초금액
                     , 0 AS THM_EXP_AMT --당월예정금액 @TO-DO
                     , 0 AS THM_ADD_AMT --당월추가금액 @TO-DO
                     , 0 AS THM_DP_AMT --당월입금액 @TO-DO
                     , 0 AS THM_ADJ_AMT --당월조정금액 @TO-DO
                     , T1.EOT_UC_AMT AS EOT_UC_AMT --청구잔액 @TO-DO
                     , 0 AS NEXT_MON_AMT1 --차월금액 @TO-DO
                     , 0 AS NEXT_MON_AMT2 --차차월금액 @TO-DO
        --------------------------------------------------------------
        -- 연체사항
        --------------------------------------------------------------
                     , T5.DLQ_MCN AS DLQ_MCN -- 연체개월
                     , T5.DLQ_ACU_MCN AS DLQ_ACU_MCN -- 연체누적개월수
                     , T1.SL_STP_YN AS SL_STP_YN -- 매출중지여부
                     , T8.ACTCS_DT AS ACTCS_DT -- 수임일자
                     , T30.RCP_AOFFCE_CD AS RCP_AOFFCE_CD -- 접수사무소코드
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'RCP_AOFFCE_CD' AND CD_VLD_VAL = T30.RCP_AOFFCE_CD) AS RCP_AOFFCE_CD_NM -- 접수사무소명 @TO-DO 사무소명이 집금담당자의 근무지정보이면 집금파트너상세 Table.집금상담사근무지코드(CLCTAM_CSLR_WRKP_CD)를 읽어야 함
                     , T8.CLCTAM_DV_CD AS CLCTAM_DV_CD -- 집금구분코드
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'CLCTAM_DV_CD' AND CD_VLD_VAL = T8.CLCTAM_DV_CD) AS CLCTAM_DV_CD_NM -- 집금구분코드명
                     , T8.CLCTAM_PRTNR_NO AS CLCTAM_PRTNR_NO -- 집금파트너번호
                     , (SELECT NVL(MAX(PRTNR_KNM), '') FROM TB_CBBO_CLCTAM_PRTNR_DTL WHERE PRTNR_NO  = T8.CLCTAM_PRTNR_NO) AS CLCTAM_PRTNR_NM -- 집금파트너이름*/
        --------------------------------------------------------------
        -- 기타정보
        --------------------------------------------------------------
                     , T7.DP_TP_CD AS DP_TP_CD -- 이체구분코드(LC31.LCCHK1)
                     , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = 'TNT_WELLS' AND CD_ID = 'DP_TP_CD' AND CD_VLD_VAL = T7.DP_TP_CD) AS DP_TP_CD_NM
                     , T7.MPY_BSDT AS MPY_BSDT -- 이체일자
                     , T7.FNIT_APR_RS_CD AS FNIT_APR_RS_CD -- 금융기관승인결과코드
                  FROM  TB_CBCL_WELLS_SL_MM_CL_IZ T1  -- WELLS매출월마감내역
                 INNER JOIN TB_SSCT_CNTR_BAS T2 -- 계약기본
                    ON T1.CNTR_NO = T2.CNTR_NO
                 INNER JOIN TB_SSCT_CNTR_DTL T11 -- 계약상세
                    ON T1.CNTR_NO = T11.CNTR_NO
                   AND T1.CNTR_SN = T11.CNTR_SN
                  LEFT OUTER JOIN TB_PDBS_PD_BAS T4 --상품기본
                    ON T1.PD_CD = T4.PD_CD
                  LEFT OUTER JOIN TB_CBCL_DLQ_BAS T5 --연체기본
                    ON T1.SL_CL_YM = T5.PERF_YM
                   AND T1.CNTR_NO = T5.CNTR_NO
                   AND T1.CNTR_SN = T5.CNTR_SN
                  LEFT OUTER JOIN TB_SSCT_CNTR_STLM_REL T6 --계약결재관계
                    ON T6.DTL_CNTR_NO = T1.CNTR_NO
                   AND T6.DTL_CNTR_SN = T1.CNTR_SN
                   AND SUBSTR(T6.VL_STRT_DTM, 1, 6) <![CDATA[<=]]> T1.SL_CL_YM
                   AND SUBSTR(T6.VL_END_DTM, 1, 6) >= T1.SL_CL_YM
                  LEFT OUTER JOIN TB_SSCT_CNTR_STLM_BAS T7 -- 계약결제기본
                    ON T7.CNTR_STLM_ID = T6.CNTR_STLM_ID
                  LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS T8 --채권계약기본
                    ON T8.CNTR_NO = T1.CNTR_NO
                   AND T8.CNTR_SN = T1.CNTR_SN
                   AND T8.BASE_YM = T1.SL_CL_YM
                  LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL T9
                    ON T9.PD_CD = T4.PD_CD
                   AND T9.PD_EXTS_PRP_GRP_CD  ='CNTR'
                  LEFT OUTER JOIN LATERAL (SELECT BASE_DTL_CNTR_NO
                                                , BASE_DTL_CNTR_SN
                                                , OJ_DTL_CNTR_NO
                                                , OJ_DTL_CNTR_SN
                                             FROM TB_SSCT_CNTR_REL
                                            WHERE BASE_DTL_CNTR_NO = T11.CNTR_NO
                                              AND BASE_DTL_CNTR_SN = T11.CNTR_SN
                                              AND CNTR_REL_DTL_CD IN ('214')           /* 계약관계상세코드 : 원주문 - 정기배송(214) */
                                              AND DTA_DL_YN = 'N'
                                              AND VL_END_DTM = (SELECT MAX(VL_END_DTM)
                                                                  FROM TB_SSCT_CNTR_REL T131
                                                                 WHERE  1=1
                                                                   AND T131.BASE_DTL_CNTR_NO = T11.CNTR_NO
                                                                   AND T131.BASE_DTL_CNTR_SN = T11.CNTR_SN
                                                                   AND T131.CNTR_REL_DTL_CD IN ('214')     /* 계약관계상세코드 : 원주문 - 정기배송(214) */
                                                                   AND T131.DTA_DL_YN = 'N')) T13          /*유효종료일시*/

                    ON T13.BASE_DTL_CNTR_NO = T11.CNTR_NO
                   AND T13.BASE_DTL_CNTR_SN = T11.CNTR_SN
                  LEFT OUTER JOIN TB_SSCT_CNTR_DTL T14           /*T.계약상세 -> 정기배송 원주문.*/
                    ON T14.CNTR_NO = T13.OJ_DTL_CNTR_NO         /*계약번호  */
                   AND T14.CNTR_SN = T13.OJ_DTL_CNTR_SN         /*계약번호일련번호  */
                   AND T14.DTA_DL_YN = 'N'
                  LEFT OUTER JOIN LATERAL (SELECT /* 기기정보 추가정보 */
                                                  T161.DTL_CNTR_NO
                                                , T161.DTL_CNTR_SN
                                                , T162.RCGVP_KNM    /* 수령자한글명 */
                                                , T164.PD_NM        /* 상품명 */
                                                , T164.SV_PD_TP_CD /* 기기용도 */
                                                , T165.PD_CLSF_NM AS PD_MCLSF_NM    /* 상품중분류 */
                                                , T166.PD_CLSF_NM AS PD_DCLSF_NM    /* 상품소분류 */
                                             FROM TB_SSCT_CNTR_ADR_REL T161      /* T.계약주소관계 - 설치지 */
                                             LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS T162    /* T.계약주소지기본 - 설치지 */
                                               ON T162.CNTR_ADRPC_ID = T161.CNTR_ADRPC_ID
                                              AND T162.DTA_DL_YN = 'N'
                                             LEFT OUTER JOIN TB_GBCO_ADR_BAS T163           /* T.주소기본 - 설치지 */
                                               ON T163.ADR_ID = T162.ADR_ID
                                              AND T163.DTA_DL_YN = 'N'
                                             LEFT OUTER JOIN TB_PDBS_PD_BAS T164            /* T.상품기본 -  */
                                               ON T164.PD_CD = T14.BASE_PD_CD               /* 상품코드 */
                                              AND T164.TEMP_SAVE_YN = 'N'                   /* 임시저장여부 */
                                              AND T164.DTA_DL_YN = 'N'                      /* 데이터삭제여부 */
                                             LEFT OUTER JOIN TB_PDBS_PD_CLSF_BAS T165       /* T.상품분류기본 중분류명 =중분류명 */
                                               ON T165.PD_CLSF_ID = T164.PD_MCLSF_ID        /* 상품분류ID */
                                              AND T165.DTA_DL_YN = 'N'
                                             LEFT OUTER JOIN TB_PDBS_PD_CLSF_BAS T166       /* T.상품분류기본 상품소분류ID 소분류명 */
                                               ON T166.PD_CLSF_ID = T164.PD_DCLSF_ID        /* 상품분류ID */
                                              AND T166.DTA_DL_YN = 'N'
                                            WHERE T161.DTL_CNTR_NO = T14.CNTR_NO
                                              AND T161.DTL_CNTR_SN = T14.CNTR_SN
                                              AND T161.ADRPC_TP_CD IN ('2', '3')                    /* 주소지유형코드 : 설치지(3)  */
                                              AND T161.VL_END_DTM = '99991231235959'        /* 유효종료일시 */
                                              AND T161.DTA_DL_YN = 'N') T16    /* 기기정보의 설치정보*/
                    ON T16.DTL_CNTR_NO = T14.CNTR_NO       /* 멤버십의 원주문을 대상으로 지정하여 결합된 계약 */
                   AND T16.DTL_CNTR_SN = T14.CNTR_SN
                  LEFT OUTER JOIN LATERAL (SELECT /* 현재 패키지 - 정보 명칭/패키지분류*/
                                                  T240.PD_CD         /* 패키지코드 데체*/
                                                , T240.PD_NM         /* 패키지명 데체*/
                                                , T241.PD_CLSF_NM    /* 패키지군명(분류명) 데체*/
                                             FROM TB_PDBS_PD_BAS T240                /* T.상품기본 -  */
                                            INNER JOIN TB_PDBS_PD_CLSF_BAS T241     /* T.상품분류기본 상품중분류ID = */
                                               ON T241.PD_CLSF_ID = T240.PD_CLSF_ID/* 상품분류ID */
                                              AND T241.DTA_DL_YN = 'N'
                                            WHERE 1=1
                                              AND T240.TEMP_SAVE_YN = 'N'                /* 임시저장여부 */
                                              AND T240.DTA_DL_YN = 'N'                   /* 데이터삭제여부 */
                                              AND T240.PD_CD = T11.HGR_PD_CD) T24
                    ON T24.PD_CD = T11.HGR_PD_CD
                  LEFT OUTER JOIN LATERAL (SELECT /*+LEADING(DHIST) INDEX(DHIST ARR_TB_SSCT_CNTR_DCH_HIST) USE_NL(DHIST PBAS)*/
                                                  /* 최초 접수시 패키지 정보 */
                                                  DHIST.HGR_PD_CD   /* 접수기준 - 패키지번호 */
                                                , PBAS.PD_NM       /* 접수기준 - 패키지명 */
                                                , DHIST.CNTR_NO
                                                , DHIST.CNTR_SN
                                             FROM TB_SSCT_CNTR_DCH_HIST DHIST /* 계약상세변경이력 */
                                            INNER JOIN TB_PDBS_PD_BAS PBAS /* 상품기본 */
                                               ON PBAS.PD_CD = DHIST.HGR_PD_CD
                                              AND PBAS.DTA_DL_YN = 'N'
                                            WHERE 1=1
                                            --AND DHIST.CNTR_NO = T11.CNTR_NO
                                            --AND DHIST.CNTR_SN = T11.CNTR_SN
                                              AND DHIST.HIST_STRT_DTM IN (SELECT NVL(MIN(HIST_STRT_DTM) ,'') /* 이력시작일시 */
                                                                            FROM TB_SSCT_CNTR_CH_HIST
                                                                           WHERE 1=1
                                                                             AND CNTR_NO = DHIST.CNTR_NO
                                                                             AND CNTR_PRGS_STAT_CD = '60' /*계약진행상태코드:확정(60)*/
                                                                             AND DTA_DL_YN = 'N')) T25
                    ON T25.CNTR_NO = T1.CNTR_NO
                   AND T25.CNTR_SN = T1.CNTR_SN
                  LEFT OUTER JOIN LATERAL (SELECT *
                                             FROM (SELECT T1.SL_CL_YM, T1.CNTR_NO, T1.CNTR_SN, RCP_AOFFCE_CD
                                                     FROM TB_CBBO_WELLS_BND_CLCO_SEND_IZ -- Wells채권추심사송신내역
                                                    WHERE CST_NO = SUBSTR(T1.CNTR_NO, 2) || LPAD(T1.CNTR_SN, 3, '0')
                                                      AND BASE_YM = T1.SL_CL_YM
                                                      AND BZ_HDQ_DV_CD = '20'
                                                      AND DTA_DL_YN = 'N'
                                                    ORDER BY SEND_SN DESC)
                                            WHERE ROWNUM = 1) T30
                    ON T30.SL_CL_YM = T1.SL_CL_YM
                   AND T30.CNTR_NO = T1.CNTR_NO
                   AND T30.CNTR_SN = T1.CNTR_SN
                  LEFT OUTER JOIN LATERAL (SELECT MONTHS_BETWEEN(TO_DATE(SL_CL_YM || '01', 'YYYY-MM-DD')
                                                , (SELECT TO_DATE(SL_CM_YMD, 'YYYY-MM-DD')
                                                     FROM (SELECT SL_CL_YM || '01' AS SL_CM_YMD
                                                             FROM TB_CBCL_WELLS_SL_MM_CL_IZ
                                                            WHERE CNTR_NO = T1.CNTR_NO
                                                              AND CNTR_SN = T1.CNTR_SN
                                                            ORDER BY SL_CL_YM ASC)
                                                    WHERE ROWNUM = 1)) AS SL_PERIOD -- 매출실적월과 최초매출발생월간의 개월수
                                                , SL_CL_YM
                                                , CNTR_NO
                                                , CNTR_SN
                                             FROM TB_CBCL_WELLS_SL_MM_CL_IZ
                                            WHERE CNTR_NO = T1.CNTR_NO
                                             AND CNTR_SN = T1.CNTR_SN) T31
                    ON T31.SL_CL_YM = T1.SL_CL_YM
                   AND T31.CNTR_NO = T1.CNTR_NO
                   AND T31.CNTR_SN = T1.CNTR_SN
                 WHERE T1.CNTR_NO || T1.CNTR_SN = #{cntrDtlNo}
                   <if test="@MybatisUtils@isNotEmpty(slClYm)">
                   AND T1.SL_CL_YM = #{slClYm}
                   AND T1.SELL_TP_CD = '6'
                   </if>
                 ORDER BY T1.SL_CL_YM DESC)
         WHERE ROWNUM = 1
    </select>

</mapper>
