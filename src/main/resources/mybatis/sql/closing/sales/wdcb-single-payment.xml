<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.closing.sales.mapper.WdcbSinglePaymentMapper">
    <select id="selectBaseInformation" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbSinglePaymentDto$BaseSearchRes">
        <!-- [Wells]일시불 매출 정보 조회 -->
        WITH T1 AS (SELECT *
                      FROM TB_CBCL_BZNS_ATAM_BAS -- 영업선수금
                     WHERE CNTR_NO = #{cntrNo}
                       AND CNTR_SN = #{cntrSn})
           , T2 AS (SELECT A.CNTR_CH_RCP_ID
                         , A.CNTR_CH_SN
                         , B.CNTR_CH_FSH_DTM AS CNTR_CH_FSH_DTM
                         , C.IST_DT AS IST_DT
                      FROM TB_SSCT_CNTR_CH_RCP_DTL A -- 계약변경접수상세
                     INNER JOIN TB_SSCT_CNTR_CH_RCP_BAS B -- 계약변경접수기본
                        ON A.CNTR_CH_RCP_ID = B.CNTR_CH_RCP_ID
                       AND B.CNTR_CH_TP_CD = '201' -- 계약변경 유형코드(201 : 계약상세/상품변경)
                       AND B.APR_DTM IS NOT NULL   -- 승인일시
                       AND B.DTA_DL_YN = 'N'
                      LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL C
                        ON C.CNTR_NO = A.DTL_CNTR_NO
                       AND C.CNTR_SN = A.DTL_CNTR_SN
                       AND C.DTA_DL_YN = 'N'
                     WHERE A.DTL_CNTR_NO = #{cntrNo}
                       AND A.DTL_CNTR_SN = #{cntrSn}
                       AND A.DTA_DL_YN = 'N')
        SELECT F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', A.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형
             , A.CNTR_NO || '-' || A.CNTR_SN AS CNTR_DTL_NO -- 계약상세번호
             , C.CST_KNM AS CST_KNM -- 고객명
             , F_CMZ_CD_NM('TNT_WELLS', 'COPN_DV_CD', C.COPN_DV_CD) AS COPN_DV_CD_NM -- 고객구분
             , D.PRTNR_KNM || '(' || D.PRTNR_NO || ')' AS PRTNR_KNM -- 판매자정보
             , A.CNTR_DT AS CNTR_DT --계약일
             , A.SL_RCOG_DT AS SL_RCOG_DT -- 매출일자
             , A.CAN_DT AS CAN_DT --취소일
             , D.OG_NM || '(' || D.OG_CD || ')' AS OG_INFO-- 조직정보
             , A.PD_CD || '(' || E.PD_NM || ')' AS PD_INFO -- 상품정보
             , F.DSC_AMT AS DSC_AMT -- 할인금액
             , '확인필요' AS DSC_TP -- @TO-DO 할인유형코드(LC30.LCETC4)
             , '확인필요' AS ALNC_STU -- @TO-DO 제휴상태(LC30.LCCK03)
             , G.SELL_EV_CD || '(' || F_CMZ_CD_NM('TNT_WELLS', 'SELL_EV_CD', G.SELL_EV_CD) || ')' AS SELL_EV_CD --행사정보(LC30.LCETC9)
             , A. SELL_AMT AS SELL_AMT --판매가격
             , ( SELECT NVL(SUM(NVL(ALNC_FEE, 0)), 0)
                   FROM TB_RVDW_RVE_DTL -- 수납상세
                  WHERE CNTR_NO = A.CNTR_NO
                    AND CNTR_SN = A.CNTR_SN
                    AND DTA_DL_YN = 'N' ) AS ALNC_FEE -- 제휴수수료(LC30.LCFAMT)
             /* @TO-DO TOBE에는 인수금 관리하지 않음
              * 단, 월마감실적에 청약금이 있는데(SUBSC_AMT), 마이그는 CWSAMT+CWAAMT로 하고 있음
              * → 분리해서 마이그하고, 화면에서는 ASIS만 보여줄지 정의 필요
              */
             , (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '01' AND DP_DV_CD IN ('1', '3'))
             - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '01' AND DP_DV_CD IN ('2', '4')) AS SUBSC_AMT -- @TO-DO 청약금액(CW50.CWSAMT 값이 0이면, LC30.LCSAMT)
             , '삭제대상' AS TK_AMT -- @TO-DO 인수금액(CW50.CWAAMT)
             , F.CRP_UC_AMT AS CRP_UC_AMT -- 법인미수금액(LC30.LCGAMT)
             , A.ISTM_PCAM_AMT AS ISTM_PCAM_AMT-- 잔액(CW50.CWJAMT(할부원금) 값이 0이면, LC30.LCJAMT 값)
             , A.ISTM_MCN || '*' || A.MM_ISTM_AMT AS ISTM_INFO --할부정보(CW50.CWMONT, CW50.CWMAMT)
             , A.ISTM_FEE_LVY_AMT AS ISTM_FEE_LVY_AMT -- 수수료금액(CW50.CWCAMT 값이 0이면, LC30.LCCAMT)
             , A.FULPY_DT AS FULPY_DT -- 완불일자
             , '삭제대상' AS FST_FULPY_DT -- 최초완불일자(CW50.CWLSTY) -- @TO-DO TOBE는 관리하지 않음
             , ( SELECT TO_CHAR(TO_DATE(MAX(HIST_STRT_DTM), 'YYYYMMDDHH24MISS'),'YYYYMMDD')
                   FROM TB_SSCT_CNTR_DCH_HIST -- 계약상세변경이력
                  WHERE CNTR_NO = A.CNTR_NO
                    AND CNTR_SN  = A.CNTR_SN
                    AND DTA_DL_YN = 'N' ) AS CNTR_CHN_DT --변동일자(CW50.CWCHGY)
             , CASE WHEN I.ACDBT_DT IS NOT NULL THEN '대손' ELSE ' ' END AS CWKGUBNM -- 계정구분(CW50.CWKGUB) CASE WHEN CW50.CWKGUB='2' THEN '대손' ELSE ' ' END AS CWKGUBNM
             , CASE WHEN ( SELECT COUNT(*) FROM T2 ) = 0 THEN '' -- 상품변경신청 건이 없으면 ''
                    WHEN ( SELECT NVL(TO_CHAR(MAX(CNTR_CH_FSH_DTM), 'YYYYMMDD'), '') FROM T2 ) <![CDATA[<]]> ( SELECT NVL(MIN(IST_DT), '') FROM T2 ) THEN ( SELECT NVL(TO_CHAR(MAX(CNTR_CH_FSH_DTM), 'YYYYMMDD'), '') FROM T2 ) -- 상품변경신청건이 있고, 설치일자 이전에 계약변경이 처리되었으면 상변일자 셋팅
                    ELSE ''
                     END AS PD_CH_DT -- 상변일자(LC30.LCCHGY)*/
             , CASE WHEN ( SELECT COUNT(*) FROM T2 ) = 0 THEN '' -- 상품변경신청 건이 없으면 ''
                    WHEN ( SELECT NVL(TO_CHAR(MAX(CNTR_CH_FSH_DTM), 'YYYYMMDD'), '') FROM T2 ) > ( SELECT NVL(MIN(IST_DT), '') FROM T2 ) THEN ( SELECT NVL(TO_CHAR(MAX(CNTR_CH_FSH_DTM), 'YYYYMMDD'), '') FROM T2 ) -- 상품변경신청건이 있고, 설치일자 이후에 계약변경이 처리되었으면 매변일자 셋팅
                    ELSE ''
                     END AS SL_CH_DT -- 매변일자(LC30.LCMAEY)
             , '삭제대상' AS SL_CH_SN -- @TO-DO 매변일련번호(CW45.CWSEQN) ※ TOBE 관리 필드 없음
             , (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '03' AND DP_DV_CD IN ('1', '3'))
             - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '03' AND DP_DV_CD IN ('2', '4')) AS ISTM_TOT_DP_AMT -- 할부입금액(CW50.CWPAMT)
             , (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '01' AND DP_DV_CD IN ('1', '3'))
             - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '01' AND DP_DV_CD IN ('2', '4')) AS SUBSC_TOT_DP_AMT -- 청약입금액(ASIS쿼리에는 조회하지 않음)
             , (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '06' AND DP_DV_CD IN ('1', '3'))
             - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '06' AND DP_DV_CD IN ('2', '4')) AS SL_CH_TOT_DP_AMT -- 매변입금액(CW45.CWPAMT)
             , '삭제대상' AS TK_DP_AMT-- @TO-DO 인수입금액(CW50.CWAAMT) ※ 인수금액 TOBE 삭제
             , '삭제대상' AS CRP_DP_AMT -- @TO-DO 법인미수금액(CW50.CWGAMT) 수납쪽 입금구분에 법인미수금 코드가 있는데, TOBE에서는 계약금으로 합치는거로 되어있음
             , (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE DP_DV_CD IN ('1', '3'))
             - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE DP_DV_CD IN ('2', '4')) AS TOT_DP_AMT -- 입금총액(청약금액+인수금액+납입금액, CW50.CWSAMT+CW50.CWAAMT+CW50.CWPAMT)
             , O.DP_TP_CD AS DP_TP_CD -- 이체구분코드(LC31.LCCHK1)
             , O.MPY_BSDT AS MPY_BSDT -- 이체일자
             , H.DLQ_MCN AS DLQ_MCN -- 연체개월수(CW50.CWDCNT)
             , H.THM_OC_DLQ_AMT AS THM_OC_DLQ_AMT -- 연체금액(CW50.CWDAMT)
             , A.CNTR_TAM
             - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE DP_DV_CD IN ('1', '3'))
             - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE DP_DV_CD IN ('2', '4')) AS UC_BLAM --미수금액(CW50.CWQAMT - (CW50.CWSAMT + CW50.CWAAMT + CW50.CWPAMT))
             , '삭제대상' AS UC_PRT --미수출력(CW50.CWFLG2)
             , I.ACDBT_DT AS ACDBT_DT -- 대손일자(CW50.CWBDDT)
             , I.DFA_AMT AS DFA_AMT --대손금액(CW50.CWAMT4)
             , (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '09' AND DP_DV_CD IN ('1', '3'))
             - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '09' AND DP_DV_CD IN ('2', '4')) AS DFA_DP_AMT -- 대손입금액(CW5400P.CWAMT1)
             , I.DFA_AMT
             - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '09' AND DP_DV_CD IN ('1', '3'))
             - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '09' AND DP_DV_CD IN ('2', '4')) AS DFA_BLAM -- 대손잔액(대손금액 - 대손입금액)
             , (SELECT NVL(MAX(RVE_DT), '') FROM T1 WHERE RVE_DV_CD = '09' AND DP_DV_CD IN ('1', '3') ) AS DFA_RVE_DT -- 대손납입일자(CW5400P.CWACTY)
             , '확인필요' AS DFA_FNS_AMT -- @TO-DO 대손완불금액(ASIS 쿼리 이상함)
             , L.ACTCS_DT AS ACTCS_DT -- 수임일자(CW50.CWPRTY)
             , L.CLCTAM_DV_CD || '(' || F_CMZ_CD_NM('TNT_WELLS', 'CLCTAM_DV_CD', L.CLCTAM_DV_CD) || ')' AS CLCTAM_DV_CD_NM -- @TO-DO 집금유형(CW50.CWPRTY) CASE WHEN CW50.CWPGUB = '1' THEN '통　신' WHEN CW50.CWPGUB = '2' THEN '방　문' WHEN CW50.CWPGUB = '3' THEN '특　수' ELSE '******' END AS CWPDSP
             , L.CLCTAM_PRTNR_NO || '(' || (SELECT NVL(MAX(PRTNR_KNM), '') FROM TB_CBBO_CLCTAM_PRTNR_DTL WHERE PRTNR_NO  = L.CLCTAM_PRTNR_NO ) || ')' AS CLCTAM_PRTNR_NM -- 집금담당(CW50.CWPRTY)
             , B.DSB_GUR_TP_CD  || '(' || F_CMZ_CD_NM('TNT_WELLS', 'DSB_GUR_TP_CD', B.DSB_GUR_TP_CD) || ')' AS DSB_GUR_TP_CD -- 지급보증유형(CW50.CWJFLG)
             , M.BU_NOTI_DT AS BU_NOTI_DT -- 부담통보일자(CW50.CWSTBY)
             , J.REDF_DT AS REDF_DT -- 되물림일자(CW50.CWSMLY)
             , J.ADSB_DT AS ADSB_DT -- 재지급일자(CW50.CWSJGY)
             , M.BU_NOTI_TP_CD || '_' || F_CMZ_CD_NM('TNT_WELLS', 'BU_NOTI_TP_CD', M.BU_NOTI_TP_CD) AS BU_NOTI_TP_CD_NM -- 통보내용(CW50.CWTFLG)
             , F_CMZ_CD_NM('TNT_WELLS', 'VAC_BNK_CD', ( SELECT VAC_BNK_CD
                                                          FROM (SELECT VACI.*
                                                                     , DENSE_RANK() over(PARTITION BY VAC_IS_CST_NO ORDER BY VAC_IS_DTM DESC, VAC_RGST_DTM DESC) AS RANK
                                                                  FROM  TB_RVDW_VAC_IS_IZ VACI
                                                                 WHERE  VACI.DTA_DL_YN      = 'N'
                                                                   AND  VACI.VAC_USE_DV_CD  = '02'         /* 가상계좌사용구분코드 02:채권 */
                                                                   AND  VACI.VAC_IS_DV_CD   = '5'          /* 가상계좌발급구분코드 5:연체집금용 */
                                                                   AND  VACI.VAC_IS_CST_NO  = '034464321'  /* 가상계좌발급고객번호 */ )
                                                         WHERE RANK = 1)) AS VAC_BNK_CD -- 은행명
             , (SELECT VAC_NO
                  FROM (SELECT VACI.*
                             , DENSE_RANK() over(PARTITION BY VAC_IS_CST_NO ORDER BY VAC_IS_DTM DESC, VAC_RGST_DTM DESC) AS RANK
                          FROM  TB_RVDW_VAC_IS_IZ VACI
                         WHERE  VACI.DTA_DL_YN      = 'N'
                           AND  VACI.VAC_USE_DV_CD  = '02'         /* 가상계좌사용구분코드 02:채권 */
                           AND  VACI.VAC_IS_DV_CD   = '5'          /* 가상계좌발급구분코드 5:연체집금용 */
                           AND  VACI.VAC_IS_CST_NO  = '034464321'  /* 가상계좌발급고객번호 */)
                 WHERE RANK = 1) AS VAC_NO -- 가상계좌번호
          FROM TB_CBCL_WELLS_SL_MM_CL_IZ A -- WELLS매출월마감내역
         INNER JOIN TB_SSCT_CNTR_BAS B -- 계약기본
            ON A.CNTR_NO = B.CNTR_NO
           AND B.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_DTL F -- 계약상세
            ON A.CNTR_NO = F.CNTR_NO
           AND A.CNTR_SN = F.CNTR_SN
           AND F.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS C --고객기본
            ON A.CST_NO = C.CST_NO
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS D --파트너기본
            ON D.OG_TP_CD = B.SELL_OG_TP_CD
           AND D.PRTNR_NO = B.SELL_PRTNR_NO
          LEFT OUTER JOIN TB_PDBS_PD_BAS E --상품기본
            ON A.PD_CD = E.PD_CD
          LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL G --계약WELLS상세
            ON A.CNTR_NO = G.CNTR_NO
           AND A.CNTR_SN = G.CNTR_SN
           AND G.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CBCL_DLQ_BAS H -- 연체기본
            ON A.SL_CL_YM = H.PERF_YM
           AND A.CNTR_NO  = H.CNTR_NO
           AND A.CNTR_SN  = H.CNTR_SN
          LEFT OUTER JOIN TB_CBBO_DFA_IZ I -- 대손기본
            ON A.CNTR_NO  = I.CNTR_NO
           AND A.CNTR_SN  = I.CNTR_SN
           AND I.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CBCL_REDF_ADSB_BAS J --되물림재지급기본
            ON A.CNTR_NO = J.CNTR_NO
           AND A.CNTR_SN = J.CNTR_SN
          LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS L --채권계약기본
            ON A.CNTR_NO = L.CNTR_NO
           AND A.CNTR_SN = L.CNTR_SN
           AND L.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMMDD')
          LEFT OUTER JOIN (SELECT *
                             FROM (SELECT *
                                     FROM TB_FEDD_BU_NOTI_RGST_HIST -- 부담통보등록이력
                                    WHERE CNTR_NO = #{cntrNo}
                                      AND CNTR_SN = #{cntrSn}
                                      AND DTA_DL_YN = 'N'
                                      AND HIST_CH_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                                    ORDER BY HIST_CH_DTM DESC)
                            WHERE ROWNUM = 1) M
            ON A.CNTR_NO = M.CNTR_NO
           AND A.CNTR_SN = M.CNTR_SN
          LEFT OUTER JOIN TB_SSCT_CNTR_STLM_REL N --계약결제관계
            ON N.DTL_CNTR_NO = A.CNTR_NO
           AND N.DTL_CNTR_SN = A.CNTR_SN
           AND N.DTA_DL_YN = 'N'
           AND SUBSTR(N.VL_STRT_DTM, 1, 6) <![CDATA[<=]]> A.SL_CL_YM
           AND SUBSTR(N.VL_END_DTM, 1, 6) >= A.SL_CL_YM
          LEFT OUTER JOIN TB_SSCT_CNTR_STLM_BAS O -- 계약결제기본
            ON O.CNTR_STLM_ID = N.CNTR_STLM_ID
         WHERE A.SL_CL_YM = ( SELECT MAX(T.SL_CL_YM)
                                FROM TB_CBCL_WELLS_SL_MM_CL_IZ T
                               WHERE T.CNTR_NO = #{cntrNo}
                                 AND T.CNTR_SN = #{cntrSn})
           AND A.CNTR_NO = #{cntrNo}
           AND A.CNTR_SN = #{cntrSn}
    </select>

    <select id="selectSalesPerformances" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbSinglePaymentDto$SalesSearchRes">
        <!-- [Wells]일시불 매출 리스트 조회 -->
        <!--
        <ASIS 쿼리 내용>
        CW4900P : 일시불 월마감 내역
        CW5000P : 일시불 월마감 최종월의 스냅샷
                  → 월마감 작업 후 익월에 대한 월마감 TEMP 데이터를 복제하여 현재월의 입금현황을 반영
        실제 전달까지의 마감데이터에 UNION 해서 현재월 ROW도 한 줄 추가하여 보여주고 있음
        -->
        WITH T1 AS (SELECT A.SL_CL_YM AS SL_CL_YM -- 기준년월(CW49.CWPAYY)
                         , TO_CHAR(ADD_MONTHS(TO_DATE(A.SL_CL_YM, 'YYYYMM') , 1), 'YYYYMM') AS SL_CL_YM_NEXT -- 다음달 기준년월
                         , A.CNTR_NO
                         , A.CNTR_SN
                         , NVL(B.DLQ_MCN, 0) AS DLQ_MCN -- 연체개월(CW49.CWDCNT)
                         , NVL(B.EOT_DLQ_AMT, 0) AS EOT_DLQ_AMT -- 연체금액(CW49.CWDAMT)
                         , C.CLCTAM_DV_CD || '.' || F_CMZ_CD_NM('TNT_WELLS', 'CLCTAM_DV_CD', C.CLCTAM_DV_CD) AS CLCTAM_DV_CD_NM -- @TO-DO 집금구분(CW49.CWPGUB)
                         , C.CLCTAM_PRTNR_NO AS CLCTAM_PRTNR_NO -- @TO-DO 집금유형담당(CW49.CWPCDE)
                         , NVL(A.SL_DP_AGG_AMT,0) AS SL_DP_AGG_AMT -- 납입금액(CW49.CWPAMT)
                         , NVL(A.THM_INTAM_DP_AMT,0) AS THM_INTAM_DP_AMT -- 당월할부금입금금액(CW49.CWAMT3)
                         , NVL(A.CRP_UC_AMT,0) AS CRP_UC_AMT -- 법인미수(CW49.CWAMT3)
                         , NVL(A.SELL_AMT,0) AS SELL_AMT -- 판매금(CW49.CWTAMT)
                         , A.ISTM_MCN || '*' || TO_CHAR(A.MM_ISTM_AMT,'FM999,999,999,999,990') AS ISTM_INFO-- 할부개월*할부금액(CW49.CWMONT||'*'||CW49.CWMAMT||'원' )
                         , (SELECT NVL(SUM(NVL(D.RVE_AMT, 0)), 0) -- 마감데이터 이후 수납된 할부금
                              FROM TB_CBCL_BZNS_ATAM_BAS D --영업선수금기본
                             WHERE SUBSTR(D.RVE_DT, 1, 6) = TO_CHAR(ADD_MONTHS(TO_DATE(A.SL_CL_YM, 'YYYYMM') , 1), 'YYYYMM')
                               AND D.CNTR_NO = A.CNTR_NO
                               AND D.CNTR_SN = A.CNTR_SN
                               AND D.DTA_DL_YN ='N'
                               AND D.RVE_DV_CD = '03' -- 월납입액(할부금, 렌탈료)
                               AND D.DP_DV_CD IN ('1', '3')) AS RVE_AMT_THIS_MONTH -- 입금
                         , (SELECT NVL(SUM(NVL(D.RVE_AMT, 0)), 0) -- 마감데이터 이후 환불된 할부금
                              FROM TB_CBCL_BZNS_ATAM_BAS D --영업선수금기본
                             WHERE SUBSTR(D.RVE_DT, 1, 6) = TO_CHAR(ADD_MONTHS(TO_DATE(A.SL_CL_YM, 'YYYYMM') , 1), 'YYYYMM')
                               AND D.CNTR_NO = A.CNTR_NO
                               AND D.CNTR_SN = A.CNTR_SN
                               AND D.DTA_DL_YN ='N'
                               AND D.RVE_DV_CD = '03' -- 월납입액(할부금, 렌탈료)
                               AND D.DP_DV_CD IN ('2', '4') ) AS RFND_AMT_THIS_MONTH -- 환불
                      FROM TB_CBCL_WELLS_SL_MM_CL_IZ A  -- WELLS매출월마감내역
                      LEFT OUTER JOIN TB_CBCL_DLQ_BAS B --연체기본
                        ON A.SL_CL_YM = B.PERF_YM
                       AND A.CNTR_NO = B.CNTR_NO
                       AND A.CNTR_SN = B.CNTR_SN
                      LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS C --채권기본
                        ON A.SL_CL_YM = C.BASE_YM
                       AND A.CNTR_NO = C.CNTR_NO
                       AND A.CNTR_SN = C.CNTR_SN
                     WHERE A.CNTR_NO = #{cntrNo}
                       AND A.CNTR_SN = #{cntrSn}
                       AND A.SELL_TP_CD = '1') -- 일시불
        SELECT *
          FROM (SELECT SL_CL_YM_NEXT AS SL_CL_YM
                     , DLQ_MCN
                     , EOT_DLQ_AMT
                     , CLCTAM_DV_CD_NM
                     , CLCTAM_PRTNR_NO
                     , SL_DP_AGG_AMT + RVE_AMT_THIS_MONTH - RFND_AMT_THIS_MONTH AS SL_DP_AGG_AMT
                     , THM_INTAM_DP_AMT + RVE_AMT_THIS_MONTH - RFND_AMT_THIS_MONTH AS THM_INTAM_DP_AMT
                     , CRP_UC_AMT
                     , SELL_AMT
                     , ISTM_INFO
                  FROM T1
                 WHERE T1.SL_CL_YM = (SELECT MAX(SL_CL_YM) FROM T1)
                 UNION ALL
                SELECT SL_CL_YM
                     , DLQ_MCN
                     , EOT_DLQ_AMT
                     , CLCTAM_DV_CD_NM
                     , CLCTAM_PRTNR_NO
                     , SL_DP_AGG_AMT
                     , THM_INTAM_DP_AMT
                     , CRP_UC_AMT
                     , SELL_AMT
                     , ISTM_INFO
                  FROM T1) T2
         ORDER BY SL_CL_YM DESC
    </select>

    <select id="selectDepositsPages" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbSinglePaymentDto$DepositSearchRes">
        <!-- [Wells]일시불 매출 체크 리스트 조회 -->
        -- CW3300P, CW5100P, CW5200P 전부 영업선수금 테이블로 이행
        SELECT F_CMZ_CD_NM('TNT_WELLS', 'RVE_DV_CD', RVE_DV_CD) AS RVE_DV_CD1 -- 수납구분
             , RVE_DT AS RVE_DT -- 수납일자
             , PERF_DT AS PERF_DT -- 실적일자
             , DP_DV_CD || '.' || F_CMZ_CD_NM('TNT_WELLS', 'DP_DV_CD', DP_DV_CD) AS DP_DV_CD -- 입금구분
             , RVE_DV_CD || '.' || F_CMZ_CD_NM('TNT_WELLS', 'RVE_DV_CD', RVE_DV_CD) AS RVE_DV_CD2 -- 수납구분
             , DP_TP_CD || '.' || F_CMZ_CD_NM('TNT_WELLS', 'DP_TP_CD', DP_TP_CD) AS DP_TP_CD -- 입금유형
             , NVL(RVE_AMT,0) AS RVE_AMT -- 금액
          FROM TB_CBCL_BZNS_ATAM_BAS -- 영업선수금
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND DTA_DL_YN = 'N'
         ORDER BY RVE_DT DESC
    </select>

</mapper>
