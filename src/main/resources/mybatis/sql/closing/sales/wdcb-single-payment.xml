<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.closing.sales.mapper.WdcbSinglePaymentMapper">
    <select id="selectBaseInformation" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbSinglePaymentDto$BaseSearchRes">
        <!-- [Wells]일시불 매출 정보 조회-->
        WITH T1 AS (SELECT *
                      FROM TB_CBCL_BZNS_ATAM_BAS -- 영업선수금
                     WHERE CNTR_NO = #{cntrNo}
                       AND CNTR_SN = #{cntrSn})
           , T2 AS (SELECT A.CNTR_CH_RCP_ID
                         , A.CNTR_CH_SN
                         , B.CNTR_CH_FSH_DTM AS CNTR_CH_FSH_DTM
                         , C.IST_DT AS IST_DT
                      FROM TB_SSCT_CNTR_CH_RCP_DTL A -- 계약변경접수상세
                     INNER JOIN TB_SSCT_CNTR_CH_RCP_BAS B -- 계약변경접수기본
                        ON A.CNTR_CH_RCP_ID = B.CNTR_CH_RCP_ID
                       AND B.CNTR_CH_TP_CD = '201' -- 계약변경 유형코드(201 : 계약상세/상품변경)
                       AND B.APR_DTM IS NOT NULL   -- 승인일시
                       AND B.DTA_DL_YN = 'N'
                      LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL C
                        ON C.CNTR_NO = A.DTL_CNTR_NO
                       AND C.CNTR_SN = A.DTL_CNTR_SN
                       AND C.DTA_DL_YN = 'N'
                     WHERE A.DTL_CNTR_NO = #{cntrNo}
                       AND A.DTL_CNTR_SN = #{cntrSn}
                       AND A.DTA_DL_YN = 'N')
		SELECT T1.CNTR_NO AS CNTR_NO -- 계약번호
			 , T1.CNTR_SN AS CNTR_SN -- 계약일련번호
			 , T1.CNTR_NO || '-' || T1.CNTR_SN AS CNTR_DTL_NO -- 계약상세번호
			 , T1.SELL_TP_CD AS SELL_TP_CD
			 , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T1.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형명
			 , T1.CST_NO AS CST_NO
			 , T4.CST_KNM AS CST_KNM -- 고객명
			 , T4.COPN_DV_CD AS COPN_DV_CD
			 , F_CMZ_CD_NM('TNT_WELLS', 'COPN_DV_CD', T4.COPN_DV_CD) AS COPN_DV_CD_NM -- 고객구분명
			 , T5.PRTNR_NO AS PRTNR_NO -- 판매자사번
			 , T5.PRTNR_KNM AS PRTNR_KNM -- 판매자이름
			 , SUBSTR(T2.CNTR_CNFM_DTM, 1, 8) AS CNTR_DT --계약일
			 , (SELECT IST_DT FROM TB_SSCT_CNTR_WELLS_DTL WHERE CNTR_NO = T1.CNTR_NO AND CNTR_SN = T1.CNTR_SN) AS SL_DT -- 매출일자
			 , SUBSTR(T2.CNTR_CAN_DTM, 1, 8) AS CAN_DT --취소일
			 , T5.OG_NM AS OG_NM -- 조직명
			 , T5.OG_CD AS OG_CD -- 조직코드
			 , T5.OG_NM || '(' || T5.OG_CD || ')' AS OG_INFO-- 조직정보
			 , T1.PD_CD AS PD_CD -- 상품코드
			 , T6.PD_NM AS PD_NM -- 상품명
			 , T1.PD_CD || '(' || T6.PD_NM || ')' AS PD_INFO -- 상품정보
			 , T3.DSC_AMT AS DSC_AMT -- 할인금액
			 , '' AS DSC_TP -- 할인유형코드(LC30.LCETC4) @TO-DO 삭제 대상 : TOBE코드(SPAY_DSC_DV_CD)는 존재하나, 테이블 매핑 컬럼 없음
			 , T3.ALNCMP_CD AS ALNCMP_CD -- 제휴사코드
			 , F_CMZ_CD_NM('TNT_WELLS', 'ALNCMP_CD', T3.ALNCMP_CD) AS ALNCMP_CD_NM -- 제휴상태(LC30.LCCK03)
			 , T7.SELL_EV_CD AS SELL_EV_CD -- 행사코드
			 , F_CMZ_CD_NM('TNT_WELLS', 'SELL_EV_CD', T7.SELL_EV_CD) AS SELL_EV_CD_NM --행사정보(LC30.LCETC9)
			 , T1.SELL_AMT AS SELL_AMT --판매가격
			 , (SELECT NVL(SUM(NVL(ALNC_FEE, 0)), 0)
				  FROM TB_RVDW_RVE_DTL -- 수납상세
				 WHERE CNTR_NO = T1.CNTR_NO
				   AND CNTR_SN = T1.CNTR_SN
				   AND DTA_DL_YN = 'N') AS ALNC_FEE -- 제휴수수료(LC30.LCFAMT)
             , T1.SUBSC_AMT -- 청약금 @TO-BE는 청약금+인수금(CWSAMT+CWAAMT) 하나로 관리(인수금액은 TOBE 미관리)
			 , '' AS TK_AMT -- @TO-DO 삭제 대상 : 인수금액(CW50.CWAAMT)
			 , T3.CRP_UC_AMT AS CRP_UC_AMT -- 법인미수금액(LC30.LCGAMT)
			 , T1.ISTM_PCAM_AMT AS ISTM_PCAM_AMT-- 잔액(CW50.CWJAMT(할부원금) 값이 0이면, LC30.LCJAMT 값)
			 , T1.ISTM_MCN AS ISTM_MCN -- 할부개월(CW50.CWMONT)
			 , T1.MM_ISTM_AMT AS MM_ISTM_AMT -- 월할부금액(CW50.CWMAMT)
			 , T1.ISTM_MCN || '*' || T1.MM_ISTM_AMT AS ISTM_INFO --할부정보(CW50.CWMONT, CW50.CWMAMT)
			 , T1.ISTM_FEE_LVY_AMT AS ISTM_FEE_LVY_AMT -- 수수료금액(CW50.CWCAMT 값이 0이면, LC30.LCCAMT)
			 , T1.FULPY_DT AS FULPY_DT -- 완불일자
			 , '' AS FST_FULPY_DT -- 최초완불일자(CW50.CWLSTY) -- @TO-DO 삭제 대상
			 , (SELECT SUBSTR(MAX(HIST_STRT_DTM), 1, 8)
			      FROM TB_SSCT_CNTR_DCH_HIST -- 계약상세변경이력
			 	 WHERE CNTR_NO = T1.CNTR_NO
			       AND CNTR_SN  = T1.CNTR_SN
			       AND DTA_DL_YN = 'N') AS CNTR_CHN_DT --변동일자(CW50.CWCHGY)
			 , CASE WHEN T9.ACDBT_DT IS NOT NULL
				    THEN '대손' ELSE ' '
					 END AS CWKGUBNM -- 계정구분(CW50.CWKGUB) CASE WHEN CW50.CWKGUB='2'
			 , CASE WHEN (SELECT COUNT(*) FROM T2) = 0
					THEN '' -- 상품변경신청 건이 없으면 ''
			 	    WHEN (SELECT NVL(TO_CHAR(MAX(CNTR_CH_FSH_DTM), 'YYYYMMDD'), '') FROM T2) <![CDATA[<]]> (SELECT NVL(MIN(IST_DT), '') FROM T2)
					THEN ( SELECT NVL(TO_CHAR(MAX(CNTR_CH_FSH_DTM), 'YYYYMMDD'), '') FROM T2) -- 상품변경신청건이 있고, 설치일자 이전에 계약변경이 처리되었으면 상변일자 셋팅
			 	    ELSE ''
					 END AS PD_CH_DT -- 상변일자(LC30.LCCHGY)*/
			 , CASE WHEN (SELECT COUNT(*) FROM T2) = 0
				    THEN '' -- 상품변경신청 건이 없으면 ''
			 	    WHEN (SELECT NVL(TO_CHAR(MAX(CNTR_CH_FSH_DTM), 'YYYYMMDD'), '') FROM T2) > (SELECT NVL(MIN(IST_DT), '') FROM T2)
					THEN (SELECT NVL(TO_CHAR(MAX(CNTR_CH_FSH_DTM), 'YYYYMMDD'), '') FROM T2) -- 상품변경신청건이 있고, 설치일자 이후에 계약변경이 처리되었으면 매변일자 셋팅
			 	    ELSE ''
					 END AS SL_CH_DT -- 매변일자(LC30.LCMAEY)
			 , '' AS SL_CH_SN -- 매변일련번호(CW45.CWSEQN) @TO-DO 삭제 대상
			 , (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '03' AND DP_DV_CD IN ('1', '3'))
			 - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '03' AND DP_DV_CD IN ('2', '4')) AS ISTM_TOT_DP_AMT -- 할부입금액(CW50.CWPAMT)
			 , (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '01' AND DP_DV_CD IN ('1', '3'))
			 - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '01' AND DP_DV_CD IN ('2', '4')) AS SUBSC_TOT_DP_AMT -- 청약입금액(ASIS쿼리에는 조회하지 않음)
			 , (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '06' AND DP_DV_CD IN ('1', '3'))
			 - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '06' AND DP_DV_CD IN ('2', '4')) AS SL_CH_TOT_DP_AMT -- 매변입금액(CW45.CWPAMT)
			 , '' AS TK_DP_AMT-- 인수입금액(CW50.CWAAMT) @TO-DO 삭제 대상 ※ 인수금액 TOBE 삭제
			 , '' AS CRP_DP_AMT -- 법인미수금액(CW50.CWGAMT) @TO-DO 삭제 대상 : 수납쪽 입금구분에 법인미수금 코드가 있는데, TOBE에서는 계약금으로 합치는거로 되어있음
			 , (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE DP_DV_CD IN ('1', '3') )
			 - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE DP_DV_CD IN ('2', '4') ) AS TOT_DP_AMT -- 입금총액(청약금액+인수금액+납입금액, CW50.CWSAMT+CW50.CWAAMT+CW50.CWPAMT)
			 , T14.DP_TP_CD -- 이체구분코드(LC31.LCCHK1)
			 , F_CMZ_CD_NM('TNT_WELLS', 'DP_TP_CD', T14.DP_TP_CD) AS DP_TP_CD_NM -- 이체구분코드명(LC31.LCCHK1)
			 , T14.MPY_BSDT AS MPY_BSDT -- 이체일자
			 , T8.DLQ_MCN AS DLQ_MCN -- 연체개월수(CW50.CWDCNT)
			 , T8.EOT_DLQ_AMT AS THM_OC_DLQ_AMT -- 연체금액(CW50.CWDAMT)
			 , T1.EOT_UC_AMT
			 , T1.CNTR_TAM
			 - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE DP_DV_CD IN ('1', '3'))
			 - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE DP_DV_CD IN ('2', '4')) AS UC_BLAM --미수금액(CW50.CWQAMT - (CW50.CWSAMT + CW50.CWAAMT + CW50.CWPAMT))
			 , '' AS UC_PRT --미수출력(CW50.CWFLG2) @TO-DO 삭제 대상
			 , T9.ACDBT_DT AS ACDBT_DT -- 대손일자(CW50.CWBDDT)
			 , T9.DFA_AMT AS DFA_AMT --대손금액(CW50.CWAMT4)
			 , (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '09' AND DP_DV_CD IN ('1', '3'))
			 - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '09' AND DP_DV_CD IN ('2', '4')) AS DFA_DP_AMT -- 대손입금액(CW5400P.CWAMT1)
			 , T9.DFA_AMT
			 - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '09' AND DP_DV_CD IN ('1', '3'))
			 - (SELECT NVL(SUM(NVL(RVE_AMT,0)), 0) FROM T1 WHERE RVE_DV_CD = '09' AND DP_DV_CD IN ('2', '4')) AS DFA_BLAM -- 대손잔액(대손금액 - 대손입금액)
			 , (SELECT NVL(MAX(RVE_DT), '') FROM T1 WHERE RVE_DV_CD = '09' AND DP_DV_CD IN ('1', '3')) AS DFA_RVE_DT -- 대손납입일자(CW5400P.CWACTY)
			 , '' AS DFA_FNS_AMT -- @TO-DO 대손완불금액(ASIS 쿼리 이상함)
			 , T11.BND_ASN_DT AS BND_ASN_DT -- 수임일자(CW50.CWPRTY)
			 , T11.CLCTAM_DV_CD AS CLCTAM_DV_CD -- 집금구분(CW49.CWPGUB)
			 , F_CMZ_CD_NM('TNT_WELLS', 'CLCTAM_DV_CD', T11.CLCTAM_DV_CD) AS CLCTAM_DV_CD_NM
			 , T11.CLCTAM_PRTNR_NO AS CLCTAM_PRTNR_NO -- 집금담당자사번(CW50.CWPRTY)
			 , (SELECT NVL(MAX(PRTNR_KNM), '') FROM TB_CBBO_CLCTAM_PRTNR_DTL WHERE PRTNR_NO  = T11.CLCTAM_PRTNR_NO) AS CLCTAM_PRTNR_KNM --집금담당자명
			 , T2.DSB_GUR_TP_CD AS DSB_GUR_TP_CD -- 지급보증유형(CW50.CWJFLG)
			 , F_CMZ_CD_NM('TNT_WELLS', 'DSB_GUR_TP_CD', T2.DSB_GUR_TP_CD) AS DSB_GUR_TP_CD_NM
			 , T12.BU_NOTI_DT AS BU_NOTI_DT -- 부담통보일자(CW50.CWSTBY)
			 , T10.REDF_DT AS REDF_DT -- 되물림일자(CW50.CWSMLY)
			 , T10.ADSB_DT AS ADSB_DT -- 재지급일자(CW50.CWSJGY)
			 , T12.BU_NOTI_TP_CD AS BU_NOTI_TP_CD -- 통보내용(CW50.CWTFLG)
			 , F_CMZ_CD_NM('TNT_WELLS', 'BU_NOTI_TP_CD', T12.BU_NOTI_TP_CD) AS BU_NOTI_TP_CD_NM
			 , F_CMZ_CD_NM('TNT_WELLS', 'BNK_CD_CD', T15.VAC_BNK_CD) AS VAC_BNK_CD -- 은행명
			 , T15.VAC_NO  AS VAC_NO -- 가상계좌번호
		  FROM  TB_CBCL_WELLS_SL_MM_CL_IZ T1 -- WELLS매출월마감내역
		 INNER JOIN TB_SSCT_CNTR_BAS T2 -- 계약기본
		    ON T2.CNTR_NO = T1.CNTR_NO
		   AND T2.DTA_DL_YN = 'N'
		 INNER JOIN TB_SSCT_CNTR_DTL T3 -- 계약상세
		    ON T3.CNTR_NO = T1.CNTR_NO
		   AND T3.CNTR_SN = T1.CNTR_SN
		   AND T3.DTA_DL_YN = 'N'
		  LEFT OUTER JOIN TB_CUBS_CST_BAS T4 --고객기본
		    ON T4.CST_NO = T1.CST_NO
		  LEFT OUTER JOIN TB_OGBS_PRTNR_BAS T5 --파트너기본
		    ON T5.OG_TP_CD = T2.SELL_OG_TP_CD
		   AND T5.PRTNR_NO = T2.SELL_PRTNR_NO
		  LEFT OUTER JOIN TB_PDBS_PD_BAS T6 --상품기본
		    ON T6.PD_CD = T1.PD_CD
		  LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T7 --계약WELLS상세
		    ON T7.CNTR_NO = T1.CNTR_NO
		   AND T7.CNTR_SN = T1.CNTR_SN
		   AND T7.DTA_DL_YN = 'N'
		  LEFT OUTER JOIN TB_CBCL_DLQ_BAS T8 -- 연체기본
		    ON T8.PERF_YM = T1.SL_CL_YM
		   AND T8.CNTR_NO = T1.CNTR_NO
		   AND T8.CNTR_SN = T1.CNTR_SN
		  LEFT OUTER JOIN TB_CBBO_DFA_IZ T9 -- 대손기본
		    ON T9.CNTR_NO = T1.CNTR_NO
		   AND T9.CNTR_SN = T1.CNTR_SN
		   AND T9.DTA_DL_YN = 'N'
		  LEFT OUTER JOIN TB_CBCL_REDF_ADSB_BAS T10 --되물림재지급기본
		    ON T10.CNTR_NO = T1.CNTR_NO
		   AND T10.CNTR_SN = T1.CNTR_SN
		  LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS T11 --채권계약기본
		    ON T11.BASE_YM = T1.SL_CL_YM
		   AND T11.CNTR_NO = T1.CNTR_NO
		   AND T11.CNTR_SN = T1.CNTR_SN
		  LEFT OUTER JOIN (SELECT *
							 FROM (SELECT *
								     FROM TB_FEDD_BU_NOTI_RGST_HIST -- 부담통보등록이력
								    WHERE CNTR_NO = #{cntrNo}
								  	  AND CNTR_SN = #{cntrSn}
								  	  AND DTA_DL_YN = 'N'
								  	  AND HIST_CH_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
									ORDER BY HIST_CH_DTM DESC)
							WHERE ROWNUM = 1) T12
		    ON T12.CNTR_NO = T1.CNTR_NO
		   AND T12.CNTR_SN = T1.CNTR_SN
		  LEFT OUTER JOIN TB_SSCT_CNTR_STLM_REL T13 --계약결제관계
		    ON T13.DTL_CNTR_NO = T1.CNTR_NO
		   AND T13.DTL_CNTR_SN = T1.CNTR_SN
		   AND T13.DTA_DL_YN = 'N'
		   AND SUBSTR(T13.VL_STRT_DTM, 1, 6) <![CDATA[<=]]> T1.SL_CL_YM
		   AND SUBSTR(T13.VL_END_DTM, 1, 6) >= T1.SL_CL_YM
		  LEFT OUTER JOIN TB_SSCT_CNTR_STLM_BAS T14 -- 계약결제기본
		    ON T14.CNTR_STLM_ID = T13.CNTR_STLM_ID
		  LEFT OUTER JOIN LATERAL (SELECT VAC_BNK_CD
										, VAC_NO
									 FROM (SELECT VACI.*
												, DENSE_RANK() over(PARTITION BY VAC_IS_CST_NO ORDER BY VAC_IS_DTM DESC, VAC_RGST_DTM DESC, VAC_IS_ID DESC) AS RANK -- DTM이 중복건이 있어서 최종발급ID 추가
											 FROM TB_RVDW_VAC_IS_IZ VACI
											WHERE VACI.DTA_DL_YN = 'N'
										  --  AND  VACI.VAC_USE_DV_CD  = '02' --가상계좌사용구분코드 02:채권
											  AND  VACI.VAC_IS_DV_CD   = '5' -- 가상계좌발급구분코드 5:연체집금용
											  AND  VACI.VAC_IS_CST_NO  = T1.CST_NO) -- 가상계좌발급고객번호
									WHERE RANK = 1) T15
		    ON 1 = 1
		 WHERE T1.SL_CL_YM = (SELECT MAX(SL_CL_YM)
		  					    FROM TB_CBCL_WELLS_SL_MM_CL_IZ
		  					   WHERE CNTR_NO = #{cntrNo}
		  					     AND CNTR_SN = #{cntrSn})
		   AND T1.CNTR_NO = #{cntrNo}
		   AND T1.CNTR_SN = #{cntrSn}
    </select>

    <select id="selectSalesPerformances" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbSinglePaymentDto$SalesSearchRes">
        <!-- [Wells]일시불 매출 리스트 조회 -->
        <!--
        <ASIS 쿼리 내용>
        CW4900P : 일시불 월마감 내역
        CW5000P : 일시불 월마감 최종월의 스냅샷
                  → 월마감 작업 후 익월에 대한 월마감 TEMP 데이터를 복제하여 현재월의 입금현황을 반영
        실제 전달까지의 마감데이터에 UNION 해서 현재월 ROW도 한 줄 추가하여 보여주고 있음
        -->
        WITH T1 AS (SELECT DP_DV_CD
						 , NVL(RVE_AMT, 0) AS RVE_AMT
					  FROM TB_CBCL_BZNS_ATAM_BAS --영업선수금기본
					 WHERE SUBSTR(RVE_DT, 1, 6) = TO_CHAR(SYSDATE, 'YYYYMM')
					   AND CNTR_NO = #{cntrNo}
					   AND CNTR_SN = #{cntrSn}
					   AND DTA_DL_YN ='N'
					   AND RVE_DV_CD = '03' -- 월납입액(할부금, 렌탈료)
					)
		SELECT A.SL_CL_YM AS SL_CL_YM -- 기준년월(CW49.CWPAYY)
			 , A.CNTR_NO
			 , A.CNTR_SN
			 , NVL(B.DLQ_MCN, 0) AS DLQ_MCN -- 연체개월(CW49.CWDCNT)
			 , NVL(B.EOT_DLQ_AMT, 0) AS EOT_DLQ_AMT -- 연체금액(CW49.CWDAMT)
			 , CASE WHEN C.CLCTAM_DV_CD IS NOT NULL
				    THEN C.CLCTAM_DV_CD || '.' || F_CMZ_CD_NM('TNT_WELLS', 'CLCTAM_DV_CD', C.CLCTAM_DV_CD)
			 	    ELSE ''
					 END AS CLCTAM_DV_CD_NM -- @TO-DO 집금구분(CW49.CWPGUB)
			 , C.CLCTAM_PRTNR_NO AS CLCTAM_PRTNR_NO -- @TO-DO 집금유형담당(CW49.CWPCDE)
			 , (SELECT SUM(NVL(THM_INTAM_DP_AMT, 0))
			      FROM TB_CBCL_WELLS_SL_MM_CL_IZ
			     WHERE CNTR_NO = A.CNTR_NO
			 	   AND CNTR_SN = A.CNTR_SN
			 	   AND SL_CL_YM <![CDATA[<]]> A.SL_CL_YM) AS SL_DP_AGG_AMT -- 납입금액(CW49.CWPAMT)
			 , A.THM_INTAM_DP_AMT AS THM_INTAM_DP_AMT -- 당월할부금입금금액(CW49.CWAMT3)
			 , A.CRP_UC_AMT AS CRP_UC_AMT -- 법인미수(CW49.CWWAM1)
			 , A.SELL_AMT AS SELL_AMT -- 판매금(CW49.CWTAMT)
			 , A.ISTM_MCN || '*' || A.MM_ISTM_AMT ||'원' AS ISTM_INFO-- 할부개월*할부금액(CW49.CWMONT||'*'||CW49.CWMAMT||'원' )
		  FROM  TB_CBCL_WELLS_SL_MM_CL_IZ A  -- WELLS매출월마감내역
		  LEFT OUTER JOIN TB_CBCL_DLQ_BAS B --연체기본
		    ON A.SL_CL_YM = B.PERF_YM
		   AND A.CNTR_NO = B.CNTR_NO
		   AND A.CNTR_SN = B.CNTR_SN
		  LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS C --채권기본
		    ON A.SL_CL_YM = C.BASE_YM
		   AND A.CNTR_NO = C.CNTR_NO
		   AND A.CNTR_SN = C.CNTR_SN
		 WHERE A.CNTR_NO = #{cntrNo}
		   AND A.CNTR_SN = #{cntrSn}
		   AND A.SELL_TP_CD = '1' -- 일시불
		   AND TO_CHAR(SYSDATE, 'YYYYMM') >  A.SL_CL_YM
		 UNION ALL
		SELECT A.SL_CL_YM AS SL_CL_YM -- 기준년월(CW49.CWPAYY)
		     , A.CNTR_NO
		     , A.CNTR_SN
		     , NVL(B.DLQ_MCN, 0) AS DLQ_MCN -- 연체개월(CW49.CWDCNT)
		     , NVL(B.EOT_DLQ_AMT, 0) AS EOT_DLQ_AMT -- 연체금액(CW49.CWDAMT)
		     , CASE WHEN C.CLCTAM_DV_CD IS NOT NULL THEN C.CLCTAM_DV_CD || '.' || F_CMZ_CD_NM('TNT_WELLS', 'CLCTAM_DV_CD', C.CLCTAM_DV_CD)
		     	    ELSE ''  END AS CLCTAM_DV_CD_NM -- @TO-DO 집금구분(CW49.CWPGUB)
		     , C.CLCTAM_PRTNR_NO AS CLCTAM_PRTNR_NO -- @TO-DO 집금유형담당(CW49.CWPCDE)
		     , (SELECT SUM(NVL(THM_INTAM_DP_AMT, 0))
		          FROM TB_CBCL_WELLS_SL_MM_CL_IZ
		         WHERE CNTR_NO = A.CNTR_NO
		     	   AND CNTR_SN = A.CNTR_SN
		     	   AND SL_CL_YM <![CDATA[<]]> A.SL_CL_YM) AS SL_DP_AGG_AMT -- 납입금액(CW49.CWPAMT)
		     , (SELECT NVL(SUM(RVE_AMT), 0) FROM T1 WHERE DP_DV_CD IN ('1', '3'))
			 - (SELECT NVL(SUM(RVE_AMT), 0) FROM T1 WHERE DP_DV_CD IN ('2', '4')) AS THM_INTAM_DP_AMT -- 당월할부금입금금액(CW51.CWAMT3) 당월 입금 - 환불
		     , A.CRP_UC_AMT AS CRP_UC_AMT -- 법인미수(CW49.CWWAM1)
		     , A.SELL_AMT AS SELL_AMT -- 판매금(CW49.CWTAMT)
		     , A.ISTM_MCN || '*' || A.MM_ISTM_AMT ||'원' AS ISTM_INFO-- 할부개월*할부금액(CW49.CWMONT||'*'||CW49.CWMAMT||'원' )
		  FROM  TB_CBCL_WELLS_SL_MM_CL_IZ A  -- WELLS매출월마감내역
		  LEFT OUTER JOIN TB_CBCL_DLQ_BAS B --연체기본
		    ON A.SL_CL_YM = B.PERF_YM
		   AND A.CNTR_NO = B.CNTR_NO
		   AND A.CNTR_SN = B.CNTR_SN
		  LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS C --채권기본
		    ON A.SL_CL_YM = C.BASE_YM
		   AND A.CNTR_NO = C.CNTR_NO
		   AND A.CNTR_SN = C.CNTR_SN
		 WHERE A.CNTR_NO = #{cntrNo}
		   AND A.CNTR_SN = #{cntrSn}
		   AND A.SELL_TP_CD = '1' -- 일시불
		   AND TO_CHAR(SYSDATE, 'YYYYMM') =  A.SL_CL_YM
		 ORDER BY SL_CL_YM DESC
    </select>

    <select id="selectDepositsPages" resultType="com.kyowon.sms.wells.web.closing.sales.dto.WdcbSinglePaymentDto$DepositSearchRes">
        <!-- [Wells]일시불 매출 체크 리스트 조회 -->
        ---------------------------------------------------
        -- CW3300P, CW5100P : 영업선수
        -- CW5200P : 기타선수
        ---------------------------------------------------
		SELECT CNTR_NO -- 계약번호
			 , CNTR_SN -- 계약일련번호
			 , RVE_GUBUN -- 입금구분
			 , RVE_DT -- 수납일
			 , PERF_DT -- 실적일
			 , DP_DV_CD || '.' || F_CMZ_CD_NM('TNT_WELLS', 'DP_DV_CD', DP_DV_CD) AS DP_DV_CD -- 입금구분
			 , RVE_DV_CD || '.' || F_CMZ_CD_NM('TNT_WELLS', 'RVE_DV_CD', RVE_DV_CD) AS RVE_DV_CD2 -- 수납구분
			 , DP_TP_CD || '.' || F_CMZ_CD_NM('TNT_WELLS', 'DP_TP_CD', DP_TP_CD) AS DP_TP_CD -- 입금유형
			 , NVL(RVE_AMT,0) AS RVE_AMT -- 금액
		  FROM (SELECT CNTR_NO
					 , CNTR_SN
					 , CASE WHEN RVE_DV_CD IN ('03', '04') THEN '할부입금'
						   ELSE '청약/인수' END AS RVE_GUBUN
					 , RVE_DT AS RVE_DT -- 수납일자
					 , PERF_DT AS PERF_DT -- 실적일자
					 , DP_DV_CD -- 입금구분
					 , RVE_DV_CD -- 수납구분
					 , DP_TP_CD -- 입금유형
					 , RVE_AMT AS RVE_AMT -- 금액
				  FROM TB_CBCL_BZNS_ATAM_BAS -- 영업선수금
				 WHERE CNTR_NO = #{cntrNo}
				   AND CNTR_SN = #{cntrSn}
				   AND DTA_DL_YN = 'N'
				 UNION ALL
				SELECT CNTR_NO
					 , CNTR_SN
					 , '기타선수' AS RVE_GUBUN
					 , RVE_DT AS RVE_DT -- 수납일자
					 , ETC_ATAM_PRCSDT AS PERF_DT -- 실적일자
					 , DP_DV_CD -- 입금구분
					 , RVE_DV_CD -- 수납구분
					 , DP_TP_CD -- 입금유형
					 , ETC_ATAM_PROCS_AMT AS RVE_AMT -- 금액
				  FROM TB_CBCL_ETC_ATAM_PROCS_IZ -- 기타선수금 처리내역
				 WHERE CNTR_NO = #{cntrNo}
				   AND CNTR_SN = #{cntrSn}
				   AND DTA_DL_YN = 'N')
		 ORDER BY RVE_DT DESC
    </select>

</mapper>
