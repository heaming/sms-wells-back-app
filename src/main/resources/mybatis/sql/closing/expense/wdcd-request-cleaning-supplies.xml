<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.closing.expense.mapper.WdcdRequestCleaningSuppliesMgtMapper">

    <select id="selectRsbDvCd" resultType="com.kyowon.sms.wells.web.closing.expense.dto.WdcdRequestCleaningSuppliesMgtDto$SearchRsbDvCdRes">
        SELECT A.RSB_DV_CD
             , A.PSTN_DV_CD
             , B.CD_CNTN
          FROM TB_OGBS_MM_PRTNR_IZ A
         INNER JOIN T_CMZ_CD_D B
            ON A.RSB_DV_CD = B.CD_VLD_VAL
         WHERE 1=1
           AND B.TENANT_ID = #{session.tenantId}
           AND B.CD_ID = 'RSB_DV_CD'
           AND A.OG_TP_CD = #{ogTpCd}
           AND A.PRTNR_NO = #{prtnrNo}
           AND A.BASE_YM = (SELECT MAX(S1.BASE_YM)
                              FROM TB_OGBS_MM_PRTNR_IZ S1
                             WHERE S1.OG_TP_CD = A.OG_TP_CD
                               AND S1.PRTNR_NO = A.PRTNR_NO
                               AND S1.RSB_DV_CD IS NOT NULL)
    </select>

    <select id="selectBuilDingCd" resultType="com.kyowon.sms.wells.web.closing.expense.dto.WdcdRequestCleaningSuppliesMgtDto$CodeRes">
        SELECT DISTINCT B.BLD_CD
             , B.BLD_NM
          FROM TB_OGBS_MM_OG_IZ A /*월조직내역*/
         INNER JOIN TB_OGBS_BLD_BAS B /*빌딩기본*/
            ON A.BLD_CD = B.BLD_CD
           AND A.BASE_YM = SUBSTR(B.OP_DT, 1,6)
         WHERE 1=1
           AND A.DGR2_LEVL_OG_CD IN (SELECT W1.OG_CD
                                       FROM TB_OGBS_PRTNR_BAS W1 /*파트너기본*/
                                      WHERE 1=1
                                        AND W1.OG_TP_CD = #{ogTpCd}
                                        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
                                        AND W1.PRTNR_NO = #{prtnrNo}
                                        </if>
                                     )
    </select>

    <select id="selectClingCostAdjRcpNo" resultType="String">
        SELECT TO_CHAR(TO_DATE(#{aplcDt}),'YYYYMM')||LPAD(NVL(MAX(SUBSTR(CLING_COST_ADJ_RCP_NO,7,4)),0)+1,4,'0')
          FROM TB_CBCL_CLING_COST_ADJ_IZ
         WHERE RCP_YM LIKE SUBSTR(#{aplcDt},1,6)||'%'
    </select>

    <insert id="insertRequestCleaningSupplies">
        INSERT INTO TB_CBCL_CLING_COST_ADJ_IZ(
               CLING_COST_ADJ_RCP_NO
             , RCP_YM
             , APLC_DT
             , CLAIM_NM
             , BLD_CD
             , BIL_AMT
             , CARD_PSR_NM
             , LOCARA_TNO
             , EXNO_ENCR
             , IDV_TNO
             , CLING_COST_SRCP_APN_FILE_ID
             , CLING_COST_DV_CD
             , DTA_DL_YN
             , OG_TP_CD
          <include refid="COMMON.insertSystemField" />
        ) VALUES (
               #{clingCostAdjRcpNo}
             , SUBSTR(#{aplcDt},1,6) /* 신청일자 yyyymm */
             , #{aplcDt}
             , #{claimNm}
             , #{bldCd}
             , #{bilAmt}
             , #{cardPsrNm}
             , #{locaraTno}
             , #{exnoEncr}
             , #{idvTno}
             , #{clingCostSrcpApnFileId}
             , '02'
             , #{dtaDlYn}
             , #{ogTpCd}
          <include refid="COMMON.insertSystemFieldValue" />
        )
    </insert>

    <select id="selectRequestCleaningSupplies" resultType="com.kyowon.sms.wells.web.closing.expense.dto.WdcdRequestCleaningSuppliesMgtDto$FindRes">
        SELECT CLING_COST_ADJ_RCP_NO
             , CARD_PSR_NM
             , APLC_DT
             , CLAIM_NM
             , BLD_CD
             , BIL_AMT
             , LOCARA_TNO
             , EXNO_ENCR
             , IDV_TNO
             , CLING_COST_SRCP_APN_FILE_ID
             , OG_TP_CD
          FROM TB_CBCL_CLING_COST_ADJ_IZ
         WHERE CLING_COST_ADJ_RCP_NO = #{clingCostAdjRcpNo}
    </select>

    <select id="selectRequestCleaningSuppliesDetail" resultType="com.kyowon.sms.wells.web.closing.expense.dvo.WdcdRequestCleaningSuppliesDvo">
        SELECT CLING_COST_ADJ_RCP_NO
             , CARD_PSR_NM
             , APLC_DT
             , CLAIM_NM
             , BLD_CD
             , BIL_AMT
             , LOCARA_TNO
             , EXNO_ENCR
             , IDV_TNO
             , CLING_COST_SRCP_APN_FILE_ID
             , OG_TP_CD
          FROM TB_CBCL_CLING_COST_ADJ_IZ
         WHERE CLING_COST_ADJ_RCP_NO = #{clingCostAdjRcpNo}
    </select>

    <update id="editselectRequestCleaningSupplies">
        UPDATE TB_CBCL_CLING_COST_ADJ_IZ
           SET BIL_AMT = #{bilAmt}
             , CLAIM_NM = #{claimNm}
             , BLD_CD = #{bldCd}
             , BIL_AMT = #{bilAmt}
             , CARD_PSR_NM = #{cardPsrNm}
             , LOCARA_TNO = #{locaraTno}
             , EXNO_ENCR = #{exnoEncr}
             , IDV_TNO = #{idvTno}
               <include refid="COMMON.updateSystemField"/>
         WHERE CLING_COST_ADJ_RCP_NO = #{clingCostAdjRcpNo}
    </update>
</mapper>
