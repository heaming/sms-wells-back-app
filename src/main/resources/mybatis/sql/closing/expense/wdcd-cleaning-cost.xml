<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.closing.expense.mapper.WdcdCleaningCostMgtMapper">

    <select id="selectBuilDingCd" resultType="com.kyowon.sms.wells.web.closing.expense.dto.WdcdCleaningCostMgtDto$CodeRes">
        SELECT DISTINCT B.BLD_CD
             , B.BLD_NM
          FROM TB_OGBS_MM_OG_IZ A /*월조직내역*/
         INNER JOIN TB_OGBS_BLD_BAS B /*빌딩기본*/
            ON A.BLD_CD = B.BLD_CD
           AND A.BASE_YM = SUBSTR(B.OP_DT, 1,6)
         WHERE 1=1
    </select>

    <select id="selectCleaningCost" resultType="com.kyowon.sms.wells.web.closing.expense.dto.WdcdCleaningCostMgtDto$SearchRes">
        SELECT CLING_COST_ADJ_RCP_NO
             , TO_CHAR(TO_DATE(FST_RGST_DTM, 'yyyymmddhh24miss'), 'yyyy-MM-dd') AS FST_RGST_DTM
             , TO_CHAR(TO_DATE(FNL_MDFC_DTM, 'yyyymmddhh24miss'), 'yyyy-MM-dd') AS FNL_MDFC_DTM
             , CLING_COST_DV_CD
             , F_CMZ_CD_NM('TNT_BASE', 'CLING_COST_DV_CD', CLING_COST_DV_CD) AS CLING_COST_DV_NM
             , BLD_CD
             , CLAIM_NM
             , (SELECT BLD_NM
                  FROM TB_OGBS_BLD_BAS T2
                 WHERE T1.BLD_CD = T2.BLD_CD ) AS BLD_NM
             , TO_CHAR(TO_DATE(APLC_DT, 'yyyymmddhh24miss'), 'yyyy-MM-dd') AS APLC_DT
             , BIL_AMT
             , CLING_COST_SRCP_APN_FILE_ID
          FROM TB_CBCL_CLING_COST_ADJ_IZ T1
         WHERE DTA_DL_YN = 'N'
           AND SUBSTR(APLC_DT,1,6) BETWEEN #{aplcStartDt} AND #{aplcEndDt}
           AND CLING_COST_DV_CD IN ('02')
        <if test="@MybatisUtils@isNotEmpty(bldCd)">
           AND BLD_CD = #{bldCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(bldNm)">
           AND BLD_CD IN (SELECT B.BLD_CD
                            FROM TB_OGBS_MM_OG_IZ A /*월조직내역*/
                           INNER JOIN TB_OGBS_BLD_BAS B /*빌딩기본*/
                              ON A.BLD_CD = B.BLD_CD
                             AND A.BASE_YM = SUBSTR(B.OP_DT, 1,6)
                           WHERE 1=1
                             AND B.BLD_NM LIKE '%'||#{bldNm}||'%')
        </if>
        ORDER BY APLC_DT DESC, FST_RGST_DTM DESC
    </select>

    <update id="removeCleaningCost">
        UPDATE TB_CBCL_CLING_COST_ADJ_IZ
           SET DTA_DL_YN = 'Y'
         <include refid="COMMON.updateSystemField"/>
         WHERE CLING_COST_ADJ_RCP_NO = #{clingCostAdjRcpNo}
    </update>

</mapper>
