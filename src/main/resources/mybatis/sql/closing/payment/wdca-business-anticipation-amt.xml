<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.closing.payment.mapper.WdcaBusinessAnticipationAmtMapper">
    <insert id="insertBusinessBasic">
        INSERT INTO TB_CBCL_BZNS_ATAM_BAS(
            RVE_NO
            , RVE_SN
            , DP_CL_DT
            , CNTR_NO
            , CNTR_SN
            , KW_GRP_CO_CD
            , RVE_CD
            , OG_TP_CD
            , ICHR_PRTNR_NO
            , RVE_AMT
            , CST_NO
            , BZNS_ATAM_BLAM
            , SAP_DP_TP_CD
            , SAP_PD_DV_CD
            , SAP_PD_ATC_CD
            , DG_CST_ID
            , BNK_CD
            , DP_CPRCNF_NO
            , PD_CD
            , PD_HCLSF_ID
            , PD_MCLSF_ID
            , PD_LCLSF_ID
            , RVE_DT
            , PERF_DT
            , BIL_TN
            , PROCS_DV_CD
            , DP_MES_CD
            , DP_TP_CD
            , RVE_DV_CD
            , RVE_PH_CD
            , RVEPLC_DV_CD
            , CDCO_CD
            , DP_DV_CD
            , SELL_TP_CD
            , SELL_TP_DTL_CD
            , CARD_APRNO
            , CRCDNO_ENCR
            , DPR_NM
            , ACNO_ENCR
            , CRP_ACNO
            , VNCO_DV_CD
            , DP_SLIP_TRS_NO
            , ETC_ATAM_NO
            , PTYPF_HD_Y
            , PTYPF_OJ_CD
            , PTYPF_SMRY
            , PTYPF_PRCSDT
            , PTYPF_DP_SLIP_TRS_NO
            , SAP_SLPNO
            , SAP_SLIP_MSG
            , DTA_DL_YN
            <include refid="COMMON.insertSystemField" />
        ) VALUES (
            #{rveNo}
            , #{rveSn}
            , #{dpClDt}
            , #{cntrNo}
            , #{cntrSn}
            , #{kwGrpCoCd}
            , #{rveCd}
            , #{ogTpCd}
            , #{ichrPrtnrNo}
            , #{rveAmt}
            , #{cstNo}
            , #{bznsAtamBlam}
            , #{sapDpTpCd}
            , #{sapPdDvCd}
            , #{sapPdAtcCd}
            , #{dgCstId}
            , #{bnkCd}
            , #{dpCprcnfNo}
            , #{pdCd}
            , #{pdHclsfId}
            , #{pdMclsfId}
            , #{pdLclsfId}
            , #{rveDt}
            , #{perfDt}
            , #{bilTn}
            , #{procsDvCd}
            , #{dpMesCd}
            , #{dpTpCd}
            , #{rveDvCd}
            , #{rvePhCd}
            , #{rveplcDvCd}
            , #{cdcoCd}
            , #{dpDvCd}
            , #{sellTpCd}
            , #{sellTpDtlCd}
            , #{cardAprno}
            , #{crcdnoEncr}
            , #{dprNm}
            , #{acnoEncr}
            , #{crpAcno}
            , #{vncoDvCd}
            , #{dpSlipTrsNo}
            , #{etcAtamNo}
            , #{ptypfHdY}
            , #{ptypfOjCd}
            , #{ptypfSmry}
            , #{ptypfPrcsdt}
            , #{ptypfDpSlipLineSn}
            , #{sapSlpno}
            , #{sapSlipMsg}
            , 'N'
            <include refid="COMMON.insertSystemFieldValue" />
        )
    </insert>

    <insert id="insertEtcProcess">
        INSERT INTO TB_CBCL_ETC_ATAM_PROCS_IZ(
            ETC_ATAM_NO
            , ETC_ATAM_SN
            , ETC_ATAM_PROCS_CD
            , ETC_ATAM_PRCSDT
            , ETC_ATAM_PROCS_AMT
            , SAP_DP_TP_CD
            , SAP_PD_DV_CD
            , SAP_PD_ATC_CD
            , DG_CST_ID
            , RVE_NO
            , RVE_SN
            , RFND_RCP_NO
            , RVE_DT
            , BIL_TN
            , PROCS_DV_CD
            , DP_DV_CD
            , SELL_TP_CD
            , SELL_TP_DTL_CD
            , PD_CD
            , PD_HCLSF_ID
            , PD_MCLSF_ID
            , PD_LCLSF_ID
            , DP_MES_CD
            , DP_TP_CD
            , CDCO_CD
            , CARD_APRNO
            , CRCDNO_ENCR
            , BNK_CD
            , DPR_NM
            , ACNO_ENCR
            , CRP_ACNO
            , VNCO_DV_CD
            , CNTR_NO
            , CNTR_SN
            , KW_GRP_CO_CD
            , RVE_CD
            , RVE_DV_CD
            , RVE_PH_CD
            , RVEPLC_DV_CD
            , OG_TP_CD
            , ICHR_PRTNR_NO
            , CST_NO
            , DTA_DL_YN
            <include refid="COMMON.insertSystemField" />
        ) VALUES (
            #{etcAtamNo}
            , (SELECT NVL(MAX(ETC_ATAM_SN),0)+1
                 FROM TB_CBCL_ETC_ATAM_PROCS_IZ
                WHERE ETC_ATAM_NO = #{etcAtamNo})
            , #{inputGubun}
            , #{rveDt}
            , #{rveAmt}
            , #{sapDpTpCd}
            , #{sapPdDvCd}
            , #{sapPdAtcCd}
            , #{dgCstId}
            , #{rveNo}
            , #{rveSn}
            , (SELECT MAX(RFND_RCP_NO) FROM TB_RVDW_RFND_RCP_BAS WHERE CNTR_NO = #{cntrNo} AND CNTR_SN = #{cntrSn})
            , #{rveDt}
            , #{bilTn}
            , #{procsDvCd}
            , #{dpDvCd}
            , #{sellTpCd}
            , #{sellTpDtlCd}
            , #{pdCd}
            , #{pdHclsfId}
            , #{pdMclsfId}
            , #{pdLclsfId}
            , #{dpMesCd}
            , #{dpTpCd}
            , #{cdcoCd}
            , #{cardAprno}
            , #{crcdnoEncr}
            , #{bnkCd}
            , #{dprNm}
            , #{acnoEncr}
            , #{crpAcno}
            , #{vncoDvCd}
            , #{cntrNo}
            , #{cntrSn}
            , #{kwGrpCoCd}
            , #{rveCd}
            , #{rveDvCd}
            , #{rvePhCd}
            , #{rveplcDvCd}
            , #{ogTpCd}
            , #{ichrPrtnrNo}
            , #{cstNo}
            , 'N'
            <include refid="COMMON.insertSystemFieldValue" />
        )
    </insert>

    <select id="selectSapProductDivisionCode" resultType="String">
        SELECT NVL(MAX(SAP_PD_DV_CD), '') AS SAP_PD_DV_CD
          FROM TB_CBCL_SAP_PD_DV_CD
         WHERE SELL_TP_CD = #{sellTpCd}  /*판매유형코드*/
           AND SELL_TP_DTL_CD = #{sellTpDtlCd}  /*판매유형상세코드*/
           AND SAP_BZ_TERY_CD = '1210'
           AND DTA_DL_YN = 'N'
    </select>

    <select id="selectContract" resultType="Map">
        SELECT CNTR_DTL_STAT_CD /*계약상세상태코드*/
          FROM TB_SSCT_CNTR_DTL
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </select>

    <select id="selectCustomerId" resultType="String">
        SELECT NVL(MAX(DG_CST_ID), '') AS DG_CST_ID
          FROM TB_CBCL_DG_CST_ID_BAS
         WHERE SELL_TP_CD = #{sellTpCd}  /*판매유형코드*/
           AND SELL_TP_DTL_CD = #{sellTpDtlCd}  /*판매유형상세코드*/
           AND SAP_BZ_TERY_CD = '1210'
           AND DTA_DL_YN = 'N'
    </select>

    <insert id="insertBusinessProcess">
        INSERT INTO TB_CBCL_BZNS_ATAM_PROCS_IZ(
            RVE_NO
            , RVE_SN
            , BZNS_ATAM_SN
            , BZNS_ATAM_PROCS_CD
            , BZNS_ATAM_PROCS_AMT
            , DTA_DL_YN
            <include refid="COMMON.insertSystemField" />
        ) VALUES (
            #{rveNo}
            , #{rveSn}
            , (SELECT NVL(MAX(BZNS_ATAM_SN),0)+1
                 FROM TB_CBCL_BZNS_ATAM_PROCS_IZ
                WHERE RVE_NO = #{rveNo}
                  AND RVE_SN = #{rveSn})
            , #{inputGubun}
            , #{rveAmt}
            , 'N'
            <include refid="COMMON.insertSystemFieldValue" />
        )
    </insert>

    <update id="updateBusinessBasic">
        UPDATE TB_CBCL_BZNS_ATAM_BAS
           SET BZNS_ATAM_BLAM = BZNS_ATAM_BLAM - #{rveAmt}
               <include refid="COMMON.updateSystemField" />
         WHERE RVE_NO = #{rveNo}
           AND RVE_SN = #{rveSn}
    </update>

    <update id="updateEtcBasic">
        UPDATE TB_CBCL_ETC_ATAM_BAS
           SET ETC_ATAM_BLAM = ETC_ATAM_BLAM - #{rveAmt}
               <include refid="COMMON.updateSystemField" />
         WHERE ETC_ATAM_NO = #{etcAtamNo}
    </update>
</mapper>
