<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.closing.performance.mapper.WdccMembershipCnfmGenMapper">

    <select id="selectMembershipConfirmGens" resultType="com.kyowon.sms.wells.web.closing.performance.dto.WdccMembershipCnfmGenDto$SearchRes">
        SELECT M.CNTR_NO --계약번호
             , M.CNTR_SN  --계약일련번호
             , M.CNTR_NO || M.CNTR_SN AS CNTR_NO_SN  --계약일련번호
             , M.CST_KNM  --고객명
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', M.SELL_TP_CD) AS SELL_TP_NM --판매유형명
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_DTL_CD', M.SELL_TP_DTL_CD) AS SELL_TP_DTL_NM --판매유형상세코드명
             , M.CNTRW_TP_CD --계약서유형코드
             , M.SELL_OG_TP_CD --판매자조직유형코드
             , M.BASE_PD_CD --기준상품코드
             , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE PD_CD = M.BASE_PD_CD) AS PD_NM--상품명
             , '' AS USWY--, B.LCIUSE 용도
             , M.SV_PRD --서비스주기
             , M.FRISU_YN --무상여부
             , M.STPL_PTRM --약정기간
             , M.HCR_DV_CD --구분1(홈케어구분코드)
             , '' AS DV --, B.LCPRT2 --상품구분2 구분1과 동일한 값이 들어감
             , '' AS FNT_DV --, B.LCCHK1 --이체구분 ????
             , M.CNTR_CST_NO --계약고객번호
             , M.CNTR_RCP_FSH_DTM --계약접수완료일시
             , M.CNTR_PD_STRTDT --계약상품시작일자
             , M.IST_DT --설치일자
             , M.SELL_AMT --판매금액
             , M.STLM_TP_CD --결제유형코드
             , M.DSC_AMT --할인금액
             , M.CTT_RS_CD --컨택결과코드
             , F_CMZ_CD_NM('TNT_WELLS', 'LC_CTT_RS_CD', M.CTT_RS_CD) AS CTT_RS_NM --컨택결과코드명
             , M.CTT_PSIC_ID --컨택담당자ID
             , (SELECT PRTNR_KNM
                  FROM TB_OGBS_PRTNR_BAS /*파트너기본*/
                 WHERE 1 = 1
                   AND PRTNR_NO = M.CTT_PSIC_ID
                   AND ROWNUM = 1) AS CTT_PSIC_NM    --컨택담당자
             , M.FST_RGST_DTM --최초등록일시
             , M.FST_RGST_USR_ID --최초등록사용자ID
             , (SELECT PRTNR_KNM
                  FROM TB_OGBS_PRTNR_BAS /*파트너기본*/
                 WHERE 1 = 1
                   AND PRTNR_NO = M.FST_RGST_USR_ID
                   AND ROWNUM = 1) AS FST_RGST_USR_NM       --등록자
             , M.FST_RGST_PRG_ID --최초등록프로그램ID
             , M.FNL_MDFC_DTM --최종수정일자
             , M.FNL_MDFC_USR_ID --최종수정사용자ID
             , (SELECT PRTNR_KNM
                  FROM TB_OGBS_PRTNR_BAS /*파트너기본*/
                 WHERE 1 = 1
                   AND PRTNR_NO = M.FNL_MDFC_USR_ID
                   AND ROWNUM = 1) AS FNL_MDFC_USR_NM   --수정자
             , M.FNL_MDFC_PRG_ID --최종수정프로그램ID
             , M.CNTR_PD_ENDDT --계약상품종료일자
             , M.CNTR_CNFM_DTM --계약확정일시
             --,M.CNTR_PD_STRTDT --계약상품시작일자
             --, KA11.KAETC2
          FROM (SELECT T2.CNTR_NO
                     , T2.CNTR_SN
                     , T.CST_KNM  --고객명
                     , E.SELL_TP_CD --판매유형
                     , E.CNTRW_TP_CD --계약서유형코드
                     , T1.SELL_OG_TP_CD --판매자조직유형코드
                     , T2.BASE_PD_CD --기준상품코드
                     --,  B.LCIUSE 상품용도???
                     , T2.SV_PRD --서비스주기
                     , T2.FRISU_YN --무상여부
                     , T2.STPL_PTRM --약정기간
                     , F.HCR_DV_CD --홈케어구분코드
                     --,  B.LCPRT2 --상품구분2
                     --,  B.LCCHK1
                     , T1.CNTR_CST_NO --계약고객번호
                     , T1.CNTR_RCP_FSH_DTM --계약접수완료일시
                     , T2.CNTR_PD_STRTDT --계약상품시작일자
                     , F.IST_DT --설치일자
                     , T2.SELL_AMT --판매금액
                     , T2.STLM_TP_CD --결제유형코드
                     , T2.DSC_AMT --할인금액
                     , T2.CTT_RS_CD --컨택결과코드
                     , T2.CTT_PSIC_ID --컨택담당자ID
                     , T1.FST_RGST_DTM --최초등록일시
                     , T1.FST_RGST_USR_ID --최초등록사용자ID
                     , T1.FST_RGST_PRG_ID --최초등록프로그램ID
                     , T1.FNL_MDFC_DTM --최종수정일자
                     , T1.FNL_MDFC_USR_ID --최종수정사용자ID
                     , T1.FNL_MDFC_PRG_ID --최종수정프로그램ID
                     , T2.CNTR_PD_ENDDT --계약상품종료일자
                     , T1.CNTR_CNFM_DTM --계약확정일시
                     --, T2.CNTR_PD_STRTDT --계약상품시작일자
                     , E.SELL_TP_DTL_CD --판매유형상세코드
                     --,  KA11.KAETC2
                  FROM TB_SSCT_CNTR_BAS T1 --계약기본
                 INNER JOIN TB_SSCT_CNTR_DTL T2 --계약상세
                    ON T1.CNTR_NO = T2.CNTR_NO
                   AND T2.DTA_DL_YN = 'N'
                   AND T2.SELL_TP_CD = '3' --멤버십
                   AND T2.SELL_TP_DTL_CD != '33' --홈케어멤버십 재외
                   AND T2.CNTR_DTL_STAT_CD NOT IN ('301', '303', '401', '402') /*계약상세상태코드[301:고객요청해약, 303:계약취소, 401:최종종료, 402:계약기간종료]*/
                  LEFT OUTER JOIN TB_CBCL_DLQ_BAS T4 /*연체기본[AS-IS:LC5000P]*/
                    ON T4.DTA_DL_YN = 'N'
                   AND T4.PERF_YM   = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM') /*실적년월*/
                   AND T4.CNTR_NO   = T2.CNTR_NO /*계약번호*/
                   AND T4.CNTR_SN   = T2.CNTR_SN  /*계약일련번호*/
                   AND T4.DLQ_MCN   <![CDATA[<]]> 2	--연체건수 2개월 미만
                 INNER JOIN TB_SSCT_CNTR_REL D /*계약관계 (렌탈 -> 멤버십) [AS-IS:LCLIB.LC3100P+LCLIB.LC3500P]*/
                    ON D.DTA_DL_YN        = 'N'
                   AND D.BASE_DTL_CNTR_NO = T2.CNTR_NO
                   AND D.BASE_DTL_CNTR_SN = T2.CNTR_SN
                   AND D.CNTR_UNIT_TP_CD  = '020' /*계약단위유형코드 [010:계약, 020:계약상세]*/
                   AND D.CNTR_REL_TP_CD   = '20' /*계약관계유형코드 [10:계약전환관계, 20:연계상품계약관계, 30:대체회원계약관계]*/
                   AND D.CNTR_REL_DTL_CD  = '212' /*계약관계상세코드 [212:원주문-멤버십]*/
                 INNER JOIN TB_SSCT_CNTR_DTL E /*계약기본상세 [AS-IS:LCLIB.LC3100P]*/
                    ON E.DTA_DL_YN  = 'N'
                   AND E.CNTR_NO    = D.OJ_DTL_CNTR_NO
                   AND E.CNTR_SN    = D.OJ_DTL_CNTR_SN
                   AND E.SELL_TP_CD = '2' /*판매유형코드 [1:할부, 2:렌탈/리스, 3:멤버십, 4:회사설치, 5:유지관리, 6:정기배송, 9:필터]*/
                 INNER JOIN TB_SSCT_CNTR_WELLS_DTL F /*계약WELLS상세 [AS-IS:LCLIB.LCAK10P]*/
                    ON E.DTA_DL_YN = 'N'
                   AND F.CNTR_NO   = E.CNTR_NO
                   AND F.CNTR_SN   = E.CNTR_SN
                   AND F.REQD_DT   IS NULL		   --철거일자
                 INNER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ G /*WELLS매출월마감내역 [AS-IS:LC5000P]*/
                    ON G.DTA_DL_YN = 'N'
                   AND G.CNTR_NO   = E.CNTR_NO
                   AND G.CNTR_SN   = E.CNTR_SN
                   AND G.SL_CL_YM  = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM')
                   AND G.RENTAL_TN >= E.CNTR_PTRM
                  LEFT OUTER JOIN TB_CUBS_CST_BAS  T --고객기본
                    ON T1.CNTR_CST_NO = T.CST_NO
                   AND T.NUSD_RSON_CD IS NULL
                   AND T.DTA_DL_YN = 'N'
                 WHERE 1 = 1
                   AND T1.CNTR_CST_NO != '1018139767000' /*계약고객번호(공문교육건제외)*/
                   AND SUBSTR(T1.CNTR_RCP_FSH_DTM,1,6) <![CDATA[>=]]>  #{fromCntrRcpFshDtm}				--계약접수완료일자
                   AND SUBSTR(T1.CNTR_RCP_FSH_DTM,1,6) <![CDATA[<=]]>  #{toCntrRcpFshDtm}				--계약접수완료일자
                   AND T2.CNTR_PD_STRTDT IS NULL --멤버십 가입일자 미존재 --계약상품시작일자 미존재 (AS-IS 멤버십 가입일자)
                   AND T2.CNTR_PD_ENDDT = '99991231' --멤버십 탈퇴일자 미존재 --계약상품종료일자 미존재 (AS-IS 멤버십 탈퇴일자, 멤버십 취소일자)
                   AND T1.CNTR_CNFM_DTM IS NULL --멤버십 확정일자 미존재 --계약확정일자 미존재 (AS-IS 멤버십 확정일자)
                <if test="@MybatisUtils@isNotEmpty(cntrNo) and @MybatisUtils@isNotEmpty(cntrSn)">
                   AND T2.CNTR_NO = #{cntrNo}
                   AND T2.CNTR_SN = #{cntrSn}
                </if>
                <if test="@MybatisUtils@isNotEmpty(sellTpCd)">
                   AND E.SELL_TP_CD = #{sellTpCd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd)">
                   AND E.SELL_TP_DTL_CD = #{sellTpDtlCd}
                </if>
               /*화면 조직선택 - 영업부인 경우*/
               <if test="@MybatisUtils@equals(sellInflwChnlDtlCd,'2')">
                   AND T1.SELL_INFLW_CHNL_DTL_CD NOT IN ('3010', '4010') /*3010:아웃바운드(SalesTM), 4010:여행특판*/
               </if>
               /*화면 조직선택 - 영업부인 경우*/

               /*화면 조직선택 - 고객센터인 경우*/
               <if test="@MybatisUtils@equals(sellInflwChnlDtlCd,'1')">
                   AND T1.SELL_INFLW_CHNL_DTL_CD IN ('3010', '4010') /*3010:아웃바운드(SalesTM), 4010:여행특판*/
               </if>
               /*화면 조직선택 - 고객센터인 경우*/
               ---------------------------------------------------
               -- 2.만료고객 멤버십 확정 대상 조회(2020.02.19 추가)
               ---------------------------------------------------
                 UNION ALL
                SELECT T2.CNTR_NO
                     , T2.CNTR_SN
                     , T.CST_KNM --고객명
                     , E.SELL_TP_CD --판매유형
                     , E.CNTRW_TP_CD --계약서유형코드
                     , T1.SELL_OG_TP_CD --판매자조직유형코드
                     , T2.BASE_PD_CD --기준상품코드
                     --, B.LCIUSE
                     , T2.SV_PRD --서비스주기
                     , T2.FRISU_YN --무상여부
                     , T2.STPL_PTRM --약정기간
                     , T5.HCR_DV_CD --홈케어구분코드
                     --, B.LCPRT2 --상품구분2
                     --, B.LCCHK1
                     , T1.CNTR_CST_NO --계약고객번호
                     , T1.CNTR_RCP_FSH_DTM --계약접수완료일시
                     , T2.CNTR_PD_STRTDT --계약상품시작일자
                     , T5.IST_DT --설치일자
                     , T2.SELL_AMT --판매금액
                     , T2.STLM_TP_CD --결제유형코드
                     , T2.DSC_AMT --할인금액
                     , T2.CTT_RS_CD --컨택결과코드
                     , T2.CTT_PSIC_ID --컨택담당자ID
                     , T1.FST_RGST_DTM --최초등록일시
                     , T1.FST_RGST_USR_ID --최초등록사용자ID
                     , T1.FST_RGST_PRG_ID --최초등록프로그램ID
                     , T1.FNL_MDFC_DTM --최종수정일자
                     , T1.FNL_MDFC_USR_ID --최종수정사용자ID
                     , T1.FNL_MDFC_PRG_ID --최종수정프로그램ID
                     , T2.CNTR_PD_ENDDT --계약상품종료일자
                     , T1.CNTR_CNFM_DTM --계약확정일시
                     --, T2.CNTR_PD_STRTDT --계약상품시작일자
                     , E.SELL_TP_DTL_CD --판매유형상세코드
                     --, KA11.KAETC2
                  FROM TB_SSCT_CNTR_BAS T1 --계약기본
                 INNER JOIN TB_SSCT_CNTR_DTL T2 --계약상세
                    ON T1.CNTR_NO = T2.CNTR_NO
                   AND T2.SELL_TP_DTL_CD != '33' --홈케어멤버십 재외
                   AND T2.SELL_TP_CD = '2'	--렌탈
                  LEFT OUTER JOIN TB_CBCL_DLQ_BAS T4 /*연체기본 [AS-IS:LCLIB.LC5000P]*/
                /* 연체금이 있으면 매출데이터가 생성되는 것을 이용하기 위한 전월매출 조회결과 조인 */
                    ON T2.CNTR_NO = T4.CNTR_NO
                   AND T2.CNTR_SN = T4.CNTR_SN
                   AND T4.PERF_YM = TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMM')
                   AND NVL(T4.EOT_DLQ_AMT, 0) = 0 /*기말연체금액 = 0 (연체없는건)*/
                 INNER JOIN TB_SSCT_CNTR_WELLS_DTL T5 --계약WELLS상세
                    ON T2.CNTR_NO = T5.CNTR_NO
                   AND T2.CNTR_SN = T5.CNTR_SN
                 INNER JOIN TB_SSCT_CNTR_REL D /*계약관계 (렌탈 -> 멤버십) [AS-IS:LCLIB.LC3100P+LCLIB.LC3500P]*/
                    ON D.DTA_DL_YN        = 'N'
                   AND D.BASE_DTL_CNTR_NO = T2.CNTR_NO
                   AND D.BASE_DTL_CNTR_SN = T2.CNTR_SN
                   AND D.CNTR_UNIT_TP_CD  = '020' /*계약단위유형코드 [010:계약, 020:계약상세]*/
                   AND D.CNTR_REL_TP_CD   = '20' /*계약관계유형코드 [10:계약전환관계, 20:연계상품계약관계, 30:대체회원계약관계]*/
                   AND D.CNTR_REL_DTL_CD  = '212' /*계약관계상세코드 [212:원주문-멤버십]*/
                 INNER JOIN TB_SSCT_CNTR_DTL E /*계약기본상세 [AS-IS:LCLIB.LC3100P]*/
                    ON E.DTA_DL_YN  = 'N'
                   AND E.CNTR_NO    = D.OJ_DTL_CNTR_NO
                   AND E.CNTR_SN    = D.OJ_DTL_CNTR_SN
                   AND E.SELL_TP_CD = '2' /*판매유형코드 [1:할부, 2:렌탈/리스, 3:멤버십, 4:회사설치, 5:유지관리, 6:정기배송, 9:필터]*/
                   AND E.CNTR_DTL_STAT_CD IN ('301', '303', '401', '402') /*계약상세상태코드[301:고객요청해약, 303:계약취소, 401:최종종료, 402:계약기간종료]*/
                 INNER JOIN TB_SSCT_CNTR_WELLS_DTL F /*계약WELLS상세 [AS-IS:LCLIB.LCAK10P]*/
                    ON F.DTA_DL_YN = 'N'
                   AND F.CNTR_NO   = E.CNTR_NO
                   AND F.CNTR_SN   = E.CNTR_SN
                   AND F.REQD_DT IS NULL  --철거일자
                 INNER JOIN (SELECT MAX(SL_CL_YM) AS SL_CL_YM
                                  , CNTR_NO
                                  , CNTR_SN
                                  , MAX(RENTAL_TN) AS RENTAL_TN
                               FROM TB_CBCL_WELLS_SL_MM_CL_IZ G /*WELLS매출월마감내역 [AS-IS:LC5000P]*/
                              WHERE DTA_DL_YN  = 'N'
                              GROUP BY CNTR_NO, CNTR_SN) G
                    ON G.CNTR_NO    = E.CNTR_NO
                   AND G.CNTR_SN    = E.CNTR_SN
                   AND G.RENTAL_TN >= E.CNTR_PTRM
                 INNER JOIN TB_SSCT_CNTR_BAS H /*계약기본 [AS-IS:LCLIB.LC3100P]*/
                    ON H.DTA_DL_YN = 'N'
                   AND H.CNTR_NO   = E.CNTR_NO
                   AND H.CNTR_CAN_DTM IS NULL
                  LEFT OUTER JOIN TB_CUBS_CST_BAS  T --고객기본
                    ON T1.CNTR_CST_NO = T.CST_NO
                   AND T.NUSD_RSON_CD IS NULL
                   AND T.DTA_DL_YN = 'N'
                 WHERE 1 = 1
                   AND T1.CNTR_CST_NO != '1018139767000' /*계약고객번호(공문교육건제외)*/
                   AND SUBSTR(T1.CNTR_RCP_FSH_DTM,1,6) <![CDATA[>=]]>  #{fromCntrRcpFshDtm}				--계약접수완료일자
                   AND SUBSTR(T1.CNTR_RCP_FSH_DTM,1,6) <![CDATA[<=]]>  #{toCntrRcpFshDtm}				--계약접수완료일자
                   AND T2.CNTR_PD_STRTDT IS NULL --멤버십 가입일자 미존재 --계약상품시작일자 미존재 (AS-IS 멤버십 가입일자)
                   AND T2.CNTR_PD_ENDDT = '99991231' --멤버십 탈퇴일자 미존재 --계약상품종료일자 미존재 (AS-IS 멤버십 탈퇴일자, 멤버십 취소일자)
                   AND T1.CNTR_CNFM_DTM IS NULL --멤버십 확정일자 미존재 --계약확정일자 미존재 (AS-IS 멤버십 확정일자)
                <if test="@MybatisUtils@isNotEmpty(cntrNo) and @MybatisUtils@isNotEmpty(cntrSn)">
                   AND T2.CNTR_NO = #{cntrNo}
                   AND T2.CNTR_SN = #{cntrSn}
                </if>
                <if test="@MybatisUtils@isNotEmpty(sellTpCd)">
                   AND E.SELL_TP_CD = #{sellTpCd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd)">
                   AND E.SELL_TP_DTL_CD = #{sellTpDtlCd}
                </if>
               /*화면 조직선택 - 영업부인 경우*/
               <if test="@MybatisUtils@equals(sellInflwChnlDtlCd,'2')">
                   AND T1.SELL_INFLW_CHNL_DTL_CD NOT IN ('3010', '4010') /*3010:아웃바운드(SalesTM), 4010:여행특판*/
               </if>
               /*화면 조직선택 - 영업부인 경우*/

               /*화면 조직선택 - 고객센터인 경우*/
               <if test="@MybatisUtils@equals(sellInflwChnlDtlCd,'1')">
                   AND T1.SELL_INFLW_CHNL_DTL_CD IN ('3010', '4010') /*3010:아웃바운드(SalesTM), 4010:여행특판*/
               </if>
               /*화면 조직선택 - 고객센터인 경우*/
               ---------------------------------------------------
               -- 2022.11.25 조상희 수정 : 3. 5. 번 쿼리 병합
               -- 3. 일반일시불(국고보조금,웰스팜 등) + 즉시멤버십유상 가입건
               ---------------------------------------------------
                 UNION ALL
                SELECT T2.CNTR_NO
                     , T2.CNTR_SN
                     , T.CST_KNM  --고객명
                     , T2.SELL_TP_CD --판매유형
                     , T2.CNTRW_TP_CD --계약서유형코드
                     , T1.SELL_OG_TP_CD --판매자조직유형코드
                     , T2.BASE_PD_CD --기준상품코드
                     --,  B.LCIUSE
                     , T2.SV_PRD --서비스주기
                     , T2.FRISU_YN --무상여부
                     , T2.STPL_PTRM --약정기간
                     , T3.HCR_DV_CD --홈케어구분코드
                     --,  B.LCPRT2 --상품구분2
                     --,  B.LCCHK1
                     , T1.CNTR_CST_NO --계약고객번호
                     , T1.CNTR_RCP_FSH_DTM --계약접수완료일시
                     , T2.CNTR_PD_STRTDT --계약상품시작일자
                     , T3.IST_DT --설치일자
                     , T2.SELL_AMT --판매금액
                     , T2.STLM_TP_CD --결제유형코드
                     , T2.DSC_AMT --할인금액
                     , T2.CTT_RS_CD --컨택결과코드
                     , T2.CTT_PSIC_ID --컨택담당자ID
                     , T1.FST_RGST_DTM --최초등록일시
                     , T1.FST_RGST_USR_ID --최초등록사용자ID
                     , T1.FST_RGST_PRG_ID --최초등록프로그램ID
                     , T1.FNL_MDFC_DTM --최종수정일자
                     , T1.FNL_MDFC_USR_ID --최종수정사용자ID
                     , T1.FNL_MDFC_PRG_ID --최종수정프로그램ID
                     , T2.CNTR_PD_ENDDT --계약상품종료일자
                     , T1.CNTR_CNFM_DTM --계약확정일시
                     --, T2.CNTR_PD_STRTDT --계약상품시작일자
                     , T2.SELL_TP_DTL_CD --판매유형상세코드
                     --,  KA11.KAETC2
                  FROM TB_SSCT_CNTR_BAS T1 --계약기본
                 INNER JOIN TB_SSCT_CNTR_DTL T2 --계약상세
                    ON T1.CNTR_NO = T2.CNTR_NO
                 INNER JOIN TB_SSCT_CNTR_WELLS_DTL T3 --계약WELLS상세
                    ON T2.CNTR_NO = T3.CNTR_NO
                   AND T2.CNTR_SN = T3.CNTR_SN
                   AND T3.IST_DT > 0
                  LEFT OUTER JOIN TB_CUBS_CST_BAS  T --고객기본
                    ON T1.CNTR_CST_NO = T.CST_NO
                   AND T.NUSD_RSON_CD IS NULL
                   AND T.DTA_DL_YN = 'N'
                 WHERE 1 = 1
                   AND T2.CNTRW_TP_CD != '5'    --홈케어멤버십 재외
                   AND T1.CNTR_CST_NO != '1018139767000' /*계약고객번호(공문교육건제외)*/
                   AND SUBSTR(T1.CNTR_RCP_FSH_DTM,1,6) <![CDATA[>=]]>  #{fromCntrRcpFshDtm}				--계약접수완료일자
                   AND SUBSTR(T1.CNTR_RCP_FSH_DTM,1,6) <![CDATA[<=]]>  #{toCntrRcpFshDtm}				--계약접수완료일자
                   AND T2.CNTR_PD_STRTDT IS NULL --멤버십 가입일자 미존재 --계약상품시작일자 미존재 (AS-IS 멤버십 가입일자)
                   AND T2.CNTR_PD_ENDDT = '99991231' --멤버십 탈퇴일자 미존재 --계약상품종료일자 미존재 (AS-IS 멤버십 탈퇴일자, 멤버십 취소일자)
                   AND T1.CNTR_CNFM_DTM IS NULL --멤버십 확정일자 미존재 --계약확정일자 미존재 (AS-IS 멤버십 확정일자)
                   AND T2.CNTR_PD_STRTDT > 0
                <if test="@MybatisUtils@isNotEmpty(cntrNo) and @MybatisUtils@isNotEmpty(cntrSn)">
                   AND T2.CNTR_NO = #{cntrNo}
                   AND T2.CNTR_SN = #{cntrSn}
                </if>
                <if test="@MybatisUtils@isNotEmpty(sellTpCd)">
                   AND T2.SELL_TP_CD = #{sellTpCd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd)">
                   AND T2.SELL_TP_DTL_CD = #{sellTpDtlCd}
                </if>
               /*화면 조직선택 - 영업부인 경우*/
               <if test="@MybatisUtils@equals(sellInflwChnlDtlCd,'2')">
                   AND T1.SELL_INFLW_CHNL_DTL_CD NOT IN ('3010', '4010') /*3010:아웃바운드(SalesTM), 4010:여행특판*/
               </if>
               /*화면 조직선택 - 영업부인 경우*/

               /*화면 조직선택 - 고객센터인 경우*/
               <if test="@MybatisUtils@equals(sellInflwChnlDtlCd,'1')">
                   AND T1.SELL_INFLW_CHNL_DTL_CD IN ('3010', '4010') /*3010:아웃바운드(SalesTM), 4010:여행특판*/
               </if>
               /*화면 조직선택 - 고객센터인 경우*/
               ---------------------------------------------------
               -- 4.회사설치 건 확정대상 조회 조건 추가
               ---------------------------------------------------
                 UNION ALL
                SELECT T2.CNTR_NO
                     , T2.CNTR_SN
                     , T.CST_KNM  --고객명
                     , T2.SELL_TP_CD --판매유형
                     , T2.CNTRW_TP_CD --계약서유형코드
                     , T1.SELL_OG_TP_CD --판매자조직유형코드
                     , T2.BASE_PD_CD --기준상품코드
                     --,  B.LCIUSE
                     , T2.SV_PRD --서비스주기
                     , T2.FRISU_YN --무상여부
                     , T2.STPL_PTRM --약정기간
                     , F.HCR_DV_CD --홈케어구분코드
                     --,  B.LCPRT2 --상품구분2
                     --,  B.LCCHK1
                     , T1.CNTR_CST_NO --계약고객번호
                     , T1.CNTR_RCP_FSH_DTM --계약접수완료일시
                     , T2.CNTR_PD_STRTDT --계약상품시작일자
                     , F.IST_DT --설치일자
                     , T2.SELL_AMT --판매금액
                     , T2.STLM_TP_CD --결제유형코드
                     , T2.DSC_AMT --할인금액
                     , T2.CTT_RS_CD --컨택결과코드
                     , T2.CTT_PSIC_ID --컨택담당자ID
                     , T1.FST_RGST_DTM --최초등록일시
                     , T1.FST_RGST_USR_ID --최초등록사용자ID
                     , T1.FST_RGST_PRG_ID --최초등록프로그램ID
                     , T1.FNL_MDFC_DTM --최종수정일자
                     , T1.FNL_MDFC_USR_ID --최종수정사용자ID
                     , T1.FNL_MDFC_PRG_ID --최종수정프로그램ID
                     , T2.CNTR_PD_ENDDT --계약상품종료일자
                     , T1.CNTR_CNFM_DTM --계약확정일시
                     --, T2.CNTR_PD_STRTDT --계약상품시작일자
                     , E.SELL_TP_DTL_CD --판매유형상세코드
                     --,  KA11.KAETC2
                  FROM TB_SSCT_CNTR_DTL T2 /*계약기본상세 [AS-IS:LCLIB.LC3500P] -- 멤버십계약만*/
                 INNER JOIN TB_SSCT_CNTR_BAS T1 /*계약기본 [AS-IS:LCLIB.LC3500P]*/
                    ON T1.DTA_DL_YN    = 'N'
                   AND T1.CNTR_NO      = T1.CNTR_NO
                   --AND SUBSTR(T1.CNTR_RCP_FSH_DTM, 1, 6) >= TO_CHAR(ADD_MONTHS(SYSDATE, -4), 'YYYYMM')
                   AND T1.SELL_INFLW_CHNL_DTL_CD NOT IN ('3010', '4010') /*3010:아웃바운드(SalesTM), 4010:여행특판*/
                 INNER JOIN TB_SSCT_CNTR_REL D /*계약관계 (렌탈 -> 멤버십) [AS-IS:LCLIB.LC3100P+LCLIB.LC3500P]*/
                    ON D.DTA_DL_YN        = 'N'
                   AND D.BASE_DTL_CNTR_NO = T2.CNTR_NO
                   AND D.BASE_DTL_CNTR_SN = T2.CNTR_SN
                   AND D.CNTR_UNIT_TP_CD  = '020' /*계약단위유형코드 [010:계약, 020:계약상세]*/
                   AND D.CNTR_REL_TP_CD   = '20' /*계약관계유형코드 [10:계약전환관계, 20:연계상품계약관계, 30:대체회원계약관계]*/
                   AND D.CNTR_REL_DTL_CD  = '212' /*계약관계상세코드 [212:원주문-멤버십]*/
                 INNER JOIN TB_SSCT_CNTR_DTL E /*계약기본상세 [AS-IS:LCLIB.LC3100P]*/
                    ON E.DTA_DL_YN  = 'N'
                   AND E.CNTR_NO    = D.OJ_DTL_CNTR_NO
                   AND E.CNTR_SN    = D.OJ_DTL_CNTR_SN
                   AND E.SELL_TP_CD = '3' /*판매유형코드 [1:할부, 2:렌탈/리스, 3:멤버십, 4:회사설치, 5:유지관리, 6:정기배송, 9:필터]*/
                   AND E.SELL_TP_DTL_CD = '34' /*판매유형상세코드 [34:회사설치]*/
                 INNER JOIN TB_SSCT_CNTR_WELLS_DTL F /*계약WELLS상세 [AS-IS:LCLIB.LCAK10P]*/
                    ON F.DTA_DL_YN = 'N'
                   AND F.CNTR_NO   = E.CNTR_NO
                   AND F.CNTR_SN   = E.CNTR_SN
                  LEFT OUTER JOIN TB_CUBS_CST_BAS  T --고객기본
                    ON T1.CNTR_CST_NO = T.CST_NO
                   AND T.NUSD_RSON_CD IS NULL
                   AND T.DTA_DL_YN = 'N'
                 WHERE T2.DTA_DL_YN       = 'N'
                   AND T2.SELL_TP_CD      = '3'  /*판매유형코드 [1:할부, 2:렌탈/리스, 3:멤버십, 4:회사설치, 5:유지관리, 6:정기배송, 9:필터]*/
                   AND T2.SELL_TP_DTL_CD != '33' /*판매유형상세코드 [33:홈케어]*/
                   AND SUBSTR(T1.CNTR_RCP_FSH_DTM,1,6) <![CDATA[>=]]>  #{fromCntrRcpFshDtm}				--계약접수완료일자
                   AND SUBSTR(T1.CNTR_RCP_FSH_DTM,1,6) <![CDATA[<=]]>  #{toCntrRcpFshDtm}				--계약접수완료일자
                   AND T2.CNTR_PD_STRTDT IS NULL --멤버십 가입일자 미존재 --계약상품시작일자 미존재 (AS-IS 멤버십 가입일자)
                   AND T2.CNTR_PD_ENDDT = '99991231' --멤버십 탈퇴일자 미존재 --계약상품종료일자 미존재 (AS-IS 멤버십 탈퇴일자, 멤버십 취소일자)
                   AND T1.CNTR_CNFM_DTM IS NULL --멤버십 확정일자 미존재 --계약확정일자 미존재 (AS-IS 멤버십 확정일자)
                <if test="@MybatisUtils@isNotEmpty(cntrNo) and @MybatisUtils@isNotEmpty(cntrSn)">
                   AND T2.CNTR_NO = #{cntrNo}
                   AND T2.CNTR_SN = #{cntrSn}
                </if>
                <if test="@MybatisUtils@isNotEmpty(sellTpCd)">
                   AND E.SELL_TP_CD = #{sellTpCd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd)">
                   AND E.SELL_TP_DTL_CD = #{sellTpDtlCd}
                </if>
               /*화면 조직선택 - 영업부인 경우*/
               <if test="@MybatisUtils@equals(sellInflwChnlDtlCd,'2')">
                   AND T1.SELL_INFLW_CHNL_DTL_CD NOT IN ('3010', '4010') /*3010:아웃바운드(SalesTM), 4010:여행특판*/
               </if>
               /*화면 조직선택 - 영업부인 경우*/

               /*화면 조직선택 - 고객센터인 경우*/
               <if test="@MybatisUtils@equals(sellInflwChnlDtlCd,'1')">
                   AND T1.SELL_INFLW_CHNL_DTL_CD IN ('3010', '4010') /*3010:아웃바운드(SalesTM), 4010:여행특판*/
               </if>) M
               /*화면 조직선택 - 고객센터인 경우*/
         ORDER BY M.CNTR_NO
    </select>

    <update id="updateMembershipCnfmGen">
        UPDATE TB_SSCT_CNTR_BAS
           SET CNTR_CNFM_DTM = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
        <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND CNTR_NO = #{cntrNo}
    </update>
</mapper>
