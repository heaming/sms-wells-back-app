<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.closing.performance.mapper.WdccOverduePenaltyMapper">

    <select id="selectCode" resultType="com.kyowon.sms.wells.web.closing.performance.dto.WdccOverduePenaltyDto$FindCodeRes">
        SELECT DISTINCT SAP_PD_DV_CD
             , SAP_PD_DV_NM
          FROM TB_CBCL_SAP_PD_DV_CD
         WHERE SAP_BZ_TERY_CD = '1210'
           AND SAP_PD_ATC_CD = '00'
    </select>

    <select id="selectPointAggregates" resultType="com.kyowon.sms.wells.web.closing.performance.dto.WdccOverduePenaltyDto$SearchPointAggregateRes">
        -- 렌탈/리스 포인트선수 집계
        WITH T1 AS (
            SELECT A.SL_CL_YM -- 실적년월
                 , A.SELL_TP_CD -- 판매유형코드
                 , A.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세코드
                 , A.SAP_PD_DV_CD AS SAP_PD_DV_CD -- SAP상품구분코드
                 , A.MLG_BTD_PRPD_AMT AS MLG_BTD_PRPD_AMT -- 기초마일리지금액
                 , A.MLG_DP_AMT AS MLG_DP_AMT -- 마일리지입금금액
                 , A.MLG_RFND_AMT AS MLG_RFND_AMT -- 마일리지환불금액
                 , A.MLG_SL_AMT AS MLG_SL_AMT -- 마일리지매출금액
                 , A.MLG_EOT_PRPD_AMT AS MLG_EOT_PRPD_AMT -- 마일리지기말선수금액
              FROM TB_CBCL_WELLS_SL_MM_CL_IZ A
              LEFT OUTER JOIN TB_SSCT_CNTR_BAS B -- 계약기본
                ON A.CNTR_NO = B.CNTR_NO
               AND B.DTA_DL_YN = 'N'
             WHERE A.SL_CL_YM  = #{slClYm}
               AND A.SELL_TP_CD = '2'
               <if test="@MybatisUtils@equals(sellTpCd, '2')">
               AND A.SELL_TP_DTL_CD IN ('21', '23')
               AND NOT EXISTS ( SELECT /*+ UNNEST */ 1
                                  FROM TB_SSCT_CNTR_DTL AA
                                 INNER JOIN TB_PDBS_PD_CLSF_BAS BB -- 상품분류기본-소분류[AS-IS:KA1100P]
                                    ON BB.PD_CLSF_ID = AA.PD_LCLSF_ID -- 상품분류ID = 상품세분류ID
                                   AND BB.DTA_DL_YN = 'N'
                                   AND BB.USE_YN = 'Y'
                                   AND BB.REF_PD_CLSF_VAL = '05003002' -- [Cooking+커피머신+원두]
                                 WHERE AA.CNTR_NO = A.CNTR_NO
                                   AND AA.CNTR_SN = A.CNTR_SN )
               </if>
               <if test="!@MybatisUtils@equals(sellTpCd, '2')">
               AND A.SELL_TP_DTL_CD NOT IN ('21', '23')
               </if>
               <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
               AND A.SELL_TP_DTL_CD = #{sellTpDtlCd}
               </if>
               <if test="@MybatisUtils@isNotEmpty(sapPdDvCd) and !@MybatisUtils@equals(sapPdDvCd, 'ALL')">
               AND A.SAP_PD_DV_CD = #{sapPdDvCd}
               </if>
               <if test="@MybatisUtils@isNotEmpty(cntrNo)">
               AND A.CNTR_NO   = #{cntrNo}   /*계약번호*/
               </if>
               <if test="@MybatisUtils@isNotEmpty(cntrSn)">
               AND A.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
               </if>
               <if test="@MybatisUtils@isNotEmpty(sellInflwChnlDtlCd) and !@MybatisUtils@equals(sellInflwChnlDtlCd, 'ALL')">
               AND B.SELL_INFLW_CHNL_DTL_CD = #{sellInflwChnlDtlCd}
               </if>
        ) SELECT T1.SL_CL_YM -- 실적년월
               , T1.SELL_TP_CD -- 판매유형코드
               , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = T1.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
               , T1.SELL_TP_DTL_CD -- 판매유형상세코드
               , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_DTL_CD' AND CD_VLD_VAL = T1.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
               , T1.SAP_PD_DV_CD AS SAP_PD_DV_CD
               , (SELECT MAX(SAP_PD_ATC_NM)
                  FROM TB_CBCL_SAP_PD_DV_CD
                  WHERE SAP_BZ_TERY_CD = '1210' -- SAP_BZ_TERY_CD : WELLS면 1210, EDU면 1110
                    AND SAP_PD_ATC_CD = '00'
                    AND SAP_PD_DV_CD = T1.SAP_PD_DV_CD) AS SAP_PD_ATC_NM -- SAP상품코드명*/
               , SUM(MLG_BTD_PRPD_AMT) AS MLG_BTD_PRPD_AMT -- 기초마일리지금액
               , SUM(MLG_DP_AMT) AS MLG_DP_AMT -- 마일리지입금금액
               , SUM(MLG_RFND_AMT) AS MLG_RFND_AMT -- 마일리지환불금액
               , SUM(MLG_DP_AMT - MLG_RFND_AMT) AS MLG_TOT_AMT -- 합계
               , SUM(MLG_SL_AMT) AS MLG_SL_AMT -- 마일리지매출금액
               , SUM(MLG_EOT_PRPD_AMT) AS MLG_EOT_PRPD_AMT -- 마일리지기말선수금액
            FROM T1
           WHERE 1=1
           GROUP BY SL_CL_YM, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
           ORDER BY SL_CL_YM DESC, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
    </select>

    <select id="selectPointOrders" resultType="com.kyowon.sms.wells.web.closing.performance.dto.WdccOverduePenaltyDto$SearchPointOrderRes">
        /* 포인트 선수금 주문별 조회시 */
        SELECT T1.SL_CL_YM AS SL_CL_YM-- 실적년월
             , T1.SELL_TP_CD AS SELL_TP_CD-- 판매유형코드
             , F_CMZ_CD_NM(#{session.tenantId}, 'SELL_TP_CD', T1.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
             , T1.SELL_TP_DTL_CD AS SELL_TP_DTL_CD-- 판매유형상세코드
             , F_CMZ_CD_NM(#{session.tenantId}, 'SELL_TP_DTL_CD', T1.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
             , T1.SAP_PD_DV_CD AS SAP_PD_DV_CD -- SAP상품구분코드
             , ( SELECT MAX(SAP_PD_ATC_NM)
                 FROM TB_CBCL_SAP_PD_DV_CD
                 WHERE SAP_BZ_TERY_CD = '1210' -- SAP_BZ_TERY_CD : WELLS면 1210, EDU면 1110
                   AND SAP_PD_ATC_CD = '00'
                   AND SAP_PD_DV_CD = T1.SAP_PD_DV_CD ) AS SAP_PD_ATC_NM -- SAP상품코드명
             , T1.CNTR_CST_NO AS CNTR_CST_NO -- 고객번호
             , ( SELECT CST_KNM FROM TB_CUBS_CST_BAS WHERE CST_NO = T1.CNTR_CST_NO AND DTA_DL_YN = 'N' ) AS CST_KNM -- 고객명
             , T1.CNTR_NO || '-' || T1.CNTR_SN AS CNTR_NO  -- 계약번호
             , T1.SL_RCOG_DT AS SL_RCOG_DT -- 매출일자
             , T1.MLG_BTD_PRPD_AMT AS MLG_BTD_PRPD_AMT -- 기초마일리지금액
             , T1.DP_TP_CD AS DP_TP_CD -- 입금유형코드
             , CASE WHEN T1.DP_TP_CD = '0605' THEN T1.MLG_DP_AMT - T1.MLG_RFND_AMT ELSE 0 END AS CHARGED_DP_AMT -- 유상입금
             , CASE WHEN T1.DP_TP_CD = '0606' THEN T1.MLG_DP_AMT - T1.MLG_RFND_AMT ELSE 0 END AS FREE_DP_AMT -- 무상입금
             , CASE WHEN T1.DP_TP_CD IS NULL OR T1.DP_TP_CD NOT IN ('0605', '0606') THEN T1.MLG_DP_AMT - T1.MLG_RFND_AMT ELSE 0 END AS ETC_DP_AMT -- 기타입금
             , CASE WHEN T1.DP_TP_CD = '0605' THEN T1.MLG_SL_AMT ELSE 0 END AS CHARGED_SL_AMT -- 유상매출
             , CASE WHEN T1.DP_TP_CD = '0606' THEN T1.MLG_SL_AMT ELSE 0 END AS FREE_SL_AMT -- 무상매출
             , CASE WHEN T1.DP_TP_CD IS NULL OR T1.DP_TP_CD NOT IN ('0605', '0606') THEN T1.MLG_SL_AMT ELSE 0 END AS ETC_SL_AMT -- 기타매출
             , T1.MLG_EOT_PRPD_AMT -- 마일리지기말선수금액
          FROM (
               SELECT A.SL_CL_YM -- 실적년월
                    , A.SELL_TP_CD -- 판매유형코드
                    , A.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세코드
                    , A.SAP_PD_DV_CD AS SAP_PD_DV_CD -- SAP상품구분코드
                    , B.CNTR_CST_NO AS CNTR_CST_NO -- 고객번호
                    , A.CNTR_NO AS CNTR_NO -- 계약번호
                    , A.CNTR_SN AS CNTR_SN -- 계약일련번호
                    , A.SL_RCOG_DT AS SL_RCOG_DT-- 매출일자
                    , A.MLG_BTD_PRPD_AMT AS MLG_BTD_PRPD_AMT -- 기초마일리지금액
                    , (SELECT DP_TP_CD
                         FROM ( SELECT *
                                  FROM TB_CBCL_BZNS_ATAM_BAS
                                 WHERE CNTR_NO = A.CNTR_NO
                                   AND CNTR_SN = A.CNTR_SN
                                   AND DP_DV_CD = '1' -- 입금
                                   AND DP_TP_CD IN ('0605', '0606', '0703') -- *TOBE : '0605'(유상포인트), '0606'(무상포인트), '0703'(k멤버스포인트) * ASIS : 'M'(포인트몰-유상) , 'N'(포인트몰-무상), 'P'(K포인트)
                                 ORDER BY PERF_DT DESC
                              )
                        WHERE ROWNUM = 1) AS DP_TP_CD -- 입금유형코드
                    , A.MLG_DP_AMT AS MLG_DP_AMT -- 마일리지입금금액
                    , A.MLG_RFND_AMT AS MLG_RFND_AMT -- 마일리지환불금액
                    , A.MLG_SL_AMT AS MLG_SL_AMT -- 마일리지매출금액
                    , A.MLG_EOT_PRPD_AMT AS MLG_EOT_PRPD_AMT -- 마일리지기말선수금액
                 FROM TB_CBCL_WELLS_SL_MM_CL_IZ A
                 LEFT OUTER JOIN TB_SSCT_CNTR_BAS B -- 계약기본
                   ON A.CNTR_NO = B.CNTR_NO
                  AND B.DTA_DL_YN = 'N'
                WHERE A.SL_CL_YM = #{slClYm}
                  AND A.SELL_TP_CD = '2'
                  <if test="@MybatisUtils@equals(sellTpCd, '2')">
                  AND A.SELL_TP_DTL_CD IN ('21', '23')
                  </if>
                  <if test="!@MybatisUtils@equals(sellTpCd, '2')">
                  AND A.SELL_TP_DTL_CD NOT IN ('21', '23')
                  </if>
                  <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                  AND A.SELL_TP_DTL_CD = #{sellTpDtlCd}
                  </if>
                  <if test="@MybatisUtils@isNotEmpty(sapPdDvCd) and !@MybatisUtils@equals(sapPdDvCd, 'ALL')">
                  AND A.SAP_PD_DV_CD = #{sapPdDvCd}
                  </if>
                  <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                  AND A.CNTR_NO   = #{cntrNo}   /*계약번호*/
                  </if>
                  <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                  AND A.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                  </if>
                  <if test="@MybatisUtils@isNotEmpty(sellInflwChnlDtlCd) and !@MybatisUtils@equals(sellInflwChnlDtlCd, 'ALL')">
                  AND B.SELL_INFLW_CHNL_DTL_CD = #{sellInflwChnlDtlCd}
                  </if>
                  AND A.MLG_BTD_PRPD_AMT + A.MLG_DP_AMT + A.MLG_RFND_AMT + A.MLG_SL_AMT != 0
               ) T1
    </select>

    <select id="selectAnticipationDates" resultType="com.kyowon.sms.wells.web.closing.performance.dto.WdccOverduePenaltyDto$SearchAggregateDateRes">
        ------------------------------------
        -- 선수금 일자별 조회
        -- 해당월 2일~현재일2일전까지 목록 조회
        ------------------------------------
        WITH W1 AS
        (SELECT SUBSTR(SL_CL_DT, 1, 6) AS SL_CL_YM
              , SL_CL_DT AS SL_CL_DT
              , ROWNUM AS ROW_NUM
              , RANK() OVER (ORDER BY SL_CL_DT DESC) AS RANK_NUM
          FROM (SELECT TO_CHAR(TO_DATE(#{slClYm}||'02','YYYYMMDD') + (LEVEL-1), 'YYYYMMDD') AS SL_CL_DT
                  FROM DUAL
               CONNECT BY LEVEL <![CDATA[ <= ]]> (CASE WHEN #{slClYm} <![CDATA[ < ]]> TO_CHAR(SYSDATE, 'YYYYMM')
                                                       THEN (SELECT LAST_DAY((SELECT TO_DATE(#{slClYm}||'01', 'YYYYMMDD') FROM DUAL)) FROM DUAL) - TO_DATE(#{slClYm}||'02','YYYYMMDD')
                                                       ELSE (SELECT TO_DATE(SYSDATE-1) FROM DUAL) - TO_DATE(#{slClYm}||'02','YYYYMMDD')
                                                        END))
         WHERE SL_CL_DT <![CDATA[ < ]]> TO_CHAR(SYSDATE, 'YYYYMMDD')
           AND SL_CL_DT <![CDATA[ <= ]]> (SELECT LAST_DAY((SELECT TO_DATE(#{slClYm}||'02', 'YYYYMMDD') FROM DUAL)) FROM DUAL)
         ORDER BY SL_CL_DT
        ), W2 AS
        ------------------------------------
        -- 일자별 선수현황 조회
        ------------------------------------
        (
        SELECT SL_CL_YM AS SL_CL_YM
             , PERF_DT AS PERF_DT
             , SELL_TP_CD AS SELL_TP_CD
             , SELL_TP_DTL_CD AS SELL_TP_DTL_CD
             , SAP_PD_DV_CD AS SAP_PD_DV_CD
             , DP_DV_CD AS DP_DV_CD
             , RVE_DV_CD AS RVE_DV_CD
             , SUM(RVE_AMT) AS RVE_AMT
          FROM (
                SELECT SUBSTR(A.PERF_DT,1,6) AS SL_CL_YM -- 실적년월
                     , A.PERF_DT AS PERF_DT -- 실적일자
                     , A.SELL_TP_CD AS SELL_TP_CD -- 판매유형코드
                     , A.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세코드
                     , A.SAP_PD_DV_CD AS SAP_PD_DV_CD -- SAP상품구분코드
                     , A.DP_DV_CD AS DP_DV_CD -- 입금구분
                     , A.RVE_DV_CD AS RVE_DV_CD -- 수납구분
                     , NVL(A.RVE_AMT,0) AS RVE_AMT
                  FROM TB_CBCL_BZNS_ATAM_BAS A
                  LEFT OUTER JOIN TB_SSCT_CNTR_BAS B -- 계약기본
                    ON A.CNTR_NO = B.CNTR_NO
                   AND B.DTA_DL_YN = 'N'
                 WHERE A.PERF_DT BETWEEN #{slClYm}||'01' AND TO_CHAR(LAST_DAY(TO_DATE(#{slClYm}, 'YYYYMM')), 'YYYYMMDD')
                   AND A.SELL_TP_CD = DECODE(#{sellTpCd}, '10', '2', #{sellTpCd}) /* 렌탈 리스 화면코드 분리로 인해 변환처리, '10' : 리스 */
                   <if test="@MybatisUtils@equals(sellTpCd, '2')">
                   AND A.SELL_TP_DTL_CD IN ('21', '23')
                   </if>
                   <if test="@MybatisUtils@equals(sellTpCd, '10')">
                   AND A.SELL_TP_DTL_CD NOT IN ('21', '23')
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                   AND A.SELL_TP_DTL_CD = #{sellTpDtlCd}
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(sapPdDvCd) and !@MybatisUtils@equals(sapPdDvCd, 'ALL')">
                   AND A.SAP_PD_DV_CD = #{sapPdDvCd}
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                   AND A.CNTR_NO   = #{cntrNo}   /*계약번호*/
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                   AND A.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(sellInflwChnlDtlCd) and !@MybatisUtils@equals(sellInflwChnlDtlCd, 'ALL')">
                   AND B.SELL_INFLW_CHNL_DTL_CD = #{sellInflwChnlDtlCd}
                   </if>
                   <if test="@MybatisUtils@equals(sellTpCd, '2')">
                   AND NOT EXISTS ( SELECT /*+ UNNEST */ 1
                                      FROM TB_SSCT_CNTR_DTL AA
                                     INNER JOIN TB_PDBS_PD_CLSF_BAS BB -- 상품분류기본-소분류[AS-IS:KA1100P]
                                        ON BB.PD_CLSF_ID = AA.PD_LCLSF_ID -- 상품분류ID = 상품세분류ID
                                       AND BB.DTA_DL_YN = 'N'
                                       AND BB.USE_YN = 'Y'
                                       AND BB.REF_PD_CLSF_VAL = '05003002' -- [Cooking+커피머신+원두]
                                     WHERE AA.CNTR_NO = A.CNTR_NO
                                       AND AA.CNTR_SN = A.CNTR_SN )
                   </if>
                   AND A.RVE_DV_CD NOT IN ('02', '07') -- 02.연체가산금, 07.위약금
                   <if test="(@MybatisUtils@equals(sellTpDtlCd, 'ALL') and @MybatisUtils@equals(sellTpCd, '6')) or (@MybatisUtils@equals(sellTpDtlCd, '63') and @MybatisUtils@equals(sellTpCd, '6'))">
                 UNION ALL
                SELECT SUBSTR(A.PERF_DT,1,6) AS SL_CL_YM -- 실적년월
                     , A.PERF_DT AS PERF_DT -- 실적일자
                     , A.SELL_TP_CD AS SELL_TP_CD -- 판매유형코드
                     , A.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세코드
                     , A.SAP_PD_DV_CD AS SAP_PD_DV_CD -- SAP상품구분코드
                     , A.DP_DV_CD AS DP_DV_CD -- 입금구분
                     , A.RVE_DV_CD AS RVE_DV_CD -- 수납구분
                     , NVL(A.RVE_AMT,0) AS RVE_AMT
                  FROM TB_CBCL_BZNS_ATAM_BAS A
                  LEFT OUTER JOIN TB_SSCT_CNTR_BAS B -- 계약기본
                    ON A.CNTR_NO = B.CNTR_NO
                   AND B.DTA_DL_YN = 'N'
                 WHERE A.PERF_DT BETWEEN #{slClYm}||'01' AND TO_CHAR(LAST_DAY(TO_DATE(#{slClYm}, 'YYYYMM')), 'YYYYMMDD')
                   AND A.SELL_TP_CD = '2'
                   AND A.SELL_TP_DTL_CD IN ('21', '23')
                   AND EXISTS ( SELECT /*+ UNNEST */ 1
                                  FROM TB_SSCT_CNTR_DTL AA
                                 INNER JOIN TB_PDBS_PD_CLSF_BAS BB -- 상품분류기본-소분류[AS-IS:KA1100P]
                                    ON BB.PD_CLSF_ID = AA.PD_LCLSF_ID -- 상품분류ID = 상품세분류ID
                                   AND BB.DTA_DL_YN = 'N'
                                   AND BB.USE_YN = 'Y'
                                   AND BB.REF_PD_CLSF_VAL = '05003002' -- [Cooking+커피머신+원두]
                                 WHERE AA.CNTR_NO = A.CNTR_NO
                                   AND AA.CNTR_SN = A.CNTR_SN )
                   <if test="@MybatisUtils@isNotEmpty(sapPdDvCd) and !@MybatisUtils@equals(sapPdDvCd, 'ALL')">
                   AND A.SAP_PD_DV_CD = #{sapPdDvCd}
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                   AND A.CNTR_NO   = #{cntrNo}   /*계약번호*/
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                   AND A.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                   </if>
                   <if test="@MybatisUtils@isNotEmpty(sellInflwChnlDtlCd) and !@MybatisUtils@equals(sellInflwChnlDtlCd, 'ALL')">
                   AND B.SELL_INFLW_CHNL_DTL_CD = #{sellInflwChnlDtlCd}
                   </if>
                   AND A.RVE_DV_CD NOT IN ('02', '07') -- 02.연체가산금, 07.위약금
                </if>
            )
            GROUP BY SL_CL_YM, PERF_DT, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD, DP_DV_CD, RVE_DV_CD
            ORDER BY SL_CL_YM, PERF_DT, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD, DP_DV_CD, RVE_DV_CD
        ), W3 AS
        (
        	<if test="@MybatisUtils@equals(sellTpCd, '1')">
	        	<include refid="sqlAnticipationSinglePayments" />
	        </if>
	        <if test="@MybatisUtils@equals(sellTpCd, '3')">
	        	<include refid="sqlAnticipationMemberships" />
	        </if>
	        <if test="@MybatisUtils@equals(sellTpCd, '6')">
	        	<include refid="sqlAnticipationRegularShippings" />
	        </if>
	        <if test="@MybatisUtils@equals(sellTpCd, '2')">
	        	<include refid="sqlAnticipationRentals" />
	        </if>
	        <if test="@MybatisUtils@equals(sellTpCd, '10')">
	        	<include refid="sqlAnticipationLeases" />
	        </if>
        )
        /*--------------------------------------------------------------*/
        /* 1일자 조회 */
        /*--------------------------------------------------------------*/
        SELECT TO_CHAR(TO_DATE(#{slClYm}, 'YYYYMM'), 'YYYY-MM') AS SL_CL_YM
             , TO_CHAR(TO_DATE(#{slClYm}||'01', 'YYYYMMDD'), 'YYYY-MM-DD') AS SL_CL_DT
	         , W3.SELL_TP_CD AS SELL_TP_CD
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = W3.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
             , W3.SELL_TP_DTL_CD AS SELL_TP_DTL_CD
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_DTL_CD' AND CD_VLD_VAL = W3.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
             , W3.SAP_PD_DV_CD AS SAP_PD_DV_CD
             , (SELECT MAX(SAP_PD_ATC_NM)
                FROM TB_CBCL_SAP_PD_DV_CD
                WHERE SAP_BZ_TERY_CD = '1210' -- SAP_BZ_TERY_CD : WELLS면 1210, EDU면 1110
                  AND SAP_PD_ATC_CD = '00'
                  AND SAP_PD_DV_CD = W3.SAP_PD_DV_CD) AS SAP_PD_ATC_NM -- SAP상품코드명
             , BTD_ATAM AS BTD_ATAM -- 전기이월
             , NVL((SELECT SUM(RVE_AMT) FROM W2
                    WHERE PERF_DT = #{slClYm}||'01'
                      AND SELL_TP_CD = W3.SELL_TP_CD
                      AND SELL_TP_DTL_CD = W3.SELL_TP_DTL_CD
                      AND SAP_PD_DV_CD = W3.SAP_PD_DV_CD
                      AND DP_DV_CD IN ('1', '3')), 0) AS ATAM_DP_AMT -- 선수입금
             , NVL((SELECT SUM(RVE_AMT) FROM W2
                    WHERE PERF_DT = #{slClYm}||'01'
                      AND SELL_TP_CD = W3.SELL_TP_CD
                      AND SELL_TP_DTL_CD = W3.SELL_TP_DTL_CD
                      AND SAP_PD_DV_CD = W3.SAP_PD_DV_CD
                      AND DP_DV_CD IN ('2', '4')), 0) AS THM_ATAM_RFND_AMT -- 선수환불
             , NVL((SELECT SUM(CASE WHEN DP_DV_CD IN ('1', '3') THEN RVE_AMT ELSE RVE_AMT*-1 END) FROM W2
                    WHERE PERF_DT = #{slClYm}||'01'
                      AND SELL_TP_CD = W3.SELL_TP_CD
                      AND SELL_TP_DTL_CD = W3.SELL_TP_DTL_CD
                      AND SAP_PD_DV_CD = W3.SAP_PD_DV_CD), 0) AS DP_TOT_AMT -- 입금합계
             , 0 AS SL_BND_ALRPY_AMT -- 매출대사(일자별로는 미조회)
             , 0 AS BOR_AMT -- 위약금(일자별로는 미조회)
             , 0 AS ADJ_AMT -- 조정금액
             , 0 AS ETC_PROFIT -- 잡이익
             , 0 AS EOT_ATAM -- 기말 영업선수금
	      FROM W3
        UNION ALL
        /*--------------------------------------------------------------*/
        /* 일자별 조회 */
        /*--------------------------------------------------------------*/
        SELECT TO_CHAR(TO_DATE(W1.SL_CL_YM, 'YYYYMM'), 'YYYY-MM') AS SL_CL_YM
             , TO_CHAR(TO_DATE(W1.SL_CL_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS SL_CL_DT
             , T2.SELL_TP_CD AS SELL_TP_CD
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = T2.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
             , T2.SELL_TP_DTL_CD AS SELL_TP_DTL_CD
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_DTL_CD' AND CD_VLD_VAL = T2.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
             , T2.SAP_PD_DV_CD AS SAP_PD_DV_CD
             , (SELECT MAX(SAP_PD_ATC_NM)
                FROM TB_CBCL_SAP_PD_DV_CD
                WHERE SAP_BZ_TERY_CD = '1210' -- SAP_BZ_TERY_CD : WELLS면 1210, EDU면 1110
                  AND SAP_PD_ATC_CD = '00'
                  AND SAP_PD_DV_CD = T2.SAP_PD_DV_CD) AS SAP_PD_ATC_NM -- SAP상품코드명
             , 0 AS BTD_ATAM -- 전기이월
             , NVL((SELECT SUM(RVE_AMT) FROM W2
                    WHERE PERF_DT = W1.SL_CL_DT
                      AND SELL_TP_CD = T2.SELL_TP_CD
                      AND SELL_TP_DTL_CD = T2.SELL_TP_DTL_CD
                      AND SAP_PD_DV_CD = T2.SAP_PD_DV_CD
                      AND DP_DV_CD IN ('1', '3')), 0) AS ATAM_DP_AMT -- 선수입금
             , NVL((SELECT SUM(RVE_AMT) FROM W2
                    WHERE PERF_DT = W1.SL_CL_DT
                      AND SELL_TP_CD = T2.SELL_TP_CD
                      AND SELL_TP_DTL_CD = T2.SELL_TP_DTL_CD
                      AND SAP_PD_DV_CD = T2.SAP_PD_DV_CD
                      AND DP_DV_CD IN ('2', '4')), 0) AS THM_ATAM_RFND_AMT -- 선수환불
             , NVL((SELECT SUM(CASE WHEN DP_DV_CD IN ('1', '3') THEN RVE_AMT ELSE RVE_AMT*-1 END) FROM W2
                    WHERE PERF_DT = W1.SL_CL_DT
                      AND SELL_TP_CD = T2.SELL_TP_CD
                      AND SELL_TP_DTL_CD = T2.SELL_TP_DTL_CD
                      AND SAP_PD_DV_CD = T2.SAP_PD_DV_CD), 0) AS DP_TOT_AMT -- 입금합계
             , 0 AS SL_BND_ALRPY_AMT -- 매출대사(일자별로는 미조회)
             , 0 AS BOR_AMT -- 위약금(일자별로는 미조회)
             , 0 AS ADJ_AMT -- 조정금액
             , 0 AS ETC_PROFIT -- 잡이익
             , 0 AS EOT_ATAM -- 기말 영업선수금
          FROM W1
          LEFT OUTER JOIN (SELECT PERF_DT -- 실적일자
                                , SELL_TP_CD -- 판매유형코드
                                , SELL_TP_DTL_CD -- 판매유형상세코드
                                , SAP_PD_DV_CD -- SAP상품구분코드
                             FROM W2
                            WHERE 1=1
                            GROUP BY PERF_DT, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD) T2
            ON T2.PERF_DT = W1.SL_CL_DT
        UNION ALL
		    /*--------------------------------------------------------------*/
        /* 마지막일자 조회(전일자) */
        /*--------------------------------------------------------------*/
        SELECT TO_CHAR(TO_DATE(#{slClYm}, 'YYYYMM'), 'YYYY-MM') AS SL_CL_YM
             , (SELECT TO_CHAR(TO_DATE(SL_CL_DT, 'YYYYMMDD')+1, 'YYYY-MM-DD') FROM W1 WHERE RANK_NUM = 1) AS SL_CL_DT
	           , W3.SELL_TP_CD AS SELL_TP_CD
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = W3.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
             , W3.SELL_TP_DTL_CD AS SELL_TP_DTL_CD
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_DTL_CD' AND CD_VLD_VAL = W3.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
             , W3.SAP_PD_DV_CD AS SAP_PD_DV_CD
             , (SELECT MAX(SAP_PD_ATC_NM)
                FROM TB_CBCL_SAP_PD_DV_CD
                WHERE SAP_BZ_TERY_CD = '1210' -- SAP_BZ_TERY_CD : WELLS면 1210, EDU면 1110
                  AND SAP_PD_ATC_CD = '00'
                  AND SAP_PD_DV_CD = W3.SAP_PD_DV_CD) AS SAP_PD_ATC_NM -- SAP상품코드명
             , 0 AS BTD_ATAM -- 전기이월
             , NVL((SELECT SUM(RVE_AMT) FROM W2
                    WHERE PERF_DT = (SELECT TO_CHAR(TO_DATE(SL_CL_DT, 'YYYYMMDD')+1, 'YYYYMMDD') FROM W1 WHERE RANK_NUM = 1)
                      AND SELL_TP_CD = W3.SELL_TP_CD
                      AND SELL_TP_DTL_CD = W3.SELL_TP_DTL_CD
                      AND SAP_PD_DV_CD = W3.SAP_PD_DV_CD
                      AND DP_DV_CD IN ('1', '3')), 0) AS ATAM_DP_AMT -- 선수입금
             , NVL((SELECT SUM(RVE_AMT) FROM W2
                    WHERE PERF_DT = (SELECT TO_CHAR(TO_DATE(SL_CL_DT, 'YYYYMMDD')+1, 'YYYYMMDD') FROM W1 WHERE RANK_NUM = 1)
                      AND SELL_TP_CD = W3.SELL_TP_CD
                      AND SELL_TP_DTL_CD = W3.SELL_TP_DTL_CD
                      AND SAP_PD_DV_CD = W3.SAP_PD_DV_CD
                      AND DP_DV_CD IN ('2', '4')), 0) AS THM_ATAM_RFND_AMT -- 선수환불
             , NVL((SELECT SUM(CASE WHEN DP_DV_CD IN ('1', '3') THEN RVE_AMT ELSE RVE_AMT*-1 END) FROM W2
                    WHERE PERF_DT = (SELECT TO_CHAR(TO_DATE(SL_CL_DT, 'YYYYMMDD')+1, 'YYYYMMDD') FROM W1 WHERE RANK_NUM = 1)
                      AND SELL_TP_CD = W3.SELL_TP_CD
                      AND SELL_TP_DTL_CD = W3.SELL_TP_DTL_CD
                      AND SAP_PD_DV_CD = W3.SAP_PD_DV_CD), 0) AS DP_TOT_AMT -- 입금합계
             , W3.SL_BND_ALRPY_AMT AS SL_BND_ALRPY_AMT -- 매출대사(일자별로는 미조회)
             , W3.BOR_AMT AS BOR_AMT -- 위약금(일자별로는 미조회)
             , W3.ADJ_AMT AS ADJ_AMT -- 조정금액
             , W3.ETC_PROFIT AS ETC_PROFIT -- 잡이익
             , W3.EOT_ATAM AS EOT_ATAM -- 기말 영업선수금
	      FROM W3
         ORDER BY SL_CL_DT, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
    </select>

    <sql id="sqlAnticipationSinglePayments">
        -- 1.1 일시불 일자별외
        SELECT <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">
               SUBSTR(T2.SL_CL_YM,1,4) || '-' || SUBSTR(T2.SL_CL_YM,5,2) || (
                   CASE WHEN SUM(T2.EOT_ATAM) != SUM(T2.BTD_ATAM + T2.DP_TOT_AMT - T2.SL_BND_ALRPY_AMT - T2.BOR_AMT + T2.ADJ_AMT - T2.ETC_PROFIT)  THEN ' *'
                        ELSE ''
                   END) AS SL_CL_YM -- 실적년월
             </if>
             <if test="@MybatisUtils@equals(agrgDv, '3') or @MybatisUtils@equals(agrgDv, '4')">
               SUBSTR(T2.SL_CL_YM,1,4) || '-' || SUBSTR(T2.SL_CL_YM,5,2) || (CASE WHEN T2.ERR_YN = 'Y' THEN ' *' ELSE '' END) AS SL_CL_YM -- 실적년월
             </if>
             , T2.SELL_TP_CD -- 판매유형코드
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = T2.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
             , T2.SELL_TP_DTL_CD -- 판매유형상세코드
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_DTL_CD' AND CD_VLD_VAL = T2.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
             , T2.SAP_PD_DV_CD AS SAP_PD_DV_CD
             , (SELECT MAX(SAP_PD_ATC_NM)
                FROM TB_CBCL_SAP_PD_DV_CD
                WHERE SAP_BZ_TERY_CD = '1210' -- SAP_BZ_TERY_CD : WELLS면 1210, EDU면 1110
                  AND SAP_PD_ATC_CD = '00'
                  AND SAP_PD_DV_CD = T2.SAP_PD_DV_CD) AS SAP_PD_ATC_NM -- SAP상품코드명
             <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">
             , '' AS CST_NO -- 고객번호
             , '' AS CST_KNM -- 고객명
             , '' AS PD_CD-- 상품코드
             , '' AS PD_NM -- 상품명
             , '' AS CNTR_NO
             , SUM(BTD_ATAM) AS BTD_ATAM-- 전기이월
             , SUM(ATAM_DP_AMT) AS ATAM_DP_AMT -- 선수입금(계약금+할부금+기타선수금)
             , SUM(CNTRAM_DP_AMT) AS ATAM_DP_AMT_1
             , SUM(THM_INTAM_DP_AMT) AS ATAM_DP_AMT_2
             , SUM(THM_ATAM_DP_AMT) AS ATAM_DP_AMT_3
             , SUM(THM_ATAM_RFND_AMT) AS THM_ATAM_RFND_AMT -- 선수환불액
             , SUM(DP_TOT_AMT) AS DP_TOT_AMT -- 입금합계
             , SUM(SL_BND_ALRPY_AMT) AS SL_BND_ALRPY_AMT -- 매출합계
             , SUM(CNTRAM_DP_AMT) AS SL_BND_ALRPY_AMT_1 -- 매출_계약금
             , SUM(THM_INTAM_DP_AMT) AS SL_BND_ALRPY_AMT_2 -- 매출_할부금
             , SUM(EOT_ATAM) AS EOT_ATAM -- 기말 영업선수금
             , SUM(BOR_AMT) AS BOR_AMT -- 위약금
             , SUM(ADJ_AMT) AS ADJ_AMT -- 조정금액
             , SUM(ETC_PROFIT) AS ETC_PROFIT -- 잡이익
             </if>
             <if test="@MybatisUtils@equals(agrgDv, '3') or @MybatisUtils@equals(agrgDv, '4')">
             , T2.CST_NO AS CST_NO -- 고객번호
             , (SELECT CST_KNM FROM TB_CUBS_CST_BAS WHERE CST_NO = T2.CST_NO AND DTA_DL_YN = 'N') AS CST_KNM -- 고객명
             , T2.PD_CD AS PD_CD-- 상품코드
             , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE PD_CD = T2.PD_CD) AS PD_NM -- 상품명
             , T2.CNTR_NO || '-' || T2.CNTR_SN AS CNTR_NO
             , BTD_ATAM AS BTD_ATAM-- 전기이월
             , ATAM_DP_AMT AS ATAM_DP_AMT -- 선수입금(계약금+할부금+기타선수금)
             , CNTRAM_DP_AMT AS ATAM_DP_AMT_1
             , THM_INTAM_DP_AMT AS ATAM_DP_AMT_2
             , THM_ATAM_DP_AMT AS ATAM_DP_AMT_3
             , THM_ATAM_RFND_AMT AS THM_ATAM_RFND_AMT -- 선수환불액
             , DP_TOT_AMT AS DP_TOT_AMT -- 입금합계
             , SL_BND_ALRPY_AMT AS SL_BND_ALRPY_AMT -- 매출합계
             , CNTRAM_DP_AMT AS SL_BND_ALRPY_AMT_1 -- 매출_계약금
             , THM_INTAM_DP_AMT AS SL_BND_ALRPY_AMT_2 -- 매출_할부금
             , EOT_ATAM AS EOT_ATAM -- 기말 영업선수금
             , BOR_AMT AS BOR_AMT -- 위약금
             , ADJ_AMT AS ADJ_AMT -- 조정금액
             , ETC_PROFIT AS ETC_PROFIT -- 잡이익
             </if>
          FROM (
                SELECT T1.*
                     , CASE WHEN T1.EOT_ATAM != T1.BTD_ATAM + T1.DP_TOT_AMT - T1.SL_BND_ALRPY_AMT - T1.BOR_AMT + T1.ADJ_AMT - T1.ETC_PROFIT THEN 'Y'
                       ELSE 'N' END AS ERR_YN
                  FROM (
                        SELECT A.SL_CL_YM AS SL_CL_YM -- 실적년월
                             , A.SELL_TP_CD AS SELL_TP_CD -- 판매유형코드
                             , A.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세코드
                             , A.CNTR_NO AS CNTR_NO -- 계약번호
                             , A.CNTR_SN AS CNTR_SN -- 계약일련번호
                             , A.SAP_PD_DV_CD AS SAP_PD_DV_CD -- SAP상품구분코드
                             , A.CST_NO AS CST_NO -- 고객번호
                             , A.PD_CD AS PD_CD -- 상품코드
                             , NVL(A.BTD_ATAM, 0) AS BTD_ATAM -- 전기이월 CW4900P.CWWA24
                      	     , NVL(A.THM_ATAM_DP_AMT, 0) AS THM_ATAM_DP_AMT -- 기타선수입금 CW4900P.CWWA22
                      	     , NVL(A.THM_ATAM_RFND_AMT, 0) AS THM_ATAM_RFND_AMT -- 기타선수환불 CW4900P.CWWA23
                      	     , NVL(A.EOT_ATAM, 0) AS EOT_ATAM -- 기말 기타선수잔액 CW4900P.CWWA24
                      	     , NVL(A.CNTRAM_DP_AMT, 0) AS CNTRAM_DP_AMT -- 계약금입금 CW4900P.CWWA16
                      	     , NVL(A.THM_INTAM_DP_AMT, 0) AS THM_INTAM_DP_AMT -- 할부금입금 CW4900P.CWWA18
                      	     , NVL(A.CNTRAM_DP_AMT, 0) + NVL(A.THM_INTAM_DP_AMT, 0) + NVL(A.THM_ATAM_DP_AMT, 0) AS ATAM_DP_AMT -- 선수입금(계약금+할부금+기타선수금)
                      	     , NVL(A.CNTRAM_DP_AMT, 0) + NVL(A.THM_INTAM_DP_AMT, 0) + NVL(A.THM_ATAM_DP_AMT, 0) - NVL(A.THM_ATAM_RFND_AMT, 0) AS DP_TOT_AMT -- 입금합계
                      	     , NVL(A.CNTRAM_DP_AMT, 0) + NVL(A.THM_INTAM_DP_AMT, 0) AS SL_BND_ALRPY_AMT -- 매출합계
                      	     -------------------------------------------
                      	     --TOBE 추가영역
                      	     -------------------------------------------
                      		   , 0 AS BOR_AMT -- 위약금
                      	   	 , 0 AS ADJ_AMT -- 조정금액
                      		   , 0 AS ETC_PROFIT -- 잡이익
                          FROM TB_CBCL_WELLS_SL_MM_CL_IZ A
                          LEFT OUTER JOIN TB_SSCT_CNTR_BAS B -- 계약기본
                            ON A.CNTR_NO = B.CNTR_NO
                           AND B.DTA_DL_YN = 'N'
                          LEFT OUTER JOIN TB_CBCL_DLQ_BAS C -- 연체기본
                            ON C.PERF_YM = A.SL_CL_YM
                           AND C.CNTR_NO = A.CNTR_NO
                           AND C.CNTR_SN = A.CNTR_SN
                           AND C.DTA_DL_YN = 'N'
                         WHERE 1=1
                           AND A.SL_CL_YM = #{slClYm}
                           AND A.SELL_TP_CD = '1'
                           <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                           AND A.SELL_TP_DTL_CD = #{sellTpDtlCd}
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(sapPdDvCd) and !@MybatisUtils@equals(sapPdDvCd, 'ALL')">
                           AND A.SAP_PD_DV_CD = #{sapPdDvCd}
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                           AND A.CNTR_NO   = #{cntrNo}   /*계약번호*/
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                           AND A.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(sellInflwChnlDtlCd) and !@MybatisUtils@equals(sellInflwChnlDtlCd, 'ALL')">
                           AND B.SELL_INFLW_CHNL_DTL_CD = #{sellInflwChnlDtlCd}
                           </if>
                       ) T1
               ) T2
        <if test="@MybatisUtils@equals(agrgDv, '4')"> -- 가로계산식 틀린 회원
        WHERE T2.ERR_YN = 'Y'
        </if>
        <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">  -- 집계, 일자
        GROUP BY SL_CL_YM, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
        ORDER BY SL_CL_YM DESC, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
        </if>
    </sql>

    <select id="selectAnticipationSinglePayments" resultType="com.kyowon.sms.wells.web.closing.performance.dto.WdccOverduePenaltyDto$SearchOrderRes">
        <include refid="sqlAnticipationSinglePayments"></include>
    </select>

    <sql id="sqlAnticipationMemberships">
        -- 멤버십 일자별외
        SELECT
             <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">
               SUBSTR(T2.SL_CL_YM,1,4) || '-' || SUBSTR(T2.SL_CL_YM,5,2) || (
                   CASE WHEN SUM(T2.EOT_ATAM) != SUM(T2.BTD_ATAM + T2.DP_TOT_AMT - T2.SL_BND_ALRPY_AMT - T2.BOR_AMT + T2.ADJ_AMT - T2.ETC_PROFIT)  THEN ' *'
                        ELSE ''
                   END) AS SL_CL_YM -- 실적년월
             </if>
             <if test="@MybatisUtils@equals(agrgDv, '3') or @MybatisUtils@equals(agrgDv, '4')">
               SUBSTR(T2.SL_CL_YM,1,4) || '-' || SUBSTR(T2.SL_CL_YM,5,2) || (CASE WHEN T2.ERR_YN = 'Y' THEN ' *' ELSE '' END) AS SL_CL_YM -- 실적년월
             </if>
             , T2.SELL_TP_CD -- 판매유형코드
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = T2.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
             , T2.SELL_TP_DTL_CD -- 판매유형상세코드
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_DTL_CD' AND CD_VLD_VAL = T2.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
             , T2.SAP_PD_DV_CD AS SAP_PD_DV_CD
             , (SELECT MAX(SAP_PD_ATC_NM)
                  FROM TB_CBCL_SAP_PD_DV_CD
                 WHERE SAP_BZ_TERY_CD = '1210' -- SAP_BZ_TERY_CD : WELLS면 1210, EDU면 1110
                   AND SAP_PD_ATC_CD = '00'
                   AND SAP_PD_DV_CD = T2.SAP_PD_DV_CD) AS SAP_PD_ATC_NM -- SAP상품코드명
             <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">
             , '' AS CST_NO -- 고객번호
             , '' AS CST_KNM -- 고객명
             , '' AS PD_CD -- 상품코드
             , '' AS PD_NM -- 상품명
             , '' AS CNTR_NO
             , SUM(T2.BTD_ATAM) AS BTD_ATAM -- 전기이월
             , SUM(T2.ATAM_DP_AMT) AS ATAM_DP_AMT -- 선수입금합계 LCAM32 - LCAM83
             , SUM(T2.THM_ATAM_RFND_AMT) AS THM_ATAM_RFND_AMT -- 선수환불 LCAM33
             , SUM(T2.DP_TOT_AMT) AS DP_TOT_AMT -- 입금합계 LCAM32 - LCAM83 - LCAM33
             , SUM(T2.SL_BND_ALRPY_AMT) AS SL_BND_ALRPY_AMT -- 매출합계
             , SUM(T2.EOT_ATAM) AS EOT_ATAM -- 기말 영업선수금
             , SUM(T2.BOR_AMT) AS BOR_AMT -- 위약금
             , SUM(T2.ADJ_AMT) AS ADJ_AMT -- 조정금액
             , SUM(T2.ETC_PROFIT) AS ETC_PROFIT -- 잡이익
             </if>
             <if test="@MybatisUtils@equals(agrgDv, '3') or @MybatisUtils@equals(agrgDv, '4')">
             , T2.CST_NO AS CST_NO -- 고객번호
             , (SELECT CST_KNM FROM TB_CUBS_CST_BAS WHERE CST_NO = T2.CST_NO AND DTA_DL_YN = 'N') AS CST_KNM -- 고객명
             , T2.PD_CD AS PD_CD -- 상품코드
             , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE PD_CD = T2.PD_CD) AS PD_NM -- 상품명
             , T2.CNTR_NO || '-' || T2.CNTR_SN AS CNTR_NO
             , T2.BTD_ATAM AS BTD_ATAM -- 전기이월
             , T2.ATAM_DP_AMT AS ATAM_DP_AMT -- 선수입금합계 LCAM32 - LCAM83
             , T2.THM_ATAM_RFND_AMT AS THM_ATAM_RFND_AMT -- 선수환불 LCAM33
             , T2.DP_TOT_AMT AS DP_TOT_AMT -- 입금합계 LCAM32 - LCAM83 - LCAM33
             , T2.SL_BND_ALRPY_AMT AS SL_BND_ALRPY_AMT -- 매출합계
             , T2.EOT_ATAM AS EOT_ATAM -- 기말 영업선수금
             , T2.BOR_AMT AS BOR_AMT -- 위약금
             , T2.ADJ_AMT AS ADJ_AMT -- 조정금액
             , T2.ETC_PROFIT AS ETC_PROFIT -- 잡이익
             </if>
            FROM
            (
                SELECT T1.*
                     , CASE WHEN T1.EOT_ATAM != T1.BTD_ATAM + T1.DP_TOT_AMT - T1.SL_BND_ALRPY_AMT - T1.BOR_AMT + T1.ADJ_AMT - T1.ETC_PROFIT THEN 'Y'
                            ELSE 'N' END AS ERR_YN
                  FROM (
                            SELECT A.SL_CL_YM AS SL_CL_YM -- 실적년월
                                 , A.SELL_TP_CD AS SELL_TP_CD -- 판매유형코드
                                 , A.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세코드
                                 , A.CNTR_NO AS CNTR_NO -- 계약번호
                                 , A.CNTR_SN AS CNTR_SN -- 계약일련번호
                                 , A.SAP_PD_DV_CD AS SAP_PD_DV_CD -- SAP상품구분코드
                                 , A.CST_NO AS CST_NO -- 고객번호
                                 , A.PD_CD AS PD_CD -- 상품코드
                                 -------------------------------------------------
                                 -- 전기이월
                                 -------------------------------------------------
                                 , NVL(A.BTD_ATAM, 0) + NVL(A.PRM_BLAM_BTD_AMT, 0) AS BTD_ATAM -- 전기이월
                                 , NVL(A.BTD_ATAM, 0) AS BTD_ATAM_1 -- 선수기초 LCAM31
                                 , NVL(A.PRM_BLAM_BTD_AMT, 0) AS BTD_ATAM_2 -- 선납잔액 LCAM21
                                 -------------------------------------------------
                                 -- 선수입금
                                 -------------------------------------------------
                                 , NVL(A.THM_ATAM_DP_AMT, 0) - (CASE WHEN A.SL_CL_YM <![CDATA[<]]> '201605' THEN 0
                                                                 ELSE NVL(C.THM_DLQ_ADD_DP_SUM_AMT, 0) - NVL(C.THM_DLQ_ADD_RFND_SUM_AMT, 0) -- 가산금 입금-환불
                                                            END) AS ATAM_DP_AMT -- 선수입금 LCAM32 - LCAM83
                                 , NVL(A.THM_ATAM_DP_AMT, 0) AS THM_ATAM_DP_AMT -- 선수입금
                                 , (CASE WHEN A.SL_CL_YM <![CDATA[<]]> '201605' THEN 0
                                             ELSE NVL(C.THM_DLQ_ADD_DP_SUM_AMT, 0) - NVL(C.THM_DLQ_ADD_RFND_SUM_AMT, 0) -- 가산금 입금-환불
                                        END) AS THM_DLQ_ADD_DP_SUM_AMT -- 가산금입금
                                 , NVL(A.THM_ATAM_RFND_AMT, 0) AS THM_ATAM_RFND_AMT -- 선수환불 LCAM33
                                 , NVL(A.THM_ATAM_DP_AMT, 0) - NVL(A.THM_ATAM_RFND_AMT, 0) - (CASE WHEN A.SL_CL_YM <![CDATA[<]]> '201605' THEN 0
                                                          ELSE NVL(C.THM_DLQ_ADD_DP_SUM_AMT, 0) - NVL(C.THM_DLQ_ADD_RFND_SUM_AMT, 0) -- 가산금 입금-환불
                                                     END) AS DP_TOT_AMT-- 입금합계
                                 -------------------------------------------------
                                 -- 매출
                                 -------------------------------------------------
                                 , NVL(A.SL_BND_ALRPY_AMT, 0) AS SL_BND_ALRPY_AMT -- 매출합계 (LCAM38 - LCAM53) 였으나 TOBE LCAM53은 위약금으로 관리
                                 -------------------------------------------------
                                 -- 기말선수
                                 -------------------------------------------------
                                 , NVL(A.EOT_ATAM, 0) AS EOT_ATAM -- 기말 LCAM36
                                 -------------------------------------------
                                 --TOBE 추가영역
                                 -------------------------------------------
                                 , NVL(D.DP_CCAM_SUM_AMT, 0) AS BOR_AMT -- LCAM63 위약금(필터공제가 TOBE에서 위약금으로 관리)
                                 , 0 AS ADJ_AMT -- 조정금액
                                 , NVL((SELECT SUM(NVL(T1.BZNS_ATAM_BLAM, 0))
      			                              FROM TB_CBCL_BZNS_ATAM_PROCS_IZ  T1
      			                             WHERE T1.CNTR_NO = A.CNTR_NO
      			                               AND T1.CNTR_SN = A.CNTR_SN
      			                               AND T1.PTYPF_OJ_CD = '9' -- 잡이익 처리완료
      			                               AND T1.PTYPF_PRCSDT BETWEEN A.SL_CL_YM||'01' AND TO_CHAR(LAST_DAY(TO_DATE(A.SL_CL_YM,'YYYYMM')),'YYYYMMDD')), 0) AS ETC_PROFIT-- 잡이익
                              FROM TB_CBCL_WELLS_SL_MM_CL_IZ A
                              LEFT OUTER JOIN TB_SSCT_CNTR_BAS B -- 계약기본
                                ON A.CNTR_NO = B.CNTR_NO
                               AND B.DTA_DL_YN = 'N'
                              LEFT OUTER JOIN TB_CBCL_DLQ_BAS C -- 연체기본
                                ON C.PERF_YM = A.SL_CL_YM
                               AND C.CNTR_NO = A.CNTR_NO
                               AND C.CNTR_SN = A.CNTR_SN
                               AND C.DTA_DL_YN = 'N'
                              LEFT OUTER JOIN TB_CBCL_WELLS_BOR_AMT_BAS D -- 위약기본
                          	    ON D.PERF_YM = A.SL_CL_YM
                          		 AND D.CNTR_NO = A.CNTR_NO
                          		 AND D.CNTR_SN = A.CNTR_SN
                          		 AND D.DTA_DL_YN = 'N'
                             WHERE 1=1
                               AND A.SL_CL_YM = #{slClYm}
                               AND A.SELL_TP_CD = '3'
                               <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                               AND A.SELL_TP_DTL_CD = #{sellTpDtlCd}
                               </if>
                               <if test="@MybatisUtils@isNotEmpty(sapPdDvCd) and !@MybatisUtils@equals(sapPdDvCd, 'ALL')">
                               AND A.SAP_PD_DV_CD = #{sapPdDvCd}
                               </if>
                               <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                               AND A.CNTR_NO   = #{cntrNo}   /*계약번호*/
                               </if>
                               <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                               AND A.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                               </if>
                               <if test="@MybatisUtils@isNotEmpty(sellInflwChnlDtlCd) and !@MybatisUtils@equals(sellInflwChnlDtlCd, 'ALL')">
                               AND B.SELL_INFLW_CHNL_DTL_CD = #{sellInflwChnlDtlCd}
                               </if>
                             ) T1
                  ) T2
            <if test="@MybatisUtils@equals(agrgDv, '4')">
            WHERE T2.ERR_YN = 'Y'
            </if>
            <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">  -- 집계, 일자
            GROUP BY SL_CL_YM, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
            ORDER BY SL_CL_YM, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
            </if>
    </sql>

    <select id="selectAnticipationMemberships" resultType="com.kyowon.sms.wells.web.closing.performance.dto.WdccOverduePenaltyDto$SearchOrderRes">
        <include refid="sqlAnticipationMemberships"></include>
    </select>

    <sql id="sqlAnticipationRegularShippings">
        SELECT
             <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">
               SUBSTR(T2.SL_CL_YM,1,4) || '-' || SUBSTR(T2.SL_CL_YM,5,2) || (
                   CASE WHEN SUM(T2.EOT_ATAM) != SUM(T2.BTD_ATAM
                                                   + T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_SUM_AMT - (T2.THM_ATAM_RFND_AMT - T2.THM_DLQ_ADD_RFND_SUM_AMT)
                                                   - T2.SL_BND_ALRPY_AMT
                                                   - T2.BOR_AMT
                                                   + T2.ADJ_AMT
                                                   - T2.ETC_PROFIT)  THEN ' *'
                        ELSE ''
                   END) AS SL_CL_YM -- 실적년월
             </if>
             <if test="@MybatisUtils@equals(agrgDv, '3') or @MybatisUtils@equals(agrgDv, '4')">
               SUBSTR(T2.SL_CL_YM,1,4) || '-' || SUBSTR(T2.SL_CL_YM,5,2) || (CASE WHEN T2.ERR_YN = 'Y' THEN ' *' ELSE '' END) AS SL_CL_YM -- 실적년월
             </if>
             , T2.SELL_TP_CD -- 판매유형코드
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = T2.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
             , T2.SELL_TP_DTL_CD -- 판매유형상세코드
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_DTL_CD' AND CD_VLD_VAL = T2.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
             , T2.SAP_PD_DV_CD AS SAP_PD_DV_CD
             , (SELECT MAX(SAP_PD_ATC_NM)
                FROM TB_CBCL_SAP_PD_DV_CD
                WHERE SAP_BZ_TERY_CD = '1210' -- SAP_BZ_TERY_CD : WELLS면 1210, EDU면 1110
                  AND SAP_PD_ATC_CD = '00'
                  AND SAP_PD_DV_CD = T2.SAP_PD_DV_CD) AS SAP_PD_ATC_NM -- SAP상품코드명
             <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">
             , '' AS CST_NO -- 고객번호
             , '' AS CST_KNM -- 고객명
             , '' AS PD_CD -- 상품코드
             , '' AS PD_NM -- 상품명
             , '' AS CNTR_NO
             , SUM(T2.BTD_ATAM) AS BTD_ATAM -- 전기이월
             , SUM(T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_SUM_AMT) AS ATAM_DP_AMT -- 선수입금합계
             , SUM(T2.THM_ATAM_DP_AMT) AS DP_AMT_1 -- 선수입금
             , SUM(T2.THM_DLQ_ADD_DP_SUM_AMT) AS DP_AMT_2 -- 가산금입금
             , SUM(T2.THM_ATAM_RFND_AMT - T2.THM_DLQ_ADD_RFND_SUM_AMT) AS THM_ATAM_RFND_AMT -- 선수환불
             , SUM(T2.THM_ATAM_RFND_AMT) AS RFND_AMT_1 -- 선수환불
             , SUM(T2.THM_DLQ_ADD_RFND_SUM_AMT) AS RFND_AMT_2 -- 가산금환불
             , SUM(T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_SUM_AMT - (T2.THM_ATAM_RFND_AMT - T2.THM_DLQ_ADD_RFND_SUM_AMT)) AS DP_TOT_AMT -- 입금합계
             , SUM(T2.SL_BND_ALRPY_AMT) AS SL_BND_ALRPY_AMT -- 매출대체
             , SUM(T2.EOT_ATAM) AS EOT_ATAM -- 기말 영업선수금
             , SUM(T2.BOR_AMT) AS BOR_AMT -- 위약대체
             , SUM(T2.ADJ_AMT) AS ADJ_AMT -- 조정금액
             , SUM(T2.ETC_PROFIT) AS ETC_PROFIT -- 잡이익
             </if>
             <if test="@MybatisUtils@equals(agrgDv, '3') or @MybatisUtils@equals(agrgDv, '4')">
             , T2.CST_NO AS CST_NO -- 고객번호
             , (SELECT CST_KNM FROM TB_CUBS_CST_BAS WHERE CST_NO = T2.CST_NO AND DTA_DL_YN = 'N') AS CST_KNM -- 고객명
             , T2.PD_CD AS PD_CD -- 상품코드
             , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE PD_CD = T2.PD_CD) AS PD_NM -- 상품명
             , T2.CNTR_NO || '-' || T2.CNTR_SN AS CNTR_NO
             , T2.BTD_ATAM AS BTD_ATAM -- 전기이월
             , T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_SUM_AMT AS ATAM_DP_AMT -- 선수입금합계
             , T2.THM_ATAM_DP_AMT AS DP_AMT_1 -- 선수입금
          	 , T2.THM_DLQ_ADD_DP_SUM_AMT AS DP_AMT_2 -- 가산금입금
             , T2.THM_ATAM_RFND_AMT - T2.THM_DLQ_ADD_RFND_SUM_AMT AS THM_ATAM_RFND_AMT -- 선수환불
             , T2.THM_ATAM_RFND_AMT AS RFND_AMT_1 -- 선수환불
          	 , T2.THM_DLQ_ADD_RFND_SUM_AMT AS RFND_AMT_2 -- 가산금환불
             , T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_SUM_AMT - (T2.THM_ATAM_RFND_AMT - T2.THM_DLQ_ADD_RFND_SUM_AMT) AS DP_TOT_AMT -- 입금합계
             , T2.SL_BND_ALRPY_AMT AS SL_BND_ALRPY_AMT -- 매출대체
             , T2.EOT_ATAM AS EOT_ATAM -- 기말 영업선수금
             , T2.BOR_AMT AS BOR_AMT -- 위약대체
             , T2.ADJ_AMT AS ADJ_AMT -- 조정금액
             , T2.ETC_PROFIT AS ETC_PROFIT -- 잡이익
             </if>
          FROM (
                SELECT T1.*
                     , CASE WHEN T1.EOT_ATAM != T1.BTD_ATAM
                                              + T1.THM_ATAM_DP_AMT - T1.THM_DLQ_ADD_DP_SUM_AMT - (T1.THM_ATAM_RFND_AMT - T1.THM_DLQ_ADD_RFND_SUM_AMT)
                                              - T1.SL_BND_ALRPY_AMT
                                              - T1.BOR_AMT
                                              + T1.ADJ_AMT
                                              - T1.ETC_PROFIT THEN 'Y'
                       ELSE 'N' END AS ERR_YN
                  FROM (
                         SELECT A.SL_CL_YM AS SL_CL_YM -- 실적년월
                              , A.SELL_TP_CD AS SELL_TP_CD -- 판매유형코드
                              , A.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세코드
                              , A.CNTR_NO AS CNTR_NO -- 계약번호
                              , A.CNTR_SN AS CNTR_SN -- 계약일련번호
                              , A.SAP_PD_DV_CD AS SAP_PD_DV_CD -- SAP상품구분코드
                              , A.CST_NO AS CST_NO -- 고객번호
                              , A.PD_CD AS PD_CD -- 상품코드
                              -------------------------------------------------
                              -- 전기이월
                              -------------------------------------------------
                              , NVL(A.BTD_ATAM, 0) AS BTD_ATAM -- 전기이월 LCAM31
                              -------------------------------------------------
                              -- 선수입금
                              -------------------------------------------------
                              , NVL(A.THM_ATAM_DP_AMT, 0) AS THM_ATAM_DP_AMT -- 선수입금 LCAM32
                              , NVL(C.THM_DLQ_ADD_DP_SUM_AMT, 0) AS THM_DLQ_ADD_DP_SUM_AMT -- 가산금입금 LCAM83
                              , NVL(A.THM_ATAM_RFND_AMT, 0) AS THM_ATAM_RFND_AMT -- 선수환불 LCAM33
                              , NVL(C.THM_DLQ_ADD_RFND_SUM_AMT, 0) AS THM_DLQ_ADD_RFND_SUM_AMT -- 가산금환불 LCAM83
                              -------------------------------------------------
                              -- 매출
                              -------------------------------------------------
                              , NVL(A.SL_BND_ALRPY_AMT, 0) AS SL_BND_ALRPY_AMT -- 매출대체 LCAM38
                              -------------------------------------------
                              -- 위약대체
                              -------------------------------------------
                              , NVL(D.DP_CCAM_SUM_AMT, 0) AS BOR_AMT -- 위약미수입금 LCA103
                              -------------------------------------------------
                              -- 기말선수
                              -------------------------------------------------
                              , NVL(A.EOT_ATAM, 0) AS EOT_ATAM -- 기말 LCAM36
                              -------------------------------------------
                              -- 잡이익
                              -------------------------------------------
                              , 0 AS ADJ_AMT -- 조정금액
                              , NVL((SELECT SUM(NVL(T1.BZNS_ATAM_BLAM, 0))
  			                               FROM TB_CBCL_BZNS_ATAM_PROCS_IZ  T1
  			                              WHERE T1.CNTR_NO = A.CNTR_NO
  			                                AND T1.CNTR_SN = A.CNTR_SN
  			                                AND T1.PTYPF_OJ_CD = '9' -- 잡이익 처리완료
  			                                AND T1.PTYPF_PRCSDT BETWEEN A.SL_CL_YM||'01' AND TO_CHAR(LAST_DAY(TO_DATE(A.SL_CL_YM,'YYYYMM')),'YYYYMMDD')), 0) AS ETC_PROFIT-- 잡이익
                           FROM TB_CBCL_WELLS_SL_MM_CL_IZ A
                           LEFT OUTER JOIN TB_SSCT_CNTR_BAS B -- 계약기본
                             ON A.CNTR_NO = B.CNTR_NO
                            AND B.DTA_DL_YN = 'N'
                           LEFT OUTER JOIN TB_CBCL_DLQ_BAS C -- 연체기본
                             ON C.PERF_YM = A.SL_CL_YM
                            AND C.CNTR_NO = A.CNTR_NO
                            AND C.CNTR_SN = A.CNTR_SN
                            AND C.DTA_DL_YN = 'N'
                           LEFT OUTER JOIN TB_CBCL_WELLS_BOR_AMT_BAS D -- 위약기본
                             ON D.PERF_YM = A.SL_CL_YM
                            AND D.CNTR_NO = A.CNTR_NO
                            AND D.CNTR_SN = A.CNTR_SN
                            AND D.DTA_DL_YN = 'N'
                          WHERE 1=1
                            AND A.SL_CL_YM = #{slClYm}
                            AND A.SELL_TP_CD = '6'
                            <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                            AND A.SELL_TP_DTL_CD = #{sellTpDtlCd}
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(sapPdDvCd) and !@MybatisUtils@equals(sapPdDvCd, 'ALL')">
                            AND A.SAP_PD_DV_CD = #{sapPdDvCd}
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                            AND A.CNTR_NO   = #{cntrNo}   /*계약번호*/
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                            AND A.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(sellInflwChnlDtlCd) and !@MybatisUtils@equals(sellInflwChnlDtlCd, 'ALL')">
                            AND B.SELL_INFLW_CHNL_DTL_CD = #{sellInflwChnlDtlCd}
                            </if>
                           <if test="(@MybatisUtils@equals(sellTpDtlCd, 'ALL') and @MybatisUtils@equals(sellTpCd, '6')) or (@MybatisUtils@equals(sellTpDtlCd, '63') and @MybatisUtils@equals(sellTpCd, '6'))">
                          UNION ALL
                         SELECT /*+ LEADING(F E A) use_nl(F E A) */
                                A.SL_CL_YM AS SL_CL_YM -- 실적년월
                              , A.SELL_TP_CD AS SELL_TP_CD -- 판매유형코드
                              , A.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세코드
                              , A.CNTR_NO AS CNTR_NO -- 계약번호
                              , A.CNTR_SN AS CNTR_SN -- 계약일련번호
                              , A.SAP_PD_DV_CD AS SAP_PD_DV_CD -- SAP상품구분코드
                              , A.CST_NO AS CST_NO -- 고객번호
                              , A.PD_CD AS PD_CD -- 상품코드
                              -------------------------------------------------
                              -- 전기이월
                              -------------------------------------------------
                              , NVL(A.BTD_ATAM, 0) + NVL(A.PRM_BLAM_BTD_AMT, 0) AS BTD_ATAM -- 전기이월 LCAM31(선수기초) + LCAM21(선납잔액)
                              -------------------------------------------------
                              -- 선수입금
                              -------------------------------------------------
                              , NVL(A.THM_ATAM_DP_AMT, 0) - (CASE WHEN A.SL_CL_YM <![CDATA[<]]> '201605' THEN 0
                                                                  ELSE NVL(C.THM_DLQ_ADD_DP_SUM_AMT, 0) - NVL(C.THM_DLQ_ADD_RFND_SUM_AMT, 0) -- 가산금 입금-환불
                                                             END) AS THM_ATAM_DP_AMT -- 선수입금 LCAM32
                              , 0 AS THM_DLQ_ADD_DP_SUM_AMT -- 가산금입금 LCAM83
                              , NVL(A.THM_ATAM_RFND_AMT, 0) AS THM_ATAM_RFND_AMT -- 선수환불 LCAM33
                              , 0 AS THM_DLQ_ADD_RFND_SUM_AMT -- UNION 처리용(미사용항목)
                              -------------------------------------------------
                              -- 매출
                              -------------------------------------------------
                              , NVL(A.SL_BND_ALRPY_AMT, 0) AS SL_BND_ALRPY_AMT -- 매출대체 LCAM38
                              -------------------------------------------
                              -- 위약대체
                              -------------------------------------------
                              , NVL(D.DP_CCAM_SUM_AMT, 0) AS BOR_AMT -- 위약미수입금 LCA103
                              -------------------------------------------------
                              -- 기말선수
                              -------------------------------------------------
                              , NVL(A.EOT_ATAM, 0) AS EOT_ATAM -- 기말 LCAM36
                              -------------------------------------------
                              -- 잡이익
                              -------------------------------------------
                              , 0 AS ADJ_AMT -- 조정금액
                              , NVL((SELECT SUM(NVL(T1.BZNS_ATAM_BLAM, 0))
			                                 FROM TB_CBCL_BZNS_ATAM_PROCS_IZ  T1
			                                WHERE T1.CNTR_NO = A.CNTR_NO
			                                  AND T1.CNTR_SN = A.CNTR_SN
			                                  AND T1.PTYPF_OJ_CD = '9' -- 잡이익 처리완료
			                                  AND T1.PTYPF_PRCSDT BETWEEN A.SL_CL_YM||'01' AND TO_CHAR(LAST_DAY(TO_DATE(A.SL_CL_YM,'YYYYMM')),'YYYYMMDD')), 0) AS ETC_PROFIT-- 잡이익
                           FROM TB_CBCL_WELLS_SL_MM_CL_IZ A
                          INNER JOIN TB_SSCT_CNTR_DTL E -- 계약상세
                             ON E.CNTR_NO = A.CNTR_NO
                            AND E.CNTR_SN = A.CNTR_SN
                            AND E.DTA_DL_YN = 'N'
                          INNER JOIN TB_PDBS_PD_CLSF_BAS F -- 상품분류기본
                             ON F.PD_CLSF_ID = E.PD_LCLSF_ID -- 상품분류ID = 상품세분류ID
                            AND F.DTA_DL_YN = 'N'
                            AND F.USE_YN = 'Y'
                            AND F.REF_PD_CLSF_VAL = '05003002' -- 원두
                           LEFT OUTER JOIN TB_CBCL_DLQ_BAS C -- 연체기본
                             ON C.PERF_YM = A.SL_CL_YM
                            AND C.CNTR_NO = A.CNTR_NO
                            AND C.CNTR_SN = A.CNTR_SN
                            AND C.DTA_DL_YN = 'N'
                           LEFT OUTER JOIN TB_CBCL_WELLS_BOR_AMT_BAS D -- 위약기본
                             ON D.PERF_YM = A.SL_CL_YM
                            AND D.CNTR_NO = A.CNTR_NO
                            AND D.CNTR_SN = A.CNTR_SN
                            AND D.DTA_DL_YN = 'N'
                          WHERE 1=1
                            AND A.SL_CL_YM = #{slClYm}
                            AND A.SELL_TP_CD = '2'
                            AND A.SELL_TP_DTL_CD IN ('21', '23')
                            ------------------------------------------------
                            -- 렌탈 원두상품때문에 판매유형상세는 조건절에서 제외
                            ------------------------------------------------
                            <if test="@MybatisUtils@isNotEmpty(sapPdDvCd) and !@MybatisUtils@equals(sapPdDvCd, 'ALL')">
                            AND A.SAP_PD_DV_CD = #{sapPdDvCd}
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                            AND A.CNTR_NO   = #{cntrNo}   /*계약번호*/
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                            AND A.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(sellInflwChnlDtlCd) and !@MybatisUtils@equals(sellInflwChnlDtlCd, 'ALL')">
                            AND B.SELL_INFLW_CHNL_DTL_CD = #{sellInflwChnlDtlCd}
                            </if>
                           </if>
                      ) T1
               ) T2
           WHERE 1=1
            <if test="@MybatisUtils@equals(agrgDv, '4')">
             AND T2.ERR_YN = 'Y'
            </if>
            <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">  -- 집계, 일자
            GROUP BY SL_CL_YM, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
            ORDER BY SL_CL_YM, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
            </if>
    </sql>

    <select id="selectAnticipationRegularShippings" resultType="com.kyowon.sms.wells.web.closing.performance.dto.WdccOverduePenaltyDto$SearchOrderRes">
        <include refid="sqlAnticipationRegularShippings"></include>
    </select>

    <sql id="sqlAnticipationRentals">
        -- 렌탈 일자별외
        SELECT
             <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">
               SUBSTR(T2.SL_CL_YM,1,4) || '-' || SUBSTR(T2.SL_CL_YM,5,2) || (
                   CASE WHEN SUM(T2.EOT_ATAM) != SUM(T2.BTD_ATAM
                                                   + T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_AMT - T2.THM_ATAM_RFND_AMT
                                                   - (T2.SL_BND_ALRPY_AMT_1 - T2.SL_BND_ALRPY_AMT_3 + T2.SL_BND_ALRPY_AMT_4 + T2.SL_BND_ALRPY_AMT_5 - T2.SL_BND_ALRPY_AMT_6)
                                                   - T2.BOR_AMT
                                                   + T2.ATAM_CV_AMT + T2.OVR_CTR_BOR_AMT
                                                   - T2.ETC_PROFIT) THEN ' *'
                        ELSE ''
                   END) AS SL_CL_YM -- 실적년월
             </if>
             <if test="@MybatisUtils@equals(agrgDv, '3') or @MybatisUtils@equals(agrgDv, '4')">
               SUBSTR(T2.SL_CL_YM,1,4) || '-' || SUBSTR(T2.SL_CL_YM,5,2) || (CASE WHEN T2.ERR_YN = 'Y' THEN ' *' ELSE '' END) AS SL_CL_YM -- 실적년월
             </if>
             , T2.SELL_TP_CD -- 판매유형코드
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = T2.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
             , T2.SELL_TP_DTL_CD -- 판매유형상세코드
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_DTL_CD' AND CD_VLD_VAL = T2.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
             , T2.SAP_PD_DV_CD AS SAP_PD_DV_CD
             , (SELECT MAX(SAP_PD_ATC_NM)
                FROM TB_CBCL_SAP_PD_DV_CD
                WHERE SAP_BZ_TERY_CD = '1210' -- SAP_BZ_TERY_CD : WELLS면 1210, EDU면 1110
                  AND SAP_PD_ATC_CD = '00'
                  AND SAP_PD_DV_CD = T2.SAP_PD_DV_CD) AS SAP_PD_ATC_NM -- SAP상품코드명
             <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">
             , '' AS CST_NO -- 고객번호
             , '' AS CST_KNM -- 고객명
             , '' AS PD_CD -- 상품코드
             , '' AS PD_NM -- 상품명
             , '' AS CNTR_NO
             , SUM(T2.BTD_ATAM) AS BTD_ATAM -- 전기이월
             , SUM(T2.BTD_ATAM_1) AS BTD_ATAM_1
             , SUM(T2.BTD_ATAM_2) AS BTD_ATAM_2
             , SUM(T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_AMT) AS ATAM_DP_AMT  -- 선수입금
             , SUM(T2.THM_ATAM_DP_AMT) AS ATAM_DP_AMT_1
             , SUM(T2.THM_DLQ_ADD_DP_AMT) AS ATAM_DP_AMT_2
             , SUM(T2.THM_ATAM_RFND_AMT) AS THM_ATAM_RFND_AMT  -- 선수환불
             , SUM(T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_AMT - T2.THM_ATAM_RFND_AMT) AS DP_TOT_AMT -- 입금합계
             , SUM(T2.SL_BND_ALRPY_AMT_1 - T2.SL_BND_ALRPY_AMT_3 + T2.SL_BND_ALRPY_AMT_4 + T2.SL_BND_ALRPY_AMT_5 - T2.SL_BND_ALRPY_AMT_6) AS SL_BND_ALRPY_AMT -- 매출합계
             , SUM(T2.SL_BND_ALRPY_AMT_1) AS SL_BND_ALRPY_AMT_1
             , SUM(T2.SL_BND_ALRPY_AMT_3) AS SL_BND_ALRPY_AMT_3
             , SUM(T2.SL_BND_ALRPY_AMT_4) AS SL_BND_ALRPY_AMT_4
             , SUM(T2.SL_BND_ALRPY_AMT_5) AS SL_BND_ALRPY_AMT_5
             , SUM(T2.SL_BND_ALRPY_AMT_6) AS SL_BND_ALRPY_AMT_6
             , SUM(T2.BOR_AMT) AS BOR_AMT -- 위약금
             , SUM(T2.ATAM_CV_AMT + T2.OVR_CTR_BOR_AMT) AS ADJ_AMT -- 조정금액
             , SUM(T2.ETC_PROFIT) AS ETC_PROFIT -- 잡이익
             , SUM(T2.EOT_ATAM) AS EOT_ATAM -- 기말 영업선수금
             </if>
             <if test="@MybatisUtils@equals(agrgDv, '3') or @MybatisUtils@equals(agrgDv, '4')">
             , T2.CST_NO AS CST_NO -- 고객번호
             , (SELECT CST_KNM FROM TB_CUBS_CST_BAS WHERE CST_NO = T2.CST_NO AND DTA_DL_YN = 'N') AS CST_KNM -- 고객명
             , T2.PD_CD AS PD_CD -- 상품코드
             , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE PD_CD = T2.PD_CD) AS PD_NM -- 상품명
             , T2.CNTR_NO || '-' || T2.CNTR_SN AS CNTR_NO
             , T2.BTD_ATAM AS BTD_ATAM -- 전기이월
             , T2.BTD_ATAM_1 AS BTD_ATAM_1
             , T2.BTD_ATAM_2 AS BTD_ATAM_2
             , T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_AMT AS ATAM_DP_AMT  -- 선수입금
             , T2.THM_ATAM_DP_AMT AS ATAM_DP_AMT_1
             , T2.THM_DLQ_ADD_DP_AMT AS ATAM_DP_AMT_2
             , T2.THM_ATAM_RFND_AMT AS THM_ATAM_RFND_AMT  -- 선수환불
             , T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_AMT - T2.THM_ATAM_RFND_AMT AS DP_TOT_AMT -- 입금합계
             , T2.SL_BND_ALRPY_AMT_1 - T2.SL_BND_ALRPY_AMT_3 + T2.SL_BND_ALRPY_AMT_4 + T2.SL_BND_ALRPY_AMT_5 - T2.SL_BND_ALRPY_AMT_6 AS SL_BND_ALRPY_AMT -- 매출합계
             , T2.SL_BND_ALRPY_AMT_1 AS SL_BND_ALRPY_AMT_1
             , T2.SL_BND_ALRPY_AMT_3 AS SL_BND_ALRPY_AMT_3
             , T2.SL_BND_ALRPY_AMT_4 AS SL_BND_ALRPY_AMT_4
             , T2.SL_BND_ALRPY_AMT_5 AS SL_BND_ALRPY_AMT_5
             , T2.SL_BND_ALRPY_AMT_6 AS SL_BND_ALRPY_AMT_6
             , T2.BOR_AMT AS BOR_AMT -- 위약금
             , T2.ATAM_CV_AMT + T2.OVR_CTR_BOR_AMT AS ADJ_AMT -- 조정금액
             , T2.ETC_PROFIT AS ETC_PROFIT -- 잡이익
             , T2.EOT_ATAM AS EOT_ATAM -- 기말 영업선수금
             </if>
          FROM (
                SELECT
                       T1.*
                     , CASE WHEN T1.EOT_ATAM != T1.BTD_ATAM
                                              + T1.THM_ATAM_DP_AMT - T1.THM_DLQ_ADD_DP_AMT - T1.THM_ATAM_RFND_AMT
                                              - (T1.SL_BND_ALRPY_AMT_1 - T1.SL_BND_ALRPY_AMT_3 + T1.SL_BND_ALRPY_AMT_4 + T1.SL_BND_ALRPY_AMT_5 - T1.SL_BND_ALRPY_AMT_6)
                                              - T1.BOR_AMT
                                              + T1.ATAM_CV_AMT + T1.OVR_CTR_BOR_AMT
                                              - T1.ETC_PROFIT THEN 'Y'
                            ELSE 'N' END AS ERR_YN
                  FROM (
                        SELECT A.SL_CL_YM AS SL_CL_YM -- 실적년월
                             , A.SELL_TP_CD AS SELL_TP_CD -- 판매유형코드
                             , A.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세코드
                             , A.CNTR_NO AS CNTR_NO -- 계약번호
                             , A.CNTR_SN AS CNTR_SN -- 계약일련번호
                             , A.SAP_PD_DV_CD AS SAP_PD_DV_CD -- SAP상품구분코드
                             , A.CST_NO AS CST_NO -- 고객번호
                             , A.PD_CD AS PD_CD -- 상품코드
                             -------------------------------------------------
                             -- 전기이월
                             -------------------------------------------------
                             , NVL(A.BTD_ATAM, 0) + NVL(A.PRM_BLAM_BTD_AMT, 0) AS BTD_ATAM -- 전기이월
                             , NVL(A.BTD_ATAM, 0) AS BTD_ATAM_1 -- 선수기초 LCAM31
                             , NVL(A.PRM_BLAM_BTD_AMT, 0) AS BTD_ATAM_2 -- 선납잔액 LCAM21
                             -------------------------------------------------
                             -- 선수입금
                             -------------------------------------------------
                             , NVL(A.THM_ATAM_DP_AMT, 0) AS THM_ATAM_DP_AMT -- 선수입금 LCAM32
                             , (CASE WHEN A.SL_CL_YM <![CDATA[<]]> '201605' THEN 0
                                     ELSE NVL(C.THM_DLQ_ADD_DP_SUM_AMT, 0) - NVL(C.THM_DLQ_ADD_RFND_SUM_AMT, 0) -- 가산금 입금-환불
                                END) AS THM_DLQ_ADD_DP_AMT -- 가산금입금 LCAM83
                             , NVL(A.THM_ATAM_RFND_AMT, 0) AS THM_ATAM_RFND_AMT -- 선수환불 LCAM33
                             -------------------------------------------------
                             -- 매출
                             -- LC505.LCTAMT - LC505.LCRAMT - LC505.LCAM43 + LC505.LCTCHA + LC505.LCAM38 - LC505.LCAM74
                             -------------------------------------------------
                             , (CASE WHEN SUBSTR(H.CNTR_PD_STRTDT, 1, 6) = A.SL_CL_YM THEN NVL(A.CNTR_AMT, 0) ELSE 0 END) AS SL_BND_ALRPY_AMT_1 -- 렌탈등록비-할인금액(LC505.LCTAMT - LC505.LCRAMT)
                             , NVL(A.RENTAL_RGST_COST_RFND_AMT, 0) AS SL_BND_ALRPY_AMT_3 -- 등록환불
                             , NVL(A.RENTAL_RGST_COST_DFAM, 0) AS SL_BND_ALRPY_AMT_4 -- 등록차액
                             , NVL(A.SL_BND_ALRPY_AMT, 0) AS SL_BND_ALRPY_AMT_5 -- 매출입금
                             , NVL(A.MLG_SL_AMT, 0) AS SL_BND_ALRPY_AMT_6 -- 포인트_매출
                             -------------------------------------------------
                             -- 기말선수
                             -------------------------------------------------
                             , NVL(A.EOT_ATAM, 0) AS EOT_ATAM -- 기말 LCAM36
                             -------------------------------------------
                             -- 위약금
                             -------------------------------------------
                             , NVL(D.DP_CCAM_SUM_AMT, 0) AS BOR_AMT -- 위약미수입금
                             -------------------------------------------
                             -- 조정금액 LC505.LCCM34 + LC505.LCA107
                             -------------------------------------------
                             , NVL(A.OVR_CTR_DP_AMT, 0) AS ATAM_CV_AMT -- 미수초과조정
                             , (CASE WHEN A.SL_CL_YM >= '202212' AND F.AUTH_RSG_CNFM_YN = 'Y' THEN NVL(D.OVR_CTR_BOR_AMT, 0) ELSE 0 END) AS OVR_CTR_BOR_AMT -- 위약미수초과조정
                             , NVL((SELECT SUM(NVL(T1.BZNS_ATAM_BLAM, 0))
  			                              FROM TB_CBCL_BZNS_ATAM_PROCS_IZ  T1
  			                             WHERE T1.CNTR_NO = A.CNTR_NO
  			                               AND T1.CNTR_SN = A.CNTR_SN
  			                               AND T1.PTYPF_OJ_CD = '9' -- 잡이익 처리완료
  			                               AND T1.PTYPF_PRCSDT BETWEEN A.SL_CL_YM||'01' AND TO_CHAR(LAST_DAY(TO_DATE(A.SL_CL_YM,'YYYYMM')),'YYYYMMDD')), 0) AS ETC_PROFIT-- 잡이익
                          FROM TB_CBCL_WELLS_SL_MM_CL_IZ A
                          LEFT OUTER JOIN TB_SSCT_CNTR_BAS B -- 계약기본
                            ON A.CNTR_NO = B.CNTR_NO
                           AND B.DTA_DL_YN = 'N'
                          LEFT OUTER JOIN TB_SSCT_CNTR_DTL H -- 계약상세
                  			    ON H.CNTR_NO = A.CNTR_NO
                  			   AND H.CNTR_SN = A.CNTR_SN
                          LEFT OUTER JOIN TB_CBCL_DLQ_BAS C -- 연체기본
                            ON C.PERF_YM = A.SL_CL_YM
                           AND C.CNTR_NO = A.CNTR_NO
                           AND C.CNTR_SN = A.CNTR_SN
                           AND C.DTA_DL_YN = 'N'
                          LEFT OUTER JOIN TB_CBCL_WELLS_BOR_AMT_BAS D -- 위약기본
                            ON D.PERF_YM = A.SL_CL_YM
                           AND D.CNTR_NO = A.CNTR_NO
                           AND D.CNTR_SN = A.CNTR_SN
                           AND D.DTA_DL_YN = 'N'
                          LEFT OUTER JOIN TB_CBBO_WELLS_AUTH_RSG_IZ F -- WELLS직권해지
                            ON F.CNTR_NO = A.CNTR_NO
                           AND F.CNTR_SN = A.CNTR_SN
                           AND F.AUTH_RSG_CNFM_YN = 'Y'
                           AND F.BASE_YM <![CDATA[<=]]> A.SL_CL_YM
                         WHERE 1=1
                           AND A.SL_CL_YM = #{slClYm}
                           AND A.SELL_TP_CD = '2'
                           AND A.SELL_TP_DTL_CD IN ('21', '23')
                           AND NOT EXISTS ( SELECT /*+ UNNEST */ 1
                                            FROM TB_SSCT_CNTR_DTL AA
                                           INNER JOIN TB_PDBS_PD_CLSF_BAS BB -- 상품분류기본-소분류[AS-IS:KA1100P]
                                              ON BB.PD_CLSF_ID = AA.PD_LCLSF_ID -- 상품분류ID = 상품세분류ID
                                             AND BB.DTA_DL_YN = 'N'
                                             AND BB.USE_YN = 'Y'
                                             AND BB.REF_PD_CLSF_VAL = '05003002' -- [Cooking+커피머신+원두]
                                           WHERE AA.CNTR_NO = A.CNTR_NO
                                             AND AA.CNTR_SN = A.CNTR_SN )
                           <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                           AND A.SELL_TP_DTL_CD = #{sellTpDtlCd}
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(sapPdDvCd) and !@MybatisUtils@equals(sapPdDvCd, 'ALL')">
                           AND A.SAP_PD_DV_CD = #{sapPdDvCd}
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                           AND A.CNTR_NO   = #{cntrNo}   /*계약번호*/
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                           AND A.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(sellInflwChnlDtlCd) and !@MybatisUtils@equals(sellInflwChnlDtlCd, 'ALL')">
                           AND B.SELL_INFLW_CHNL_DTL_CD = #{sellInflwChnlDtlCd}
                           </if>
                        ) T1
               ) T2
         WHERE 1=1
           <if test="@MybatisUtils@equals(agrgDv, '4')"> -- 가로계산식 틀린 회원
           AND T2.ERR_YN = 'Y'
           </if>
           <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">  -- 집계, 일자
           GROUP BY SL_CL_YM, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
           ORDER BY SL_CL_YM, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
           </if>
    </sql>

    <select id="selectAnticipationRentals" resultType="com.kyowon.sms.wells.web.closing.performance.dto.WdccOverduePenaltyDto$SearchOrderRes">
        <include refid="sqlAnticipationRentals"></include>
    </select>

    <sql id="sqlAnticipationLeases">
        -- 리스 일자별외
        SELECT
             <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">
               SUBSTR(T2.SL_CL_YM,1,4) || '-' || SUBSTR(T2.SL_CL_YM,5,2) || (
                   CASE WHEN SUM(T2.EOT_ATAM) != SUM(T2.BTD_ATAM
                                                   + T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_SUM_AMT - T2.THM_ATAM_RFND_AMT
                                                   - T2.SL_BND_ALRPY_AMT
                                                   - T2.BOR_AMT
                                                   + T2.ATAM_CV_AMT
                                                   - T2.ETC_PROFIT) THEN ' *'
                        ELSE ''
                   END) AS SL_CL_YM -- 실적년월
             </if>
             <if test="@MybatisUtils@equals(agrgDv, '3') or @MybatisUtils@equals(agrgDv, '4')">
               SUBSTR(T2.SL_CL_YM,1,4) || '-' || SUBSTR(T2.SL_CL_YM,5,2) || (CASE WHEN T2.ERR_YN = 'Y' THEN ' *' ELSE '' END) AS SL_CL_YM -- 실적년월
             </if>
             , T2.SELL_TP_CD -- 판매유형코드
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_CD' AND CD_VLD_VAL = T2.SELL_TP_CD) AS SELL_TP_CD_NM -- 판매유형코드명
             , T2.SELL_TP_DTL_CD -- 판매유형상세코드
             , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID = #{session.tenantId} AND CD_ID = 'SELL_TP_DTL_CD' AND CD_VLD_VAL = T2.SELL_TP_DTL_CD) AS SELL_TP_DTL_CD_NM -- 판매유형상세코드명
             , T2.SAP_PD_DV_CD AS SAP_PD_DV_CD
             , (SELECT MAX(SAP_PD_ATC_NM)
                FROM TB_CBCL_SAP_PD_DV_CD
                WHERE SAP_BZ_TERY_CD = '1210' -- SAP_BZ_TERY_CD : WELLS면 1210, EDU면 1110
                  AND SAP_PD_ATC_CD = '00'
                  AND SAP_PD_DV_CD = T2.SAP_PD_DV_CD) AS SAP_PD_ATC_NM -- SAP상품코드명
             <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">
             , '' AS CST_NO -- 고객번호
             , '' AS CST_KNM -- 고객명
             , '' AS PD_CD -- 상품코드
             , '' AS PD_NM -- 상품명
             , '' AS CNTR_NO
             , SUM(T2.BTD_ATAM) AS BTD_ATAM -- 전기이월
             , SUM(T2.BTD_ATAM_1) AS BTD_ATAM_1
             , SUM(T2.BTD_ATAM_2) AS BTD_ATAM_2
             , SUM(T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_SUM_AMT) AS ATAM_DP_AMT  -- 선수입금
             , SUM(T2.THM_ATAM_DP_AMT) AS ATAM_DP_AMT_1
             , SUM(T2.THM_DLQ_ADD_DP_SUM_AMT) AS ATAM_DP_AMT_2
             , SUM(T2.THM_ATAM_RFND_AMT) AS THM_ATAM_RFND_AMT  -- 선수환불
             , SUM(T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_SUM_AMT - T2.THM_ATAM_RFND_AMT) AS DP_TOT_AMT -- 입금합계
             , SUM(T2.SL_BND_ALRPY_AMT) AS SL_BND_ALRPY_AMT -- 매출합계
             , SUM(T2.BOR_AMT) AS BOR_AMT -- 위약금
             , SUM(T2.ATAM_CV_AMT) AS ADJ_AMT -- 조정금액
             , SUM(T2.EOT_ATAM) AS EOT_ATAM -- 기말 영업선수금
             , SUM(T2.ETC_PROFIT) AS ETC_PROFIT -- 잡이익
             </if>
             <if test="@MybatisUtils@equals(agrgDv, '3') or @MybatisUtils@equals(agrgDv, '4')">
             , T2.CST_NO AS CST_NO -- 고객번호
             , (SELECT CST_KNM FROM TB_CUBS_CST_BAS WHERE CST_NO = T2.CST_NO AND DTA_DL_YN = 'N') AS CST_KNM -- 고객명
             , T2.PD_CD AS PD_CD -- 상품코드
             , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE PD_CD = T2.PD_CD) AS PD_NM -- 상품명
             , T2.CNTR_NO || '-' || T2.CNTR_SN AS CNTR_NO
             , T2.BTD_ATAM AS BTD_ATAM -- 전기이월
             , T2.BTD_ATAM_1 AS BTD_ATAM_1
             , T2.BTD_ATAM_2 AS BTD_ATAM_2
             , T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_SUM_AMT AS ATAM_DP_AMT  -- 선수입금
             , T2.THM_ATAM_DP_AMT AS ATAM_DP_AMT_1
             , T2.THM_DLQ_ADD_DP_SUM_AMT AS ATAM_DP_AMT_2
             , T2.THM_ATAM_RFND_AMT AS THM_ATAM_RFND_AMT  -- 선수환불
             , T2.THM_ATAM_DP_AMT - T2.THM_DLQ_ADD_DP_SUM_AMT - T2.THM_ATAM_RFND_AMT AS DP_TOT_AMT -- 입금합계
             , T2.SL_BND_ALRPY_AMT AS SL_BND_ALRPY_AMT -- 매출합계
             , T2.BOR_AMT AS BOR_AMT -- 위약금
             , T2.ATAM_CV_AMT AS ADJ_AMT -- 조정금액
             , T2.EOT_ATAM AS EOT_ATAM -- 기말 영업선수금
             , T2.ETC_PROFIT AS ETC_PROFIT -- 잡이익
             </if>
          FROM (
                SELECT T1.*
                     , CASE WHEN T1.EOT_ATAM != T1.BTD_ATAM
                                              + T1.THM_ATAM_DP_AMT - T1.THM_DLQ_ADD_DP_SUM_AMT - T1.THM_ATAM_RFND_AMT
                                              - T1.SL_BND_ALRPY_AMT
                                              - T1.BOR_AMT
                                              + T1.ATAM_CV_AMT
                                              - T1.ETC_PROFIT THEN 'Y'
                            ELSE 'N' END AS ERR_YN
                  FROM (
                        SELECT A.SL_CL_YM AS SL_CL_YM -- 실적년월
                             , A.SELL_TP_CD AS SELL_TP_CD -- 판매유형코드
                             , A.SELL_TP_DTL_CD AS SELL_TP_DTL_CD -- 판매유형상세코드
                             , A.CNTR_NO AS CNTR_NO -- 계약번호
                             , A.CNTR_SN AS CNTR_SN -- 계약일련번호
                             , A.SAP_PD_DV_CD AS SAP_PD_DV_CD -- SAP상품구분코드
                             , A.CST_NO AS CST_NO -- 고객번호
                             , A.PD_CD AS PD_CD -- 상품코드
                             -------------------------------------------------
                             -- 전기이월
                             -------------------------------------------------
                             , NVL(A.BTD_ATAM, 0) + NVL(A.PRM_BLAM_BTD_AMT, 0) AS BTD_ATAM -- 전기이월
                             , NVL(A.BTD_ATAM, 0) AS BTD_ATAM_1 -- 선수기초 LCAM31
                             , NVL(A.PRM_BLAM_BTD_AMT, 0) AS BTD_ATAM_2 -- 선납잔액 LCAM21
                             -------------------------------------------------
                             -- 선수입금
                             -------------------------------------------------
                             , NVL(A.THM_ATAM_DP_AMT, 0) AS THM_ATAM_DP_AMT -- 선수입금 LCAM32
                             , NVL(C.THM_DLQ_ADD_DP_SUM_AMT, 0) AS THM_DLQ_ADD_DP_SUM_AMT -- 가산금입금 LCAM83
                             , NVL(A.THM_ATAM_RFND_AMT, 0) AS THM_ATAM_RFND_AMT -- 선수환불 LCAM33
                             -------------------------------------------------
                             -- 매출
                             -- LC505.LCAM35 + LC505.LCCM35 + LC505.LCSM35
                             -------------------------------------------------
                             , NVL(A.PRPD_SL_AMT, 0) AS SL_BND_ALRPY_AMT -- 원금+이자+서비스 선수매출
                             -------------------------------------------------
                             -- 기말선수
                             -------------------------------------------------
                             , NVL(A.EOT_ATAM, 0) AS EOT_ATAM -- 기말 LCAM36
                             -------------------------------------------
                             -- 위약금
                             -------------------------------------------
                             , NVL(D.DP_CCAM_SUM_AMT, 0) AS BOR_AMT -- 위약미수입금
                             -------------------------------------------
                             -- 조정금액 LC505.LCCM34
                             -------------------------------------------
                             , NVL(A.OVR_CTR_DP_AMT, 0) AS ATAM_CV_AMT -- 미수초과조정
                             , NVL((SELECT SUM(NVL(T1.BZNS_ATAM_BLAM, 0))
  			                              FROM TB_CBCL_BZNS_ATAM_PROCS_IZ  T1
  			                             WHERE T1.CNTR_NO = A.CNTR_NO
  			                               AND T1.CNTR_SN = A.CNTR_SN
  			                               AND T1.PTYPF_OJ_CD = '9' -- 잡이익 처리완료
  			                               AND T1.PTYPF_PRCSDT BETWEEN A.SL_CL_YM||'01' AND TO_CHAR(LAST_DAY(TO_DATE(A.SL_CL_YM,'YYYYMM')),'YYYYMMDD')), 0) AS ETC_PROFIT-- 잡이익
                          FROM TB_CBCL_WELLS_SL_MM_CL_IZ A
                          LEFT OUTER JOIN TB_SSCT_CNTR_BAS B -- 계약기본
                            ON A.CNTR_NO = B.CNTR_NO
                           AND B.DTA_DL_YN = 'N'
                          LEFT OUTER JOIN TB_CBCL_DLQ_BAS C -- 연체기본
                            ON C.PERF_YM = A.SL_CL_YM
                               AND C.CNTR_NO = A.CNTR_NO
                               AND C.CNTR_SN = A.CNTR_SN
                           AND C.DTA_DL_YN = 'N'
                          LEFT OUTER JOIN TB_CBCL_WELLS_BOR_AMT_BAS D -- 위약기본
                            ON D.PERF_YM = A.SL_CL_YM
                               AND D.CNTR_NO = A.CNTR_NO
                               AND D.CNTR_SN = A.CNTR_SN
                           AND D.DTA_DL_YN = 'N'
                         WHERE 1=1
                           AND A.SL_CL_YM = #{slClYm}
                           AND A.SELL_TP_CD = '2'
                           AND A.SELL_TP_DTL_CD NOT IN ('21', '23')
                           <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd) and !@MybatisUtils@equals(sellTpDtlCd, 'ALL')">
                           AND A.SELL_TP_DTL_CD = #{sellTpDtlCd}
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(sapPdDvCd) and !@MybatisUtils@equals(sapPdDvCd, 'ALL')">
                           AND A.SAP_PD_DV_CD = #{sapPdDvCd}
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(cntrNo)">
                           AND A.CNTR_NO   = #{cntrNo}   /*계약번호*/
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(cntrSn)">
                           AND A.CNTR_SN   = #{cntrSn}   /*계약상세번호*/
                           </if>
                           <if test="@MybatisUtils@isNotEmpty(sellInflwChnlDtlCd) and !@MybatisUtils@equals(sellInflwChnlDtlCd, 'ALL')">
                           AND B.SELL_INFLW_CHNL_DTL_CD = #{sellInflwChnlDtlCd}
                           </if>
                        ) T1
               ) T2
        WHERE 1=1
          <if test="@MybatisUtils@equals(agrgDv, '4')"> -- 가로계산식 틀린 회원
          AND T2.ERR_YN = 'Y'
          </if>
          <if test="@MybatisUtils@equals(agrgDv, '1') or @MybatisUtils@equals(agrgDv, '2')">  -- 집계, 일자
          GROUP BY SL_CL_YM, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
          ORDER BY SL_CL_YM, SELL_TP_CD, SELL_TP_DTL_CD, SAP_PD_DV_CD
          </if>
    </sql>

    <select id="selectAnticipationLeases" resultType="com.kyowon.sms.wells.web.closing.performance.dto.WdccOverduePenaltyDto$SearchOrderRes">
        <include refid="sqlAnticipationLeases"></include>
    </select>

</mapper>

