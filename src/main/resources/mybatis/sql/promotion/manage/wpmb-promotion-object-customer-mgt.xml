<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.promotion.manage.mapper.WpmbPromotionObjectCustomerMgtMapper">
    <select id="selectPromotionObjectCustomerPages" resultType="com.kyowon.sms.wells.web.promotion.manage.dto.WpmbPromotionObjectCustomerMgtDto$SearchRes">
       SELECT T1.PMOT_OJ_REL_ID
            , T1.HIST_STRT_DTM
            , T1.HIST_END_DTM
            , T1.CNTR_NO
            , T1.CNTR_SN
            , T1.VL_STRT_DTM
            , T1.VL_END_DTM
            , T1.PMOT_OJ_SPC_DSC_DV_CD
            , T1.PD_CD
            , T1.SELL_TP_CD
            , T1.TEMP_SAVE_YN
            , T1.DTA_DL_YN
            , T1.FST_RGST_DTM
            , T1.FST_RGST_USR_ID
            , T2.USR_NM                                              AS FNL_MDFC_USR_NM
            , T1.FNL_MDFC_DTM
            , T1.FNL_MDFC_USR_ID
            , T3.USR_NM                                              AS FST_RGST_USR_NM
            , '' AS APY_BIZ_CD
         FROM TB_PDBS_PMOT_OJ_REL T1
         LEFT OUTER JOIN T_CMP_USR_ACO_M T2
           ON T1.FNL_MDFC_USR_ID = T2.USR_ID
         LEFT OUTER JOIN T_CMP_USR_ACO_M T3
           ON T1.FST_RGST_USR_ID = T3.USR_ID
        WHERE T1.DTA_DL_YN = 'N'
    <if test="@MybatisUtils@isNotEmpty(cntrNo)">
          AND T1.CNTR_NO = #{cntrNo}
    </if>
    <if test="@MybatisUtils@isNotEmpty(cntrSn)">
          AND T1.CNTR_SN = #{cntrSn}
    </if>
    <if test="@MybatisUtils@isNotEmpty(vlStrtDtm)">
          AND T1.VL_END_DTM <![CDATA[>=]]> #{vlStrtDtm} || '000000'
    </if>
    <if test="@MybatisUtils@isNotEmpty(vlEndDtm)">
          AND T1.VL_STRT_DTM <![CDATA[<=]]> #{vlEndDtm} || '235959'
    </if>
    <if test="@MybatisUtils@isNotEmpty(pmotOjSpcDscDvCd)">
          AND T1.PMOT_OJ_SPC_DSC_DV_CD = #{pmotOjSpcDscDvCd}
    </if>
        ORDER BY T1.FST_RGST_DTM DESC
    </select>

    <insert id="insertPromotionObjectCustomer" parameterType="com.kyowon.sms.wells.web.promotion.manage.dvo.WpmbPromotionObjectCustomerDvo">
        <selectKey keyProperty="pmotOjRelId" resultType="java.lang.String" order="BEFORE">
            SELECT 'PDM' || LPAD(SQ_PDBS_PMOT_OJ_REL$PMOT_OJ_REL_ID.NEXTVAL,12,0)
              FROM DUAL
        </selectKey>
            INSERT INTO TB_PDBS_PMOT_OJ_REL
                (
                      PMOT_OJ_REL_ID
                    , HIST_STRT_DTM
                    , HIST_END_DTM
                    , CNTR_NO
                    , CNTR_SN
                    , VL_STRT_DTM
                    , VL_END_DTM
                    , PMOT_OJ_SPC_DSC_DV_CD
                    , PD_CD
                    , SELL_TP_CD
                    , TEMP_SAVE_YN
                    , DTA_DL_YN
                    <include refid="COMMON.insertSystemField"/>
                )
            VALUES (
                      #{pmotOjRelId}
                    , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                    , '99991231235959'
                    , #{cntrNo}
                    , #{cntrSn}
                    , #{vlStrtDtm} || '000000'
                    , #{vlEndDtm} || '000000'
                    , #{pmotOjSpcDscDvCd}
                    , (SELECT BASE_PD_CD
                         FROM TB_SSCT_CNTR_DTL
                        WHERE DTA_DL_YN = 'N'
                          AND CNTR_NO = #{cntrNo}
                          AND CNTR_SN = #{cntrSn}
                          AND ROWNUM = 1)
                    , #{sellTpCd}
                    , 'N'
                    , 'N'
                    <include refid="COMMON.insertSystemFieldValue" />
                )
    </insert>

    <update id="updatePromotionObjectCustomer" parameterType="com.kyowon.sms.wells.web.promotion.manage.dvo.WpmbPromotionObjectCustomerDvo">
        UPDATE TB_PDBS_PMOT_OJ_REL
           SET CNTR_NO = #{cntrNo}
             , CNTR_SN = #{cntrSn}
             , VL_STRT_DTM = CASE WHEN LENGTH(#{vlStrtDtm}) = 8 THEN #{vlStrtDtm} || '000000'
                                  ELSE #{vlStrtDtm}
                              END
             , VL_END_DTM = CASE WHEN LENGTH(#{vlEndDtm}) = 8 THEN #{vlEndDtm} || '000000'
                                 ELSE #{vlEndDtm}
                             END
             , PMOT_OJ_SPC_DSC_DV_CD = #{pmotOjSpcDscDvCd}
             , SELL_TP_CD = #{sellTpCd}
         <include refid="COMMON.updateSystemField" />
         WHERE PMOT_OJ_REL_ID = #{pmotOjRelId}
           AND HIST_STRT_DTM = #{histStrtDtm}
    </update>

    <select id="selectObjectCustomerContractInfo" resultType="com.kyowon.sms.wells.web.promotion.manage.dvo.WpmbPromotionObjectCustomerDvo">
        SELECT T1.CNTR_NO
             , T1.CNTR_SN
             , T1.SELL_TP_CD
             , T2.PMOT_OJ_REL_ID
          FROM TB_SSCT_CNTR_DTL T1
          LEFT OUTER JOIN TB_PDBS_PMOT_OJ_REL T2
            ON T2.CNTR_NO = T1.CNTR_NO
           AND T2.CNTR_SN = T1.CNTR_SN
           AND T2.DTA_DL_YN = 'N'
         WHERE T1.DTA_DL_YN = 'N'
           AND T1.CNTR_NO = #{cntrNo}
           AND T1.CNTR_SN = #{cntrSn}
    </select>

    <update id="deletePromotionObjectCustomer" parameterType="com.kyowon.sms.wells.web.promotion.manage.dvo.WpmbPromotionObjectCustomerDvo">
        UPDATE TB_PDBS_PMOT_OJ_REL
           SET DTA_DL_YN = 'Y'
         <include refid="COMMON.updateSystemField"/>
         WHERE PMOT_OJ_REL_ID = #{pmotOjRelId}
           AND HIST_STRT_DTM = #{histStrtDtm}
    </update>
</mapper>
