<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.risk.mapper.WctcRiskAuditMapper">
    <select id="selectIrregularBznsInqr" resultType="com.kyowon.sms.wells.web.contract.risk.dto.WctcRiskAuditDto$SearchRes">
        SELECT
           MAX(DANG_CHK_ID)                AS DANG_CHK_ID
         , MAX(H.WELLS_OJ_PSTN_RANK_NM)    AS WELLS_OJ_PSTN_RANK_NM    /* 구분 */
         , MAX(H.DANG_MNGT_PNTNR_OG_NM)    AS DANG_MNGT_PNTNR_OG_NM    /* 소속명 */
         , H.DANG_MNGT_PNTNR_OG_CD         AS DANG_MNGT_PNTNR_OG_CD    /* 소속코드 */--
         , MAX(H.DANG_MNGT_PNTNR_NM)       AS DANG_MNGT_PNTNR_NM       /* 성명 */
         , H.DANG_MNGT_PRTNR_NO            AS DANG_MNGT_PRTNR_NO       /* 사번 */ --
         , MAX(H.DANG_OJ_PRTNR_NM)         AS DANG_OJ_PRTNR_NM         /* 행위자사번-성명 */
         , H.DANG_OJ_PRTNR_NO              AS DANG_OJ_PRTNR_NO         /* 행위자사번-사번 */
         , MAX(H.DANG_OJ_PRTNR_PSTN_DV_NM) AS DANG_OJ_PRTNR_PSTN_DV_NM /* 행위자사번-직급 */
         , MAX(H.DANG_OC_STRTMM)           AS DANG_OC_STRTMM           /* 벌점-발생년월 */
         , MAX(H.DANG_ARBIT_OG_NM)         AS DANG_ARBIT_OG_NM         /* 벌점-조치부서 */
         , MAX(H.DANG_CHK_NM)              AS DANG_CHK_NM              /* 벌점-부과내역 */
         , MAX(H.DANG_ARBIT_CD_NM)         AS DANG_ARBIT_CD_NM         /* 벌점-조치항목 */
         , MAX(H.DANG_UNCVR_CT)            AS DANG_UNCVR_CT            /* 벌점-부과대상건수 */
         , MAX(H.DANG_ARBIT_LVY_PC)        AS DANG_ARBIT_LVY_PC        /* 벌점-조치결과부과점수 */
         , MAX(H.DANG_ARBIT_LVY_PC_SUM)    AS DANG_ARBIT_LVY_PC_SUM    /* 벌점-합계점수 */
         , MAX(H.FST_RGST_USR_ID)          AS FST_RGST_USR_ID          /* 등록자 */
         , MAX(H.FST_RGST_DT)              AS FST_RGST_DT              /* 등록일자 */
         , MAX(H.DANG_MNGT_PSTN_DV_CD)     AS DANG_MNGT_PSTN_DV_CD     /* 위험관리직급구분코드 */
         , MAX(H.DANG_ARBIT_OG_ID)         AS DANG_ARBIT_OG_ID         /* 위험조치조직ID */
         , MAX(H.DANG_ARBIT_CD)            AS DANG_ARBIT_CD            /* 위험조치코드 */
         , MAX(H.DANG_ARBIT_LVY_PC_ORG)    AS DANG_ARBIT_LVY_PC_ORG    /* 위험조치부과점수(계산하기전) */
         , MAX(H.FST_RGST_DTM)             AS FST_RGST_DTM             /* 최초등록일시 */
         , MAX(H.DGR1_LEVL_OG_CD)          AS DGR1_LEVL_OG_CD          /* 1차레벨조직코드 */
         , MAX(H.DGR2_LEVL_OG_CD)          AS DGR2_LEVL_OG_CD          /* 2차레벨조직코드 */
         , MAX(H.DGR3_LEVL_OG_CD)          AS DGR3_LEVL_OG_CD          /* 3차레벨조직코드 */
         , MAX(H.OG_ID)                    AS OG_ID                    /* 조직ID */
         , MAX(H.SORT_ORD)                 AS SORT_ORD                 /* 정렬순번 */
         , MAX(H.PSTN_DV_CD)               AS PSTN_DV_CD               /* 직급구분코드 */
         , MIN(H.DANG_OJ_PRTNR_PSTN_DV_CD) AS DANG_OJ_PRTNR_PSTN_DV_CD /* 행위자직급코드 */
      FROM
           (
            WITH TB_TEST AS (
                    SELECT DANG_CHK_ID
                         , AFMDBS.F_CMZ_CD_NM('TNT_WELLS', 'WELLS_OJ_PSTN_RANK_CD', A.DANG_MNGT_PSTN_DV_CD)  AS WELLS_OJ_PSTN_RANK_NM /* [구분] - WELLS대상직급명-CODE : WELLS_OJ_PSTN_RANK_CD */
                         , D2.OG_NM AS DANG_MNGT_PNTNR_OG_NM /* [소속명] - 월 조직/파트너 내역(WITH).조직명 */
                         , D2.OG_CD AS DANG_MNGT_PNTNR_OG_CD /* [소속코드] - 월 조직/파트너 내역(WITH).조직코드 */
                         , C2.PRTNR_KNM AS DANG_MNGT_PNTNR_NM /* [성명] - 월 조직/파트너 내역(WITH).파트너한글명 */
                         , A.DANG_MNGT_PRTNR_NO /* [사번] - 위험점검내역.위험관리파트너번호 */
                         , C1.PRTNR_KNM AS DANG_OJ_PRTNR_NM /* [행위자사번 - 성명] - 월 조직/파트너 내역(WITH).파트너한글명 */
                         , A.DANG_OJ_PRTNR_NO /* [행위자사번- 사번] - 위험점검내역.위험대상파트너번호 */
                         , C1.PSTN_DV_CD AS DANG_OJ_PRTNR_PSTN_DV_CD /* 행위자직급코드 - 월 조직/파트너 내역(WITH).직급코드 */
                         , AFMDBS.F_CMZ_CD_NM('TNT_WELLS', 'PSTN_DV_CD', C1.PSTN_DV_CD) AS DANG_OJ_PRTNR_PSTN_DV_NM /* [행위자사번 - 직급] - 월 조직/파트너 내역(WITH).직급구분명 */
                         , SUBSTR(A.DANG_OC_STRTDT, 1, 6) AS DANG_OC_STRTMM /* [벌점 - 발생년월] - SUBSTR(위험점검내역.위험발생시작일자,1,6) */
                         , AFMDBS.F_CMZ_CD_NM ('TNT_WELLS', 'PNTSC_ARBIT_DEPT_CD', A.DANG_ARBIT_OG_ID) AS DANG_ARBIT_OG_NM /* [벌점 - 조치부서] - 공통코드 벌점 조치 부서 PNTSC_ARBIT_DEPT_CD */
                         , A.DANG_CHK_NM /* [벌점 - 부과내역] - 위험점검내역.위험점검명 */
                         , AFMDBS.F_CMZ_CD_NM ('TNT_WELLS', 'PNTSC_ARBIT_ATC_CD', A.DANG_ARBIT_CD) AS DANG_ARBIT_CD_NM /* [벌점 - 조치항목] - 공통코드 벌점조치항목 PNTSC_ARBIT_ATC_CD */
                         , A.DANG_UNCVR_CT /* [벌점 - 부과대상건수] - 위험점검내역.위험적발건수 */
                         , CASE WHEN A.DANG_MNGT_PSTN_DV_CD = '5' /* 위험점검내역.위험관리직급구분코드 = 5(업무지원매니저-BM) */
                                     THEN TRUNC(NVL(A.DANG_ARBIT_LVY_PC,0) * 0.5, 1) /* TRUNC(위험점검내역.위험조치부과점수 * 0.5,1) */
                                ELSE NVL(A.DANG_ARBIT_LVY_PC,0)
                           END DANG_ARBIT_LVY_PC /* [벌점 - 조치결과 부과점수] */
                         , (
                            SELECT SUM(CASE WHEN A.DANG_MNGT_PSTN_DV_CD = '5' /* 위험점검내역.위험관리직급구분코드 = 5(업무지원매니저-BM) */
                                                 THEN TRUNC(NVL(A.DANG_ARBIT_LVY_PC,0) * 0.5, 1) /* TRUNC(위험점검내역.위험조치부과점수 * 0.5,1) */
                                            ELSE NVL(A.DANG_ARBIT_LVY_PC,0)
                                       END)
                              FROM TB_SSCT_DANG_CHK_IZ A2
                             WHERE A2.DANG_MNGT_PRTNR_NO = A.DANG_MNGT_PRTNR_NO /* 위험점검내역.위험관리파트너번호 = 위험점검내역.위험관리파트너번호 */
                               AND A2.DANG_MNGT_PSTN_DV_CD = A.DANG_MNGT_PSTN_DV_CD /* 위험점검내역.위험관리직급구분코드 = 위험점검내역.위험관리직급구분코드 */
                                <if test='@MybatisUtils@equals(srchGbn, "1")'>
                                      <if test='@MybatisUtils@isNotEmpty(dangOcStrtdt)'>
                                          AND  SUBSTR(A2.FST_RGST_DTM,1,8) <![CDATA[ >= ]]> TRIM(#{dangOcStrtdt}) /* 위험점검내역.최초등록일시 입력한 FROM년월일 */
                                      </if>
                                      <if test='@MybatisUtils@isNotEmpty(dangOcEnddt)'>
                                          AND SUBSTR(A2.FST_RGST_DTM,1,8) <![CDATA[<= ]]> TRIM(#{dangOcEnddt}) /* 위험점검내역.최초등록일시 입력한 TO년월일 */
                                      </if>
                                </if>
                                <if test='@MybatisUtils@equals(srchGbn, "2")'>
                                      <if test='@MybatisUtils@isNotEmpty(dangOcStrtMonth)'>
                                         AND DECODE(LENGTH(A.DANG_OC_STRTDT ), 6, A.DANG_OC_STRTDT ||'01', A.DANG_OC_STRTDT )  <![CDATA[ >= ]]> TRIM(#{dangOcStrtMonth})||'01' /* 위험점검내역.위험발생시작일자 입력한 FROM년월 */
                                      </if>
                                      <if test='@MybatisUtils@isNotEmpty(dangOcEndMonth)'>
                                          AND A2.DANG_OC_STRTDT <![CDATA[<= ]]> TO_CHAR(LAST_DAY(TRIM(#{dangOcEndMonth})||'01'),'YYYYMMDD') /* 위험점검내역.최초등록일시 입력한 TO년월 */
                                      </if>
                                </if>
                            ) AS DANG_ARBIT_LVY_PC_SUM /* [벌점 - 합계점수] */
                         , A.FST_RGST_USR_ID /* [등록자] - 위험점검내역.최초등록사용자ID */
                         , TO_CHAR(TO_DATE(A.FST_RGST_DTM, 'YYYYMMDDHH24MISS'), 'YYYY.MM.DD') AS FST_RGST_DT /* [등록일자] - 위험점검내역.최초등록일시 */
                         , A.DANG_MNGT_PSTN_DV_CD /* 위험점검내역.위험관리직급구분코드 - 월조직,파트너 마감에서 사용하는 코드와 다름 */
                         , A.DANG_ARBIT_OG_ID /* 위험점검내역.위험조치조직ID */
                         , A.DANG_ARBIT_CD /* 위험점검내역.위험조치코드 */
                         , A.DANG_ARBIT_LVY_PC AS DANG_ARBIT_LVY_PC_ORG /* 위험점검내역.위험조치부과점수(ORG) */
                         , SUBSTR(A.FST_RGST_DTM,'1','8') AS FST_RGST_DTM /* 위험점검내역.최초등록일시 */
                         , D2.DGR1_LEVL_OG_CD AS DGR1_LEVL_OG_CD /* 총괄단 - 월 조직/파트너 내역(WITH).1차레벨조직코드 */
                         , D2.DGR2_LEVL_OG_CD AS DGR2_LEVL_OG_CD /* 지역단 - 월 조직/파트너 내역(WITH).2차레벨조직코드 */
                         , D2.DGR3_LEVL_OG_CD AS DGR3_LEVL_OG_CD /* 지점 - 월 조직/파트너 내역(WITH).2차레벨조직코드 */
                         , D2.OG_ID AS OG_ID /* 지점 - 월 조직/파트너 내역(WITH).조직ID */
                         , C2.PSTN_DV_CD AS PSTN_DV_CD /* 직급구분코드 - 월 조직/파트너 내역(WITH).직급구분코드 */
                      FROM TB_SSCT_DANG_CHK_IZ A /* 위험점검내역 */
                     INNER JOIN TB_OGBS_MM_PRTNR_IZ C1 /* 월파트너내역 */
                        ON C1.PRTNR_NO = A.DANG_OJ_PRTNR_NO /* 월파트너내역.파트너번호 = 위험점검내역.위험대상파트너번호 */
                       AND C1.BASE_YM = SUBSTR(A.DANG_OC_STRTDT, 1, 6) /* 월파트너내역.기준년월 = SUBSTR(위험점검내역.위험발생시작일자, 1, 6) */
                       AND C1.DTA_DL_YN = 'N'
                     INNER JOIN TB_OGBS_MM_OG_IZ D1 /* 월조직내역 */
                        ON D1.OG_ID = C1.OG_ID /* 월조직내역.조직ID = 월파트너내역.조직ID */
                       AND D1.BASE_YM = SUBSTR(A.DANG_OC_STRTDT, 1, 6) /* 월조직내역.기준년월 = SUBSTR(위험점검내역.위험발생시작일자, 1, 6) */
                       AND D1.DTA_DL_YN = 'N'
                     INNER JOIN TB_OGBS_MM_PRTNR_IZ C2 /* 월파트너내역 */
                        ON C2.PRTNR_NO = A.DANG_MNGT_PRTNR_NO /* 월파트너내역.파트너번호 = 위험점검내역.위험대상파트너번호 */
                       AND C2.BASE_YM = C1.BASE_YM /* 월파트너내역.기준년월 = 월조직내역.기준년월 */
                       AND C2.DTA_DL_YN = 'N'
                     INNER JOIN TB_OGBS_MM_OG_IZ D2 /* 월조직내역 */
                        ON D2.OG_ID = C2.OG_ID /* 월조직내역.조직ID = 월파트너내역.조직ID */
                       AND D2.BASE_YM = C2.BASE_YM /* 월조직내역.기준년월 = SUBSTR(위험점검내역.위험발생시작일자, 1, 6) */
                       AND D2.DTA_DL_YN = 'N'
                     WHERE 1 = 1
                       AND A.DANG_MNGT_PSTN_DV_CD != 15 /* 위험점검내역.위험관리직급구분코드 != 15 ▶ as-is 조건 15(웰스플레너) 제외 */
                       AND A.DTA_DL_YN = 'N' /* 위험점검내역.데이터삭제여부가 'N'인 건 */
                       /* 조회조건 - 적용기간(등록일자 또는 발생년월) FROM~TO */
                        <if test='@MybatisUtils@equals(srchGbn, "1")'>
                            <if test='@MybatisUtils@isNotEmpty(dangOcStrtdt)'>
                                AND  SUBSTR(A.FST_RGST_DTM,1,8) <![CDATA[ >= ]]> TRIM(#{dangOcStrtdt}) /* 위험점검내역.최초등록일시 입력한 FROM년월일 */
                            </if>
                            <if test='@MybatisUtils@isNotEmpty(dangOcEnddt)'>
                                AND SUBSTR(A.FST_RGST_DTM,1,8) <![CDATA[<= ]]> TRIM(#{dangOcEnddt}) /* 위험점검내역.최초등록일시 입력한 TO년월일 */
                            </if>
                        </if>
                        <if test='@MybatisUtils@equals(srchGbn, "2")'>
                            <if test='@MybatisUtils@isNotEmpty(dangOcStrtMonth)'>
                               AND DECODE(LENGTH(A.DANG_OC_STRTDT ), 6, A.DANG_OC_STRTDT ||'01', A.DANG_OC_STRTDT )  <![CDATA[ >= ]]> TRIM(#{dangOcStrtMonth})||'01' /* 위험점검내역.위험발생시작일자 입력한 FROM년월 */
                            </if>
                            <if test='@MybatisUtils@isNotEmpty(dangOcEndMonth)'>
                                AND A.DANG_OC_STRTDT <![CDATA[<= ]]> TO_CHAR(LAST_DAY(TRIM(#{dangOcEndMonth})||'01'),'YYYYMMDD') /* 위험점검내역.최초등록일시 입력한 TO년월 */
                            </if>
                        </if>
                   )
            SELECT G.DANG_CHK_ID
                 , G.WELLS_OJ_PSTN_RANK_NM /* 구분 */
                 , G.DANG_MNGT_PNTNR_OG_NM /* 소속명 */
                 , G.DANG_MNGT_PNTNR_OG_CD /* 소속코드 */
                 , G.DANG_MNGT_PNTNR_NM /* 성명 */
                 , G.DANG_MNGT_PRTNR_NO /* 사번 */
                 , G.DANG_OJ_PRTNR_NM /* 행위자사번-성명 */
                 , G.DANG_OJ_PRTNR_NO /* 행위자사번-사번 */
                 , G.DANG_OJ_PRTNR_PSTN_DV_NM /* 행위자사번-직급 */
                 , G.DANG_OC_STRTMM /* 벌점-발생년월 */
                 , G.DANG_ARBIT_OG_NM /* 벌점-조치부서 */
                 , G.DANG_CHK_NM /* 벌점-부과내역 */
                 , G.DANG_ARBIT_CD_NM /* 벌점-조치항목 */
                 , G.DANG_UNCVR_CT /* 벌점-부과대상건수 */
                 , G.DANG_ARBIT_LVY_PC /* 벌점-조치결과부과점수 */
                 , G.DANG_ARBIT_LVY_PC_SUM /* 벌점-합계점수 */
                 , G.FST_RGST_USR_ID /* 등록자 */
                 , G.FST_RGST_DT /* 등록일자 */
                 , G.DANG_MNGT_PSTN_DV_CD /* 위험관리직급구분코드 */
                 , G.DANG_ARBIT_OG_ID /* 위험조치조직ID */
                 , G.DANG_ARBIT_CD /* 위험조치코드 */
                 , G.DANG_ARBIT_LVY_PC_ORG /* 위험조치부과점수(계산하기전) */
                 , G.FST_RGST_DTM /* 최초등록일시 */
                 , G.DGR1_LEVL_OG_CD /* 1차레벨조직코드 */
                 , G.DGR2_LEVL_OG_CD /* 2차레벨조직코드 */
                 , G.DGR3_LEVL_OG_CD /* 3차레벨조직코드 */
                 , G.OG_ID /* 조직ID */
                 , 5 AS SORT_ORD /* 정렬순번 */
                 , G.PSTN_DV_CD /* 직급구분코드 */
                 , G.DANG_OJ_PRTNR_PSTN_DV_CD /* 행위자직급코드*/
              FROM TB_TEST G
             WHERE 1=1
                <if test='@MybatisUtils@isNotEmpty(gnrdv)'>
                    AND TRIM(G.DGR1_LEVL_OG_CD) LIKE #{gnrdv}||'%' /* 조회조건 - 총괄단 - 1차레벨조직 */
                </if>
                <if test='@MybatisUtils@isNotEmpty(rgrp)'>
                    AND TRIM(G.DGR2_LEVL_OG_CD) LIKE SUBSTR(#{rgrp},1,3)||'%' /* 조회조건 - 지역단 - 2차레벨조직 */
                </if>
                <if test='@MybatisUtils@isNotEmpty(brch)'>
                    AND TRIM(G.DGR3_LEVL_OG_CD) LIKE #{brch}||'%' /* 조회조건 - 지점 - 3차레벨조직 */
                </if>
                <if test='@MybatisUtils@isNotEmpty(dangOjPrtnrNo)'>
                    AND TRIM(G.DANG_MNGT_PRTNR_NO) LIKE #{dangOjPrtnrNo}||'%' /* 조회조건 - 사번 - 위험점검내역.위험관리파트너번호 */
                </if>
                <if test='@MybatisUtils@isNotEmpty(dangMngtPrtnrNo)'>
                    AND TRIM(G.DANG_MNGT_PSTN_DV_CD) LIKE #{dangMngtPrtnrNo}||'%' /* 조회조건 - 직위구분 - 위험점검내역.위험관리직급구분코드 */
                </if>
            UNION ALL
            SELECT
                   '' AS DANG_CHK_ID
                 , AFMDBS.F_CMZ_CD_NM('TNT_WELLS', 'WELLS_OJ_PSTN_RANK_CD', TRIM(B.PSTN_DV_CD)) AS WELLS_OJ_PSTN_RANK_NM  /* 구분 - 직급구분명 */

                 , B.OG_NM AS DANG_MNGT_PNTNR_OG_NM /* 소속명 - 조직명*/
                 , B.OG_CD AS DANG_MNGT_PNTNR_OG_CD /* 소속코드 - 조직코드*/
                 , B.PRTNR_KNM AS DANG_MNGT_PNTNR_NM /* 성명 - 파트너한글명 */
                 , A.OG_PRTNR_NO AS DANG_MNGT_PRTNR_NO /* 사번 - 1/2/3차 레벨 대표 파트너번호, 영업지원 파트너 번호 (총괄단,지역단,지점,영업지원파트너 번호 ) */
                 , NULL AS DANG_OJ_PRTNR_NM /* 행위자사번-성명 */
                 , NULL AS DANG_OJ_PRTNR_NO /* 행위자사번-사번 */
                 , NULL AS DANG_OJ_PRTNR_PSTN_DV_NM /* 행위자사번-직급 */
                 , NULL AS DANG_OC_STRTMM /* 벌점-빌셍년월 */
                 , NULL AS DANG_ARBIT_OG_NM /* 벌점-조치부서 */
                 , NULL AS DANG_CHK_NM /* 벌점-부과내역 */
                 , NULL AS DANG_ARBIT_CD_NM /* 벌점-조치상목 */
                 , NULL AS DANG_UNCVR_CT /* 벌점-부과대상건수 */
                 , NULL AS DANG_ARBIT_LVY_PC /* 벌점-조치결과부과점수 */
                 , NULL AS DANG_ARBIT_LVY_PC_SUM /* 벌점-합계점수 */
                 , NULL AS FST_RGST_USR_ID /* 등록자 */
                 , NULL AS FST_RGST_DT /* 등록일자 */
                 , NULL AS DANG_MNGT_PSTN_DV_CD /* 위험관리직급구분코드 */
                 , NULL AS DANG_ARBIT_OG_ID /* 위험조치조직ID */
                 , NULL AS DANG_ARBIT_CD /* 위험조치코드 */
                 , NULL AS DANG_ARBIT_LVY_PC_ORG /* 위험조치부과점수(계산전) */
                 , NULL AS FST_RGST_DTM /* 최초등록일시 */
                 , NULL AS DGR1_LEVL_OG_CD /* 1차레벨조직코드 */
                 , NULL AS DGR2_LEVL_OG_CD /* 2차레벨조직코드 */
                 , NULL AS DGR3_LEVL_OG_CD /* 3차레벨조직코드 */
                 , B.OG_ID /* 조직ID*/
                 , A.SORT_ODR AS SORT_ORD /* 정렬순번 */
                 , B.PSTN_DV_CD /* 직급구분코드 */
                 , NULL AS DANG_OJ_PRTNR_PSTN_DV_CD /* 행위자직급코드 */
              FROM
                   (
                    SELECT B.OG_PRTNR_NO AS OG_PRTNR_NO /* 1/2/3차 레벨 대표 파트너번호, 영업지원 파트너 번호 (총괄단,지역단,지점,영업지원파트너 번호 ) */
                         , B.SORT_ODR AS SORT_ODR /* 정렬순서 */
                      FROM
                           (
                            SELECT A.DGR1_LEVL_DG_PRTNR_NO AS OG_PRTNR_NO /* 월조직내역.1차레벨대표파트너번호 - 총괄단 */
                                 , 1 AS SORT_ODR /* 정렬순서 */
                              FROM TB_OGBS_MM_OG_IZ A /* 월조직내역 - 월조직내역 TABLE의 1~5차 레벨 조직ID가 없으므로 별도로 조회 */
                             WHERE 1=1
                               AND A.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM') /* 월조직내역.기준년월 = 현재월 */
                               AND NVL(A.DTA_DL_YN, 'N') = 'N' /* 월조직내역.데이터삭제여부가 'N'인 건 */
                               AND A.OG_TP_CD LIKE 'W%' /* 월조직내역의 조직유형코드 'W'로 시작 하는 건 - ▷임시처리 조직유형코드 적용 확정 이후 수정 필요 */
                            UNION ALL
                            SELECT A.DGR2_LEVL_DG_PRTNR_NO AS OG_PRTNR_NO /* 월조직내역.2차레벨대표파트너번호 - 지역단 */
                                 , 2 AS SORT_ODR /* 정렬순서 */
                              FROM TB_OGBS_MM_OG_IZ A /* 월조직내역 - 월조직내역 TABLE의 1~5차 레벨 조직ID가 없으므로 별도로 조회 */
                             WHERE 1=1
                               AND A.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM') /* 월조직내역.기준년월 = 현재월 */
                               AND NVL(A.DTA_DL_YN, 'N') = 'N' /* 월조직내역.데이터삭제여부가 'N'인 건 */
                               AND A.OG_TP_CD LIKE 'W%' /* 월조직내역의 조직유형코드 'W'로 시작 하는 건 - ▷임시처리 조직유형코드 적용 확정 이후 수정 필요 */
                            UNION ALL
                            SELECT A.DGR3_LEVL_DG_PRTNR_NO AS OG_PRTNR_NO /* 월조직내역.3차레벨대표파트너번호 - 지점 */
                                 , 3 AS SORT_ODR /* 정렬순서 */
                              FROM TB_OGBS_MM_OG_IZ A /* 월조직내역 - 월조직내역 TABLE의 1~5차 레벨 조직ID가 없으므로 별도로 조회 */
                             WHERE 1=1
                               AND A.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM') /* 월조직내역.기준년월 = 현재월 */
                               AND NVL(A.DTA_DL_YN, 'N') = 'N' /* 월조직내역.데이터삭제여부가 'N'인 건 */
                               AND A.OG_TP_CD LIKE 'W%' /* 월조직내역의 조직유형코드 'W'로 시작 하는 건 - ▷임시처리 조직유형코드 적용 확정 이후 수정 필요 */
                            UNION ALL
                            SELECT A.OG_UPBRNG_PRTNR_NO AS OG_PRTNR_NO /* 월조직내역.조직육성파트너번호(영업지원파트너번호) */
                                 , 4 AS SORT_ODR /* 정렬순서 */
                              FROM TB_OGBS_MM_OG_IZ A /* 월조직내역 - 월조직내역 TABLE의 1~5차 레벨 조직ID가 없으므로 별도로 조회 */
                             WHERE 1=1
                               AND A.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM') /* 월조직내역.기준년월 = 현재월 */
                               AND NVL(A.DTA_DL_YN, 'N') = 'N' /* 월조직내역.데이터삭제여부가 'N'인 건 */
                               AND A.OG_TP_CD LIKE 'W%' /* 월조직내역의 조직유형코드 'W'로 시작 하는 건 - ▷임시처리 조직유형코드 적용 확정 이후 수정 필요 */
                           ) B
                     GROUP BY B.OG_PRTNR_NO, B.SORT_ODR
                   ) A /* 조직-관리자 InLineView */
             INNER JOIN TB_OGBS_MM_PRTNR_IZ B/* 월파트너내역 */
                ON B.PRTNR_NO = A.OG_PRTNR_NO /* 월파트너내역.파트너번호 =  조직-관리자 InLineView.파트너번호 */
               AND B.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM') /* 월파트너내역.기준년월 = 현재월 */
               AND NVL(B.DTA_DL_YN, 'N') = 'N' /* 월파트너내역.데이터삭제여부가 'N'인 건 */
               AND B.OG_TP_CD LIKE 'W%' /* 월조직내역의 조직유형코드 'W'로 시작 하는 건 - ▷임시처리 조직유형코드 적용 확정 이후 수정 필요 */
            INNER JOIN TB_OGBS_MM_OG_IZ B2
               ON B2.OG_ID = B.OG_ID
            WHERE 1=1
              AND NOT EXISTS (
                  SELECT G.DANG_MNGT_PRTNR_NO FROM TB_TEST G
                   WHERE G.DANG_MNGT_PNTNR_OG_CD = B.OG_CD
                     AND G.DANG_MNGT_PRTNR_NO = A.OG_PRTNR_NO)
                <if test='@MybatisUtils@isNotEmpty(gnrdv)'>
                    AND TRIM(B2.DGR1_LEVL_OG_CD) LIKE #{gnrdv}||'%' /* 조회조건 - 총괄단 - 1차레벨조직 */
                </if>
                <if test='@MybatisUtils@isNotEmpty(rgrp)'>
                    AND TRIM(B2.DGR2_LEVL_OG_CD) LIKE SUBSTR(#{rgrp},1,3)||'%' /* 조회조건 - 지역단 - 2차레벨조직 */
                </if>
                <if test='@MybatisUtils@isNotEmpty(brch)'>
                    AND TRIM(B2.DGR3_LEVL_OG_CD) LIKE #{brch}||'%' /* 조회조건 - 지점 - 3차레벨조직 */
                </if>
                <if test='@MybatisUtils@isNotEmpty(dangOjPrtnrNo)'>
                    AND TRIM(A.OG_PRTNR_NO) LIKE #{dangOjPrtnrNo}||'%' /* 조회조건 - 사번 - 위험점검내역.위험관리파트너번호 */
                </if>
                <if test='@MybatisUtils@isNotEmpty(dangMngtPrtnrNo)'>
                    AND TRIM(B.PSTN_DV_CD) LIKE #{dangMngtPrtnrNo}||'%' /* 조회조건 - 직위구분 - 위험점검내역.위험관리직급구분코드 */
                </if>
           ) H
     GROUP BY H.DANG_MNGT_PNTNR_OG_CD /* 소속코드 - 조직코드*/
            , H.DANG_MNGT_PRTNR_NO /* 사번 - 1/2/3차 레벨 대표 파트너번호, 영업지원 파트너 번호 (총괄단,지역단,지점,영업지원파트너 번호 ) */
            , H.DANG_OJ_PRTNR_NO /* 행위자사번 */
     ORDER BY DANG_MNGT_PNTNR_OG_CD /* 소속코드 - 조직코드*/
            , PSTN_DV_CD /* 직급구분코드 */ --DANG_MNGT_PSTN_DV_CD /* 위험관리직급구분코드 */
            , DANG_MNGT_PNTNR_NM /* 성명-연계자 */
            , DANG_OJ_PRTNR_PSTN_DV_CD /* 행위자직급코드 */
            , DANG_OJ_PRTNR_NM /* 행위자성명*/
    </select>
    <update id="updateDangerCheckIz">
        UPDATE TB_SSCT_DANG_CHK_IZ
           SET DTA_DL_YN = 'Y'
         WHERE DANG_CHK_ID = #{dangChkId}
    </update>
    <update id="updateDangerCheckChHist">
        UPDATE TB_SSCT_DANG_CHK_CH_HIST
           SET DTA_DL_YN = 'Y'
         WHERE HIST_END_DTM = '99991231235959'
            AND DANG_CHK_ID = #{dangChkId}
    </update>
    <insert id="insertDangerCheckChHist">
        INSERT INTO TB_SSCT_DANG_CHK_CH_HIST(
            DANG_CHK_ID
            ,HIST_STRT_DTM
            ,HIST_END_DTM
            ,DANG_OJ_PRTNR_NO
            ,DANG_MNGT_PRTNR_NO
            ,DANG_OJ_OG_ID
            ,DANG_OJ_PSTN_DV_CD
            ,DANG_MNGT_PSTN_DV_CD
            ,DANG_GD_CD
            ,DANG_UNCVR_CT
            ,DANG_CHK_NM
            ,DANG_CHK_DT
            ,DANG_UNCVR_CN
            ,DANG_OC_STRTDT
            ,DANG_OC_ENDDT
            ,DANG_ARBIT_DT
            ,DANG_ARBIT_CD
            ,DANG_ARBIT_LVY_PC
            ,DANG_ARBIT_OG_ID
            ,DANG_ARBIT_CN
            ,DCPLA_RS_CN
            ,DCPLA_RIMB_AMT
            ,DTA_DL_YN
            <include refid="COMMON.insertSystemField" />
        ) SELECT
            DANG_CHK_ID
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , '99991231235959'
            ,DANG_OJ_PRTNR_NO
            ,DANG_MNGT_PRTNR_NO
            ,DANG_OJ_OG_ID
            ,DANG_OJ_PSTN_DV_CD
            ,DANG_MNGT_PSTN_DV_CD
            ,DANG_GD_CD
            ,DANG_UNCVR_CT
            ,DANG_CHK_NM
            ,DANG_CHK_DT
            ,DANG_UNCVR_CN
            ,DANG_OC_STRTDT
            ,DANG_OC_ENDDT
            ,DANG_ARBIT_DT
            ,DANG_ARBIT_CD
            ,DANG_ARBIT_LVY_PC
            ,DANG_ARBIT_OG_ID
            ,DANG_ARBIT_CN
            ,DCPLA_RS_CN
            ,DCPLA_RIMB_AMT
            ,DTA_DL_YN
            <include refid="COMMON.insertSystemFieldValue" />
            FROM TB_SSCT_DANG_CHK_IZ
            WHERE DANG_CHK_ID = #{dangChkId}
    </insert>
</mapper>
