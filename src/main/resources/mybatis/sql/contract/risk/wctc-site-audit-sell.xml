<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.risk.mapper.WctcSiteAuditSellMapper">
    <select id="selectSiteAuditSellPages" resultType="com.kyowon.sms.wells.web.contract.risk.dto.WctcSiteAuditSellDto$SearchRes">
        SELECT I1.DGR1_LEVL_OG_CD
             , I1.DGR2_LEVL_OG_CD
             , I1.DGR3_LEVL_OG_CD
             , COUNT(B1.CNTR_NO) AS PERF_CNT /* 실적건수 */
          FROM TB_SSCT_CNTR_BAS A1/* 계약기본 */
         INNER JOIN TB_SSCT_CNTR_DTL B1 /* 계약상세 */
            ON B1.CNTR_NO = A1.CNTR_NO
           AND B1.DTA_DL_YN = 'N'
           AND A1.DTA_DL_YN = 'N'
         INNER JOIN LATERAL
             (
              SELECT D1.PRTNR_NO /* 월파트너내역.파트너번호 */
                   , D1.PRTNR_KNM /* 월파트너내역.파트너한글명 */
                   , D1.PSTN_DV_CD /* 월파트너내역.직급구분코드 */
                   , AFMDBS.F_CMZ_CD_NM('TNT_WELLS', 'PSTN_DV_CD', D1.PSTN_DV_CD) AS PSTN_DV_NM /* 직급구분명 */
                   , D1.RSB_DV_CD /* 직책구분코드 */
                   , D1.ROL_DV_CD /* 직무구분코드 */
                   , E1.DGR1_LEVL_OG_CD /* 월조직내역.1차레벨조직코드 - 총괄단 */
                   , E1.DGR1_LEVL_OG_NM /* 월조직내역.1차레벨조직명 - 총괄단 */
                   , E1.DGR1_LEVL_DG_PRTNR_NO /* 월조직내역.1차레벨대표파트너번호 - 총괄단 */
                   , E1.DGR1_LEVL_OG_ID /* 1차레벨조직ID */
                   , E1.DGR1_LEVL_DG_PRTNR_NM /* 1차레벨대표파트너명 */
                   , E1.DGR2_LEVL_OG_CD /* 월조직내역.2차레벨조직코드 - 지역단 */
                   , E1.DGR2_LEVL_OG_NM /* 월조직내역.2차레벨조직명 - 지역단 */
                   , E1.DGR2_LEVL_DG_PRTNR_NO /* 월조직내역.2차레벨대표파트너번호 - 지역단 */
                   , E1.DGR2_LEVL_OG_ID /* 2차레벨조직ID */
                   , E1.DGR2_LEVL_DG_PRTNR_NM /* 2차레벨대표파트너명 */
                   , E1.DGR3_LEVL_OG_CD /* 월조직내역.3차레벨조직코드 - 지점 */
                   , E1.DGR3_LEVL_OG_NM /* 월조직내역.3차레벨조직명 - 지점 */
                   , E1.DGR3_LEVL_DG_PRTNR_NO /* 월조직내역.3차레벨대표파트너번호 - 지점 */
                   , E1.DGR3_LEVL_OG_ID /* 3차레벨조직ID */
                   , E1.DGR3_LEVL_DG_PRTNR_NM /* 3차레벨대표파트너명 */
                   , E1.DGR4_LEVL_OG_CD /* 월조직내역.4차레벨조직코드 */
                   , E1.DGR4_LEVL_OG_NM /* 월조직내역.4차레벨조직명 */
                   , E1.DGR4_LEVL_DG_PRTNR_NO /* 월조직내역.4차레벨대표파트너번호 */
                   , E1.DGR4_LEVL_OG_ID /* 4차레벨조직ID */
                   , E1.DGR4_LEVL_DG_PRTNR_NM /* 4차레벨대표파트너명 */
                   , E1.DGR5_LEVL_OG_CD /* 월조직내역.5차레벨조직코드 */
                   , E1.DGR5_LEVL_OG_NM /* 월조직내역.5차레벨조직명 */
                   , E1.DGR5_LEVL_DG_PRTNR_NO /* 월조직내역.5차레벨대표파트너번호 */
                   , E1.DGR5_LEVL_OG_ID /* 5차레벨조직ID */
                   , E1.BIZ_SPPT_PRTNR_NO /* 월조직내역.업무지원파트너번호 */
                   , E1.OG_UPBRNG_PRTNR_NO /* 월조직내역.조직육성파트너번호(영업지원파트너번호)-BM */
                   , E1.OG_CD /* 월조직내역.조직코드 */
                   , E1.OG_ID /* 월조직내역.조직ID */
                   , E1.OG_NM /* 월조직내역.조직명 */
                   , E1.BASE_YM /* 월조직내역.기준년월 */
                   , E1.OG_TP_CD /* 월조직내역.조직유형코드 */
                   , E1.BLD_CD /* 빌딩코드 */
                   , E1.BLD_NM /* 빌딩명 */
                FROM TB_OGBS_MM_PRTNR_IZ D1 /* 월파트너내역 */
               INNER JOIN TB_OGBS_MM_OG_IZ E1/* 월조직내역 */
                  ON D1.BASE_YM = E1.BASE_YM /* 월파트너내역.기준년월 = 월조직내역.기준년월 */
                 AND D1.OG_ID = E1.OG_ID /* 월조직내역.조직ID = 월파트너내역.조직ID */
                 AND D1.OG_TP_CD = E1.OG_TP_CD /* 월조직내역.조직유형코드 = 월파트너내역.조직유형코드 */
                 AND D1.DTA_DL_YN = 'N'/* 월파트너내역.데이터삭제여부가 'N'인 건 */
                 AND E1.DTA_DL_YN = 'N' /* 월조직내역.데이터삭제여부가 'N'인 건 */
               WHERE E1.BASE_YM = SUBSTR(A1.CNTR_CNFM_DTM, 1, 6)
                 AND E1.OG_TP_CD = A1.SELL_OG_TP_CD
                 AND D1.PRTNR_NO = A1.SELL_PRTNR_NO
             ) I1
            ON I1.OG_TP_CD = A1.SELL_OG_TP_CD
           AND I1.PRTNR_NO = A1.SELL_PRTNR_NO
         INNER JOIN TB_SSCT_CNTR_WELLS_DTL C1 /* 계약WELLS상세 */
            ON C1.CNTR_NO = B1.CNTR_NO
           AND C1.CNTR_SN = B1.CNTR_SN
           AND C1.DTA_DL_YN = 'N'
         INNER JOIN TB_PDBS_PD_BAS S2
            ON S2.PD_CD = B1.BASE_PD_CD
           AND S2.TEMP_SAVE_YN = 'N'
           AND S2.DTA_DL_YN = 'N'
         WHERE 1=1
    <choose>
        <when test="@MybatisUtils@equals(ptrmDv, '1')">
           AND A1.CNTR_RCP_FSH_DTM BETWEEN #{dtStrt}||'000000' AND #{dtEnd}||'235959'
        </when>
        <when test="@MybatisUtils@equals(ptrmDv, '2')">
           AND C1.IST_DT BETWEEN #{dtStrt}||'000000' AND #{dtEnd}||'235959'
        </when>
    </choose>
        <if test="@MybatisUtils@isNotEmpty(dgr1LevlOgCd)">
           AND I1.DGR1_LEVL_OG_CD = #{dgr1LevlOgCd}   /* 총괄단조건(1차레벨조직코드) */
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr2LevlOgCd)">
           AND I1.DGR2_LEVL_OG_CD = #{dgr2LevlOgCd}   /* 지역단조건(2차레벨조직코드)*/
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr3LevlOgCd)">
           AND I1.DGR3_LEVL_OG_CD = #{dgr3LevlOgCd}   /* 지점조건(3차레벨조직코드)*/
        </if>
        <if test="@MybatisUtils@isNotEmpty(sellPrtnrNo)">
           AND A1.SELL_PRTNR_NO = #{sellPrtnrNo}      /* 판매파트너조건 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cntrStatCd)">
           AND B1.CNTR_DTL_STAT_CD = #{cntrStatCd}    /* 상태구분(계약상세상태코드) - 001(정상), 002(정지), 003(해약), 004(종료) */
        </if>
        <if test="@MybatisUtils@isNotEmpty(sellTpCd)">
           AND B1.SELL_TP_CD = #{sellTpCd}            /* 판매구분조건(판매유형코드) - 1(일시불), 2(렌탈/리스), 3(멤버십), 4(회사설치), 5(유지관리), 6(정기배송), 9(필터)) */
        </if>
        <if test="@MybatisUtils@isNotEmpty(sellTpDtlCd)">
           AND B1.SELL_TP_DTL_CD = #{sellTpDtlCd}     /* 판매유형조건(판매유형상세코드) */
        </if>
        <if test="@MybatisUtils@isNotEmpty(pdMclsfId)">
           AND S2.PD_MCLSF_ID = #{pdMclsfId}          /* 제품군조건(상품중분류ID)  */
        </if>
         GROUP BY I1.DGR1_LEVL_OG_CD, I1.DGR2_LEVL_OG_CD, I1.DGR3_LEVL_OG_CD
    </select>

</mapper>

