<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.risk.mapper.WctcDangerArbitMapper">
    <select id="selectDangerArbitManagerial" resultType="com.kyowon.sms.wells.web.contract.risk.dto.WctcDangerArbitDto$SearchRes">
        SELECT G.DANG_CHK_ID    /* 위험점검ID */
             , G.DANG_OJ_PRTNR_NO /* 행위자사번-사번 */
             , G.DANG_OC_STRTDT /* 행위자사번-발생년월 */
             , G.DANG_OJ_OG_ID /* 행위자사번-소속 */
             , G.DANG_OJ_PRTNR_NM /* 행위자사번-성명 */
             , G.DANG_OJ_PRTNR_PSTN_DV_NM /* 행위자사번-직급 */
             , G.DGR1_LEVL_DG_PRTNR_NM /*소속-총괄단*/
             , G.DGR2_LEVL_DG_PRTNR_NM /*소속-지역단*/
             , G.DGR3_LEVL_DG_PRTNR_NM /*소속- BM*/
             , G.DGR4_LEVL_DG_PRTNR_NM /*소속-지점*/
             , G.DANG_CHK_NM /* 벌점-부과내역 */
             , G.DANG_ARBIT_CD_NM /* 벌점-조치항목 */
             , G.DANG_UNCVR_CT /* 벌점-부과대상건수 */
             , G.DANG_ARBIT_LVY_PC /* 벌점-조치결과부과점수 */
             , G.DANG_ARBIT_OG_NM /* 벌점-조치부서 */
             , G.FST_RGST_USR_ID /* 등록자 */
             , G.FST_RGST_DT /* 등록일자 */
         FROM (
         WITH TB_OGBS_MM AS (
            SELECT D.PSTN_DV_CD /*월파트너내역.직급구분코드*/
             , D.PRTNR_NO /* 월파트너내역.파트너번호 */
             , D.PRTNR_KNM /* 월파트너내역.파트너한글명 */
             , D.PSTN_DV_CD /* 월파트너내역.직급구분코드 */
             , AFMDBS.F_CMZ_CD_NM('TNT_WELLS', 'PSTN_DV_CD', D.PSTN_DV_CD) AS PSTN_DV_NM /* 직급구분명 */
             , C.DGR1_LEVL_OG_CD /* 월조직내역.1차레벨조직코드 - 총괄단 */
             , C.DGR1_LEVL_OG_NM /* 월조직내역.1차레벨조직명 - 총괄단 */
             , C.DGR1_LEVL_DG_PRTNR_NO /* 월조직내역.1차레벨대표파트너번호 - 총괄단 */
             , (
                SELECT MAX(F.OG_ID)
                  FROM WSMDBS.TB_OGBS_OG_BAS F /* 조직기본 */
                 WHERE F.DTA_DL_YN != 'Y' /* 조직기본.데이터삭제여부가 'Y'가 아닌 건*/
                   AND F.OG_CD = C.DGR1_LEVL_OG_CD /* 조직기본.조직ID = 월조직내역.1차레벨조직코드 */
               ) AS DGR1_LEVL_OG_ID /* 1차레벨조직ID */
             , C.DGR2_LEVL_OG_CD /* 월조직내역.2차레벨조직코드 - 지역단 */
             , C.DGR2_LEVL_OG_NM /* 월조직내역.2차레벨조직명 - 지역단 */
             , C.DGR2_LEVL_DG_PRTNR_NO /* 월조직내역.2차레벨대표파트너번호 - 지역단 */
             , (
                SELECT MAX(F.OG_ID)
                  FROM WSMDBS.TB_OGBS_OG_BAS F /* 조직기본 */
                 WHERE F.DTA_DL_YN != 'Y' /* 조직기본.데이터삭제여부가 'Y'가 아닌 건*/
                   AND F.OG_CD = C.DGR2_LEVL_OG_CD /* 조직기본.조직ID = 월조직내역.2차레벨조직코드 */
               ) AS DGR2_LEVL_OG_ID /* 2차레벨조직ID */
             , C.DGR3_LEVL_OG_CD /* 월조직내역.3차레벨조직코드 - 지점 */
             , C.DGR3_LEVL_OG_NM /* 월조직내역.3차레벨조직명 - 지점 */
             , C.DGR3_LEVL_DG_PRTNR_NO /* 월조직내역.3차레벨대표파트너번호 - 지점 */
             , (
                SELECT MAX(F.OG_ID)
                  FROM WSMDBS.TB_OGBS_OG_BAS F /* 조직기본 */
                 WHERE F.DTA_DL_YN != 'Y' /* 조직기본.데이터삭제여부가 'Y'가 아닌 건*/
                   AND F.OG_CD = C.DGR3_LEVL_OG_CD /* 조직기본.조직ID = 월조직내역.3차레벨조직코드 */
               ) AS DGR3_LEVL_OG_ID /* 3차레벨조직ID */
             , C.DGR4_LEVL_OG_CD /* 월조직내역.4차레벨조직코드 */
             , C.DGR4_LEVL_OG_NM /* 월조직내역.4차레벨조직명 */
             , C.DGR4_LEVL_DG_PRTNR_NO /* 월조직내역.4차레벨대표파트너번호 */
             , (
                SELECT MAX(F.OG_ID)
                  FROM WSMDBS.TB_OGBS_OG_BAS F /* 조직기본 */
                 WHERE F.DTA_DL_YN != 'Y' /* 조직기본.데이터삭제여부가 'Y'가 아닌 건*/
                   AND F.OG_CD = C.DGR4_LEVL_OG_CD /* 조직기본.조직ID = 월조직내역.4차레벨조직코드 */
               ) AS DGR4_LEVL_OG_ID /* 4차레벨조직ID */
             , C.DGR5_LEVL_OG_CD /* 월조직내역.5차레벨조직코드 */
             , C.DGR5_LEVL_OG_NM /* 월조직내역.5차레벨조직명 */
             , C.DGR5_LEVL_DG_PRTNR_NO /* 월조직내역.5차레벨대표파트너번호 */
             , (
                SELECT MAX(F.OG_ID)
                  FROM WSMDBS.TB_OGBS_OG_BAS F /* 조직기본 */
                 WHERE F.DTA_DL_YN != 'Y' /* 조직기본.데이터삭제여부가 'Y'가 아닌 건*/
                   AND F.OG_CD = C.DGR5_LEVL_OG_CD /* 조직기본.조직ID = 월조직내역.5차레벨조직코드 */
               ) AS DGR5_LEVL_OG_ID /* 5차레벨조직ID */
             , C.BIZ_SPPT_PRTNR_NO /* 월조직내역.업무지원파트너번호 */
             , C.OG_CD /* 월조직내역.조직코드 */
             , C.OG_ID /* 월조직내역.조직ID */
             , C.OG_NM /* 월조직내역.조직명 */
             , C.BASE_YM /* 월조직내역.기준년월 */
            FROM WSMDBS.TB_OGBS_MM_OG_IZ C/* 월조직내역 - 월조직내역 TABLE의 1~5차 레벨 조직ID가 없으므로 별도로 조회 */
                INNER JOIN WSMDBS.TB_OGBS_MM_PRTNR_IZ D /* 월파트너내역 */
                   ON D.BASE_YM = C.BASE_YM /* 월파트너내역.기준년월 = 월조직내역.기준년월 */
                  AND D.OG_ID = C.OG_ID /* 월조직내역.조직ID = 월파트너내역.조직ID */
                WHERE 1=1
                  AND C.DTA_DL_YN != 'Y' /* 월조직내역.데이터삭제여부가 'Y'가 아닌 건 */
                  AND D.DTA_DL_YN != 'Y' /* 월조직내역.데이터삭제여부가 'Y'가 아닌 건*/
                <if test='@MybatisUtils@equals(searchGubun, "1")'>
                  AND C.BASE_YM <![CDATA[ >= ]]> SUBSTR(#{startDate}, 1, 6)
                  AND C.BASE_YM <![CDATA[ <= ]]> SUBSTR(#{endDate}, 1, 6)
                </if>
                <if test='@MybatisUtils@equals(searchGubun, "2")'>
                  AND C.BASE_YM <![CDATA[ >= ]]> TRIM(#{startMonth})
                  AND C.BASE_YM <![CDATA[ <= ]]> TRIM(#{endMonth})
                </if>
               )
                SELECT  A.DANG_CHK_ID   /* 위험점검ID */
                    , A.DANG_OJ_PRTNR_NO /* [행위자사번- 사번] - 위험점검내역.위험대상파트너번호 */
                    , A.DANG_OC_STRTDT /* [벌점 - 발생년월] - SUBSTR(위험점검내역.위험발생시작일자,1,6) */
                    , A.DANG_OJ_OG_ID /* 행위자사번-소속 */
                    , (
                        SELECT PRTNR_KNM /* 파트너한글명 */
                          FROM TB_OGBS_MM E /* 월 조직/파트너 마감(WITH) */
                         WHERE E.PRTNR_NO = A.DANG_OJ_PRTNR_NO /* 월 조직/파트너 마감(WITH).파트너번호 = 위험점검내역.위험대상파트너번호 */
                          AND E.BASE_YM = SUBSTR(A.DANG_OC_STRTDT, 1, 6) /* 월 조직/파트너 마감(WITH).기준년월 = SUBSTR(위험점검내역.위험발생시작일자, 1, 6) */
                       ) AS DANG_OJ_PRTNR_NM /* [행위자사번 - 성명] - 월 조직/파트너 마감(WITH).파트너한글명 */
                    , (
                        SELECT PSTN_DV_NM /* 직급구분명 */
                          FROM TB_OGBS_MM E /* 월 조직/파트너 마감(WITH) */
                         WHERE E.PRTNR_NO = A.DANG_OJ_PRTNR_NO /* 월 조직/파트너 마감(WITH).파트너번호 = 위험점검내역.위험대상파트너번호 */
                          AND E.BASE_YM = SUBSTR(A.DANG_OC_STRTDT, 1, 6) /* 월 조직/파트너 마감(WITH).기준년월 = SUBSTR(위험점검내역.위험발생시작일자, 1, 6) */
                       ) AS DANG_OJ_PRTNR_PSTN_DV_NM /* [행위자사번 - 직급] - 월 조직/파트너 마감(WITH).직급구분명 */
                    , C.DGR1_LEVL_DG_PRTNR_NM /* [ 소속 - 총괄단 ] 월조직내역.1차레벨대표파트너명 */
                    , C.DGR2_LEVL_DG_PRTNR_NM /* [ 소속 - 지역단 ] 월조직내역.2차레벨대표파트너명 */
                    , C.DGR3_LEVL_DG_PRTNR_NM /* [ 소속 - BM ] 월조직내역.3차레벨대표파트너명 */
                    , C.DGR4_LEVL_DG_PRTNR_NM /* [ 소속 - 지점 ] 월조직내역.4차레벨대표파트너명 */
                    , A.DANG_CHK_NM /* [벌점 - 부과내역] - 위험점검내역.위험점검명 */
                    , B.DANG_ARBIT_CD_NM /* [벌점 - 조치항목] - 위험조치코드.위험조치코드명 */
                    , A.DANG_UNCVR_CT /* [벌점 - 부과대상건수] - 위험점검내역.위험적발건수 */
                    , CASE WHEN A.DANG_MNGT_PSTN_DV_CD = '5' /* 위험점검내역.위험관리직급구분코드 = 5(업무지원매니저-BM) */
                                 THEN TRUNC(NVL(A.DANG_ARBIT_LVY_PC,0) * 0.5, 1) /* TRUNC(위험점검내역.위험조치부과점수 * 0.5,1) */
                            ELSE NVL(A.DANG_ARBIT_LVY_PC,0)
                       END DANG_ARBIT_LVY_PC /* [벌점 - 조치결과 부과점수] */
                    ,(
                        SELECT C.OG_NM
                          FROM WSMDBS.TB_OGBS_MM_OG_IZ C/* 월조직내역 */
                         WHERE C.BASE_YM = SUBSTR(A.DANG_OC_STRTDT, 1, 6) /* 월조직내역.기준년월 = SUBSTR(위험점검내역.위험발생시작일자, 1, 6) */
                           AND C.OG_ID = A.DANG_ARBIT_OG_ID /* 월조직내역.조직ID = 위험점검내역.위험조치조직ID  */
                       ) AS DANG_ARBIT_OG_NM /* [벌점 - 조치부서] - 월조직내역.조직명 */
                    , A.FST_RGST_USR_ID /* [등록자] - 위험점검내역.최초등록사용자ID */
                        , SUBSTR(A.FST_RGST_DTM,0,6) AS FST_RGST_DT /* [등록일자] - 위험점검내역.최초등록일시 */
                FROM WSMDBS.TB_SSCT_DANG_CHK_IZ A /* 위험점검내역 */
                LEFT OUTER JOIN WSMDBS.TB_SSCT_DANG_ARBIT_CD B /* 위험조치코드 */
                        ON B.DANG_ARBIT_CD = A.DANG_ARBIT_CD /* 위험조치코드.위험조치코드 = 위험점검내역.위험조치코드*/
                       AND B.DTA_DL_YN != 'Y' /* 위험조치코드.데이터삭제여부가 'Y'가 아닌 건*/
                       /* 위험조치코드 유효시작일시, 유효종료일시는 위험점검내역 위험 */
                       AND B.VL_STRT_DTM <![CDATA[ >= ]]>A.DANG_OC_STRTDT /* 위험조치코드.유효시작일시 >= 위험점검내역.위험발생시작일자 */
                       AND B.VL_END_DTM <![CDATA[ <= ]]> A.DANG_OC_ENDDT /* 위험조치코드.유효종료일시 >= 위험점검내역.위험발생종료일자 */
                LEFT OUTER JOIN TB_OGBS_MM_OG_IZ C  /* 월조직내역 */
                    ON A.DANG_OJ_OG_ID = C.OG_ID /* 위험점검내역.위험대상조직ID >= 월조직내역.조직ID */
                WHERE 1=1
                AND A.DTA_DL_YN != 'Y' /* 위험점검내역.데이터삭제여부가 'Y'가 아닌 건*/
                ) G
                WHERE 1=1
                ORDER BY
                        G.DANG_OJ_OG_ID /* 행위자사번-소속 */
                       ,G.DANG_OJ_PRTNR_NM /* 행위자사번-성명 */

    </select>
    <update id="updateDangerCheckIzDlYn">
        UPDATE WSMDBS.TB_SSCT_DANG_CHK_IZ
           SET DTA_DL_YN = 'Y'
           <include refid="COMMON.updateSystemField"/>
         WHERE DANG_CHK_ID = #{dangChkId}
    </update>
    <update id="updateDangerCheckChHist">
        UPDATE WSMDBS.TB_SSCT_DANG_CHK_CH_HIST
           SET DTA_DL_YN = 'Y'
           <include refid="COMMON.updateSystemField"/>
         WHERE HIST_END_DTM = '99991231999999'
            AND DANG_CHK_ID = #{dangChkId}
    </update>
    <insert id="insertDangerCheckChHistY">
        INSERT INTO WSMDBS.TB_SSCT_DANG_CHK_CH_HIST(
               DANG_CHK_ID
             , HIST_END_DTM
             , DANG_OJ_PRTNR_NO
             , DANG_MNGT_PRTNR_NO
             , DANG_OJ_OG_ID
             , DANG_OJ_PSTN_DV_CD
             , DANG_MNGT_PSTN_DV_CD
             , DANG_GD_VAL
             , DANG_UNCVR_CT
             , DANG_CHK_NM
             , DANG_CHK_DT
             , DANG_UNCVR_CN
             , DANG_OC_STRTDT
             , DANG_OC_ENDDT
             , DANG_ARBIT_DT
             , DANG_ARBIT_CD
             , DANG_ARBIT_LVY_PC
             , DANG_ARBIT_OG_ID
             , DANG_ARBIT_CN
             , DCPLA_RS_CN
             , DCPLA_RIMB_AMT
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField" />
        ) SELECT DANG_CHK_ID
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
             , DANG_OJ_PRTNR_NO
             , DANG_MNGT_PRTNR_NO
             , DANG_OJ_OG_ID
             , DANG_OJ_PSTN_DV_CD
             , DANG_MNGT_PSTN_DV_CD
             , DANG_GD_VAL
             , DANG_UNCVR_CT
             , DANG_CHK_NM
             , DANG_CHK_DT
             , DANG_UNCVR_CN
             , DANG_OC_STRTDT
             , DANG_OC_ENDDT
             , DANG_ARBIT_DT
             , DANG_ARBIT_CD
             , DANG_ARBIT_LVY_PC
             , DANG_ARBIT_OG_ID
             , DANG_ARBIT_CN
             , DCPLA_RS_CN
             , DCPLA_RIMB_AMT
             , DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue" />
          FROM WSMDBS.TB_SSCT_DANG_CHK_IZ
          WHERE 1=1
             AND DANG_CHK_ID = #{dangChkId}
    </insert>

    <insert id="insertDangerCheckChHistN">
        INSERT INTO WSMDBS.TB_SSCT_DANG_CHK_CH_HIST(
              DANG_CHK_ID
            , HIST_STRT_DTM
            , HIST_END_DTM
            , DANG_OJ_PRTNR_NO
            , DANG_MNGT_PRTNR_NO
            , DANG_OJ_OG_ID
            , DANG_OJ_PSTN_DV_CD
            , DANG_MNGT_PSTN_DV_CD
            , DANG_GD_VAL
            , DANG_UNCVR_CT
            , DANG_CHK_NM
            , DANG_CHK_DT
            , DANG_UNCVR_CN
            , DANG_OC_STRTDT
            , DANG_OC_ENDDT
            , DANG_ARBIT_DT
            , DANG_ARBIT_CD
            , DANG_ARBIT_LVY_PC
            , DANG_ARBIT_OG_ID
            , DANG_ARBIT_CN
            , DCPLA_RS_CN
            , DCPLA_RIMB_AMT
            , DTA_DL_YN
            <include refid="COMMON.insertSystemField" />
        ) SELECT DANG_CHK_ID
               , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
               , '99991231999999'
               , DANG_OJ_PRTNR_NO
               , DANG_MNGT_PRTNR_NO
               , DANG_OJ_OG_ID
               , DANG_OJ_PSTN_DV_CD
               , DANG_MNGT_PSTN_DV_CD
               , DANG_GD_VAL
               , DANG_UNCVR_CT
               , DANG_CHK_NM
               , DANG_CHK_DT
               , DANG_UNCVR_CN
               , DANG_OC_STRTDT
               , DANG_OC_ENDDT
               , DANG_ARBIT_DT
               , DANG_ARBIT_CD
               , DANG_ARBIT_LVY_PC
               , DANG_ARBIT_OG_ID
               , DANG_ARBIT_CN
               , DCPLA_RS_CN
               , DCPLA_RIMB_AMT
               , DTA_DL_YN
            <include refid="COMMON.insertSystemFieldValue" />
          FROM WSMDBS.TB_SSCT_DANG_CHK_IZ
          WHERE 1=1
               AND DANG_CHK_ID = #{dangChkId}
    </insert>

    <insert id="insertDangerCheckIz" parameterType="com.kyowon.sms.wells.web.contract.risk.dvo.WctcDangerArbitDvo">
        <selectKey keyProperty="item.dangChkId" resultType="java.lang.String" order="BEFORE">
            SELECT LPAD(SQ_SSCT_DANG_CHK_IZ$DANG_CHK_ID.NEXTVAL,15,0)
              FROM DUAL
        </selectKey>
        INSERT INTO WSMDBS.TB_SSCT_DANG_CHK_IZ (  /* 위험점검내역 */
                  DANG_CHK_ID          /* 위험점검ID */
                , DANG_OJ_PRTNR_NO     /* 위험대상파트너번호 */
                , DANG_MNGT_PRTNR_NO   /* 위험관리파트너번호 */
                , DANG_OJ_OG_ID        /* 위험대상조직ID */
                , DANG_OJ_PSTN_DV_CD   /* 위험대상직급구분코드 */
                , DANG_MNGT_PSTN_DV_CD /* 위험관리직급구분코드 */
                , DANG_GD_VAL          /* 위험등급값 */
                , DANG_UNCVR_CT        /* 위험적발건수 */
                , DANG_CHK_NM          /* 위험점검명 */
                , DANG_CHK_DT          /* 위험점검일자 */
                , DANG_UNCVR_CN        /* 위험적발내용 */
                , DANG_OC_STRTDT       /* 위험발생시작일자 */
                , DANG_OC_ENDDT        /* 위험발생종료일자 */
                , DANG_ARBIT_DT        /* 위험조치일자 */
                , DANG_ARBIT_CD        /* 위험조치코드 */
                , DANG_ARBIT_LVY_PC    /* 위험조치부과점수 */
                , DANG_ARBIT_OG_ID     /* 위험조치조직ID */
                , DANG_ARBIT_CN        /* 위험조치내용 */
                , DCPLA_RS_CN          /* 징계결과내용 */
                , DCPLA_RIMB_AMT       /* 징계변제금액 */
                , DTA_DL_YN            /* 데이터삭제여부 */
                <include refid="COMMON.insertSystemField" />)
            VALUES (
                  #{item.dangChkId}
                , #{item.dangOjPrtnrNo}
                , #{item.dangMngtPrtnrNo}
                , #{item.dangOjOgId}
                , #{item.dangOjPstnDvCd}
                , #{item.dangMngtPstnDvCd}
                , #{item.dangGdVal}
                , #{item.dangUncvrCt}
                , #{item.dangChkNm}
                , #{item.dangChkDt}
                , #{item.dangUncvrCn}
                , #{item.dangOcStrtdt}
                , #{item.dangOcEnddt}
                , #{item.dangArbitDt}
                , #{item.dangArbitCd}
                , #{item.dangArbitLvyPc}
                , #{item.dangArbitOgId}
                , #{item.dangArbitCn}
                , #{item.dcplaRsCn}
                , #{item.dcplaRimbAmt}
                , 'N'
                <include refid="COMMON.insertSystemFieldValue" />
    </insert>
    <update id="updateDangerCheckIz">
        UPDATE WSMDBS.TB_SSCT_DANG_CHK_IZ /* 위험점검내역 */
           SET DANG_CHK_NM          = #{dangChkNm}           /* 위험점검명 */
           , DANG_UNCVR_CT        = #{dangUncvrCt}         /* 위험적발건수 */
           , DANG_ARBIT_CD        = #{dangArbitCd}         /* 위험조치코드 공통코드 개발 시 변경 */
           , DANG_ARBIT_CN        = #{dangArbitCn}         /* 위험조치내용 */
           , DANG_ARBIT_LVY_PC    = #{dangArbitLvyPc}      /* 위험조치부과점수 */
           , DANG_ARBIT_OG_ID     = #{dangArbitOgId}       /* 위험조치조직ID 공통 코드 개발 시 변경*/
            <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND DANG_CHK_ID          = #{dangChkId}           /* 위험점검ID */
    </update>
</mapper>
