<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.salesstatus.mapper.WcteSecProductMapper">
    <!-- region 예약일 -->
    <select id="selectReservationPages"
            resultType="com.kyowon.sms.wells.web.contract.salesstatus.dto.WcteSecProductDto$SearchReservationRes">
        SELECT T_BZS_IVC_HIST_BY_CNTR.CNTR_NO        AS CNTR_NO /*계약번호*/
             , T_BZS_IVC_HIST_BY_CNTR.CNTR_SN        AS CNTR_SN /*계약일련번호*/
             , T_BZS_IVC_PROCS_HIST_RES.BSDT         AS RES_DT /* 예약일시 */
             , T_BZS_IVC_PROCS_HIST_STOC_STR.BSDT    AS STOC_STR_DT /* 재입고일시 */
             , T_BZS_IVC_HIST_BY_CNTR.SPP_BZS_ORD_ID AS SPP_BZS_ORD_ID /*배송업체주문ID*/
             , T_BZS_IVC_HIST_BY_CNTR.FST_RGST_DTM   AS FST_RGST_DTM /*최초등록일시*/
             , T_CNTR_DTL.SELL_TP_CD                 AS SELL_TP_CD /*판매유형코드*/
             , T_CNTR_DTL.BASE_PD_CD                 AS PD_CD /*기준상품코드*/
             , T_PD_BAS.PD_NM                        AS PD_NM /*기준상품명*/
             , T_CNTR_ADRPC_BAS.RCGVP_KNM            AS RCGVP_KNM /*수령자한글명*/
             , T_CNTR_BAS.SELL_PRTNR_NO              AS SELL_PRTNR_NO /*판매파트너번호*/
             , T_CNTR_BAS.CNTR_CNFM_DTM              AS CNTR_CNFM_DTM /*계약확정일시*/
             , T_CNTR_PRTNR_REL.OG_TP_CD             AS OG_TP_CD /*조직유형코드*/
             , T_MM_OG_IZ.OG_ID                      AS OG_ID /*조직ID*/
             , T_MM_OG_IZ.OG_CD                      AS OG_CD /*조직코드*/
             , T_MM_OG_IZ.HOO_PRTNR_NO               AS HOO_PRTNR_NO /*조직장파트너번호*/
             , T_MM_PRTNR_IZ.PRTNR_KNM               AS PRTNR_KNM /*파트너한글명*/
          FROM (SELECT SUB_T_BZS_IVC_PROCS_HIST.CNTR_NO             AS CNTR_NO
                     , SUB_T_BZS_IVC_PROCS_HIST.CNTR_SN             AS CNTR_SN
                     , MAX(SUB_T_BZS_IVC_PROCS_HIST.FST_RGST_DTM)   AS FST_RGST_DTM
                     , MAX(SUB_T_BZS_IVC_PROCS_HIST.SPP_BZS_ORD_ID) AS SPP_BZS_ORD_ID
                  FROM TB_SSSO_SPP_BZS_IVC_PROCS_HIST SUB_T_BZS_IVC_PROCS_HIST /*배송업체송장처리이력*/
                 WHERE SUB_T_BZS_IVC_PROCS_HIST.DTA_DL_YN = 'N'
                   AND SUB_T_BZS_IVC_PROCS_HIST.SPP_PROCS_BZS_CD = '20' /* 삼성전자 */
                   AND SUB_T_BZS_IVC_PROCS_HIST.OTSD_LK_DRM_VAL IN ('1000001', '1000002')
                 GROUP BY SUB_T_BZS_IVC_PROCS_HIST.CNTR_NO
                        , SUB_T_BZS_IVC_PROCS_HIST.CNTR_SN)   T_BZS_IVC_HIST_BY_CNTR /*계약 최신 이력*/
               LEFT OUTER JOIN TB_SSSO_SPP_BZS_IVC_PROCS_HIST T_BZS_IVC_PROCS_HIST_RES /*예약 이력*/
               ON T_BZS_IVC_PROCS_HIST_RES.DTA_DL_YN = 'N'
                   AND T_BZS_IVC_PROCS_HIST_RES.CNTR_NO = T_BZS_IVC_HIST_BY_CNTR.CNTR_NO
                   AND T_BZS_IVC_PROCS_HIST_RES.CNTR_SN = T_BZS_IVC_HIST_BY_CNTR.CNTR_SN
                   AND T_BZS_IVC_PROCS_HIST_RES.SPP_PROCS_BZS_CD = '20' /* 삼성 */
                   AND T_BZS_IVC_PROCS_HIST_RES.OTSD_LK_DRM_VAL = '1000001'
               LEFT OUTER JOIN TB_SSSO_SPP_BZS_IVC_PROCS_HIST T_BZS_IVC_PROCS_HIST_STOC_STR /*재고 입고 이력*/
               ON T_BZS_IVC_PROCS_HIST_RES.DTA_DL_YN = 'N'
                   AND T_BZS_IVC_PROCS_HIST_RES.CNTR_NO = T_BZS_IVC_HIST_BY_CNTR.CNTR_NO
                   AND T_BZS_IVC_PROCS_HIST_RES.CNTR_SN = T_BZS_IVC_HIST_BY_CNTR.CNTR_SN
                   AND T_BZS_IVC_PROCS_HIST_RES.SPP_PROCS_BZS_CD = '20' /* 삼성 */
                   AND T_BZS_IVC_PROCS_HIST_RES.OTSD_LK_DRM_VAL = '1000002'
               INNER JOIN TB_SSCT_CNTR_DTL                    T_CNTR_DTL /*계약상세*/
               ON T_CNTR_DTL.DTA_DL_YN = 'N'
                   AND T_CNTR_DTL.CNTR_NO = T_BZS_IVC_HIST_BY_CNTR.CNTR_NO
                   AND T_CNTR_DTL.CNTR_SN = T_BZS_IVC_HIST_BY_CNTR.CNTR_SN
                   AND T_CNTR_DTL.SELL_TP_CD IN ('1', '2')
               INNER JOIN TB_SSCT_CNTR_BAS                    T_CNTR_BAS /*계약기본*/
               ON T_CNTR_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_BAS.CNTR_NO = T_CNTR_DTL.CNTR_NO
               INNER JOIN TB_SSCT_CNTR_ADR_REL                T_ADR_REL /*계약주소관계*/
               ON T_ADR_REL.DTA_DL_YN = 'N'
                   AND T_ADR_REL.DTL_CNTR_NO = T_BZS_IVC_HIST_BY_CNTR.CNTR_NO
                   AND T_ADR_REL.DTL_CNTR_SN = T_BZS_IVC_HIST_BY_CNTR.CNTR_SN
                   AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T_ADR_REL.VL_STRT_DTM AND T_ADR_REL.VL_END_DTM
               INNER JOIN TB_SSCT_CNTR_ADRPC_BAS              T_CNTR_ADRPC_BAS /*계약주소지기본*/
               ON T_CNTR_ADRPC_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_ADRPC_BAS.CNTR_ADRPC_ID = T_ADR_REL.CNTR_ADRPC_ID
               LEFT OUTER JOIN TB_SSCT_CNTR_PRTNR_REL         T_CNTR_PRTNR_REL /*계약파트너관계 FIXME INNER*/
               ON T_CNTR_PRTNR_REL.DTA_DL_YN = 'N'
                   AND T_CNTR_PRTNR_REL.CNTR_PRTNR_TP_CD = '010' /*판매자*/
                   AND T_CNTR_PRTNR_REL.CNTR_NO = T_CNTR_BAS.CNTR_NO
                   AND T_CNTR_PRTNR_REL.PRTNR_NO = T_CNTR_BAS.SELL_PRTNR_NO
               INNER JOIN TB_PDBS_PD_BAS                      T_PD_BAS /*상품기본*/
               ON T_PD_BAS.DTA_DL_YN = 'N'
                   AND T_PD_BAS.PD_CD = T_CNTR_DTL.BASE_PD_CD
               LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ            T_MM_PRTNR_IZ /*월파트너내역*/
               ON T_MM_PRTNR_IZ.DTA_DL_YN = 'N'
                   AND T_MM_PRTNR_IZ.OG_TP_CD = T_CNTR_PRTNR_REL.OG_TP_CD
                   AND T_MM_PRTNR_IZ.BASE_YM = SUBSTR(T_CNTR_BAS.CNTR_CNFM_DTM, 1, 6)
                   AND T_MM_PRTNR_IZ.PRTNR_NO = T_CNTR_BAS.SELL_PRTNR_NO
               LEFT OUTER JOIN TB_OGBS_MM_OG_IZ               T_MM_OG_IZ /*월조직내역*/
               ON T_MM_OG_IZ.DTA_DL_YN = 'N'
                   AND T_MM_OG_IZ.BASE_YM = SUBSTR(T_CNTR_BAS.CNTR_CNFM_DTM, 1, 6)
                   AND T_MM_PRTNR_IZ.OG_ID = T_MM_OG_IZ.OG_ID
         WHERE T_CNTR_DTL.SELL_TP_CD = #{sellTpCd}
           AND ((T_BZS_IVC_PROCS_HIST_RES.BSDT BETWEEN #{strtdt} AND #{enddt}) OR
             (T_BZS_IVC_PROCS_HIST_STOC_STR.BSDT BETWEEN #{strtdt} AND #{enddt}))
         ORDER BY T_BZS_IVC_HIST_BY_CNTR.FST_RGST_DTM
    </select>
    <!-- endregion 예약일 -->

    <!-- region 확정일 -->
    <select id="selectConfirms"
            resultType="com.kyowon.sms.wells.web.contract.salesstatus.dto.WcteSecProductDto$SearchConfirmRes">
        SELECT T_BZS_IVC_PROCS_IZ.CNTR_NO           AS CNTR_NO /*계약번호 orderSheetId*/
             , T_BZS_IVC_PROCS_IZ.CNTR_SN           AS CNTR_SN /*계약일련번호*/
             , T_CNTR_DTL.SELL_TP_CD                AS SELL_TP_CD /*판매유형코드 LCTYPE*/
             , T_CNTR_DTL.PD_HCLSF_ID               AS PD_HCLSF_ID /*상품대분류ID KAETC1*/
             , T_CNTR_DTL.PD_MCLSF_ID               AS PD_MCLSF_ID /*상품중분류ID KAETC2*/
             , T_CNTR_ADRPC_BAS.RCGVP_KNM           AS RCGVP_KNM /*수령자한글명 LCCNAM*/
             , T_BZS_IVC_PROCS_IZ.SPP_BZS_ORD_ID    AS SPP_BZS_ORD_ID /*배송업체주문ID ORDER_DELIVERY_ID*/
             , T_BZS_IVC_PROCS_IZ.SPP_FSH_DT        AS SPP_FSH_DT /*배송완료일자 DELIVERY_END_DT*/
             , T_CNTR_DTL.BASE_PD_CD                AS PD_CD /*기준상품코드 LCICDE*/
             , T_PD_BAS.PD_NM                       AS PD_NM /*상품명 productSName*/
             , T_BZS_IVC_PROCS_IZ.SPP_FSH_RGST_DTM  AS SPP_FSH_RGST_DTM /*배송완료등록일시 DE_END_DT_REGDTTM*/
             , T_BZS_IVC_PROCS_IZ.BAT_WK_FSH_DTM    AS BAT_WK_FSH_DTM /*배치작업완료일시 DE_END_DT_RSLT1_DTTM*/
             , T_CNTR_DTL_STAT_CH_HIST.CAN_DT       AS CAN_DT /*취소일 LCCANY*/
             , T_CTT_BAS.CTT_RS_CD                  AS CTT_RS_CD /*컨택결과코드 LCCCDE*/
             , T_PDCT_IDNO_OSTR_IZ.PDCT_IDNO        AS PDCT_IDNO /*제품고유번호 LCSRNO*/
             , T_PDCT_IDNO_OSTR_IZ.SPP_BZS_MODEL_ID AS SPP_BZS_MODEL_ID /*배송업체모델ID LCSRN1*/
             , CASE
                   WHEN T_CNTR_DTL.SELL_TP_CD != '2' THEN ''
                   WHEN (T_CNTR_DTL.CNTR_AMT - T_CNTR_PRC_CMPT_IZ.CTR_VAL) = 0
                                                     THEN ''
                   WHEN (T_CNTR_DTL.CNTR_AMT - T_CNTR_PRC_CMPT_IZ.CTR_VAL) <![CDATA[<=]]> (SELECT SUM(CASE
                                                                                                 WHEN DP_DV_CD = '1'
                                                                                                     THEN RVE_AMT
                                                                                                     ELSE RVE_AMT * -1
                                                                                             END)
                                                                                    FROM TB_RVDW_RVE_DTL /*수납상세*/
                                                                                   WHERE DTA_DL_YN = 'N'
                                                                                     AND CNTR_NO = T_BZS_IVC_PROCS_IZ.CNTR_NO
                                                                                     AND CNTR_SN = T_BZS_IVC_PROCS_IZ.CNTR_SN)
                                                     THEN 'Y'
                                                     ELSE 'N'
               END                                  AS RGST_FEE_FLPYM_YN /*등록비완납여부 TRMT_CMPL_YN*/
          FROM TB_SSSO_SPP_BZS_IVC_PROCS_IZ              T_BZS_IVC_PROCS_IZ /*배송업체송장처리내역*/
               LEFT OUTER JOIN TB_SSCT_CNTR_DTL          T_CNTR_DTL /*계약상세*/
               ON T_CNTR_DTL.DTA_DL_YN = 'N'
                   AND T_CNTR_DTL.CNTR_NO = T_BZS_IVC_PROCS_IZ.CNTR_NO
                   AND T_CNTR_DTL.CNTR_SN = T_BZS_IVC_PROCS_IZ.CNTR_SN
               INNER JOIN TB_SSCT_CNTR_BAS               T_CNTR_BAS /*계약기본*/
               ON T_CNTR_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_BAS.CNTR_NO = T_CNTR_DTL.CNTR_NO
               LEFT OUTER JOIN TB_SSCT_CNTR_ADR_REL      T_CNTR_ADR_REL /*계약주소관계*/
               ON T_CNTR_ADR_REL.DTA_DL_YN = 'N'
                   AND T_CNTR_ADR_REL.DTL_CNTR_NO = T_BZS_IVC_PROCS_IZ.CNTR_NO
                   AND T_CNTR_ADR_REL.DTL_CNTR_SN = T_BZS_IVC_PROCS_IZ.CNTR_SN
                   AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T_CNTR_ADR_REL.VL_STRT_DTM || '000000' AND
                       T_CNTR_ADR_REL.VL_END_DTM || '235959'
               LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS    T_CNTR_ADRPC_BAS /*계약주소지기본*/
               ON T_CNTR_ADRPC_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_ADRPC_BAS.CNTR_ADRPC_ID = T_CNTR_ADR_REL.CNTR_ADRPC_ID
                   AND T_CNTR_ADRPC_BAS.CNTR_NO = T_CNTR_ADR_REL.DTL_CNTR_NO
               LEFT OUTER JOIN TB_SSOP_CTT_DTL           T_CTT_DTL
               ON T_CTT_DTL.CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND T_CTT_DTL.CNTR_SN = T_CNTR_DTL.CNTR_SN
                   AND T_CTT_DTL.CTT_OJ_ID = (SELECT MAX(CTT_OJ_ID)
                                                FROM TB_SSOP_CTT_DTL
                                               WHERE DTA_DL_YN = 'N'
                                                 AND CNTR_NO = T_CTT_DTL.CNTR_NO
                                                 AND CNTR_SN = T_CTT_DTL.CNTR_SN)
               LEFT OUTER JOIN TB_SSOP_CTT_BAS           T_CTT_BAS
               ON T_CTT_BAS.CTT_OJ_ID = T_CTT_DTL.CTT_OJ_ID
               LEFT OUTER JOIN (SELECT CNTR_NO, CNTR_SN, CAN_DT
                                  FROM (SELECT CNTR_NO
                                             , CNTR_SN
                                             , SUBSTR(HIST_STRT_DTM, 1, 8)                                                   AS CAN_DT
                                             , ROW_NUMBER() OVER (PARTITION BY CNTR_NO, CNTR_SN ORDER BY HIST_STRT_DTM DESC) AS RN
                                          FROM TB_SSCT_CNTR_DTL_STAT_CH_HIST
                                         WHERE DTA_DL_YN = 'N'
                                           AND CNTR_DTL_STAT_CD IN ('301', '302', '303'))
                                 WHERE RN = 1)           T_CNTR_DTL_STAT_CH_HIST
               ON T_CNTR_DTL_STAT_CH_HIST.CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND T_CNTR_DTL_STAT_CH_HIST.CNTR_SN = T_CNTR_DTL.CNTR_SN
               LEFT OUTER JOIN TB_SSSO_PDCT_IDNO_OSTR_IZ T_PDCT_IDNO_OSTR_IZ /*제품고유번호출고내역*/
               ON T_PDCT_IDNO_OSTR_IZ.DTA_DL_YN = 'N'
                   AND T_PDCT_IDNO_OSTR_IZ.CNTR_NO = T_BZS_IVC_PROCS_IZ.CNTR_NO
                   AND T_PDCT_IDNO_OSTR_IZ.CNTR_SN = T_BZS_IVC_PROCS_IZ.CNTR_SN
               LEFT OUTER JOIN TB_SSCT_CNTR_PRC_CMPT_IZ  T_CNTR_PRC_CMPT_IZ /*계약가격산출내역*/
               ON T_CNTR_PRC_CMPT_IZ.DTA_DL_YN = 'N'
                   AND T_CNTR_PRC_CMPT_IZ.CNTR_NO = T_BZS_IVC_PROCS_IZ.CNTR_NO
                   AND T_CNTR_PRC_CMPT_IZ.CNTR_SN = T_BZS_IVC_PROCS_IZ.CNTR_SN
               LEFT OUTER JOIN TB_PDBS_PD_BAS            T_PD_BAS /*상품기본*/
               ON T_PD_BAS.DTA_DL_YN = 'N'
                   AND T_PD_BAS.PD_CD = T_CNTR_DTL.BASE_PD_CD
               INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL        T_PD_ECOM_PRP_DTL /*상품각사속성안내*/
               ON T_PD_ECOM_PRP_DTL.DTA_DL_YN = 'N'
                   AND T_PD_ECOM_PRP_DTL.PD_CD = T_CNTR_DTL.BASE_PD_CD
                   AND T_PD_ECOM_PRP_DTL.PD_EXTS_PRP_GRP_CD = 'SPP'
                   AND T_PD_ECOM_PRP_DTL.PD_PRP_VAL02 = 'S'
         WHERE T_CNTR_DTL.SELL_TP_CD IN ('1', '2')
           <if test="@MybatisUtils@isNotEmpty(strtdt) and @MybatisUtils@isNotEmpty(enddt)"><trim>
               AND T_BZS_IVC_PROCS_IZ.SPP_FSH_DT BETWEEN #{strtdt} AND #{enddt}
           </trim></if>
           AND T_BZS_IVC_PROCS_IZ.SPP_BZS_ORD_ID IS NOT NULL
           <if test="@MybatisUtils@isNotEmpty(sellTpCd)"><trim>
               AND T_CNTR_DTL.SELL_TP_CD = #{sellTpCd}
           </trim></if>
           <if test="@MybatisUtils@isNotEmpty(sppBzsOrdId)"><trim>
               AND T_BZS_IVC_PROCS_IZ.SPP_BZS_ORD_ID LIKE '%' || #{sppBzsOrdId} || '%'
           </trim></if>
           <if test="@MybatisUtils@isNotEmpty(pdctIdno)"><trim>
               AND T_PDCT_IDNO_OSTR_IZ.PDCT_IDNO LIKE '%' || UPPER(#{pdctIdno}) || '%'
           </trim></if>
         ORDER BY T_BZS_IVC_PROCS_IZ.SPP_FSH_DT DESC

    </select>

    <select id="selectConfirmValidation"
            resultType="com.kyowon.sms.wells.web.contract.salesstatus.dvo.WcteConfirmValidationDvo"
    >
        SELECT T_CNTR_DTL.CNTR_NO                   AS CNTR_NO /*계약번호*/
             , T_CNTR_DTL.CNTR_SN                   AS CNTR_SN /*계약일련번호*/
             , T_CNTR_DTL.SELL_TP_CD                   AS SELL_TP_CD /* 계약종류 */
             , T_CNTR_DTL_STAT_CANCELED_HIST.CAN_DT AS CAN_DT /*취소일자*/
             , CASE
                   WHEN T_CNTR_DTL.CNTR_PD_STRTDT IS NOT NULL /*60:확정*/
                       THEN 'Y'
                       ELSE ''
               END                                  AS CNTR_CNFM_YN /*매출확정여부*/
             , T_CNTR_WELLS_DTL.IST_DT              AS IST_DT /*설치일자*/
             , T_CNTR_DTL.SPP_DUEDT                 AS SPP_DUEDT /*배송예정일자*/
             , T_CNTR_WELLS_DTL.CPS_DT              AS CPS_DT /*보상일자*/
             , CASE
                   WHEN T_PD_ECOM_PRP_DTL.PD_PRP_VAL02 = 'S'
                       THEN 'Y'
                       ELSE ''
               END                                  AS SEC_PD_YN /*삼성제품여부?*/
             , CASE
                   WHEN T_PDCT_IDNO_OSTR_IZ.OSTR_SN IS NOT NULL
                       THEN 'Y'
                       ELSE ''
               END                                  AS OSTR_RGST_YN /*제품고유번호출고내역존재여부?*/
          FROM TB_SSCT_CNTR_DTL                          T_CNTR_DTL /*계약상세*/
               INNER JOIN TB_SSCT_CNTR_BAS               T_CNTR_BAS /*계약기본*/
               ON T_CNTR_BAS.DTA_DL_YN = 'N'
                   AND T_CNTR_BAS.CNTR_NO = T_CNTR_DTL.CNTR_NO
               LEFT OUTER JOIN (SELECT CNTR_NO, CNTR_SN, CAN_DT
                                  FROM (SELECT CNTR_NO
                                             , CNTR_SN
                                             , SUBSTR(HIST_STRT_DTM, 1, 8)                                                   AS CAN_DT
                                             , ROW_NUMBER() OVER (PARTITION BY CNTR_NO, CNTR_SN ORDER BY HIST_STRT_DTM DESC) AS RN
                                          FROM TB_SSCT_CNTR_DTL_STAT_CH_HIST
                                         WHERE DTA_DL_YN = 'N'
                                           AND CNTR_DTL_STAT_CD IN ('301', '302', '303'))
                                 WHERE RN = 1)           T_CNTR_DTL_STAT_CANCELED_HIST
               ON T_CNTR_DTL_STAT_CANCELED_HIST.CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND T_CNTR_DTL_STAT_CANCELED_HIST.CNTR_SN = T_CNTR_DTL.CNTR_SN
               LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL    T_CNTR_WELLS_DTL /*계약WELLS상세*/
               ON T_CNTR_WELLS_DTL.DTA_DL_YN = 'N'
                   AND T_CNTR_WELLS_DTL.CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND T_CNTR_WELLS_DTL.CNTR_SN = T_CNTR_DTL.CNTR_SN
               LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL        T_PD_ECOM_PRP_DTL /*상품각사속성안내*/
               ON T_PD_ECOM_PRP_DTL.DTA_DL_YN = 'N'
                   AND T_PD_ECOM_PRP_DTL.PD_CD = T_CNTR_DTL.BASE_PD_CD
                   AND T_PD_ECOM_PRP_DTL.PD_EXTS_PRP_GRP_CD = 'SPP'
               LEFT OUTER JOIN TB_SSSO_PDCT_IDNO_OSTR_IZ        T_PDCT_IDNO_OSTR_IZ /*제품고유번호출고내역*/
               ON T_PDCT_IDNO_OSTR_IZ.DTA_DL_YN = 'N'
                   AND T_PDCT_IDNO_OSTR_IZ.CNTR_NO = T_CNTR_DTL.CNTR_NO
                   AND T_PDCT_IDNO_OSTR_IZ.CNTR_SN = T_CNTR_DTL.CNTR_SN
                   AND T_PDCT_IDNO_OSTR_IZ.OSTR_SN = '0'
         WHERE T_CNTR_DTL.DTA_DL_YN = 'N'
           AND T_CNTR_DTL.CNTR_NO = #{cntrNo}
           AND T_CNTR_DTL.CNTR_SN = #{cntrSn}
    </select>

    <update id="updateShippingDueDate">
        update TB_SSCT_CNTR_DTL T_CNTR_DTL
           set T_CNTR_DTL.SPP_DUEDT = #{sppDuedt}
         where T_CNTR_DTL.DTA_DL_YN = 'N'
           AND T_CNTR_DTL.CNTR_NO = #{cntrNo}
           AND T_CNTR_DTL.CNTR_SN = #{cntrSn}
    </update>

    <insert id="insertContractDetailChangeHistory">
        INSERT INTO TB_SSCT_CNTR_DCH_HIST ( CNTR_NO /*계약번호*/
                                          , CNTR_SN /*계약일련번호*/
                                          , HIST_STRT_DTM /*이력시작일시*/
                                          , HIST_END_DTM /*이력종료일시*/
                                          , BASE_PD_CD /*기준상품코드*/
                                          , HGR_PD_CD /*상위상품코드*/
                                          , PD_QTY /*상품수량*/
                                          , STPL_PTRM_UNIT_CD /*약정기간단위코드*/
                                          , STPL_PTRM /*약정기간*/
                                          , ISTM_MCN /*할부개월수*/
                                          , CNTR_PD_STRTDT /*계약상품시작일자*/
                                          , CNTR_PD_ENDDT /*계약상품종료일자*/
                                          , CNTR_DTL_STAT_CD /*계약상세상태코드*/
                                          , SELL_TP_CD /*판매유형코드*/
                                          , SV_PTRM_UNIT_CD /*서비스기간단위코드*/
                                          , SV_PRD /*서비스주기*/
                                          , BLG_CRP_CD /*소속법인코드*/
                                          , RVE_CRP_CD /*수납법인코드*/
                                          , CO_CD /*회사코드*/
                                          , PD_GD_CD /*상품등급코드*/
                                          , PD_HCLSF_ID /*상품대분류ID*/
                                          , PD_MCLSF_ID /*상품중분류ID*/
                                          , PD_LCLSF_ID /*상품소분류ID*/
                                          , PD_DCLSF_ID /*상품세분류ID*/
                                          , STLM_TP_CD /*결제유형코드*/
                                          , CRNCY_DV_CD /*통화구분코드*/
                                          , APY_EXCR /*적용환율*/
                                          , PD_BASE_AMT /*상품기준금액*/
                                          , FNL_AMT /*최종금액*/
                                          , VAT /*부가가치세*/
                                          , SELL_AMT /*판매금액*/
                                          , CNTR_AMT /*계약금액*/
                                          , ISTM_PCAM_AMT /*할부원금금액*/
                                          , ISTM_INT_AMT /*할부이자금액*/
                                          , MM_ISTM_AMT /*월할부금액*/
                                          , ACKMT_PERF_RT /*인정실적율*/
                                          , ACKMT_PERF_AMT /*인정실적금액*/
                                          , SPP_DUEDT /*배송예정일자*/
                                          , RESUB_YN /*재구독여부*/
                                          , RSTL_YN /*재약정여부*/
                                          , FRISU_YN /*무상여부*/
                                          , SMTPL_ID /*스마트플랜ID*/
                                          , SMTPL_SN /*스마트플랜일련번호*/
                                          , BF_ORD_NO /*이전주문번호*/
                                          , CNTR_CH_RCP_ID /*계약변경접수ID*/
                                          , CNTR_CH_SN /*계약변경일련번호*/
                                          , DTA_DL_YN /*데이터삭제여부*/
                                          , FST_RGST_DTM /*최초등록일시*/
                                          , FST_RGST_USR_ID /*최초등록사용자ID*/
                                          , FST_RGST_PRG_ID /*최초등록프로그램ID*/
                                          , FST_RGST_DEPT_ID /*최초등록부서ID*/
                                          , FNL_MDFC_DTM /*최종수정일시*/
                                          , FNL_MDFC_USR_ID /*최종수정사용자ID*/
                                          , FNL_MDFC_PRG_ID /*최종수정프로그램ID*/
                                          , FNL_MDFC_DEPT_ID /*최종수정부서ID*/
                                          , BOO_SELL_TP_CD /*예약판매유형코드*/
                                          , FEE_FXAM_YN /*수수료정액여부*/
                                          , FRISU_DSB_TP_CD /*무상지급유형코드*/
                                          , CNTR_CH_DTL_AK_CN /*계약변경상세요청내용*/
                                          , CNTRW_TP_CD /*계약서유형코드*/
                                          , TXINV_PBL_OJ_YN /*세금계산서발행대상여부*/
                                          , FEE_ACKMT_CT /*수수료인정건수*/
                                          , CVT_PERF_AMT /*환산실적금액*/
                                          , FEE_ACKMT_BASE_AMT /*수수료인정기준금액*/
                                          , SELL_TP_DTL_CD /*판매유형상세코드*/
                                          , SELL_DSC_DV_CD /*판매할인구분코드*/
                                          , SELL_DSCR_CD /*판매할인율코드*/
                                          , SELL_DSC_CTR_AMT /*판매할인조정금액*/
                                          , SELL_DSC_TP_CD /*판매할인유형코드*/
                                          , DSC_AMT /*할인금액*/
                                          , CNTRAM_DSC_AMT /*계약금할인금액*/
                                          , CRP_UC_AMT /*법인미수금액*/
                                          , SELL_FEE /*판매수수료*/
                                          , ALNCMP_CD /*제휴사코드*/
                                          , ALNCMP_CNTR_DRM_VAL /*제휴사계약식별값*/
        )
        SELECT CNTR_NO /*계약번호*/
             , CNTR_SN /*계약일련번호*/
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') AS HIST_STRT_DTM
             , '99991231235959'                     AS HIST_END_DTM
             , BASE_PD_CD /*기준상품코드*/
             , HGR_PD_CD /*상위상품코드*/
             , PD_QTY /*상품수량*/
             , STPL_PTRM_UNIT_CD /*약정기간단위코드*/
             , STPL_PTRM /*약정기간*/
             , ISTM_MCN /*할부개월수*/
             , CNTR_PD_STRTDT /*계약상품시작일자*/
             , CNTR_PD_ENDDT /*계약상품종료일자*/
             , CNTR_DTL_STAT_CD /*계약상세상태코드*/
             , SELL_TP_CD /*판매유형코드*/
             , SV_PTRM_UNIT_CD /*서비스기간단위코드*/
             , SV_PRD /*서비스주기*/
             , BLG_CRP_CD /*소속법인코드*/
             , RVE_CRP_CD /*수납법인코드*/
             , CO_CD /*회사코드*/
             , PD_GD_CD /*상품등급코드*/
             , PD_HCLSF_ID /*상품대분류ID*/
             , PD_MCLSF_ID /*상품중분류ID*/
             , PD_LCLSF_ID /*상품소분류ID*/
             , PD_DCLSF_ID /*상품세분류ID*/
             , STLM_TP_CD /*결제유형코드*/
             , CRNCY_DV_CD /*통화구분코드*/
             , APY_EXCR /*적용환율*/
             , PD_BASE_AMT /*상품기준금액*/
             , FNL_AMT /*최종금액*/
             , VAT /*부가가치세*/
             , SELL_AMT /*판매금액*/
             , CNTR_AMT /*계약금액*/
             , ISTM_PCAM_AMT /*할부원금금액*/
             , ISTM_INT_AMT /*할부이자금액*/
             , MM_ISTM_AMT /*월할부금액*/
             , ACKMT_PERF_RT /*인정실적율*/
             , ACKMT_PERF_AMT /*인정실적금액*/
             , SPP_DUEDT /*배송예정일자*/
             , RESUB_YN /*재구독여부*/
             , RSTL_YN /*재약정여부*/
             , FRISU_YN /*무상여부*/
             , SMTPL_ID /*스마트플랜ID*/
             , SMTPL_SN /*스마트플랜일련번호*/
             , BF_ORD_NO /*이전주문번호*/
             , CNTR_CH_RCP_ID /*계약변경접수ID*/
             , CNTR_CH_SN /*계약변경일련번호*/
             , DTA_DL_YN /*데이터삭제여부*/
             , FST_RGST_DTM /*최초등록일시*/
             , FST_RGST_USR_ID /*최초등록사용자ID*/
             , FST_RGST_PRG_ID /*최초등록프로그램ID*/
             , FST_RGST_DEPT_ID /*최초등록부서ID*/
             , FNL_MDFC_DTM /*최종수정일시*/
             , FNL_MDFC_USR_ID /*최종수정사용자ID*/
             , FNL_MDFC_PRG_ID /*최종수정프로그램ID*/
             , FNL_MDFC_DEPT_ID /*최종수정부서ID*/
             , BOO_SELL_TP_CD /*예약판매유형코드*/
             , FEE_FXAM_YN /*수수료정액여부*/
             , FRISU_DSB_TP_CD /*무상지급유형코드*/
             , CNTR_CH_DTL_AK_CN /*계약변경상세요청내용*/
             , CNTRW_TP_CD /*계약서유형코드*/
             , TXINV_PBL_OJ_YN /*세금계산서발행대상여부*/
             , FEE_ACKMT_CT /*수수료인정건수*/
             , CVT_PERF_AMT /*환산실적금액*/
             , FEE_ACKMT_BASE_AMT /*수수료인정기준금액*/
             , SELL_TP_DTL_CD /*판매유형상세코드*/
             , SELL_DSC_DV_CD /*판매할인구분코드*/
             , SELL_DSCR_CD /*판매할인율코드*/
             , SELL_DSC_CTR_AMT /*판매할인조정금액*/
             , SELL_DSC_TP_CD /*판매할인유형코드*/
             , DSC_AMT /*할인금액*/
             , CNTRAM_DSC_AMT /*계약금할인금액*/
             , CRP_UC_AMT /*법인미수금액*/
             , SELL_FEE /*판매수수료*/
             , ALNCMP_CD /*제휴사코드*/
             , ALNCMP_CNTR_DRM_VAL /*제휴사계약식별값*/
          FROM TB_SSCT_CNTR_DTL
          WHERE CNTR_NO = #{cntrNo}
            AND CNTR_SN = #{cntrSn}
    </insert>

    <insert id="insertProductOutOfStorageIz">
        INSERT INTO TB_SSSO_PDCT_IDNO_OSTR_IZ ( /* 제품고유번호출고내역 */
                                                CNTR_NO /* 계약번호 */
                                              , CNTR_SN /* 계약일련번호 */
                                              , OSTR_SN /* 출고일련번호 */
                                              , SELL_TP_CD /* 판매유형코드 */
                                              , OSTR_RQDT /* 출고요청일자 */
                                              , PDCT_IDNO /* 제품고유번호 */
                                              , SPP_BZS_MODEL_ID /* 배송업체모델ID */
                                              , OSTR_MTR_DV_CD /* 출고자료구분코드 */
                                              , SPP_PROCS_BZS_CD /* 배송처리업체코드 */
        <include refid="COMMON.insertSystemField"/>)
        VALUES ( #{cntrNo}
               , #{cntrSn}
               /*FIXME: 출고일련번호를 어떻게 가져갈지 아직 불확실함.*/
               , COALESCE(0, (SELECT COALESCE(MAX(OSTR_SN), 0) + 1 FROM TB_SSSO_PDCT_IDNO_OSTR_IZ WHERE CNTR_NO = #{cntrNo} AND CNTR_SN = #{cntrSn}))
               , #{sellTpCd}
               , TO_CHAR(SYSDATE, 'YYYYMMDD')
               , #{pdctIdno}
               , #{sppBzsModelId}
               , '1'
               , '3'
        <include refid="COMMON.insertSystemFieldValue"/>)
    </insert>

    <insert id="insertInvoiceProcessIz">
        INSERT INTO TB_SSSO_SPP_BZS_IVC_PROCS_IZ ( /* 배송업체송장처리내역 */
                                                   SPP_BZS_PROCS_ID /* 배송업체처리ID */
                                                 , CNTR_NO /* 계약번호 */
                                                 , CNTR_SN /* 계약일련번호 */
                                                 , SPP_PROCS_BZS_CD /* 배송처리업체코드 */
                                                 , SPP_BZS_ORD_ID /* 배송업체주문ID */
                                                 , SPP_BZS_ORD_RGST_DTM /* 배송업체주문호출일시 */
                                                 , SPP_FSH_RGST_DTM /* 배송완료호출일시 */
                                                 , SPP_FSH_DT /* 배송완료일시 */
        <include refid="COMMON.insertSystemField"/>)
        VALUES ( (SELECT NVL(MAX(TO_NUMBER(SPP_BZS_PROCS_ID)), 0) + 1 FROM TB_SSSO_SPP_BZS_IVC_PROCS_IZ)
               , #{cntrNo}
               , #{cntrSn}
               , '3'
               , #{sppBzsOrdId}
               , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
               , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
               , #{sppFshDt}
        <include refid="COMMON.insertSystemFieldValue"/>)
    </insert>

    <select id="selectInvoiceProcessIzPk" resultType="java.lang.String">
        SELECT MAX(TO_NUMBER(SPP_BZS_PROCS_ID))
          FROM TB_SSSO_SPP_BZS_IVC_PROCS_IZ
         WHERE DTA_DL_YN = 'N'
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND SPP_BZS_ORD_ID = #{sppBzsOrdId}
           AND SPP_FSH_DT = #{sppFshDt}
    </select>


    <insert id="insertInvoiceProcessHistory">
        INSERT INTO TB_SSSO_SPP_BZS_IVC_PROCS_HIST ( SPP_BZS_PROCS_ID /*배송업체처리ID*/
                                                   , CNTR_NO /*계약번호*/
                                                   , CNTR_SN /*계약일련번호*/
                                                   , SPP_PROCS_BZS_CD /*배송처리업체코드*/
                                                   , SPP_BZS_ORD_ID /*배송업체주문ID*/
                                                   , SPP_BZS_PD_ID /*배송업체상품ID*/
                                                   , BAT_WK_FSH_DTM /*배치작업완료일시*/
                                                   , SPP_IVC_NO /*배송송장번호*/
                                                   , DTA_DL_YN /*데이터삭제여부*/
                                                   , FST_RGST_DTM /*최초등록일시*/
                                                   , FST_RGST_USR_ID /*최초등록사용자ID*/
                                                   , FST_RGST_PRG_ID /*최초등록프로그램ID*/
                                                   , FST_RGST_DEPT_ID /*최초등록부서ID*/
                                                   , FNL_MDFC_DTM /*최종수정일시*/
                                                   , FNL_MDFC_USR_ID /*최종수정사용자ID*/
                                                   , FNL_MDFC_PRG_ID /*최종수정프로그램ID*/
                                                   , FNL_MDFC_DEPT_ID /*최종수정부서ID*/
                                                   , CH_SN /*변경일련번호*/
                                                   , SPP_BZS_ORD_RGST_DTM /*배송업체주문등록일시*/
                                                   , SPP_FSH_RGST_DTM /*배송완료등록일시*/
                                                   , SPP_FSH_DT /*배송완료일자*/
                                                   , SELL_TP_CD /*판매유형코드*/
                                                   , BF_ORD_NO /*이전주문번호*/
        )
        SELECT SPP_BZS_PROCS_ID /*배송업체처리ID*/
             , CNTR_NO /*계약번호*/
             , CNTR_SN /*계약일련번호*/
             , SPP_PROCS_BZS_CD /*배송처리업체코드*/
             , SPP_BZS_ORD_ID /*배송업체주문ID*/
             , SPP_BZS_PD_ID /*배송업체상품ID*/
             , BAT_WK_FSH_DTM /*배치작업완료일시*/
             , SPP_IVC_NO /*배송송장번호*/
             , DTA_DL_YN /*데이터삭제여부*/
             , FST_RGST_DTM /*최초등록일시*/
             , FST_RGST_USR_ID /*최초등록사용자ID*/
             , FST_RGST_PRG_ID /*최초등록프로그램ID*/
             , FST_RGST_DEPT_ID /*최초등록부서ID*/
             , FNL_MDFC_DTM /*최종수정일시*/
             , FNL_MDFC_USR_ID /*최종수정사용자ID*/
             , FNL_MDFC_PRG_ID /*최종수정프로그램ID*/
             , FNL_MDFC_DEPT_ID /*최종수정부서ID*/
             , 0 /*변경일련번호*/
             , SPP_BZS_ORD_RGST_DTM /*배송업체주문등록일시*/
             , SPP_FSH_RGST_DTM /*배송완료등록일시*/
             , SPP_FSH_DT /*배송완료일자*/
             , SELL_TP_CD /*판매유형코드*/
             , BF_ORD_NO /*이전주문번호*/
          FROM TB_SSSO_SPP_BZS_IVC_PROCS_IZ
         WHERE SPP_BZS_PROCS_ID = #{sppBzsProcsId}
    </insert>
    <!-- endregion 확정일 -->


    <sql id="forTemplate">
    </sql>
</mapper>
