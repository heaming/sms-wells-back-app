<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.ordermgmt.mapper.WctaOrderDetailInqrMapper">
    <select id="selectOrderDetailSpayCntrtPages" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaOrderDetailInqrDto$SearchRes">
        SELECT CONCAT(CONCAT(A1.CNTR_NO, '-'), A1.CNTR_SN) AS CNTR_DTL_NO /* 계약번호 - 계약일련번호 [계약상세번호] */
             , A1.CNTR_NO /* 계약번호 [계약번호] */
             , A1.CNTR_SN /* 계약일련번호 [계약번호] */
             , C1.CST_KNM /* 고객한글명 [계약자명] */
             , C1.COPN_DV_CD /* 법인격구분코드(계약자 고객구분 ) 1:개인, 2:법인 */
             , F_CMZ_CD_NM ('TNT_WELLS', 'COPN_DV_CD', C1.COPN_DV_CD) AS COPN_DV_NM /* 고객구분명 [고객구분]*/
               /* 개인인경우 생년월일, 사업자인경우 사업자 등록번호로 조회 하려 했으나 실명구분코드와 실명번호 암호화로 대체 처리하여도 되는지 데이터 확인 후 진행 */
             , C1.BZRNO /* 사업자등록번호(계약자) */
             , C1.BRYY_MMDD /* 생년월일(계약자) */
             , C1.SEX_DV_CD /* 성별구분코드(계약자) */
             , CASE WHEN C1.COPN_DV_CD = '1' /* 계약자 고객구분 1(개인) 인 경우 */
                         THEN C1.BRYY_MMDD
                    WHEN C1.COPN_DV_CD = '2' /* 계약자 고객구분 2(법인) 인 경우 */
                         THEN C1.BZRNO
                    ELSE ''
               END AS RNMNO /* [주민/사업자번호] */
             , C1.RNMNO_DV_CD /* 실명번호구분코드 01:주민등록번호, 02:외국인등록번호, 03:법인등록번호, 04:사업자등록번호, 05:단체고유번호 */
             , C1.RNMNO_ENCR /* 실명번호암호화 */
             , A1.BASE_PD_CD /* 기준상품코드[상품코드] */
               /* 기준상품만을 조건으로 조회하려 했으나 복합상품, 기준상품, 서비스, 교재 제품등 해당 상품 유형이 확인 되지 않아 MAX로 조회 */
             , (
                SELECT MAX(D1.PD_NM) /* 상품기본.상품명 */
                  FROM TB_PDBS_PD_BAS D1 /* 상품기본 */
                 WHERE D1.PD_CD = A1.BASE_PD_CD /* 상품기본.상품코드 = 계약상세.기준상품코드 */
                   AND D1.DTA_DL_YN != 'Y' /* 상품기본.데이터삭제여부가 'Y'가 아닌 건 */
               ) AS BASE_PD_NM /* [상품명] */
             , A1.DSC_APY_TP_CD /* 계약상세.할인적용유형코드 [할인구분]*/
             , F_CMZ_CD_NM(  'TNT_WELLS'
                           , (SELECT CM1.USER_DFN_02 AS ID
                                FROM T_CMZ_CD_D CM1
                               WHERE 1 = 1
                                 AND CM1.CD_ID = 'DSC_APY_TP_CD'
                                 AND CM1.CD_VLD_VAL = A1.SELL_TP_CD
                                 AND CM1.TENANT_ID = 'TNT_WELLS')
                           , A1.DSC_APY_TP_CD ) AS DSC_APY_TP_NM
             , A1.DSC_APY_DTL_CD /* 계약상세.할인적용상세코드 [할인유형] */
             /* 할인유형명 계층형으로 되어있음 */
             , F_CMZ_CD_NM(  'TNT_WELLS'
                           , (SELECT CM2.USER_DFN_02
                                FROM T_CMZ_CD_D CM2
                               WHERE 1 = 1
                                 AND CM2.CD_ID = 'DSC_APY_DTL_CD'
                                 AND CM2.PRTS_CD_ID = (SELECT CM1.USER_DFN_02 AS ID
                                                         FROM T_CMZ_CD_D CM1
                                                        WHERE CM1.CD_ID = 'DSC_APY_TP_CD'
                                                          AND CM1.CD_VLD_VAL = A1.SELL_TP_CD
                                                          AND CM1.TENANT_ID = 'TNT_WELLS')
                                 AND CM2.TENANT_ID = 'TNT_WELLS')
                           , A1.DSC_APY_DTL_CD) AS DSC_APY_DTL_NM
             , B1.CNTR_RCP_FSH_DTM /* 계약기본.계약접수완료일시 [접수일] */
             , A1.SPP_DUEDT /* 계약상세.배송예정일자 [예정일] */
             , (SELECT MAX(E1.SL_DT)
                  FROM TB_CBCL_WELLS_SL_MM_CL_IZ E1 /* WELLS매출월마감내역 */
                 WHERE E1.CNTR_NO = A1.CNTR_NO
                   AND E1.CNTR_SN = A1.CNTR_SN
                   AND E1.SL_CL_YM BETWEEN NVL(A1.CNTR_PD_STRTDT, TO_CHAR(SYSDATE,'YYYYMM')) AND TO_CHAR(SYSDATE,'YYYYMM')) AS SL_DT /* WELLS매출월마감내역.매출일자 - 현재월기준 [매출일] */
             , SUBSTR(B1.CNTR_CAN_DTM, 1, 8) AS CNTR_CAN_DT /* 계약기본.계약취소일시 [취소일] */
             , F1.CPS_DT /* 계약WELLS상세.보상일자 [보상일] */
             /* 매출경과일 항목 조회 기준 확정 이후 처리 - 해당항목 as-is에 없음
              * as-is LC3000.LCDEMY/LCDEMM/LCDEMD 예정년월일 + 14일
              * to-be 매핑정보 기준 배송예정일자 + 14일 */
             , CASE WHEN TRIM(A1.SPP_DUEDT) IS NOT NULL
                         THEN TO_CHAR(TO_DATE(A1.SPP_DUEDT, 'YYYYMMDD')+14, 'YYYYMMDD')
                    ELSE ''
               END AS SL_PASG_DT /* [매출경과일] */
             , CASE WHEN TRIM(B1.CNTR_CNFM_APR_DTM) IS NOT NULL
                         THEN 'Y'
                    ELSE 'N'
               END SL_CNFM_YN /* [매출확정여부] */
             , B1.CNTR_CAN_RSON_CD /* 계약기본.계약취소사유코드 [취소유형] */
             , F_CMZ_CD_NM ('TNT_WELLS', 'CNTR_CAN_RSON_CD', B1.CNTR_CAN_RSON_CD) AS CAN_RSON_NM /* [취소유형명] */
             , '' AS CNTR_CH_DTL_RSON_CD /* , A1.CNTR_CH_DTL_RSON_CD  계약상세.계약변경상세사유코드 TODO: 계약변경 상세변경상세사유코드 삭제 여부 확인 */
             , '' AS CNTR_CH_DTL_RSON_NM /* , F_CMZ_CD_NM ('TNT_WELLS', 'CNTR_CH_DTL_RSON_CD', A1.CNTR_CH_DTL_RSON_CD) AS CNTR_CH_DTL_RSON_NM [계약변경명] TODO: 계약변경 상세변경상세사유코드 삭제 여부 확인*/
             , A1.FRISU_YN /* 계약상세.무상여부 [무료체험여부] */
             , '' AS FRE_EXPN_CNFM_DTM /* TODO : 무료체험 확정일 매핑정보 확인 필요 무료체험기본.무료체험확정일시(TB_SSOP_FRE_EXPN_BAS.FRE_EXPN_CNFM_DTM)가 있으나 JOIN 정보 확인 불가 */
             , (
                SELECT MAX(G1.CTT_TP_CD) KEEP (DENSE_RANK FIRST ORDER BY G1.CTT_RCP_DTM DESC NULLS LAST, G1.CTT_FSH_DTM DESC NULLS LAST) AS CTT_TP_CD /* 컨택기본.컨택완료일시 */
                  FROM TB_SSOP_CTT_BAS G1 /* 컨택기본 */
                 WHERE G1.DTA_DL_YN = 'N'
                   AND G1.CNTR_NO = A1.CNTR_NO /* 컨택기본.계약번호 = 계약상세.계약번호 */
               ) AS CTT_TP_CD /* [컨택코드] */
             , (
                SELECT  F_CMZ_CD_NM ('TNT_WELLS', 'CNTR_TP_CD', (MAX(G1.CTT_TP_CD) KEEP (DENSE_RANK FIRST ORDER BY G1.CTT_RCP_DTM DESC NULLS LAST, G1.CTT_FSH_DTM DESC NULLS LAST))) AS CTT_TP_CD /* 컨택기본.컨택완료일시 */
                  FROM TB_SSOP_CTT_BAS G1 /* 컨택기본 */
                 WHERE G1.DTA_DL_YN = 'N'
                   AND G1.CNTR_NO = A1.CNTR_NO /* 컨택기본.계약번호 = 계약상세.계약번호 */
               ) AS CTT_TP_NM /* [컨택코드명] */
             , (SELECT MAX(I1.SPP_MTHD_TP_CD) KEEP (DENSE_RANK FIRST ORDER BY I1.SPP_DUEDT DESC NULLS LAST, I1.IOST_DTM DESC NULLS LAST) AS IOST_DTL_CD /* 배송주문기본.배송방식유형코드 */
                  FROM TB_SSSO_SPP_ORD_DTL H1 /* 배송주문상세 */
                 INNER JOIN TB_SSSO_SPP_ORD_BAS I1 /* 배송주문기본 */
                    ON I1.SPP_ORD_NO = H1.SPP_ORD_NO /* 배송주문기본.배송주문번호 = 배송주문상세.배송주문번호 */
                   AND I1.DTA_DL_YN = 'N'
                   AND H1.DTA_DL_YN = 'N'
                 WHERE H1.CNTR_NO = A1.CNTR_NO
                   AND H1.CNTR_SN = A1.CNTR_SN
                   AND I1.IOST_TP_CD = '10' /* 배송주문기본.입출고유형코드 = 10(출고) */
                ) AS IOST_DTL_CD /* 매핑은 배송주문기본.배송방식유형코드(TB_SSSO_SPP_ORD_BAS.SPP_MTHD_TP_CD) [출고구분] */
             , (
                SELECT MAX(SUBSTR(L1.SPP_IVC_CRT_DTM, 1, 8))
                  FROM TB_SSCT_FGPT_RCP_IZ J1 /* 사은품접수내역 */
                 INNER JOIN TB_SSSO_SPP_PLAN_BAS K1 /* 배송계획기본 */
                    ON K1.FGPT_RCP_ID = J1.FGPT_RCP_ID /* 배송계획기본.사은품접수ID = 사은품접수내역.사은품접수ID */
                   AND K1.DTA_DL_YN = 'N'
                   AND J1.DTA_DL_YN = 'N'
                   AND K1.CNTR_NO = J1.DTL_CNTR_NO
                   AND K1.CNTR_SN = J1.DTL_CNTR_SN
                 INNER JOIN TB_SSSO_SPP_ORD_DTL H2 /* 배송주문상세 */
                    ON H2.SPP_PLAN_ID = K1.SPP_PLAN_ID
                   AND H2.CNTR_NO = J1.DTL_CNTR_NO
                   AND H2.CNTR_SN = J1.DTL_CNTR_SN
                   AND H2.DTA_DL_YN = 'N'
                 INNER JOIN TB_SSSO_SPP_BZS_IVC_PROCS_IZ L1/* 배송업체송장처리내역 */
                    ON L1.CNTR_NO = H2.CNTR_NO
                   AND L1.CNTR_SN = H2.CNTR_SN
                   AND L1.SPP_ORD_NO = H2.SPP_ORD_NO
                   AND L1.DTA_DL_YN = 'N'
                 WHERE J1.DTL_CNTR_NO = A1.CNTR_NO
                   AND J1.DTL_CNTR_SN = A1.CNTR_SN
               ) AS SPP_IVC_CRT_DTM /* 배송업체송장처리내역.배송송장생성일시 [사은품택배송장출력일] */
             , CASE WHEN TRIM(A1.BOO_SELL_TP_CD) IS NOT NULL THEN 'Y'
                    ELSE 'N'
               END BOO_SELL_YN /* 예약판매여부 계약상세.예약판매유형코드가 있으면 Y 그외 N [예약판매여부] */
             , B1.CNTR_TP_CD /* 계약기본.계약유형코드 */
             , F_CMZ_CD_NM ('TNT_WELLS', 'CNTR_TP_CD', B1.CNTR_TP_CD) AS CNTR_TP_NM /* [판매유형] */
               /* AS-IS 업무담당자 최초등록자 */
             , B1.SELL_PRTNR_NO /* 계약기본.판매파트너번호 */
             , A1.FST_RGST_USR_ID /* 계약상세.최초등록사용자 [업무담당자]*/
             , A1.FST_RGST_DEPT_ID /* 계약상세.최초등록부서 [조직코드] */
             , (SELECT MAX(N1.RVE_CD)
                  FROM T_CMP_USR_ACO_M N1 /* 사용자기본 */
                 INNER JOIN TB_OGBS_PRTNR_DTL M1 /* 파트너상세 */
                    ON M1.PRTNR_NO = N1.EPNO  /* 파트너상세.파트너번호 = 사용자기본.사번 */
                   AND N1.DEL_YN = 'N'
                  LEFT OUTER JOIN TB_RVDW_RVE_CD N1 /* 수납코드 */
                    ON N1.RVE_CD = M1.RVE_CD /* 수납코드.수납코드 = 파트너상세.수납코드 */
                   AND N1.DTA_DL_YN = 'N'
                 WHERE N1.USR_ID = A1.FST_RGST_USR_ID /* 사용자기본.사용자ID = 계약상세.최초등록사용자 */
               ) AS RVE_CD
               /* 용도구분 매핑정보 확인 이후 진행 - AS-IS:LC3000P.LCIUSE */
             , A1.SV_PRD /* 계약상세.서비스주기 [관리주기] */
             , F1.FRISU_AS_PTRM_N /* 계약WELLS상세.무상AS기간수 [무상AS기간] */
             , F1.FRISU_BFSVC_PTRM_N /* 계약WELLS상세.무상BS기간수 [무상멤버십개월] */
               /* 즉시유상멤버십여부 매핑정보 확인 이후 진행 - AS-IS:LC3000P.LCCK05 */
             , F_CMZ_CD_NM('TNT_WELLS', 'ALNCMP_CD', B1.ALNCMP_CD) AS ALNCMP_NM /* 제휴사코드명 [제휴코드명] */
             , F1.SELL_EV_CD /* 계약WELLS상세.판매행사코드 */
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_EV_CD', F1.SELL_EV_CD) AS SELL_EV_NM /* 판매행사코드명 [행사코드명] */
             , A1.FNL_AMT /* 계약상세.최종금액 [총판매금] */
             , A1.SELL_AMT /* 계약상세.판매금액 [공급가] */
             , A1.VAT /* 계약상세.부가가치세 [부가세] */
             , A1.CNTR_AMT /* 계약상세.계약금액 [확정청약금] */
             , A1.ISTM_INT_AMT /* 계약상세.할부이자금액 */
             , A1.FEE_ACKMT_BASE_AMT /* 계약상세.수수료인정기준금액 [수수료] */
             , '' AS CRP_UC  /* TODO : 법인미수 매핑정보 확인 이후 진행 - AS-IS:LC3000P.LCGAMT TB_SSCT_CNTR_PRC_CMPT_IZ 확인 */
             , '' AS TOT_DSC_AMT  /* TODO : 총할인금 매핑정보 확인 이후 진행 - AS-IS:LC3000P.LCRAMT 230314 매핑정보 및 계산식이 없음, TB_SSCT_CNTR_PRC_CMPT_IZ 확인 */
             , A1.FEE_ACKMT_CT /* 계약상세.수수료인정건수 [인정건수] */
             , A1.ACKMT_PERF_AMT /* 계약상세.인정실적금액(최종금액비율안분) [총인정금] */
             , A1.FEE_ACKMT_BASE_AMT AS FEE_ACKMT_TOT_AMT /* 계약상세.수수료인정기준금액 [총기준수수료] */
             , A1.FEE_FXAM_YN /* 계약상세.수수료정액여부 [수수료정액여부] */
             , '' AS PD_SALE_FEE  /* TODO : 판매수수료 매핑정보 확인 이후 진행 - AS-IS:LC3000P.LCFAMT, TB_SSCT_CNTR_PRC_CMPT_IZ 확인 */
             , '' AS CASH_BLAM /* TODO : 현금잔액 매핑정보 확인 이후 진행 - AS-IS:LC3000P.LCJAMT TB_SSCT_CNTR_PRC_CMPT_IZ 확인 */
             , A1.ISTM_MCN /* 계약상세.할부개월수 [할부개월수] */
             , A1.MM_ISTM_AMT /* 계약상세.월할부금액 [월할부금] */
             , A1.ISTM_PCAM_AMT /* 계약상세.할부원금액(최종금액비율안분) [총할부금액] */
             , B1.CNTR_CST_NO /* 계약기본.계약고객번호 [고객번호] */
             , C1.CRAL_LOCARA_TNO /* 휴대지역전화번호(계약자) [계약자휴대전화번호] */
             , O1.NEW_ADR_ZIP /* 주소기본.신주소우편번호(계약자) [우편번호]*/
             , O1.RNADR /* 주소기본.도로명주소(계약자) [계약자 기준주소] */
             , O1.RDADR /* 주소기본.도로명상세주소(계약자) [계약자 상세주소] */
             , R1.RCGVP_KNM /* 수령자한글명 [설치자명] */
             , R1.CRAL_LOCARA_TNO AS ISTLC_CRAL_LOCARA_TNO/* 휴대지역전화번호 [설치자 휴대전화번호] */
             , NVL2(R1.NEW_ADR_ZIP, R1.NEW_ADR_ZIP, R1.OLD_ADR_ZIP) AS ISTLC_ADR_ZIP /* [설치자우편번호] */
             , NVL2(R1.RNADR, R1.RNADR, R1.LTN_ADR) AS ISTLC_ADR /* [설치자 기준주소] */
             , NVL2(R1.RDADR, R1.RDADR, R1.LTN_DTL_ADR) AS ISTLC_DADR /* [설치자 상세주소] */
               /* TODO : 결합구분 AS-IS LC3000P.LCST04: 1(모종결합), H(홈케어), M(홈케어멤버십) → 결합구분에 대해 확인 할 수 없으므로 AS-IS와 동일하게 체크 */
             , F_CMZ_CD_NM('TNT_WELLS', 'CNTR_REL_DTL_CD',
               (SELECT MAX(CNTR_REL_DTL_CD) /* 계약관계상세코드 */
                  FROM TB_SSCT_CNTR_REL S1 /* 계약관계 */
                 WHERE S1.CNTR_UNIT_TP_CD = '020' /* 계약관계.계약단위유형코드 = '020'(계약상세) */
                   AND S1.BASE_DTL_CNTR_NO = A1.CNTR_NO /* 기준상세계약번호 */
                   AND S1.BASE_DTL_CNTR_SN = A1.CNTR_SN/* 기준상세계약일련번호*/
                   AND S1.DTA_DL_YN = 'N'
                   AND S1.CNTR_REL_DTL_CD IN ( '216', '219', '221' ) /* 216(모종결합), 219(홈케어), 221(홈페이멤버십)  */
                 )) AS CNTR_REL_DTL_NM /* 계약관계상세코드명 [결합구분]*/
             , B1.ALNCMP_CNTR_DRM_VAL   /* 제휴사계약식별값(LCCK11+LCCK12+LCCK13) MKN*/
             , F_CMZ_CD_NM('TNT_WELLS', 'ALNCMP_CD', T1.ALNCMP_CD) AS ALNCMP_CD /* 제휴사코드명 [제휴코드] */
             , (SELECT MAX(U1.ALNC_PRTNR_DRM_VAL) KEEP (DENSE_RANK FIRST ORDER BY U1.VL_END_DTM DESC NULLS LAST) AS ALNC_PRTNR_DRM_VAL /* 제휴파트너 식별값  */
                  FROM TB_SSCT_CNTR_PRTNR_REL U1 /* 계약파트너관계 */
                 WHERE U1.CNTR_NO = A1.CNTR_NO
                   AND U1.DTA_DL_YN = 'N'
                   AND U1.CNTR_PRTNR_TP_CD IN ('040') /* 계약파트너유형코드 : 대리계약판매자(040)   MKN */
                   AND U1.VL_END_DTM = '99991231235959'
               ) AS ALNC_PRTNR_DRM_VAL /* 제휴판매자코드 */
             , '' AS SPC_ORD_DV  /* TODO : 특별주문구분 매핑정보 확인 이후 진행 - AS-IS:LC3000P.LCET01 P(K포인트), W(W머니), V(W포인트) */
             , (SELECT MAX(I2.SPP_ORD_IVC_NO) KEEP (DENSE_RANK FIRST ORDER BY I2.SPP_DUEDT DESC NULLS LAST) AS SPP_ORD_IVC_NO /* 배송주문송장번호 */
                  FROM TB_SSSO_SPP_ORD_DTL H3 /* 배송주문상세 */
                 INNER JOIN TB_SSSO_SPP_ORD_BAS I2 /* 배송주문기본 */
                    ON I2.SPP_ORD_NO = H3.SPP_ORD_NO /* 배송주문기본.배송주문번호 = 배송주문상세.배송주문번호*/
                   AND H3.DTA_DL_YN = 'N'
                   AND I2.DTA_DL_YN = 'N'
                 WHERE H3.CNTR_NO = A1.CNTR_NO
                   AND H3.CNTR_SN = A1.CNTR_SN
               ) AS SPP_ORD_IVC_NO /* 배송주문송장번호 [송장정보] */
             , (
                SELECT MAX(D2.PD_ABBR_NM) /* 상품기본.상품명 */
                  FROM TB_PDBS_PD_BAS D2 /* 상품기본 */
                 WHERE D2.PD_CD = A1.BASE_PD_CD /* 상품기본.상품코드 = 계약상세.기준상품코드 */
                   AND D2.DTA_DL_YN = 'N'
               ) ||'('||A1.BASE_PD_CD||'):'||A1.PD_QTY AS BASE_PD_INFO /* [상품명]  MKN */
             , A1.BASE_PD_CD AS BASE_PD_CD2 /* [상품코드] */
             , A1.PD_QTY /* [상품수량] */
             , X1.FGPT_PD_NM1 /* [사은품1] */
             , X1.FGPT_PD_NM2 /* [사은품2] */
             , X1.FGPT_PD_NM3 /* [사은품3] */
             , X1.FGPT_PD_NM4 /* [사은품4] */
             , F1.BFSVC_BZS_DV_CD /* BS업체구분코드 */
             , F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_BZS_DV_CD', F1.BFSVC_BZS_DV_CD) AS BFSVC_BZS_DV_NM /* BS업체구분코드명 [업체BS구분] */
             , F1.SPLY_BZS_DV_CD /* 조달업체구분코드 */
             , F_CMZ_CD_NM('TNT_WELLS', 'SPLY_BZS_DV_CD', F1.SPLY_BZS_DV_CD) AS SPLY_BZS_DV_NM /* 조달업체구분코드명 [업체구분] */
             , B1.CNTR_CAN_DTM /* 계약취소일시 */
          FROM TB_SSCT_CNTR_DTL A1 /* 계약상세 */
         INNER JOIN TB_SSCT_CNTR_BAS B1 /* 계약기본 */
            ON A1.CNTR_NO = B1.CNTR_NO /* 계약상세.계약번호 = 계약기본.계약번호  */
           AND A1.DTA_DL_YN = 'N' /* 계약상세.데이터삭제여부 = 'N' */
           AND B1.DTA_DL_YN = 'N' /* 계약기본.데이터삭제여부 = 'N' */
         INNER JOIN TB_CUBS_CST_BAS C1 /* 고객기본 */
            ON C1.CST_NO = B1.CNTR_CST_NO /* 고객기본.고객번호 = 계약기본.계약고객번호 */
           AND C1.DTA_DL_YN = 'N' /* 고객기본.데이터삭제여부 = 'N' */
           AND C1.TEMP_SAVE_YN = 'N' /* 고객기본.임시저장여부 = 'N' */
          LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL F1 /* 계약WELLS상세 */
            ON F1.CNTR_NO = A1.CNTR_NO
           AND F1.CNTR_SN = A1.CNTR_SN
          LEFT OUTER JOIN TB_GBCO_ADR_BAS O1 /* 주소기본 - 계약자의 주소정보를 참조 */
            ON O1.ADR_ID = C1.ADR_ID
           AND O1.DTA_DL_YN = 'N'
         LEFT OUTER JOIN LATERAL
            (
             SELECT P1.CNTR_NO
                  , P1.DTL_CNTR_NO
                  , P1.DTL_CNTR_SN
                  , Q1.RCGVP_KNM /* 수령자한글명 */
                  , Q1.CRAL_LOCARA_TNO /* 휴대지역전화번호 */
                  , Q1.MEXNO_ENCR /* 휴대전화국번호암호화 */
                  , Q1.CRAL_IDV_TNO /*휴대개별전화번호 */
                  , Q1.ADR_DV_CD /* 주소구분코드*/
                  , TRIM(O2.NEW_ADR_ZIP) AS NEW_ADR_ZIP /* 신주소우편번호 */
                  , TRIM(O2.RNADR) AS RNADR /* 도로명주소 */
                  , TRIM(O2.RDADR) AS RDADR /* 도로명상세주소 */
                  , TRIM(O2.OLD_ADR_ZIP) AS OLD_ADR_ZIP /* 구주소우편번호 */
                  , TRIM(O2.LTN_ADR) AS LTN_ADR /* 지번주소 */
                  , TRIM(O2.LTN_DTL_ADR) AS LTN_DTL_ADR /* 지번상세주소 */
               FROM TB_SSCT_CNTR_ADR_REL P1 /* 계약주소관계 */
              INNER JOIN TB_SSCT_CNTR_ADRPC_BAS Q1/* 계약주소지기본 */
                 ON Q1.CNTR_NO = P1.DTL_CNTR_NO
                AND Q1.CNTR_ADRPC_ID = P1.CNTR_ADRPC_ID /* 계약주소지기본.계약주소지ID = 계약주소관계.계약주소지ID */
              INNER JOIN TB_GBCO_ADR_BAS O2 /* 주소 기본 */
                 ON O2.ADR_ID = Q1.ADR_ID
              WHERE P1.DTL_CNTR_NO = A1.CNTR_NO
                AND P1.DTL_CNTR_SN = A1.CNTR_SN
                AND P1.CNTR_UNIT_TP_CD = '020' /* 계약주소관계.계약단위유형코드 */
                AND P1.ADRPC_TP_CD = '3' /* 주소지유형코드 = '3'(설치처) */
                AND P1.DTA_DL_YN = 'N'
                AND O2.DTA_DL_YN = 'N'
                AND Q1.DTA_DL_YN = 'N'
            ) R1
           ON R1.DTL_CNTR_NO = A1.CNTR_NO
          AND R1.DTL_CNTR_SN = A1.CNTR_SN
         LEFT OUTER JOIN TB_SSCT_ACMPAL_CNTR_IZ T1 /* 관계사제휴계약내역 */
           ON T1.BASE_CNTR_NO = A1.CNTR_NO
          AND T1.BASE_CNTR_SN = A1.CNTR_SN
          AND T1.DTA_DL_YN = 'N'
          AND T1.ALNC_STAT_TP_CD = '10' /* 제휴상태유형코드 = '10'(제휴정상) */
         LEFT OUTER JOIN LATERAL /* 사은품 4개까지 */
              (
               SELECT W1.DTL_CNTR_NO
                    , W1.DTL_CNTR_SN
                    , MAX(W1.FGPT_PD_NM1) AS FGPT_PD_NM1
                    , MAX(W1.FGPT_PD_NM2) AS FGPT_PD_NM2
                    , MAX(W1.FGPT_PD_NM3) AS FGPT_PD_NM3
                    , MAX(W1.FGPT_PD_NM4) AS FGPT_PD_NM4
                 FROM (
                       SELECT V1.DTL_CNTR_NO
                            , V1.DTL_CNTR_SN
                            , CASE WHEN ROWNUM = 1
                                        THEN V1.FGPT_PD_NM
                                   ELSE ''
                              END FGPT_PD_NM1
                            , CASE WHEN ROWNUM = 2
                                        THEN V1.FGPT_PD_NM
                                   ELSE ''
                              END FGPT_PD_NM2
                            , CASE WHEN ROWNUM = 3
                                        THEN V1.FGPT_PD_NM
                                   ELSE ''
                              END FGPT_PD_NM3
                            , CASE WHEN ROWNUM = 4
                                        THEN V1.FGPT_PD_NM
                                   ELSE ''
                              END FGPT_PD_NM4
                         FROM
                              (
                               SELECT J2.DTL_CNTR_NO
                                    , J2.DTL_CNTR_SN
                                    , J2.FGPT_PD_CD /* 사은품상품코드 */
                                    , (
                                       SELECT MAX(D3.PD_NM) /* 상품기본.상품명 */
                                         FROM TB_PDBS_PD_BAS D3 /* 상품기본 */
                                        WHERE D3.PD_CD = J2.FGPT_PD_CD /* 상품기본.상품코드 = 계약상세.기준상품코드 */
                                          AND D3.DTA_DL_YN = 'N'
                                      ) AS FGPT_PD_NM /* [상품명] */
                                 FROM TB_SSCT_FGPT_RCP_IZ J2 /* 사은품접수내역 */
                                INNER JOIN TB_SSSO_SPP_PLAN_BAS K2 /* 배송계획기본 */
                                   ON K2.FGPT_RCP_ID = J2.FGPT_RCP_ID /* 배송계획기본.사은품접수ID = 사은품접수내역.사은품접수ID */
                                  AND K2.DTA_DL_YN = 'N'
                                  AND J2.DTA_DL_YN = 'N'
                                  AND K2.CNTR_NO = J2.DTL_CNTR_NO
                                  AND K2.CNTR_SN = J2.DTL_CNTR_SN
                                INNER JOIN TB_SSSO_SPP_ORD_DTL H4 /* 배송주문상세 */
                                   ON H4.SPP_PLAN_ID = K2.SPP_PLAN_ID
                                  AND H4.CNTR_NO = J2.DTL_CNTR_NO
                                  AND H4.CNTR_SN = J2.DTL_CNTR_SN
                                  AND H4.DTA_DL_YN = 'N'
                                INNER JOIN TB_SSSO_SPP_ORD_BAS I3 /* 배송주문기본 */
                                   ON I3.SPP_ORD_NO = H4.SPP_ORD_NO
                                  AND I3.DTA_DL_YN = 'N'
                                  AND I3.SPP_PRGS_STAT_CD = '70' /* 배송진행상태코드 = '70'(배송완료)*/
                                WHERE J2.DTL_CNTR_NO = A1.CNTR_NO
                                  AND J2.DTL_CNTR_SN = A1.CNTR_SN
                                 ORDER BY J2.FGPT_PD_CD
                              ) V1
                        WHERE ROWNUM <![CDATA[ <= ]]> 4
                      ) W1
                GROUP BY W1.DTL_CNTR_NO, W1.DTL_CNTR_SN
              ) X1
           ON X1.DTL_CNTR_NO = A1.CNTR_NO
          AND X1.DTL_CNTR_SN = A1.CNTR_SN
        WHERE 1=1
        <if test='@MybatisUtils@equals(searchGbn,"1")'>
          AND C1.BRYY_MMDD = #{bryyMmdd}
            <if test='@MybatisUtils@equals(sexGbn,"M")'>
                AND C1.SEX_DV_CD IN ('1','3')
            </if>
            <if test='@MybatisUtils@equals(sexGbn,"F")'>
                AND C1.SEX_DV_CD IN ('2','4')
            </if>
        </if>
        <if test='@MybatisUtils@equals(searchGbn,"2")'>
          AND C1.BZRNO = #{bzrno}
        </if>
        <if test='@MybatisUtils@equals(searchGbn,"3")'>
          AND C1.BZRNO = #{bzrno}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cstKnm)'>
          AND C1.CST_KNM LIKE '%'||#{cstKnm}||'%'
        </if>
        <if test='@MybatisUtils@isNotEmpty(cralLocaraTno)'>
          AND C1.CRAL_LOCARA_TNO = #{cralLocaraTno}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrCstNo)'>
          AND B1.CNTR_CST_NO LIKE #{cntrCstNo}||'%'
        </if>
        <if test='@MybatisUtils@equals(cntrCanYn,"Y")'>
          AND B1.CNTR_CAN_DTM IS NULL
        </if>
    </select>
</mapper>
