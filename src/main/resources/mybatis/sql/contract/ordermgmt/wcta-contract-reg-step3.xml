<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.ordermgmt.mapper.WctaContractRegStep3Mapper">

    <select id="selectAdrInfoByCntrAdrpcId" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dvo.WctaContractRegStep3Dvo">
        SELECT CASE WHEN T1.ADR_DV_CD = '1' THEN T2.NEW_ADR_ZIP
                    WHEN T1.ADR_DV_CD = '2' THEN T2.OLD_ADR_ZIP
                    ELSE ''
                    END AS ZIP
             , CASE WHEN T1.ADR_DV_CD = '1' THEN T2.RNADR
                    WHEN T1.ADR_DV_CD = '2' THEN T2.LTN_ADR
                    ELSE ''
                    END AS ADR
             , CASE WHEN T1.ADR_DV_CD = '1' THEN T2.RDADR
                    WHEN T1.ADR_DV_CD = '2' THEN T2.LTN_DTL_ADR
                    ELSE ''
                    END AS ADR_DTL
             , T1.ADR_ID
          FROM TB_SSCT_CNTR_ADRPC_BAS T1
         INNER JOIN TB_GBCO_ADR_BAS T2
            ON T2.ADR_ID = T1.ADR_ID
           AND T2.DTA_DL_YN = 'N'
         WHERE T1.CNTR_ADRPC_ID = #{cntrAdrpcId}
           AND T1.DTA_DL_YN = 'N'
    </select>

    <select id="selectAdrInfoByCntrCstNo" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dvo.WctaContractRegStep3Dvo">
        SELECT T1.CST_KNM AS RCGVP_KNM
             , T1.CRAL_LOCARA_TNO
             , T1.MEXNO_ENCR
             , T1.CRAL_IDV_TNO
             , CASE WHEN T2.RNADR IS NOT NULL THEN T2.RNADR
                    WHEN T2.LTN_ADR IS NOT NULL THEN T2.LTN_ADR
                    ELSE ''
                    END AS ADR
             , CASE WHEN T2.RDADR IS NOT NULL THEN T2.RDADR
                    WHEN T2.LTN_DTL_ADR IS NOT NULL THEN T2.LTN_DTL_ADR
                    ELSE ''
                    END AS ADR_DTL
             , CASE WHEN T2.NEW_ADR_ZIP IS NOT NULL THEN T2.NEW_ADR_ZIP
                    WHEN T2.OLD_ADR_ZIP IS NOT NULL THEN T2.OLD_ADR_ZIP
                    ELSE ''
                    END AS ZIP
             , CASE WHEN T2.RNADR IS NOT NULL THEN '1'
                    ELSE '2'
                    END AS ADR_DV_CD
             , T1.ADR_ID
          FROM TB_CUBS_CST_BAS T1
         INNER JOIN TB_GBCO_ADR_BAS T2
            ON T2.ADR_ID = T1.ADR_ID
           AND T2.DTA_DL_YN = 'N'
         WHERE 1=1
           AND T1.CST_NO = #{cstNo}
           AND T1.DTA_DL_YN = 'N'
    </select>

    <!-- STEP3 저장 -->
    <update id="updateCntrDtlStep3">
        UPDATE TB_SSCT_CNTR_DTL /* 계약상세 */
           SET RVE_CRP_CD          = #{rveCrpCd}            /* 수납법인코드 */
             , STLM_TP_CD          = #{stlmTpCd}            /* 결제유형코드 */
             , CRNCY_DV_CD         = #{crncyDvCd}           /* 통화구분코드 */
             , CNTR_AMT            = #{cntrAmt}             /* 계약금액 */
             , ISTM_MCN            = #{istmMcn}             /* 할부개월수 */
             , ISTM_PCAM_AMT       = #{istmPcamAmt}         /* 할부원금금액 */
             , ISTM_INT_AMT        = #{istmIntAmt}          /* 할부이자금액 */
             , MM_ISTM_AMT         = #{mmIstmAmt}           /* 월할부금액 */
             , SPP_DUEDT           = #{sppDuedt}            /* 배송예정일자 */
            <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND CNTR_NO             = #{cntrNo}              /* 계약번호 */
           AND CNTR_SN             = #{cntrSn}              /* 계약일련번호 */
           AND DTA_DL_YN = 'N'
    </update>

    <insert id="insertCntrStlmRelStep3">
        <selectKey keyProperty="item.cntrStlmRelId" resultType="java.lang.String" order="BEFORE">
        SELECT LPAD(NVL(MAX(TO_NUMBER(CNTR_STLM_REL_ID)) + 1, 1), 15, 0)
          FROM TB_SSCT_CNTR_STLM_REL
        </selectKey>
        INSERT INTO TB_SSCT_CNTR_STLM_REL (  /* 계약결제관계 */
               CNTR_STLM_REL_ID   /* 계약결제관계ID */
             , VL_STRT_DTM        /* 유효시작일시 */
             , VL_END_DTM         /* 유효종료일시 */
             , CNTR_UNIT_TP_CD    /* 계약단위유형코드 */
             , CNTR_STLM_ID       /* 계약결제ID */
             , CNTR_NO            /* 계약번호 */
             , DTL_CNTR_NO        /* 상세계약번호 */
             , DTL_CNTR_SN        /* 상세계약일련번호 */
             , DP_TP_CD           /* 입금유형코드 */
             , RVE_DV_CD          /* 수납구분코드 */
             , ISLND_INCMDC_TP_CD /* 도서지역소득공제유형코드 */
             , STLM_AMT           /* 결제금액 */
             <include refid="COMMON.insertSystemField" />)
         VALUES (
               #{item.cntrStlmRelId}
             , #{item.vlStrtDtm}
             , #{item.vlEndDtm}
             , #{item.cntrUnitTpCd}
             , #{item.cntrStlmId}
             , #{item.cntrNo}
             , #{item.dtlCntrNo}
             , #{item.dtlCntrSn}
             , #{item.dpTpCd}
             , #{item.rveDvCd}
             , #{item.islndIncmdcTpCd}
             , #{item.stlmAmt}
             <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <insert id="insertCntrAdrpcBasStep3">
        <selectKey keyProperty="item.cntrAdrpcId" resultType="java.lang.String" order="BEFORE">
        SELECT LPAD(NVL(MAX(TO_NUMBER(CNTR_ADRPC_ID)) + 1, 1), 15, 0)
          FROM TB_SSCT_CNTR_ADRPC_BAS
        </selectKey>
        INSERT INTO TB_SSCT_CNTR_ADRPC_BAS (  /* 계약주소지기본 */
               CNTR_ADRPC_ID           /* 계약주소지ID */
             , CNTR_NO                 /* 계약번호 */
             , CNTR_CST_NO             /* 계약고객번호 */
             , CNTRT_REL_CD            /* 계약자관계코드 */
             , RCGVP_KNM               /* 수령자한글명 */
             , RCGVP_ENM               /* 수령자영문명 */
             , COPN_DV_CD              /* 법인격구분코드 */
             , CRP_SPMT_DRM_NM         /* 법인추가식별명 */
             , NAT_CD                  /* 국가코드 */
             , ADR_DV_CD               /* 주소구분코드 */
             , ADR_ID                  /* 주소ID */
             , CRAL_LOCARA_TNO         /* 휴대지역전화번호 */
             , MEXNO_ENCR              /* 휴대전화국번호암호화 */
             , CRAL_IDV_TNO            /* 휴대개별전화번호 */
             , LOCARA_TNO              /* 지역전화번호 */
             , EXNO_ENCR               /* 전화국번호암호화 */
             , IDV_TNO                 /* 개별전화번호 */
             , EMADR                   /* 이메일주소 */
             , CNR_SPP_YN              /* 센터배송여부 */
             , OG_TP_CD                /* 조직유형코드 */
             , BLD_CD                  /* 빌딩코드 */
             , MVS_DSTC_RCVRY_BASE_DTM /* 소산파기복구기준일시 */
             , MVS_DSTC_RCVRY_DV_CD    /* 소산파기복구구분코드 */
             , MVS_DSTC_RCVRY_DTM      /* 소산파기복구일시 */
             <include refid="COMMON.insertSystemField" />)
         VALUES (
               #{item.cntrAdrpcId}
             , #{item.cntrNo}
             , #{item.cntrCstNo}
             , #{item.cntrtRelCd}
             , #{item.rcgvpKnm}
             , #{item.rcgvpEnm}
             , #{item.copnDvCd}
             , #{item.crpSpmtDrmNm}
             , #{item.natCd}
             , #{item.adrDvCd}
             , #{item.adrId}
             , #{item.cralLocaraTno}
             , #{item.mexnoEncr}
             , #{item.cralIdvTno}
             , #{item.locaraTno}
             , #{item.exnoEncr}
             , #{item.idvTno}
             , #{item.emadr}
             , #{item.cnrSppYn}
             , #{item.ogTpCd}
             , #{item.bldCd}
             , #{item.mvsDstcRcvryBaseDtm}
             , #{item.mvsDstcRcvryDvCd}
             , #{item.mvsDstcRcvryDtm}
             <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <insert id="insertCntrAdrRelStep3">
        <selectKey keyProperty="item.cntrAdrRelId" resultType="java.lang.String" order="BEFORE">
        SELECT LPAD(NVL(MAX(TO_NUMBER(CNTR_ADR_REL_ID)) + 1, 1), 15, 0)
          FROM TB_SSCT_CNTR_ADR_REL
        </selectKey>
        INSERT INTO TB_SSCT_CNTR_ADR_REL (  /* 계약주소관계 */
               CNTR_ADR_REL_ID    /* 계약주소관계ID */
             , VL_STRT_DTM        /* 유효시작일시 */
             , VL_END_DTM         /* 유효종료일시 */
             , ADRPC_TP_CD        /* 주소지유형코드 */
             , CNTR_UNIT_TP_CD    /* 계약단위유형코드 */
             , CNTR_NO            /* 계약번호 */
             , DTL_CNTR_NO        /* 상세계약번호 */
             , DTL_CNTR_SN        /* 상세계약일련번호 */
             , CNTR_ADRPC_ID      /* 계약주소지ID */
             , VST_RQDT           /* 방문요청일자 */
             , VST_AK_STRT_HM     /* 방문요청시작시분 */
             , VST_AK_END_HM      /* 방문요청종료시분 */
             , URGT_OJ_YN         /* 긴급대상여부 */
             , CNTRW_POSND_TP_CD  /* 계약서발송처유형코드 */
             , SPP_MTHD_TP_CD     /* 배송방식유형코드 */
             , SPP_ICHR_AOFFCE_CD /* 배송담당사무소코드 */
             , SPP_ICHR_USR_ID    /* 배송담당사용자ID */
             , CNTR_CH_RCP_ID     /* 계약변경접수ID */
             <include refid="COMMON.insertSystemField" />)
         VALUES (
               #{item.cntrAdrRelId}
             , #{item.vlStrtDtm}
             , #{item.vlEndDtm}
             , #{item.adrpcTpCd}
             , #{item.cntrUnitTpCd}
             , #{item.cntrNo}
             , #{item.dtlCntrNo}
             , #{item.dtlCntrSn}
             , #{item.cntrAdrpcId}
             , #{item.vstRqdt}
             , #{item.vstAkStrtHm}
             , #{item.vstAkEndHm}
             , #{item.urgtOjYn}
             , #{item.cntrwPosndTpCd}
             , #{item.sppMthdTpCd}
             , #{item.sppIchrAoffceCd}
             , #{item.sppIchrUsrId}
             , #{item.cntrChRcpId}
             <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <delete id="deleteStlmRelsStep3">
        DELETE TB_SSCT_CNTR_STLM_REL
         WHERE DTL_CNTR_NO = #{cntrNo}
    </delete>

    <delete id="deleteAdrpcBasStep3">
        DELETE TB_SSCT_CNTR_ADRPC_BAS
         WHERE CNTR_NO = #{cntrNo}
    </delete>

    <delete id="deleteAdrRelsStep3">
        DELETE TB_SSCT_CNTR_ADR_REL
         WHERE DTL_CNTR_NO = #{cntrNo}
    </delete>

    <delete id="deleteCntrPrccchHistory">
        DELETE TB_SSCT_CNTR_PRCCCH_HIST
         WHERE CNTR_NO = #{cntrNo}
    </delete>
</mapper>
