<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.ordermgmt.mapper.WctaEmployeePrchsGcfMngtMapper">
    <select id="selectEmployeePurchaseGcfs" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dvo.WctaEmployeePrchsGcfMngtDvo">
        SELECT T5.HMNRSC_EMPNO AS EMPNO	/* 인사사원번호 */
             , T6.FNM AS FNM
             , T6.CRAL_LOCARA_TNO AS CRAL_LOCARA_TNO
             , T6.MEXNO_ENCR AS MEXNO_ENCR
             , T6.CRAL_IDV_TNO AS CRAL_IDV_TNO
             --, T6.CRAL_LOCARA_TNO || '-' || T6.MEXNO_ENCR || '-' || T6.CRAL_IDV_TNO AS CNTR_CRAL_TNO
             , MAX(T6.RSGN_DT) AS RSGN_DT
             , MAX(CASE WHEN T2.SELL_INFLW_CHNL_DTL_CD = '9020' THEN '임직원' ELSE T5.OG_NM END) AS SELL_INFLW_CHNL_DTL_CD
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'MM') THEN 1 ELSE 0 END) AS CNT_PRE
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'MM') AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_PRE_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'MM') THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'MM') AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_PRE_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = TO_CHAR(SYSDATE, 'MM') THEN 1 ELSE 0 END) AS CNT_CUR
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = TO_CHAR(SYSDATE, 'MM') AND T1.CNTR_DTL_STAT_CD = '303'  THEN 1 ELSE 0 END) AS CNT_CUR_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = TO_CHAR(SYSDATE, 'MM') THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = TO_CHAR(SYSDATE, 'MM') AND T1.CNTR_DTL_STAT_CD = '303'  THEN 1 ELSE 0 END) AS CNT_CUR_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '01' THEN 1 ELSE 0 END) AS CNT_01
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '01' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_01_C	/* 설치 후 취소건 */
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '01' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '01' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_01_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '02' THEN 1 ELSE 0 END) AS CNT_02
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '02' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_02_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '02' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '02' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_02_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '03' THEN 1 ELSE 0 END) AS CNT_03
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '03' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_03_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '03' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '03' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_03_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '04' THEN 1 ELSE 0 END) AS CNT_04
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '04' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_04_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '04' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '04' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_04_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '05' THEN 1 ELSE 0 END) AS CNT_05
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '05' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_05_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '05' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '05' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_05_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '06' THEN 1 ELSE 0 END) AS CNT_06
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '06' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_06_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '06' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '06' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_06_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '07' THEN 1 ELSE 0 END) AS CNT_07
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '07' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_07_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '07' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '07' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_07_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '08' THEN 1 ELSE 0 END) AS CNT_08
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '08' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_08_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '08' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '08' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_08_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '09' THEN 1 ELSE 0 END) AS CNT_09
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '09' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_09_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '09' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '09' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_09_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '10' THEN 1 ELSE 0 END) AS CNT_10
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '10' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_10_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '10' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '10' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_10_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '11' THEN 1 ELSE 0 END) AS CNT_11
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '11' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_11_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '11' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '11' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_11_FNL
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '12' THEN 1 ELSE 0 END) AS CNT_12
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '12' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_12_C
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '12' THEN 1 ELSE 0 END) - SUM(CASE WHEN SUBSTR(T3.IST_DT, 5,2) = '12' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_12_FNL
             , COUNT(1) AS CNT_TOT
             , SUM(CASE WHEN SUBSTR(T3.IST_DT, 1,4) = '2023' AND T1.CNTR_DTL_STAT_CD = '303' THEN 1 ELSE 0 END) AS CNT_TOT_C
         FROM TB_SSCT_CNTR_DTL T1  /* T.계약상세 */
        INNER JOIN TB_SSCT_CNTR_BAS T2  /* T.계약기본 */
           ON T2.CNTR_NO = T1.CNTR_NO
          AND T2.DTA_DL_YN = 'N'
          AND T2.SELL_INFLW_CHNL_DTL_CD = '9020'
          --AND T2.SELL_OG_TP_CD = 'HR1'
         LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T3	/* T.계약WELLS상세 */
           ON T3.CNTR_NO = T1.CNTR_NO
          AND T3.CNTR_SN = T1.CNTR_SN
          AND T3.DTA_DL_YN = 'N'
         LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ T5	/* T.월파트너내역 */
           ON T5.PRTNR_NO = T2.SELL_PRTNR_NO
          AND T5.OG_TP_CD = T2.SELL_OG_TP_CD
          AND T5.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
          AND T5.DTA_DL_YN = 'N'
         LEFT OUTER JOIN LATERAL (
                        /* 임직원-사번변경된 경우 최종사번으로 조회 */
                        SELECT FNM
                             , CRAL_LOCARA_TNO
                             , MEXNO_ENCR
                             , CRAL_IDV_TNO
                             , RSGN_DT --퇴직일자
                        FROM TB_OGBS_EMP_BAS
                        WHERE SAP_REF_EMPNO_VAL IS NULL  --SAP 참조사번
                        START WITH SAP_EMPNO = T5.HMNRSC_EMPNO
                        CONNECT BY PRIOR SAP_REF_EMPNO_VAL=SAP_EMPNO
                        ) T6
           ON 1=1
         LEFT OUTER JOIN TB_SSCT_CNTR_CST_REL T7	/* T.계약자관계코드 */
           ON T7.DTL_CNTR_NO = T1.CNTR_NO
          AND T7.DTL_CNTR_SN = T1.CNTR_SN
          AND CNTR_CST_REL_TP_CD = '10' /* 계약자 */
          -- AND CNTRT_REL_CD = '01'	/* 계약자관계코드 - 01:본인, 07:지인 */
        WHERE 1=1
          AND T1.SELL_TP_CD = '2'	/* 렌탈 */
          AND TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') <![CDATA[ >= ]]>  TO_DATE(T3.IST_DT, 'YYYYMMDD') + 14
          AND T3.IST_DT LIKE #{istDt} || '%'  /* 매출일자 데이타 없어서 우선 대체해서 테스트 */
        <if test="@MybatisUtils@isNotEmpty(emplDv)">
            <choose>
                <when test='@MybatisUtils@equals(emplDv, "1")'> /* 임직원 */
                    AND T2.SELL_OG_TP_CD = 'HR1'
                </when>
                <otherwise> /* 사업자 */
                    AND T2.SELL_OG_TP_CD != 'HR1'
                </otherwise>
            </choose>
        </if>
        <if test="@MybatisUtils@isNotEmpty(empNo)">
          AND T5.HMNRSC_EMPNO = #{empNo}
        </if>
        <if test="@MybatisUtils@isNotEmpty(cntrtRelCd)">
           AND T7.CNTRT_REL_CD = #{cntrtRelCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
           AND T6.CRAL_LOCARA_TNO = #{cralLocaraTno}
        </if>
        <if test="@MybatisUtils@isNotEmpty(mexnoEncr)">
           AND T6.MEXNO_ENCR = #{mexnoEncr}
        </if>
        <if test="@MybatisUtils@isNotEmpty(cralIdvTno)">
           AND T6.CRAL_IDV_TNO = #{cralIdvTno}
        </if>
        GROUP BY T5.HMNRSC_EMPNO
               , T6.FNM
               , T6.CRAL_LOCARA_TNO
               , T6.MEXNO_ENCR
               , T6.CRAL_IDV_TNO
    </select>

</mapper>
