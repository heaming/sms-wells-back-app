<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.ordermgmt.mapper.WctbCancellationMtrSetMapper">
    <select id="selectContractBase" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctbCancellationMtrSetDto$SearchRes">
        SELECT T2.CNTR_NO              /* 계약번호 */
             , T2.CNTR_SN              /* 계약일련번호 */
             , T1.CNTR_CAN_DTM         /* 계약취소일시 */
        FROM TB_SSCT_CNTR_BAS T1 /* 계약기본 */
        LEFT OUTER JOIN TB_SSCT_CNTR_DTL T2 /* 계약상세 */
            ON T1.CNTR_NO = T2.CNTR_NO /* 계약기본.계약번호 = 계약상세.계약번호*/
        WHERE 1 = 1
            AND T2.CNTR_DTL_STAT_CD              = '303'              /* 계약상세.계약상세상태코드 */
            AND T1.CNTR_CAN_DTM  <![CDATA[ <= ]]> #{performanceYm}              /* 계약취소일시 */
            AND T2.SELL_TP_CD                   = #{businessType}
    </select>
    <update id="updateContractDetail">
        UPDATE TB_SSCT_CNTR_DTL /* 계약상세 */
           SET CNTR_DTL_STAT_CD    = '301'      /* 계약상세상태코드 */
            <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND CNTR_NO             = #{cntrNo}             /* 계약번호 */
           AND CNTR_SN             = #{cntrSn}             /* 계약일련번호 */
    </update>
    <insert id="insertContractDetailHist">
        INSERT INTO TB_SSCT_CNTR_DCH_HIST (  /* 계약상세변경이력 */
              CNTR_NO             /* 계약번호 */
            , HIST_STRT_DTM       /* 이력시작일시 */
            , CNTR_SN             /* 계약일련번호 */
            , HIST_END_DTM        /* 이력종료일시 */
            , BASE_PD_CD          /* 기준상품코드 */
            , HGR_PD_CD           /* 상위상품코드 */
            , PD_QTY_UNIT_CD      /* 상품수량단위코드 */
            , PD_QTY              /* 상품수량 */
            , STPL_PTRM_UNIT_CD   /* 약정기간단위코드 */
            , STPL_PTRM           /* 약정기간 */
            , ISTM_MCN            /* 할부개월수 */
            , CNTR_PD_STRTDT      /* 계약상품시작일자 */
            , CNTR_PD_ENDDT       /* 계약상품종료일자 */
            , CNTR_DTL_STAT_CD    /* 계약상세상태코드 */
            , SELL_TP_CD          /* 판매유형코드 */
            , DSC_APY_TP_CD       /* 할인적용유형코드 */
            , DSC_APY_DTL_CD      /* 할인적용상세코드 */
            , DSC_APY_DRM_VAL     /* 할인적용식별값 */
            , SV_PTRM_UNIT_CD     /* 서비스기간단위코드 */
            , SV_PRD              /* 서비스주기 */
            , CNTRW_TP_CD         /* 계약서유형코드 */
            , BLG_CRP_CD          /* 소속법인코드 */
            , RVE_CRP_CD          /* 수납법인코드 */
            , CO_CD               /* 회사코드 */
            , BOO_SELL_TP_CD      /* 예약판매유형코드 */
            , PD_GD_CD            /* 상품등급코드 */
            , PD_HCLSF_ID         /* 상품대분류ID */
            , PD_MCLSF_ID         /* 상품중분류ID */
            , PD_LCLSF_ID         /* 상품소분류ID */
            , PD_DCLSF_ID         /* 상품세분류ID */
            , STLM_TP_CD          /* 결제유형코드 */
            , CRNCY_DV_CD         /* 통화구분코드 */
            , APY_EXCR            /* 적용환율 */
            , PD_BASE_AMT         /* 상품기준금액 */
            , FNL_AMT             /* 최종금액 */
            , VAT                 /* 부가가치세 */
            , SELL_AMT            /* 판매금액 */
            , CNTR_AMT            /* 계약금액 */
            , ISTM_PCAM_AMT       /* 할부원금금액 */
            , ISTM_INT_AMT        /* 할부이자금액 */
            , MM_ISTM_AMT         /* 월할부금액 */
            , ACKMT_PERF_RT       /* 인정실적율 */
            , ACKMT_PERF_AMT      /* 인정실적금액 */
            , SPP_DUEDT           /* 배송예정일자 */
            , RESUB_YN            /* 재구독여부 */
            , RSTL_YN             /* 재약정여부 */
            , FRISU_YN            /* 무상여부 */
            , FRISU_DSB_TP_CD     /* 무상지급유형코드 */
            , FEE_FXAM_YN         /* 수수료정액여부 */
            , TXINV_PBL_OJ_YN     /* 세금계산서발행대상여부 */
            , SMTPL_ID            /* 스마트플랜ID */
            , SMTPL_SN            /* 스마트플랜일련번호 */
            , BF_ORD_NO           /* 이전주문번호 */
            , CNTR_CH_RCP_ID      /* 계약변경접수ID */
            , CNTR_CH_SN          /* 계약변경일련번호 */
            , CNTR_CH_DTL_RSON_CD /* 계약변경상세사유코드 */
            , CNTR_CH_DTL_AK_CN   /* 계약변경상세요청내용 */
            , DTA_DL_YN           /* 데이터삭제여부 */
            <include refid="COMMON.insertSystemField" />)
            SELECT CNTR_NO             /* 계약번호 */
                 , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')  /* 이력시작일시 */
                 , CNTR_SN             /* 계약일련번호 */
                 , '99991231999999'    /* 이력종료일시 */
                 , BASE_PD_CD          /* 기준상품코드 */
                 , HGR_PD_CD           /* 상위상품코드 */
                 , PD_QTY_UNIT_CD      /* 상품수량단위코드 */
                 , PD_QTY              /* 상품수량 */
                 , STPL_PTRM_UNIT_CD   /* 약정기간단위코드 */
                 , STPL_PTRM           /* 약정기간 */
                 , ISTM_MCN            /* 할부개월수 */
                 , CNTR_PD_STRTDT      /* 계약상품시작일자 */
                 , CNTR_PD_ENDDT       /* 계약상품종료일자 */
                 , CNTR_DTL_STAT_CD    /* 계약상세상태코드 */
                 , SELL_TP_CD          /* 판매유형코드 */
                 , DSC_APY_TP_CD       /* 할인적용유형코드 */
                 , DSC_APY_DTL_CD      /* 할인적용상세코드 */
                 , DSC_APY_DRM_VAL     /* 할인적용식별값 */
                 , SV_PTRM_UNIT_CD     /* 서비스기간단위코드 */
                 , SV_PRD              /* 서비스주기 */
                 , CNTRW_TP_CD         /* 계약서유형코드 */
                 , BLG_CRP_CD          /* 소속법인코드 */
                 , RVE_CRP_CD          /* 수납법인코드 */
                 , CO_CD               /* 회사코드 */
                 , BOO_SELL_TP_CD      /* 예약판매유형코드 */
                 , PD_GD_CD            /* 상품등급코드 */
                 , PD_HCLSF_ID         /* 상품대분류ID */
                 , PD_MCLSF_ID         /* 상품중분류ID */
                 , PD_LCLSF_ID         /* 상품소분류ID */
                 , PD_DCLSF_ID         /* 상품세분류ID */
                 , STLM_TP_CD          /* 결제유형코드 */
                 , CRNCY_DV_CD         /* 통화구분코드 */
                 , APY_EXCR            /* 적용환율 */
                 , PD_BASE_AMT         /* 상품기준금액 */
                 , FNL_AMT             /* 최종금액 */
                 , VAT                 /* 부가가치세 */
                 , SELL_AMT            /* 판매금액 */
                 , CNTR_AMT            /* 계약금액 */
                 , ISTM_PCAM_AMT       /* 할부원금금액 */
                 , ISTM_INT_AMT        /* 할부이자금액 */
                 , MM_ISTM_AMT         /* 월할부금액 */
                 , ACKMT_PERF_RT       /* 인정실적율 */
                 , ACKMT_PERF_AMT      /* 인정실적금액 */
                 , SPP_DUEDT           /* 배송예정일자 */
                 , RESUB_YN            /* 재구독여부 */
                 , RSTL_YN             /* 재약정여부 */
                 , FRISU_YN            /* 무상여부 */
                 , FRISU_DSB_TP_CD     /* 무상지급유형코드 */
                 , FEE_FXAM_YN         /* 수수료정액여부 */
                 , TXINV_PBL_OJ_YN     /* 세금계산서발행대상여부 */
                 , SMTPL_ID            /* 스마트플랜ID */
                 , SMTPL_SN            /* 스마트플랜일련번호 */
                 , BF_ORD_NO           /* 이전주문번호 */
                 , CNTR_CH_RCP_ID      /* 계약변경접수ID */
                 , CNTR_CH_SN          /* 계약변경일련번호 */
                 , CNTR_CH_DTL_RSON_CD /* 계약변경상세사유코드 */
                 , CNTR_CH_DTL_AK_CN   /* 계약변경상세요청내용 */
                 , DTA_DL_YN           /* 데이터삭제여부 */
                 <include refid="COMMON.insertSystemFieldValue" /> 
              FROM TB_SSCT_CNTR_DTL /* 계약상세 */
             WHERE 1 = 1
               AND CNTR_NO             = #{cntrNo}             /* 계약번호 */
               AND CNTR_SN             = #{cntrSn}             /* 계약일련번호 */
    </insert>
</mapper>