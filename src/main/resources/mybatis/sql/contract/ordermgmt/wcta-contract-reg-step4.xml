<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.ordermgmt.mapper.WctaContractRegStep4Mapper">

    <select id="selectStlmDtls" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dvo.WctaContractRegStep4Dvo$StlmDtlDvo">
        SELECT T3.PD_NM
             , T2.STLM_TP_CD
             , F_CMZ_CD_NM(#{session.tenantId}, 'STLM_TP_CD', T2.STLM_TP_CD, #{session.langId}) AS STLM_TP_NM
             , T2.STLM_TP_CD
             , T2.FNL_AMT
             , T2.DSC_AMT
             , NVL(SUM(CASE WHEN T2.STLM_TP_CD = '10' AND T1.RVE_DV_CD = '01' AND T1.DP_TP_CD IN ('0201', '0101') THEN T1.STLM_AMT ELSE 0 END), 0) AS C1001
             , NVL(SUM(CASE WHEN T2.STLM_TP_CD = '10' AND T1.RVE_DV_CD = '01' AND T1.DP_TP_CD = '0702' THEN T1.STLM_AMT ELSE 0 END), 0) AS C10010702
             , NVL(SUM(CASE WHEN T2.STLM_TP_CD = '10' AND T1.RVE_DV_CD = '01' AND T1.DP_TP_CD = '0802' THEN T1.STLM_AMT ELSE 0 END), 0) AS C10010802
             , NVL(SUM(CASE WHEN T2.STLM_TP_CD = '10' AND T1.RVE_DV_CD = '01' AND T1.DP_TP_CD = '0803' THEN T1.STLM_AMT ELSE 0 END), 0) AS C10010803
             , NVL(SUM(CASE WHEN T2.STLM_TP_CD = '20' AND T1.RVE_DV_CD = '01' AND T1.DP_TP_CD IN ('0201', '0101') THEN T1.STLM_AMT ELSE 0 END), 0) AS C2001
             , NVL(SUM(CASE WHEN T2.STLM_TP_CD = '20' AND T1.RVE_DV_CD = '01' AND T1.DP_TP_CD = '0702' THEN T1.STLM_AMT ELSE 0 END), 0) AS C20010702
             , NVL(SUM(CASE WHEN T2.STLM_TP_CD = '20' AND T1.RVE_DV_CD = '01' AND T1.DP_TP_CD = '0802' THEN T1.STLM_AMT ELSE 0 END), 0) AS C20010802
             , NVL(SUM(CASE WHEN T2.STLM_TP_CD = '20' AND T1.RVE_DV_CD = '01' AND T1.DP_TP_CD = '0803' THEN T1.STLM_AMT ELSE 0 END), 0) AS C20010803
             , NVL(SUM(CASE WHEN T2.STLM_TP_CD = '20' AND T1.RVE_DV_CD = '03' AND T1.DP_TP_CD IN ('0203') THEN T1.STLM_AMT ELSE 0 END), 0) AS C2003
          FROM TB_SSCT_CNTR_STLM_REL T1
         INNER JOIN TB_SSCT_CNTR_DTL T2
            ON T2.CNTR_NO = T1.DTL_CNTR_NO
           AND T2.CNTR_SN = T1.DTL_CNTR_SN
           AND T2.DTA_DL_YN = 'N'
         INNER JOIN TB_PDBS_PD_BAS T3
            ON T3.PD_CD = T2.BASE_PD_CD
           AND T3.DTA_DL_YN = 'N'
         WHERE T1.DTL_CNTR_NO = #{cntrNo}
           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN VL_STRT_DTM AND VL_END_DTM
           AND T1.DTA_DL_YN = 'N'
         GROUP BY T1.DTL_CNTR_SN, T3.PD_NM, T2.STLM_TP_CD, T2.FNL_AMT, T2.DSC_AMT, T2.CNTR_SN
         ORDER BY T2.CNTR_SN
    </select>

    <!-- STEP4 저장 -->
    <update id="updateCntrBasStep4">
        UPDATE TB_SSCT_CNTR_BAS /* 계약기본 */
           SET CST_STLM_IN_MTH_CD  = #{cstStlmInMthCd}      /* 고객결제입력방법코드 */
        <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND CNTR_NO             = #{cntrNo}              /* 계약번호 */
           AND DTA_DL_YN = 'N'
    </update>
</mapper>
