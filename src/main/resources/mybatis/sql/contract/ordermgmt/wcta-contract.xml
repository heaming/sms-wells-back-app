<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.ordermgmt.mapper.WctaContractMapper">
    <select id="selectApprovalAskDivides" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchRes">
        SELECT CNTR_APR_AK_DV_CD
             , CNTR_APR_AK_DV_CD AS CNTR_APR_AK_DV_PK
             , CNTR_APR_AK_DV_CD_NM
             , (CNTR_APR_AK_DV_CD || '-' || CNTR_APR_AK_DV_CD_NM) AS CNTR_APR_AK_DV_NM
             , CNTR_APR_AK_MSG_CN
             , CNTR_APR_CAN_MSG_CN
             , CNTR_APR_CONF_MSG_CN
             , VL_STRT_DTM
             , VL_STRT_DTM AS VL_STRT_DTM_PK
             , VL_END_DTM
          FROM TB_SSCT_CNTR_APR_AK_DV_CD
         WHERE 1=1
           AND DTA_DL_YN = 'N'
         <if test='@MybatisUtils@isNotEmpty(standardDt)'>
           AND #{standardDt} BETWEEN VL_STRT_DTM AND VL_END_DTM
         </if>
         ORDER BY TO_NUMBER(CNTR_APR_AK_DV_CD)
    </select>

    <update id="deleteApprovalAskDivides">
        UPDATE TB_SSCT_CNTR_APR_AK_DV_CD
           SET DTA_DL_YN = 'Y'
               <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND CNTR_APR_AK_DV_CD = #{cntrAprAkDvCd}
           AND VL_STRT_DTM = #{vlStrtDtm}
    </update>

    <select id="selectConfirmAprPsicAks" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchConfirmAprPsicAksRes">
        SELECT MIN(T2.CNTR_APR_FW_ID)   AS CNTR_APR_FW_ID         /*계약승인발송ID*/
             , T1.CNTR_APR_AK_DV_CD                             /* 계약승인요청구분코드*/
             , MIN(T1.AK_USR_ID)                               AS AK_USR_ID           /*요청자 사번 REQ_ID*/
             , MIN(T1.RQR_NM)                                    AS RQR_NM           /*요청자 명 REQ_NM*/
             , T2.CNTR_APR_FW_DV_CD     /* 계약승인발송구분코드*/
             , CASE WHEN T2.CNTR_APR_FW_DV_CD = '1' THEN '요청(1)'
                    WHEN T2.CNTR_APR_FW_DV_CD = '4' THEN '취소(4)'
                    ELSE ''
               END                                          AS CNTR_APR_FW_DV_NM       /*요청구분 1:요청,4:취소*/
             , LISTAGG(DISTINCT  T2.RCV_USR_NM,',') WITHIN GROUP (ORDER BY T1.AK_USR_ID) AS RCV_USR_NM
             , MIN(T2.FW_DTM) AS SEND_DTTM           /*발송일시*/
             , MIN(CASE WHEN T2.CNTR_APR_FW_DV_CD = '1' THEN T1.APR_YN ELSE '-' END)     AS APRV_YN     /*승인 여부*/
             , MIN(CASE WHEN T2.CNTR_APR_FW_DV_CD = '1' THEN T1.APR_USR_ID ELSE '-' END) AS APRV_ID     /*승인자 사번*/
             , MIN(CASE WHEN T2.CNTR_APR_FW_DV_CD = '1' THEN T1.APR_USR_NM ELSE '-' END) AS APRV_NM     /*승인자 명*/
             , MIN(T1.APR_DTM)                         AS APRV_DTTM   /*승인 일시*/
             , MIN(CASE WHEN T2.CNTR_APR_FW_DV_CD = '1' THEN T1.CAN_YN  ELSE '-' END)    AS CANC_YN     /*취소 여부*/
             , MIN(T3.CNTR_APR_AK_DV_CD_NM)                                              AS ACKD_REQ_NM      /*승인 요청 명*/
             , MIN(CNTR_NO)
         FROM TB_SSCT_CNTR_APR_IZ T1                        /* T.계약승인내역     WPN_DFNT_ACKD_REQ REQ */
         LEFT OUTER JOIN TB_SSCT_CNTR_APR_FW_HIST T2        /* T.계약승인발송이력   WPN_DFNT_ACKD_MSG MSG */
            ON T1.CNTR_APR_ID = T2.CNTR_APR_ID                  /* 계약승인ID (MIG DATA 맞지 않음)*/
           AND T2.DTA_DL_YN = 'N'  /* 데이터삭제여부 */
         LEFT OUTER JOIN TB_SSCT_CNTR_APR_AK_DV_CD T3       /* T.계약승인요청구분코드 WPN_DFNT_ACKD_BAS BAS */
           ON T1.CNTR_APR_AK_DV_CD = T3.CNTR_APR_AK_DV_CD   /* 계약승인요청구분코드 */
          AND T3.DTA_DL_YN = 'N'  /* 데이터삭제여부 */
        WHERE 1=1
          AND T1.CNTR_NO = #{cntrNo}/* 계약번호 */
          AND T1.DTA_DL_YN = 'N'  /* 데이터삭제여부 */
        GROUP BY T1.CNTR_APR_AK_DV_CD, T2.CNTR_APR_FW_DV_CD, T1.CNTR_APR_AK_DV_CD /*계약승인ID, 계약승인발송구분코드, 계약승인요청구분코드*/
        ORDER BY T1.CNTR_APR_AK_DV_CD, T2.CNTR_APR_FW_DV_CD, T1.CNTR_APR_AK_DV_CD /*계약승인ID, 계약승인발송구분코드, 계약승인요청구분코드*/
    </select>

    <select id="selectConfirmAprPsicPrchss" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchConfirmAprPsicPrchssRes">
        SELECT T2.CNTR_NO || T2.CNTR_SN  AS CNTR_NO /* 계약번호 */
             , T3.CST_KNM  /* 계약자명 */
             , NVL((SELECT CASE WHEN CST_GD_CD = '2' THEN 'VIP' ELSE '일반' END        /* 고객등급 */
                  FROM TB_SSCT_CST_GD_ESTM_IZ T10 /* T.고객등급산정내역*/
                 WHERE 1=1
                  AND T10.CST_NO = T1.CNTR_CST_NO       /* 고객번호 */
                  AND T10.VL_END_DTM = '99991231235959' /* 유효종료일시*/
                  AND T10.DTA_DL_YN = 'N'               /* 데이터삭제여부*/
                  AND T10.CST_GD_ESTM_DT = (SELECT MAX(CST_GD_ESTM_DT)
                                             FROM TB_SSCT_CST_GD_ESTM_BAI_IZ T11 /*고객등급산정근거내역*/
                                            WHERE 1=1
                                              AND T11.CNTR_NO = T2.CNTR_NO  /* 계약변호*/
                                              AND T11.CNTR_SN = T2.CNTR_SN  /* 계약일련번호 */
                                              AND T11.DTA_DL_YN = 'N'
                                              AND T11.SELL_TP_CD  = '2' /* 판매유형 : 렌탈(2) */
                                            )), '-') AS CST_GD_NM   /* 고객등급 */
             , T5.RCGVP_KNM  /* 고객명 */
             , (T51.RNADR ||' '|| T51.RDADR) AS ADR  /* 설치주소 */
             , T6.PD_NM  /* 상품명 */
             , T7.IST_DT /* 설치일 */
             , CASE WHEN REGEXP_LIKE(T2.CNTR_DTL_STAT_CD, '^2|^3') THEN '탈퇴'
                    WHEN REGEXP_LIKE(T2.CNTR_DTL_STAT_CD, '^4') THEN    '종료'
                    WHEN REGEXP_LIKE(T2.CNTR_DTL_STAT_CD, '^1') THEN    '관리'
                    ELSE '' END  USE_DIV
             , T2.CNTR_DTL_STAT_CD  /* 사용구분 1:관리,2:탈퇴,3:취소, 0:완료 */
             , F_CMZ_CD_NM('TNT_WELLS', 'CNTR_DTL_STAT_CD', T2.CNTR_DTL_STAT_CD) AS TCNTR_DTL_STAT_CD2  /* 사용구분 1:관리,2:탈퇴,3:취소, 0:완료 */
             , T8.APY_TN                            AS APY_TN   /* 렌탈회차(적용회차) : 월마감실적에 생성될예정*/
             , T9.DLQ_MCN || '/' ||T9.DLQ_OC_AMT    AS DLQ_INFO /* 연체개월/금액 */
          FROM TB_SSCT_CNTR_BAS T1             /* T.계약기본 (고객번호)*/
         INNER JOIN TB_SSCT_CNTR_DTL T2             /* T.계약상세 */
            ON T1.CNTR_NO = T2.CNTR_NO
           AND T2.SELL_TP_CD = '2' /*렌탈*/
           AND T2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS T3        /* T.고객기본 */
            ON T3.CST_NO = T1.CNTR_CST_NO
           AND T3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS T5 /* T.계약주소지기본 */
            ON T5.CNTR_CST_NO = T1.CNTR_CST_NO
           AND T5.CNTR_NO = T1.CNTR_NO
           AND T5.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_GBCO_ADR_BAS T51       /* T.주소기본 */
            ON T51.ADR_ID = T5.ADR_ID
          LEFT OUTER JOIN TB_PDBS_PD_BAS T6         /* T.상품기본 */
            ON T6.PD_CD = T2.BASE_PD_CD
           AND T6.DTA_DL_YN = 'N'
           AND T6.SELL_YN = 'Y'
          LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T7 /* T.계약WELLS상세 */
            ON T7.CNTR_NO = T2.CNTR_NO              /* 계약번호 */
           AND T7.CNTR_SN = T2.CNTR_SN
           LEFT OUTER JOIN LATERAL (SELECT *
                                     FROM (SELECT T80.CNTR_NO
                                                , T80.CNTR_SN
                                                , /*T8.APY_TN*/ 'TODO'  AS APY_TN   /* 렌탈회차 */
                                             FROM TB_CBCL_CNTR_PERF_MM_CL T80       /* T.계약실적월마감 */
                                            WHERE 1=1
                                              AND T80.CNTR_NO = T2.CNTR_NO
                                              AND T80.CNTR_SN = T2.CNTR_SN
                                              AND T80.BASE_YM IN (TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMM'), TO_CHAR(SYSDATE,'YYYYMM'))
                                            ORDER BY T80.BASE_YM DESC
                                            )
                                      WHERE ROWNUM= 1
            ) T8
            ON T8.CNTR_NO = T2.CNTR_NO
           AND T8.CNTR_SN = T2.CNTR_SN
          LEFT OUTER JOIN LATERAL (SELECT *
                                     FROM (SELECT T90.CNTR_NO, T90.CNTR_SN, T90.DLQ_MCN, T90.DLQ_OC_AMT
                                             FROM TB_CBCL_DLQ_BAS T90         /* T.연체기본 */
                                            WHERE 1=1
                                              AND T90.CNTR_NO = T2.CNTR_NO
                                              AND T90.CNTR_SN = T2.CNTR_SN
                                              AND T90.BASE_YM IN (TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMM'), TO_CHAR(SYSDATE,'YYYYMM'))
                                            ORDER BY T90.BASE_YM DESC
                                            )
                                      WHERE ROWNUM= 1
            ) T9
            ON T9.CNTR_NO = T2.CNTR_NO
           AND T9.CNTR_SN = T2.CNTR_SN
        WHERE 1=1
          AND T1.DTA_DL_YN = 'N'
          AND T1.CNTR_NO = #{cntrNo}
    </select>

    <select id="selectConfirmApprovalBases" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchConfirmApprovalBaseRes">
        SELECT T1.CNTR_APR_BASE_ID
             , T1.CNTR_APR_AK_DV_CD
             , T1.CNTR_APR_SELL_DV_CD
             , T2.CNTR_APR_AK_DV_CD_NM
             , T1.CNTR_APR_CHNL_DV_VAL
             , T1.CNTR_APR_ICHR_DV_CD
             , T1.ICHR_USR_ID
             , CASE WHEN T1.PSIC_NM = '0' THEN '' ELSE T1.PSIC_NM END PSIC_NM
             , T1.VL_STRT_DTM
             , T1.VL_END_DTM
             , T1.NOTY_FW_OJ_YN
          FROM TB_SSCT_CNTR_APR_BASE_BAS T1
             , TB_SSCT_CNTR_APR_AK_DV_CD T2
         WHERE 1=1
           AND T1.CNTR_APR_AK_DV_CD = T2.CNTR_APR_AK_DV_CD
         <if test='@MybatisUtils@isNotEmpty(cntrAprAkDvCd)'>
           AND T1.CNTR_APR_AK_DV_CD = #{cntrAprAkDvCd}
         </if>
         <if test='@MybatisUtils@isNotEmpty(standardDt)'>
           AND #{standardDt} BETWEEN T1.VL_STRT_DTM AND T1.VL_END_DTM
         </if>
           AND T1.DTA_DL_YN = 'N'
    </select>

    <select id="selectCountConfirmApprovalBases" resultType="int">
         SELECT COUNT(1) AS "CNT"
           FROM TB_SSCT_CNTR_APR_BASE_BAS
          WHERE 1=1
            AND CNTR_APR_AK_DV_CD = #{cntrAprAkDvCd}
         <if test='@MybatisUtils@equals(checkType,"U")'>    <!-- Unique : 삭제시 존재 여부 체크, 수정시 변경하려는 자료의 값이 존재하는지 체크 -->
            AND CNTR_APR_SELL_DV_CD = #{cntrAprSellDvCd}
            AND CNTR_APR_CHNL_DV_VAL = #{cntrAprChnlDvVal}
            AND CNTR_APR_ICHR_DV_CD = #{cntrAprIchrDvCd}
            AND ICHR_USR_ID = #{ichrUsrId}
            AND VL_STRT_DTM = #{vlStrtDtm}
            AND CNTR_APR_BASE_ID = #{cntrAprBaseId}
         </if>
          <if test='@MybatisUtils@equals(checkType,"A")'>    <!-- Area : 수정시 기존 자료와 기간 중복 체크-->
            AND CNTR_APR_SELL_DV_CD = #{cntrAprSellDvCd}
            AND CNTR_APR_CHNL_DV_VAL = #{cntrAprChnlDvVal}
            AND CNTR_APR_ICHR_DV_CD = #{cntrAprIchrDvCd}
            AND ICHR_USR_ID = #{ichrUsrId}
            AND (#{vlStrtDtm} BETWEEN VL_STRT_DTM AND VL_END_DTM
              OR #{vlEndDtm} BETWEEN VL_STRT_DTM AND VL_END_DTM
              OR VL_END_DTM BETWEEN #{vlStrtDtm} AND #{vlEndDtm})
          <if test='@MybatisUtils@isNotEmpty(cntrAprBaseId)'>
            AND CNTR_APR_BASE_ID != #{cntrAprBaseId}
          </if>
         </if>
    </select>

    <insert id="insertConfirmApprovalBases">
        INSERT INTO TB_SSCT_CNTR_APR_BASE_BAS(
           CNTR_APR_BASE_ID
         , CNTR_APR_AK_DV_CD
         , CNTR_APR_SELL_DV_CD
         , CNTR_APR_CHNL_DV_VAL
         , CNTR_APR_ICHR_DV_CD
         , ICHR_USR_ID
         , PSIC_NM
         , VL_STRT_DTM
         , VL_END_DTM
         , NOTY_FW_OJ_YN
         , DTA_DL_YN
         <include refid="COMMON.insertSystemField"/>
    ) VALUES (
           (SELECT NVL(MAX(TO_NUMBER(CNTR_APR_BASE_ID))+1,0) FROM TB_SSCT_CNTR_APR_BASE_BAS)
         , #{cntrAprAkDvCd}
         , #{cntrAprSellDvCd}
         , #{cntrAprChnlDvVal}
         , #{cntrAprIchrDvCd}
         , #{ichrUsrId}
         , #{psicNm}
         , #{vlStrtDtm}
         , #{vlEndDtm}
         , #{notyFwOjYn}
         , NVL(#{dtaDlYn}, 'N')
         <include refid="COMMON.insertSystemFieldValue"/>
       )
    </insert>

    <update id="updateConfirmApprovalBases">
        UPDATE TB_SSCT_CNTR_APR_BASE_BAS
           SET CNTR_APR_SELL_DV_CD = #{cntrAprSellDvCd}
             , CNTR_APR_CHNL_DV_VAL = #{cntrAprChnlDvVal}
             , CNTR_APR_ICHR_DV_CD = #{cntrAprIchrDvCd}
             , ICHR_USR_ID = #{ichrUsrId}
             , PSIC_NM = #{psicNm}
             , VL_STRT_DTM = #{vlStrtDtm}
             , VL_END_DTM = #{vlEndDtm}
             , NOTY_FW_OJ_YN = #{notyFwOjYn}
               <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND CNTR_APR_BASE_ID = #{cntrAprBaseId}
    </update>

    <update id="deleteConfirmApprovalBases">
        UPDATE TB_SSCT_CNTR_APR_BASE_BAS
           SET DTA_DL_YN = 'Y'
               <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND CNTR_APR_BASE_ID = #{cntrAprBaseId}
           AND CNTR_APR_AK_DV_CD = #{cntrAprAkDvCd}
           AND CNTR_APR_SELL_DV_CD = #{cntrAprSellDvCd}
           AND CNTR_APR_CHNL_DV_VAL = #{cntrAprChnlDvVal}
           AND CNTR_APR_ICHR_DV_CD = #{cntrAprIchrDvCd}
           AND ICHR_USR_ID = #{ichrUsrId}
           AND VL_STRT_DTM = #{vlStrtDtm}
           AND PSIC_NM = #{psicNm}
    </update>
    <select id="selectBpdRentalAccMgtPss" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchBpdRentalAccMgtPssRes">
        SELECT
           MAX(T1.PD_MCLSF_ID) AS PDGRP_NM /* [상품군]  */
         , MAX(T1.PD_NM) AS PD_NM /* [상품명]  */
         , MAX(T1.BASE_PD_CD) AS BASE_PD_CD /* [상품코드]  */
         , T1.IST_MT       AS IST_DT /* [설치년월] */
         , MAX(T1.RSTL_YN) AS RSTL_YN /* [재약정여부] */
         , SUM(T1.TOT_CNT) AS J_CNT /* [가입건수] */
         , SUM(T1.CNT1)    AS MCHN_CH_CNT /* [기변건수] */
         , SUM(T1.CNT2)    AS RE_RENTAL_CNT /* [재렌탈건수] */
         , SUM(T1.CNT3)    AS MSH_CNT /* [멤버십건수] */
         , SUM(T1.CNT4)    AS KEEP_RENTAL_CNT /* [렌탈유지] */
         , SUM(T1.CNT5)    AS SPR_EXN_CNT /* [이탈(만료→자가)] */
         , SUM(T1.CNT6)    AS SPR_REQD_CNT /* [이탈(철거-후속계약X)] */
         , ROUND((SUM(T1.CNT5) + SUM(T1.CNT6)) * 100 / SUM(T1.TOT_CNT),1) SPR_RAT  /* [이탈율] */
        FROM (
            SELECT D.PD_MCLSF_ID /* 상품기본.상품중분류ID */
                 , D.PD_NM /* 상품기본.상품명 */
                 , A.BASE_PD_CD /* 계약상세.기준상품코드 */
                 , SUBSTR(C.IST_DT,1,6) AS IST_MT  /* 설치년월 */
                 , F.CHK_CHDVC_RERNT /* 기변/재렌탈 체크 */
                 , NVL(A.RSTL_YN, 'N') AS RSTL_YN /* 재약정여부-재약정을 통해 약정기간을 변경한 계약체결 유무를 구분 */
                 , 1 AS TOT_CNT /* 가입건수 */
                 , CASE WHEN F.CHK_CHDVC_RERNT = 'C' THEN 1 ELSE 0 END AS CNT1 /* 기변건수 */
                 , CASE WHEN F.CHK_CHDVC_RERNT = 'R' THEN 1 ELSE 0 END AS CNT2 /* 재렌탈건수 */
                 , CASE WHEN A.SELL_TP_CD = 3 THEN 1 ELSE 0 END AS CNT3 /* 멤버십건수 */
                 , CASE WHEN A.CNTR_DTL_STAT_CD = '101' /*계약상세 상태코드가 정상(101) 이면서 */
                             AND A.CNTR_PD_ENDDT IS NOT NULL
                             AND TO_DATE(A.CNTR_PD_ENDDT, 'YYYYMMDD') <![CDATA[ < ]]> SYSDATE /* 계약 종료일이 현재일보다 작은 경우 */
                             THEN 1
                        ELSE 0
                   END AS CNT4 /* 렌탈유지건수 */
                 , CASE WHEN A.CNTR_DTL_STAT_CD = '101'/*계약상세 상태코드가 정상(101) 이면서 */
                              AND A.CNTR_PD_ENDDT IS NOT NULL
                              AND TO_DATE(A.CNTR_PD_ENDDT, 'YYYYMMDD') >= SYSDATE /* 계약 종료일이 현재일보다 크거나 같은 경우 */
                             THEN 1
                        WHEN A.CNTR_DTL_STAT_CD = '402' /*계약상세 상태코드가 계약기간종료(402)인 경우 */
                             THEN 1
                        ELSE 0
                   END AS CNT5 /* 이탈건수(만료→자가) */
                 , CASE WHEN A.CNTR_DTL_STAT_CD = '401' /*계약상세 상태코드가 계약기간종료(401) 이면서 */
                             AND C.REQD_DT IS NOT NULL /* 철거일자 */
                             THEN 1
                        ELSE 0
                   END AS CNT6 /* 이탈건수(철거-후속계약X) */
              FROM WSMDBS.TB_SSCT_CNTR_DTL  A /* 계약상세 */
             INNER JOIN TB_SSCT_CNTR_BAS B /*계약기본*/
                ON A.CNTR_NO = B.CNTR_NO
             INNER JOIN TB_SSCT_CNTR_WELLS_DTL C /* 계약WELLS 상세 */
                ON A.CNTR_NO = C.CNTR_NO
               AND A.CNTR_SN = C.CNTR_SN
             INNER JOIN WSMDBS.TB_PDBS_PD_BAS  D /* 상품기본 */
                ON A.BASE_PD_CD = D.PD_CD
              LEFT OUTER JOIN
                   (/* 기변 재렌탈 */
                    SELECT  CASE WHEN F.MCHN_CH_TP_CD NOT IN (15,16,19) THEN 'C' /* 기기변경 */
                                 ELSE 'R' /* 재렌탈 */
                            END CHK_CHDVC_RERNT /* 기변/재렌탈 체크*/
                         , F.BASE_CNTR_NO /* 기준계약번호 */
                         , F.BASE_CNTR_SN /* 기준계약일련번호 */
                         , F.OJ_CNTR_NO /* 대상계약번호 */
                         , F.OJ_CNTR_SN /* 대상계약일련번호  */
                      FROM TB_SSCT_MCHN_CH_IZ F/* 기기변경내역 */
                     WHERE 1=1
                       AND F.DTA_DL_YN = 'N' /* 데이터 삭제 여부가 'N'인 건*/
                   ) F
                ON F.BASE_CNTR_NO = A.CNTR_NO /* 기준계약번호 */
               AND F.BASE_CNTR_SN = A.CNTR_SN /* 기준계약일련번호 */
              LEFT OUTER JOIN
                   (/* 재약정 - 접수후 취소건은 제외*/
                    SELECT 'Y' AS RSTL_YN /* 재약정여부 */
                         , G.CNTR_NO /* 계약번호 */
                         , G.CNTR_SN /* 계약일련번호 */
                      FROM TB_SSCT_RENTAL_RSTL_IZ G /* 렌탈 재약정 내역  */
                     WHERE 1=1
                       AND G.DTA_DL_YN = 'N' /* 데이터 삭제 여부가 'N'인 건*/
                       AND G.STPL_CNFM_DTM IS NOT NULL /*약정확정일시-접수후 취소건은 제외*/
                       AND G.STPL_CAN_DTM IS NULL /*약정취소일시-접수후 취소건은 제외*/
                       AND G.STPL_WDWL_DTM IS NULL /*약정철회일시-접수후 취소건은 제외*/
                   ) G
                ON G.CNTR_NO = A.CNTR_NO /* 기준계약번호 */
               AND G.CNTR_SN = A.CNTR_SN /* 기준계약일련번호 */
             WHERE 1=1
               AND B.CNTR_PRGS_STAT_CD = '050' /* 계약진행 상태 코드(050 : 계약확정) */
               AND A.SELL_TP_CD IN ('2','3') /* 판매유형코드(2 : 렌탈/리스, 3 : 멤버십) */
                <if test='@MybatisUtils@isNotEmpty(copnDvCd)'>
                    AND B.COPN_DV_CD = #{copnDvCd}
                </if>
           ) T1
        WHERE 1=1
        <if test='@MybatisUtils@isNotEmpty(istStartDt) and @MybatisUtils@isNotEmpty(istEndDt)'>
            AND T1.IST_MT BETWEEN #{istStartDt} AND #{istEndDt}
        </if>
        <if test='@MybatisUtils@isNotEmpty(pdMclsfId)'>
            AND T1.PD_MCLSF_ID = #{pdMclsfId}
        </if>
        <if test='@MybatisUtils@isNotEmpty(basePdCd)'>
            AND T1.BASE_PD_CD = #{basePdCd}
        </if>
        GROUP BY T1.PD_MCLSF_ID, T1.PD_NM, T1.BASE_PD_CD, T1.IST_MT
    </select>
    <select id="selectByoRentalAccMgtInqrs" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchByoRentalAccMgtInqrsRes">
        SELECT
           MAX(T1.DGR1_LEVL_OG_NM) AS DGR1_LEVL_OG_NM /* 1차상위 조직명 - 총괄단 ※내역 기준에 따라 다를 수 있음 */
         , MAX(T1.DGR2_LEVL_OG_NM) AS DGR2_LEVL_OG_NM /* 2차상위 조직명 - 지역단 ※내역 기준에 따라 다를 수 있음 */
         , T1.IST_MT       AS IST_DT /* 설치년월 */
         , MAX(T1.RSTL_YN) AS RSTL_YN /* 재약정여부 */
         , SUM(T1.TOT_CNT) AS J_CNT /* 가입건수 */
         , SUM(T1.CNT1)    AS MCHN_CH_CNT /* 기변건수 */
         , SUM(T1.CNT2)    AS RE_RENTAL_CNT /* 재렌탈건수 */
         , SUM(T1.CNT3)    AS MSH_CNT /* 멤버십건수 */
         , SUM(T1.CNT4)    AS KEEP_RENTAL_CNT /* 렌탈유지 */
         , SUM(T1.CNT5)    AS SPR_EXN_CNT /* 이탈(만료→자가) */
         , SUM(T1.CNT6)    AS SPR_REQD_CNT /* 이탈(철거-후속계약X) */
         , ROUND((SUM(T1.CNT5) + SUM(T1.CNT6)) * 100 / SUM(T1.TOT_CNT),1) SPR_RAT  -- 이탈율
      FROM (
            SELECT E.DGR1_LEVL_OG_NM /* 1차상위 조직명 - 총괄단 ※내역 기준에 따라 다를 수 있음 */
                 , E.DGR2_LEVL_OG_NM /* 2차상위 조직명 - 지역단 ※내역 기준에 따라 다를 수 있음 */
                 , SUBSTR(C.IST_DT,1,6) AS IST_MT  /* 설치년월 */
                 , F.CHK_CHDVC_RERNT /* 기변/재렌탈 체크 */
                 , NVL(A.RSTL_YN, 'N') AS RSTL_YN /* 재약정여부-재약정을 통해 약정기간을 변경한 계약체결 유무를 구분 */
                 , 1 AS TOT_CNT /* 가입건수 */
                 , CASE WHEN F.CHK_CHDVC_RERNT = 'C' THEN 1 ELSE 0 END AS CNT1 /* 기변건수 */
                 , CASE WHEN F.CHK_CHDVC_RERNT = 'R' THEN 1 ELSE 0 END AS CNT2 /* 재렌탈건수 */
                 , CASE WHEN A.SELL_TP_CD = 3 THEN 1 ELSE 0 END AS CNT3 /* 멤버십건수 */
                 , CASE WHEN A.CNTR_DTL_STAT_CD = '101' /*계약상세 상태코드가 정상(101) 이면서 */
                             AND A.CNTR_PD_ENDDT IS NOT NULL
                             AND TO_DATE(A.CNTR_PD_ENDDT, 'YYYYMMDD') <![CDATA[ < ]]> SYSDATE /* 계약 종료일이 현재일보다 작은 경우 */
                             THEN 1
                        ELSE 0
                   END AS CNT4 /* 렌탈유지건수 */
                 , CASE WHEN A.CNTR_DTL_STAT_CD = '101'/*계약상세 상태코드가 정상(101) 이면서 */
                              AND A.CNTR_PD_ENDDT IS NOT NULL
                              AND TO_DATE(A.CNTR_PD_ENDDT, 'YYYYMMDD') >= SYSDATE /* 계약 종료일이 현재일보다 크거나 같은 경우 */
                             THEN 1
                        WHEN A.CNTR_DTL_STAT_CD = '402' /*계약상세 상태코드가 계약기간종료(402)인 경우 */
                             THEN 1
                        ELSE 0
                   END AS CNT5 /* 이탈건수(만료→자가) */
                 , CASE WHEN A.CNTR_DTL_STAT_CD = '401' /*계약상세 상태코드가 계약기간종료(401) 이면서 */
                             AND C.REQD_DT IS NOT NULL /* 철거일자 */
                             THEN 1
                        ELSE 0
                   END AS CNT6 /* 이탈건수(철거-후속계약X) */
              FROM TB_SSCT_CNTR_DTL A /* 계약상세 */
             INNER JOIN TB_SSCT_CNTR_BAS B /*계약기본*/
                ON A.CNTR_NO = B.CNTR_NO
             INNER JOIN TB_SSCT_CNTR_WELLS_DTL C /* 계약WELLS 상세 */
                ON A.CNTR_NO = C.CNTR_NO
               AND A.CNTR_SN = C.CNTR_SN
             INNER JOIN TB_OGBS_MM_PRTNR_IZ D /* 월파트너 내역 */
                ON D.PRTNR_NO = B.SELL_PRTNR_NO /* 월파트너내역.파트너 번호 = 계약기본.판매파트너번호*/
             INNER JOIN WSMDBS.TB_OGBS_MM_OG_IZ  E /* 월 조직 내역 */
                ON E.OG_ID = D.OG_ID /* 월조직내역.조직ID = 월파트너내역.조직ID */
               AND E.BASE_YM = D.BASE_YM
              LEFT OUTER JOIN
                   (/* 기변 재렌탈 */
                    SELECT  CASE WHEN F.MCHN_CH_TP_CD NOT IN (15,16,19) THEN 'C' /* 기기변경 */
                                 ELSE 'R' /* 재렌탈 */
                            END CHK_CHDVC_RERNT /* 기변/재렌탈 체크*/
                         , F.BASE_CNTR_NO /* 기준계약번호 */
                         , F.BASE_CNTR_SN /* 기준계약일련번호 */
                         , F.OJ_CNTR_NO /* 대상계약번호 */
                         , F.OJ_CNTR_SN /* 대상계약일련번호  */
                      FROM TB_SSCT_MCHN_CH_IZ F/* 기기변경내역 */
                     WHERE 1=1
                       AND F.DTA_DL_YN = 'N' /* 데이터 삭제 여부가 'N'인 건*/
                   ) F
                ON F.BASE_CNTR_NO = A.CNTR_NO /* 기준계약번호 */
               AND F.BASE_CNTR_SN = A.CNTR_SN /* 기준계약일련번호 */
              LEFT OUTER JOIN
                   (/* 재약정 - 접수후 취소건은 제외*/
                    SELECT 'Y' AS RSTL_YN /* 재약정여부 */
                         , G.CNTR_NO /* 계약번호 */
                         , G.CNTR_SN /* 계약일련번호 */
                      FROM TB_SSCT_RENTAL_RSTL_IZ G /* 렌탈 재약정 내역  */
                     WHERE 1=1
                       AND G.DTA_DL_YN = 'N' /* 데이터 삭제 여부가 'N'인 건*/
                       AND G.STPL_CNFM_DTM IS NOT NULL /*약정확정일시-접수후 취소건은 제외*/
                       AND G.STPL_CAN_DTM IS NULL /*약정취소일시-접수후 취소건은 제외*/
                       AND G.STPL_WDWL_DTM IS NULL /*약정철회일시-접수후 취소건은 제외*/
                   ) G
                ON G.CNTR_NO = A.CNTR_NO /* 기준계약번호 */
                AND G.CNTR_SN = A.CNTR_SN /* 기준계약일련번호 */
            WHERE 1=1
                AND B.CNTR_PRGS_STAT_CD = '050' /* 계약진행 상태 코드(050 : 계약확정) */
                AND A.SELL_TP_CD IN ('2','3') /* 판매유형코드(2 : 렌탈/리스, 3 : 멤버십) */
                <if test='@MybatisUtils@isNotEmpty(copnDvCd)'>
                    AND B.COPN_DV_CD = #{copnDvCd}
                </if>
        ) T1
        WHERE 1=1
        <if test='@MybatisUtils@isNotEmpty(istStartDt) and @MybatisUtils@isNotEmpty(istEndDt)'>
            AND T1.IST_MT BETWEEN #{istStartDt} AND #{istEndDt}
        </if>
        <if test='@MybatisUtils@isNotEmpty(dgr1LevlOgNm)'>
            AND T1.DGR1_LEVL_OG_NM = #{dgr1LevlOgNm}
        </if>
        <if test='@MybatisUtils@isNotEmpty(dgr2LevlOgNm)'>
            AND T1.DGR2_LEVL_OG_NM = #{dgr2LevlOgNm}
        </if>
        GROUP BY T1.DGR1_LEVL_OG_NM /* 1차상위 조직명 - 총괄단 ※내역 기준에 따라 다를 수 있음 */
            , T1.DGR2_LEVL_OG_NM /* 2차상위 조직명 - 지역단 ※내역 기준에 따라 다를 수 있음 */
            , T1.IST_MT            /* 설치년월(설치일자)*/
    </select>
</mapper>
