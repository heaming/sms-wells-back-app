<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.ordermgmt.mapper.WctaContractMapper">
    <select id="selectContractNumberInqrPages" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchCntrNoRes">
        SELECT SUBSTR(T2.CNTR_CNFM_DTM,1,8) AS CNTR_CNFM_DTM
             , T1.CNTR_NO
             , T1.CNTR_SN
             , T5.CST_KNM AS CNTR_CST_KNM
             , T4.RCGVP_KNM AS IST_CST_KNM
             , T6.PD_NM
          FROM TB_SSCT_CNTR_DTL T1
         INNER JOIN TB_SSCT_CNTR_BAS T2
            ON T2.CNTR_NO = T1.CNTR_NO
           AND T2.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_ADR_REL T3
            ON T3.DTL_CNTR_NO = T1.CNTR_NO
           AND T3.DTL_CNTR_SN = T1.CNTR_SN
           AND T3.VL_END_DTM = '99991231235959'
           AND T3.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_ADRPC_BAS T4
            ON T4.CNTR_ADRPC_ID = T3.CNTR_ADR_REL_ID
           AND T4.DTA_DL_YN = 'N'
         INNER JOIN TB_CUBS_CST_BAS T5
            ON T5.CST_NO = T2.CNTR_CST_NO
           AND T5.DTA_DL_YN = 'N'
         INNER JOIN TB_PDBS_PD_BAS T6
            ON T6.PD_CD = T1.BASE_PD_CD
           AND T6.DTA_DL_YN = 'N'
         WHERE 1 = 1
           AND T1.DTA_DL_YN = 'N'
        <if test='@MybatisUtils@isNotEmpty(cntrCstKnm)'>
           AND T5.CST_KNM = #{cntrCstKnm}
        </if>
        <if test='@MybatisUtils@isNotEmpty(lrnnCstKnm)'>
           AND T4.CST_KNM = #{lrnnCstKnm}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cralLocaraTno)'>
           AND T5.CRAL_LOCARA_TNO = #{cralLocaraTno}
        </if>
        <if test='@MybatisUtils@isNotEmpty(mexnoEncr)'>
           AND T5.MEXNO_ENCR = #{mexnoEncr}
            <if test='@MybatisUtils@isNotEmpty(cralIdvTno)'>
           AND T5.CRAL_IDV_TNO = #{cralIdvTno}
            </if>
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrCstNo)'>
           AND T2.CNTR_CST_NO = #{cntrCstNo}
        </if>
    </select>

    <select id="selectHomecareContracts" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchHomecareContractsRes">
        SELECT T1.CNTR_NO
             , T1.CNTR_SN
             , T4.RCGVP_KNM
             , T5.PD_CD
             , T5.PD_NM
             , T2.CNTR_CNFM_DTM
          FROM TB_SSCT_CNTR_DTL T1
         INNER JOIN TB_SSCT_CNTR_BAS T2
            ON T2.CNTR_NO = T1.CNTR_NO
           AND T2.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_ADR_REL T3
            ON T3.DTL_CNTR_NO = T1.CNTR_NO
           AND T3.DTL_CNTR_SN = T1.CNTR_SN
           AND T3.VL_END_DTM = '99991231235959'
           AND T3.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_ADRPC_BAS T4
            ON T4.CNTR_ADRPC_ID = T3.CNTR_ADR_REL_ID
           AND T4.DTA_DL_YN = 'N'
         INNER JOIN TB_PDBS_PD_BAS T5
            ON T5.PD_CD = T1.BASE_PD_CD
           AND T5.DTA_DL_YN = 'N'
         WHERE 1 = 1
           AND T1.DTA_DL_YN = 'N'
           AND
        <foreach collection="dtos" item="cntr" separator="OR" open="(" close=")">
            (T1.CNTR_NO = #{cntr.cntrNo} AND T1.CNTR_SN = #{cntr.cntrSn})
        </foreach>
    </select>

    <update id="updateHomecareContractsDuedt">
        UPDATE TB_SSCT_CNTR_DTL
           SET SPP_DUEDT = #{duedt}
        <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </update>

    <update id="updateHomecareContractsCandt">
        UPDATE TB_SSCT_CNTR_DTL
           SET CNTR_DTL_STAT_CD = '303'
        <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </update>

    <select id="selectApprovalAskDivides" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchRes">
        SELECT CNTR_APR_AK_DV_CD
             , CNTR_APR_AK_DV_CD AS CNTR_APR_AK_DV_PK
             , CNTR_APR_AK_DV_CD_NM
             , (CNTR_APR_AK_DV_CD || '-' || CNTR_APR_AK_DV_CD_NM) AS CNTR_APR_AK_DV_NM
             , CNTR_APR_AK_MSG_CN
             , CNTR_APR_CAN_MSG_CN
             , CNTR_APR_CONF_MSG_CN
             , VL_STRT_DTM
             , VL_STRT_DTM AS VL_STRT_DTM_PK
             , VL_END_DTM
          FROM TB_SSCT_CNTR_APR_AK_DV_CD
         WHERE 1=1
           AND DTA_DL_YN = 'N'
         <if test='@MybatisUtils@isNotEmpty(standardDt)'>
           AND #{standardDt} BETWEEN VL_STRT_DTM AND VL_END_DTM
         </if>
         ORDER BY TO_NUMBER(CNTR_APR_AK_DV_CD)
    </select>

    <update id="deleteApprovalAskDivides">
        UPDATE TB_SSCT_CNTR_APR_AK_DV_CD
           SET DTA_DL_YN = 'Y'
               <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND CNTR_APR_AK_DV_CD = #{cntrAprAkDvCd}
           AND VL_STRT_DTM = #{vlStrtDtm}
    </update>

    <select id="selectConfirmAprPsicAks" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchConfirmAprPsicAksRes">
        SELECT MIN(T2.CNTR_APR_FW_ID)   AS CNTR_APR_FW_ID         /*계약승인발송ID*/
             , T1.CNTR_APR_AK_DV_CD                             /* 계약승인요청구분코드*/
             , MIN(T1.AK_USR_ID)                               AS AK_USR_ID           /*요청자 사번 REQ_ID*/
             , MIN(T1.RQR_NM)                                    AS RQR_NM           /*요청자 명 REQ_NM*/
             , T2.CNTR_APR_FW_DV_CD     /* 계약승인발송구분코드*/
             , CASE WHEN T2.CNTR_APR_FW_DV_CD = '1' THEN '요청(1)'
                    WHEN T2.CNTR_APR_FW_DV_CD = '4' THEN '취소(4)'
                    ELSE ''
               END                                          AS CNTR_APR_FW_DV_NM       /*요청구분 1:요청,4:취소*/
             , LISTAGG(DISTINCT  T2.RCV_USR_NM,',') WITHIN GROUP (ORDER BY T1.AK_USR_ID) AS RCV_USR_NM
             , MIN(T2.FW_DTM) AS SEND_DTTM           /*발송일시*/
             , MIN(CASE WHEN T2.CNTR_APR_FW_DV_CD = '1' THEN T1.APR_YN ELSE '-' END)     AS APRV_YN     /*승인 여부*/
             , MIN(CASE WHEN T2.CNTR_APR_FW_DV_CD = '1' THEN T1.APR_USR_ID ELSE '-' END) AS APRV_ID     /*승인자 사번*/
             , MIN(CASE WHEN T2.CNTR_APR_FW_DV_CD = '1' THEN T1.APR_USR_NM ELSE '-' END) AS APRV_NM     /*승인자 명*/
             , MIN(T1.APR_DTM)                         AS APRV_DTTM   /*승인 일시*/
             , MIN(CASE WHEN T2.CNTR_APR_FW_DV_CD = '1' THEN T1.CAN_YN  ELSE '-' END)    AS CANC_YN     /*취소 여부*/
             , MIN(T3.CNTR_APR_AK_DV_CD_NM)                                              AS ACKD_REQ_NM      /*승인 요청 명*/
             , MIN(CNTR_NO)
         FROM TB_SSCT_CNTR_APR_IZ T1                        /* T.계약승인내역     WPN_DFNT_ACKD_REQ REQ */
         LEFT OUTER JOIN TB_SSCT_CNTR_APR_FW_HIST T2        /* T.계약승인발송이력   WPN_DFNT_ACKD_MSG MSG */
            ON T1.CNTR_APR_ID = T2.CNTR_APR_ID                  /* 계약승인ID (MIG DATA 맞지 않음)*/
           AND T2.DTA_DL_YN = 'N'  /* 데이터삭제여부 */
         LEFT OUTER JOIN TB_SSCT_CNTR_APR_AK_DV_CD T3       /* T.계약승인요청구분코드 WPN_DFNT_ACKD_BAS BAS */
           ON T1.CNTR_APR_AK_DV_CD = T3.CNTR_APR_AK_DV_CD   /* 계약승인요청구분코드 */
          AND T3.DTA_DL_YN = 'N'  /* 데이터삭제여부 */
        WHERE 1=1
          AND T1.CNTR_NO = #{cntrNo}/* 계약번호 */
          AND T1.DTA_DL_YN = 'N'  /* 데이터삭제여부 */
        GROUP BY T1.CNTR_APR_AK_DV_CD, T2.CNTR_APR_FW_DV_CD, T1.CNTR_APR_AK_DV_CD /*계약승인ID, 계약승인발송구분코드, 계약승인요청구분코드*/
        ORDER BY T1.CNTR_APR_AK_DV_CD, T2.CNTR_APR_FW_DV_CD, T1.CNTR_APR_AK_DV_CD /*계약승인ID, 계약승인발송구분코드, 계약승인요청구분코드*/
    </select>

    <select id="selectConfirmAprPsicPrchss" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchConfirmAprPsicPrchssRes">
        SELECT T2.CNTR_NO || T2.CNTR_SN  AS CNTR_NO /* 계약번호 */
             , T3.CST_KNM  /* 계약자명 */
             , NVL((SELECT CASE WHEN CST_GD_CD = '2' THEN 'VIP' ELSE '일반' END        /* 고객등급 */
                  FROM TB_SSCT_CST_GD_ESTM_IZ T10 /* T.고객등급산정내역*/
                 WHERE 1=1
                  AND T10.CST_NO = T1.CNTR_CST_NO       /* 고객번호 */
                  AND T10.VL_END_DTM = '99991231235959' /* 유효종료일시*/
                  AND T10.DTA_DL_YN = 'N'               /* 데이터삭제여부*/
                  AND T10.CST_GD_ESTM_DT = (SELECT MAX(CST_GD_ESTM_DT)
                                             FROM TB_SSCT_CST_GD_ESTM_BAI_IZ T11 /*고객등급산정근거내역*/
                                            WHERE 1=1
                                              AND T11.CNTR_NO = T2.CNTR_NO  /* 계약변호*/
                                              AND T11.CNTR_SN = T2.CNTR_SN  /* 계약일련번호 */
                                              AND T11.DTA_DL_YN = 'N'
                                              AND T11.SELL_TP_CD  = '2' /* 판매유형 : 렌탈(2) */
                                            )), '-') AS CST_GD_NM   /* 고객등급 */
             , T5.RCGVP_KNM  /* 고객명 */
             , (T51.RNADR ||' '|| T51.RDADR) AS ADR  /* 설치주소 */
             , T6.PD_NM  /* 상품명 */
             , T7.IST_DT /* 설치일 */
             , CASE WHEN REGEXP_LIKE(T2.CNTR_DTL_STAT_CD, '^2|^3') THEN '탈퇴'
                    WHEN REGEXP_LIKE(T2.CNTR_DTL_STAT_CD, '^4') THEN    '종료'
                    WHEN REGEXP_LIKE(T2.CNTR_DTL_STAT_CD, '^1') THEN    '관리'
                    ELSE '' END  USE_DIV
             , T2.CNTR_DTL_STAT_CD  /* 사용구분 1:관리,2:탈퇴,3:취소, 0:완료 */
             , F_CMZ_CD_NM('TNT_WELLS', 'CNTR_DTL_STAT_CD', T2.CNTR_DTL_STAT_CD) AS TCNTR_DTL_STAT_CD2  /* 사용구분 1:관리,2:탈퇴,3:취소, 0:완료 */
             , T8.APY_TN                            AS APY_TN   /* 렌탈회차(적용회차) : 월마감실적에 생성될예정*/
             , T9.DLQ_MCN || '/' ||T9.DLQ_OC_AMT    AS DLQ_INFO /* 연체개월/금액 */
          FROM TB_SSCT_CNTR_BAS T1             /* T.계약기본 (고객번호)*/
         INNER JOIN TB_SSCT_CNTR_DTL T2             /* T.계약상세 */
            ON T1.CNTR_NO = T2.CNTR_NO
           AND T2.SELL_TP_CD = '2' /*렌탈*/
           AND T2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS T3        /* T.고객기본 */
            ON T3.CST_NO = T1.CNTR_CST_NO
           AND T3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS T5 /* T.계약주소지기본 */
            ON T5.CNTR_CST_NO = T1.CNTR_CST_NO
           AND T5.CNTR_NO = T1.CNTR_NO
           AND T5.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_GBCO_ADR_BAS T51       /* T.주소기본 */
            ON T51.ADR_ID = T5.ADR_ID
          LEFT OUTER JOIN TB_PDBS_PD_BAS T6         /* T.상품기본 */
            ON T6.PD_CD = T2.BASE_PD_CD
           AND T6.DTA_DL_YN = 'N'
           AND T6.SELL_YN = 'Y'
          LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T7 /* T.계약WELLS상세 */
            ON T7.CNTR_NO = T2.CNTR_NO              /* 계약번호 */
           AND T7.CNTR_SN = T2.CNTR_SN
           LEFT OUTER JOIN LATERAL (SELECT *
                                     FROM (SELECT T80.CNTR_NO
                                                , T80.CNTR_SN
                                                , /*T8.APY_TN*/ 'TODO'  AS APY_TN   /* 렌탈회차 */
                                             FROM TB_CBCL_CNTR_PERF_MM_CL T80       /* T.계약실적월마감 */
                                            WHERE 1=1
                                              AND T80.CNTR_NO = T2.CNTR_NO
                                              AND T80.CNTR_SN = T2.CNTR_SN
                                              AND T80.BASE_YM IN (TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMM'), TO_CHAR(SYSDATE,'YYYYMM'))
                                            ORDER BY T80.BASE_YM DESC
                                            )
                                      WHERE ROWNUM= 1
            ) T8
            ON T8.CNTR_NO = T2.CNTR_NO
           AND T8.CNTR_SN = T2.CNTR_SN
          LEFT OUTER JOIN LATERAL (SELECT *
                                     FROM (SELECT T90.CNTR_NO, T90.CNTR_SN, T90.DLQ_MCN, T90.DLQ_OC_AMT
                                             FROM TB_CBCL_DLQ_BAS T90         /* T.연체기본 */
                                            WHERE 1=1
                                              AND T90.CNTR_NO = T2.CNTR_NO
                                              AND T90.CNTR_SN = T2.CNTR_SN
                                              AND T90.BASE_YM IN (TO_CHAR(ADD_MONTHS(SYSDATE,-1),'YYYYMM'), TO_CHAR(SYSDATE,'YYYYMM'))
                                            ORDER BY T90.BASE_YM DESC
                                            )
                                      WHERE ROWNUM= 1
            ) T9
            ON T9.CNTR_NO = T2.CNTR_NO
           AND T9.CNTR_SN = T2.CNTR_SN
        WHERE 1=1
          AND T1.DTA_DL_YN = 'N'
          AND T1.CNTR_NO = #{cntrNo}
    </select>

    <select id="selectConfirmApprovalBases" resultType="com.kyowon.sms.wells.web.contract.ordermgmt.dto.WctaContractDto$SearchConfirmApprovalBaseRes">
        SELECT T1.CNTR_APR_BASE_ID
             , T1.CNTR_APR_AK_DV_CD
             , T1.CNTR_APR_SELL_DV_CD
             , T2.CNTR_APR_AK_DV_CD_NM
             , T1.CNTR_APR_CHNL_DV_VAL
             , T1.CNTR_APR_ICHR_DV_CD
             , T1.ICHR_USR_ID
             , CASE WHEN T1.PSIC_NM = '0' THEN '' ELSE T1.PSIC_NM END PSIC_NM
             , T1.VL_STRT_DTM
             , T1.VL_END_DTM
             , T1.NOTY_FW_OJ_YN
          FROM TB_SSCT_CNTR_APR_BASE_BAS T1
             , TB_SSCT_CNTR_APR_AK_DV_CD T2
         WHERE 1=1
           AND T1.CNTR_APR_AK_DV_CD = T2.CNTR_APR_AK_DV_CD
         <if test='@MybatisUtils@isNotEmpty(cntrAprAkDvCd)'>
           AND T1.CNTR_APR_AK_DV_CD = #{cntrAprAkDvCd}
         </if>
         <if test='@MybatisUtils@isNotEmpty(standardDt)'>
           AND #{standardDt} BETWEEN T1.VL_STRT_DTM AND T1.VL_END_DTM
         </if>
           AND T1.DTA_DL_YN = 'N'
    </select>

    <select id="selectCountConfirmApprovalBases" resultType="int">
         SELECT COUNT(1) AS "CNT"
           FROM TB_SSCT_CNTR_APR_BASE_BAS
          WHERE 1=1
            AND CNTR_APR_AK_DV_CD = #{cntrAprAkDvCd}
         <if test='@MybatisUtils@equals(checkType,"U")'>    <!-- Unique : 삭제시 존재 여부 체크, 수정시 변경하려는 자료의 값이 존재하는지 체크 -->
            AND CNTR_APR_SELL_DV_CD = #{cntrAprSellDvCd}
            AND CNTR_APR_CHNL_DV_VAL = #{cntrAprChnlDvVal}
            AND CNTR_APR_ICHR_DV_CD = #{cntrAprIchrDvCd}
            AND ICHR_USR_ID = #{ichrUsrId}
            AND VL_STRT_DTM = #{vlStrtDtm}
            AND CNTR_APR_BASE_ID = #{cntrAprBaseId}
         </if>
          <if test='@MybatisUtils@equals(checkType,"A")'>    <!-- Area : 수정시 기존 자료와 기간 중복 체크-->
            AND CNTR_APR_SELL_DV_CD = #{cntrAprSellDvCd}
            AND CNTR_APR_CHNL_DV_VAL = #{cntrAprChnlDvVal}
            AND CNTR_APR_ICHR_DV_CD = #{cntrAprIchrDvCd}
            AND ICHR_USR_ID = #{ichrUsrId}
            AND (#{vlStrtDtm} BETWEEN VL_STRT_DTM AND VL_END_DTM
              OR #{vlEndDtm} BETWEEN VL_STRT_DTM AND VL_END_DTM
              OR VL_END_DTM BETWEEN #{vlStrtDtm} AND #{vlEndDtm})
          <if test='@MybatisUtils@isNotEmpty(cntrAprBaseId)'>
            AND CNTR_APR_BASE_ID != #{cntrAprBaseId}
          </if>
         </if>
    </select>

    <insert id="insertConfirmApprovalBases">
        INSERT INTO TB_SSCT_CNTR_APR_BASE_BAS(
           CNTR_APR_BASE_ID
         , CNTR_APR_AK_DV_CD
         , CNTR_APR_SELL_DV_CD
         , CNTR_APR_CHNL_DV_VAL
         , CNTR_APR_ICHR_DV_CD
         , ICHR_USR_ID
         , PSIC_NM
         , VL_STRT_DTM
         , VL_END_DTM
         , NOTY_FW_OJ_YN
         , DTA_DL_YN
         <include refid="COMMON.insertSystemField"/>
    ) VALUES (
           (SELECT NVL(MAX(TO_NUMBER(CNTR_APR_BASE_ID))+1,0) FROM TB_SSCT_CNTR_APR_BASE_BAS)
         , #{cntrAprAkDvCd}
         , #{cntrAprSellDvCd}
         , #{cntrAprChnlDvVal}
         , #{cntrAprIchrDvCd}
         , #{ichrUsrId}
         , #{psicNm}
         , #{vlStrtDtm}
         , #{vlEndDtm}
         , #{notyFwOjYn}
         , NVL(#{dtaDlYn}, 'N')
         <include refid="COMMON.insertSystemFieldValue"/>
       )
    </insert>

    <update id="updateConfirmApprovalBases">
        UPDATE TB_SSCT_CNTR_APR_BASE_BAS
           SET CNTR_APR_SELL_DV_CD = #{cntrAprSellDvCd}
             , CNTR_APR_CHNL_DV_VAL = #{cntrAprChnlDvVal}
             , CNTR_APR_ICHR_DV_CD = #{cntrAprIchrDvCd}
             , ICHR_USR_ID = #{ichrUsrId}
             , PSIC_NM = #{psicNm}
             , VL_STRT_DTM = #{vlStrtDtm}
             , VL_END_DTM = #{vlEndDtm}
             , NOTY_FW_OJ_YN = #{notyFwOjYn}
               <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND CNTR_APR_BASE_ID = #{cntrAprBaseId}
    </update>

    <update id="deleteConfirmApprovalBases">
        UPDATE TB_SSCT_CNTR_APR_BASE_BAS
           SET DTA_DL_YN = 'Y'
               <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND CNTR_APR_BASE_ID = #{cntrAprBaseId}
           AND CNTR_APR_AK_DV_CD = #{cntrAprAkDvCd}
           AND CNTR_APR_SELL_DV_CD = #{cntrAprSellDvCd}
           AND CNTR_APR_CHNL_DV_VAL = #{cntrAprChnlDvVal}
           AND CNTR_APR_ICHR_DV_CD = #{cntrAprIchrDvCd}
           AND ICHR_USR_ID = #{ichrUsrId}
           AND VL_STRT_DTM = #{vlStrtDtm}
           AND PSIC_NM = #{psicNm}
    </update>
</mapper>
