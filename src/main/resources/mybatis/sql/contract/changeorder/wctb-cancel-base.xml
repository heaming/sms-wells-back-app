<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.changeorder.mapper.WctbCancelBaseMapper">

    <select id="selectCancelBases" resultType="com.kyowon.sms.wells.web.contract.changeorder.dto.WctbCancelBaseDto$SearchRes">
        SELECT T1.SELL_TP_CD
            , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T1.SELL_TP_CD) AS SELL_TP_NM
            , SUBSTR(T2.CNTR_CNFM_DTM,1,8) AS CNTR_CNFM_DT
            , T1.CNTR_NO
            , T1.CNTR_SN
            , F_CMZ_CD_NM('TNT_WELLS', 'COPN_DV_CD', T2.COPN_DV_CD) AS COPN_DV_NM
            , T2.CNTR_CST_NO
            , T4.CST_KNM AS CNTR_CST_KNM
            , T3.PD_NM
            , 'wells' AS CNTR_GBN
            , T6.HOO_PRTNR_NM   /* 본부장명 */
            , T6.HOO_PRTNR_NO   /* 본부장사번 */
            , T5.OG_CD 	        /* 소속 */
            , T1.BASE_PD_CD
            , T1.STPL_PTRM      /* 의무기간 */
            , T1.CNTR_PD_STRTDT /* 매출년월 - 설치일자생성 시 들어감 */
            , T1.CNTR_AMT       /* 등록비 */
            , T1.CNTRAM_DSC_AMT /* 등록비 할인 */
            , T1.CNTR_TAM
            , T1.PD_BASE_AMT    /* 정상렌탈료 */
            , T1.CNTR_PTRM      /* 렌탈개월 */
            , T1.FNL_AMT        /* 렌탈금액 */
            , T1.DSC_AMT        /* 렌탈할인금액 */
            , T7.STPL_PTRM AS RSTL_PTRM /* 재약정개월 */
            , T7.STPL_DSC_AMT   /* 재약정할인금액 */
            , T7.STPL_STRTDT    /* 재약정기간 FROM */
            , T7.STPL_ENDDT     /* 재약정기간 TO */
            , T8.NOM_SL_AMT     /* 정상매출 */
			, T8.RENTAL_DC      /* 렌탈일수 */
			, T8.SL_DC          /* 매출일수 */
			, '' AS CHG_DT      /* 교체일자 없음 */
			, T8.SPMT_SL_AMT    /* 추가매출 */
			, T8.NOM_DSC_AMT    /* 정상할인 */
			, 0 AS CAN_CTR_AMT  /* 취소조정금액 : 일단0으로 SET 화면에서 넣음 */
			, '' AS ADD_SRV	    /* 부가서비스 매출 없음 - LCA125:확인해야 함, 가압펌프 매출 */
			, T8.SPMT_DSC_AMT   /* 추가할인 */
			, T8.SL_CTR_AMT     /* 매출조정금액 */
			, T8.THM_SL_SUM_AMT /* 매출금액 */
			, T8.SL_SUM_VAT     /* 매출VAT */
			, T8.SL_AGG_AMT     /* 매출누계 */
			, 0 AS THM_PAIAM_AMT    /* 당월원리금 - 등록때는 없음 */
			, 0 AS THM_SRV_AMT      /* 당월서비스 - 등록때는 없음 */
			, T8.EOT_PCAM_BLAM      /* 매출잔액 */
			, T81.BTD_DLQ_ADD_AMT   /* 연체가산금 */
			, T81.THM_DLQ_ADD_DP_SUM_AMT    /* 연체가산금입금 */
			, T81.THM_DLQ_ADD_RFND_SUM_AMT  /* 연체가산금환불 */
			, T81.EOT_DLQ_AMT               /* 미수금 : 연체금 */
          FROM TB_SSCT_CNTR_DTL T1
         INNER JOIN TB_SSCT_CNTR_BAS T2
            ON T2.CNTR_NO = T1.CNTR_NO
           AND T2.DTA_DL_YN = 'N'
         INNER JOIN TB_PDBS_PD_BAS T3
            ON T3.PD_CD = T1.BASE_PD_CD
           AND T3.TEMP_SAVE_YN = 'N'
           AND T3.DTA_DL_YN = 'N'
         INNER JOIN TB_CUBS_CST_BAS T4
            ON T4.CST_NO = T2.CNTR_CST_NO
           AND T4.DTA_DL_YN = 'N'
         INNER JOIN TB_OGBS_MM_PRTNR_IZ T5
            ON T5.BASE_YM = SUBSTR(T2.CNTR_CNFM_DTM,1,6)
           AND T5.OG_TP_CD = T2.SELL_OG_TP_CD
           AND T5.PRTNR_NO = T2.SELL_PRTNR_NO
           AND T5.DTA_DL_YN = 'N'
         INNER JOIN TB_OGBS_MM_OG_IZ T6
            ON T6.OG_ID = T5.OG_ID
           AND T6.BASE_YM = T5.BASE_YM
           AND T6.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_RENTAL_RSTL_IZ T7
            ON T7.CNTR_NO = T1.CNTR_NO
           AND T7.CNTR_SN = T1.CNTR_SN
           AND T7.STPL_TN = (SELECT MAX(STPL_TN)
                               FROM TB_SSCT_RENTAL_RSTL_IZ
                              WHERE CNTR_NO = T1.CNTR_NO
                                AND CNTR_SN = T1.CNTR_SN
                                AND DTA_DL_YN = 'N')
           AND T7.DTA_DL_YN = 'N'
         INNER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ T8    /* 매출이 생성되지 않은 건은 체크하므로 아예 조건에 포함 */
            ON T8.CNTR_NO = T1.CNTR_NO
           AND T8.CNTR_SN = T1.CNTR_SN
           AND T8.SL_CL_YM = (SELECT MAX(SL_CL_YM)
                                FROM TB_CBCL_WELLS_SL_MM_CL_IZ
                               WHERE CNTR_NO = T1.CNTR_NO
                                 AND CNTR_SN = T1.CNTR_SN )
           AND T8.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CBCL_DLQ_BAS T81
            ON T81.CNTR_NO = T8.CNTR_NO
           AND T81.CNTR_SN = T8.CNTR_SN
           AND T81.PERF_YM = T8.SL_CL_YM
           AND T81.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_REL T9
            ON T9.OJ_DTL_CNTR_NO = T1.CNTR_NO
           AND T9.OJ_DTL_CNTR_SN = T1.CNTR_SN
           AND T9.CNTR_REL_DTL_CD = '215'
           AND T9.DTA_DL_YN = 'N'
         WHERE T1.DTA_DL_YN = 'N'
<!--           AND T1.SELL_TP_CD = '2'-->
           AND T1.STPL_PTRM > 0             /* 의무약정기간이 있어야 함 */
           AND T9.OJ_DTL_CNTR_NO IS NULL    /* 1+1 이전코드가 아니어야 함 */
           AND T1.CNTR_DTL_STAT_CD IN ('101','201','202')
       <if test="@MybatisUtils@isNotEmpty(cntrNo)">
            AND T1.CNTR_NO = #{cntrNo}              /* 계약상세번호 조건이 존재하는 경우 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cntrSn)">
            AND T1.CNTR_SN = #{cntrSn}
        </if>
        <if test="@MybatisUtils@isNotEmpty(cstNo)">
            AND T2.CNTR_CST_NO = #{cstNo}
        </if>
        <if test="@MybatisUtils@isNotEmpty(dm)">
            AND T2.CNTR_CNFM_DTM BETWEEN #{dm}||'01000000' AND #{dm}||'31235959'
        </if>
    </select>
</mapper>
