<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.contract.changeorder.mapper.WctbMembershipBulkChangeMapper">
    <select id="selectMembershipBulkChanges" resultType="com.kyowon.sms.wells.web.contract.changeorder.dto.WctbMembershipBulkChangeDto$SearchRes">
        SELECT T1.CNTR_NO||'-'||T1.CNTR_SN AS CNTR_DTL_NO	/*상세계약번호*/
             , (SELECT CST_KNM FROM TB_CUBS_CST_BAS WHERE CST_NO = T2.CNTR_CST_NO) AS CST_KNM /* 계약자명 */
             , T2.SELL_INFLW_CHNL_DTL_CD	/*판매유입채널상세 - 판매구분*/
             , T1.SELL_TP_DTL_CD	/*판매유형상세코드 - 판매유형*/
             , T2.SELL_PRTNR_NO		/*판매파트너번호-대리인코드*/
             , (SELECT PRTNR_KNM FROM TB_OGBS_PRTNR_BAS WHERE PRTNR_NO = T2.SELL_PRTNR_NO AND  OG_TP_CD = T2.SELL_OG_TP_CD AND DTA_DL_YN='N') AS PRTNR_NM	/*판매파트너명*/
             , (SELECT RVE_CD FROM TB_OGBS_PRTNR_DTL WHERE OG_TP_CD = T2.SELL_OG_TP_CD AND PRTNR_NO = T2.SELL_PRTNR_NO) AS RVE_CD	/*수납코드*/
             , T3.REQD_DT	/*철거일자*/
             , T5.CNTR_CH_RCP_DTM	/*접수일-변경요청접수일*/
             , T3.IST_DT	/*설치일*/
             , T2.CNTR_STLM_FSH_DTM	/*계약결제완료일시-매출일자*/
             , T1.SV_PRD	/*서비스주기*/
             , '' AS USEYN /* 용도구분 TODO : 매핑안됨 */
             , T1.BASE_PD_CD	/*기준상품코드*/
             , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE PD_CD = T1.BASE_PD_CD) AS PD_NM /* 상품명 */
             , T1.FNL_AMT		/*멤버쉽회비*/
             , T1.STLM_TP_CD	/*결제유형코드-납입방법*/
             , T3.FRISU_BFSVC_PTRM_N	/*무상BS기간수-멤버십무상*/
             , T1.CNTRW_TP_CD	/*계약서유형코드-멤버십구분*/
             , T1.STPL_PTRM		/*약정기간-멤버십기간*/
             , T2.CNTR_CNFM_APR_DTM	/*계약확정승인일시-확정일*/
             , (SELECT MIN(CAN_DT) KEEP(DENSE_RANK FIRST ORDER BY SL_CL_YM)
                   FROM TB_CBCL_WELLS_SL_MM_CL_IZ
                  WHERE DTA_DL_YN = 'N'
                    AND CNTR_NO = T1.CNTR_NO
                    AND CNTR_SN = T1.CNTR_SN
                ) AS CAN_DT 	/*취소일자*/
             , T1.SPP_DUEDT AS DUEDT /* 예정일(홈케어)-매핑후처리필요 계약상세변경이력:배송예정일자 */
             , T2.CNTR_CNFM_DTM		/*계약확정일시 -가입일:AS-IS대비 확인필요' */
             , (SELECT HIST_STRT_DTM
                  FROM TB_SSCT_CNTR_DTL_STAT_CH_HIST
                 WHERE CNTR_NO = T1.CNTR_NO
                   AND CNTR_SN = T1.CNTR_SN
                   AND HIST_END_DTM = '99991231235959'
                   AND CNTR_DTL_STAT_CD IN ('301','302','303','401','402')
                ) AS WDWAL_DT    /*탈퇴일*/
             , (SELECT F_CMZ_CD_NM('TNT_WELLS', 'SV_VST_PRD_CD', PD_PRP_VAL02)
                  FROM TB_PDBS_PD_ECOM_PRP_DTL
                 WHERE 1=1
                   AND PD_CD = T1.BASE_PD_CD
                   AND PD_EXTS_PRP_GRP_CD = 'SCHD'
                   AND PD_PRP_VAL03 IS NOT NULL )  AS VST_PRD	/*방문주기 */
             , F_CMZ_CD_NM('TNT_WELLS', 'LC_CTT_RS_CD', T1.CTT_RS_CD) AS CTT_RS_NM	/*컨택코드*/
             , T1.CTT_PSIC_ID	/*컨택담당*/
             , (SELECT USR_NM FROM T_CMP_USR_ACO_M WHERE USR_ID = T1.CTT_PSIC_ID) AS CTT_PSIC_NM	/*컨택담당명*/
             , T3.HCR_DV_CD		/*홈케어구분코드-상품구분*/
             , T1.FEE_FXAM_YN	/*수수료정액여부-정액여부(Y:수당제외)*/
             , T1.FEE_ACKMT_BASE_AMT	/*수수료인정기준금액-수수료기준금액*/
             , T1.SELL_DSC_DV_CD	/*판매할인구분코드-할인구분*/
             , T1.SELL_DSCR_CD	/*판매할인율코드-할인유형*/
             , '' AS GRP_GBN /* 그룹구분 TODO : 컬럼확인 필요 */
             , T1.FST_RGST_DTM	/*최초등록일시-입력일자*/
             , T1.FST_RGST_USR_ID	/*최초등록사용자ID-입력담당*/
             , (SELECT USR_NM FROM T_CMP_USR_ACO_M WHERE USR_ID = T1.FST_RGST_USR_ID) AS FST_RGST_USR_NM /*입력담당자명*/
             , T1.FNL_MDFC_DTM		/*최종수정일시-수정일자*/
             , T1.FNL_MDFC_USR_ID	/*최종수정사용자ID-수정담당*/
             , (SELECT USR_NM FROM T_CMP_USR_ACO_M WHERE USR_ID = T1.FNL_MDFC_USR_ID) AS FNL_MDFC_USR_NM	/*수정담당자명*/
             , T5.CNTR_CH_AK_CN AS CNTR_CH_AK_CN /* 변경사유 */
          FROM TB_SSCT_CNTR_CH_RCP_DTL T4 	/*계약변경접수상세*/
         INNER JOIN TB_SSCT_CNTR_CH_RCP_BAS T5 	/*계약변경접수기본*/
            ON T5.DTA_DL_YN = 'N'
           AND T4.DTA_DL_YN = 'N'
           AND T5.CNTR_CH_RCP_ID = T4.CNTR_CH_RCP_ID
         INNER JOIN TB_SSCT_CNTR_DCH_HIST T1		/*계약상세변경이력*/
            ON T1.CNTR_NO = T4.DTL_CNTR_NO
           AND T1.CNTR_SN = T4.DTL_CNTR_SN
           AND T1.HIST_STRT_DTM <![CDATA[<=]]> T5.CNTR_CH_FSH_DTM
           AND T1.HIST_END_DTM <![CDATA[>=]]> T5.CNTR_CH_FSH_DTM
           AND T1.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_CH_HIST T2	/*계약변경이력*/
            ON T2.CNTR_NO = T4.DTL_CNTR_NO
           AND T2.HIST_STRT_DTM <![CDATA[<=]]> T5.CNTR_CH_FSH_DTM
           AND T2.HIST_END_DTM <![CDATA[>=]]> T5.CNTR_CH_FSH_DTM
           AND T2.CNTR_NO = T1.CNTR_NO
           AND T2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DCH_HIST T3  /*계약WELLS상세변경이력*/
            ON T3.CNTR_NO = T1.CNTR_NO
           AND T3.CNTR_SN = T1.CNTR_SN
           AND T3.DTA_DL_YN = 'N'
           AND T3.HIST_STRT_DTM <![CDATA[<=]]> T5.CNTR_CH_FSH_DTM
           AND T3.HIST_END_DTM <![CDATA[>=]]> T5.CNTR_CH_FSH_DTM
         WHERE 1=1
           AND T1.SELL_TP_CD = '3'	/*멤버십*/
        <if test='@MybatisUtils@isNotEmpty(cntrNo)'>
            --조회조건 : 계약번호
           AND T1.CNTR_NO = #{cntrNo}
        </if>
        <if test='@MybatisUtils@isNotEmpty(cntrSn)'>
           AND T1.CNTR_SN = #{cntrSn}
        </if>
        <if test='@MybatisUtils@isNotEmpty(rfdt)'>
            -- 조회조건 : 반영년월
           AND SUBSTR(T5.CNTR_CH_FSH_DTM, 1, 8) = #{rfdt}
        </if>
         ORDER BY T1.CNTR_NO, T1.CNTR_SN, T5.CNTR_CH_RCP_DTM
    </select>
</mapper>
