<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.bond.transfer.mapper.WbnaFosterTransferMgtMapper">
    <select id="selectFosterTransfers" resultType="com.kyowon.sms.wells.web.bond.transfer.dto.WbnaFosterTransferMgtDto$SearchRes">
        SELECT BZ_HDQ_DV_CD
             , BASE_YM
             , CLCO_CD
             , SUM(WO_CST_CT) AS TOT_CST_CT
             , SUM(WO_CNTR_CT) AS TOT_CNTR_CT
             , SUM(WO_CST_CT) AS WO_CST_CT
             , SUM(WO_CNTR_CT) AS WO_CNTR_CT
             , SUM(WO_OBJ_AMT) AS WO_OBJ_AMT
             , SUM(WO_DLQ_AMT) AS WO_DLQ_AMT
             , SUM(WO_THM_CHRAM_AMT) AS WO_THM_CHRAM_AMT
             , SUM(WO_DLQ_ADD_AMT) AS WO_DLQ_ADD_AMT
             , SUM(WO_RSG_BOR_AMT) AS WO_RSG_BOR_AMT
             , SUM(RENTAL_CST_CT) AS RENTAL_CST_CT
             , SUM(RENTAL_CNTR_CT) AS RENTAL_CNTR_CT
             , SUM(RENTAL_OBJ_AMT) AS RENTAL_OBJ_AMT
             , SUM(RENTAL_DLQ_AMT) AS RENTAL_DLQ_AMT
             , SUM(RENTAL_THM_CHRAM_AMT) AS RENTAL_THM_CHRAM_AMT
             , SUM(RENTAL_DLQ_ADD_AMT) AS RENTAL_DLQ_ADD_AMT
             , SUM(RENTAL_RSG_BOR_AMT) AS RENTAL_RSG_BOR_AMT
             , SUM(LEASE_CST_CT) AS LEASE_CST_CT
             , SUM(LEASE_CNTR_CT) AS LEASE_CNTR_CT
             , SUM(LEASE_OBJ_AMT) AS LEASE_OBJ_AMT
             , SUM(LEASE_DLQ_AMT) AS LEASE_DLQ_AMT
             , SUM(LEASE_THM_CHRAM_AMT) AS LEASE_THM_CHRAM_AMT
             , SUM(LEASE_DLQ_ADD_AMT) AS LEASE_DLQ_ADD_AMT
             , SUM(LEASE_RSG_BOR_AMT) AS LEASE_RSG_BOR_AMT
             , SUM(MSH_CST_CT) AS MSH_CST_CT
             , SUM(MSH_CNTR_CT) AS MSH_CNTR_CT
             , SUM(MSH_OBJ_AMT) AS MSH_OBJ_AMT
             , SUM(MSH_DLQ_AMT) AS MSH_DLQ_AMT
             , SUM(MSH_THM_CHRAM_AMT) AS MSH_THM_CHRAM_AMT
             , SUM(MSH_DLQ_ADD_AMT) AS MSH_DLQ_ADD_AMT
             , SUM(MSH_RSG_BOR_AMT) AS MSH_RSG_BOR_AMT
             , COUNT(RGLR_SPP_CST_CT) RGLR_SPP_CST_CT
             , COUNT(RGLR_SPP_CNTR_CT) AS RGLR_SPP_CNTR_CT
             , SUM(RGLR_SPP_OBJ_AMT) AS RGLR_SPP_OBJ_AMT
             , SUM(RGLR_SPP_DLQ_AMT) AS RGLR_SPP_DLQ_AMT
             , SUM(RGLR_SPP_THM_CHRAM_AMT) AS RGLR_SPP_THM_CHRAM_AMT
             , SUM(RGLR_SPP_DLQ_ADD_AMT) AS RGLR_SPP_DLQ_ADD_AMT
             , SUM(RGLR_SPP_RSG_BOR_AMT) AS RGLR_SPP_RSG_BOR_AMT
             , SUM(HCR_CST_CT) AS HCR_CST_CT
             , SUM(HCR_CNTR_CT) AS HCR_CNTR_CT
             , SUM(HCR_OBJ_AMT) AS HCR_OBJ_AMT
             , SUM(HCR_DLQ_AMT) AS HCR_DLQ_AMT
             , SUM(HCR_THM_CHRAM_AMT) AS HCR_THM_CHRAM_AMT
             , SUM(HCR_DLQ_ADD_AMT) AS HCR_DLQ_ADD_AMT
             , SUM(HCR_RSG_BOR_AMT) AS HCR_RSG_BOR_AMT
             , COUNT(SPAY_CST_CT) AS SPAY_CST_CT
             , COUNT(SPAY_CNTR_CT) AS SPAY_CNTR_CT
             , SUM(SPAY_OBJ_AMT) AS SPAY_OBJ_AMT
             , SUM(SPAY_DLQ_AMT) AS SPAY_DLQ_AMT
             , SUM(SPAY_THM_CHRAM_AMT) AS SPAY_THM_CHRAM_AMT
             , SUM(SPAY_DLQ_ADD_AMT) AS SPAY_DLQ_ADD_AMT
             , SUM(SPAY_RSG_BOR_AMT) AS SPAY_RSG_BOR_AMT
          FROM (
                SELECT BZ_HDQ_DV_CD
                     , BASE_YM
                     , BND_BIZ_DV_CD
                     , CLCO_CD
                     , COUNT(DISTINCT CST_NO) as WO_CST_CT		/* 전체 고객수 			*/
                     , COUNT(CNTR_NO) 	as WO_CNTR_CT		/* 전체 계약수 			*/
                     , SUM(DLQ_AMT + THM_CHRAM_AMT) 	as WO_OBJ_AMT		/* 전체 대상금액 		*/
                     , SUM(DLQ_AMT) 	as WO_DLQ_AMT		/* 전체 연체금액 		*/
                     , SUM(THM_CHRAM_AMT) 	as WO_THM_CHRAM_AMT	/* 전체 당월금액 	*/
                     , SUM(DLQ_ADD_AMT)	as WO_DLQ_ADD_AMT	/* 전체 연체가산금액 	*/
                     , SUM(RSG_BOR_AMT) 	as WO_RSG_BOR_AMT	/* 전체 위약금액 */
                     /*렌탈*/
                     , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L20' THEN CST_NO ELSE NULL END) AS RENTAL_CST_CT
                     , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN CNTR_NO ELSE NULL END) AS RENTAL_CNTR_CT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN (DLQ_AMT + THM_CHRAM_AMT) ELSE 0 END) AS RENTAL_OBJ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN DLQ_AMT ELSE 0 END) AS RENTAL_DLQ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN THM_CHRAM_AMT ELSE 0 END) AS RENTAL_THM_CHRAM_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN DLQ_ADD_AMT ELSE 0 END) AS RENTAL_DLQ_ADD_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN RSG_BOR_AMT ELSE 0 END) AS RENTAL_RSG_BOR_AMT
                     /*(금융)리스*/
                     , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L21' THEN CST_NO ELSE NULL END) AS LEASE_CST_CT
                     , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN CNTR_NO ELSE NULL END) AS LEASE_CNTR_CT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN (DLQ_AMT + THM_CHRAM_AMT) ELSE 0 END) AS LEASE_OBJ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN DLQ_AMT ELSE 0 END) AS LEASE_DLQ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN THM_CHRAM_AMT ELSE 0 END) AS LEASE_THM_CHRAM_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN DLQ_ADD_AMT ELSE 0 END) AS LEASE_DLQ_ADD_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN RSG_BOR_AMT ELSE 0 END) AS LEASE_RSG_BOR_AMT
                     /*(일반)멥버십*/
                     , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L30' THEN CST_NO ELSE NULL END) AS MSH_CST_CT
                     , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN CNTR_NO ELSE NULL END) AS MSH_CNTR_CT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN (DLQ_AMT + THM_CHRAM_AMT) ELSE 0 END) AS MSH_OBJ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN DLQ_AMT ELSE 0 END) AS MSH_DLQ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN THM_CHRAM_AMT ELSE 0 END) AS MSH_THM_CHRAM_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN DLQ_ADD_AMT ELSE 0 END) AS MSH_DLQ_ADD_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN RSG_BOR_AMT ELSE 0 END) AS MSH_RSG_BOR_AMT
                     /*정기배송*/
                     , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L60' THEN CST_NO ELSE NULL END) AS RGLR_SPP_CST_CT
                     , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN CNTR_NO ELSE NULL END) AS RGLR_SPP_CNTR_CT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN (DLQ_AMT + THM_CHRAM_AMT) ELSE 0 END) AS RGLR_SPP_OBJ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN DLQ_AMT ELSE 0 END) AS RGLR_SPP_DLQ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN THM_CHRAM_AMT ELSE 0 END) AS RGLR_SPP_THM_CHRAM_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN DLQ_ADD_AMT ELSE 0 END) AS RGLR_SPP_DLQ_ADD_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN RSG_BOR_AMT ELSE 0 END) AS RGLR_SPP_RSG_BOR_AMT
                     /*(홈케어)멥버십 - 없는 값 나중에 판매유형코드로 변경 될 수 있음*/
                     , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L30' THEN CST_NO ELSE NULL END) AS HCR_CST_CT
                     , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN CNTR_NO ELSE NULL END) AS HCR_CNTR_CT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN (DLQ_AMT + THM_CHRAM_AMT) ELSE 0 END) AS HCR_OBJ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN DLQ_AMT ELSE 0 END) AS HCR_DLQ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN THM_CHRAM_AMT ELSE 0 END) AS HCR_THM_CHRAM_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN DLQ_ADD_AMT ELSE 0 END) AS HCR_DLQ_ADD_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L30' THEN RSG_BOR_AMT ELSE 0 END) AS HCR_RSG_BOR_AMT
                     /*일시불 - 없는 값 나중에 판매유형코드로 변경 될 수 있음*/
                     , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L10' THEN CST_NO ELSE NULL END) AS SPAY_CST_CT
                     , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN CNTR_NO ELSE NULL END) AS SPAY_CNTR_CT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN (DLQ_AMT + THM_CHRAM_AMT) ELSE 0 END) AS SPAY_OBJ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN DLQ_AMT ELSE 0 END) AS SPAY_DLQ_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN THM_CHRAM_AMT ELSE 0 END) AS SPAY_THM_CHRAM_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN DLQ_ADD_AMT ELSE 0 END) AS SPAY_DLQ_ADD_AMT
                     , SUM(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN RSG_BOR_AMT ELSE 0 END) AS SPAY_RSG_BOR_AMT
                  FROM TB_CBBO_BND_CNTR_BAS
                 WHERE 1=1
                   AND BASE_YM = #{baseYm} /* 기준년월 */
                   AND BZ_HDQ_DV_CD = #{bzHdqDvCd} /* 사업부 구분 */
                   AND CLCO_CD = '01' /* 위탁사 : NICE */
                   AND BND_CLCTN_PRP_DV_CD = '03' /* 위탁 상태의 채권만 대상 */
            <if test="@MybatisUtils@isNotEmpty(bndNwDvCd)">
                   AND BND_NW_DV_CD = #{bndNwDvCd} /* 신규구분 */
            </if>
            <if test="@MybatisUtils@isNotEmpty(cstNo)">
                   AND CST_NO = #{cstNo} /* 고객번호 */
            </if>
            <if test="@MybatisUtils@isNotEmpty(cstNm)">
                   AND CST_NM = #{cstNm} /* 고객명 */
            </if>
            <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
                   AND CRAL_LOCARA_TNO = #{cralLocaraTno} /* 휴대지역전화번호 */
            </if>
            <if test="@MybatisUtils@isNotEmpty(mexnoEncr)">
                   AND MEXNO_ENCR = #{mexnoEncr} /* 휴대전화국번호암호화 */
            </if>
            <if test="@MybatisUtils@isNotEmpty(cralIdvTno)">
                   AND CRAL_IDV_TNO = #{cralIdvTno} /* 휴대개별전화번호 */
            </if>
                 GROUP BY BZ_HDQ_DV_CD, BASE_YM, CLCO_CD, BND_BIZ_DV_CD /* 사업본부구분코드, 기준년월, 추심사코드 , 채권업무구분코드 */
            ) T1
       GROUP BY BZ_HDQ_DV_CD, BASE_YM, CLCO_CD
    </select>

    <select id="selectPartTransferDetailsSummary" resultType="com.kyowon.sms.wells.web.bond.transfer.dto.WbnaFosterTransferMgtDto$SearchDetailSummaryRes">
        SELECT T1.BASE_YM
             , T1.BZ_HDQ_DV_CD
             , T1.CLCO_CD
             , TO_CHAR(SUM(T1.DLQ_AMT + T1.THM_CHRAM_AMT), 'FM999,999,999,999') AS TRG_AMT  /* 대상금액 */
             , TO_CHAR(SUM(T1.DLQ_AMT), 'FM999,999,999,999') AS DLQ_AMT                     /* 연체금액 */
             , TO_CHAR(SUM(T1.THM_CHRAM_AMT), 'FM999,999,999,999') AS THM_CHRAM_AMT         /* 당월금액 */
             , TO_CHAR(SUM(T1.DLQ_ADD_AMT), 'FM999,999,999,999') AS DLQ_ADD_AMT             /* 연체가산금액 */
             , TO_CHAR(SUM(T1.RSG_BOR_AMT), 'FM999,999,999,999') AS RSG_BOR_AMT             /* 위약금액 */
          FROM TB_CBBO_BND_CNTR_BAS T1
         WHERE T1.BASE_YM = #{baseYm}                                                       /* 기준년월 */
           AND T1.BZ_HDQ_DV_CD = #{bzHdqDvCd}                                               /* 사업부 구분 */
           AND T1.CLCO_CD = '01'                                                            /* 위탁사 : NICE */
           AND T1.BND_CLCTN_PRP_DV_CD = '03'		                                        /* 채권추심속성구분코드 = 03.위탁이관 */
        <if test="@MybatisUtils@isNotEmpty(bndNwDvCd)">
           AND T1.BND_NW_DV_CD = #{bndNwDvCd}                                               /* 신규구분 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cstNo)">
           AND T1.CST_NO = #{cstNo}                                                         /* 고객번호 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cstNm)">
            AND T1.CST_NM = #{cstNm}                                                        /* 고객명 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
           AND T1.CRAL_LOCARA_TNO = #{cralLocaraTno}                                        /* 휴대지역전화번호 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(mexnoEncr)">
           AND T1.MEXNO_ENCR = #{mexnoEncr}                                                 /* 휴대전화국번호암호화 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cralIdvTno)">
           AND T1.CRAL_IDV_TNO = #{cralIdvTno}                                              /* 휴대개별전화번호 */
        </if>
         GROUP BY BZ_HDQ_DV_CD, BASE_YM, CLCO_CD
    </select>

    <select id="selectFosterTransferDetails" resultType="com.kyowon.sms.wells.web.bond.transfer.dto.WbnaFosterTransferMgtDto$SearchDetailRes">
        WITH CLCO_TF_OJ AS (
        SELECT T1.CLCO_CD AS FSTR_CO_NM		                /* 위탁사명 */
		     , T1.CLCTN_OJ_PRTNR_NO			                /* 담당자명 */
		     , T1.CLCTAM_DV_CD AS JBF_CLCTAM_DV_CD		    /* 직전담당집금구분 */
		     , T1.BF_CLCTAM_PRTNR_NO AS JBF_CLCTAM_PRTNR_NO /* 직전담당자 */
		     , T1.CNTR_NO			                        /* 계약번호 */
		     , T1.CNTR_SN			                        /* 계약일련번호 */
		     , T1.CST_NM			                        /* 고객명 */
		     , T1.CST_NO				                    /* 고객번호 */
		     , T1.BND_BIZ_DV_CD AS PD_NM			        /* 상품구분 = 채권업무구분코드 */
		     , T1.DLQ_MCN			                        /* 연체개월 */
		     , CASE WHEN T1.CLCTAM_DV_CD IN ('01','02','04') THEN T1.DLQ_AMT + T1.THM_CHRAM_AMT + T1.DLQ_ADD_AMT + T1.RSG_BOR_AMT WHEN T1.CLCTAM_DV_CD = '03' THEN T1.DLQ_AMT ELSE 0 END AS TRG_AMT	        /* 대상금액 */
		     , T1.DLQ_AMT			                        /* 연체금액 */
		     , T1.THM_CHRAM_AMT		                        /* 당월요금 */
		     , T1.DLQ_ADD_AMT		                        /* 연체가산금 */
		     , T1.RSG_BOR_AMT		                        /* 위약금액 */
		     , (SELECT RNADR                                /* 도로명주소 */
		          FROM TB_GBCO_ADR_BAS                      /* 주소기본 Table */
		         WHERE T1.BND_CST_ADR_ID = ADR_ID) AS ADDR	/* 고객 주소 */
 	    FROM TB_CBBO_BND_CNTR_BAS T1	                    /* 채권계약기본 Table */
       WHERE T1.BASE_YM = #{baseYm}                         /* 기준년월 */
         AND T1.BZ_HDQ_DV_CD = #{bzHdqDvCd}                 /* 사업부 구분 */
         AND CLCO_CD = '01'                                 /* 위탁사 : NICE */
         AND T1.BND_CLCTN_PRP_DV_CD = '03'		            /* 채권추심속성구분코드 = 03.위탁이관 */
        <if test="@MybatisUtils@isNotEmpty(bndNwDvCd)">
         AND T1.BND_NW_DV_CD = #{bndNwDvCd}                    /* 신규구분 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cstNo)">
         AND T1.CST_NO = #{cstNo}                              /* 고객번호 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cstNm)">
         AND T1.CST_NM = #{cstNm}                              /* 고객명 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
         AND T1.CRAL_LOCARA_TNO = #{cralLocaraTno}             /* 휴대지역전화번호 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(mexnoEncr)">
         AND T1.MEXNO_ENCR = #{mexnoEncr}                      /* 휴대전화국번호암호화 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cralIdvTno)">
         AND T1.CRAL_IDV_TNO = #{cralIdvTno}                   /* 휴대개별전화번호 */
        </if>
        )
       SELECT T2.FSTR_CO_NM			                        /* 위탁사명 */
            , T2.CLCTN_OJ_PRTNR_NO	                        /* 담당자명 */
            , T2.JBF_CLCTAM_DV_CD	                        /* 직전담당집금구분 */
            , T2.JBF_CLCTAM_PRTNR_NO	                    /* 직전담당자 */
            , T2.CNTR_NO			                        /* 계약번호 */
            , T2.CNTR_SN			                        /* 계약일련번호  */
            , T2.CST_NM			                            /* 고객명 */
            , T2.CST_NO			                            /* 고객번호 */
            , T2.PD_NM			                            /* 상품구분 -- 계약번호 + 계약상세번호 로 상품정보 조회 */
            , T2.DLQ_MCN		                            /* 연체개월 */
            , T2.TRG_AMT			                        /* 대상금액 */
            , T2.DLQ_AMT			                        /* 연체금액 */
            , T2.THM_CHRAM_AMT	                            /* 당월요금 */
            , T2.DLQ_ADD_AMT		                        /* 연체가산금 */
            , T2.RSG_BOR_AMT		                        /* 위약금액 */
            , T3.LWM_TP_CD		                            /* 법조치유형 */
            , T3.LWM_DTL_TP_CD	                            /* 법조치상세 */
            , T3.LWM_DT			                            /* 법조치일자 */
            , T3.DFLT_DT			                        /* 채불등록일자 */
            , T2.ADDR	                                    /* 고객 주소 */
         FROM CLCO_TF_OJ T2	                                /* WITH로 생성한 위탁이관대상 가상 Table */
         LEFT OUTER JOIN TB_CBBO_BND_LWM_IZ T3	                /* 채권법조치내역 Talbe */
           ON T2.CNTR_NO = T3.CNTR_NO
          AND T2.CNTR_SN = T3.CNTR_SN
    </select>
</mapper>
