<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.bond.transfer.mapper.WbnaFosterTransferMgtMapper">
    <select id="selectFosterTransfers" resultType="com.kyowon.sms.wells.web.bond.transfer.dto.WbnaFosterTransferMgtDto$SearchRes">
        WITH WELLS_FSTR_TF_DATA AS (
             SELECT T1.BASE_YM	                                                            /* 기준년월 */
                  , T1.BZ_HDQ_DV_CD	                                                        /* 사업본부구분코드 */
                  , T1.CLCTAM_DV_CD	                                                        /* 집금구분코드 */
                  , T1.CLCO_CD                                                              /* 추심사코드 */
                  , NVL( CASE WHEN T2.SELL_TP_DTL_CD IN ('11', '12', '13') THEN 'L10'	    /* 할부(일시불) */
                              WHEN T2.SELL_TP_DTL_CD IN ('21', '23', '25', '26') THEN 'L20'	/* 렌탈 */
                              WHEN T2.SELL_TP_DTL_CD IN ('22', '24') THEN 'L21'				/* (금융)리스 */
                              WHEN T2.SELL_TP_DTL_CD IN ('31', '32') THEN 'L31'				/* 일반멤버십 */
                              WHEN T2.SELL_TP_DTL_CD = '33' THEN 'L32'						/* 홈케어멤버십 */
                              WHEN T2.SELL_TP_DTL_CD IN ('61', '62', '63') THEN 'L60'		/* 정기배송 */
                          END, T1.BND_BIZ_DV_CD) AS BND_BIZ_DV_CD		                    /* 채권업무구분코드 */
                 , T1.CNTR_NO	                                                            /* 계약번호 */
                 , T1.CNTR_SN	                                                            /* 계약일련번호 */
                 , T1.CST_NO 	                                                            /* 고객번호 */
                 , NVL(T1.DLQ_AMT, 0) + NVL(T1.DLQ_ADD_AMT, 0) AS DLQ_AMT	                /* 연체금액(=연체금액 + 연체가산금액) */
                 , NVL(T1.THM_CHRAM_AMT, 0) AS THM_CHRAM_AMT	                            /* 당월요금금액 */
                 , NVL(T1.DLQ_ADD_AMT, 0) AS DLQ_ADD_AMT		                            /* 연체가산금액 */
                 , NVL(T1.RSG_BOR_AMT, 0) AS RSG_BOR_AMT		                            /* 위약금액 */
              FROM TB_CBBO_BND_CNTR_BAS T1 		                                            /* 채권계약기본 Table */
              LEFT OUTER JOIN TB_SSCT_CNTR_DTL T2	                                        /* 계약상세 TABLE */
                ON T2.CNTR_NO = T1.CNTR_NO
               AND T2.CNTR_SN = T1.CNTR_SN
             WHERE 1 = 1
               AND T1.BASE_YM = #{baseYm}
               AND T1.BZ_HDQ_DV_CD = #{bzHdqDvCd}		/* 사업본부구분코드 : 20.WELLS */
               AND T1.CLCTAM_DV_CD = '09'			    /* 집금구분코드 : 09.위탁 */
               AND T1.BND_CLCTN_PRP_DV_CD = '03'	    /* 채권추심속성구분코드 : 03.위탁이관 */
               AND T1.DTA_DL_YN = 'N'
        <if test="@MybatisUtils@isNotEmpty(bndNwDvCd)">
               AND T1.BND_NW_DV_CD = #{bndNwDvCd} /* 신규구분 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cstNo)">
               AND T1.CST_NO = #{cstNo} /* 고객번호 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cstNm)">
               AND T1.CST_NM = #{cstNm} /* 고객명 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
               AND T1.CRAL_LOCARA_TNO = #{cralLocaraTno} /* 휴대지역전화번호 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(mexnoEncr)">
               AND T1.MEXNO_ENCR = #{mexnoEncr} /* 휴대전화국번호암호화 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cralIdvTno)">
               AND T1.CRAL_IDV_TNO = #{cralIdvTno} /* 휴대개별전화번호 */
        </if>
             )
        SELECT BASE_YM
             , BZ_HDQ_DV_CD
             , CLCO_CD
             , COUNT(DISTINCT CST_NO) AS WO_CST_CT		/* 전체 고객수 */
             , COUNT(CNTR_NO) AS WO_CNTR_CT				/* 전체 계약수 */
             , SUM(DLQ_AMT + DLQ_ADD_AMT + THM_CHRAM_AMT + RSG_BOR_AMT) AS WO_OBJ_AMT	/* 전체 대상금액 */
             , SUM(DLQ_AMT)	AS WO_DLQ_AMT				/* 전체 연체금액 */
             , SUM(THM_CHRAM_AMT) AS WO_THM_CHRAM_AMT	/* 전체 당월금액 */
             , SUM(DLQ_ADD_AMT)	AS WO_DLQ_ADD_AMT		/* 전체 연체가산금액 */
             , SUM(RSG_BOR_AMT) AS WO_RSG_BOR_AMT		/* 전체 위약금액 */
             /* 렌탈 */
             , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L20' THEN CST_NO ELSE NULL END) AS RENTAL_CST_CT
             , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN CNTR_NO ELSE NULL END) AS RENTAL_CNTR_CT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN (DLQ_AMT + DLQ_ADD_AMT + THM_CHRAM_AMT + RSG_BOR_AMT) ELSE 0 END) AS RENTAL_OBJ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN DLQ_AMT ELSE 0 END) AS RENTAL_DLQ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN THM_CHRAM_AMT ELSE 0 END) AS RENTAL_THM_CHRAM_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN DLQ_ADD_AMT ELSE 0 END) AS RENTAL_DLQ_ADD_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L20' THEN RSG_BOR_AMT ELSE 0 END) AS RENTAL_RSG_BOR_AMT
             /* 금융리스 */
             , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L21' THEN CST_NO ELSE NULL END) AS LEASE_CST_CT
             , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN CNTR_NO ELSE NULL END) AS LEASE_CNTR_CT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN (DLQ_AMT + DLQ_ADD_AMT + THM_CHRAM_AMT + RSG_BOR_AMT) ELSE 0 END) AS LEASE_OBJ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN DLQ_AMT ELSE 0 END) AS LEASE_DLQ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN THM_CHRAM_AMT ELSE 0 END) AS LEASE_THM_CHRAM_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN DLQ_ADD_AMT ELSE 0 END) AS LEASE_DLQ_ADD_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L21' THEN RSG_BOR_AMT ELSE 0 END) AS LEASE_RSG_BOR_AMT
             /* 일반멤버십 */
             , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L31' THEN CST_NO ELSE NULL END) AS MSH_CST_CT
             , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L31' THEN CNTR_NO ELSE NULL END) AS MSH_CNTR_CT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L31' THEN (DLQ_AMT + DLQ_ADD_AMT + THM_CHRAM_AMT + RSG_BOR_AMT) ELSE 0 END) AS MSH_OBJ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L31' THEN DLQ_AMT ELSE 0 END) AS MSH_DLQ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L31' THEN THM_CHRAM_AMT ELSE 0 END) AS MSH_THM_CHRAM_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L31' THEN DLQ_ADD_AMT ELSE 0 END) AS MSH_DLQ_ADD_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L31' THEN RSG_BOR_AMT ELSE 0 END) AS MSH_RSG_BOR_AMT
             /* 홈케어멤버십 */
             , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L32' THEN CST_NO ELSE NULL END) AS HCR_CST_CT
             , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L32' THEN CNTR_NO ELSE NULL END) AS HCR_CNTR_CT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L32' THEN (DLQ_AMT + DLQ_ADD_AMT + THM_CHRAM_AMT + RSG_BOR_AMT) ELSE 0 END) AS HCR_OBJ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L32' THEN DLQ_AMT ELSE 0 END) AS HCR_DLQ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L32' THEN THM_CHRAM_AMT ELSE 0 END) AS HCR_THM_CHRAM_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L32' THEN DLQ_ADD_AMT ELSE 0 END) AS HCR_DLQ_ADD_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L32' THEN RSG_BOR_AMT ELSE 0 END) AS HCR_RSG_BOR_AMT
             /* 일시불 */
             , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L10' THEN CST_NO ELSE NULL END) AS SPAY_CST_CT
             , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN CNTR_NO ELSE NULL END) AS SPAY_CNTR_CT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN (DLQ_AMT + DLQ_ADD_AMT + THM_CHRAM_AMT + RSG_BOR_AMT) ELSE 0 END) AS SPAY_OBJ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN DLQ_AMT ELSE 0 END) AS SPAY_DLQ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN THM_CHRAM_AMT ELSE 0 END) AS SPAY_THM_CHRAM_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN DLQ_ADD_AMT ELSE 0 END) AS SPAY_DLQ_ADD_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L10' THEN RSG_BOR_AMT ELSE 0 END) AS SPAY_RSG_BOR_AMT
             /* 정기배송 */
             , COUNT(DISTINCT CASE WHEN BND_BIZ_DV_CD = 'L60' THEN CST_NO ELSE NULL END) AS RGLR_SPP_CST_CT
             , COUNT(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN CNTR_NO ELSE NULL END) AS RGLR_SPP_CNTR_CT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN (DLQ_AMT + DLQ_ADD_AMT + THM_CHRAM_AMT + RSG_BOR_AMT) ELSE 0 END) AS RGLR_SPP_OBJ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN DLQ_AMT ELSE 0 END) AS RGLR_SPP_DLQ_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN THM_CHRAM_AMT ELSE 0 END) AS RGLR_SPP_THM_CHRAM_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN DLQ_ADD_AMT ELSE 0 END) AS RGLR_SPP_DLQ_ADD_AMT
             , SUM(CASE WHEN BND_BIZ_DV_CD = 'L60' THEN RSG_BOR_AMT ELSE 0 END) AS RGLR_SPP_RSG_BOR_AMT
          FROM WELLS_FSTR_TF_DATA  		/* WELLS 위탁이관데이터 Virtual View */
         GROUP BY BASE_YM, BZ_HDQ_DV_CD, CLCO_CD
    </select>

    <select id="selectPartTransferDetailsSummary" resultType="com.kyowon.sms.wells.web.bond.transfer.dto.WbnaFosterTransferMgtDto$SearchDetailSummaryRes">
        SELECT T1.BASE_YM
             , T1.BZ_HDQ_DV_CD
             , T1.CLCO_CD
             , TO_CHAR(SUM(NVL(T1.DLQ_AMT, 0) + NVL(T1.DLQ_ADD_AMT, 0) + NVL(T1.THM_CHRAM_AMT, 0) + NVL(T1.RSG_BOR_AMT, 0)), 'FM999,999,999,999') AS TRG_AMT  /* 대상금액 */
             , TO_CHAR(SUM(NVL(T1.DLQ_AMT, 0) + NVL(T1.DLQ_ADD_AMT, 0)), 'FM999,999,999,999') AS DLQ_AMT                     /* 연체금액 */
             , TO_CHAR(SUM(NVL(T1.THM_CHRAM_AMT, 0)), 'FM999,999,999,999') AS THM_CHRAM_AMT         /* 당월금액 */
             , TO_CHAR(SUM(NVL(T1.DLQ_ADD_AMT, 0)), 'FM999,999,999,999') AS DLQ_ADD_AMT             /* 연체가산금액 */
             , TO_CHAR(SUM(NVL(T1.RSG_BOR_AMT, 0)), 'FM999,999,999,999') AS RSG_BOR_AMT             /* 위약금액 */
          FROM TB_CBBO_BND_CNTR_BAS T1
         WHERE T1.BASE_YM = #{baseYm}
           AND T1.BZ_HDQ_DV_CD = #{bzHdqDvCd}
           AND T1.CLCTAM_DV_CD = '09'			                                        /* 집금구분코드 : 09.위탁 */
           AND T1.BND_CLCTN_PRP_DV_CD = '03'	                                        /* 채권추심속성구분코드 : 03.위탁이관 */
           AND T1.DTA_DL_YN = 'N'
        <if test="@MybatisUtils@isNotEmpty(bndNwDvCd)">
           AND T1.BND_NW_DV_CD = #{bndNwDvCd}                                               /* 신규구분 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cstNo)">
           AND T1.CST_NO = #{cstNo}                                                         /* 고객번호 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cstNm)">
            AND T1.CST_NM = #{cstNm}                                                        /* 고객명 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
           AND T1.CRAL_LOCARA_TNO = #{cralLocaraTno}                                        /* 휴대지역전화번호 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(mexnoEncr)">
           AND T1.MEXNO_ENCR = #{mexnoEncr}                                                 /* 휴대전화국번호암호화 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(cralIdvTno)">
           AND T1.CRAL_IDV_TNO = #{cralIdvTno}                                              /* 휴대개별전화번호 */
        </if>
         GROUP BY BZ_HDQ_DV_CD, BASE_YM, CLCO_CD
    </select>

    <select id="selectFosterTransferDetails" resultType="com.kyowon.sms.wells.web.bond.transfer.dto.WbnaFosterTransferMgtDto$SearchDetailRes">
        WITH BND_LWM_IZ AS (
             SELECT T2.*
               FROM ( SELECT BND_BIZ_DV_CD
                           , CNTR_NO
                           , CNTR_SN
                           , MAX(LWM_DT) KEEP(DENSE_RANK LAST ORDER BY LWM_DT) AS LWM_DT
                        FROM TB_CBBO_BND_LWM_IZ T2                  /* 채권법조치내역 Talbe */
                       GROUP BY BND_BIZ_DV_CD, CNTR_NO, CNTR_SN ) T1
             INNER JOIN TB_CBBO_BND_LWM_IZ T2                       /* 채권법조치내역 Talbe */
                ON T2.CNTR_NO = T1.CNTR_NO
               AND T2.CNTR_SN = T1.CNTR_SN
               AND T2.LWM_DT = T1.LWM_DT
            )
        SELECT F_CMZ_CD_NM('TNT_EDU', 'CLCO_CD', T1.CLCO_CD) AS FSTR_CO_NM              /* 위탁사명 */
             , T1.CLCTAM_PRTNR_NO 	                                                    /* 담당자번호 */
             , T4.PRTNR_KNM AS CLCTAM_PRTNR_NM                                          /* 담당자명 */
             , F_CMZ_CD_NM('TNT_EDU', 'CLCTAM_DV_CD', T4.CLCTAM_DV_CD) AS CLCTAM_DVD 	/* 직전담당집금 */
             , T4.PRTNR_KNM 		                                                    /* 직전담당자 */
             , T1.CNTR_NO 				                                                /* 계약번호 */
             , T1.CNTR_SN 				                                                /* 계약일련번호 */
             , T1.CST_NM 				                                                /* 고객명 */
             , T1.CST_NO 				                                                /* 고객번호 */
             , NVL( CASE WHEN T3.SELL_TP_DTL_CD IN ('11', '12', '13') THEN 'L10'	    /* 할부(일시불) */
                         WHEN T3.SELL_TP_DTL_CD IN ('21', '23', '25', '26') THEN 'L20'	/* 렌탈 */
                         WHEN T3.SELL_TP_DTL_CD IN ('22', '24') THEN 'L21'				/* (금융)리스 */
                         WHEN T3.SELL_TP_DTL_CD IN ('31', '32') THEN 'L31'				/* 일반멤버십 */
                         WHEN T3.SELL_TP_DTL_CD = '33' THEN 'L32'						/* 홈케어멤버십 */
                         WHEN T3.SELL_TP_DTL_CD IN ('61', '62', '63') THEN 'L60'		/* 정기배송 */
                     END, T1.BND_BIZ_DV_CD) AS PD_NM                                    /* 상품구분=채권업무구분코드 */
             , T1.DLQ_MCN	                                                            /* 연체개월 */
             , NVL(T1.DLQ_AMT, 0) + NVL(DLQ_ADD_AMT, 0) + NVL(T1.THM_CHRAM_AMT, 0) + NVL(T1.RSG_BOR_AMT, 0) AS TRG_AMT	/* 대상금액(=연체금액 + 연체가산금액 + 당월요금 + 위약금액) */
             , NVL(DLQ_AMT, 0) + NVL(DLQ_ADD_AMT, 0) AS DLQ_AMT		                   /* 연체금액(=연체금액 + 연체가산금액) */
             , NVL(THM_CHRAM_AMT, 0) AS THM_CHRAM_AMT	                               /* 당월요금 */
             , NVL(DLQ_ADD_AMT, 0) AS DLQ_ADD_AMT		                               /* 연체가산금 */
             , NVL(RSG_BOR_AMT, 0) AS RSG_BOR_AMT		                               /* 위약금액 */
             , F_CMZ_CD_NM('TNT_EDU', 'LWM_TP_CD', T2.LWM_TP_CD) AS LWM_TP 		        /* 법조치유형 */
             , F_CMZ_CD_NM('TNT_EDU', 'LWM_DTL_TP_CD', T2.LWM_DTL_TP_CD) AS LWM_DTL_TP_CD 	/* 법조치상세 */
             , T2.LWM_DT 			                                                    /* 법조치일자 */
             , T2.DFLT_DT 			                                                    /* 채불등록일자 */
             , (SELECT RNADR
                  FROM TB_GBCO_ADR_BAS
                 WHERE ADR_ID = (SELECT ADR_ID
                                   FROM TB_CUBS_CST_BAS
                                  WHERE CST_NO=T1.CST_NO)
                   AND DTA_DL_YN != 'Y') AS ADDR		                                /* 고객 주소 */
          FROM TB_CBBO_BND_CNTR_BAS T1 	                                                /* 채권계약기본 TABLE */
          LEFT OUTER JOIN BND_LWM_IZ T2
            ON T2.CNTR_NO = T1.CNTR_NO
           AND T2.CNTR_SN = T1.CNTR_SN
          LEFT OUTER JOIN TB_SSCT_CNTR_DTL T3	                                        /* 계약상세 TABLE */
            ON T3.CNTR_NO = T1.CNTR_NO
           AND T3.CNTR_SN = T1.CNTR_SN
          LEFT OUTER JOIN TB_CBBO_CLCTAM_PRTNR_DTL T4	                                /* 집금파트너상세 TABLE */
            ON T4.PRTNR_NO = T1.CLCTAM_PRTNR_NO
         WHERE T1.BASE_YM = #{baseYm}
           AND T1.BZ_HDQ_DV_CD = #{bzHdqDvCd}
           AND T1.CLCTAM_DV_CD = '09'			                                        /* 집금구분코드 : 09.위탁 */
           AND T1.BND_CLCTN_PRP_DV_CD = '03'	                                        /* 채권추심속성구분코드 : 03.위탁이관 */
           AND T1.DTA_DL_YN = 'N'
           <if test="@MybatisUtils@isNotEmpty(bndNwDvCd)">
           AND T1.BND_NW_DV_CD = #{bndNwDvCd}                    /* 신규구분 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(cstNo)">
           AND T1.CST_NO = #{cstNo}                              /* 고객번호 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(cstNm)">
           AND T1.CST_NM = #{cstNm}                              /* 고객명 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
           AND T1.CRAL_LOCARA_TNO = #{cralLocaraTno}             /* 휴대지역전화번호 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(mexnoEncr)">
           AND T1.MEXNO_ENCR = #{mexnoEncr}                      /* 휴대전화국번호암호화 */
           </if>
           <if test="@MybatisUtils@isNotEmpty(cralIdvTno)">
           AND T1.CRAL_IDV_TNO = #{cralIdvTno}                   /* 휴대개별전화번호 */
           </if>
    </select>
</mapper>
