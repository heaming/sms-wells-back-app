<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.bond.credit.mapper.WbndRentalCbMgtDelinquentHistoryMapper">
    <select id="selectRentalCbMgtDelinquentHistories" resultType="com.kyowon.sms.wells.web.bond.credit.dvo.WbndRentalCbDelinquentIzDvo">
        /* 렌탈CB 연체이력 조회 */
        SELECT K1.CST_NO
             , B1.CST_KNM
             , B1.COPN_DV_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'COPN_DV_CD', B1.COPN_DV_CD) AS COPN_DV_NM /*법인격구분명*/
             , B1.CRAL_LOCARA_TNO
             , B1.MEXNO_ENCR
             , B1.CRAL_IDV_TNO
             , K1.ORG_DLQ_AMT AS DLQ_AMT
             , GREATEST(K1.ORG_DLQ_BLAM - K1.NET_DP_AMT, 0) AS DLQ_BLAM
             , K1.CLCTAM_PRTNR_NO
             , N1.PRTNR_KNM
             , '1588-4113' AS DSPH_TNO               /*발신번호*/
             , K1.NICE_FW_DT AS RGST_SCH_DT           /*NICE등록예정일자*/
             , K1.NICE_FW_EXCD_YN                     /*나이스발송제외여부*/
             , M1.MSG_FW_DT
             , M1.RESULT_YN
        FROM (
            SELECT M1.CST_NO
                , SUM(M1.DLQ_AMT) AS ORG_DLQ_AMT
                , SUM(M1.DLQ_BLAM) AS ORG_DLQ_BLAM
                , MAX(M1.NICE_FW_EXCD_YN) AS NICE_FW_EXCD_YN
                , MAX(M1.NICE_FW_DT) AS NICE_FW_DT
                , MAX(N1.CLCTAM_PRTNR_NO) AS CLCTAM_PRTNR_NO
                , SUM(R1.DP_RVE_AMT - R1.RFND_RVE_AMT) AS NET_DP_AMT
                , MAX(M1.NOTY_TRS_DT) AS NOTY_TRS_DT
            FROM TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ M1
            INNER JOIN TB_SSCT_CNTR_STLM_REL C3
                ON M1.CNTR_NO = C3.DTL_CNTR_NO
                AND C3.DTA_DL_YN = 'N'
                AND #{baseYm} BETWEEN SUBSTR(C3.VL_STRT_DTM, 1, 6) AND SUBSTR(C3.VL_END_DTM, 1, 6)
            INNER JOIN TB_SSCT_CNTR_STLM_BAS C4
                ON C3.CNTR_STLM_ID = C4.CNTR_STLM_ID
                AND C4.DTA_DL_YN = 'N'
                AND C4.DP_TP_CD IN ('0101', '0102', '0201','0203') /*계좌자동이체, 카드자동이체*/
            INNER JOIN LATERAL (
                SELECT X1.*
                  FROM TB_CBBO_BND_CNTR_BAS X1
                 WHERE X1.BASE_YM = #{baseYm}
                   AND M1.CNTR_NO = X1.CNTR_NO
                   AND X1.BND_CLCTN_PRP_RSON_CD IN ('20', '3C', '80')
                 ORDER BY X1.BASE_YM ASC
                FETCH FIRST 1 ROW ONLY
            ) N1
                ON 1 = 1
            INNER JOIN LATERAL (
                SELECT NVL(SUM(CASE WHEN X1.DP_DV_CD IN ('1', '3') THEN NVL(X1.DP_AMT, 0) ELSE 0 END), 0) AS DP_RVE_AMT   /*입금금액*/
                     , NVL(SUM(CASE WHEN X1.DP_DV_CD IN ('2', '4') THEN NVL(X1.DP_AMT, 0) ELSE 0 END), 0) AS RFND_RVE_AMT /*환불금액*/
                  FROM TB_RVDW_RVE_DTL X1
                 WHERE M1.CNTR_NO = X1.CNTR_NO
                   AND SUBSTR(X1.PERF_DT, 1, 6) = #{baseYm}
                   AND M1.CST_NO = X1.CST_NO
                   AND X1.RVE_DV_CD IN ('02','03','04','05','07','08','19','13','18','97')
                   AND X1.DP_DV_CD IN ('1','2','3','4')
                   AND X1.DP_MES_CD IN ('01', '02')    /*입금수단코드-01:현금,02:신용카드*/
                   AND X1.RVE_PROCS_YN = 'Y' /*수납처리여부*/
                   AND X1.DTA_DL_YN = 'N'
                   AND X1.KW_GRP_CO_CD = '2000'
                   AND X1.RVE_SN = (SELECT MAX(SX1.RVE_SN) AS RVE_SN FROM TB_RVDW_RVE_DTL SX1 WHERE SX1.KW_GRP_CO_CD = X1.KW_GRP_CO_CD AND SX1.RVE_NO = X1.RVE_NO)
            ) R1
                ON 1 = 1
            WHERE 1 = 1
            <if test="@MybatisUtils@isNotEmpty(cstNo)">
                AND M1.CST_NO = #{cstNo}                  /*고객번호*/
            </if>
                AND M1.RENTAL_CB_RGST_DV_CD IN ('1', '3')
                AND NVL(M1.DLQ_BLAM, 0) > 0  /* 연체잔액 */
                AND M1.DTA_DL_YN = 'N'
                AND M1.NOTY_FW_OJ_YN = 'Y'
                AND M1.RLS_DT IS NULL
                AND TO_CHAR(TO_DATE(M1.OC_CRT_DT, 'YYYYMMDD'), 'YYYYMM') = #{baseYm}
            GROUP BY M1.CST_NO
        ) K1
        INNER JOIN TB_CUBS_CST_BAS B1
             ON K1.CST_NO = B1.CST_NO
        LEFT JOIN TB_CBBO_CLCTAM_PRTNR_DTL N1
             ON K1.CLCTAM_PRTNR_NO = N1.PRTNR_NO
        LEFT JOIN LATERAL (
            SELECT
                SUBSTR(X1.FWBOO_DTM, 1, 8) AS MSG_FW_DT
                , DECODE(NVL(X3.RESULT, X2.RESULT), '1000', 'Y', 'N') AS RESULT_YN
            FROM TB_CBBO_BND_MSG_RELY_IZ X1
            LEFT JOIN ATA_MMT_TRAN X2
                ON X1.BND_MSG_RELY_ID = X2.RESERVED2
                AND X1.FW_BIZ_NM = X2.RESERVED3
                AND X1.BND_MSG_TP_VAL1 = X2.RESERVED4
                AND X1.BND_MSG_TP_VAL2 = X2.RESERVED5
                AND X2.TEMPLATE_CODE = 'wells18153'
            LEFT JOIN ATA_MMT_LOG X3
                ON X2.MT_PR = X3.MT_PR
            WHERE
                X1.FW_BIZ_NM = 'BN_KAKAO_MESSAGE' /*발송업무명*/
                AND X1.MSG_FW_TP_CD = '01'            /*메시지발송유형코드-01:카카오알림톡*/
                AND X1.BND_MSG_TP_VAL1 = 'B'          /*채권알림톡업무코드-B:등록관련*/
                AND X1.BND_MSG_TP_VAL2 = 'B05'        /*채권알림톡업무상세코드-B05:렌탈CB연체정보등록 예고*/
                AND K1.CST_NO = X1.CST_NO
                AND X1.DTA_DL_YN = 'N'
                AND K1.NOTY_TRS_DT = SUBSTR(X1.FST_RGST_DTM, 1, 8)
        ) M1
            ON 1 = 1
        WHERE 1 = 1
            AND K1.ORG_DLQ_AMT - K1.NET_DP_AMT > 0
        <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
            AND B1.CRAL_LOCARA_TNO = #{cralLocaraTno} /*휴대폰번호1*/
        </if>
        <if test="@MybatisUtils@isNotEmpty(mexnoEncr)">
            AND B1.MEXNO_ENCR = #{mexnoEncr}          /*휴대폰번호2-입력된값을 암호화하여 대입*/
        </if>
        <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
            AND B1.CRAL_IDV_TNO = #{cralIdvTno}       /*휴대폰번호3*/
        </if>
        ORDER BY K1.CST_NO
    </select>

    <select id="selectRentalCbDlqIzSendThisMonthCount" resultType="integer">
        SELECT COUNT(1)
          FROM TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ
         WHERE 1 = 1
           AND OC_CRT_DT LIKE #{baseYm}||'%'
           AND NOTY_FW_OJ_YN = 'Y'   /*알림발송대상여부*/
           AND NOTY_TRS_DT IS NOT NULL
           AND DTA_DL_YN = 'N'
    </select>

    <update id="updateRentalCbDlqIz" >
        /* 렌탈CB 연체이력 조회 - 저장(NICE발송제외 여부) */
        UPDATE TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ
           SET NICE_FW_EXCD_YN = #{niceFwExcdYn}
		<include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND CST_NO = #{cstNo}
           AND OC_CRT_DT LIKE #{baseYm}||'%'
    </update>
    <insert id="insertRentalCbDlqHistory">
        /* 렌탈CB 연체정보 조회 - 저장(이력) */
        INSERT INTO TB_CBBO_RENTAL_CB_DLQ_HIST ( /*T:렌탈CB연체이력*/
               CNTR_NO                 /*계약번호*/
             , HIST_CH_DTM             /*이력변경일시*/
             , CST_NO                  /*고객번호*/
             , RENTAL_CB_RGST_DV_CD    /*렌탈CB등록구분코드*/
             , DLQ_AMT                 /*연체금액*/
             , DLQ_BLAM                /*연체잔액*/
             , FST_OC_DT               /*최초발생일자*/
             , OC_BSDT                 /*발생기준일자*/
             , OC_CRT_DT               /*발생생성일자*/
             , OC_FILE_CRT_DT          /*발생파일생성일자*/
             , CHG_FILE_CRT_DT         /*변동파일생성일자*/
             , RLS_FILE_CRT_DT         /*해제파일생성일자*/
             , BF_RLS_DT               /*이전해제일자*/
             , RLS_DT                  /*해제일자*/
             , DL_DT                   /*삭제일자*/
             , CLCTAM_OG_TP_CD         /*집금조직유형코드*/
             , CLCTAM_PRTNR_NO         /*집금파트너번호*/
             , NICE_FW_EXCD_YN         /*나이스발송제외여부*/
             , NOTY_FW_OJ_YN           /*알림발송대상여부*/
             , NOTY_TRS_DT             /*알림전송일자*/
             , NOTY_RCV_DT             /*알림수신일자*/
             , NOTY_RCV_YN             /*알림수신여부*/
             , NOTAK_RS_CD             /*알림톡결과코드*/
             , SMS_FW_RCV_STAT_CD      /*SMS발송수신상태코드*/
             , DTA_DL_YN               /*데이터삭제여부*/
		<include refid="COMMON.insertSystemField"/>
        )
        SELECT CNTR_NO                 /*계약번호*/
             , TO_CHAR(SYSDATE,'YYMMDDHH24MMSS')||LPAD(ROWNUM,2,0) AS HIST_CH_DTM
             , CST_NO                  /*고객번호*/
             , RENTAL_CB_RGST_DV_CD    /*렌탈CB등록구분코드*/
             , DLQ_AMT                 /*연체금액*/
             , DLQ_BLAM                /*연체잔액*/
             , FST_OC_DT               /*최초발생일자*/
             , OC_BSDT                 /*발생기준일자*/
             , OC_CRT_DT               /*발생생성일자*/
             , OC_FILE_CRT_DT          /*발생파일생성일자*/
             , CHG_FILE_CRT_DT         /*변동파일생성일자*/
             , RLS_FILE_CRT_DT         /*해제파일생성일자*/
             , BF_RLS_DT               /*이전해제일자*/
             , RLS_DT                  /*해제일자*/
             , DL_DT                   /*삭제일자*/
             , CLCTAM_OG_TP_CD         /*집금조직유형코드*/
             , CLCTAM_PRTNR_NO         /*집금파트너번호*/
             , NICE_FW_EXCD_YN         /*나이스발송제외여부*/
             , NOTY_FW_OJ_YN           /*알림발송대상여부*/
             , NOTY_TRS_DT             /*알림전송일자*/
             , NOTY_RCV_DT             /*알림수신일자*/
             , NOTY_RCV_YN             /*알림수신여부*/
             , NOTAK_RS_CD             /*알림톡결과코드*/
             , SMS_FW_RCV_STAT_CD      /*SMS발송수신상태코드*/
             , DTA_DL_YN               /*데이터삭제여부*/
		<include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ /*T:WELLS렌탈CB연체내역*/
         WHERE 1 = 1
           AND CST_NO = #{cstNo}
           AND OC_CRT_DT LIKE #{baseYm}||'%'
    </insert>

    <update id="updateMessageSendDate">
        /* 렌탈CB 연체정보 조회 - 알림톡 전송일자 갱신 */
        UPDATE TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ A /*T:WELLS렌탈CB연체내역*/
           SET A.NOTY_TRS_DT = TO_CHAR(SYSDATE,'YYYYMMDD')
        <include refid="COMMON.updateSystemField"/>
           WHERE 1 = 1
           AND A.CST_NO = #{cstNo}
           AND A.OC_CRT_DT LIKE #{baseYm}||'%'
           AND A.NOTY_FW_OJ_YN = 'Y'
           AND A.DTA_DL_YN = 'N'
           AND NOT EXISTS (SELECT 1
                             FROM TB_CBBO_BND_CNTC_EXCD_OJ_IZ /*T:채권접촉제외대상내역*/
                            WHERE CST_NO = A.CST_NO
                              AND CTNT_EXCD_BND_BIZ_CD = '02'           /*연락제외채권업무코드-02:렌탈CB*/
                              AND TO_CHAR(SYSDATE,'YYYYMMDD') BETWEEN APY_STRTDT AND APY_ENDDT /*적용시작일자~종료일자*/
                              AND DTA_DL_YN = 'N')
    </update>
</mapper>
