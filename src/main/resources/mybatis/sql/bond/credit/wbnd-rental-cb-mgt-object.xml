<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.bond.credit.mapper.WbndRentalCbMgtObjectMapper">
    <select id="selectRentalCbMessageObjectsByCustomer" resultType="com.kyowon.sms.wells.web.bond.credit.dvo.WbndRentalCbDelinquentIzDvo">
        /* 렌탈CB 연체정보 조회 (고객번호별) */
        SELECT
            A.CST_NO,
            A.CST_KNM,
            A.COPN_DV_CD,
            A.COPN_DV_NM,
            A.SELL_TP_CD,
            A.SELL_TP_NM,
            A.CRAL_LOCARA_TNO,
            A.MEXNO_ENCR,
            A.CRAL_IDV_TNO,
            A.DLQ_AMT,
            A.DLQ_BLAM,
            A.CLCTAM_PRTNR_NO,
            A.PRTNR_KNM,
            A.DSPH_TNO,
            A.RGST_SCH_DT
        FROM (
            SELECT
                DISTINCT N1.CST_NO, /*고객번호*/
                C1.CST_KNM, /*고객명*/
                T1.COPN_DV_CD, /*법인격구분코드*/
                F_CMZ_CD_NM('TNT_WELLS', 'COPN_DV_CD', T1.COPN_DV_CD) AS COPN_DV_NM, /*법인격구분명*/
                T2.SELL_TP_CD, /*상품구분코드*/
                F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T2.SELL_TP_CD) AS SELL_TP_NM, /*상품구분명*/
                C1.CRAL_LOCARA_TNO,
                C1.MEXNO_ENCR,
                C1.CRAL_IDV_TNO,
                SUM(D1.EOT_DLQ_AMT
                    + D1.EOT_DLQ_ADD_AMT
                    - D1.THM_OC_DLQ_AMT
                    - D1.THM_OC_DLQ_ADD_AMT
                    + D1.THM_DLQ_DP_SUM_AMT
                    + D1.THM_DLQ_ADD_DP_SUM_AMT
                    + D1.THM_CTR_DLQ_ADD_AMT
                    - D1.THM_DLQ_RFND_SUM_AMT
                    - D1.THM_DLQ_ADD_RFND_SUM_AMT
                    + NVL(Q2.EOT_BOR_AMT, 0)
                    + (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
                ) OVER(PARTITION BY N1.CST_NO) AS DLQ_AMT, /*연체금액*/
                SUM(D1.EOT_DLQ_AMT /*기말연체금액*/
                    + D1.EOT_DLQ_ADD_AMT /*기말연체가산금액*/
                    + NVL(Q2.EOT_BOR_AMT, 0) /*기말위약금액*/
                    - (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
                ) OVER(PARTITION BY N1.CST_NO) AS DLQ_BLAM, /*연체잔액*/
                N1.CLCTAM_PRTNR_NO, /*집금담당자번호*/
                N2.PRTNR_KNM, /*집금담당자명*/
                '1588-4113' AS DSPH_TNO, /*발신번호*/
                TO_CHAR(TO_DATE(Z3.FWBOO_DTM,'YYYYMMDD') + 8,'YYYYMMDD') AS RGST_SCH_DT /*등록예정일자-알림톡발송일자 +8일*/
            FROM
                TB_CBCL_DLQ_BAS D1 /*연체기본*/
                INNER JOIN TB_CBBO_BND_CNTR_BAS N1 /*채권계약기본*/
                    ON N1.BASE_YM = #{baseYm}
                    AND D1.CNTR_NO = N1.CNTR_NO
                    AND D1.CNTR_SN = N1.CNTR_SN
                    AND N1.BND_CLCTN_PRP_RSON_CD IN ('20', '3C', '80')
                INNER JOIN TB_CBBO_CLCTAM_PRTNR_DTL N2 /*집금파트너상세*/
                    ON N1.CLCTAM_PRTNR_NO = N2.PRTNR_NO
                INNER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ S1 /* WELLS매출월마감내역 */
                    ON N1.BASE_YM = S1.SL_CL_YM
                    AND N1.CNTR_NO = S1.CNTR_NO
                    AND N1.CNTR_SN = S1.CNTR_SN
                    AND S1.SELL_TP_CD = '2' /*렌탈리스*/
                    AND S1.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
                INNER JOIN TB_SSCT_CNTR_BAS T1 /*계약기본*/
                    ON N1.CNTR_NO = T1.CNTR_NO
                    AND T1.CNTR_CNFM_DTM >= '20200901'
                    AND N1.CST_NO = T1.CNTR_CST_NO
                    AND T1.DTA_DL_YN = 'N'
                INNER JOIN TB_SSCT_CNTR_DTL T2 /* 계약상세 */
                    ON D1.CNTR_NO = T2.CNTR_NO
                    AND D1.CNTR_SN = T2.CNTR_SN
                    AND T2.DTA_DL_YN = 'N'
                    AND T2.SELL_TP_CD = '2' /*렌탈리스*/
                    AND T2.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
                INNER JOIN TB_SSCT_CNTR_STLM_REL T3 /*계약결제관계*/
                    ON D1.CNTR_NO = T3.DTL_CNTR_NO
                    AND D1.CNTR_SN = T3.DTL_CNTR_SN
                    AND T3.DTA_DL_YN = 'N'
                    AND S1.SL_CL_YM BETWEEN SUBSTR(T3.VL_STRT_DTM, 1, 6) AND SUBSTR(T3.VL_END_DTM, 1, 6)
                INNER JOIN TB_SSCT_CNTR_STLM_BAS T4 /*계약결제기본*/
                    ON T3.CNTR_STLM_ID = T4.CNTR_STLM_ID
                    AND T4.DTA_DL_YN = 'N'
                    AND T4.DP_TP_CD IN ('0102','0203') /*계좌자동이체, 카드자동이체*/
                INNER JOIN TB_CUBS_CST_BAS C1 /*고객기본*/
                    ON N1.CST_NO = C1.CST_NO
                INNER JOIN TB_PDBS_PD_BAS P1 /*상품기본*/
                    ON T2.BASE_PD_CD = P1.PD_CD
                    AND P1.DTA_DL_YN = 'N'
                INNER JOIN TB_PDBS_PD_CLSF_BAS P2 /*상품분류*/
                    ON P1.PD_CLSF_ID = P2.PD_CLSF_ID
                LEFT JOIN TB_CBCL_WELLS_BOR_AMT_BAS Q2 /* WELLS위약금액기본 */
                    ON N1.BASE_YM = Q2.PERF_YM
                    AND N1.CNTR_NO = Q2.CNTR_NO
                    AND N1.CNTR_SN = Q2.CNTR_SN
                    AND Q2.DTA_DL_YN = 'N'
                LEFT JOIN TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ X1 /*WELLS렌탈CB연체내역*/
                    ON N1.CNTR_NO = X1.CNTR_NO
                    AND N1.CST_NO = X1.CST_NO
                    AND X1.DTA_DL_YN = 'N'
                LEFT JOIN TB_CBBO_BND_MSG_RELY_IZ Z3 /* 채권메시지중계내역 */
                    ON N1.CNTR_NO = Z3.CNTR_NO
                    AND N1.CNTR_SN = Z3.CNTR_SN
                    AND Z3.FW_BIZ_NM = 'BN_KAKAO_MESSAGE' /*발송업무명*/
                    AND Z3.MSG_FW_TP_CD = '01' /*메시지발송유형코드-01:카카오알림톡*/
                    AND Z3.BND_MSG_TP_VAL1 = 'B' /*채권알림톡업무코드-B:등록관련*/
                    AND Z3.BND_MSG_TP_VAL2 = 'B05' /*채권알림톡업무상세코드-B05:렌탈CB연체정보등록 예고*/
                    AND N1.CST_NO = Z3.CST_NO
                    AND Z3.DTA_DL_YN = 'N'
            WHERE 1 = 1
            <if test="@MybatisUtils@isNotEmpty(cstNo)">
                AND N1.CST_NO = #{cstNo}                /*고객번호*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
                AND C1.CRAL_LOCARA_TNO = #{cralLocaraTno} /*휴대폰번호1*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(mexnoEncr)">
                AND C1.MEXNO_ENCR = #{mexnoEncr}          /*휴대폰번호2-입력된값을 암호화하여 대입*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(cralIdvTno)">
                AND C1.CRAL_IDV_TNO = #{cralIdvTno}       /*휴대폰번호3*/
            </if>
                AND D1.PERF_YM = #{baseYm}
                AND D1.DLQ_MCN >= 0
                AND D1.EOT_DLQ_AMT + D1.EOT_DLQ_ADD_AMT > 0
                AND D1.DTA_DL_YN = 'N'
                AND NOT EXISTS (SELECT 1 FROM TB_CBBO_BND_CNTC_EXCD_OJ_IZ X1
                                WHERE N1.CST_NO = X1.CST_NO
                                AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN X1.APY_STRTDT AND X1.APY_ENDDT
                                AND X1.CTNT_EXCD_BND_BIZ_CD = '02'
                                AND X1.DTA_DL_YN = 'N')
                AND NOT EXISTS (SELECT 1 FROM TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ X1
                                WHERE N1.CST_NO = X1.CST_NO
                                AND X1.RENTAL_CB_RGST_DV_CD IN ('1','3')
                                AND X1.NOTY_RCV_YN = 'Y'
                                AND X1.DTA_DL_YN = 'N')
            ) A
            WHERE
                A.DLQ_BLAM >= 100000
    </select>

    <select id="selectRentalCbMessageObjectsByContract" resultType="com.kyowon.sms.wells.web.bond.credit.dvo.WbndRentalCbDelinquentIzDvo">
        /* 렌탈CB 연체정보 조회 (계약별) */
        WITH RENTAL_CB AS (
            SELECT N1.CST_NO
            FROM TB_CBCL_DLQ_BAS D1    /*연체기본*/
            INNER JOIN TB_CBBO_BND_CNTR_BAS N1 /*채권계약기본*/
                ON N1.BASE_YM = #{baseYm}
                AND D1.CNTR_NO = N1.CNTR_NO
                AND D1.CNTR_SN = N1.CNTR_SN
                AND N1.BND_CLCTN_PRP_RSON_CD IN ('20', '3C', '80')
            INNER JOIN TB_CBBO_CLCTAM_PRTNR_DTL N2 /*집금파트너상세*/
                ON N1.CLCTAM_PRTNR_NO = N2.PRTNR_NO
            INNER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ S1 /* WELLS매출월마감내역 */
                ON N1.BASE_YM = S1.SL_CL_YM
                AND N1.CNTR_NO = S1.CNTR_NO
                AND N1.CNTR_SN = S1.CNTR_SN
                AND S1.SELL_TP_CD = '2' /*렌탈리스*/
                AND S1.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
            INNER JOIN TB_SSCT_CNTR_BAS T1 /*계약기본*/
                ON N1.CNTR_NO = T1.CNTR_NO
                AND T1.CNTR_CNFM_DTM >= '20200901'
                AND N1.CST_NO = T1.CNTR_CST_NO
                AND T1.DTA_DL_YN = 'N'
            INNER JOIN TB_SSCT_CNTR_DTL T2  /* 계약상세 */
                ON D1.CNTR_NO = T2.CNTR_NO
                AND D1.CNTR_SN = T2.CNTR_SN
                AND T2.DTA_DL_YN = 'N'
                AND T2.SELL_TP_CD = '2' /*렌탈리스*/
                AND T2.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
            INNER JOIN TB_SSCT_CNTR_STLM_REL T3 /*계약결제관계*/
                ON D1.CNTR_NO = T3.DTL_CNTR_NO
                AND D1.CNTR_SN = T3.DTL_CNTR_SN
                AND T3.DTA_DL_YN = 'N'
                AND S1.SL_CL_YM BETWEEN SUBSTR(T3.VL_STRT_DTM, 1, 6) AND SUBSTR(T3.VL_END_DTM, 1, 6)
            INNER JOIN TB_SSCT_CNTR_STLM_BAS T4 /*계약결제기본*/
                ON T3.CNTR_STLM_ID = T4.CNTR_STLM_ID
                AND T4.DTA_DL_YN = 'N'
                AND T4.DP_TP_CD IN ('0102','0203') /*계좌자동이체, 카드자동이체*/
            LEFT JOIN TB_CBCL_WELLS_BOR_AMT_BAS Q2   /* WELLS위약금액기본 */
                ON N1.BASE_YM = Q2.PERF_YM
                AND N1.CNTR_NO = Q2.CNTR_NO
                AND N1.CNTR_SN = Q2.CNTR_SN
                AND Q2.DTA_DL_YN = 'N'
            WHERE 1 = 1
            <if test="@MybatisUtils@isNotEmpty(cstNo)">
                AND N1.CST_NO = #{cstNo}                /*고객번호*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(cralLocaraTno)">
                AND C1.CRAL_LOCARA_TNO = #{cralLocaraTno} /*휴대폰번호1*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(mexnoEncr)">
                AND C1.MEXNO_ENCR = #{mexnoEncr}          /*휴대폰번호2-입력된값을 암호화하여 대입*/
            </if>
            <if test="@MybatisUtils@isNotEmpty(cralIdvTno)">
                AND C1.CRAL_IDV_TNO = #{cralIdvTno}       /*휴대폰번호3*/
            </if>
                AND D1.PERF_YM = #{baseYm}
                AND D1.DLQ_MCN >= 0
                AND D1.EOT_DLQ_AMT + D1.EOT_DLQ_ADD_AMT > 0
                AND D1.DTA_DL_YN = 'N'
                AND NOT EXISTS (SELECT 1 FROM TB_CBBO_BND_CNTC_EXCD_OJ_IZ X1
                                WHERE N1.CST_NO = X1.CST_NO
                                    AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN X1.APY_STRTDT AND X1.APY_ENDDT
                                    AND X1.CTNT_EXCD_BND_BIZ_CD = '02'
                                    AND X1.DTA_DL_YN = 'N')
                AND NOT EXISTS (SELECT 1 FROM TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ X1
                                WHERE N1.CST_NO = X1.CST_NO
                                    AND X1.RENTAL_CB_RGST_DV_CD IN ('1','3')
                                    AND X1.NOTY_RCV_YN = 'Y'
                                    AND X1.DTA_DL_YN = 'N')
            GROUP BY N1.CST_NO
            HAVING SUM(D1.EOT_DLQ_AMT /*기말연체금액*/
                        + D1.EOT_DLQ_ADD_AMT /*기말연체가산금액*/
                        + NVL(Q2.EOT_BOR_AMT, 0) /*기말위약금액*/
                        - (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
                    ) >= 100000
        )
        SELECT
            N1.CST_NO, /*고객번호*/
            D1.CNTR_NO, /*계약번호*/
            D1.CNTR_SN, /*계약일련번호*/
            D1.CNTR_NO || '-' || D1.CNTR_SN AS CNTR_DTL_NO, /*계약상세번호*/
            C1.CST_KNM, /*고객명*/
            T1.COPN_DV_CD, /*법인격구분코드*/
            F_CMZ_CD_NM('TNT_WELLS', 'COPN_DV_CD', T1.COPN_DV_CD) AS COPN_DV_NM, /*법인격구분명*/
            T2.SELL_TP_CD, /*상품구분코드*/
            F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T2.SELL_TP_CD) AS SELL_TP_NM, /*상품구분명*/
            P2.PD_CLSF_NM, /*상품명*/
            S1.SL_RCOG_DT, /*매출일자*/
            C1.CRAL_LOCARA_TNO,
            C1.MEXNO_ENCR,
            C1.CRAL_IDV_TNO,
            T4.MPY_BSDT, /*자동이체약정일자*/
            T4.DP_TP_CD, /*입금유형코드*/
            NVL(F_CMZ_CD_NM('TNT_WELLS', 'DP_TP_CD', T4.DP_TP_CD), '-') AS FNT_DV_NM,
            (D1.EOT_DLQ_AMT
                + D1.EOT_DLQ_ADD_AMT
                - D1.THM_OC_DLQ_AMT
                - D1.THM_OC_DLQ_ADD_AMT
                + D1.THM_DLQ_DP_SUM_AMT
                + D1.THM_DLQ_ADD_DP_SUM_AMT
                + D1.THM_CTR_DLQ_ADD_AMT
                - D1.THM_DLQ_RFND_SUM_AMT
                - D1.THM_DLQ_ADD_RFND_SUM_AMT
                + NVL(Q2.EOT_BOR_AMT, 0)
                + (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
            ) AS DLQ_AMT, /*연체금액*/
            (D1.EOT_DLQ_AMT /*기말연체금액*/
                + D1.EOT_DLQ_ADD_AMT /*기말연체가산금액*/
                + NVL(Q2.EOT_BOR_AMT, 0) /*기말위약금액*/
                - (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
            ) AS DLQ_BLAM, /*연체잔액*/
            N1.CLCTAM_PRTNR_NO, /*집금담당자번호*/
            N2.PRTNR_KNM, /*집금담당자명*/
            '1588-4113' AS DSPH_TNO,              /*발신번호*/
            X1.NOTY_RCV_YN, /*알림발송대상여부*/
            TO_CHAR(TO_DATE(Z3.FWBOO_DTM,'YYYYMMDD') + 8,'YYYYMMDD') AS RGST_SCH_DT, /*등록예정일자-알림톡발송일자 +8일*/
            X1.NICE_FW_EXCD_YN AS NICE_FW_EXCD_YN,  /*NICE발송제외여부*/
            SUBSTR(Z3.FWBOO_DTM, 1, 8) AS FWBOO_DTM,    /*알림톡발송일자*/
            '' AS NOTY_FW_OJ_DT  /*알림톡발송제외일자*/
        FROM
            TB_CBCL_DLQ_BAS D1    /*연체기본*/
            INNER JOIN TB_CBBO_BND_CNTR_BAS N1 /*채권계약기본*/
                ON N1.BASE_YM = #{baseYm}
                AND D1.CNTR_NO = N1.CNTR_NO
                AND D1.CNTR_SN = N1.CNTR_SN
                AND N1.BND_CLCTN_PRP_RSON_CD IN ('20', '3C', '80')
            INNER JOIN TB_CBBO_CLCTAM_PRTNR_DTL N2 /*집금파트너상세*/
                ON N1.CLCTAM_PRTNR_NO = N2.PRTNR_NO
            INNER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ S1 /* WELLS매출월마감내역 */
                ON N1.BASE_YM = S1.SL_CL_YM
                AND N1.CNTR_NO = S1.CNTR_NO
                AND N1.CNTR_SN = S1.CNTR_SN
                AND S1.SELL_TP_CD = '2' /*렌탈리스*/
                AND S1.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
            INNER JOIN TB_SSCT_CNTR_BAS T1 /*계약기본*/
                ON N1.CNTR_NO = T1.CNTR_NO
                AND T1.CNTR_CNFM_DTM >= '20200901'
                AND N1.CST_NO = T1.CNTR_CST_NO
                AND T1.DTA_DL_YN = 'N'
            INNER JOIN TB_SSCT_CNTR_DTL T2  /* 계약상세 */
                ON D1.CNTR_NO = T2.CNTR_NO
                AND D1.CNTR_SN = T2.CNTR_SN
                AND T2.DTA_DL_YN = 'N'
                AND T2.SELL_TP_CD = '2' /*렌탈리스*/
                AND T2.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
            INNER JOIN TB_SSCT_CNTR_STLM_REL T3 /*계약결제관계*/
                ON D1.CNTR_NO = T3.DTL_CNTR_NO
                AND D1.CNTR_SN = T3.DTL_CNTR_SN
                AND T3.DTA_DL_YN = 'N'
                AND S1.SL_CL_YM BETWEEN SUBSTR(T3.VL_STRT_DTM, 1, 6) AND SUBSTR(T3.VL_END_DTM, 1, 6)
            INNER JOIN TB_SSCT_CNTR_STLM_BAS T4 /*계약결제기본*/
                ON T3.CNTR_STLM_ID = T4.CNTR_STLM_ID
                AND T4.DTA_DL_YN = 'N'
                AND T4.DP_TP_CD IN ('0102','0203') /*계좌자동이체, 카드자동이체*/
            INNER JOIN TB_CUBS_CST_BAS C1 /*고객기본*/
                ON N1.CST_NO = C1.CST_NO
            INNER JOIN TB_PDBS_PD_BAS P1 /*상품기본*/
                ON T2.BASE_PD_CD = P1.PD_CD
                AND P1.DTA_DL_YN = 'N'
            INNER JOIN TB_PDBS_PD_CLSF_BAS P2 /*상품분류*/
                ON P1.PD_CLSF_ID = P2.PD_CLSF_ID
            LEFT JOIN TB_CBCL_WELLS_BOR_AMT_BAS Q2   /* WELLS위약금액기본 */
                ON N1.BASE_YM = Q2.PERF_YM
                AND N1.CNTR_NO = Q2.CNTR_NO
                AND N1.CNTR_SN = Q2.CNTR_SN
                AND Q2.DTA_DL_YN = 'N'
            LEFT JOIN TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ X1 /*WELLS렌탈CB연체내역*/
                ON N1.CNTR_NO = X1.CNTR_NO
                AND N1.CST_NO = X1.CST_NO
                AND X1.DTA_DL_YN = 'N'
            LEFT JOIN TB_CBBO_BND_MSG_RELY_IZ Z3  /* 채권메시지중계내역 */
                ON N1.CNTR_NO = Z3.CNTR_NO
                AND N1.CNTR_SN = Z3.CNTR_SN
                AND Z3.FW_BIZ_NM = 'BN_KAKAO_MESSAGE' /*발송업무명*/
                AND Z3.MSG_FW_TP_CD = '01' /*메시지발송유형코드-01:카카오알림톡*/
                AND Z3.BND_MSG_TP_VAL1 = 'B' /*채권알림톡업무코드-B:등록관련*/
                AND Z3.BND_MSG_TP_VAL2 = 'B05' /*채권알림톡업무상세코드-B05:렌탈CB연체정보등록 예고*/
                AND N1.CST_NO = Z3.CST_NO
                AND Z3.DTA_DL_YN = 'N'
        WHERE 1 = 1
            AND D1.PERF_YM = #{baseYm}
            AND D1.DLQ_MCN >= 0
            AND D1.EOT_DLQ_AMT + D1.EOT_DLQ_ADD_AMT > 0
            AND D1.DTA_DL_YN = 'N'
            AND (D1.EOT_DLQ_AMT /*기말연체금액*/
                + D1.EOT_DLQ_ADD_AMT /*기말연체가산금액*/
                + NVL(Q2.EOT_BOR_AMT, 0) /*기말위약금액*/
                + (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
            ) > 0
            AND N1.CST_NO IN (SELECT CST_NO FROM RENTAL_CB)
        ORDER BY D1.CNTR_NO DESC, N1.BASE_YM DESC
    </select>

    <update id="updateMessageObjectYn" >
        /* 렌탈CB 연체정보 조회 - 저장(알림톡 대상 선정) */
        MERGE INTO TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ MRG_CB    /*WELLS렌탈CB연체내역*/
        USING (WITH RENTAL_CB AS (
            SELECT N1.CST_NO
            FROM TB_CBCL_DLQ_BAS D1    /*연체기본*/
            INNER JOIN TB_CBBO_BND_CNTR_BAS N1 /*채권계약기본*/
                ON N1.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
                AND D1.CNTR_NO = N1.CNTR_NO
                AND D1.CNTR_SN = N1.CNTR_SN
                AND N1.BND_CLCTN_PRP_RSON_CD IN ('20', '3C', '80')
            INNER JOIN TB_CBBO_CLCTAM_PRTNR_DTL N2 /*집금파트너상세*/
                ON N1.CLCTAM_PRTNR_NO = N2.PRTNR_NO
            INNER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ S1 /* WELLS매출월마감내역 */
                ON N1.BASE_YM = S1.SL_CL_YM
                AND N1.CNTR_NO = S1.CNTR_NO
                AND N1.CNTR_SN = S1.CNTR_SN
                AND S1.SELL_TP_CD = '2' /*렌탈리스*/
                AND S1.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
            INNER JOIN TB_SSCT_CNTR_BAS T1 /*계약기본*/
                ON N1.CNTR_NO = T1.CNTR_NO
                AND T1.CNTR_CNFM_DTM >= '20200901'
                AND N1.CST_NO = T1.CNTR_CST_NO
                AND T1.DTA_DL_YN = 'N'
            INNER JOIN TB_SSCT_CNTR_DTL T2  /* 계약상세 */
                ON D1.CNTR_NO = T2.CNTR_NO
                AND D1.CNTR_SN = T2.CNTR_SN
                AND T2.DTA_DL_YN = 'N'
                AND T2.SELL_TP_CD = '2' /*렌탈리스*/
                AND T2.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
            INNER JOIN TB_SSCT_CNTR_STLM_REL T3 /*계약결제관계*/
                ON D1.CNTR_NO = T3.DTL_CNTR_NO
                AND D1.CNTR_SN = T3.DTL_CNTR_SN
                AND T3.DTA_DL_YN = 'N'
                AND S1.SL_CL_YM BETWEEN SUBSTR(T3.VL_STRT_DTM, 1, 6) AND SUBSTR(T3.VL_END_DTM, 1, 6)
            INNER JOIN TB_SSCT_CNTR_STLM_BAS T4 /*계약결제기본*/
                ON T3.CNTR_STLM_ID = T4.CNTR_STLM_ID
                AND T4.DTA_DL_YN = 'N'
                AND T4.DP_TP_CD IN ('0102','0203') /*계좌자동이체, 카드자동이체*/
            LEFT JOIN TB_CBCL_WELLS_BOR_AMT_BAS Q2   /* WELLS위약금액기본 */
                ON N1.BASE_YM = Q2.PERF_YM
                AND N1.CNTR_NO = Q2.CNTR_NO
                AND N1.CNTR_SN = Q2.CNTR_SN
                AND Q2.DTA_DL_YN = 'N'
            WHERE 1 = 1
                AND D1.PERF_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                AND D1.DLQ_MCN >= 0
                AND D1.EOT_DLQ_AMT + D1.EOT_DLQ_ADD_AMT > 0
                AND D1.DTA_DL_YN = 'N'
                AND NOT EXISTS (SELECT 1 FROM TB_CBBO_BND_CNTC_EXCD_OJ_IZ X1
                                WHERE N1.CST_NO = X1.CST_NO
                                    AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN X1.APY_STRTDT AND X1.APY_ENDDT
                                    AND X1.CTNT_EXCD_BND_BIZ_CD = '02'
                                    AND X1.DTA_DL_YN = 'N')
                AND NOT EXISTS (SELECT 1 FROM TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ X1
                                WHERE N1.CST_NO = X1.CST_NO
                                    AND X1.RENTAL_CB_RGST_DV_CD IN ('1','3')
                                    AND X1.NOTY_RCV_YN = 'Y'
                                    AND X1.DTA_DL_YN = 'N')
            GROUP BY N1.CST_NO
            HAVING SUM(D1.EOT_DLQ_AMT /*기말연체금액*/
                        + D1.EOT_DLQ_ADD_AMT /*기말연체가산금액*/
                        + NVL(Q2.EOT_BOR_AMT, 0) /*기말위약금액*/
                        - (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
                    ) >= 100000
        )
        SELECT
            N1.CST_NO, /*고객번호*/
            C1.CST_KNM, /*고객명*/
            D1.CNTR_NO, /*계약번호*/
            C1.CRAL_LOCARA_TNO,
            C1.MEXNO_ENCR,
            C1.CRAL_IDV_TNO,
            (D1.EOT_DLQ_AMT
                + D1.EOT_DLQ_ADD_AMT
                - D1.THM_OC_DLQ_AMT
                - D1.THM_OC_DLQ_ADD_AMT
                + D1.THM_DLQ_DP_SUM_AMT
                + D1.THM_DLQ_ADD_DP_SUM_AMT
                + D1.THM_CTR_DLQ_ADD_AMT
                - D1.THM_DLQ_RFND_SUM_AMT
                - D1.THM_DLQ_ADD_RFND_SUM_AMT
                + NVL(Q2.EOT_BOR_AMT, 0)
                + (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
            ) AS DLQ_AMT, /*연체금액*/
            (D1.EOT_DLQ_AMT /*기말연체금액*/
                + D1.EOT_DLQ_ADD_AMT /*기말연체가산금액*/
                + NVL(Q2.EOT_BOR_AMT, 0) /*기말위약금액*/
                - (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
            ) AS DLQ_BLAM, /*연체잔액*/
            N1.CLCTAM_PRTNR_NO, /*집금담당자번호*/
            (CASE WHEN TO_CHAR(ADD_MONTHS(TO_DATE(D1.PERF_YM, 'YYYYMM'), 1), 'YYYYMM') = TO_CHAR(SYSDATE, 'YYYYMM')
                  THEN TO_CHAR(SYSDATE, 'YYYYMM') || '01'
                  ELSE D1.PERF_YM || T4.MPY_BSDT END
            ) AS OC_BSDT, /*발생일자-MPY_BSDT 납부기준일자*/
            X1.RENTAL_CB_RGST_DV_CD
        FROM
            TB_CBCL_DLQ_BAS D1    /*연체기본*/
            INNER JOIN TB_CBBO_BND_CNTR_BAS N1 /*채권계약기본*/
                ON N1.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                AND D1.CNTR_NO = N1.CNTR_NO
                AND D1.CNTR_SN = N1.CNTR_SN
                AND N1.BND_CLCTN_PRP_RSON_CD IN ('20', '3C', '80')
            INNER JOIN TB_CBBO_CLCTAM_PRTNR_DTL N2 /*집금파트너상세*/
                ON N1.CLCTAM_PRTNR_NO = N2.PRTNR_NO
            INNER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ S1 /* WELLS매출월마감내역 */
                ON N1.BASE_YM = S1.SL_CL_YM
                AND N1.CNTR_NO = S1.CNTR_NO
                AND N1.CNTR_SN = S1.CNTR_SN
                AND S1.SELL_TP_CD = '2' /*렌탈리스*/
                AND S1.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
            INNER JOIN TB_SSCT_CNTR_BAS T1 /*계약기본*/
                ON N1.CNTR_NO = T1.CNTR_NO
                AND T1.CNTR_CNFM_DTM >= '20200901'
                AND N1.CST_NO = T1.CNTR_CST_NO
                AND T1.DTA_DL_YN = 'N'
            INNER JOIN TB_SSCT_CNTR_DTL T2  /* 계약상세 */
                ON D1.CNTR_NO = T2.CNTR_NO
                AND D1.CNTR_SN = T2.CNTR_SN
                AND T2.DTA_DL_YN = 'N'
                AND T2.SELL_TP_CD = '2' /*렌탈리스*/
                AND T2.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
            INNER JOIN TB_SSCT_CNTR_STLM_REL T3 /*계약결제관계*/
                ON D1.CNTR_NO = T3.DTL_CNTR_NO
                AND D1.CNTR_SN = T3.DTL_CNTR_SN
                AND T3.DTA_DL_YN = 'N'
                AND S1.SL_CL_YM BETWEEN SUBSTR(T3.VL_STRT_DTM, 1, 6) AND SUBSTR(T3.VL_END_DTM, 1, 6)
            INNER JOIN TB_SSCT_CNTR_STLM_BAS T4 /*계약결제기본*/
                ON T3.CNTR_STLM_ID = T4.CNTR_STLM_ID
                AND T4.DTA_DL_YN = 'N'
                AND T4.DP_TP_CD IN ('0102','0203') /*계좌자동이체, 카드자동이체*/
            INNER JOIN TB_CUBS_CST_BAS C1 /*고객기본*/
                ON N1.CST_NO = C1.CST_NO
            INNER JOIN TB_PDBS_PD_BAS P1 /*상품기본*/
                ON T2.BASE_PD_CD = P1.PD_CD
                AND P1.DTA_DL_YN = 'N'
            INNER JOIN TB_PDBS_PD_CLSF_BAS P2 /*상품분류*/
                ON P1.PD_CLSF_ID = P2.PD_CLSF_ID
            LEFT JOIN TB_CBCL_WELLS_BOR_AMT_BAS Q2   /* WELLS위약금액기본 */
                ON N1.BASE_YM = Q2.PERF_YM
                AND N1.CNTR_NO = Q2.CNTR_NO
                AND N1.CNTR_SN = Q2.CNTR_SN
                AND Q2.DTA_DL_YN = 'N'
            LEFT JOIN TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ X1 /*WELLS렌탈CB연체내역*/
                ON N1.CNTR_NO = X1.CNTR_NO
                AND N1.CST_NO = X1.CST_NO
                AND X1.DTA_DL_YN = 'N'
            LEFT JOIN TB_CBBO_BND_MSG_RELY_IZ Z3  /* 채권메시지중계내역 */
                ON N1.CNTR_NO = Z3.CNTR_NO
                AND N1.CNTR_SN = Z3.CNTR_SN
                AND Z3.FW_BIZ_NM = 'BN_KAKAO_MESSAGE' /*발송업무명*/
                AND Z3.MSG_FW_TP_CD = '01' /*메시지발송유형코드-01:카카오알림톡*/
                AND Z3.BND_MSG_TP_VAL1 = 'B' /*채권알림톡업무코드-B:등록관련*/
                AND Z3.BND_MSG_TP_VAL2 = 'B05' /*채권알림톡업무상세코드-B05:렌탈CB연체정보등록 예고*/
                AND N1.CST_NO = Z3.CST_NO
                AND Z3.DTA_DL_YN = 'N'
        WHERE 1 = 1
            AND D1.PERF_YM = TO_CHAR(SYSDATE), 'YYYYMM')
            AND D1.DLQ_MCN >= 0
            AND D1.EOT_DLQ_AMT + D1.EOT_DLQ_ADD_AMT > 0
            AND D1.DTA_DL_YN = 'N'
            AND (D1.EOT_DLQ_AMT /*기말연체금액*/
                + D1.EOT_DLQ_ADD_AMT /*기말연체가산금액*/
                + NVL(Q2.EOT_BOR_AMT, 0) /*기말위약금액*/
                - (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
            ) > 0
            AND N1.CST_NO IN (SELECT CST_NO FROM RENTAL_CB)
        ) SRC2
            ON (MRG_CB.CNTR_NO = SRC2.CNTR_NO)
        WHEN NOT MATCHED THEN
            INSERT (
                 MRG_CB.CNTR_NO                 /*계약번호*/
               , MRG_CB.CST_NO                  /*고객번호*/
               , MRG_CB.RENTAL_CB_RGST_DV_CD    /*렌탈DB등록구분코드*/
               , MRG_CB.DLQ_AMT                 /*연체금액*/
               , MRG_CB.DLQ_BLAM                /*연체잔액*/
               , MRG_CB.FST_OC_DT               /*최초발생일자*/
               , MRG_CB.OC_BSDT                 /*발생기준일자*/
               , MRG_CB.OC_CRT_DT               /*발생생성일자*/
               , MRG_CB.OC_FILE_CRT_DT          /*발생파일생성일자*/
               , MRG_CB.CHG_FILE_CRT_DT         /*변동파일생성일자*/
               , MRG_CB.RLS_FILE_CRT_DT         /*해제파일생성일자*/
               , MRG_CB.BF_RLS_DT               /*이전해제일자*/
               , MRG_CB.RLS_DT                  /*해제일자*/
               , MRG_CB.DL_DT                   /*삭제일자*/
               , MRG_CB.CLCTAM_OG_TP_CD         /*집금조직유형코드*/
               , MRG_CB.CLCTAM_PRTNR_NO         /*집금파트너번호*/
               , MRG_CB.NOTY_FW_OJ_YN           /*알림톡발송대상여부*/
               <include refid="COMMON.insertSystemField"/>
            ) VALUES (
                 SRC2.CNTR_NO                    /*계약번호*/
               , SRC2.CST_NO                     /*고객번호*/
               , '1'                            /*렌탈DB등록구분코드*/
               , SRC2.DLQ_AMT                    /*연체금액*/
               , SRC2.DLQ_BLAM                   /*연체잔액*/
               , SRC2.OC_BSDT                    /*최초발생일자*/
               , SRC2.OC_BSDT                    /*발생기준일자*/
               , TO_CHAR(SYSDATE,'YYYYMMDD')    /*발생생성일자*/
               , ''                             /*발생파일생성일자*/
               , ''                             /*변동파일생성일자*/
               , ''                             /*해제파일생성일자*/
               , ''                             /*이전해제일자*/
               , ''                             /*해제일자*/
               , ''                             /*삭제일자*/
               , ''                             /*집금조직유형코드*/
               , SRC2.CLCTAM_PRTNR_NO            /*집금파트너번호*/
               , 'Y'                            /*알림톡발송대상여부*/
               <include refid="COMMON.insertSystemFieldValue"/>
            )
    </update>

    <insert id="insertMessageObjectHist" >
        /* 렌탈CB 연체정보 조회 - 저장(이력) */
        INSERT INTO TB_CBBO_RENTAL_CB_DLQ_HIST ( /*T:렌탈CB연체이력*/
               CNTR_NO                 /*계약번호*/
             , HIST_CH_DTM             /*이력변경일시*/
             , CST_NO                  /*고객번호*/
             , RENTAL_CB_RGST_DV_CD    /*렌탈CB등록구분코드*/
             , DLQ_AMT                 /*연체금액*/
             , DLQ_BLAM                /*연체잔액*/
             , FST_OC_DT               /*최초발생일자*/
             , OC_BSDT                 /*발생기준일자*/
             , OC_CRT_DT               /*발생생성일자*/
             , OC_FILE_CRT_DT          /*발생파일생성일자*/
             , CHG_FILE_CRT_DT         /*변동파일생성일자*/
             , RLS_FILE_CRT_DT         /*해제파일생성일자*/
             , BF_RLS_DT               /*이전해제일자*/
             , RLS_DT                  /*해제일자*/
             , DL_DT                   /*삭제일자*/
             , CLCTAM_OG_TP_CD         /*집금조직유형코드*/
             , CLCTAM_PRTNR_NO         /*집금파트너번호*/
             , NICE_FW_EXCD_YN         /*나이스발송제외여부*/
             , NOTY_FW_OJ_YN           /*알림발송대상여부*/
             , NOTY_TRS_DT             /*알림전송일자*/
             , NOTY_RCV_DT             /*알림수신일자*/
             , NOTY_RCV_YN             /*알림수신여부*/
             , NOTAK_RS_CD             /*알림톡결과코드*/
             , SMS_FW_RCV_STAT_CD      /*SMS발송수신상태코드*/
             , DTA_DL_YN               /*데이터삭제여부*/
        <include refid="COMMON.insertSystemField"/>
        )
        SELECT CNTR_NO                 /*계약번호*/
             , TO_CHAR(SYSDATE,'YYYYMMDDHH24MMSS')
             , CST_NO                  /*고객번호*/
             , RENTAL_CB_RGST_DV_CD    /*렌탈CB등록구분코드*/
             , DLQ_AMT                 /*연체금액*/
             , DLQ_BLAM                /*연체잔액*/
             , FST_OC_DT               /*최초발생일자*/
             , OC_BSDT                 /*발생기준일자*/
             , OC_CRT_DT               /*발생생성일자*/
             , OC_FILE_CRT_DT          /*발생파일생성일자*/
             , CHG_FILE_CRT_DT         /*변동파일생성일자*/
             , RLS_FILE_CRT_DT         /*해제파일생성일자*/
             , BF_RLS_DT               /*이전해제일자*/
             , RLS_DT                  /*해제일자*/
             , DL_DT                   /*삭제일자*/
             , CLCTAM_OG_TP_CD         /*집금조직유형코드*/
             , CLCTAM_PRTNR_NO         /*집금파트너번호*/
             , NICE_FW_EXCD_YN         /*나이스발송제외여부*/
             , NOTY_FW_OJ_YN           /*알림발송대상여부*/
             , NOTY_TRS_DT             /*알림전송일자*/
             , NOTY_RCV_DT             /*알림수신일자*/
             , NOTY_RCV_YN             /*알림수신여부*/
             , NOTAK_RS_CD             /*알림톡결과코드*/
             , SMS_FW_RCV_STAT_CD      /*SMS발송수신상태코드*/
             , DTA_DL_YN               /*데이터삭제여부*/
        <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ /*T:WELLS렌탈CB연체내역*/
         WHERE 1 = 1
           AND OC_CRT_DT LIKE TO_CHAR(SYSDATE, 'YYYYMM')||'%'
           AND NOTY_FW_OJ_YN = 'Y'
    </insert>

    <select id="selectRentalCbMgtPaymentInfos" resultType="com.kyowon.sms.wells.web.bond.credit.dvo.WbndRentalCbDelinquentIzDvo">
        /* 렌탈CB납입정보(팝업) */
        SELECT
            N1.CST_NO, /*고객번호*/
            D1.CNTR_NO || '-' || D1.CNTR_SN AS CNTR_DTL_NO, /*계약상세번호*/
            C1.CST_KNM, /*고객명*/
            F_CMZ_CD_NM('TNT_WELLS', 'COPN_DV_CD', T1.COPN_DV_CD) AS COPN_DV_NM, /*법인격구분명*/
            F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T2.SELL_TP_CD) AS SELL_TP_NM, /*상품구분명*/
            P2.PD_CLSF_NM, /*상품명*/
            S1.SL_RCOG_DT, /*매출일자*/
            C1.CRAL_LOCARA_TNO,
            C1.MEXNO_ENCR,
            C1.CRAL_IDV_TNO,
            NVL(R1.DP_DT, '-') AS DP_DT, /*입금일자*/
            NVL(F_CMZ_CD_NM('TNT_WELLS', 'DP_TP_CD', T4.DP_TP_CD), '-') AS FNT_DV_NM,
            (D1.EOT_DLQ_AMT
                + D1.EOT_DLQ_ADD_AMT
                - D1.THM_OC_DLQ_AMT
                - D1.THM_OC_DLQ_ADD_AMT
                + D1.THM_DLQ_DP_SUM_AMT
                + D1.THM_DLQ_ADD_DP_SUM_AMT
                + D1.THM_CTR_DLQ_ADD_AMT
                - D1.THM_DLQ_RFND_SUM_AMT
                - D1.THM_DLQ_ADD_RFND_SUM_AMT
                + NVL(Q2.EOT_BOR_AMT, 0)   /*기말위약금액*/
                + (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
            ) AS DLQ_AMT, /*연체금액*/
            (NVL((CASE WHEN R1.DP_DV_CD IN ('1','3') THEN NVL(R1.DP_AMT, 0) ELSE 0 END), 0)  /*입금금액*/
                - NVL((CASE WHEN R1.DP_DV_CD IN ('2','4') THEN NVL(R1.DP_AMT, 0) ELSE 0 END), 0) /*환불금액*/
                + NVL(Q2.EOT_BOR_AMT, 0) /*기말위약금액*/
                + (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
            ) AS TOTAL_DP_AMT, /*연체입금금액*/
            (D1.EOT_DLQ_AMT /*기말연체금액*/
                + D1.EOT_DLQ_ADD_AMT /*기말연체가산금액*/
                + NVL(Q2.EOT_BOR_AMT, 0) /*기말위약금액*/
                - (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
            ) AS DLQ_BLAM, /*연체잔액*/
            N2.PRTNR_KNM, /*집금담당자명*/
            '1588-4113' AS DSPH_TNO,              /*발신번호*/
            TO_CHAR(TO_DATE(Z3.FWBOO_DTM,'YYYYMMDD') + 8,'YYYYMMDD') AS RGST_SCH_DT, /*등록예정일자-알림톡발송일자 +8일*/
            X1.NICE_FW_EXCD_YN AS NICE_FW_EXCD_YN,  /*NICE발송제외여부*/
            SUBSTR(Z3.FWBOO_DTM, 1, 8) AS FWBOO_DTM,    /*알림톡발송일자*/
            (SELECT (CASE WHEN X9.RESULT = '1000' THEN 'Y' ELSE 'N' END)
                FROM TB_CBBO_BND_MSG_RELY_IZ X7  /* 채권메시지중계내역 */
                INNER JOIN ATA_MMT_TRAN X8  /* 전송테이블 */
                    ON X8.RESERVED2 = X7.BND_MSG_RELY_ID  /*채권메시지중계ID*/
                    AND X8.RESERVED3 = X7.FW_BIZ_NM        /*발송업무명*/
                    AND X8.RESERVED4 = X7.BND_MSG_TP_VAL1  /*채권알림톡업무코드*/
                    AND X8.RESERVED5 = X7.BND_MSG_TP_VAL2  /*채권알림톡업무상세코드*/
                    AND X8.TEMPLATE_CODE = 'wells18153'  /* 템플릿코드 */
                INNER JOIN ATA_MMT_LOG X9  /* 로그테이블 */
                    ON X9.MT_PR = X8.MT_PR
                WHERE X7.DTA_DL_YN = 'N'
                    AND X7.FW_BIZ_NM = 'BN_KAKAO_MESSAGE'  /* 발송업무명 */
                    AND X7.MSG_FW_TP_CD = '01'  /* 메시지발송유형코드-01:카카오알림톡 */
                    AND X7.BND_MSG_TP_VAL1 = 'B'  /* 채권알림톡업무코드-B:등록관련 */
                    AND X7.BND_MSG_TP_VAL2 = 'B05'  /* 채권알림톡업무상세코드-B05:렌탈CB연체정보등록 예고 */
                    AND X7.CST_NO = N1.CST_NO
                ORDER BY X9.MT_SEQ DESC
                FETCH FIRST 1 ROWS ONLY
            ) AS RESULT_YN, /*알림톡성공여부*/
            '' AS NOTY_FW_OJ_DT  /*알림톡발송제외일자*/
        FROM
            TB_CBCL_DLQ_BAS D1    /*연체기본*/
            INNER JOIN TB_CBBO_BND_CNTR_BAS N1 /*채권계약기본*/
                ON N1.BASE_YM = #{baseYm}
                AND D1.CNTR_NO = N1.CNTR_NO
                AND D1.CNTR_SN = N1.CNTR_SN
                AND N1.BND_CLCTN_PRP_RSON_CD IN ('20', '3C', '80')
            INNER JOIN TB_CBBO_CLCTAM_PRTNR_DTL N2 /*집금파트너상세*/
                ON N1.CLCTAM_PRTNR_NO = N2.PRTNR_NO
            INNER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ S1 /* WELLS매출월마감내역 */
                ON N1.BASE_YM = S1.SL_CL_YM
                AND N1.CNTR_NO = S1.CNTR_NO
                AND N1.CNTR_SN = S1.CNTR_SN
                AND S1.SELL_TP_CD = '2' /*렌탈리스*/
                AND S1.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
            INNER JOIN TB_SSCT_CNTR_BAS T1 /*계약기본*/
                ON N1.CNTR_NO = T1.CNTR_NO
                AND T1.CNTR_CNFM_DTM >= '20200901'
                AND N1.CST_NO = T1.CNTR_CST_NO
                AND T1.DTA_DL_YN = 'N'
            INNER JOIN TB_SSCT_CNTR_DTL T2  /* 계약상세 */
                ON D1.CNTR_NO = T2.CNTR_NO
                AND D1.CNTR_SN = T2.CNTR_SN
                AND T2.DTA_DL_YN = 'N'
                AND T2.SELL_TP_CD = '2' /*렌탈리스*/
                AND T2.SELL_TP_DTL_CD IN ('22', '24', '25') /*판매유형상세코드-리스*/
            INNER JOIN TB_SSCT_CNTR_STLM_REL T3 /*계약결제관계*/
                ON D1.CNTR_NO = T3.DTL_CNTR_NO
                AND D1.CNTR_SN = T3.DTL_CNTR_SN
                AND T3.DTA_DL_YN = 'N'
                AND S1.SL_CL_YM BETWEEN SUBSTR(T3.VL_STRT_DTM, 1, 6) AND SUBSTR(T3.VL_END_DTM, 1, 6)
            INNER JOIN TB_SSCT_CNTR_STLM_BAS T4 /*계약결제기본*/
                ON T3.CNTR_STLM_ID = T4.CNTR_STLM_ID
                AND T4.DTA_DL_YN = 'N'
                AND T4.DP_TP_CD IN ('0102','0203') /*계좌자동이체, 카드자동이체*/
            INNER JOIN TB_CUBS_CST_BAS C1 /*고객기본*/
                ON N1.CST_NO = C1.CST_NO
            INNER JOIN TB_PDBS_PD_BAS P1 /*상품기본*/
                ON T2.BASE_PD_CD = P1.PD_CD
                AND P1.DTA_DL_YN = 'N'
            INNER JOIN TB_PDBS_PD_CLSF_BAS P2 /*상품분류*/
                ON P1.PD_CLSF_ID = P2.PD_CLSF_ID
            LEFT JOIN TB_CBCL_WELLS_BOR_AMT_BAS Q2   /* WELLS위약금액기본 */
                ON N1.BASE_YM = Q2.PERF_YM
                AND N1.CNTR_NO = Q2.CNTR_NO
                AND N1.CNTR_SN = Q2.CNTR_SN
                AND Q2.DTA_DL_YN = 'N'
            LEFT JOIN TB_CBBO_WELLS_RENTAL_CB_DLQ_IZ X1 /*WELLS렌탈CB연체내역*/
                ON N1.CNTR_NO = X1.CNTR_NO
                AND N1.CST_NO = X1.CST_NO
                AND X1.DTA_DL_YN = 'N'
            LEFT JOIN TB_CBBO_BND_MSG_RELY_IZ Z3  /* 채권메시지중계내역 */
                ON N1.CNTR_NO = Z3.CNTR_NO
                AND N1.CNTR_SN = Z3.CNTR_SN
                AND Z3.FW_BIZ_NM = 'BN_KAKAO_MESSAGE' /*발송업무명*/
                AND Z3.MSG_FW_TP_CD = '01' /*메시지발송유형코드-01:카카오알림톡*/
                AND Z3.BND_MSG_TP_VAL1 = 'B' /*채권알림톡업무코드-B:등록관련*/
                AND Z3.BND_MSG_TP_VAL2 = 'B05' /*채권알림톡업무상세코드-B05:렌탈CB연체정보등록 예고*/
                AND N1.CST_NO = Z3.CST_NO
                AND Z3.DTA_DL_YN = 'N'
            LEFT JOIN TB_RVDW_RVE_DTL R1 /*T:수납상세*/
                ON N1.CNTR_NO = R1.CNTR_NO
                AND N1.CNTR_SN = R1.CNTR_SN
                AND N1.BASE_YM = SUBSTR(R1.PERF_DT, 1, 6)
                AND N1.CST_NO = R1.CST_NO
                AND R1.RVE_DV_CD IN ('02','03','04','05','07','08','19','13','18','97')
                AND R1.DP_DV_CD IN ('1','2','3','4')
                AND R1.DP_MES_CD IN ('01', '02') /*입금수단코드-01:현금,02:신용카드*/
                AND R1.DP_TP_CD IN ('0102','0203') /*계좌자동이체, 카드자동이체*/
                AND R1.RVE_PROCS_YN = 'Y' /*수납처리여부*/
                AND R1.DTA_DL_YN = 'N'
                AND R1.KW_GRP_CO_CD = '2000'
                AND R1.RVE_SN = (SELECT MAX(SR1.RVE_SN) AS RVE_SN FROM TB_RVDW_RVE_DTL SR1 WHERE SR1.KW_GRP_CO_CD = R1.KW_GRP_CO_CD AND SR1.RVE_NO = R1.RVE_NO)
        WHERE
            N1.CST_NO = #{cstNo}
            AND D1.PERF_YM = #{baseYm}
            AND D1.DLQ_MCN >= 0
            AND D1.EOT_DLQ_AMT + D1.EOT_DLQ_ADD_AMT > 0
            AND D1.DTA_DL_YN = 'N'
            AND (NVL((CASE WHEN R1.DP_DV_CD IN ('1','3') THEN NVL(R1.DP_AMT, 0) ELSE 0 END), 0)  /*입금금액*/
                - NVL((CASE WHEN R1.DP_DV_CD IN ('2','4') THEN NVL(R1.DP_AMT, 0) ELSE 0 END), 0) /*환불금액*/
                + NVL(Q2.EOT_BOR_AMT, 0) /*기말위약금액*/
                + (S1.MLG_DP_AMT - S1.MLG_RFND_AMT + S1.THM_ATAM_DP_AMT - S1.THM_ATAM_RFND_AMT) /*마일리지, 당월선수금*/
            )  > 0
        ORDER BY D1.CNTR_NO DESC, N1.BASE_YM DESC
    </select>
</mapper>





