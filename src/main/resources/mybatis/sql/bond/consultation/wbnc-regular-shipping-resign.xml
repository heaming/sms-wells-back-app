<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.bond.consultation.mapper.WbncRegularShippingResignMapper">
    <select id="selectRegularShippingResigns" resultType="com.kyowon.sms.wells.web.bond.consultation.dto.WbncRegularShippingResignDto$SearchRes">
        /* 직권해지관리 - 정기배송해지 조회 */
        SELECT
            A.SL_CL_YM AS BASE_YM	/*기준년월*/
            ,A.CNTR_NO	/*계약번호*/
            ,A.CNTR_SN	/*계약일련번호*/
            ,(CASE WHEN E.AUTH_RSG_CNFM_YN = 'N' THEN '해지예정'
                WHEN E.AUTH_RSG_CNFM_YN = 'Y' THEN '직권해지'
                ELSE '' END
            ) AS AUTH_RSG_STS	/*해지상태*/
            ,E.AUTH_RSG_CNFM_YN	/*직권해지확정여부*/
            ,A.CNTR_NO||'-'||A.CNTR_SN AS CNTR_NO_SN	/*계약상세번호*/
            ,A.CST_NO	/*고객번호*/
            ,(SELECT S1.CST_KNM
                FROM TB_CUBS_CST_BAS S1 /*T:고객기본*/
                WHERE S1.CST_NO = A.CST_NO) AS CST_KNM	/*고객명*/
            , C.BASE_PD_CD	/*패키지번호*/
            , (SELECT S1.PD_NM
                FROM TB_PDBS_PD_BAS S1 /*상품기본*/
                WHERE S1.PD_CD = A.PD_CD) AS PD_NM                     /*패키지명*/
            , F.PRTNR_KNM                                              /*플래너(판매자)명*/
            , B.SELL_PRTNR_NO                                          /*플래너(판매자)번호*/
            , F.OG_CD                                                  /*조직코드*/
            , H.SL_DT                                                  /*매출일자*/
            , H.SELL_AMT                                               /*판매금액*/
            , D.DLQ_MCN                                                /*연체개월수*/
            , A.BTD_UC_AMT AS UC_AMT                                   /*미수금액 - 기초미수금액*/
            , D.BTD_DLQ_AMT AS DLQ_AMT                                 /*연체금액*/
            , A.SL_DP_AGG_AMT AS TOT_RVE_AMT /*입금누계-연체시작일자이후부터 입금된 총금액*/
            , (SELECT S1.PRTNR_KNM
                FROM TB_CBBO_CLCTAM_PRTNR_DTL S1 /*T:집금파트너상세*/
                WHERE 1 = 1
                AND S1.PRTNR_NO = G.CLCTAM_PRTNR_NO
                AND ROWNUM <![CDATA[<=]]> 1
            ) AS CLCTAM_PRTNR_NM /*집금담당자명*/
            , G.CLCTAM_PRTNR_NO
            , '' AS ERR_CN                /*에러내용*/
            , G.BND_BIZ_DV_CD    /* 채권업무구분코드 */
            , G.BND_CLCTN_PRP_DV_CD    /* 채권추심속성구분코드 */
            , G.BND_CLCTN_PRP_RSON_CD    /* 채권추심속성사유코드 */
            , G.BND_CLCTN_PRP_CHDT    /* 채권추심속성변경일자 */
        FROM TB_CBCL_WELLS_SL_MM_CL_IZ A	/* WELLS매출월마감내역 */
        INNER JOIN TB_SSCT_CNTR_BAS B		/*T:계약기본*/
            ON 1 = 1
            AND A.CNTR_NO = B.CNTR_NO
        INNER JOIN TB_SSCT_CNTR_DTL C	/*T:계약상세*/
            ON 1 = 1
            AND C.CNTRW_TP_CD = '7'	/* 계약상세 */
            AND C.CNTR_NO = A.CNTR_NO
            AND C.CNTR_SN = A.CNTR_SN
        INNER JOIN TB_CBCL_DLQ_BAS D
            ON 1 = 1
            AND D.PERF_YM = A.SL_CL_YM
            AND D.CNTR_NO = A.CNTR_NO
            AND D.CNTR_SN = A.CNTR_SN
        LEFT OUTER JOIN TB_CBBO_WELLS_AUTH_RSG_IZ E /*T:WELLS직권해지내역*/
            ON 1 = 1
            AND E.BASE_YM = A.SL_CL_YM
            AND E.CNTR_NO = A.CNTR_NO
            AND E.CNTR_SN = A.CNTR_SN
        LEFT JOIN TB_OGBS_PRTNR_BAS F /*T:파트너기본*/
            ON 1 = 1
            AND F.OG_TP_CD = B.SELL_OG_TP_CD
            AND F.PRTNR_NO = B.SELL_PRTNR_NO
        LEFT JOIN TB_CBBO_BND_CNTR_BAS G /*T:채권계약기본*/
            ON 1 = 1
            AND G.BASE_YM = A.SL_CL_YM
            AND G.CNTR_NO = A.CNTR_NO
            AND G.CNTR_SN = A.CNTR_SN
        LEFT JOIN TB_FEAM_WELS_NRCTR_MM_CL H	/* 웰스순주문계약월마감 */
            ON 1 = 1
            AND H.BASE_YM = A.SL_CL_YM
            AND H.CNTR_NO = A.CNTR_NO
            AND H.CNTR_SN = A.CNTR_SN
        WHERE 1 = 1
            AND A.SL_CL_YM = SUBSTR(#{authRsgDt}, 0, 6)	/* 매출마감년월 */
            AND A.SL_RCOG_DT IS NOT NULL		/* LCSLEY>0 */
            AND A.CAN_DT IS NULL 			/* 취소일자 */
            AND A.CNTR_TAM > 1			/* 계약총액 LCMONT>1 */
            AND A.RENTAL_TN <![CDATA[<=]]> 99
            AND D.BTD_DLQ_AMT > 0
            AND D.DLQ_MCN >= 3   /* 연체개월수 */
            AND G.BND_CLCTN_PRP_DV_CD IN ('02','03','08')    /* 채권추심속성구분코드 */
            AND G.BND_CLCTN_PRP_RSON_CD != '3C'				/* 채권추심속성사유코드-위탁관리 */
            <if test='@MybatisUtils@isNotEmpty(clctamDvCd)'>
               AND G.CLCTAM_DV_CD = #{clctamDvCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(clctamPrtnrNo)'>
               AND G.CLCTAM_PRTNR_NO = #{clctamPrtnrNo}
            </if>
    </select>

    <update id="updateRegularShippingResignFinalConfirm">
        /* 직권해지관리 - 정기배송해지 최종확정 */
        UPDATE TB_CBBO_WELLS_AUTH_RSG_IZ /*T:WELLS직권해지내역*/
           SET AUTH_RSG_CNFM_YN = 'Y'
             , AUTH_RSG_CNFMDT = TO_CHAR(SYSDATE,'YYYYMMDD')
             , AUTH_RSG_CNFM_RGST_PRTNR_NO = #{session.employeeIDNumber}
         WHERE 1 = 1
           AND DTA_DL_YN = 'N'
           AND AUTH_RSG_EXP_YN = 'Y'
           AND BASE_YM = #{baseYm}
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </update>
</mapper>
