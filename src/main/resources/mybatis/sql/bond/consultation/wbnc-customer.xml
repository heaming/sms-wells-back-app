<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.bond.consultation.mapper.WbncCustomerMapper">
    <select id="selectBaseYm" resultType="com.kyowon.sms.wells.web.bond.consultation.dto.WbncCustomerDto$FindBaseYmRes">
        SELECT BASE_YM 
          FROM ( SELECT BASE_YM 
                   FROM TB_CBBO_BND_CNSL_BAS_IZ 
                  WHERE 1=1
                  ORDER BY BASE_YM DESC
               )
         WHERE ROWNUM = 1
    </select>
    
    <select id="selectCustomers" resultType="com.kyowon.sms.wells.web.bond.consultation.dto.WbncCustomerDto$SearchRes"> 
        SELECT MAX(CTT) AS CTT /* 컨택 */
		     , MAX(BIL_DT) AS BIL_DT /* 이체일자 */
		     , MAX(DP_TP_CD) AS DP_TP_CD /* 입금유형코드*/
		     , MAX(FNT) AS FNT /* 이체 */
		     , CST_NO /* 고객번호 */
		     , MAX(CST_NM) AS CST_NM /* 고객명 */
		     , MAX(DLQ_MCNT) AS DLQ_MCNT   /* 연체개월 */  
		     , MAX(FNL_CNSL_D) AS FNL_CNSL_D /* 최종상담일 */
		     , MAX(OJ_AMT) AS OJ_AMT /* 대상금액 */
		     , MAX(OJ_DP) AS OJ_DP /* 대상입금 */ 
		     , MAX(OJ_BLAM) AS OJ_BLAM /* 대상금액 - 대상입금 = 대상잔액 */
		     , MAX(TOT_DLQ_AMT) AS TOT_DLQ_AMT /* 연체금액 + 연체가산금 = 총연체금 */
		     , MAX(TOT_DLQ_DP) AS TOT_DLQ_DP /* 연체입금금액 + 연체가산금입금금액 = 총연체입금 */
		     , MAX(TOT_DLQ_BLAM) AS TOT_DLQ_BLAM /* 총연체금 - 총연체입금 = 총연체잔액 */
		     , MAX(DLQ_AMT) AS DLQ_AMT /* 연체금액 */
		     , MAX(DLQ_DP) AS DLQ_DP /* 연체입금 */
		     , MAX(DLQ_BLAM) AS DLQ_BLAM /* 연체금액 - 연체입금 = 연체잔액 */  
		     , MAX(MM_CHRAM_AMT) AS MM_CHRAM_AMT /* 월요금액 */      
		     , MAX(MM_CHRAM_DP) AS MM_CHRAM_DP /* 월요금입금 */       
		     , MAX(MM_CHRAM_BLAM) AS MM_CHRAM_BLAM /* 당월요금금액 - 당월요금입금금액 = 월요금잔액 */      
		     , MAX(DLQ_ADD_AMT) AS DLQ_ADD_AMT /* 연체가산금액 */       
		     , MAX(DLQ_ADD_DP) AS DLQ_ADD_DP /* 연체가산입금 */     
		     , MAX(DLQ_ADAMT_BLAM) AS DLQ_ADAMT_BLAM /* 연체가산금액 - 연체가산금입금금액 = 연체가산금잔액 */      
		     , MAX(UC_AMT) AS UC_AMT /* 미수금액 */    
		     , MAX(RSG_BOR_DP_AMT) AS RSG_BOR_DP_AMT /* 해지위약입금금액 */   
		     , MAX(UC_DP) AS UC_DP /* 미수입금 */  
		     , MAX(UC_BLAM) AS UC_BLAM /* 미수금 - 총입금액 = 미수잔액 */
		     , MAX(TOT_DP_AMT) AS TOT_DP_AMT /* 연체입금금액 + 연체가산입금금액 + 해지위약금입금금액 + 당월요금입금금액 = 총입금액 */
		     , MAX(SPMT_SL) AS SPMT_SL /* 추가매출 */  
		     , MAX(CCAM) AS CCAM/* 위약금 */
		     , MAX(LSFE) AS LSFE /* 분실료 */    
		     , MAX(RTLFE1) AS RTLFE1 /* 렌탈료1 */     
		     , MAX(RTLFE_ISTM1) AS RTLFE_ISTM1 /* 렌탈료1할 */   
		     , MAX(RTLFE2) AS RTLFE2 /* 렌탈료2 */    
		     , MAX(RTLFE_ISTM2) AS RTLFE_ISTM2 /* 렌탈료2할 */
		     , MAX(CLCTAM_PRTNR_NO) AS CLCTAM_PRTNR_NO /* 집금번호 */
		     , MAX(CLCTAM_ICHR) AS CLCTAM_ICHR   /* 집급담당 */
		     , MAX(CRAL_LOCARA_TNO) AS CRAL_LOCARA_TNO /* 계약휴대전화번호1 */ 
		     , MAX(MEXNO_ENCR) AS MEXNO_ENCR /* 계약휴대전화번호2 */ 
		     , MAX(CRAL_IDV_TNO) AS CRAL_IDV_TNO  /* 계약휴대전화번호3 */
		     , MAX(IST_CRAL_LOCARA_TNO) AS IST_CRAL_LOCARA_TNO /* 설치휴대전화번호1 */ 
		     , MAX(IST_MEXNO_ENCR) AS IST_MEXNO_ENCR /* 설치휴대전화번호2 */ 
		     , MAX(IST_CRAL_IDV_TNO) AS IST_CRAL_IDV_TNO /* 설치휴대전화번호3 */
		     , MAX(VT_AC_BNK) AS VT_AC_BNK /* 가상계좌은행 */ 
		     , MAX(VT_AC_NO) AS VT_AC_NO /* 가상계좌번호 */ 
		     , MAX(SFK) AS SFK /* 세이프키*/
		     , MAX(CLN_PSBL) AS CLN_PSBL /* 회수가능성*/ 
		     , MAX(CLN_PRCS) AS CLN_PRCS /* 회수절차*/  
		     , MAX(CST_STAT) AS CST_STAT /* 고객상태*/   
		     , MAX(CVCP_INF) AS CVCP_INF /* 민원정보*/
		     , MAX(UNUSL_ARTC) AS UNUSL_ARTC /* 특이사항*/
		     , MAX(CNTR_TP_CD) AS CNTR_TP_CD /* 고객구분*/
		     , MAX(CNTR_NO) AS CNTR_NO /* 계약번호 */
		     , MAX(CNTR_SN) AS CNTR_SN /* 계약일련번호 */
		  FROM (
		        SELECT CASE WHEN T1.BND_ASN_DT > T2.FST_RGST_DTM AND SUBSTR( T2.TEL_CNSL_RS_CD , 1 ,1 ) = 1 THEN '○'
		                    WHEN T1.BND_ASN_DT > T2.FST_RGST_DTM AND SUBSTR( T2.TEL_CNSL_RS_CD , 1 ,1 ) = 2 THEN '△'
		                    ELSE 'Ｘ'
		                END AS CTT /* 컨택 */
		             , T3.MPY_BSDT AS BIL_DT /* 이체일자 */
		             , T3.DP_TP_CD /* 입금유형코드*/
		             , T3.FNT_MTHD AS FNT /* 이체 */
		             , T1.CST_NO AS CST_NO /* 고객번호 */
		             , T4.CST_KNM AS CST_NM /* 고객명 */
		             , T5.DLQ_MCN AS DLQ_MCNT   /* 연체개월 */  
		             , SUBSTR(T1.FST_RGST_DTM,0,8) AS FNL_CNSL_D /* 최종상담일 */
		             , (NVL(T5.DLQ_AMT, 0) + NVL(T5.DLQ_ADD_AMT, 0)) + NVL(T5.THM_CHRAM_AMT, 0) AS OJ_AMT /* 대상금액 */
		             , (NVL(T5.DLQ_DP_AMT, 0) + NVL(T5.DLQ_ADD_DP_AMT, 0)) + NVL(T5.THM_CHRAM_DP_AMT, 0) AS OJ_DP /* 대상입금 */ 
		             , ((NVL(T5.DLQ_AMT, 0) + NVL(T5.DLQ_ADD_AMT, 0)) + NVL(T5.THM_CHRAM_AMT, 0)) - ((NVL(T5.DLQ_DP_AMT, 0) + NVL(T5.DLQ_ADD_DP_AMT, 0)) + NVL(T5.THM_CHRAM_DP_AMT, 0)) AS OJ_BLAM /* 대상금액 - 대상입금 = 대상잔액 */
		             , NVL(T5.DLQ_AMT, 0) + NVL(T5.DLQ_ADD_AMT, 0) AS TOT_DLQ_AMT /* 연체금액 + 연체가산금 = 총연체금 */
		             , NVL(T5.DLQ_DP_AMT, 0) + NVL(T5.DLQ_ADD_DP_AMT, 0) AS TOT_DLQ_DP /* 연체입금금액 + 연체가산금입금금액 = 총연체입금 */
		             , (NVL(T5.DLQ_AMT, 0) + NVL(T5.DLQ_ADD_AMT, 0)) - (NVL(T5.DLQ_DP_AMT, 0) + NVL(T5.DLQ_ADD_DP_AMT, 0)) AS TOT_DLQ_BLAM /* 총연체금 - 총연체입금 = 총연체잔액 */
		             , NVL(T5.DLQ_AMT, 0) AS DLQ_AMT /* 연체금액 */
		             , NVL(T5.DLQ_DP_AMT, 0) AS DLQ_DP /* 연체입금 */
		             , NVL(T5.DLQ_AMT, 0) - NVL(T5.DLQ_DP_AMT, 0) AS DLQ_BLAM /* 연체금액 - 연체입금 = 연체잔액 */  
		             , NVL(T5.THM_CHRAM_AMT, 0) AS MM_CHRAM_AMT /* 월요금액 */      
		             , NVL(T5.THM_CHRAM_DP_AMT, 0) AS MM_CHRAM_DP /* 월요금입금 */       
		             , NVL(T5.THM_CHRAM_AMT, 0) - NVL(T5.THM_CHRAM_DP_AMT, 0) AS MM_CHRAM_BLAM /* 당월요금금액 - 당월요금입금금액 = 월요금잔액 */      
		             , NVL(T5.DLQ_ADD_AMT, 0) AS DLQ_ADD_AMT /* 연체가산금액 */       
		             , NVL(T5.DLQ_ADD_DP_AMT, 0) AS DLQ_ADD_DP /* 연체가산입금 */     
		             , NVL(T5.DLQ_ADD_AMT, 0) - NVL(T5.DLQ_ADD_DP_AMT, 0) AS DLQ_ADAMT_BLAM /* 연체가산금액 - 연체가산금입금금액 = 연체가산금잔액 */      
		             , NVL(T5.UC_AMT, 0) AS UC_AMT /* 미수금액 */    
		             , NVL(T5.RSG_BOR_DP_AMT, 0) AS RSG_BOR_DP_AMT /* 해지위약입금금액 */   
		             , NVL(T5.DLQ_DP_AMT, 0) + NVL(T5.DLQ_ADD_DP_AMT, 0) + NVL(T5.RSG_BOR_DP_AMT, 0) + NVL(T5.THM_CHRAM_DP_AMT, 0) AS UC_DP /* 미수입금 */  
		             , NVL(T5.UC_AMT, 0) - (NVL(T5.DLQ_DP_AMT, 0) + NVL(T5.DLQ_ADD_DP_AMT, 0) + NVL(T5.RSG_BOR_DP_AMT, 0) + NVL(T5.THM_CHRAM_DP_AMT, 0)) AS UC_BLAM /* 미수금 - 총입금액 = 미수잔액 */
		             , NVL(T5.DLQ_DP_AMT, 0) + NVL(T5.DLQ_ADD_DP_AMT, 0) + NVL(T5.RSG_BOR_DP_AMT, 0) + NVL(T5.THM_CHRAM_DP_AMT, 0) AS TOT_DP_AMT /* 연체입금금액 + 연체가산입금금액 + 해지위약금입금금액 + 당월요금입금금액 = 총입금액 */
		             , NVL(T6.SPMT_SL_AMT, 0) AS SPMT_SL /* 추가매출 */  
		             , NVL(T7.BOR_AMT, 0) AS CCAM /* 위약금 */
		             , NVL(T7.LS_RNTF, 0) AS LSFE /* 분실료 */    
		             , NVL(T8.RENTAL_AMT, 0) AS RTLFE1 /* 렌탈료1 */     
		             , NVL(T8.RENTAL_DSC_AMT, 0) AS RTLFE_ISTM1 /* 렌탈료1할 */   
		             , NVL(T8.RENTAL_AMT2, 0) AS RTLFE2 /* 렌탈료2 */    
		             , NVL(T8.RENTAL_DSC_AMT2, 0) AS RTLFE_ISTM2 /* 렌탈료2할 */
		             , T1.CLCTAM_PRTNR_NO /* 집금번호 */
		             , (SELECT DISTINCT PRTNR_KNM FROM TB_CBBO_CLCTAM_PRTNR_DTL WHERE PRTNR_NO = T1.CLCTAM_PRTNR_NO) AS CLCTAM_ICHR   /* 집급담당 */
		             , T4.CRAL_LOCARA_TNO /* 계약휴대전화번호1 */ 
		             , T4.MEXNO_ENCR /* 계약휴대전화번호2 */ 
		             , T4.CRAL_IDV_TNO  /* 계약휴대전화번호3 */
		             , T9.CRAL_LOCARA_TNO AS IST_CRAL_LOCARA_TNO /* 설치휴대전화번호1 */ 
		             , T9.MEXNO_ENCR AS IST_MEXNO_ENCR /* 설치휴대전화번호2 */ 
		             , T9.CRAL_IDV_TNO AS IST_CRAL_IDV_TNO /* 설치휴대전화번호3 */
		             , F_CMZ_CD_NM('TNT_WELLS', 'BNK_CD', T10.VAC_BNK_CD) AS VT_AC_BNK /* 가상계좌은행 */ 
		             , T10.VAC_NO AS VT_AC_NO /* 가상계좌번호 */ 
		             , T4.SFK_VAL AS SFK /* 세이프키*/
		             , T11.BND_CLN_PSBL_DV_CD AS CLN_PSBL /* 회수가능성*/ 
		             , T11.BND_CLN_PRCS_DV_CD AS CLN_PRCS /* 회수절차*/  
		             , T11.BND_CNSL_CST_STAT_CD AS CST_STAT /* 고객상태*/   
		             , T12.CVCP_CN AS CVCP_INF /* 민원정보*/
		             , T12.CNSL_UNUITM_CN AS UNUSL_ARTC /* 특이사항*/
		             , T13.COPN_DV_CD AS CNTR_TP_CD /* 고객구분*/
		             , T1.CNTR_NO /* 계약번호 */
		             , T1.CNTR_SN /* 계약일련번호 */
		          FROM TB_CBBO_BND_CNSL_BAS_IZ T1 /* 채권상담기본내역 */
		          LEFT OUTER JOIN (
		                           SELECT CST_NO
		                                , BND_CLN_PSBL_DV_CD 
		                                , BND_CLN_PRCS_DV_CD
		                                , BND_CNSL_CST_STAT_CD
		                                , TEL_CNSL_RS_CD
		                                , FST_RGST_DTM 
		                             FROM TB_CBBO_BND_TEL_CNSL_IZ /* 채권전화상담내역 */
		                            WHERE ROWNUM = 1 ORDER BY FST_RGST_DTM DESC
		             ) T2
		            ON T1.CST_NO = T2.CST_NO
		          LEFT OUTER JOIN ( 
		                           SELECT (MPY_BSDT||CASE WHEN DP_TP_CD = '0203' THEN '카' END) AS FNT_MTHD
		                                , CNTR_NO
		                                , CST_NO
		                                , DP_TP_CD
		                                , MPY_BSDT
		                             FROM TB_SSCT_CNTR_STLM_BAS 
		                             WHERE (DP_TP_CD = '0102' OR DP_TP_CD = '0203')
		             ) T3
		            ON T1.CNTR_NO = T3.CNTR_NO 
		           AND T1.CST_NO = T3.CST_NO      
		          LEFT OUTER JOIN TB_CUBS_CST_BAS T4 /* 고객기본 */
		            ON T1.CST_NO = T4.CST_NO 
		          LEFT OUTER JOIN TB_CBBO_BND_CNTR_BAS T5 /* 채권계약기본 */
		            ON T1.CNTR_NO = T5.CNTR_NO
		           AND T1.CNTR_SN = T5.CNTR_SN  
		           AND T1.BASE_YM = T5.BASE_YM
		          LEFT OUTER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ T6 /* WELLS매출월마감내역 */
		            ON T6.SL_CL_YM = TO_CHAR(ADD_MONTHS(TO_DATE(T1.BASE_YM, 'YYYYMM'), -1), 'YYYYMM')
		           AND T6.CNTR_NO = T1.CNTR_NO 
		           AND T6.CNTR_SN = T1.CNTR_SN
		          LEFT OUTER JOIN TB_CBCL_WELLS_BOR_AMT_BAS T7 /* WELLS위약금액기본 */
		            ON T7.PERF_YM = TO_CHAR(ADD_MONTHS(TO_DATE(T1.BASE_YM, 'YYYYMM'), -1), 'YYYYMM')
		           AND T7.CNTR_NO = T1.CNTR_NO 
		           AND T7.CNTR_SN = T1.CNTR_SN  
		          LEFT OUTER JOIN TB_CBCL_WELLS_SL_MM_CL_IZ T8 /* WELLS매출월마감내역 */
		            ON T8.SL_CL_YM = TO_CHAR(ADD_MONTHS(TO_DATE(T1.BASE_YM, 'YYYYMM'), -1), 'YYYYMM')
		           AND T8.CNTR_NO = T1.CNTR_NO 
		           AND T8.CNTR_SN = T1.CNTR_SN
		          LEFT OUTER JOIN (
		                            SELECT CR.CNTR_ADRPC_ID
		                                 , CR.DTL_CNTR_NO
		                                 , CR.DTL_CNTR_SN
		                                 , CB.LOCARA_TNO
		                                 , CB.EXNO_ENCR
		                                 , CB.IDV_TNO
		                                 , CB.CRAL_LOCARA_TNO
		                                 , CB.MEXNO_ENCR
		                                 , CB.CRAL_IDV_TNO
		                                 , NVL(AB.NEW_ADR_ZIP, AB.OLD_ADR_ZIP) AS SPP_ZIP
		                                 , NVL(AB.RNADR, AB.LTN_ADR) AS SPP_ADR
		                                 , NVL(AB.RDADR, AB.LTN_DTL_ADR) AS SPP_DTL_ADR
		                              FROM TB_SSCT_CNTR_ADR_REL CR /* 계약주소관계 */
		                              LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS CB /* 계약주소지기본 */
		                                ON CB.CNTR_ADRPC_ID = CR.CNTR_ADRPC_ID
		                              LEFT OUTER JOIN TB_GBCO_ADR_BAS AB /* 주소기본 */
		                                ON AB.ADR_ID = CB.ADR_ID
		                             WHERE CR.CNTR_UNIT_TP_CD = '020'
		                               AND CR.ADRPC_TP_CD = '3'  /* 설치주소 */
		                               AND CR.DTA_DL_YN = 'N'
		                          ) T9
		            ON T1.CNTR_NO = T9.DTL_CNTR_NO
		           AND T1.CNTR_SN = T9.DTL_CNTR_SN
		          LEFT OUTER JOIN TB_RVDW_VAC_BAS T10 /* 가상계좌기본 */
		            ON T10.VAC_IS_DV_CD = '5'/*가상계좌발급구분코드 = 연체집금용*/ 
		           AND T10.VAC_STAT_CD = '1'/*가상계좌상태코드 = 할당*/ 
		           AND T10.VAC_IS_CST_NO = T1.CST_NO/*발급고객번호*/
		          LEFT OUTER JOIN 
		                         (
		                           SELECT CST_NO
		                                , BND_CLN_PSBL_DV_CD 
		                                , BND_CLN_PRCS_DV_CD
		                                , BND_CNSL_CST_STAT_CD
		                                , TEL_CNSL_RS_CD
		                                , FST_RGST_DTM 
		                             FROM TB_CBBO_BND_TEL_CNSL_IZ /* 채권전화상담내역 */
		                            WHERE ROWNUM = 1 ORDER BY FST_RGST_DTM DESC
		             ) T11
		            ON T1.CST_NO = T11.CST_NO
		          LEFT OUTER JOIN (
		                             SELECT MAX(FNL_MDFC_DTM) AS FNL_MDFC_DTM
		                                  , CLCTN_OJ_OG_TP_CD
		                                  , CLCTN_OJ_PRTNR_NO
		                                  , MAX(CNSL_UNUITM_CN) AS CNSL_UNUITM_CN
		                                  , MAX(CVCP_CN) AS CVCP_CN
		                               FROM TB_CBBO_BND_UNUITM_CVCP_DTL
		                              WHERE BND_CNTR_TP_CD = '02'
		                                AND DTA_DL_YN = 'N'
		                              GROUP BY CLCTN_OJ_OG_TP_CD, CLCTN_OJ_PRTNR_NO
		                            ) T12
		            ON T12.CLCTN_OJ_OG_TP_CD = T1.CLCTN_OJ_OG_TP_CD
		           AND T12.CLCTN_OJ_PRTNR_NO = T1.CLCTN_OJ_PRTNR_NO
		         INNER JOIN TB_SSCT_CNTR_BAS T13 /* 계약기본 */
                    ON T1.CNTR_NO = T13.CNTR_NO
		     )
         WHERE 1=1
           AND CLCTAM_PRTNR_NO = #{schClctamNo}
         <if test='@MybatisUtils@isNotEmpty(schCstNo)'>
           AND CST_NO = #{schCstNo}
         </if>  
         <if test='@MybatisUtils@isNotEmpty(schCstNm)'>
           AND CST_NM = #{schCstNm}
         </if>  
         <if test='@MybatisUtils@isNotEmpty(schCralLocaraTno) and @MybatisUtils@isNotEmpty(schMexnoEncr) and @MybatisUtils@isNotEmpty(schCralIdvTno)'>
           AND CRAL_LOCARA_TNO = #{schCralLocaraTno} 
           AND MEXNO_ENCR = #{schMexnoEncr} 
           AND CRAL_IDV_TNO = #{schCralIdvTno}
         </if>
         <if test='@MybatisUtils@isNotEmpty(schSfK)'>
           AND SFK = #{schSfK}
         </if>
         <if test='@MybatisUtils@isNotEmpty(schIstCralLocaraTno) and @MybatisUtils@isNotEmpty(schIstMexnoEncr) and @MybatisUtils@isNotEmpty(schIstCralIdvTno)'>
           AND IST_CRAL_LOCARA_TNO = #{schIstCralLocaraTno} 
           AND IST_MEXNO_ENCR = #{schIstMexnoEncr} 
           AND IST_CRAL_IDV_TNO = #{schIstCralIdvTno}
         </if>
         <if test='@MybatisUtils@isNotEmpty(schDlqMcntStrt) and @MybatisUtils@isNotEmpty(schDlqMcntEnd)'>
           AND DLQ_MCNT BETWEEN #{schDlqMcntStrt} AND #{schDlqMcntEnd}
         </if>
         <if test='@MybatisUtils@isNotEmpty(schFntDtStrt) and @MybatisUtils@isNotEmpty(schFntDtEnd)'>
           AND DP_TP_CD = #{schFntDv}
           AND BIL_DT BETWEEN #{schFntDtStrt} AND #{schFntDtEnd}
         </if>
         <if test='@MybatisUtils@isNotEmpty(schOjBlamStrt) and @MybatisUtils@isNotEmpty(schOjBlamEnd)'>
           AND OJ_BLAM BETWEEN #{schOjBlamStrt} AND #{schOjBlamEnd}
         </if>
         <if test='@MybatisUtils@isNotEmpty(schCstDv)'>
            AND CNTR_TP_CD = #{schCstDv}
         </if>
         <if test='@MybatisUtils@isNotEmpty(schDv)'>
           <if test="schDv == '01'">
             AND (DLQ_AMT - DLQ_DP) <![CDATA[<>]]> 0 /*연체잔액0원제외*/
           </if>
           <if test="schDv == '02'">
             AND (DLQ_DP + DLQ_ADD_DP + RSG_BOR_DP_AMT + MM_CHRAM_DP) > 0 /*총입금액0원제외*/
           </if>
           <if test="schDv == '03'">
             AND ((DLQ_AMT + DLQ_ADD_AMT + MM_CHRAM_AMT) - (DLQ_DP + DLQ_ADD_DP + MM_CHRAM_DP)) <![CDATA[<>]]> 0 /*대상잔액0원제외*/
           </if>
           <if test="schDv == '04'">
             AND DLQ_MCNT <![CDATA[<>]]> 0 /*연체개월0개월제외*/
           </if>
         </if>
         GROUP BY CST_NO
    </select>
    
    <select id="selectCustomerDetail" resultType="com.kyowon.sms.wells.web.bond.consultation.dto.WbncCustomerDto$FindRes">
        SELECT T1.CNTR_NO AS CNTR_NO /* 계약번호 */ 
		     , T1.CNTR_SN AS CNTR_SN /* 계약일련번호 */
		     , T1.CNTR_NO || T1.CNTR_SN AS DTL_CNTR_NO /* 상세계약번호 */
		     , T2.CST_KNM AS CST_NM /* 고객명 */
		     , T2.SEX_DV_CD
		     , F_CMZ_CD_NM('TNT_WELLS', 'SEX_DV_CD', T2.SEX_DV_CD) AS SEX_DV_NM 
		     , T2.BRYY_MMDD
		     , T2.CRAL_LOCARA_TNO AS CNTR_CRAL_LOCARA_TNO  /* 계약처휴대지역전화번호 */
		     , T2.MEXNO_ENCR  AS CNTR_MEXNO_ENCR           /* 계약처휴대전화국번호암호화 */
		     , T2.CRAL_IDV_TNO  AS CNTR_CRAL_IDV_TNO       /* 계약처휴대전화번호3 */
		     , T1.CST_NO AS CST_NO /* 고객번호 */
		     , T2.SFK_VAL AS SFK /* 세이프키 */
		     , T3.BU_NOTI_TP_CD AS BU_NOTI_TP_CD /* 부담유형 */
		     , T4.RCGVP_KNM AS RCGVP_KNM /* 설치자명 */
		     , T4.LOCARA_TNO AS IST_LOCARA_TNO /* 설치처지역전화번호 */
		     , T4.EXNO_ENCR AS IST_EXNO_ENCR /* 설치처전화국번호암호화 */
		     , T4.IDV_TNO AS IST_IDV_TNO /* 설치처개별전화번호 */
		     , T4.CRAL_LOCARA_TNO AS IST_CRAL_LOCARA_TNO /* 설치처휴대지역전화번호 */
		     , T4.MEXNO_ENCR AS IST_MEXNO_ENCR /* 설치처휴대전화국번호암호화 */
		     , T4.CRAL_IDV_TNO AS IST_CRAL_IDV_TNO /* 설치처휴대개별전화번호 */
		     , T5.SPP_ZIP AS CNTR_SPP_ZIP/* 계약처우편번호 */
		     , T5.SPP_ADR AS CNTR_SPP_ADR/* 계약처기본주소 */
		     , T5.SPP_DTL_ADR AS CNTR_SPP_DTL_ADR /* 계약처상세주소 */
		     , T4.SPP_ZIP AS IST_SPP_ZIP /* 설치처우편번호 */
		     , T4.SPP_ADR AS IST_SPP_ADR /* 설치처기본주소 */
		     , T4.SPP_DTL_ADR AS IST_SPP_DTL_ADR /* 설치처상세주소 */
		     , T6.PD_NM AS PD_NM /* 상품명 */  
		     , T7.CNTR_DTL_STAT_CD /* 현재회원상태 */
		     , F_CMZ_CD_NM('TNT_WELLS', 'CNTR_DTL_STAT_CD', T7.CNTR_DTL_STAT_CD) AS CNTR_DTL_STAT_NM /* 현재회원상태명 */
		     , TO_CHAR(TO_DATE(T8.CNTR_RCP_FSH_DTM,'YYYYMMDD'),'YYYY-MM-DD') AS RCP_DT /* 접수일 */
		     , TO_CHAR(TO_DATE(T9.IST_DT,'YYYYMMDD'),'YYYY-MM-DD') AS IST_DT /* 설치일 */
		     , TO_CHAR(TO_DATE(T8.CNTR_CAN_DTM,'YYYYMMDD'),'YYYY-MM-DD') AS CAN_DT /* 취소일 */
		     , TO_CHAR(TO_DATE(T9.REQD_DT,'YYYYMMDD'),'YYYY-MM-DD') AS REQD_DT /* 철거일 */
		     , T10.BNK_NM || ' : ' || T10.AFTN_NO AS VT_AC /* 자동이체 */
		     , T11.MPY_BSDT AS FNT_DT /* 이체일자 */ 
		     , T11.DP_TP_CD AS MPY_MTHD_TP_CD/* 입금유형코드 */
		     , F_CMZ_CD_NM('TNT_WELLS', 'DP_TP_CD', T11.DP_TP_CD) AS MPY_MTHD_TP_NM /* 입금유형코드명 */
		     , T12.PRTNR_KNM AS PLAR /* 판매자 */
		     , T12.CRAL_LOCARA_TNO AS PLAR_CRAL_LOCARA_TNO 
		     , T12.MEXNO_ENCR AS PLAR_MEXNO_ENCR 
		     , T12.CRAL_IDV_TNO AS PLAR_CRAL_IDV_TNO /* 판매자 휴대전화번호 */
		     , TO_CHAR(TO_DATE(T8.CLTN_DT,'YYYYMMDD'),'YYYY-MM-DD') AS CLTN_DT /* 판매자 해약일 */
		     , T13.PRTNR_KNM AS DSMN /* 지국장 */
		     , T13.CRAL_LOCARA_TNO AS DSMN_CRAL_LOCARA_TNO
		     , T13.MEXNO_ENCR AS DSMN_MEXNO_ENCR
		     , T13.CRAL_IDV_TNO AS DSMN_CRAL_IDV_TNO /* 지국장 휴대전화번호 */
		     , T13.CLTN_DT AS DSMN_CLTN_DT /* 지국장 해약일 */
		     , T14.BLD_CD AS BLD_CD /* 소속빌딩코드 */
		     , T14.BLD_NM AS BLD_NM /* 소속빌딩명 */
		     , '' AS ALNC_CD /* 제휴코드 */
		     , '' AS ALNC_NM /* 제휴명 */
		     , '' AS ALNC_STAT /* 제휴상태 */
		     , T15.VAC_NO AS VAC_NO /* 가상계좌번호 */
		     , TO_CHAR(TO_DATE(T1.BND_TF_DT,'YYYYMMDD'),'YYYY-MM-DD') AS TF_DT /* 이관일자 */
		     , T1.CLCTAM_PRTNR_NO AS PRTNR_NO /* 집금담당번호 */
		     , (SELECT PRTNR_KNM FROM TB_CBBO_CLCTAM_PRTNR_DTL WHERE PRTNR_NO = T1.CLCTAM_PRTNR_NO) AS PRTNR_NM /*집금담당명*/
		     , (SELECT TO_CHAR(TO_DATE(SUBSTR(TT1.DFLT_RGST_DTM, 0,8),'YYYYMMDD'),'YYYY-MM-DD') FROM TB_CBBO_DFLT_RGST_BAS TT1 WHERE TT1.DFLT_RLS_DTM IS NULL AND DTA_DL_YN = 'N' AND TT1.CST_NO = T1.CST_NO AND TT1.OC_DT = (SELECT MAX(TT2.OC_DT) FROM TB_CBBO_DFLT_RGST_BAS TT2 WHERE TT2.DFLT_RLS_DTM IS NULL AND TT2.DTA_DL_YN = 'N' AND TT2.CST_NO = TT1.CST_NO)) AS DFLT_DT /*채무불이행일자*/
		     , T16.LWM_MO_CN /* 법조치 */
		     , ( CASE WHEN T7.CNTR_DTL_STAT_CD > '201' THEN 'Y' ELSE '' END) AS SL_STP /* 매출중지 */
		     , T17.BND_CLN_PSBL_DV_CD /* 회수가능성 */   
		     , T17.BND_CLN_PRCS_DV_CD /* 회수절차 */   
		     , NVL(T18.LWM_RCGN_AMT,0) + NVL(T18.LWM_DLVYFE,0) + NVL(T18.LWM_ENFORC_CS_AMT,0) + NVL(T18.LWM_PESU_PRCS_CS_AMT,0) AS LWSC_BIL_AMT /* 소송비 청구금액 */
		     , NVL(T18.LWM_DP_AMT,0) AS LWM_DP_AMT /* 소송비 입금액 */
		     , NVL(T18.LWM_RCGN_AMT,0) + NVL(T18.LWM_DLVYFE,0) + NVL(T18.LWM_ENFORC_CS_AMT,0) + NVL(T18.LWM_PESU_PRCS_CS_AMT,0) - NVL(T18.LWM_DP_AMT, 0) AS LWSC_BLAM /* 소송비 잔액 */
		     , NVL(T19.UC_AMT,0) AS UC_AMT /* 미수금합산 */
		  FROM TB_CBBO_BND_CNSL_BAS_IZ T1 /* 채권상담기본내역 */
		  LEFT OUTER JOIN TB_CUBS_CST_BAS T2 /* 고객기본 */
		    ON T1.CST_NO = T2.CST_NO
		  LEFT OUTER JOIN TB_FEDD_BU_NOTI_RGST_BAS T3 /* 부담통보등록기본 */
		    ON T1.CNTR_NO = T3.CNTR_NO
		   AND T1.CNTR_SN = T3.CNTR_SN 
		  LEFT OUTER JOIN (
		                    SELECT CR.CNTR_ADRPC_ID
		                         , CR.DTL_CNTR_NO
		                         , CR.DTL_CNTR_SN
		                         , CB.LOCARA_TNO
		                         , CB.EXNO_ENCR
		                         , CB.IDV_TNO
		                         , CB.CRAL_LOCARA_TNO
		                         , CB.MEXNO_ENCR
		                         , CB.CRAL_IDV_TNO
		                         , CB.RCGVP_KNM
		                         , NVL(AB.NEW_ADR_ZIP, AB.OLD_ADR_ZIP) AS SPP_ZIP
		                         , NVL(AB.RNADR, AB.LTN_ADR) AS SPP_ADR
		                         , NVL(AB.RDADR, AB.LTN_DTL_ADR) AS SPP_DTL_ADR
		                      FROM TB_SSCT_CNTR_ADR_REL CR /* 계약주소관계 */
		                      LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS CB /* 계약주소지기본 */
		                        ON CB.CNTR_ADRPC_ID = CR.CNTR_ADRPC_ID
		                      LEFT OUTER JOIN TB_GBCO_ADR_BAS AB /* 주소기본 */
		                        ON AB.ADR_ID = CB.ADR_ID
		                     WHERE CR.ADRPC_TP_CD = '3'  /* 설치주소 */
		                       AND CR.DTA_DL_YN = 'N'
		                  ) T4
		    ON T1.CNTR_NO = T4.DTL_CNTR_NO
		   AND T1.CNTR_SN = T4.DTL_CNTR_SN
		  LEFT OUTER JOIN (
		                    SELECT CR.CNTR_ADRPC_ID /* 계약주소지ID */
		                         , CB.ADR_ID /* 주소ID */
		                         , CR.DTL_CNTR_NO /* 상세계약번호 */
		                         , CR.DTL_CNTR_SN /* 상세계약일련번호 */
		                         , CB.LOCARA_TNO /* 전화번호1 */
		                         , CB.EXNO_ENCR /* 전화번호2 */
		                         , CB.IDV_TNO /* 전화번호3 */
		                         , CB.CRAL_LOCARA_TNO /* 휴대전화번호1 */
		                         , CB.MEXNO_ENCR /* 휴대전화번호2 */
		                         , CB.CRAL_IDV_TNO /* 휴대전화번호3 */
		                         , NVL(AB.NEW_ADR_ZIP, AB.OLD_ADR_ZIP) AS SPP_ZIP /* 우편번호 */
		                         , NVL(AB.RNADR, AB.LTN_ADR) AS SPP_ADR /* 주소 */
		                         , NVL(AB.RDADR, AB.LTN_DTL_ADR) AS SPP_DTL_ADR /* 상세주소 */
		                      FROM TB_SSCT_CNTR_ADR_REL CR /* 계약주소관계 */
		                      LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS CB /* 계약주소지기본 */
		                        ON CB.CNTR_ADRPC_ID = CR.CNTR_ADRPC_ID
		                      LEFT OUTER JOIN TB_GBCO_ADR_BAS AB /* 주소기본 */
		                        ON AB.ADR_ID = CB.ADR_ID
		                     WHERE CR.ADRPC_TP_CD = '1'   /* 계약주소 */
		                       AND CR.DTA_DL_YN = 'N'
		                  ) T5
		    ON T1.CNTR_NO = T5.DTL_CNTR_NO
		   AND T1.CNTR_SN = T5.DTL_CNTR_SN
		  LEFT OUTER JOIN TB_SSCT_CNTR_DTL T7 /* 계약상세 */
		    ON T1.CNTR_NO = T7.CNTR_NO
		   AND T1.CNTR_SN = T7.CNTR_SN   
		  LEFT OUTER JOIN TB_PDBS_PD_BAS T6 /* 상품기본 */
		    ON T7.BASE_PD_CD = T6.PD_CD
		  LEFT OUTER JOIN (
		                    SELECT TB1.CNTR_NO
		                         , TB1.CNTR_RCP_FSH_DTM
		                         , TB1.CNTR_CAN_DTM
		                         , TB2.CLTN_DT
		                      FROM TB_SSCT_CNTR_BAS TB1 /* 계약기본 */
		                      LEFT OUTER JOIN TB_OGBS_PRTNR_DTL TB2 /* 파트너기본 */
		                        ON TB1.SELL_PRTNR_NO = TB2.PRTNR_NO
		                        WHERE ROWNUM = 1
		                  ) T8
		    ON T1.CNTR_NO = T8.CNTR_NO
		  LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T9 /* 계약WELLS상세 */
		    ON T1.CNTR_NO = T9.CNTR_NO
		   AND T1.CNTR_SN = T9.CNTR_SN  
		  LEFT JOIN (
		              SELECT T1.BASE_YM
		                   , T1.BASE_YM || T5.MPY_BSDT AS FNT_STPL_DT --이체예정일자
		                   , T5.MPY_BSDT --이체약정일
		                   , CASE WHEN T7.FNT_DV_CD = '01' THEN F_CMZ_CD_NM('TNT_WELLS', 'BNK_CD', T5.BNK_CD)
		                          WHEN T7.FNT_DV_CD = '02' THEN F_CMZ_CD_NM('TNT_WELLS', 'CDCO_CD', T5.CDCO_CD)
		                      END AS BNK_NM --은행명(자동이체방식)
		                   , CASE WHEN T7.FNT_DV_CD = '01' THEN T5.ACNO_ENCR
		                          WHEN T7.FNT_DV_CD = '02' THEN T5.CRCDNO_ENCR
		                      END AS AFTN_NO --계좌번호암호화(자동이체 번호)
		                   , T1.CNTR_NO  
		                   , T1.CNTR_SN
		                FROM TB_CBBO_BND_CNSL_BAS_IZ T1
		                LEFT JOIN TB_SSCT_CNTR_STLM_REL T4 ON T4.DTL_CNTR_NO = T1.CNTR_NO AND T4.DTL_CNTR_SN = T1.CNTR_SN AND T4.DTA_DL_YN = 'N'
		                LEFT JOIN TB_SSCT_CNTR_STLM_BAS T5 ON T5.CNTR_STLM_ID = T4.CNTR_STLM_ID
		                LEFT JOIN TB_RVCL_BIL_PLAN_BAS T7 ON T7.BIL_YM = T1.BASE_YM AND T7.CNTR_NO = T1.CNTR_NO AND T7.CNTR_SN = T1.CNTR_SN
		     ) T10
		    ON T10.CNTR_NO = T1.CNTR_NO AND T10.CNTR_SN = T1.CNTR_SN
		  LEFT OUTER JOIN ( 
		                   SELECT CNTR_NO
		                        , CST_NO
		                        , DP_TP_CD
		                        , MPY_BSDT
		                     FROM TB_SSCT_CNTR_STLM_BAS 
		                     WHERE (DP_TP_CD = '0102' OR DP_TP_CD = '0203')
		     ) T11
		    ON T1.CNTR_NO = T11.CNTR_NO 
		   AND T1.CST_NO = T11.CST_NO  
		  LEFT OUTER JOIN (
		                    SELECT TB1.CNTR_NO
		                         , TB2.CRAL_LOCARA_TNO
		                         , TB2.MEXNO_ENCR
		                         , TB2.CRAL_IDV_TNO
		                         , TB2.PRTNR_KNM
		                      FROM TB_SSCT_CNTR_BAS TB1 /* 계약기본 */
		                      INNER JOIN TB_OGBS_PRTNR_BAS TB2 /* 파트너기본 */
		                        ON TB1.SELL_PRTNR_NO = TB2.PRTNR_NO
		                  ) T12
		    ON T1.CNTR_NO = T12.CNTR_NO
		   LEFT OUTER JOIN (
		                    SELECT B1.CNTR_NO /*계약번호*/
		                         , B4.PRTNR_KNM /*지국장명*/
		                         , B4.CRAL_LOCARA_TNO /*지국장휴대전화번호 앞*/
		                         , B4.MEXNO_ENCR /*지국장휴대전화번호 중간*/
		                         , B4.CRAL_IDV_TNO /*지국장휴대전화번호 뒤*/
		                         , B5.CLTN_DT /*지국장 해약일자*/
		                        FROM TB_SSCT_CNTR_BAS B1/*계약기본*/
		                       INNER JOIN TB_OGBS_PRTNR_BAS B2/*파트너기본*/ ON B1.SELL_OG_TP_CD = B2.OG_TP_CD AND B1.SELL_PRTNR_NO = B2.PRTNR_NO
		                       INNER JOIN TB_OGBS_OG_BAS B3/*조직기본*/ ON B3.OG_ID = B2.OG_ID
		                       INNER JOIN TB_OGBS_PRTNR_BAS B4/*파트너기본*/ ON B4.OG_TP_CD = B3.HOO_OG_TP_CD AND B4.PRTNR_NO = B3.HOO_PRTNR_NO
		                       INNER JOIN TB_OGBS_PRTNR_DTL B5/*파트너상세*/ ON B5.OG_TP_CD = B4.OG_TP_CD AND B5.PRTNR_NO = B4.PRTNR_NO 
		                  ) T13
		    ON T1.CNTR_NO = T13.CNTR_NO
		  LEFT OUTER JOIN (
		                    SELECT TB1.CNTR_NO
		                         , TB4.BLD_CD
		                         , TB4.BLD_NM
		                      FROM TB_SSCT_CNTR_BAS TB1 /* 계약기본 */
		                      LEFT OUTER JOIN TB_OGBS_PRTNR_BAS TB2 /* 파트너기본 */
		                        ON TB1.SELL_PRTNR_NO = TB2.PRTNR_NO
		                      LEFT OUTER JOIN TB_OGBS_OG_BAS TB3 /* 조직기본 */
		                        ON TB2.OG_TP_CD = TB3.OG_TP_CD
		                       AND TB2.OG_ID = TB3.OG_ID
		                      LEFT OUTER JOIN TB_OGBS_BLD_BAS TB4 /* 빌딩기본 */
		                        ON TB3.OG_TP_CD = TB4.OG_TP_CD
		                       AND TB3.BLD_CD = TB4.BLD_CD
		                  ) T14
		    ON T1.CNTR_NO = T14.CNTR_NO
		  LEFT JOIN (
		              SELECT ROW_NUMBER() OVER(PARTITION BY CST_NO, CNTR_NO, CNTR_SN ORDER BY VAC_IS_DTL_SN DESC) AS RN
		                   , CST_NO
		                   , CNTR_NO 
		                   , CNTR_SN
		                   , (SELECT TT3.FNIT_NM FROM TB_RVDW_FNIT_CD TT3 WHERE FNIT_DV_CD = '1' AND TT3.FNIT_CD = TT2.VAC_BNK_CD) || ' : ' || TT2.VAC_NO AS VAC_NO
		                FROM TB_RVDW_VAC_IS_DTL TT1
		               INNER JOIN TB_RVDW_VAC_BAS TT2 
		                  ON TT2.VAC_IS_ID = TT1.VAC_IS_ID 
		                 AND TT2.VAC_IS_DV_CD = '5'/*가상계좌발급구분코드 = 연체집금용*/ 
		                 AND TT2.VAC_STAT_CD = '1'/*가상계좌상태코드 = 할당*/
		     ) T15
		    ON T15.RN = 1 AND T15.CST_NO = T1.CST_NO AND T15.CNTR_NO = T1.CNTR_NO AND T15.CNTR_SN = T1.CNTR_SN 
		  LEFT OUTER JOIN (
		                    SELECT TB1.CST_NO
		                         , TB1.CNTR_NO
		                         , TB1.CNTR_SN
		                         , TB1.DFLT_DT
		                         , TB1.LWM_MO_CN
		                      FROM TB_CBBO_BND_LWM_IZ TB1 /* 채권법조치내역 */
		                     WHERE ROWNUM = 1
		                     ORDER BY TB1.FST_RGST_DTM DESC  
		                  ) T16
		    ON T1.CST_NO = T16.CST_NO
		   AND T1.CNTR_NO = T16.CNTR_NO
		   AND T1.CNTR_SN = T16.CNTR_SN 
		  LEFT OUTER JOIN (
		                   SELECT BND_CLN_PSBL_DV_CD
		                        , CST_NO
		                        , BND_CLN_PRCS_DV_CD
		                        , FST_RGST_DTM
		                     FROM TB_CBBO_BND_TEL_CNSL_IZ  /* 채권전화상담내역 */
		                    WHERE ROWNUM= 1
		                    ORDER BY FST_RGST_DTM DESC 
		                ) T17
		    ON T1.CST_NO = T17.CST_NO
		  LEFT OUTER JOIN (
		                    SELECT * FROM (
		                                   SELECT ROW_NUMBER() OVER(PARTITION BY TB2.CST_NO ORDER BY TB2.CST_NO) AS RN
		                                        , TB2.CST_NO
		                                        , SUM(LWM_RCGN_AMT) OVER(PARTITION BY TB2.CST_NO) AS LWM_RCGN_AMT
		                                        , SUM(LWM_DLVYFE) OVER(PARTITION BY TB2.CST_NO) AS LWM_DLVYFE
		                                        , SUM(LWM_ENFORC_CS_AMT) OVER(PARTITION BY TB2.CST_NO) AS LWM_ENFORC_CS_AMT
		                                        , SUM(LWM_PESU_PRCS_CS_AMT) OVER(PARTITION BY TB2.CST_NO) AS LWM_PESU_PRCS_CS_AMT
		                                        , SUM(LWM_DP_AMT) OVER(PARTITION BY TB2.CST_NO, TB2.CNTR_NO) AS LWM_DP_AMT
		                                     FROM (
		                                           SELECT TB1.CST_NO
		                                                , TB1.CNTR_NO
		                                                , TB1.CNTR_SN
		                                                , CASE WHEN TB1.LWM_PESU_PRCS_CS_AMT > 1 THEN 0 ELSE TB1.LWM_RCGN_AMT END LWM_RCGN_AMT         /*인지금액*/
		                                                , CASE WHEN TB1.LWM_PESU_PRCS_CS_AMT > 1 THEN 0 ELSE TB1.LWM_DLVYFE END LWM_DLVYFE             /*송달료*/
		                                                , TB1.LWM_ENFORC_CS_AMT         /*개문집행비용금액*/
		                                                , TB1.LWM_PESU_PRCS_CS_AMT     /*독촉절차비용금액*/
		                                                , TB1.LWM_DP_AMT            /*입금금액*/
		                                             FROM TB_CBBO_BND_LWM_IZ TB1 /* 채권법조치내역 */
		                                        ) TB2
		                                )
		                            WHERE RN = 1 /*고객번호,계약번호,계약일련번호 당 한건만*/
		                ) T18
		    ON T1.CST_NO = T18.CST_NO
		 INNER JOIN TB_CBBO_BND_CNTR_BAS T19 /*채권계약기본*/
		    ON T19.BASE_YM = T1.BASE_YM 
		   AND T19.CNTR_NO = T1.CNTR_NO 
		   AND T19.CNTR_SN = T1.CNTR_SN 
		 WHERE 1=1
           AND T1.CST_NO = #{schCstNo}
           AND T1.CNTR_NO = #{schCntrNo} 
           AND T1.CNTR_SN = #{schCntrSn}
           AND ROWNUM = 1
    </select>
    
    <select id="selectCustomerDetails" resultType="com.kyowon.sms.wells.web.bond.consultation.dto.WbncCustomerDto$FindCustomerDetailRes">
        SELECT MAX(MPY_BSDT) AS MPY_BSDT /* 이체 */
		     , MAX(SELL_TP_CD) AS SELL_TP_CD /* 업무구분 */
		     , MAX(SELL_TP_NM) AS SELL_TP_NM   /*상품구분*/
		     , MAX(PRDF) AS PRDF /* 제품군 */
		     , MAX(PD_NM) AS PD_NM /* 상품명 */
		     , MAX(CNTR_NO) AS CNTR_NO /* 계약번호 */
		     , MAX(CNTR_SN) AS CNTR_SN /* 계약일련번호 */
		     , CST_NO /* 고객번호 */
		     , MAX(CST_KNM) AS CST_KNM /* 고객명 */
		     , MAX(DLQ_MCN) AS DLQ_MCN /* 연체개월 */
		     , MAX(CNTR_RSG_DT) AS CNTR_RSG_DT /* 직권해지일자 */
		     , MAX(OJ_AMT) AS OJ_AMT /* 대상금액 */ 
		     , MAX(OJ_DP) AS OJ_DP /* 대상입금 */ 
		     , MAX(OJ_BLAM) AS OJ_BLAM /* 대상금액 - 대상입금 = 대상잔액 */ 
		     , MAX(TOT_DLQ_AMT) AS TOT_DLQ_AMT /* 연체금액 + 연체가산금 = 총연체금 */
		     , MAX(TOT_DLQ_DP) AS TOT_DLQ_DP /* 연체입금금액 + 연체가산금입금금액 = 총연체입금 */
		     , MAX(TOT_DLQ_BLAM) AS TOT_DLQ_BLAM /* 총연체금 - 총연체입금 = 총연체잔액 */
		     , MAX(MM_CHRAM_AMT) AS TOT_DLQ_BLAM /* 월요금액 */      
		     , MAX(MM_CHRAM_DP) AS TOT_DLQ_BLAM /* 월요금입금 */       
		     , MAX(MM_CHRAM_BLAM ) AS MM_CHRAM_BLAM/* 당월요금금액 - 당월요금입금금액 = 월요금잔액 */      
		     , MAX(DLQ_ADD_AMT) AS DLQ_ADD_AMT /* 연체가산금액 */       
		     , MAX(DLQ_ADD_DP) AS DLQ_ADD_DP /* 연체가산입금 */     
		     , MAX(DLQ_ADAMT_BLAM) AS  DLQ_ADAMT_BLAM/* 연체가산금액 - 연체가산금입금금액 = 연체가산금잔액 */ 
		     , MAX(SV_CS) AS SV_CS /* 서비스비용 */
		     , MAX(SV_DP) AS SV_DP /* 서비스입금 */
		     , MAX(SV_BLAM) AS SV_BLAM /* 서비스잔액 */
		     , MAX(UC_AMT) AS UC_AMT /* 미수금액 */       
		     , MAX(UC_DP) AS UC_DP /* 미수입금 */  
		     , MAX(UC_BLAM) AS UC_BLAM /* 미수금 - 총입금액 = 미수잔액 */ 
		     , MAX(TOT_DP_AMT) AS TOT_DP_AMT /* 연체입금금액 + 연체가산입금금액 + 해지위약금입금금액 + 당월요금입금금액 = 총입금액 */ 
		     , MAX(SPMT_SL) AS SPMT_SL /* 추가매출 */  
		     , MAX(LS_RNTF) AS LS_RNTF /* 분실손료 */ 
		     , MAX(VT_AC_DV) AS VT_AC_DV /* 가상계좌구분 */  
		     , MAX(VT_AC_BNK) AS VT_AC_BNK /* 가상계좌은행 */ 
		     , MAX(VT_AC_NO) AS VT_AC_NO /* 가상계좌번호 */ 
		     , MAX(CCAM) AS CCAM /* 위약금 */ 
		     , MAX(LSFE) AS LSFE /* 분실료 */ 
		     , MAX(RTLFE1) AS RTLFE1 /* 렌탈료1 */        
		     , MAX(RTLFE_ISTM1) AS RTLFE_ISTM1 /* 렌탈료1할 */       
		     , MAX(RTLFE2) AS RTLFE2   /* 렌탈료2 */        
		     , MAX(RTLFE_ISTM2) AS RTLFE_ISTM2 /* 렌탈료2할 */  
		     , MAX(DPR_NM) AS DPR_NM /* 입금자 */  
		     , MAX(CLCTAM_PRTNR_NO) AS CLCTAM_PRTNR_NO /* 집금번호 */
		     , MAX(CLCTAM_ICHR) AS CLCTAM_ICHR   /* 집급담당 */
		     , MAX(TF_DT) AS TF_DT /* 이관일자 */
		     , MAX(SFK) AS SFK /* 세이프키 */
		     , MAX(BND_BIZ_DV_CD) AS BND_BIZ_DV_CD /* 채권업무구분코드 */
		  FROM(
		        SELECT T2.MPY_BSDT /* 이체 */
		             , T4.SELL_TP_CD /* 업무구분 */
		             , (CASE WHEN 'TNT_WELLS' = 'TNT_EDU' 
		                     THEN (CASE WHEN T4.SELL_TP_CD = '1' THEN '전집' ELSE '학습지' END)
		                     WHEN 'TNT_WELLS' = 'TNT_WELLS' 
		                     THEN (SELECT CD_CNTN
		                             FROM T_CMZ_CD_D
		                            WHERE 1=1
		                              AND TENANT_ID = 'TNT_WELLS'
		                              AND CD_ID = 'SELL_TP_CD'
		                              AND CD_VLD_VAL = T4.SELL_TP_CD) END) AS SELL_TP_NM   /*상품구분*/
		             , '' AS PRDF /* 제품군 */
		             , T5.PD_NM /* 상품명 */
		             , T1.CNTR_NO /* 계약번호 */
		             , T1.CNTR_SN /* 계약일련번호 */
		             , T1.CST_NO /* 고객번호 */
		             , T6.CST_KNM /* 고객명 */
		             , T7.DLQ_MCN /* 연체개월 */
		             , '' AS CNTR_RSG_DT /* 직권해지일자 */
		             , NVL(0, 0) AS OJ_AMT /* 대상금액 */ 
		             , NVL(0, 0) AS OJ_DP /* 대상입금 */ 
		             , NVL(0, 0) - NVL(0, 0) AS OJ_BLAM /* 대상금액 - 대상입금 = 대상잔액 */ 
		             , T7.DLQ_AMT + T7.DLQ_ADD_AMT AS TOT_DLQ_AMT /* 연체금액 + 연체가산금 = 총연체금 */
		             , T7.DLQ_DP_AMT + T7.DLQ_ADD_DP_AMT AS TOT_DLQ_DP /* 연체입금금액 + 연체가산금입금금액 = 총연체입금 */
		             , (T7.DLQ_AMT + T7.DLQ_ADD_AMT) - (T7.DLQ_DP_AMT + T7.DLQ_ADD_DP_AMT) AS TOT_DLQ_BLAM /* 총연체금 - 총연체입금 = 총연체잔액 */
		             , T7.THM_CHRAM_AMT AS MM_CHRAM_AMT /* 월요금액 */      
		             , T7.THM_CHRAM_DP_AMT AS MM_CHRAM_DP /* 월요금입금 */       
		             , T7.THM_CHRAM_AMT - T7.THM_CHRAM_DP_AMT AS MM_CHRAM_BLAM /* 당월요금금액 - 당월요금입금금액 = 월요금잔액 */      
		             , T7.DLQ_ADD_AMT AS DLQ_ADD_AMT /* 연체가산금액 */       
		             , T7.DLQ_ADD_DP_AMT AS DLQ_ADD_DP /* 연체가산입금 */     
		             , T7.DLQ_ADD_AMT - T7.DLQ_ADD_DP_AMT AS DLQ_ADAMT_BLAM /* 연체가산금액 - 연체가산금입금금액 = 연체가산금잔액 */ 
		             , 0 AS SV_CS /* 서비스비용 */
		             , 0 AS SV_DP /* 서비스입금 */
		             , 0 AS SV_BLAM /* 서비스잔액 */
		             , T7.UC_AMT AS UC_AMT /* 미수금액 */       
		             , 0 AS UC_DP /* 미수입금 */  
		             , 0 AS UC_BLAM /* 미수금 - 총입금액 = 미수잔액 */ 
		             , 0 AS TOT_DP_AMT /* 연체입금금액 + 연체가산입금금액 + 해지위약금입금금액 + 당월요금입금금액 = 총입금액 */ 
		             , 0 AS SPMT_SL /* 추가매출 */  
		             , 0 AS LS_RNTF /* 분실손료 */ 
		             , '' AS VT_AC_DV /* 가상계좌구분 */  
		             , T9.VAC_BNK_CD AS VT_AC_BNK /* 가상계좌은행 */ 
		             , T9.VAC_NO AS VT_AC_NO /* 가상계좌번호 */ 
		             , 0 AS CCAM /* 위약금 */ 
		             , 0 AS LSFE /* 분실료 */ 
		             , 0 AS RTLFE1 /* 렌탈료1 */        
		             , 0 AS RTLFE_ISTM1 /* 렌탈료1할 */       
		             , 0 AS RTLFE2 /* 렌탈료2 */        
		             , 0 AS RTLFE_ISTM2 /* 렌탈료2할 */  
		             , T8.DPR_NM /* 입금자 */  
		             , T1.CLCTAM_PRTNR_NO /* 집금번호 */
		             , ( SELECT PRTNR_KNM
		                   FROM TB_OGBS_PRTNR_BAS
		                  WHERE PRTNR_NO = T1.CLCTAM_PRTNR_NO
		               ) AS CLCTAM_ICHR   /* 집급담당 */
		             , T1.BND_TF_DT AS TF_DT /* 이관일자 */
		             , T6.SFK_VAL AS SFK /* 세이프키 */
		             , T1.BND_BIZ_DV_CD /* 채권업무구분코드 */
		          FROM TB_CBBO_BND_CNSL_BAS_IZ T1 /* 채권상담기본내역 */ 
		         LEFT OUTER JOIN (
		                            SELECT CST_NO
		                                 , MPY_BSDT
		                              FROM TB_SSCT_CNTR_STLM_BAS/* 계약결제기본 */
		                             WHERE ROWNUM = 1
		                          ) T2  
		            ON T1.CST_NO = T2.CST_NO  
		         LEFT OUTER JOIN TB_SSCT_CNTR_DTL T4 /* 계약상세 */
		            ON T1.CNTR_NO = T4.CNTR_NO
		           AND T1.CNTR_SN = T4.CNTR_SN   
		         LEFT OUTER JOIN TB_PDBS_PD_BAS T5 /* 상품기본 */
		            ON T4.BASE_PD_CD = T5.PD_CD
		         INNER JOIN TB_CUBS_CST_BAS T6 /* 고객기본 */
		            ON T1.CST_NO = T6.CST_NO
		         INNER JOIN TB_CBBO_BND_CNTR_BAS T7 /* 채권계약기본 */
		            ON T1.CNTR_NO = T7.CNTR_NO
		           AND T1.CNTR_SN = T7.CNTR_SN
		         LEFT OUTER JOIN (
		                           SELECT CST_NO
		                                , DPR_NM
		                             FROM TB_CBBO_BND_TEL_CNSL_IZ  /* 채권전화상담내역 */
		                            WHERE ROWNUM= 1
		                            ORDER BY FST_RGST_DTM DESC 
		                         ) T8
		            ON T1.CST_NO = T8.CST_NO
		         LEFT OUTER JOIN TB_RVDW_VAC_IS_IZ T9 /* 가상계좌발급내역 */
		            ON T1.CST_NO = T9.VAC_IS_CST_NO
		         WHERE 1=1
		           AND T1.CST_NO = #{schCstNo}
		      ) 
		 WHERE 1=1
		 GROUP BY CST_NO
    </select>
    
    <select id="selectUnusualArticles" resultType="com.kyowon.sms.wells.web.bond.consultation.dto.WbncCustomerDto$FindUnusualArticlesRes">
        SELECT CNSL_UNUITM_CN
		     , ROWNUM
		  FROM (
		        SELECT CNSL_UNUITM_CN
		             , ROWNUM
		          FROM TB_CBBO_BND_UNUITM_CVCP_DTL
		         WHERE 1=1 
		           AND CST_NO = #{schCstNo}
		           AND CNTR_NO = #{schCntrNo} 
		           AND CNTR_SN = #{schCntrSn}
		         ORDER BY FST_RGST_DTM DESC  
		     )
		 WHERE 1=1
		   AND ROWNUM = 1
    </select>
    
    <insert id="mergeUnuitmCn">
        MERGE INTO TB_CBBO_BND_UNUITM_CVCP_DTL T1    /* 채권특이사항민원상세 */
        USING ( SELECT #{cstNo} AS CST_NO            /* 고객번호 */
                     , #{cntrNo} AS CNTR_NO          /* 계약번호 */
                     , #{cntrSn} AS CNTR_SN          /* 계약일련번호 */
                  FROM DUAL ) T2
           ON (
                       T1.CST_NO = T2.CST_NO         /* 고객번호 */
                   AND T1.CNTR_NO = T2.CNTR_NO       /* 계약번호 */
                   AND T1.CNTR_SN = T2.CNTR_SN       /* 계약일련번호 */
              )
         WHEN MATCHED THEN
       UPDATE SET CNSL_UNUITM_CN = #{cnslUnuitmCn}
         <include refid="COMMON.updateSystemField"/>
         WHEN NOT MATCHED THEN
           INSERT (
                  BND_UNUITM_ID
                , BND_CNTR_TP_CD
                , BND_BIZ_DV_CD
                , CST_NO
                , CNTR_NO
                , CNTR_SN
                , CLCTN_OJ_OG_TP_CD
                , CLCTN_OJ_PRTNR_NO
                , CNSL_UNUITM_CN
                , CVCP_CN
                , DTA_DL_YN
                <include refid="COMMON.insertSystemField"/>
           ) VALUES (
                  ( SELECT TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDhh24miss') || LPAD((SELECT COUNT(1) FROM TB_CBBO_BND_UNUITM_CVCP_DTL WHERE SUBSTR(FST_RGST_DTM, 0,8) = TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD'))+1, 6, '0')
                      FROM DUAL)
                , #{bndCntrTpCd}
                , #{bndBizDvCd}
                , #{cstNo}
                , #{cntrNo}
                , #{cntrSn}
                , #{clctnOjOgTpCd}
                , #{clctnOjPrtnrNo}
                , #{cnslUnuitmCn}
                , #{cvcpCn}
                , 'N'
                <include refid="COMMON.insertSystemFieldValue" />  )
    </insert>
    
    <insert id="insertCounsel">
        INSERT INTO TB_CBBO_BND_TEL_CNSL_IZ ( /* 채권전화상담내역 */
               TEL_CNSL_ID
             , BND_CNTR_TP_CD
             , BND_BIZ_DV_CD
             , CST_NO
             , CNTR_NO
             , CNTR_SN
             , CLCTN_OJ_OG_TP_CD
             , CLCTN_OJ_PRTNR_NO
             , CLCTN_OJ_PRTNR_BZRNO
             , CLCTAM_PRTNR_NO
             , TEL_CNSL_PH_CD
             , BND_CNSL_MTR_DV_CD
             , TEL_CNSL_RS_CD
             , CNSL_CST_PRP_CD
             , TEL_CNSL_CN
             , BND_CLN_PSBL_DV_CD
             , BND_CNSL_CST_STAT_CD
             , BND_CLN_PRCS_DV_CD
             , DPR_NM
             , RDG_ID
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField" /> )
        VALUES (
               ( SELECT TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDhh24miss') || LPAD((SELECT COUNT(1) FROM TB_CBBO_BND_TEL_CNSL_IZ WHERE SUBSTR(FST_RGST_DTM, 0,8) = TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD'))+1, 6, '0')
                   FROM DUAL )
             , #{bndCntrTpCd}
             , #{bndBizDvCd}
             , #{cstNo}
             , #{cntrNo}
             , #{cntrSn}
             , #{clctnOjOgTpCd}
             , #{clctnOjPrtnrNo}
             , #{clctnOjPrtnrBzrno}
             , #{clctamPrtnrNo}
             , #{telCnslPhCd}
             , #{bndCnslMtrDvCd}
             , #{telCnslRsCd}
             , #{cnslCstPrpCd}
             , #{telCnslCn}
             , #{bndClnPsblDvCd}
             , #{bndCnslCstStatCd}
             , #{bndClnPrcsDvCd}
             , #{dprNm}
             , #{rdgId}
             , 'N'
             <include refid="COMMON.insertSystemFieldValue" /> 
             )
    </insert>
    
    <insert id="insertPromise">
        INSERT INTO TB_CBBO_BND_CNSL_PROM_BOO_IZ ( /* 채권상담약속예약내역 */
               PROM_BOO_ID
             , BND_CNTR_TP_CD
             , BND_BIZ_DV_CD
             , CST_NO
             , CNTR_NO
             , CNTR_SN
             , CLCTN_OJ_OG_TP_CD
             , CLCTN_OJ_PRTNR_NO
             , CLCTN_OJ_PRTNR_BZRNO
             , PROM_DT
             , PROM_HH
             , CLCTAM_PROM_TP_CD
             , CLN_PROM_AMT
             , PROM_CN
             , PROM_FSH_YN
             , DTA_DL_YN 
             <include refid="COMMON.insertSystemField" /> )
        VALUES (
               ( SELECT TO_CHAR(SYSTIMESTAMP, 'YYYYMMDDhh24miss') || LPAD((SELECT COUNT(1) FROM TB_CBBO_BND_CNSL_PROM_BOO_IZ  WHERE SUBSTR(FST_RGST_DTM, 0,8) = TO_CHAR(SYSTIMESTAMP, 'YYYYMMDD'))+1, 6, '0')
                   FROM DUAL )
             , #{bndCntrTpCd}
             , #{bndBizDvCd}
             , #{cstNo}
             , #{cntrNo}
             , #{cntrSn}
             , #{clctnOjOgTpCd}
             , #{clctnOjPrtnrNo}
             , #{clctnOjPrtnrBzrno}
             , NVL(#{promDt},' ')
             , NVL(RPAD(#{promHh},6,'0'),'')
             , #{promTp}
             , NVL(#{promAmt}, '0')
             , #{promCn}
             , #{promFshYn}
             , 'N'
             <include refid="COMMON.insertSystemFieldValue" /> 
             )
    </insert>
    
    <select id="selectCounselHistorys" resultType="com.kyowon.sms.wells.web.bond.consultation.dto.WbncCustomerDto$FindCounselHistoryRes">
        SELECT T1.TEL_CNSL_ID
             , T1.FST_RGST_DTM AS IN_DT
             , (SELECT EPNO FROM T_CMP_USR_ACO_M WHERE USR_ID = T1.FST_RGST_USR_ID AND DEL_YN = 'N' ) AS IN_ICHR
             , (SELECT USR_NM FROM T_CMP_USR_ACO_M WHERE USR_ID = T1.FST_RGST_USR_ID AND DEL_YN = 'N') AS IN_ICHR_NM
             , F_CMZ_CD_NM(#{session.tenantId}, 'TEL_CNSL_PH_CD', T1.TEL_CNSL_PH_CD) AS CNSL_PH  
             , F_CMZ_CD_NM(#{session.tenantId}, 'TEL_CNSL_RS_CD', T1.TEL_CNSL_RS_CD) AS CRNCY_RS
             , DPR_NM AS DPR_NM
             , TEL_CNSL_CN AS CNSL_CN
          FROM TB_CBBO_BND_TEL_CNSL_IZ T1
         WHERE T1.CST_NO = #{schCstNo}
           AND T1.CNTR_NO = #{schCntrNo} 
           AND T1.CNTR_SN = #{schCntrSn}
    </select>
</mapper>
