<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.bond.consultation.mapper.WbncCustomerSearchMapper">
    <!-- 고객찾기 -->
    <select id="selectCustomers" resultType="com.kyowon.sms.wells.web.bond.consultation.dto.WbncCustomerSearchDto$SearchRes">
        SELECT BND_BIZ_DV_CD
             , BND_BIZ_DV_NM
             , CNTR_NO
             , CNTR_SN
             , CST_KNM
             , CLCTAM_PRTNR_NO
             , PRTNR_KNM
             , CST_NO
             , SPP_ZIP
             , SPP_ADR
             , SPP_DTL_ADR
             , ADR
             , CNTR_LOCARA_TNO
             , CNTR_EXNO_ENCR
             , CNTR_IDV_TNO
             , CNTR_CRAL_LOCARA_TNO
             , CNTR_MEXNO_ENCR
             , CNTR_CRAL_IDV_TNO
             , IST_LOCARA_TNO
             , IST_EXNO_ENCR
             , IST_IDV_TNO
             , IST_CRAL_LOCARA_TNO
             , IST_MEXNO_ENCR
             , IST_CRAL_IDV_TNO
             , SFK_VAL
             , BND_CLCTN_PRP_DV_CD
             , BND_CLCTN_PRP_DV_NM
             , BND_CLCTN_PRP_RSON_CD
             , BND_CLCTN_PRP_RSON_NM
          FROM
             (
              SELECT T1.BND_BIZ_DV_CD    /* 채권업무구분코드 */
                   , F_CMZ_CD_NM('TNT_WELLS', 'BND_BIZ_DV_CD', T1.BND_BIZ_DV_CD) AS BND_BIZ_DV_NM  /* 채권업무구분코드명 */
                   , T1.CNTR_NO  /* 계약번호 */
                   , T1.CNTR_SN  /* 계약일련번호 */
                   , T1.CST_NM AS CST_KNM  /* 고객명 */
                   , T1.CLCTAM_PRTNR_NO /* 집급담당파트너번호 */
                   , (SELECT PRTNR_KNM FROM TB_CBBO_CLCTAM_PRTNR_DTL WHERE PRTNR_NO = T1.CLCTAM_PRTNR_NO AND DTA_DL_YN = 'N') AS PRTNR_KNM  /* 집급담당파트너명 */
                   , T1.CST_NO /* 고객번호 */
                   , T3.SPP_ZIP /* 계약처우편번호 */
                   , T3.SPP_ADR /* 계약처기본주소 */
                   , T3.SPP_DTL_ADR /* 계약처상세주소 */
                   , T3.SPP_ADR || ' ' || T3.SPP_DTL_ADR AS ADR /* 주소 */
                   , T3.LOCARA_TNO AS CNTR_LOCARA_TNO /* 계약처지역전화번호 */
                   , T3.EXNO_ENCR AS CNTR_EXNO_ENCR /* 계약처전화국번호암호화 */
                   , T3.IDV_TNO AS CNTR_IDV_TNO   /* 계약처개별전화번호 */
                   , T3.CRAL_LOCARA_TNO AS CNTR_CRAL_LOCARA_TNO  /* 계약처휴대지역전화번호 */
                   , T3.MEXNO_ENCR  AS CNTR_MEXNO_ENCR           /* 계약처휴대전화국번호암호화 */
                   , T3.CRAL_IDV_TNO  AS CNTR_CRAL_IDV_TNO       /* 계약처휴대개별전화번호 */
                   , T4.LOCARA_TNO AS IST_LOCARA_TNO   /* 설치처지역전화번호 */
                   , T4.EXNO_ENCR AS IST_EXNO_ENCR     /* 설치처전화국번호암호화 */
                   , T4.IDV_TNO AS IST_IDV_TNO         /* 설치처개별전화번호 */
                   , T4.CRAL_LOCARA_TNO AS IST_CRAL_LOCARA_TNO   /* 설치처휴대지역전화번호 */
                   , T4.MEXNO_ENCR AS IST_MEXNO_ENCR             /* 설치처휴대전화국번호암호화 */
                   , T4.CRAL_IDV_TNO AS IST_CRAL_IDV_TNO         /* 설치처휴대개별전화번호 */
                   , T2.SFK_VAL  /* 세이프키*/
                   , T1.BND_CLCTN_PRP_DV_CD  /* 채권속성코드 */
                   , F_CMZ_CD_NM('TNT_WELLS', 'BND_CLCTN_PRP_DV_CD', T1.BND_CLCTN_PRP_DV_CD) AS BND_CLCTN_PRP_DV_NM  /* 채권속성명 */
                   , T1.BND_CLCTN_PRP_RSON_CD  /* 속성사유코드 */
                   , F_CMZ_CD_NM('TNT_WELLS', 'BND_CLCTN_PRP_RSON_CD', T1.BND_CLCTN_PRP_RSON_CD) AS BND_CLCTN_PRP_RSON_NM  /* 속성사유명 */
                FROM TB_CBBO_BND_CNTR_BAS T1
                LEFT OUTER JOIN TB_CUBS_CST_BAS T2
                  ON T2.CST_NO = T1.CST_NO
                LEFT OUTER JOIN (
		                          SELECT CR.CNTR_ADRPC_ID
		                                 , CR.DTL_CNTR_NO
		                                 , CR.DTL_CNTR_SN
		                                 , CB.LOCARA_TNO
		                                 , CB.EXNO_ENCR
		                                 , CB.IDV_TNO
		                                 , CB.CRAL_LOCARA_TNO
		                                 , CB.MEXNO_ENCR
		                                 , CB.CRAL_IDV_TNO
		                                 , NVL(AB.NEW_ADR_ZIP, AB.OLD_ADR_ZIP) AS SPP_ZIP
		                                 , NVL(AB.RNADR, AB.LTN_ADR) AS SPP_ADR
		                                 , NVL(AB.RDADR, AB.LTN_DTL_ADR) AS SPP_DTL_ADR
		                              FROM TB_SSCT_CNTR_ADR_REL CR /* 계약주소관계 */
		                              LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS CB /* 계약주소지기본 */
		                                ON CB.CNTR_ADRPC_ID = CR.CNTR_ADRPC_ID
		                              LEFT OUTER JOIN TB_GBCO_ADR_BAS AB /* 주소기본 */
		                                ON AB.ADR_ID = CB.ADR_ID
		                             WHERE CR.CNTR_UNIT_TP_CD = '020'
		                               AND CR.ADRPC_TP_CD = '1'  /* 계약주소 */
		                               AND CR.DTA_DL_YN = 'N'
		             ) T3
		            ON T1.CNTR_NO = T3.DTL_CNTR_NO
		           AND T1.CNTR_SN = T3.DTL_CNTR_SN
                LEFT OUTER JOIN (
		                            SELECT CR.CNTR_ADRPC_ID
		                                 , CR.DTL_CNTR_NO
		                                 , CR.DTL_CNTR_SN
		                                 , CB.LOCARA_TNO
		                                 , CB.EXNO_ENCR
		                                 , CB.IDV_TNO
		                                 , CB.CRAL_LOCARA_TNO
		                                 , CB.MEXNO_ENCR
		                                 , CB.CRAL_IDV_TNO
		                                 , NVL(AB.NEW_ADR_ZIP, AB.OLD_ADR_ZIP) AS SPP_ZIP
		                                 , NVL(AB.RNADR, AB.LTN_ADR) AS SPP_ADR
		                                 , NVL(AB.RDADR, AB.LTN_DTL_ADR) AS SPP_DTL_ADR
		                              FROM TB_SSCT_CNTR_ADR_REL CR /* 계약주소관계 */
		                              LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS CB /* 계약주소지기본 */
		                                ON CB.CNTR_ADRPC_ID = CR.CNTR_ADRPC_ID
		                              LEFT OUTER JOIN TB_GBCO_ADR_BAS AB /* 주소기본 */
		                                ON AB.ADR_ID = CB.ADR_ID
		                             WHERE CR.CNTR_UNIT_TP_CD = '020'
		                               AND CR.ADRPC_TP_CD IN ('2','3')  /* 배송,설치주소 */
		                               AND CR.DTA_DL_YN = 'N'
		                          ) T4
		            ON T1.CNTR_NO = T4.DTL_CNTR_NO
		           AND T1.CNTR_SN = T4.DTL_CNTR_SN
               WHERE 1=1
                 AND T1.BASE_YM = (SELECT BASE_YM FROM (SELECT BASE_YM FROM TB_CBBO_BND_CNSL_BAS_IZ WHERE BND_CNTR_TP_CD = '01' ORDER BY BASE_YM DESC) WHERE ROWNUM = 1)
                 AND T1.BASE_YM = (SELECT BASE_YM FROM (SELECT BASE_YM FROM TB_CBBO_BND_CNSL_BAS_IZ WHERE BND_CNTR_TP_CD = '01' ORDER BY BASE_YM DESC) WHERE ROWNUM = 1)
                 <if test='@MybatisUtils@isNotEmpty(clctamPrtnrNo)'>
                 AND T1.CLCTAM_PRTNR_NO = #{clctamPrtnrNo}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(cstNo)'>
                 AND T1.CST_NO = #{cstNo}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(cstKnm)'>
                 AND T1.CST_NM = #{cstKnm}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(bndClctnPrpDvCd)'>
                 AND T1.BND_CLCTN_PRP_DV_CD = #{bndClctnPrpDvCd}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(bndClctnPrpRsonCd)'>
                 AND T1.BND_CLCTN_PRP_RSON_CD = #{bndClctnPrpRsonCd}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(cntrCralLocaraTno) and @MybatisUtils@isNotEmpty(cntrMexnoEncr) and @MybatisUtils@isNotEmpty(cntrCralIdvTno)'>
                 AND (T3.CRAL_LOCARA_TNO = #{cntrCralLocaraTno} AND T3.MEXNO_ENCR = #{cntrMexnoEncr} AND T3.CRAL_IDV_TNO = #{cntrCralIdvTno})
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(cntrLocaraTno) and @MybatisUtils@isNotEmpty(cntrExnoEncr) and @MybatisUtils@isNotEmpty(cntrIdvTno)'>
		         AND (T3.LOCARA_TNO = #{cntrLocaraTno} AND T3.EXNO_ENCR = #{cntrExnoEncr} AND T3.IDV_TNO = #{cntrIdvTno})
		         </if>
                 <if test='@MybatisUtils@isNotEmpty(istCralLocaraTno) and @MybatisUtils@isNotEmpty(istMexnoEncr) and @MybatisUtils@isNotEmpty(istCralIdvTno)'>
                 AND (T4.CRAL_LOCARA_TNO = #{istCralLocaraTno} AND T4.MEXNO_ENCR = #{istMexnoEncr} AND T4.CRAL_IDV_TNO = #{istCralIdvTno})
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(istLocaraTno) and @MybatisUtils@isNotEmpty(istExnoEncr) and @MybatisUtils@isNotEmpty(istIdvTno)'>
                 AND (T4.LOCARA_TNO = #{istLocaraTno} AND T4.EXNO_ENCR = #{istExnoEncr} AND T4.IDV_TNO = #{istIdvTno})
                 </if>
                 AND T1.DTA_DL_YN = 'N'
             )
         WHERE 1=1
           <if test='@MybatisUtils@isNotEmpty(adr) '>
           AND ADR LIKE '%' || #{adr} || '%'
           </if>
    </select>
</mapper>
