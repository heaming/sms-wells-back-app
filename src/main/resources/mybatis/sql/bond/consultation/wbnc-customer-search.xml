<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.bond.consultation.mapper.WbncCustomerSearchMapper">
    <!-- 고객찾기 -->
    <select id="selectCustomers" resultType="com.kyowon.sms.wells.web.bond.consultation.dto.WbncCustomerSearchDto$SearchRes">
        SELECT BND_BIZ_DV_CD
             , BND_BIZ_DV_NM
             , CNTR_NO
             , CNTR_SN
             , CST_KNM
             , CLCTAM_PRTNR_NO
             , PRTNR_KNM
             , CST_NO
             , SPP_ZIP
             , SPP_ADR
             , SPP_DTL_ADR
             , ADR
             , CNTR_LOCARA_TNO
             , CNTR_EXNO_ENCR
             , CNTR_IDV_TNO
             , CNTR_CRAL_LOCARA_TNO
             , CNTR_MEXNO_ENCR
             , CNTR_CRAL_IDV_TNO
             , IST_LOCARA_TNO
             , IST_EXNO_ENCR
             , IST_IDV_TNO
             , IST_CRAL_LOCARA_TNO
             , IST_MEXNO_ENCR
             , IST_CRAL_IDV_TNO
             , SFK_VAL
             , BND_CLCTN_PRP_DV_CD
             , BND_CLCTN_PRP_DV_NM
             , BND_CLCTN_PRP_RSON_CD
             , BND_CLCTN_PRP_RSON_NM
          FROM
             (
              SELECT T1.BND_BIZ_DV_CD    /* 채권업무구분코드 */
                   , F_CMZ_CD_NM('TNT_WELLS', 'BND_BIZ_DV_CD', T1.BND_BIZ_DV_CD) AS BND_BIZ_DV_NM  /* 채권업무구분코드명 */
                   , T1.CNTR_NO  /* 계약번호 */
                   , T1.CNTR_SN  /* 계약일련번호 */
                   , T1.CST_NM AS CST_KNM  /* 고객명 */
                   , T1.CLCTAM_PRTNR_NO /* 집급담당파트너번호 */
                   , (SELECT PRTNR_KNM FROM TB_CBBO_CLCTAM_PRTNR_DTL WHERE PRTNR_NO = T1.CLCTAM_PRTNR_NO AND DTA_DL_YN = 'N') AS PRTNR_KNM  /* 집급담당파트너명 */
                   , T1.CST_NO /* 고객번호 */
                   , (SELECT NVL(NEW_ADR_ZIP, OLD_ADR_ZIP) FROM TB_GBCO_ADR_BAS WHERE ADR_ID = T1.BND_CST_ADR_ID AND DTA_DL_YN = 'N') AS SPP_ZIP /* 계약처우편번호 */
                   , (SELECT NVL(RNADR, LTN_ADR) FROM TB_GBCO_ADR_BAS WHERE ADR_ID = T1.BND_CST_ADR_ID AND DTA_DL_YN = 'N') AS SPP_ADR /* 계약처기본주소 */
                   , (SELECT NVL(RDADR, LTN_DTL_ADR) FROM TB_GBCO_ADR_BAS WHERE ADR_ID = T1.BND_CST_ADR_ID AND DTA_DL_YN = 'N') AS SPP_DTL_ADR /* 계약처상세주소 */
                   , (SELECT NVL(RNADR, LTN_ADR) FROM TB_GBCO_ADR_BAS WHERE ADR_ID = T1.BND_CST_ADR_ID AND DTA_DL_YN = 'N') || ' ' || (SELECT NVL(RDADR, LTN_DTL_ADR) FROM TB_GBCO_ADR_BAS WHERE ADR_ID = T1.BND_CST_ADR_ID AND DTA_DL_YN = 'N') AS ADR /* 주소 */
                   , CASE WHEN T2.COPN_DV_CD = '1' THEN T3.LOCARA_TNO
                          WHEN T2.COPN_DV_CD = '2' THEN T4.LOCARA_TNO
                          ELSE ''
                     END AS CNTR_LOCARA_TNO /* 계약처지역전화번호 */
                   , CASE WHEN T2.COPN_DV_CD = '1' THEN T3.EXNO_ENCR
                          WHEN T2.COPN_DV_CD = '2' THEN T4.EXNO_ENCR
                          ELSE ''
                     END AS CNTR_EXNO_ENCR /* 계약처전화국번호암호화 */
                   , CASE WHEN T2.COPN_DV_CD = '1' THEN T3.IDV_TNO
                          WHEN T2.COPN_DV_CD = '2' THEN T4.IDV_TNO
                          ELSE ''
                     END AS CNTR_IDV_TNO   /* 계약처개별전화번호 */
                   , T2.CRAL_LOCARA_TNO AS CNTR_CRAL_LOCARA_TNO  /* 계약처휴대지역전화번호 */
                   , T2.MEXNO_ENCR  AS CNTR_MEXNO_ENCR           /* 계약처휴대전화국번호암호화 */
                   , T2.CRAL_IDV_TNO  AS CNTR_CRAL_IDV_TNO       /* 계약처휴대개별전화번호 */
                   , T6.LOCARA_TNO AS IST_LOCARA_TNO   /* 설치처지역전화번호 */
                   , T6.EXNO_ENCR AS IST_EXNO_ENCR     /* 설치처전화국번호암호화 */
                   , T6.IDV_TNO AS IST_IDV_TNO         /* 설치처개별전화번호 */
                   , T6.CRAL_LOCARA_TNO AS IST_CRAL_LOCARA_TNO   /* 설치처휴대지역전화번호 */
                   , T6.MEXNO_ENCR AS IST_MEXNO_ENCR             /* 설치처휴대전화국번호암호화 */
                   , T6.CRAL_IDV_TNO AS IST_CRAL_IDV_TNO         /* 설치처휴대개별전화번호 */
                   , T2.SFK_VAL  /* 세이프키*/
                   , T1.BND_CLCTN_PRP_DV_CD  /* 채권속성코드 */
                   , F_CMZ_CD_NM('TNT_WELLS', 'BND_CLCTN_PRP_DV_CD', T1.BND_CLCTN_PRP_DV_CD) AS BND_CLCTN_PRP_DV_NM  /* 채권속성명 */
                   , T1.BND_CLCTN_PRP_RSON_CD  /* 속성사유코드 */
                   , F_CMZ_CD_NM('TNT_WELLS', 'BND_CLCTN_PRP_RSON_CD', T1.BND_CLCTN_PRP_RSON_CD) AS BND_CLCTN_PRP_RSON_NM  /* 속성사유명 */
                FROM TB_CBBO_BND_CNTR_BAS T1
                LEFT OUTER JOIN TB_CUBS_CST_BAS T2
                  ON T2.CST_NO = T1.CST_NO
                LEFT OUTER JOIN (
                                 SELECT *
                                   FROM (
                                         SELECT CTPLC.*, RANK() OVER (PARTITION BY CST_CTPLC_OJ_DV_CD, CST_CTPLC_OJ_REFK_VAL ORDER BY HIST_STRT_DTM DESC) AS RNK
                                           FROM TB_CUBS_CST_CTPLC_BAS CTPLC
                                          WHERE 1=1
                                            AND CST_CTPLC_OJ_DV_CD = '01' /* 고객 */
                                            AND CTPLC_TP_CD = '04' /* 자택전화번호 */
                                        )
                                  WHERE RNK = 1
                                ) T3
                  ON T3.CST_CTPLC_OJ_REFK_VAL = T1.CST_NO
                LEFT OUTER JOIN (
                                 SELECT *
                                   FROM (
                                         SELECT CTPLC.*, RANK() OVER (PARTITION BY CST_CTPLC_OJ_DV_CD, CST_CTPLC_OJ_REFK_VAL ORDER BY HIST_STRT_DTM DESC) AS RNK
                                           FROM TB_CUBS_CST_CTPLC_BAS CTPLC
                                          WHERE 1=1
                                            AND CST_CTPLC_OJ_DV_CD = '03' /* 고객관계자 */
                                            AND CTPLC_TP_CD = '05' /* 직장전화번호 */
                                        )
                                  WHERE RNK = 1
                                ) T4
                  ON T4.CST_CTPLC_OJ_REFK_VAL = T1.CST_NO
                LEFT OUTER JOIN TB_SSCT_CNTR_ADR_REL T5
                  ON T5.ADRPC_TP_CD = '3'  /* 설치주소 */
                 AND T5.DTL_CNTR_NO = T1.CNTR_NO
                 AND T5.DTL_CNTR_SN = T1.CNTR_SN
                 AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T5.VL_STRT_DTM AND T5.VL_END_DTM
                 AND T5.DTA_DL_YN = 'N'
                LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS T6
                  ON T6.CNTR_ADRPC_ID = T5.CNTR_ADRPC_ID
                 AND T6.DTA_DL_YN = 'N'
               WHERE 1=1
                 AND T1.BASE_YM = (SELECT BASE_YM FROM (SELECT BASE_YM FROM TB_CBBO_BND_CNSL_BAS_IZ WHERE BND_CNTR_TP_CD = '01' ORDER BY BASE_YM DESC) WHERE ROWNUM = 1)
                 <if test='@MybatisUtils@isNotEmpty(clctamPrtnrNo)'>
                 AND T1.CLCTAM_PRTNR_NO = #{clctamPrtnrNo}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(cstNo)'>
                 AND T1.CST_NO = #{cstNo}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(cstKnm)'>
                 AND T1.CST_NM = #{cstKnm}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(bndClctnPrpDvCd)'>
                 AND T1.BND_CLCTN_PRP_DV_CD = #{bndClctnPrpDvCd}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(bndClctnPrpRsonCd)'>
                 AND T1.BND_CLCTN_PRP_RSON_CD = #{bndClctnPrpRsonCd}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(cntrCralLocaraTno) and @MybatisUtils@isNotEmpty(cntrMexnoEncr) and @MybatisUtils@isNotEmpty(cntrCralIdvTno)'>
                 AND (T2.CRAL_LOCARA_TNO = #{cntrCralLocaraTno} AND T2.MEXNO_ENCR = #{cntrMexnoEncr} AND T2.CRAL_IDV_TNO = #{cntrCralIdvTno})
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(istCralLocaraTno) and @MybatisUtils@isNotEmpty(istMexnoEncr) and @MybatisUtils@isNotEmpty(istCralIdvTno)'>
                 AND (T6.CRAL_LOCARA_TNO = #{istCralLocaraTno} AND T6.MEXNO_ENCR = #{istMexnoEncr} AND T6.CRAL_IDV_TNO = #{istCralIdvTno})
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(istLocaraTno) and @MybatisUtils@isNotEmpty(istExnoEncr) and @MybatisUtils@isNotEmpty(istIdvTno)'>
                 AND (T6.LOCARA_TNO = #{istLocaraTno} AND T6.EXNO_ENCR = #{istExnoEncr} AND T6.IDV_TNO = #{istIdvTno})
                 </if>
                 AND T1.DTA_DL_YN = 'N'
             )
         WHERE 1=1
           <if test='@MybatisUtils@isNotEmpty(cntrLocaraTno) and @MybatisUtils@isNotEmpty(cntrExnoEncr) and @MybatisUtils@isNotEmpty(cntrIdvTno)'>
           AND (CNTR_LOCARA_TNO = #{cntrLocaraTno} AND CNTR_EXNO_ENCR = #{cntrExnoEncr} AND CNTR_IDV_TNO = #{cntrIdvTno})
           </if>
           <if test='@MybatisUtils@isNotEmpty(adr) '>
           AND ADR LIKE '%' || #{adr} || '%'
           </if>
    </select>
</mapper>
