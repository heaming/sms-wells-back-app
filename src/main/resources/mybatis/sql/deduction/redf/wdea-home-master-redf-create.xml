<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.deduction.redf.mapper.WdeaHomeMasterRedfCreateMapper">

    <select id="selectHomeMasters" resultType="com.kyowon.sms.wells.web.deduction.redf.dto.WdeaHomeMasterRedfCreateDto$SearchRes">
        /* 홈마스터 되물림생성 목록 조회 */
        SELECT M.PERF_YM /*귀속년월*/
			 , AK05.OG_CD /*소속코드*/
			 , AK05.PRTNR_KNM /*판매자명*/
			 , M.PRTNR_NO /*파트너번호*/
			 , AK05.PSTN_DV_CD /*직급*/
             , F_CMZ_CD_NM('TNT_WELLS', 'RSB_DV_CD', AK05.RSB_DV_CD, #{session.langId}) AS RSB_DV_NM
			 , T_ENVR_ELHM_CNT /*환경가전 귀속월실적*/
			 , F_ENVR_ELHM_CNT /*환경가전 되물림전실적*/
			 , B_ENVR_ELHM_CNT /*환경가전 되물림후실적*/
			 , D_ENVR_ELHM_CNT /*환경가전 되물림실적*/
			 , T_ENVR_ELHM_CNT_JO /*환경가전 귀속월실적*/
			 , F_ENVR_ELHM_CNT_JO /*환경가전 되물림전실적*/
			 , B_ENVR_ELHM_CNT_JO /*환경가전 되물림후실적*/
			 , D_ENVR_ELHM_CNT_JO /*환경가전 되물림실적*/
			 , T_ENVR_ELHM_RENTAL_MATT  /*환경가전 렌탈(매트리스) 귀속월실적*/
			 , F_ENVR_ELHM_RENTAL_MATT  /*환경가전 렌탈(매트리스) 되물림전실적*/
			 , B_ENVR_ELHM_RENTAL_MATT  /*환경가전 렌탈(매트리스) 되물림후실적*/
			 , D_ENVR_ELHM_RENTAL_MATT  /*환경가전 렌탈(매트리스) 되물림실적*/
			 , T_ENVR_ELHM_RENTAL_MATT_JO  /*환경가전 렌탈(매트리스) 귀속월실적*/
			 , F_ENVR_ELHM_RENTAL_MATT_JO  /*환경가전 렌탈(매트리스) 되물림전실적*/
			 , B_ENVR_ELHM_RENTAL_MATT_JO  /*환경가전 렌탈(매트리스) 되물림후실적*/
			 , D_ENVR_ELHM_RENTAL_MATT_JO  /*환경가전 렌탈(매트리스) 되물림실적*/
			 , T_ENVR_ELHM_RENTAL_MATT_EXCP  /*환경가전 렌탈(매트리스 외) 귀속월실적*/
			 , F_ENVR_ELHM_RENTAL_MATT_EXCP  /*환경가전 렌탈(매트리스 외) 되물림전실적*/
			 , B_ENVR_ELHM_RENTAL_MATT_EXCP  /*환경가전 렌탈(매트리스 외) 되물림후실적*/
			 , D_ENVR_ELHM_RENTAL_MATT_EXCP  /*환경가전 렌탈(매트리스 외) 되물림실적*/
			 , T_ENVR_ELHM_RENTAL_MATT_EXCP_JO  /*환경가전 렌탈(매트리스 외) 귀속월실적*/
			 , F_ENVR_ELHM_RENTAL_MATT_EXCP_JO  /*환경가전 렌탈(매트리스 외) 되물림전실적*/
			 , B_ENVR_ELHM_RENTAL_MATT_EXCP_JO  /*환경가전 렌탈(매트리스 외) 되물림후실적*/
			 , D_ENVR_ELHM_RENTAL_MATT_EXCP_JO  /*환경가전 렌탈(매트리스 외) 되물림실적*/
			 , T_ENVR_ELHM_SPAY  /*환경가전 일시불 귀속월실적*/
			 , F_ENVR_ELHM_SPAY  /*환경가전 일시불 되물림전실적*/
			 , B_ENVR_ELHM_SPAY  /*환경가전 일시불 되물림후실적*/
			 , D_ENVR_ELHM_SPAY  /*환경가전 일시불 되물림실적*/
			 , T_ENVR_ELHM_SPAY_JO  /*환경가전 일시불 귀속월실적*/
			 , F_ENVR_ELHM_SPAY_JO  /*환경가전 일시불 되물림전실적*/
			 , B_ENVR_ELHM_SPAY_JO  /*환경가전 일시불 되물림후실적*/
			 , D_ENVR_ELHM_SPAY_JO  /*환경가전 일시불 되물림실적*/
			 , T_ENVR_ELHM_EXCP_SPAY  /*환경가전외 일시불 귀속월실적*/
			 , F_ENVR_ELHM_EXCP_SPAY  /*환경가전외 일시불 되물림전실적*/
			 , B_ENVR_ELHM_EXCP_SPAY  /*환경가전외 일시불 되물림후실적*/
			 , D_ENVR_ELHM_EXCP_SPAY  /*환경가전외 일시불 되물림실적*/
			 , T_ENVR_ELHM_EXCP_SPAY_JO  /*환경가전외 일시불 귀속월실적*/
			 , F_ENVR_ELHM_EXCP_SPAY_JO  /*환경가전외 일시불 되물림전실적*/
			 , B_ENVR_ELHM_EXCP_SPAY_JO  /*환경가전외 일시불 되물림후실적*/
			 , D_ENVR_ELHM_EXCP_SPAY_JO  /*환경가전외 일시불 되물림실적*/
			 /* 되물림 수수료 */
             , M.ENVR_BZNS_REDF_PR /*환경가전 비례(개인)*/
             , M.ENVR_BZNS_REDF_JO /*환경가전 비례(조직)*/
             , M.ENCRG_REDF1 /*장려1(생산장려/목표달성)*/
             , M.ENCRG_REDF2_PR /*장려2(개인교차판매수당)*/
             , M.ENCRG_REDF2_JO /*장려2(지점비례수당)*/
             , M.SPAY_REDF_PR /*일시불(환경가전기기변경)*/
             , M.SPAY_REDF_JO /*일시불(환경가전기기변경)*/
             , M.OG_SELL_PRPN /*조직판매비례(환경가전조직비례)*/
             , M.OG_SELL_LK_REDF /*조직판매연계(조직판매장려)*/
             , M.OG_MGT_REDF /*조직관리(조직관리)*/
             , M.NW_SELL_REDF /*신규판매(조직신규판매)*/
             , M.OG_SELL_PRPN_REDF /*조직판매일시불(환경가전외조직비례)*/
             , (M.ENVR_BZNS_REDF_PR + M.ENCRG_REDF1 + M.ENCRG_REDF2_PR + M.SPAY_REDF_PR) AS SUM_REDF_AMT_PR /* 되물림합계금액(개인) */
             , (M.ENVR_BZNS_REDF_JO + M.ENCRG_REDF1 + M.ENCRG_REDF2_JO + M.SPAY_REDF_JO + M.OG_SELL_PRPN
                + M.OG_SELL_LK_REDF + M. OG_MGT_REDF + M.NW_SELL_REDF + M.OG_SELL_PRPN_REDF) AS SUM_REDF_AMT_JO /* 되물림합계금액(조직) */
		  FROM (
				SELECT REDF_ADSB_OC_YM
		             , PERF_YM
		             , OG_TP_CD
		             , PRTNR_NO
		             , CO_CD
		             , NVL(MAX((CASE WHEN FEE_CD = 'W030001'
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS ENVR_BZNS_REDF_PR /*환경가전 비례(개인)*/
                     , COUNT(CASE WHEN FEE_CD = 'W030001' THEN 1 END) AS ENVR_BZNS_REDF_CNT_PR
		             , NVL(MAX((CASE WHEN FEE_CD = 'W030051'
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS ENVR_BZNS_REDF_JO /*환경가전 비례(조직)*/
		             , NVL(MAX((CASE WHEN FEE_CD = 'W030002'
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS ENCRG_REDF1 /*장려1(생산장려/목표달성)*/
		             , NVL(MAX((CASE WHEN FEE_CD = 'W030003'
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS ENCRG_REDF2_PR /*장려2(개인교차판매수당)*/
		             , NVL(MAX((CASE WHEN FEE_CD = 'W030053'
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS ENCRG_REDF2_JO /*장려2(지점비례수당)*/
		             , NVL(MAX((CASE WHEN FEE_CD = 'W030004'
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS SPAY_REDF_PR /*일시불(환경가전기기변경)*/
		             , NVL(MAX((CASE WHEN FEE_CD = 'W030054'
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS SPAY_REDF_JO /*일시불(환경가전기기변경)*/
		             , NVL(MAX((CASE WHEN FEE_CD IN ('W030071', 'W030042')
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS OG_SELL_PRPN /*조직판매비례(환경가전조직비례)*/
		             , NVL(MAX((CASE WHEN FEE_CD IN ('W030073')
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS OG_SELL_LK_REDF /*조직판매연계(조직판매장려)*/
		             , NVL(MAX((CASE WHEN FEE_CD = 'W030075'
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS OG_MGT_REDF /*조직관리(조직관리)*/
		             , NVL(MAX((CASE WHEN FEE_CD = 'W030074'
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS NW_SELL_REDF /*신규판매(조직신규판매)*/
		             , NVL(MAX((CASE WHEN FEE_CD IN ('W030072')
		                             THEN (CASE WHEN REDF_ADSB_CTR_CNFM_AMT IS NULL
		                                    THEN REDF_ADSB_OC_AMT
		                                    ELSE REDF_ADSB_CTR_CNFM_AMT END)
		                     END)), 0) AS OG_SELL_PRPN_REDF /*조직판매일시불(환경가전외조직비례)*/
		          FROM TB_FEDD_FEE_REDF_ADSB_BAS /*수수료되물림재지급기본*/
		         WHERE DTA_DL_YN = 'N'
		           AND OG_TP_CD = 'W03'
		           AND REDF_ADSB_OC_YM = #{redfAdsbOcYm} /*PARAM: 발생년월*/
		           AND PERF_YM BETWEEN #{perfYmFrom} AND #{perfYmTo} /*PARAM: 실적년월*/
		           AND REDF_ADSB_TP_CD = #{redfAdsbTpCd} /*PARAM: 처리유형*/
                   <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                   AND PRTNR_NO = #{prtnrNo} /*파트너번호*/
                   </if>
                   <if test='@MybatisUtils@equals(rsbDvCd, "01")'>
                   AND PERF_DV_CD = '0' /*지구장 이하*/
                   </if>
                   <if test='@MybatisUtils@equals(rsbDvCd, "02")'>
                   AND PERF_DV_CD = '2' /*지점장 이상*/
                   </if>
		         GROUP BY REDF_ADSB_OC_YM, PERF_YM, OG_TP_CD, PRTNR_NO, CO_CD
          ) M
		 LEFT OUTER JOIN (
		 				SELECT S1.BASE_YM /*발생년월*/
                             , S1.PERF_YM /*실적년월(귀속년월)*/
                             , S1.OG_TP_CD /*조직유형*/
                             , S1.PRTNR_NO /*파트너번호*/
                             , S1.FEE_TCNT_DV_CD /*수수료차수구분코드*/
                             , S1.CO_CD /*회사코드*/
                             /* 귀속월실적(최초) */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W03P00002' AND S1.PERF_DV_CD = '0' THEN S1.PERF_VAL END)), 0) AS T_ENVR_ELHM_CNT /* 귀속월실적 환경가전(건수) */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00031' AND S1.PERF_DV_CD = '0' THEN S1.PERF_VAL END)), 0) AS T_ENVR_ELHM_RENTAL_MATT /* 귀속월실적 환경가전 렌탈 (매트리스)  */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W03P00122' AND S1.PERF_DV_CD = '0' THEN S1.PERF_VAL END)), 0) AS T_ENVR_ELHM_RENTAL_MATT_EXCP /* 귀속월실적 환경가전 렌탈 (매트리스 외)  ASIS: AKCDA12 */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00004' AND S1.PERF_DV_CD = '0' THEN S1.PERF_VAL END)), 0) AS T_ENVR_ELHM_SPAY /* 귀속월실적 환경가전 일시불*/
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00006' AND S1.PERF_DV_CD = '0' THEN S1.PERF_VAL END)), 0) AS T_ENVR_ELHM_EXCP_SPAY /* 귀속월실적 환경가전외 일시불*/

                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W03P00002' AND S1.PERF_DV_CD = '2' THEN S1.PERF_VAL END)), 0) AS T_ENVR_ELHM_CNT_JO /* 귀속월실적 환경가전(건수) */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00031' AND S1.PERF_DV_CD = '2' THEN S1.PERF_VAL END)), 0) AS T_ENVR_ELHM_RENTAL_MATT_JO /* 귀속월실적 환경가전 렌탈 (매트리스)  */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W03P00122' AND S1.PERF_DV_CD = '2' THEN S1.PERF_VAL END)), 0) AS T_ENVR_ELHM_RENTAL_MATT_EXCP_JO /* 귀속월실적 환경가전 렌탈 (매트리스 외)  ASIS: AKCDA12 */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00004' AND S1.PERF_DV_CD = '2' THEN S1.PERF_VAL END)), 0) AS T_ENVR_ELHM_SPAY_JO /* 귀속월실적 환경가전 일시불*/
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00006' AND S1.PERF_DV_CD = '2' THEN S1.PERF_VAL END)), 0) AS T_ENVR_ELHM_EXCP_SPAY_JO /* 귀속월실적 환경가전외 일시불*/
                             /* 되물림전실적(최초 ~ 되물림 사이) */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W03P00002' AND S1.PERF_DV_CD = '0' AND S1.PERF_YM <![CDATA[ < ]]> #{redfAdsbOcYm} THEN S1.PERF_VAL END)), 0) AS F_ENVR_ELHM_CNT /* 되물림전실적 환경가전(건수) */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00031' AND S1.PERF_DV_CD = '0' AND S1.PERF_YM <![CDATA[ < ]]> #{redfAdsbOcYm} THEN S1.PERF_VAL END)), 0) AS F_ENVR_ELHM_RENTAL_MATT /* 되물림전실적 환경가전 렌탈 (매트리스) */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W03P00122' AND S1.PERF_DV_CD = '0' AND S1.PERF_YM <![CDATA[ < ]]> #{redfAdsbOcYm} THEN S1.PERF_VAL END)), 0) AS F_ENVR_ELHM_RENTAL_MATT_EXCP /* 되물림전실적 환경가전 렌탈 (매트리스 외) ASIS: AKCDA12 */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00004' AND S1.PERF_DV_CD = '0' AND S1.PERF_YM <![CDATA[ < ]]> #{redfAdsbOcYm} THEN S1.PERF_VAL END)), 0) AS F_ENVR_ELHM_SPAY /* 되물림전실적 환경가전 일시불*/
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00006' AND S1.PERF_DV_CD = '0' AND S1.PERF_YM <![CDATA[ < ]]> #{redfAdsbOcYm} THEN S1.PERF_VAL END)), 0) AS F_ENVR_ELHM_EXCP_SPAY /* 되물림전실적 환경가전외 일시불*/

                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W03P00002' AND S1.PERF_DV_CD = '0' AND S1.PERF_YM <![CDATA[ < ]]> #{redfAdsbOcYm} THEN S1.PERF_VAL END)), 0) AS F_ENVR_ELHM_CNT_JO /* 되물림전실적 환경가전(건수) */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00031' AND S1.PERF_DV_CD = '0' AND S1.PERF_YM <![CDATA[ < ]]> #{redfAdsbOcYm} THEN S1.PERF_VAL END)), 0) AS F_ENVR_ELHM_RENTAL_MATT_JO /* 되물림전실적 환경가전 렌탈 (매트리스) */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W03P00122' AND S1.PERF_DV_CD = '0' AND S1.PERF_YM <![CDATA[ < ]]> #{redfAdsbOcYm} THEN S1.PERF_VAL END)), 0) AS F_ENVR_ELHM_RENTAL_MATT_EXCP_JO /* 되물림전실적 환경가전 렌탈 (매트리스 외) ASIS: AKCDA12 */
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00004' AND S1.PERF_DV_CD = '0' AND S1.PERF_YM <![CDATA[ < ]]> #{redfAdsbOcYm} THEN S1.PERF_VAL END)), 0) AS F_ENVR_ELHM_SPAY_JO /* 되물림전실적 환경가전 일시불*/
                             , NVL(MAX((CASE WHEN S1.PERF_ATC_CD = 'W00P00006' AND S1.PERF_DV_CD = '0' AND S1.PERF_YM <![CDATA[ < ]]> #{redfAdsbOcYm} THEN S1.PERF_VAL END)), 0) AS F_ENVR_ELHM_EXCP_SPAY_JO /* 되물림전실적 환경가전외 일시불*/
                          FROM TB_FEAM_NTORP_PERF_MM_CL S1/* 순주문파트너실적월마감(ASIS: AK1700P) */
                         WHERE S1.DTA_DL_YN = 'N'
                           AND S1.FEE_TCNT_DV_CD = '02'
                           AND S1.PERF_AGRG_CRT_DV_CD = '301' /*귀속월실적(순주문집계)*/
                           AND S1.OG_TP_CD = 'W03' /* 홈마스터 집계 */
                         GROUP BY S1.BASE_YM , S1.PERF_YM, S1.OG_TP_CD, S1.PRTNR_NO, S1.FEE_TCNT_DV_CD, S1.CO_CD
         ) A /*귀속월실적*/
         ON 1 = 1
        AND M.PRTNR_NO = A.PRTNR_NO
        AND M.OG_TP_CD = A.OG_TP_CD
        AND M.PERF_YM = A.PERF_YM
       LEFT OUTER JOIN (
                       SELECT BASE_YM
                            , PERF_YM
                            , OG_TP_CD
                            , PRTNR_NO
                            /* 되물림 실적 */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W03P00002' AND PERF_DV_CD = '0' AND BASE_YM = #{redfAdsbOcYm} THEN REDF_ADSB_OJ_PERF_VAL END)), 0) AS D_ENVR_ELHM_CNT /* 되물림실적 환경가전(건수) */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00031' AND PERF_DV_CD = '0' AND BASE_YM = #{redfAdsbOcYm} THEN REDF_ADSB_OJ_PERF_VAL END)), 0) AS D_ENVR_ELHM_RENTAL_MATT /* 되물림실적 환경가전 렌탈 (매트리스) 개인 */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W03P00122' AND PERF_DV_CD = '0' AND BASE_YM = #{redfAdsbOcYm} THEN REDF_ADSB_OJ_PERF_VAL END)), 0) AS D_ENVR_ELHM_RENTAL_MATT_EXCP /* 되물림실적 환경가전 렌탈 (매트리스 외) 개인 ASIS: AKCDA12 */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00004' AND PERF_DV_CD = '0' AND BASE_YM = #{redfAdsbOcYm} THEN REDF_ADSB_OJ_PERF_VAL END)), 0) AS D_ENVR_ELHM_SPAY /* 되물림실적 환경가전 일시불*/
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00006' AND PERF_DV_CD = '0' AND BASE_YM = #{redfAdsbOcYm} THEN REDF_ADSB_OJ_PERF_VAL END)), 0) AS D_ENVR_ELHM_EXCP_SPAY /* 되물림실적 환경가전외 일시불*/

                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W03P00002' AND PERF_DV_CD = '2' AND BASE_YM = #{redfAdsbOcYm} THEN REDF_ADSB_OJ_PERF_VAL END)), 0) AS D_ENVR_ELHM_CNT_JO /* 되물림실적 환경가전(건수) */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00031' AND PERF_DV_CD = '2' AND BASE_YM = #{redfAdsbOcYm} THEN REDF_ADSB_OJ_PERF_VAL END)), 0) AS D_ENVR_ELHM_RENTAL_MATT_JO /* 되물림실적 환경가전 렌탈 (매트리스) 개인 */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W03P00122' AND PERF_DV_CD = '2' AND BASE_YM = #{redfAdsbOcYm} THEN REDF_ADSB_OJ_PERF_VAL END)), 0) AS D_ENVR_ELHM_RENTAL_MATT_EXCP_JO /* 되물림실적 환경가전 렌탈 (매트리스 외) 개인 ASIS: AKCDA12 */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00004' AND PERF_DV_CD = '2' AND BASE_YM = #{redfAdsbOcYm} THEN REDF_ADSB_OJ_PERF_VAL END)), 0) AS D_ENVR_ELHM_SPAY_JO /* 되물림실적 환경가전 일시불*/
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00006' AND PERF_DV_CD = '2' AND BASE_YM = #{redfAdsbOcYm} THEN REDF_ADSB_OJ_PERF_VAL END)), 0) AS D_ENVR_ELHM_EXCP_SPAY_JO /* 되물림실적 환경가전외 일시불*/
                            /* 되물림 후 실적 */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W03P00002' AND PERF_DV_CD = '0' THEN PERF_VAL END)), 0) AS B_ENVR_ELHM_CNT /* 되물림전 환경가전(건수) */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00031' AND PERF_DV_CD = '0' THEN PERF_VAL END)), 0) AS B_ENVR_ELHM_RENTAL_MATT /* 되물림전후 환경가전 렌탈 (매트리스) 개인 */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W03P00122' AND PERF_DV_CD = '0' THEN PERF_VAL END)), 0) AS B_ENVR_ELHM_RENTAL_MATT_EXCP /* 되물림전후 환경가전 렌탈 (매트리스 외) 개인 ASIS: AKCDA12 */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00004' AND PERF_DV_CD = '0' THEN PERF_VAL END)), 0) AS B_ENVR_ELHM_SPAY /* 되물림전후 환경가전 일시불(개인)*/
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00006' AND PERF_DV_CD = '0' THEN PERF_VAL END)), 0) AS B_ENVR_ELHM_EXCP_SPAY /* 되물림전후 환경가전외 일시불(개인)*/

                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00031' AND PERF_DV_CD = '2' THEN PERF_VAL END)), 0) AS B_ENVR_ELHM_RENTAL_MATT_JO /* 되물림전후 환경가전 렌탈 (매트리스) 개인 */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W03P00002' AND PERF_DV_CD = '2' THEN PERF_VAL END)), 0) AS B_ENVR_ELHM_CNT_JO /* 되물림전 환경가전(건수) */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W03P00122' AND PERF_DV_CD = '2' THEN PERF_VAL END)), 0) AS B_ENVR_ELHM_RENTAL_MATT_EXCP_JO /* 되물림전후 환경가전 렌탈 (매트리스 외) 개인 ASIS: AKCDA12 */
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00004' AND PERF_DV_CD = '2' THEN PERF_VAL END)), 0) AS B_ENVR_ELHM_SPAY_JO /* 되물림전후 환경가전 일시불(개인)*/
                            , NVL(MAX((CASE WHEN PERF_ATC_CD = 'W00P00006' AND PERF_DV_CD = '2' THEN PERF_VAL END)), 0) AS B_ENVR_ELHM_EXCP_SPAY_JO /* 되물림전후 환경가전외 일시불(개인)*/
                         FROM TB_FEAM_NTORP_PERF_MM_CL /* 순주문파트너실적월마감(ASIS: AK1700P) */
                        WHERE DTA_DL_YN = 'N'
                          AND FEE_TCNT_DV_CD = '02'
                          AND PERF_AGRG_CRT_DV_CD = '302' /*되물림후실적(되물림집계), TODO: 현재 데이터없음*/
                          AND OG_TP_CD = 'W03' /* 홈마스터 집계 */
                          GROUP BY BASE_YM , PERF_YM, OG_TP_CD, PRTNR_NO
       	 ) B /*되물림, 후실적*/
         ON A.PERF_YM = B.PERF_YM
        AND A.OG_TP_CD = B.OG_TP_CD
        AND A.PRTNR_NO = B.PRTNR_NO
       LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ AK05 /*월파트너내역*/
         ON M.PERF_YM = AK05.BASE_YM
        AND M.OG_TP_CD = AK05.OG_TP_CD
        AND M.PRTNR_NO = AK05.PRTNR_NO
      WHERE 1 = 1
        <if test='@MybatisUtils@equals(rsbDvCd, "01")'>
        AND TO_NUMBER(AK05.PSTN_DV_CD) <![CDATA[>=]]> '10' /*지구장 이하*/
        </if>
        <if test='@MybatisUtils@equals(rsbDvCd, "02")'>
        AND TO_NUMBER(AK05.PSTN_DV_CD) <![CDATA[<=]]> '7' /*지점장 이상*/
        </if>
        <if test='@MybatisUtils@isNotEmpty(ogCd)'>
        AND AK05.OG_CD = #{ogCd} /*PARAM: 조직코드*/
        </if>
    </select>

    <select id="selectDelinquentHomeMasters" resultType="com.kyowon.sms.wells.web.deduction.redf.dto.WdeaHomeMasterRedfCreateDto$SearchDlqRes">
        /* 홈마스터 되물림생성 - 연체 목록 조회 */
        SELECT M.BASE_YM /*발생년월*/
             , M.PERF_YM /*실적년월*/
             , M.PRTNR_NO /*파트너번호*/
             , M.PRTNR_KNM /*성명*/
             , M.OG_TP_NM /*조직유형*/
             , M.PERF_DV_NM /*실적구분*/
             , M.RENTAL_REDF_PERF /*되물림 실적.렌탈*/
             , M.ENVR_ELHM_EXCP_SPAY_REDF_PERF /*되물림 실적.가전외 일시불 실적*/
             , M.RENTAL_DLQ_REDF_PERF /*연체되물림 실적.렌탈*/
             , M.ENVR_ELHM_EXCP_SPAY_DLQ_REDF_PERF /*연체되물림 실적.가전외 일시불 실적*/
             , (M.RENTAL_DLQ_REDF_PERF + M.ENVR_ELHM_EXCP_SPAY_DLQ_REDF_PERF) AS DLQ_SUM /*연체되물림 실적.계*/
          FROM (
                SELECT A.BASE_YM
                     , A.PERF_YM
                     , A.PRTNR_NO
                     , (SELECT X.PRTNR_KNM
                          FROM TB_OGBS_PRTNR_BAS X
                         WHERE X.PRTNR_NO = A.PRTNR_NO
                           AND X.OG_TP_CD = A.OG_TP_CD) AS PRTNR_KNM
                     , F_CMZ_CD_NM(#{session.tenantId}, 'OG_TP_CD', A.OG_TP_CD, #{session.langId}) AS OG_TP_NM
                     , F_CMZ_CD_NM(#{session.tenantId}, 'PERF_DV_CD', A.PERF_DV_CD, #{session.langId}) AS PERF_DV_NM
                     , NVL(MAX(CASE WHEN A.PERF_ATC_CD = 'W00P00003' THEN A.PERF_VAL END), 0) AS RENTAL_REDF_PERF
                     , NVL(MAX(CASE WHEN A.PERF_ATC_CD = 'W00P00006' THEN A.PERF_VAL END), 0) AS ENVR_ELHM_EXCP_SPAY_REDF_PERF
                     , NVL(MAX(CASE WHEN A.PERF_ATC_CD = 'W00P00003' AND B.PERF_TP_CD = '10' THEN A.PERF_VAL END), 0) AS RENTAL_DLQ_REDF_PERF
                     , NVL(MAX(CASE WHEN A.PERF_ATC_CD = 'W00P00006' AND B.PERF_TP_CD = '10' THEN A.PERF_VAL END), 0) AS ENVR_ELHM_EXCP_SPAY_DLQ_REDF_PERF
                  FROM TB_FEAM_NTORP_PERF_MM_CL A /*순주문실적파트너월마감*/
                  LEFT OUTER JOIN TB_FEAM_WELS_NRCTR_MM_CL B /*웰스순주문계약월마감*/
                    ON B.BASE_YM = A.BASE_YM
                   AND B.PERF_YM = A.PERF_YM
                   AND B.FEE_TCNT_DV_CD = A.FEE_TCNT_DV_CD
                   AND B.PRTNR_NO = A.PRTNR_NO
                   AND B.OG_TP_CD = A.OG_TP_CD
                   AND B.CO_CD = A.CO_CD
                  LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ C /*월파트너내역*/
                    ON A.BASE_YM = C.BASE_YM
                   AND A.PRTNR_NO = C.PRTNR_NO
                   AND A.OG_TP_CD = C.OG_TP_CD
                 WHERE A.DTA_DL_YN = 'N'
                   AND A.OG_TP_CD = 'W03' /*홈마스터 고정*/
                   AND B.PERF_TP_CD = '10' /*연체*/
                   AND A.BASE_YM = #{redfAdsbOcYm}
                   AND A.PERF_YM BETWEEN #{perfYmFrom} AND #{perfYmTo}
                   <if test='@MybatisUtils@equals(rsbDvCd, "01")'>
                   AND TO_NUMBER(C.PSTN_DV_CD) <![CDATA[>=]]> '10' /*지구장 이하*/
                   </if>
                   <if test='@MybatisUtils@equals(rsbDvCd, "02")'>
                   AND TO_NUMBER(C.PSTN_DV_CD) <![CDATA[<=]]> '7' /*지점장 이상*/
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(ogCd)'>
                   AND C.OG_CD = #{ogCd} /*조직코드*/
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                   AND A.PRTNR_NO = #{prtnrNo} /*파트너번호*/
                   </if>
                 GROUP BY A.BASE_YM, A.PERF_YM, A.PRTNR_NO, A.OG_TP_CD, A.PERF_DV_CD
         ) M
    </select>

</mapper>
