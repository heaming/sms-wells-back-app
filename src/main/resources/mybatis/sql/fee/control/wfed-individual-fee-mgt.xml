<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.control.mapper.WfedIndividualFeeMgtMapper">
    <select id='selectHmstEntrp'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$FindHmstEntrpRes">
        SELECT OG.PRTNR_KNM || '(' || OG.PRTNR_NO || ')'  AS EMPL_NM /* 성명 */
             , OG.OG_NM AS BLG /* 소속 */
             , CD.CD_CNTN AS RSB /* 직책 */
             , FLOOR(MONTHS_BETWEEN (#{perfYm}||'01',OG.CNTR_DT)) +1 AS AKDCHA    /* 차월 */
             , NVL(OG.PRTNR_GD_CD,0) AS PRTNR_GD_CD /* 급수 */
             , '' AS ATCNT1 /* 집합교육참여일수 */
             , '' AS ATCNT2 /* 동행교육참여일수 */
             , OG.CNTR_DT AS AKDSYM /* 업무등록월 */
             , AK17.AKDEQ0 AS AKDEQ0 /* 총판매건수 */
             , AK17.SERCNT /* 서비스건수 */
             , AK17.SERRYL /* 서비스처리율 */
             , AK17.AKCDA19 AS AKCDA19 /* 홈케어멤버십 */
             , AK17.AKCDA10 AS AKCDA10 /* 매트리스 렌탈료 */
             , AK17.AKCDA12 AS AKCDA12 /* 매트리스 외 렌탈료 */
             , AK17.AKCDA13 AS AKCDA13 /* 환경가전 일시불 */
             , AK17.AKCDA15 AS AKCDA15 /* 환경가전 외 일시불 */
             , FEE.INTBS_SUM /* 과표계 */
             , FEE.DDTN_SUM /* 공제계 */
             , FEE.ACL_DSB_AMT /* 실지급액 */
        FROM TB_OGBS_MM_PRTNR_IZ OG
        LEFT OUTER JOIN T_CMZ_CD_D CD
          ON OG.QLF_DV_CD = CD.CD_ID
         AND CD.CD_ID = 'QLF_DV_CD'
         AND CD.TENANT_ID = #{session.tenantId}
        LEFT OUTER JOIN ( SELECT E.PRTNR_NO
                               , E.OG_TP_CD
                               , SUM(E.INTBS_AMT) AS INTBS_SUM
                               , SUM(E.DDCTAM) AS DDTN_SUM
                               , SUM(E.DSB_OJ_AMT) AS ACL_DSB_AMT
                            FROM TB_FEAM_FEE_DSB_IZ E
                           WHERE E.DSB_YM = #{perfYm}
                             AND ( E.INTBS_AMT &gt; 0 OR E.DDCTAM &gt; 0  OR E.DSB_OJ_AMT &gt; 0 )
                             AND E.PRTNR_NO = #{no}
                           GROUP BY E.PRTNR_NO, E.OG_TP_CD
                        )FEE
          ON OG.PRTNR_NO = FEE.PRTNR_NO
         AND OG.OG_TP_CD = FEE.OG_TP_CD
        LEFT OUTER JOIN ( SELECT M.PRTNR_NO
                               , SUM(AKDEQ0) AS AKDEQ0
                               , SUM(AKCDA19) AS AKCDA19
                               , SUM(AKCDA10) AS AKCDA10
                               , SUM(AKCDA12) AS AKCDA12
                               , SUM(AKCDA13) AS AKCDA13
                               , SUM(AKCDA15) AS AKCDA15
                               , SUM(SERCNT) AS SERCNT
                               , SUM(SERRYL) AS SERRYL
                            FROM ( SELECT AK17.PRTNR_NO
                                        , CASE WHEN AK17.PERF_ATC_CD = 'W03P00002' THEN PERF_VAL ELSE 0 END AS AKDEQ0
                                        , CASE WHEN AK17.PERF_ATC_CD = 'W03P00123' THEN PERF_VAL ELSE 0 END AS AKCDA19
                                        , CASE WHEN AK17.PERF_ATC_CD = 'W03P00122' THEN PERF_VAL ELSE 0 END AS AKCDA10
                                        , CASE WHEN AK17.PERF_ATC_CD = 'W00P00003' THEN PERF_VAL ELSE 0 END AS AKCDA12
                                        , CASE WHEN AK17.PERF_ATC_CD = 'W00P00004' THEN PERF_VAL ELSE 0 END AS AKCDA13
                                        , CASE WHEN AK17.PERF_ATC_CD = 'W00P00006' THEN PERF_VAL ELSE 0 END AS AKCDA15
                                        , CASE WHEN AK17.PERF_ATC_CD = 'W03P00085' THEN PERF_VAL ELSE 0 END AS SERCNT
                                        , CASE WHEN AK17.PERF_ATC_CD = 'W03P00095' THEN PERF_VAL ELSE 0 END AS SERRYL
                                     FROM TB_FEAM_NTORP_PERF_MM_CL AK17   /*순주문 파트너 실적 월마감*/
                                    WHERE AK17.FEE_TCNT_DV_CD = '01'
                                      AND AK17.BASE_YM = #{perfYm}
                                      AND AK17.PERF_DV_CD = 0
                                      AND AK17.PRTNR_NO = #{no}
                                      AND AK17.OG_TP_CD = 'W03'
                                 )M
                           GROUP BY M.PRTNR_NO
                        ) AK17
          ON OG.PRTNR_NO = AK17.PRTNR_NO
       WHERE OG.BASE_YM = #{perfYm}
         AND OG.OG_TP_CD = 'W03'
         AND OG.PRTNR_NO = #{no}
    </select>

    <select id='selectHmstFee'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$SearchHmstFeeRes">
        SELECT NVL(MAX(M.ITEM1),'') AS ITEM1
             , CASE WHEN LENGTH(MAX(M.ITEM1)) > 0 THEN NVL(MAX(M.FVAL1),0) END AS FVAL1
             , NVL(MAX(M.ITEM2),'') AS ITEM2
             , CASE WHEN LENGTH(MAX(M.ITEM2)) > 0 THEN NVL(MAX(M.FVAL2),0) END AS FVAL2
             , NVL(MAX(M.ITEM3),'') AS ITEM3
             , CASE WHEN LENGTH(MAX(M.ITEM3)) > 0 THEN NVL(MAX(M.FVAL3),0) END AS FVAL3
             , NVL(MAX(M.ITEM4),'') AS ITEM4
             , CASE WHEN LENGTH(MAX(M.ITEM4)) > 0 THEN NVL(MAX(M.FVAL4),0) END AS FVAL4
          FROM ( SELECT TO_CHAR(T2.NW_CDN) AS ITEM1
                      , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL1
                      , '' AS ITEM2
                      , '' AS FVAL2
                      , '' AS ITEM3
                      , '' AS FVAL3
                      , '' AS ITEM4
                      , '' AS FVAL4
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1                 /*T 개인관리 기본 T*/
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2            /*T 개인관리 상세 T*/
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '1'
                    AND T2.WK_GRP_CLSF_CD = '02'
                   LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND T2.NW_CDV = T3.FEE_CD
                    AND T3.DSB_YM = #{perfYm}
                    AND T3.PRTNR_NO = #{no}
                    AND T3.FEE_TCNT_DV_CD = '02'  /* 차수구분 */
                  WHERE T1.OG_TP_CD = 'W03'
                    AND #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                  GROUP BY T2.NW_CDN, T2.APY_SEQN
                  UNION
                 SELECT '' AS ITEM1
                      , '' AS FVAL1
                      , TO_CHAR(T2.NW_CDN) AS ITEM2
                      , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL2
                      , '' AS ITEM3
                      , '' AS FVAL3
                      , '' AS ITEM4
                      , '' AS FVAL4
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '2'
                    AND T2.WK_GRP_CLSF_CD = '02'
                   LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND T2.NW_CDV = T3.FEE_CD
                    AND T3.DSB_YM = #{perfYm}
                    AND T3.PRTNR_NO = #{no}
                    AND T3.FEE_TCNT_DV_CD = '02'  /* 차수구분 */
                  WHERE T1.OG_TP_CD = 'W03'
                    AND #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                  GROUP BY T2.NW_CDN, T2.APY_SEQN
                  UNION
                 SELECT '' AS ITEM1
                      , '' AS FVAL1
                      , '' AS ITEM2
                      , '' AS FVAL2
                      , T2.NW_CDN AS ITEM3
                      , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL3
                      , '' AS ITEM4
                      , '' AS FVAL4
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '3'
                    AND T2.WK_GRP_CLSF_CD = '02'
                   LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND T2.NW_CDV = T3.FEE_CD
                    AND T3.DSB_YM = #{perfYm}
                    AND T3.PRTNR_NO = #{no}
                    AND T3.FEE_TCNT_DV_CD = '02'  /* 차수구분 */
                  WHERE T1.OG_TP_CD = 'W03'
                    AND #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                  GROUP BY T2.NW_CDN, T2.APY_SEQN
                  UNION
                 SELECT '' AS ITEM1
                      , '' AS FVAL1
                      , '' AS ITEM2
                      , '' AS FVAL2
                      , '' AS ITEM3
                      , '' AS FVAL3
                      , TO_CHAR(T2.NW_CDN) AS ITEM3
                      , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL4
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '4'
                    AND T2.WK_GRP_CLSF_CD = '02'
                   LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND T2.NW_CDV = T3.FEE_CD
                    AND T3.DSB_YM = #{perfYm}
                    AND T3.PRTNR_NO = #{no}
                    AND T3.FEE_TCNT_DV_CD = '02'  /* 차수구분 */
                  WHERE T1.OG_TP_CD = 'W03'
                    AND #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                  GROUP BY T2.NW_CDN, T2.APY_SEQN
               ) M
         GROUP BY M.APY_SEQN
         ORDER BY M.APY_SEQN
    </select>

    <select id='selectHmstDeduction'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$FindHmstDeductionRes">
        SELECT MAX(AMT02) AS ERNTX
             , MAX(AMT03) AS RSDNTX
             , MAX(AMT01) AS RDS
             , MAX(AMT05) AS HIR_INSR
             , MAX(AMT06) AS INDD_INSR
             , MAX(AMT07) AS BU_DDTN
             , MAX(AMT04) AS PNPYAM
             , MAX(AMT01) + MAX(AMT02) + MAX(AMT03) + MAX(AMT04) + MAX(AMT05) + MAX(AMT06) + MAX(AMT07) AS DDTN_SUM
          FROM ( SELECT NVL(CASE WHEN FEE_DDTN_TP_CD = '01' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT01
                      , NVL(CASE WHEN FEE_DDTN_TP_CD = '02' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT02
                      , NVL(CASE WHEN FEE_DDTN_TP_CD = '03' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT03
                      , NVL(CASE WHEN FEE_DDTN_TP_CD = '04' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT04
                      , NVL(CASE WHEN FEE_DDTN_TP_CD = '05' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT05
                      , NVL(CASE WHEN FEE_DDTN_TP_CD = '06' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT06
                      , NVL(CASE WHEN FEE_DDTN_TP_CD = '07' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT07
                   FROM TB_FEAM_FEE_DDTN_IZ A
                  WHERE A.FEE_DDTN_TP_CD IN ('01','02','03','04','05','07')
                    AND A.DDTN_YM = #{perfYm} /*년월*/
                    AND A.PRTNR_NO = #{no}    /*사번*/
                    AND A.OG_TP_CD = 'W03'
                    AND A.FEE_DDTN_CNFM_AMT &gt; 0 /*0원 이상*/
                  GROUP BY FEE_DDTN_TP_CD
               )
    </select>

    <select id='selectHmstControls'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$SearchHmstControlRes">
        SELECT M.DIV
             , M.ITEM
             , M.CTR_BF
             , M.CTR_AF
             , M.RSN
             , M.CTR_DTM
             , A.PRTNR_KNM AS CTRR
          FROM TB_OGBS_MM_PRTNR_IZ A
         INNER JOIN ( SELECT '공제' AS DIV
                           , B.FEE_DDTN_TP_NM AS ITEM
                           , A.FEE_DDCTAM AS CTR_BF
                           , A.FEE_DDTN_CNFM_AMT AS CTR_AF
                           , A.FEE_CTR_RSON_CN AS RSN
                           , A.FNL_MDFC_DTM AS CTR_DTM
                           , A.FEE_CTR_OG_TP_CD AS FEE_CTR_OG_TP_CD
                           , A.FEE_CTR_PRTNR_NO AS FEE_CTR_PRTNR_NO
                        FROM TB_FEAM_FEE_DDTN_IZ A
                       INNER JOIN TB_FEAM_FEE_DDTN_TP_CD B
                          ON A.FEE_DDTN_TP_CD = B.FEE_DDTN_TP_CD
                         AND B.APY_STRT_YM &lt;= #{perfYm}
                       WHERE A.DDTN_YM = #{perfYm}
                         AND A.OG_TP_CD = 'W03'
                         AND A.PRTNR_NO = #{no}
                         AND A.FEE_TCNT_DV_CD = '02'
                         AND A.SPMT_DSB_DV_CD = '01'
                       UNION ALL
                      SELECT '수수료' AS DIV
                           , B.FEE_NM AS ITEM
                           , A.FEE_CALC_AMT AS CTR_BF
                           , A.FEE_CTR_CNFM_AMT AS CTR_AF
                           , A.FEE_CTR_RSON_CN AS RSN
                           , A.FNL_MDFC_DTM AS CTR_DTM
                           , A.FEE_CTR_OG_TP_CD AS FEE_CTR_OG_TP_CD
                           , A.FEE_CTR_PRTNR_NO AS FEE_CTR_PRTNR_NO
                        FROM TB_FEAM_FEE_CALC_BAS A
                       INNER JOIN TB_FEAM_FEE_CD B
                          ON A.FEE_CD = B.FEE_CD
                       WHERE A.BASE_YM = #{perfYm}
                         AND A.OG_TP_CD = 'W03'
                         AND A.PRTNR_NO = #{no}
                         AND A.FEE_TCNT_DV_CD = '02'
                         AND A.SPMT_DSB_DV_CD = '01'
                    )M
            ON A.PRTNR_NO = M.FEE_CTR_PRTNR_NO
           AND A.OG_TP_CD = M.FEE_CTR_OG_TP_CD
         WHERE A.BASE_YM = #{perfYm}
         ORDER BY M.DIV, M.ITEM
    </select>
    <select id='selectPlarEntrp'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$FindPlarEntrpRes">
        SELECT T1.PRTNR_KNM || '(' || T1.PRTNR_NO || ')'  AS EMPL_NM
             , T1.OG_NM AS BLG
             , T1.PRTNR_NO
             , CD.CD_CNTN AS RSB
            , NVL(
                   ( SELECT DISTINCT PM.PERF_VAL
                       FROM TB_FEAM_PRTNR_PERF_MM_CL PM     /*순주문집계 확정 테이블*/
                      WHERE PM.PRTNR_NO = T1.PRTNR_NO
                        AND PM.OG_TP_CD = T1.OG_TP_CD
                        AND PM.BASE_YM = T1.BASE_YM
                        AND PM.PERF_ATC_CD = 'W01P00012'    /*미팅참석일수*/
                        AND PM.PERF_AGRG_CRT_DV_CD = '103'  /*P추진단순주문실적생성*/
                   )
                  ,0 ) AS METG     /*출석일수*/
            , CD2.CD_CNTN AS QLF
            , NVL(T2.INTBS_SUM,0) AS INTBS_SUM
            , NVL(T2.DDTN_SUM,0) AS DDTN_SUM
            , NVL(T2.ACL_DSB_AMT,0) AS ACL_DSB_AMT
         FROM TB_OGBS_MM_PRTNR_IZ T1
         LEFT OUTER JOIN ( SELECT E.PRTNR_NO
                                , E.OG_TP_CD
                                , SUM(E.INTBS_AMT) AS INTBS_SUM
                                , SUM(E.DDCTAM) AS DDTN_SUM
                                , SUM(E.DSB_OJ_AMT) AS ACL_DSB_AMT
                             FROM TB_FEAM_FEE_DSB_IZ E
                            WHERE E.DSB_YM = #{perfYm}
                              AND ( E.INTBS_AMT &gt; 0 OR E.DDCTAM &gt; 0  OR E.DSB_OJ_AMT&gt; 0 )
                              AND E.PRTNR_NO = #{no}
                            GROUP BY E.PRTNR_NO, E.OG_TP_CD
                          )T2
           ON T1.PRTNR_NO = T2.PRTNR_NO
          AND T1.OG_TP_CD = T2.OG_TP_CD
         LEFT OUTER JOIN T_CMZ_CD_D CD
           ON T1.RSB_DV_CD = CD.CD_VLD_VAL
          AND CD.CD_ID = 'RSB_DV_CD'
          AND CD.TENANT_ID = #{session.tenantId}
         LEFT OUTER JOIN T_CMZ_CD_D CD2
           ON T1.QLF_DV_CD = CD2.CD_ID
          AND CD2.CD_ID = 'QLF_DV_CD'
          AND CD2.TENANT_ID = #{session.tenantId}
        WHERE T1.BASE_YM = #{perfYm}
          AND T1.OG_TP_CD = 'W01' /*W01~03 P,M,홈마스터*/
          AND T1.PRTNR_NO = #{no}
    </select>

    <select id='selectPlarEtcs'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$SearchPlarEtcRes">
        SELECT NVL(MAX(M.ITEM1),'') AS ITEM1
             , CASE WHEN LENGTH(MAX(M.ITEM1)) > 0 THEN NVL(MAX(M.FVAL1),0) END AS FVAL1
             , NVL(MAX(M.ITEM2),'') AS ITEM2
             , CASE WHEN LENGTH(MAX(M.ITEM2)) > 0 THEN NVL(MAX(M.FVAL2),0) END AS FVAL2
             , NVL(MAX(M.ITEM3),'') AS ITEM3
             , CASE WHEN LENGTH(MAX(M.ITEM3)) > 0 THEN NVL(MAX(M.FVAL3),0) END AS FVAL3
          FROM ( SELECT TO_CHAR(T2.NW_CDN) AS ITEM1
                      , TO_CHAR(T3.PERF_VAL) AS FVAL1
                      , '' AS ITEM2
                      , '' AS FVAL2
                      , '' AS ITEM3
                      , '' AS FVAL3
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1                 /*T 개인관리 기본 T*/
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2            /*T 개인관리 상세 T*/
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '1'
                    AND T2.WK_GRP_CLSF_CD = '01'
                   LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL T3   /*T 순주문 파트너 실적 월마감 T*/
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND SUBSTR(T2.NW_CDV,1,9) = T3.PERF_ATC_CD
                    AND T3.FEE_TCNT_DV_CD = '02' /* 차수 */
                    AND T3.BASE_YM = #{perfYm}
                    AND T3.PERF_DV_CD = 0        /* 개인판매 */
                    AND T3.PRTNR_NO = #{no}
                    AND T3.PERF_AGRG_CRT_DV_CD = '101'  /* P조직 순주문실적 생성 */
                  WHERE #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                    AND T1.OG_TP_CD = 'W01'      /*웰스 M조직*/
                  UNION
                 SELECT '' AS ITEM1
                      , '' AS FVAL1
                      , TO_CHAR(T2.NW_CDN) AS ITEM2
                      , TO_CHAR(T3.PERF_VAL) AS FVAL2
                      , '' AS ITEM3
                      , '' AS FVAL3
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '2'
                    AND T2.WK_GRP_CLSF_CD = '01'
                   LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL T3   /*T 순주문 파트너 실적 월마감 T*/
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND SUBSTR(T2.NW_CDV,1,9) = T3.PERF_ATC_CD
                    AND T3.FEE_TCNT_DV_CD = '02' /* 차수 */
                    AND T3.BASE_YM = #{perfYm}
                    AND T3.PERF_DV_CD = 2        /* 지점실적 */
                    AND T3.PRTNR_NO = #{no}
                    AND T3.PERF_AGRG_CRT_DV_CD = '101'  /* P조직 순주문실적 생성 */
                  WHERE #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                    AND T1.OG_TP_CD = 'W01'      /*웰스 M조직*/
                  UNION
                 SELECT '' AS ITEM1
                      , '' AS FVAL1
                      , '' AS ITEM2
                      , '' AS FVAL2
                      , T2.NW_CDN AS ITEM3
                      , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL3
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '3'
                    AND T2.WK_GRP_CLSF_CD = '01'
                   LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3   /*T 수수료지급 상세내역 T*/
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND SUBSTR(T2.NW_CDV,1,7) = T3.FEE_CD
                    AND T3.DSB_YM = #{perfYm}
                    AND T3.CO_CD = '2000'
                    AND T3.PRTNR_NO = #{no}
                    AND T3.FEE_TCNT_DV_CD = '02' /* 차수 */
                  WHERE #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                    AND T1.OG_TP_CD = 'W01'      /*웰스 P조직*/
                  GROUP BY T2.NW_CDN, T2.APY_SEQN
               ) M
         GROUP BY M.APY_SEQN
         ORDER BY M.APY_SEQN
    </select>

    <select id='selectPlarFee'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$SearchPlarFeeRes">
        SELECT NVL(MAX(M.ITEM1),'') AS ITEM1
             , CASE WHEN LENGTH(MAX(M.ITEM1)) > 0 THEN NVL(MAX(M.FVAL1),0) END AS FVAL1
             , NVL(MAX(M.ITEM2),'') AS ITEM2
             , CASE WHEN LENGTH(MAX(M.ITEM2)) > 0 THEN NVL(MAX(M.FVAL2),0) END AS FVAL2
             , NVL(MAX(M.ITEM3),'') AS ITEM3
             , CASE WHEN LENGTH(MAX(M.ITEM3)) > 0 THEN NVL(MAX(M.FVAL3),0) END AS FVAL3
          FROM ( SELECT TO_CHAR(T2.NW_CDN) AS ITEM1
                      , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL1
                      , '' AS ITEM2
                      , '' AS FVAL2
                      , '' AS ITEM3
                      , '' AS FVAL3
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1                 /*T 개인관리 기본 T*/
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2            /*T 개인관리 상세 T*/
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '1'
                    AND T2.WK_GRP_CLSF_CD = '02'
                   LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND T2.NW_CDV = T3.FEE_CD
                    AND T3.DSB_YM = #{perfYm}
                    AND T3.PRTNR_NO = #{no}
                    AND T3.FEE_TCNT_DV_CD = '02'  /* 차수구분 */
                  WHERE T1.OG_TP_CD = 'W01'
                    AND #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                  GROUP BY T2.NW_CDN, T2.APY_SEQN
                  UNION
                 SELECT '' AS ITEM1
                      , '' AS FVAL1
                      , TO_CHAR(T2.NW_CDN) AS ITEM2
                      , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL2
                      , '' AS ITEM3
                      , '' AS FVAL3
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '2'
                    AND T2.WK_GRP_CLSF_CD = '02'
                   LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND T2.NW_CDV = T3.FEE_CD
                    AND T3.DSB_YM = #{perfYm}
                    AND T3.PRTNR_NO = #{no}
                    AND T3.FEE_TCNT_DV_CD = '02'  /* 차수구분 */
                  WHERE T1.OG_TP_CD = 'W01'
                    AND #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                  GROUP BY T2.NW_CDN, T2.APY_SEQN
                  UNION
                 SELECT '' AS ITEM1
                      , '' AS FVAL1
                      , '' AS ITEM2
                      , '' AS FVAL2
                      , T2.NW_CDN AS ITEM3
                      , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL3
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '3'
                    AND T2.WK_GRP_CLSF_CD = '02'
                   LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND T2.NW_CDV = T3.FEE_CD
                    AND T3.DSB_YM = #{perfYm}
                    AND T3.PRTNR_NO = #{no}
                    AND T3.FEE_TCNT_DV_CD = '02'  /* 차수구분 */
                  WHERE T1.OG_TP_CD = 'W01'
                    AND #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                  GROUP BY T2.NW_CDN, T2.APY_SEQN
               ) M
         GROUP BY M.APY_SEQN
         ORDER BY M.APY_SEQN
    </select>

    <select id='selectPlarDeduction'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$FindPlarDeductionRes">
        SELECT NVL(MAX(AMT01),0) AS RDS
             , NVL(MAX(AMT02),0) AS ERNTX
             , NVL(MAX(AMT03),0) AS RSDNTX
             , NVL(MAX(AMT05),0) AS HIR_INSR
             , NVL(MAX(AMT07),0) AS BU_DDTN
             , NVL(MAX(AMT04),0) AS PNPYAM
          FROM ( SELECT NVL(CASE WHEN FEE_DDTN_TP_CD = '01' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT01
                      , NVL(CASE WHEN FEE_DDTN_TP_CD = '02' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT02
                      , NVL(CASE WHEN FEE_DDTN_TP_CD = '03' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT03
                      , NVL(CASE WHEN FEE_DDTN_TP_CD = '05' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT05
                      , NVL(CASE WHEN FEE_DDTN_TP_CD = '07' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT07
                      , NVL(CASE WHEN FEE_DDTN_TP_CD = '04' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT04
                   FROM TB_FEAM_FEE_DDTN_IZ A
                  WHERE A.FEE_DDTN_TP_CD IN ('01','02','03','04','05','07')
                    AND A.DDTN_YM = #{perfYm} /*년월*/
                    AND A.PRTNR_NO = #{no}    /*사번*/
                    AND A.OG_TP_CD = 'W01'    /*P조직*/
                    AND A.FEE_DDTN_CNFM_AMT &gt; 0 /*0원 이상*/
                  GROUP BY FEE_DDTN_TP_CD
               )
    </select>

    <select id='selectPlarControls'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$SearchPlarControlRes">
        SELECT M.DIV
             , M.ITEM
             , M.CTR_BF
             , M.CTR_AF
             , M.RSN
             , M.CTR_DTM
             , A.PRTNR_KNM AS CTRR
          FROM TB_OGBS_MM_PRTNR_IZ A
        INNER JOIN ( SELECT '공제' AS DIV
                          , B.FEE_DDTN_TP_NM AS ITEM
                          , A.FEE_DDCTAM AS CTR_BF
                          , A.FEE_DDTN_CNFM_AMT AS CTR_AF
                          , A.FEE_CTR_RSON_CN AS RSN
                          , A.FNL_MDFC_DTM AS CTR_DTM
                          , A.FEE_CTR_OG_TP_CD AS FEE_CTR_OG_TP_CD
                          , A.FEE_CTR_PRTNR_NO AS FEE_CTR_PRTNR_NO
                       FROM TB_FEAM_FEE_DDTN_IZ A
                      INNER JOIN TB_FEAM_FEE_DDTN_TP_CD B
                          ON A.FEE_DDTN_TP_CD = B.FEE_DDTN_TP_CD
                          AND B.APY_STRT_YM &lt;= #{perfYm}
                          WHERE A.DDTN_YM = #{perfYm}
                          AND A.OG_TP_CD = 'W01' /*P조직*/
                          AND A.PRTNR_NO = #{no}
                         AND A.FEE_TCNT_DV_CD = '02'
                          AND A.SPMT_DSB_DV_CD = '01'
                     UNION ALL
                     SELECT '수수료' AS DIV
                          , B.FEE_NM AS ITEM
                          , A.FEE_CALC_AMT AS CTR_BF
                          , A.FEE_CTR_CNFM_AMT AS CTR_AF
                          , A.FEE_CTR_RSON_CN AS RSN
                          , A.FNL_MDFC_DTM AS CTR_DTM
                          , A.FEE_CTR_OG_TP_CD AS FEE_CTR_OG_TP_CD
                          , A.FEE_CTR_PRTNR_NO AS FEE_CTR_PRTNR_NO
                       FROM TB_FEAM_FEE_CALC_BAS A
                      INNER JOIN TB_FEAM_FEE_CD B
                         ON A.FEE_CD = B.FEE_CD
                      WHERE A.BASE_YM = #{perfYm}
                        AND A.OG_TP_CD = 'W01' /*P조직*/
                        AND A.PRTNR_NO = #{no}
                        AND A.FEE_TCNT_DV_CD = '02'
                        AND A.SPMT_DSB_DV_CD = '01'
                    )M
         ON A.PRTNR_NO = M.FEE_CTR_PRTNR_NO
        AND A.OG_TP_CD = M.FEE_CTR_OG_TP_CD
      WHERE A.BASE_YM = #{perfYm}
      ORDER BY M.DIV, M.ITEM
    </select>

    <select id='selectMngerEntrp'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$FindMngerEntrpRes">
        SELECT T1.PRTNR_KNM AS EMPL_NM             /* 성명 */
             , T2.DGR1_LEVL_OG_NM AS MNG_DPT       /* 총괄단 */
             , T2.DGR2_LEVL_OG_NM AS RGNL_GRP      /* 지역단 */
             , T2.DGR3_LEVL_OG_NM AS BRANCH        /* 지점 */
             , CD1.CD_CNTN AS RSB                  /* 직책 */
             , T1.CNTR_DT AS RGS_BASE_MM           /* 등록기준월 = 계약월 */
             , T1.PRFMT_DT AS PRFMT_MON            /* 승진월 */
             , T1.CLTN_DT AS BIZ_CLTN_MON          /* 업무해약월 */
             , CD2.CD_CNTN AS QLF                  /* 자격 */
             , SUBSTR(T3.CV_DT,0,6) AS OPNG_MM     /* 개시월 = 웰스매니저 승급 전환월 */
             , CASE WHEN NVL(T3.ENDDT,0) = 0 THEN MONTHS_BETWEEN(SYSDATE, TO_DATE(T3.CV_DT, 'YYYY-MM-DD'))
                    ELSE MONTHS_BETWEEN(T3.ENDDT, TO_DATE(T3.CV_DT, 'YYYY-MM-DD'))
               END AS OPNG_NMM                                  /* 개시차월 = 해약일자 - 전환일자 */
             , NVL(SUBSTR(T3.ENDDT,0,6),0) AS MNG_CLTN_MM      /* 매니저 해약월 */
             , NVL(T4.MGT_CNT,0) AS MGT_CNT /* BS 총 관리건수 */
             , NVL(T4.VST_CNT,0) AS VST_CNT /* BS 총 방문건수 */
             , NVL(T4.PROCS_RT,0) AS PROCS_RT /* BS 방문율 */
             , NVL(T5.INTBS_AMT,0) AS INTBS_SUM
             , NVL(T5.DDCTAM,0) AS DDTN_SUM
             , NVL(T5.DSB_OJ_AMT,0) AS ACL_DSB_AMT
          FROM TB_OGBS_MM_PRTNR_IZ T1 /* T 월파트너내역 T */
         INNER JOIN TB_OGBS_MM_OG_IZ T2 /* T 월조직내역 T */
            ON T1.OG_TP_CD = T2.OG_TP_CD
           AND T1.BASE_YM = T2.BASE_YM
           AND T1.OG_ID = T2.OG_ID
          LEFT OUTER JOIN ( SELECT ROW_NUMBER() OVER (PARTITION BY PRTNR_NO ORDER BY CV_DT DESC) AS RANK
                                 , SUBSTR(CV_DT,0,6) AS CV_DT
                                 , SUBSTR(ENDDT,0,6) AS ENDDT
                                 , PRTNR_NO
                              FROM TB_OGPS_PLAR_QLF_CH_IZ /*플래너 자격 변경내역*/
                             WHERE OG_TP_CD = 'W02'
                               AND QLF_DV_CD = '3'  /* 웰스매니저 */
                               AND QLF_APLC_DV_CD = '1'  /* 승급 */
                               AND DTA_DL_YN = 'N'
                          )T3
            ON T1.PRTNR_NO = T3.PRTNR_NO
           AND T3.RANK = 1   /* 마지막 웰스매니저 승급정보 */
          LEFT OUTER JOIN ( SELECT T.PRTNR_NO
                                 , NVL(SUM(T.COL1),0) AS MGT_CNT
                                 , NVL(SUM(T.COL2),0) AS VST_CNT
                                 , ROUND(NVL(SUM(T.COL2),0)/NVL(SUM(T.COL1),0)*100, 2) AS PROCS_RT
                              FROM ( SELECT BS.PRTNR_NO
                                          , CASE WHEN GI.PRTNR_PERF_DTLP_ATC_CDV4 = '01' THEN BS.PERF_VAL END AS COL1
                                          , CASE WHEN GI.PRTNR_PERF_DTLP_ATC_CDV4 = '02' THEN BS.PERF_VAL END AS COL2
                                       FROM TB_FEAM_WPTN_SV_PERF_AGRG BS
                                      INNER JOIN TB_FEAM_WPTN_SV_PERF_ATC_CD GI
                                         ON BS.PRTNR_SV_PERF_ATC_CD = GI.PRTNR_SV_PERF_ATC_CD
                                        AND SUBSTR(GI.PRTNR_SV_PERF_ATC_CD,1,4) = CASE WHEN BS.BASE_YM &lt; '202207' THEN 'SV01' ELSE 'SV08' END /*202207년 이후는 구분코드 08*/
                                        AND GI.PRTNR_PERF_DTLP_ATC_CDV3 = '01' /* 일반 */
                                        AND GI.PRTNR_PERF_DTLP_ATC_CDV2 != '99'
                                      WHERE BS.BASE_YM = #{perfYm}
                                        AND BS.PRTNR_NO = #{no}
                                        AND BS.CL_DV_CD = '02'
                                        AND BS.OG_TP_CD = 'W02'
                                      UNION ALL
                                     SELECT BS.PRTNR_NO
                                          , CASE WHEN GI.PRTNR_PERF_DTLP_ATC_CDV4 = '01' THEN BS.PERF_VAL END AS COL1
                                          , CASE WHEN GI.PRTNR_PERF_DTLP_ATC_CDV4 = '02' THEN BS.PERF_VAL END AS COL2
                                       FROM TB_FEAM_WPTN_SV_PERF_AGRG BS
                                      INNER JOIN TB_FEAM_WPTN_SV_PERF_ATC_CD GI
                                         ON BS.PRTNR_SV_PERF_ATC_CD = GI.PRTNR_SV_PERF_ATC_CD
                                        AND SUBSTR(GI.PRTNR_SV_PERF_ATC_CD,1,4) = 'SV08'
                                        AND GI.PRTNR_PERF_DTLP_ATC_CDV3 = '02' /* 정액 */
                                        AND GI.PRTNR_PERF_DTLP_ATC_CDV2 != '99'
                                      WHERE BS.BASE_YM = #{perfYm}
                                        AND BS.PRTNR_NO = #{no}
                                        AND BS.CL_DV_CD = '02'
                                        AND BS.OG_TP_CD = 'W02'
                                   )T
                             GROUP BY T.PRTNR_NO
                          )T4
            ON T1.PRTNR_NO = T4.PRTNR_NO
        LEFT OUTER JOIN TB_FEAM_FEE_DSB_IZ T5
          ON T1.BASE_YM = T5.DSB_YM
         AND T1.OG_TP_CD = T5.OG_TP_CD
         AND T1.PRTNR_NO = T5.PRTNR_NO
         AND T5.CO_CD = #{session.companyCode}
         AND T5.FEE_TCNT_DV_CD = '02'
         AND T5.SPMT_DSB_DV_CD = '01'
        LEFT OUTER JOIN T_CMZ_CD_D CD1
          ON T1.RSB_DV_CD = CD1.CD_VLD_VAL
         AND CD1.CD_ID = 'RSB_DV_CD'
         AND CD1.TENANT_ID = 'TNT_WELLS'
        LEFT OUTER JOIN T_CMZ_CD_D CD2
          ON T1.QLF_DV_CD = CD2.CD_VLD_VAL
         AND CD2.CD_ID = 'QLF_DV_CD'
         AND CD2.TENANT_ID = 'TNT_WELLS'
       WHERE T1.BASE_YM = #{perfYm}
         AND T1.OG_TP_CD = 'W02'     /* M 조직 */
         AND T1.PRTNR_NO = #{no}
    </select>

    <select id='selectMngerBaseInfo'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$SearchMngerBaseInfoRes">
        SELECT NVL(MAX(M.ITEM1),'') AS ITEM1
             , CASE WHEN LENGTH(MAX(M.ITEM1)) > 0 THEN NVL(MAX(M.FVAL1),0) END AS FVAL1
             , NVL(MAX(M.ITEM2),'') AS ITEM2
             , CASE WHEN LENGTH(MAX(M.ITEM2)) > 0 THEN NVL(MAX(M.FVAL2),0) END AS FVAL2
             , NVL(MAX(M.ITEM3),'') AS ITEM3
             , CASE WHEN LENGTH(MAX(M.ITEM3)) > 0 THEN NVL(MAX(M.FVAL3),0) END AS FVAL3
             , NVL(MAX(M.ITEM4),'') AS ITEM4
             , CASE WHEN LENGTH(MAX(M.ITEM4)) > 0 THEN NVL(MAX(M.FVAL4),0) END AS FVAL4
          FROM ( SELECT TO_CHAR(T2.NW_CDN) AS ITEM1
                      , TO_CHAR(T3.PERF_VAL) AS FVAL1
                      , '' AS ITEM2
                      , '' AS FVAL2
                      , '' AS ITEM3
                      , '' AS FVAL3
                      , '' AS ITEM4
                      , '' AS FVAL4
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1                 /*T 개인관리 기본 T*/
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2            /*T 개인관리 상세 T*/
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '1'
                    AND T2.WK_GRP_CLSF_CD = '01'
                   LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL T3   /*T 순주문 파트너 실적 월마감 T*/
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND SUBSTR(T2.NW_CDV,1,9) = T3.PERF_ATC_CD
                    AND T3.FEE_TCNT_DV_CD = '02' /* 차수 */
                    AND T3.BASE_YM = #{perfYm}
                    AND T3.PERF_DV_CD = 0        /* 개인판매 */
                    AND T3.PRTNR_NO = #{no}
                    AND T3.PERF_AGRG_CRT_DV_CD = '201'  /* M조직 순주문실적 생성 */
                  WHERE #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                    AND T1.OG_TP_CD = 'W02'      /*웰스 M조직*/
                  UNION ALL
                 SELECT '' AS ITEM1
                      , '' AS FVAL1
                      , TO_CHAR(T2.NW_CDN) AS ITEM2
                      , TO_CHAR(T3.PERF_VAL) AS FVAL2
                      , '' AS ITEM3
                      , '' AS FVAL3
                      , '' AS ITEM4
                      , '' AS FVAL4
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '2'
                    AND T2.WK_GRP_CLSF_CD = '01'
                   LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL T3   /*T 순주문 파트너 실적 월마감 T*/
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND SUBSTR(T2.NW_CDV,1,9) = T3.PERF_ATC_CD
                    AND T3.FEE_TCNT_DV_CD = '02' /* 차수 */
                    AND T3.BASE_YM = #{perfYm}
                    AND T3.PERF_DV_CD = 2        /* 지점실적 */
                    AND T3.PRTNR_NO = #{no}
                    AND T3.PERF_AGRG_CRT_DV_CD = '201'  /* M조직 순주문실적 생성 */
                  WHERE #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                    AND T1.OG_TP_CD = 'W02'      /*웰스 M조직*/
                  UNION
                 SELECT '' AS ITEM1
                      , '' AS FVAL1
                      , '' AS ITEM2
                      , '' AS FVAL2
                      , T2.NW_CDN AS ITEM3
                      , CASE WHEN SUBSTR(T2.NW_CDV,10,1) = '0' THEN TO_CHAR(T3.PERF_VAL)      /* 개인실적 */
                             WHEN SUBSTR(T2.NW_CDV,10,1) = '2' THEN TO_CHAR(T4.PERF_VAL)      /* 조직실적 */
                        END AS FVAL3
                      , '' AS ITEM4
                      , '' AS FVAL4
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '3'
                    AND T2.WK_GRP_CLSF_CD = '01'
                   LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL T3   /*T 순주문 파트너 실적 월마감 T*/
                     ON SUBSTR(T2.NW_CDV,1,9) = T3.PERF_ATC_CD
                    AND T3.FEE_TCNT_DV_CD = '02' /* 차수 */
                    AND T3.BASE_YM = #{perfYm}
                    AND T3.PERF_DV_CD = 0        /* 개인판매 */
                    AND T3.PRTNR_NO = #{no}
                    AND T3.PERF_AGRG_CRT_DV_CD = '201'  /* M조직 순주문실적 생성 */
                   LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL T4   /*T 순주문 파트너 실적 월마감 T*/
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND SUBSTR(T2.NW_CDV,1,9) = T3.PERF_ATC_CD
                    AND T4.FEE_TCNT_DV_CD = '02' /* 차수 */
                    AND T4.BASE_YM = #{perfYm}
                    AND T4.PERF_DV_CD = 2        /* 조직판매 */
                    AND T4.PRTNR_NO = #{no}
                    AND T4.PERF_AGRG_CRT_DV_CD = '201'  /* M조직 순주문실적 생성 */
                  WHERE #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                    AND T1.OG_TP_CD = 'W02'      /*웰스 M조직*/
                  UNION
                 SELECT '' AS ITEM1
                      , '' AS FVAL1
                      , '' AS ITEM2
                      , '' AS FVAL2
                      , '' AS ITEM3
                      , '' AS FVAL3
                      , TO_CHAR(T2.NW_CDN) AS ITEM3
                      , TO_CHAR(T3.PERF_VAL) AS FVAL4
                      , T2.APY_SEQN
                   FROM TB_FEAM_INDV_MNGT_BAS T1
                  INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                     ON T1.VER_SN = T2.VER_SN
                    AND T1.OG_TP_CD = T2.OG_TP_CD
                    AND T2.IDV_ATC_CD = '4'
                    AND T2.WK_GRP_CLSF_CD = '01'
                   LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL T3   /*T 순주문 파트너 실적 월마감 T*/
                     ON T1.OG_TP_CD = T3.OG_TP_CD
                    AND SUBSTR(T2.NW_CDV,1,9) = T3.PERF_ATC_CD
                    AND T3.FEE_TCNT_DV_CD = '02' /* 차수 */
                    AND T3.BASE_YM = #{perfYm}
                    AND T3.PERF_DV_CD = 0        /* 개인판매 */
                    AND T3.PRTNR_NO = #{no}
                    AND T3.PERF_AGRG_CRT_DV_CD = '201'  /* M조직 순주문실적 생성 */
                  WHERE #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                    AND T1.OG_TP_CD = 'W02'      /*웰스 M조직*/
               ) M
         GROUP BY M.APY_SEQN
         ORDER BY M.APY_SEQN
    </select>

    <select id='selectMngerBeforeServices'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$SearchMngerBeforeServiceRes">
        SELECT CD_NM AS CD_NM
             , MAX(CNT1) AS CNT1
             , MAX(CNT2) AS CNT2
             , MAX(AMT1) AS AMT1
             , MAX(CNT3) AS CNT3
             , MAX(CNT4) AS CNT4
             , MAX(AMT2) AS AMT2
             , MAX(AMT1)+MAX(AMT2) AS SUM_AMT
          FROM ( SELECT CD_NM
                      , SV_CD
                      , SV_CD2
                      , NVL(SUM(COL1),0) AS CNT1
                      , NVL(SUM(COL2),0) AS CNT2
                      , NVL(SUM(COL3),0) AS AMT1
                      , 0 AS CNT3
                      , 0 AS CNT4
                      , 0 AS AMT2
                   FROM ( SELECT GI.PRTNR_PERF_DTLP_ATC_CDN2 AS CD_NM
                               , PRTNR_PERF_DTLP_ATC_CDV1||PRTNR_PERF_DTLP_ATC_CDV2 AS SV_CD
                               , PRTNR_PERF_DTLP_ATC_CDV2 AS SV_CD2
                               , CASE WHEN GI.PRTNR_PERF_DTLP_ATC_CDV4 = '01' THEN BS.PERF_VAL END AS COL1
                               , CASE WHEN GI.PRTNR_PERF_DTLP_ATC_CDV4 = '02' THEN BS.PERF_VAL END AS COL2
                               , CASE WHEN GI.PRTNR_PERF_DTLP_ATC_CDV4 = '04' THEN BS.PERF_VAL END AS COL3
                            FROM TB_FEAM_WPTN_SV_PERF_AGRG BS
                           INNER JOIN TB_FEAM_WPTN_SV_PERF_ATC_CD GI
                              ON BS.PRTNR_SV_PERF_ATC_CD = GI.PRTNR_SV_PERF_ATC_CD
                             AND SUBSTR(GI.PRTNR_SV_PERF_ATC_CD,1,4) = CASE WHEN BS.BASE_YM &lt; '202207' THEN 'SV01' ELSE 'SV08' END /*202207년 이후는 구분코드 08*/
                             AND GI.PRTNR_PERF_DTLP_ATC_CDV3 = '01' /* 일반 */
                             AND GI.PRTNR_PERF_DTLP_ATC_CDV2 != '99'
                           WHERE BS.BASE_YM = #{perfYm}
                             AND BS.PRTNR_NO = #{no}
                             AND BS.CL_DV_CD = '02'
                             AND BS.OG_TP_CD = 'W02'
                        )
                  GROUP BY CD_NM, SV_CD, SV_CD2
                  UNION
                 SELECT CD_NM
                      , SV_CD
                      , SV_CD2
                      , 0 AS CNT1
                      , 0 AS CNT2
                      , 0 AS AMT1
                      , CASE WHEN BASE_YM &lt; '202207' THEN 0 ELSE NVL(SUM(COL1),0) END AS CNT3   /*202007 이전은 정액 0원*/
                      , CASE WHEN BASE_YM &lt; '202207' THEN 0 ELSE NVL(SUM(COL2),0) END AS CNT4
                      , CASE WHEN BASE_YM &lt; '202207' THEN 0 ELSE NVL(SUM(COL3),0) END AS AMT2
                   FROM ( SELECT GI.PRTNR_PERF_DTLP_ATC_CDN2 AS CD_NM
                               , PRTNR_PERF_DTLP_ATC_CDV1||PRTNR_PERF_DTLP_ATC_CDV2 AS SV_CD
                               , PRTNR_PERF_DTLP_ATC_CDV2 AS SV_CD2
                               , BS.BASE_YM
                               , CASE WHEN GI.PRTNR_PERF_DTLP_ATC_CDV4 = '01' THEN BS.PERF_VAL END AS COL1
                               , CASE WHEN GI.PRTNR_PERF_DTLP_ATC_CDV4 = '02' THEN BS.PERF_VAL END AS COL2
                               , CASE WHEN GI.PRTNR_PERF_DTLP_ATC_CDV4 = '04' THEN BS.PERF_VAL END AS COL3
                            FROM TB_FEAM_WPTN_SV_PERF_AGRG BS
                           INNER JOIN TB_FEAM_WPTN_SV_PERF_ATC_CD GI
                              ON BS.PRTNR_SV_PERF_ATC_CD = GI.PRTNR_SV_PERF_ATC_CD
                             AND SUBSTR(GI.PRTNR_SV_PERF_ATC_CD,1,4) = 'SV08'
                             AND GI.PRTNR_PERF_DTLP_ATC_CDV3 = '02' /* 정액 */
                             AND GI.PRTNR_PERF_DTLP_ATC_CDV2 != '99'
                           WHERE BS.BASE_YM = #{perfYm}
                             AND BS.PRTNR_NO = #{no}
                             AND BS.CL_DV_CD = '02'
                             AND BS.OG_TP_CD = 'W02'
                        )
                  GROUP BY CD_NM, BASE_YM, SV_CD, SV_CD2
               )
         GROUP BY CD_NM, SV_CD, SV_CD2
         ORDER BY SV_CD2
    </select>

    <select id='selectMngerFees'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$SearchMngerFeeRes">
        SELECT NVL(MAX(M.ITEM1),'') AS ITEM1
             , CASE WHEN LENGTH(MAX(M.ITEM1)) > 0 THEN NVL(MAX(M.FVAL1),0) END AS FVAL1
             , NVL(MAX(M.ITEM2),'') AS ITEM2
             , CASE WHEN LENGTH(MAX(M.ITEM2)) > 0 THEN NVL(MAX(M.FVAL2),0) END AS FVAL2
             , NVL(MAX(M.ITEM3),'') AS ITEM3
             , CASE WHEN LENGTH(MAX(M.ITEM3)) > 0 THEN NVL(MAX(M.FVAL3),0) END AS FVAL3
             , NVL(MAX(M.ITEM4),'') AS ITEM4
             , CASE WHEN LENGTH(MAX(M.ITEM4)) > 0 THEN NVL(MAX(M.FVAL4),0) END AS FVAL4
        FROM ( SELECT TO_CHAR(T2.NW_CDN) AS ITEM1
                    , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL1
                    , '' AS ITEM2
                    , '' AS FVAL2
                    , '' AS ITEM3
                    , '' AS FVAL3
                    , '' AS ITEM4
                    , '' AS FVAL4
                    , T2.APY_SEQN
                 FROM TB_FEAM_INDV_MNGT_BAS T1                 /*T 개인관리 기본 T*/
                INNER JOIN TB_FEAM_INDV_MNGT_DTL T2            /*T 개인관리 상세 T*/
                   ON T1.VER_SN = T2.VER_SN
                  AND T1.OG_TP_CD = T2.OG_TP_CD
                  AND T2.IDV_ATC_CD = '1'
                  AND T2.WK_GRP_CLSF_CD = '02'
                 LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3
                   ON T1.OG_TP_CD = T3.OG_TP_CD
                  AND T2.NW_CDV = T3.FEE_CD
                  AND T3.DSB_YM = #{perfYm}
                  AND T3.PRTNR_NO = #{no}
                  AND T3.FEE_TCNT_DV_CD = '02'  /* 차수구분 */
                WHERE T1.OG_TP_CD = 'W02'
                  AND #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                GROUP BY T2.NW_CDN, T2.APY_SEQN
                UNION
               SELECT '' AS ITEM1
                    , '' AS FVAL1
                    , TO_CHAR(T2.NW_CDN) AS ITEM2
                    , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL2
                    , '' AS ITEM3
                    , '' AS FVAL3
                    , '' AS ITEM4
                    , '' AS FVAL4
                    , T2.APY_SEQN
                 FROM TB_FEAM_INDV_MNGT_BAS T1
                INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                   ON T1.VER_SN = T2.VER_SN
                  AND T1.OG_TP_CD = T2.OG_TP_CD
                  AND T2.IDV_ATC_CD = '2'
                  AND T2.WK_GRP_CLSF_CD = '02'
                 LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3
                   ON T1.OG_TP_CD = T3.OG_TP_CD
                  AND T2.NW_CDV = T3.FEE_CD
                  AND T3.DSB_YM = #{perfYm}
                  AND T3.PRTNR_NO = #{no}
                  AND T3.FEE_TCNT_DV_CD = '02'  /* 차수구분 */
                WHERE T1.OG_TP_CD = 'W02'
                  AND #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                GROUP BY T2.NW_CDN, T2.APY_SEQN
                UNION
               SELECT '' AS ITEM1
                    , '' AS FVAL1
                    , '' AS ITEM2
                    , '' AS FVAL2
                    , T2.NW_CDN AS ITEM3
                    , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL3
                    , '' AS ITEM4
                    , '' AS FVAL4
                    , T2.APY_SEQN
                 FROM TB_FEAM_INDV_MNGT_BAS T1
                INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                   ON T1.VER_SN = T2.VER_SN
                  AND T1.OG_TP_CD = T2.OG_TP_CD
                  AND T2.IDV_ATC_CD = '3'
                  AND T2.WK_GRP_CLSF_CD = '02'
                 LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3
                   ON T1.OG_TP_CD = T3.OG_TP_CD
                  AND T2.NW_CDV = T3.FEE_CD
                  AND T3.DSB_YM = #{perfYm}
                  AND T3.PRTNR_NO = #{no}
                  AND T3.FEE_TCNT_DV_CD = '02'  /* 차수구분 */
                WHERE T1.OG_TP_CD = 'W02'
                  AND #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                GROUP BY T2.NW_CDN, T2.APY_SEQN
                UNION
               SELECT '' AS ITEM1
                    , '' AS FVAL1
                    , '' AS ITEM2
                    , '' AS FVAL2
                    , '' AS ITEM3
                    , '' AS FVAL3
                    , TO_CHAR(T2.NW_CDN) AS ITEM3
                    , TO_CHAR(SUM(T3.FEE_ATC_VAL)) AS FVAL4
                    , T2.APY_SEQN
                 FROM TB_FEAM_INDV_MNGT_BAS T1
                INNER JOIN TB_FEAM_INDV_MNGT_DTL T2
                   ON T1.VER_SN = T2.VER_SN
                  AND T1.OG_TP_CD = T2.OG_TP_CD
                  AND T2.IDV_ATC_CD = '4'
                  AND T2.WK_GRP_CLSF_CD = '02'
                 LEFT OUTER JOIN TB_FEAM_FEE_DSB_DTL_IZ T3
                   ON T1.OG_TP_CD = T3.OG_TP_CD
                  AND T2.NW_CDV = T3.FEE_CD
                  AND T3.DSB_YM = #{perfYm}
                  AND T3.PRTNR_NO = #{no}
                  AND T3.FEE_TCNT_DV_CD = '02'  /* 차수구분 */
                WHERE T1.OG_TP_CD = 'W02'
                  AND #{perfYm} BETWEEN T1.APY_STRTMM AND T1.APY_END_MM
                GROUP BY T2.NW_CDN, T2.APY_SEQN
             ) M
       GROUP BY M.APY_SEQN
       ORDER BY M.APY_SEQN
    </select>

    <select id='selectMngerDeduction'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$FindMngerDeductionRes">
        SELECT NVL(MAX(AMT01),0) AS RDS
             , NVL(MAX(AMT02),0) AS ERNTX
             , NVL(MAX(AMT03),0) AS RSDNTX
             , NVL(MAX(AMT05),0) AS HIR_INSR
             , NVL(MAX(AMT07),0) AS BU_DDTN
             , NVL(MAX(AMT04),0) AS PNPYAM
        FROM ( SELECT NVL(CASE WHEN FEE_DDTN_TP_CD = '01' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT01
                    , NVL(CASE WHEN FEE_DDTN_TP_CD = '02' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT02
                    , NVL(CASE WHEN FEE_DDTN_TP_CD = '03' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT03
                    , NVL(CASE WHEN FEE_DDTN_TP_CD = '05' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT05
                    , NVL(CASE WHEN FEE_DDTN_TP_CD = '07' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT07
                    , NVL(CASE WHEN FEE_DDTN_TP_CD = '04' THEN SUM(A.FEE_DDTN_CNFM_AMT) END,0) AS AMT04
                 FROM TB_FEAM_FEE_DDTN_IZ A
                WHERE A.FEE_DDTN_TP_CD IN ('01','02','03','04','05','07')
                  AND A.DDTN_YM = #{perfYm}  /*년월*/
                  AND A.CO_CD = '2000'
                  AND A.OG_TP_CD = 'W02'   /*M조직*/
                  AND A.PRTNR_NO = #{no} /*사번*/
                  AND A.FEE_TCNT_DV_CD  = '02'    /* 수수료차수구분코드 */
                  AND A.SPMT_DSB_DV_CD  = '01'    /* 추가지급구분코드 - 01정상지급 */
                  AND A.FEE_DDTN_CNFM_AMT &gt; 0 /*0원 이상*/
                GROUP BY FEE_DDTN_TP_CD
              )
    </select>

    <select id='selectMngerControls'
            resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedIndividualFeeMgtDto$SearchMngerControlRes">
        SELECT M.DIV
             , M.ITEM
             , M.CTR_BF
             , M.CTR_AF
             , M.RSN
             , M.CTR_DTM
             , A.PRTNR_KNM AS CTRR
          FROM TB_OGBS_MM_PRTNR_IZ A
         INNER JOIN ( SELECT '공제' AS DIV
                           , B.FEE_DDTN_TP_NM AS ITEM
                           , A.FEE_DDCTAM AS CTR_BF
                           , A.FEE_DDTN_CNFM_AMT AS CTR_AF
                           , A.FEE_CTR_RSON_CN AS RSN
                           , A.FNL_MDFC_DTM AS CTR_DTM
                           , A.FEE_CTR_OG_TP_CD AS FEE_CTR_OG_TP_CD
                           , A.FEE_CTR_PRTNR_NO AS FEE_CTR_PRTNR_NO
                        FROM TB_FEAM_FEE_DDTN_IZ A
                       INNER JOIN TB_FEAM_FEE_DDTN_TP_CD B
                          ON A.FEE_DDTN_TP_CD = B.FEE_DDTN_TP_CD
                         AND B.APY_STRT_YM &lt;= #{perfYm}
                       WHERE A.DDTN_YM = #{perfYm}
                         AND A.OG_TP_CD = 'W02' /*M조직*/
                         AND A.PRTNR_NO = #{no}
                         AND A.FEE_TCNT_DV_CD = '02'
                         AND A.SPMT_DSB_DV_CD = '01'
                       UNION ALL
                      SELECT '수수료' AS DIV
                           , B.FEE_NM AS ITEM
                           , A.FEE_CALC_AMT AS CTR_BF
                           , A.FEE_CTR_CNFM_AMT AS CTR_AF
                           , A.FEE_CTR_RSON_CN AS RSN
                           , A.FNL_MDFC_DTM AS CTR_DTM
                           , A.FEE_CTR_OG_TP_CD AS FEE_CTR_OG_TP_CD
                           , A.FEE_CTR_PRTNR_NO AS FEE_CTR_PRTNR_NO
                        FROM TB_FEAM_FEE_CALC_BAS A
                       INNER JOIN TB_FEAM_FEE_CD B
                          ON A.FEE_CD = B.FEE_CD
                       WHERE A.BASE_YM = #{perfYm}
                         AND A.OG_TP_CD = 'W02' /*M조직*/
                         AND A.PRTNR_NO = #{no}
                         AND A.FEE_TCNT_DV_CD = '02'
                         AND A.SPMT_DSB_DV_CD = '01'
                    )M
            ON A.PRTNR_NO = M.FEE_CTR_PRTNR_NO
           AND A.OG_TP_CD = M.FEE_CTR_OG_TP_CD
         WHERE A.BASE_YM = #{perfYm}
         ORDER BY M.DIV, M.ITEM
    </select>

</mapper>
