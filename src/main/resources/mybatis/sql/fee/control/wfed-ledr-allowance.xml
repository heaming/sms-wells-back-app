<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.control.mapper.WfedLedrAllowanceMapper">


    <select id='selectIndividualLeaderAllowances' resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedLedrAllowanceDto$SearchIndividualRes">
        SELECT SUBSTR(DSB_YM, 0, 4) || '-' || SUBSTR(DSB_YM, 5) AS DSB_YM
             , HMNRSC_EMPNO
             , OG_LEVL_DV_NM
             , OG_NM
             , HGR_OG_CD
             , OG_CD
             , PRTNR_KNM
             , BRCH_CT
             , BAS_AW_AMT	/*기본수당금액*/
             , HH_EXCP_AW_AMT	/*시간외수당금액 */
             , RSB_AW_AMT	/*직책수당금액*/
             , FXN_AW_SUM_AMT	/*고정수당합계금액*/
             , TRG_CT	/*실적목표건수*/
             , PERF_CT	/*실적건수*/
             , TRUNC(PERF_ACHV_RAT, 1) AS PERF_ACHV_RAT	/*실적달성비율*/
             , TRG_ACHV_AW_AMT	/*목표달성수당금액*/
             , BRCH_AV_PERF_CT	/*지점평균실적건수(2021년02월이전)*/
             , ENCRG_AW_AMT	/*장려수당금액(2021년02월이후)*/
             , MNGR_PERF_GD_CD	/*관리자실적등급코드(2021년02월이전)*/
             , OG_AW_AMT	/*조직수당금액(2021년02월이후)*/
             , EVL_AW_AMT	/*평가수당금액*/
             , PERF_AW_SUM_AMT	/*실적수당합계금액*/
             , EXCL_DIV_AW_AMT	/*우수사업부수당금액*/
             , ICT_AW_AMT	/*인센티브수당금액*/
             , LDSTC_ATDC_AW_AMT	/*장거리출근수당금액*/
             , MRNT_SPPT_AW_AMT	/*월세지원수당금액*/
             , LECTR_ADN_AW_AMT	/*강의부가수당금액*/
             , ETC_ADN_AW_AMT	/*기타부가수당금액*/
             , ETC_ADN_AW_SUM_AMT	/*기타부가수당합계금액*/
             , FXN_PERF_AW_SUM_AMT	/*고정실적수당합계금액(고정급+업적수당)*/
             , AW_CALC_SUM_AMT	/*수당계산합계금액*/
             , HINSR_DDCTAM	/*건강보험공제금액*/
             , NRSN_INSR_DDCTAM	/*요양보험공제금액*/
             , NTNL_PNSN_DDCTAM	/*국민연금공제금액*/
             , EINSR_DDCTAM	/*고용보험공제금액*/
             , ERNTX	/*소득세*/
             , RSDNTX	/*주민세*/
             , CRPT_BZNS_DDCTAM	/*비정도영업조치금*/
             , EDDTN_AMT	/*기타공제금액*/
             , DDTN_SUM_AMT	/*공제합계금액*/
             , ACPY_AMT	/*실지급액*/
          FROM TB_FEAM_WELS_MNGR_AW_IZ
         WHERE DTA_DL_YN = 'N'
           AND DSB_YM = #{perfYm}
        <if test='@MybatisUtils@isNotEmpty(no)'>
           AND HMNRSC_EMPNO = #{no}
        </if>
        <if test='@MybatisUtils@isNotEmpty(rsbDvCd) and @MybatisUtils@equals(rsbDvCd, "W0202")'>
           /*총괄단장인 경우*/
           AND OG_CD LIKE '%000000'
        </if>
        <if test='@MybatisUtils@isNotEmpty(rsbDvCd) and @MybatisUtils@equals(rsbDvCd, "W0203")'>
           /*지역단장인 경우*/
           AND OG_CD LIKE '%0000'
           AND HGR_OG_CD != OG_CD
        </if>
           AND OG_CD IN
             ( SELECT SUB1.OG_CD
                 FROM /* 현재 관리중인 사업자 조회(로그인 사용자 기준) */
                    ( SELECT Y.OG_CD
                        FROM TB_OGBS_MM_PRTNR_IZ Y  /*월파트너내역*/
                       WHERE Y.DTA_DL_YN = 'N'
                         AND Y.BASE_YM = #{perfYm}
                         AND Y.OG_TP_CD IN ('W01', 'W02')
                        /*TODO: 아래 쿼리 세션정보로 수정 필요, 지원조직내역 이관 완료 후 쿼리 재작성 필요*/
                    <if test='@MybatisUtils@equals(lgnUsrUserGrp, "100") and @MybatisUtils@equals(lgnUsrDtrs, "110")'>
                         /* 업무담당 그룹중에 업무담당만 권한체크(BM,BM팀장은 스킵) */
                         AND (Y.OG_TP_CD, Y.OG_CD) IN /* 로그인한 업무담당이 관리하는 조직코드 */
                           ( SELECT X.OG_TP_CD
                                  , B.OG_CD
                               FROM TB_OGBS_SPPT_OG_IZ X
                              INNER JOIN
                                  ( SELECT A.OG_ID
                                         , A.OG_CD
                                      FROM TB_OGBS_MM_OG_IZ A
                                     WHERE A.DTA_DL_YN = 'N'
                                       AND A.BASE_YM = #{perfYm}
                                  ) B
                                 ON X.OG_ID = B.OG_ID
                              WHERE X.DTA_DL_YN = 'N'
                                AND X.OG_TP_CD IN ('W01', 'W02', 'HR1')
                                AND X.BZNS_SPPT_RSB_DV_CD IN ('W0106', 'W0206') /*업무담당*/
                                AND #{perfYm} BETWEEN X.MNGT_STRT_DT AND X.MNGT_END_DT
                                AND X.PRTNR_NO = #{session.userId}
                           )
                    </if>
                    <if test='@MybatisUtils@equals(lgnUsrUserGrp, "100") and (@MybatisUtils@equals(lgnUsrDtrs, "170") or @MybatisUtils@equals(lgnUsrDtrs, "177"))'>
                        /* 업무담당 그룹중에 BM,BM팀장 권한체크 */
                    <choose>
                        <when test="@MybatisUtils@isNotEmpty(perfYm) and perfYm >= 202202">
                         AND Y.PRTNR_NO IN /* 로그인한 BM이 관리하는 조직의 총괄사번 */
                           ( SELECT B.DGR1_LEVL_DG_PRTNR_NO /*총괄사번(1차레벨대표파트너번호)*/
                               FROM TB_OGBS_SPPT_OG_IZ X
                              INNER JOIN
                                  ( SELECT A.OG_ID
                                         , A.DGR1_LEVL_DG_PRTNR_NO
                                      FROM TB_OGBS_MM_OG_IZ A
                                     WHERE A.DTA_DL_YN = 'N'
                                       AND A.BASE_YM = #{perfYm}
                                  ) B
                                 ON X.OG_ID = B.OG_ID
                              WHERE X.DTA_DL_YN = 'N'
                                AND X.OG_TP_CD IN ('W01', 'W02', 'HR1')
                                AND X.BZNS_SPPT_RSB_DV_CD IN ('W0107', 'W0207') /*BM*/
                                AND #{perfYm} BETWEEN X.MNGT_STRT_DT AND X.MNGT_END_DT
                                AND X.PRTNR_NO = #{session.userId}
                           )
                        </when>
                        <otherwise>
                         AND Y.AKDBON IN
                           ( SELECT X.AKDCDE
                               FROM IFLIB.AL1300P X  /*AL1300P TOBE 사용여부 검토중 확인 후 수정 필요*/
                              WHERE X.AKDGUB IN (2,7)
                                AND X.AKDDTY = CAST(SUBSTR(#{perfYm},1,4) AS INT)
                                AND X.AKDDTM = CAST(SUBSTR(#{perfYm},5,2) AS INT)
                              <if test='@MybatisUtils@equals(lgnUsrDtrs, "170")'>
                                AND X.AKYSIL = #{session.userId}
                              </if>
                              <if test='@MybatisUtils@equals(lgnUsrDtrs, "177")'>
                                AND X.AKTSIL = #{session.userId}
                              </if>
                           )
                        </otherwise>
                    </choose>
                    </if>
                    <if test='@MybatisUtils@equals(userTypeCode, "P")'>
                         AND Y.PRTNR_NO = #{session.userId}
                    </if>
                   ) SUB1
               WHERE 1=1
            )
        ORDER BY HGR_OG_CD, OG_CD
    </select>

    <select id='selectSumLeaderAllowances' resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedLedrAllowanceDto$SearchSumRes">
        SELECT SUBSTR(DSB_YM, 0, 4) || '-' || SUBSTR(DSB_YM, 5) AS DSB_YM
             , COUNT(HMNRSC_EMPNO) AS HMNRSC_EMPNO_CNT
             , OG_LEVL_DV_NM
             , SUM(BAS_AW_AMT) AS BAS_AW_AMT	/*기본수당금액*/
             , SUM(HH_EXCP_AW_AMT) AS HH_EXCP_AW_AMT	/*시간외수당금액 */
             , SUM(RSB_AW_AMT) AS RSB_AW_AMT	/*직책수당금액*/
             , SUM(FXN_AW_SUM_AMT) AS FXN_AW_SUM_AMT	/*고정수당합계금액*/
             , SUM(TRG_CT) AS TRG_CT	/*실적목표건수*/
             , SUM(PERF_CT) AS PERF_CT	/*실적건수*/
             , SUM(TRUNC(PERF_ACHV_RAT, 1)) AS PERF_ACHV_RAT	/*실적달성비율*/
             , SUM(TRG_ACHV_AW_AMT) AS TRG_ACHV_AW_AMT	/*목표달성수당금액*/
             , SUM(BRCH_AV_PERF_CT) AS BRCH_AV_PERF_CT	/*지점평균실적건수(2021년02월이전)*/
             , SUM(ENCRG_AW_AMT) AS ENCRG_AW_AMT	/*장려수당금액(2021년02월이후)*/
             , SUM(MNGR_PERF_GD_CD) AS MNGR_PERF_GD_CD	/*관리자실적등급코드(2021년02월이전)*/
             , SUM(OG_AW_AMT) AS OG_AW_AMT	/*조직수당금액(2021년02월이후)*/
             , SUM(EVL_AW_AMT) AS EVL_AW_AMT	/*평가수당금액*/
             , SUM(PERF_AW_SUM_AMT) AS PERF_AW_SUM_AMT	/*실적수당합계금액*/
             , SUM(EXCL_DIV_AW_AMT) AS EXCL_DIV_AW_AMT	/*우수사업부수당금액*/
             , SUM(ICT_AW_AMT) AS ICT_AW_AMT	/*인센티브수당금액*/
             , SUM(LDSTC_ATDC_AW_AMT) AS LDSTC_ATDC_AW_AMT	/*장거리출근수당금액*/
             , SUM(MRNT_SPPT_AW_AMT) AS MRNT_SPPT_AW_AMT	/*월세지원수당금액*/
             , SUM(LECTR_ADN_AW_AMT) AS LECTR_ADN_AW_AMT	/*강의부가수당금액*/
             , SUM(ETC_ADN_AW_AMT) AS ETC_ADN_AW_AMT	/*기타부가수당금액*/
             , SUM(ETC_ADN_AW_SUM_AMT) AS ETC_ADN_AW_SUM_AMT	/*기타부가수당합계금액*/
             , SUM(FXN_PERF_AW_SUM_AMT) AS FXN_PERF_AW_SUM_AMT	/*고정실적수당합계금액(고정급+업적수당)*/
             , SUM(AW_CALC_SUM_AMT) AS AW_CALC_SUM_AMT	/*수당계산합계금액*/
             , SUM(HINSR_DDCTAM) AS HINSR_DDCTAM	/*건강보험공제금액*/
             , SUM(NRSN_INSR_DDCTAM) AS NRSN_INSR_DDCTAM	/*요양보험공제금액*/
             , SUM(NTNL_PNSN_DDCTAM) AS NTNL_PNSN_DDCTAM	/*국민연금공제금액*/
             , SUM(EINSR_DDCTAM) AS EINSR_DDCTAM	/*고용보험공제금액*/
             , SUM(ERNTX) AS ERNTX	/*소득세*/
             , SUM(RSDNTX) AS RSDNTX	/*주민세*/
             , SUM(CRPT_BZNS_DDCTAM) AS CRPT_BZNS_DDCTAM	/*비정도영업조치금*/
             , SUM(EDDTN_AMT) AS EDDTN_AMT	/*기타공제금액*/
             , SUM(DDTN_SUM_AMT) AS DDTN_SUM_AMT	/*공제합계금액*/
             , SUM(ACPY_AMT) AS ACPY_AMT	/*실지급액*/
          FROM TB_FEAM_WELS_MNGR_AW_IZ
         WHERE DTA_DL_YN = 'N'
           AND DSB_YM = #{perfYm}
        <if test='@MybatisUtils@isNotEmpty(no)'>
           AND HMNRSC_EMPNO = #{no}
        </if>
        <if test='@MybatisUtils@isNotEmpty(rsbDvCd) and @MybatisUtils@equals(rsbDvCd, "W0202")'>
           /*총괄단장인 경우*/
           AND OG_CD LIKE '%000000'
        </if>
        <if test='@MybatisUtils@isNotEmpty(rsbDvCd) and @MybatisUtils@equals(rsbDvCd, "W0203")'>
           /*지역단장인 경우*/
           AND OG_CD LIKE '%0000'
           AND HGR_OG_CD != OG_CD
        </if>
           AND OG_CD IN
             ( SELECT SUB1.OG_CD
                 FROM /* 현재 관리중인 사업자 조회(로그인 사용자 기준) */
                    ( SELECT Y.OG_CD
                        FROM TB_OGBS_MM_PRTNR_IZ Y  /*월파트너내역*/
                       WHERE Y.DTA_DL_YN = 'N'
                         AND Y.BASE_YM = #{perfYm}
                         AND Y.OG_TP_CD IN ('W01', 'W02')
                        /*TODO: 아래 쿼리 세션정보로 수정 필요, 지원조직내역 이관 완료 후 쿼리 재작성 필요*/
                    <if test='@MybatisUtils@equals(lgnUsrUserGrp, "100") and @MybatisUtils@equals(lgnUsrDtrs, "110")'>
                         /* 업무담당 그룹중에 업무담당만 권한체크(BM,BM팀장은 스킵) */
                         AND (Y.OG_TP_CD, Y.OG_CD) IN /* 로그인한 업무담당이 관리하는 조직코드 */
                           ( SELECT X.OG_TP_CD
                                  , B.OG_CD
                               FROM TB_OGBS_SPPT_OG_IZ X
                              INNER JOIN
                                  ( SELECT A.OG_ID
                                         , A.OG_CD
                                      FROM TB_OGBS_MM_OG_IZ A
                                     WHERE A.DTA_DL_YN = 'N'
                                       AND A.BASE_YM = #{perfYm}
                                  ) B
                                 ON X.OG_ID = B.OG_ID
                              WHERE X.DTA_DL_YN = 'N'
                                AND X.OG_TP_CD IN ('W01', 'W02', 'HR1')
                                AND X.BZNS_SPPT_RSB_DV_CD IN ('W0106', 'W0206') /*업무담당*/
                                AND #{perfYm} BETWEEN X.MNGT_STRT_DT AND X.MNGT_END_DT
                                AND X.PRTNR_NO = #{session.userId}
                           )
                    </if>
                    <if test='@MybatisUtils@equals(lgnUsrUserGrp, "100") and (@MybatisUtils@equals(lgnUsrDtrs, "170") or @MybatisUtils@equals(lgnUsrDtrs, "177"))'>
                        /* 업무담당 그룹중에 BM,BM팀장 권한체크 */
                    <choose>
                        <when test="@MybatisUtils@isNotEmpty(perfYm) and perfYm >= 202202">
                         AND Y.PRTNR_NO IN /* 로그인한 BM이 관리하는 조직의 총괄사번 */
                           ( SELECT B.DGR1_LEVL_DG_PRTNR_NO /*총괄사번(1차레벨대표파트너번호)*/
                               FROM TB_OGBS_SPPT_OG_IZ X
                              INNER JOIN
                                  ( SELECT A.OG_ID
                                         , A.DGR1_LEVL_DG_PRTNR_NO
                                      FROM TB_OGBS_MM_OG_IZ A
                                     WHERE A.DTA_DL_YN = 'N'
                                       AND A.BASE_YM = #{perfYm}
                                  ) B
                                 ON X.OG_ID = B.OG_ID
                              WHERE X.DTA_DL_YN = 'N'
                                AND X.OG_TP_CD IN ('W01', 'W02', 'HR1')
                                AND X.BZNS_SPPT_RSB_DV_CD IN ('W0107', 'W0207') /*BM*/
                                AND #{perfYm} BETWEEN X.MNGT_STRT_DT AND X.MNGT_END_DT
                                AND X.PRTNR_NO = #{session.userId}
                           )
                        </when>
                        <otherwise>
                         AND Y.AKDBON IN
                           ( SELECT X.AKDCDE
                               FROM IFLIB.AL1300P X  /*AL1300P TOBE 사용여부 검토중 확인 후 수정 필요*/
                              WHERE X.AKDGUB IN (2,7)
                                AND X.AKDDTY = CAST(SUBSTR(#{perfYm},1,4) AS INT)
                                AND X.AKDDTM = CAST(SUBSTR(#{perfYm},5,2) AS INT)
                              <if test='@MybatisUtils@equals(lgnUsrDtrs, "170")'>
                                AND X.AKYSIL = #{session.userId}
                              </if>
                              <if test='@MybatisUtils@equals(lgnUsrDtrs, "177")'>
                                AND X.AKTSIL = #{session.userId}
                              </if>
                           )
                        </otherwise>
                    </choose>
                    </if>
                    <if test='@MybatisUtils@equals(userTypeCode, "P")'>
                         AND Y.PRTNR_NO = #{session.userId}
                    </if>
                   ) SUB1
               WHERE 1=1
            )
        GROUP BY DSB_YM, OG_LEVL_DV_NM
        ORDER BY DSB_YM, OG_LEVL_DV_NM
    </select>
</mapper>
