<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.control.mapper.WfedManagerVisitFeeMapper">


    <select id='selectManagerVisitFees' resultType="com.kyowon.sms.wells.web.fee.control.dto.WfedManagerVisitFeeDto$SearchRes">
        /*
         * TODO
         * 상품 추가(KA1100P KAETC2='E')
         * 계약상세 추가(정기배송, 일시불, 렌탈, 멤버십 확인필요)
         * 주석처리 해둔 곳 TO-BE로 변경해야함
         * */
        SELECT OG.DGR1_LEVL_OG_ID	/*총괄단*/
             , OG.DGR2_LEVL_OG_ID	/*지역단*/
             , OG.DGR3_LEVL_OG_ID	/*지점*/
             , OG.PRTNR_NO
             , OG.PRTNR_KNM
             , T1.CNTR_NO	/*계약번호*/
             , T1.BASE_PD_CD	/*상품코드*/
             , (SELECT A.PD_NM FROM TB_PDBS_PD_BAS A WHERE A.DTA_DL_YN = 'N' AND A.PD_CD = T1.BASE_PD_CD) AS PD_NM	/*상품명*/
             , BAS.SV_FEE_PD_DV_CD	/*BS상품군*/
             , F_CMZ_CD_NM('TNT_WELLS', 'SV_FEE_PD_DV_CD', BAS.SV_FEE_PD_DV_CD) AS SV_FEE_PD_DV_NM	/*BS상품군*/
             , NVL(BAS.SV_FEE_BASE_AMT, 0) AS SV_FEE_BASE_AMT	/*BS기본수수료*/
             , NVL(T1.FEE_CALC_AMT, 0) AS FEE_CALC_AMT	/*방문수수료*/
             , T1.VST_RGLVL_GD_CD	/*방문급지*/
             , CASE T1.VST_RGLVL_GD_CD WHEN '01' THEN 'N'
                   WHEN '02' THEN 'G'
                   WHEN '03' THEN 'W1'
                   WHEN '04' THEN 'W2'
                   WHEN '05' THEN 'W3'
                   WHEN '06' THEN 'S1'
                   WHEN '07' THEN 'S2'
                   ELSE '*'
               END  AS VST_RGLVL_GD_NM /*방문급지*/
            /* , F_CMZ_CD_NM('TNT_WELLS', 'VST_RGLVL_GD_CD', T1.VST_RGLVL_GD_CD) AS VST_RGLVL_GD_NM	방문급지*/
             , T1.WK_EXCN_DT	/*방문일자*/
             , CASE WHEN T1.VST_TP_DV_CD = '2' THEN	/*방문취소*/
                 CASE WHEN T1.WK_CAN_RSON_CD = '01' THEN '취소'
                      WHEN T1.WK_CAN_RSON_CD = '02' THEN ' 매출중지'
                      WHEN T1.WK_CAN_RSON_CD = '03' THEN ' 배정취소'
                 ELSE '' END
               ELSE '' END AS CAN_YN	/*취소여부*/
         FROM TB_FEAM_WELS_SV_PERF_IZ T1	/*웰스서비스실적내역*/
         /*TODO 정기배송 추가*/
         LEFT OUTER JOIN
            ( SELECT * /*일시불, 렌탈*/
                FROM TB_SSCT_CNTR_DTL	/*계약상세*/
               WHERE DTA_DL_YN = 'N'
                 AND SELL_TP_CD IN ('1', '2')	/*판매유형코드*/
            ) T3
           ON T1.CNTR_NO = T3.CNTR_NO
          AND T1.CNTR_SN = T3.CNTR_SN
         LEFT OUTER JOIN
            ( SELECT * /*멤버십*/
                FROM TB_SSCT_CNTR_DTL	/*계약상세*/
               WHERE DTA_DL_YN = 'N'
                 AND SELL_TP_CD = '3'	/*판매유형코드*/
            ) T2
           ON T1.CNTR_NO = T2.CNTR_NO
          AND T1.CNTR_SN = T2.CNTR_SN
        INNER JOIN
            ( SELECT A.BASE_YM
                   , A.OG_TP_CD
                   , A.DGR1_LEVL_OG_ID
                   , A.DGR2_LEVL_OG_ID
                   , A.DGR3_LEVL_OG_ID
                   , B.PRTNR_NO
                   , B.PRTNR_KNM
                FROM TB_OGBS_MM_OG_IZ A /* 월조직내역 */
               INNER JOIN TB_OGBS_MM_PRTNR_IZ B /* 월파트너내역 */
                  ON A.BASE_YM = B.BASE_YM
                 AND A.OG_TP_CD = B.OG_TP_CD
                 AND A.OG_ID = B.OG_ID
                 AND B.DTA_DL_YN = 'N'
               WHERE A.DTA_DL_YN = 'N'
                 AND A.BASE_YM = #{baseYm}
                 AND A.OG_TP_CD IN ('W02', 'W03')	/*M조직, 홈마스터*/
                <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd1)'>
                 AND A.DGR1_LEVL_OG_ID = #{ogLevlDvCd1}
                </if>
                <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd2)'>
                 AND A.DGR2_LEVL_OG_ID = #{ogLevlDvCd2}
                </if>
                <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd3)'>
                 AND A.DGR3_LEVL_OG_ID = #{ogLevlDvCd3}
                </if>
            ) OG
           ON T1.BASE_YM = OG.BASE_YM
          AND T1.OG_TP_CD = OG.OG_TP_CD
          AND T1.PRTNR_NO = OG.PRTNR_NO
         LEFT OUTER JOIN LATERAL
            ( SELECT SV_FEE_BASE_AMT	/*BS기본수수료*/
                   , SV_FEE_PD_DV_CD	/*BS상품그룹*/
                FROM TB_FEAM_WELS_SV_FEE_BAS C
               WHERE BASE_PD_CD = T1.BASE_PD_CD
                 AND VST_MCN = 0
                 AND SV_FEE_DV_CD = CASE WHEN OG.OG_TP_CD = 'W03' THEN '2' ELSE '1' END
                /* AND LCPRT1 = CASE WHEN OG.KAETC1!='8' THEN LCPRT1 ELSE COALESCE(T5.LCPRT1,T7.LCPRT1,'') END
                 AND LCPRT2 = CASE WHEN OG.KAETC1!='8' THEN LCPRT2 ELSE COALESCE(T5.LCPRT2,T7.LCPRT2,'') END */
                 AND #{baseYm}  BETWEEN APY_STRT_YM AND APY_END_YM
               ORDER BY BASE_PD_CD , VST_MCN , SV_FEE_DV_CD , HCR_DV_CD, BASE_CH_TCNT
            ) BAS ON 1=1
        WHERE T1.DTA_DL_YN = 'N'
          AND T1.BASE_YM = #{baseYm}
          AND T1.CL_DV_CD = '02'
          AND T1.OG_TP_CD IN ('W02', 'W03')	/*M조직, 홈마스터*/
          AND (T1.WK_EXCN_DT IS NOT NULL AND T1.WK_EXCN_DT != '0')	/*작업수행일자*/
        <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
          AND OG.PRTNR_NO = #{prtnrNo}
        </if>
    </select>
</mapper>
