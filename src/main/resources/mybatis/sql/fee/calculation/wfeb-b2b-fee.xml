<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.calculation.mapper.WfebB2bFeeMgtMapper">

    <select id='selectB2bPerformance' resultType="com.kyowon.sms.wells.web.fee.calculation.dto.WfebB2bFeeMgtDto$Performance">
        SELECT T1.BASE_YM
             , O1.HOO_PRTNR_NM AS CO_CD_NM                            /* 지구명 */
             , O1.DGR3_LEVL_OG_NM AS BRCH_NM                          /* 지점명 */
             , T2.PRTNR_KNM                                           /* 핀매자            */
             , T1.PRTNR_NO                                            /* 번호              */
             , T1.CNTR_NO                                             /* 계약상세번호      */
             , T4.CST_KNM                                             /* 고객성명          */
             , T5.BASE_PD_CD                                          /* 상품코드          */
             , T6.PD_NM                                               /* 상품명            */
             , T1.SELL_TP_CD
             , T1.SELL_DSC_DV_CD  /* 할인구분 - T1.DSC_DV_CD   SELL_DSC_DV_CD  */
             , T1.SELL_DSCR_CD      /* 할인유형 (2023.10.06) */
             , T1.SELL_DSC_TP_CD   /* 할인제도 - T1.PMOT_CD     SELL_DSC_TP_CD        */
             , NVL(T7.SPP_DV_CD, '2') SPP_DV_CD        /* 결합구분 - 1결합, 2미결합 (2023.10.06) */
             , P1.SV_PD_TP_CD     /* 용도구분 - SV_TP_CD (2023.10.06) */
             , CASE WHEN T1.PMOT_USWY_DV_CD = '1' THEN '1-일반'
                    WHEN T1.PMOT_USWY_DV_CD = '2' THEN '2-업소'
                    ELSE ''
                    END MG_NM                                         /* 관리유형 -     */
             , T1.BFSVC_PRD_CD       /* 방문주기 - T1.BFSVC_PRD_CD */
             , T1.RCPDT                                               /* 접수일자          */
             , T1.SL_DT                                               /* 매출일자          */
             , T1.CAN_DT                                              /* 취소일자          */
             , (SELECT SUM(X.PERF_VAL)
           	    FROM TB_FEAM_NTORP_CNTR_MM_CL X
           	   WHERE X.BASE_YM        = T1.BASE_YM
		         AND X.PERF_YM        = T1.PERF_YM
		         AND X.FEE_TCNT_DV_CD = T1.FEE_TCNT_DV_CD
		         AND X.CNTR_NO        = T1.CNTR_NO
		         AND X.CNTR_SN        = T1.CNTR_SN
		         AND X.CNTR_PERF_CRT_DV_CD = T1.CNTR_PERF_CRT_DV_CD
		         AND X.PERF_AGRG_CRT_DV_CD = '401'               /* 실적집계생성구분코드 501-총판수수료실적생성   */
			     AND X.PERF_ATC_CD         = 'W04P00001'         /* 실적항목코드       W05P00001-기본수수료금액 */
			     AND X.PERF_DV_CD          = '0'                 /* 실적구분코드       0-개인판매               */
			     AND X.DTA_DL_YN           = 'N'
	         ) AS PERF_VAL
            , CASE WHEN T1.SELL_DSC_DV_CD = '9' AND T1.SELL_DSCR_CD  = '99' THEN 0
                   WHEN T1.SELL_DSC_DV_CD = '5' AND T1.SELL_DSCR_CD IN ('11','12','13','14') AND T1.ACKMT_PERF_AMT > 0 THEN 0
                   WHEN T1.SELL_DSC_DV_CD = '1' AND T5.CNTRW_TP_CD  != '8' AND NVL(T5.FEE_FXAM_YN, 'N') != 'Y' AND T1.ACKMT_PERF_AMT > 0 THEN NVL(T1.ACKMT_PERF_CT, 1)
                   ELSE 0 END ACKMT_PERF_CT /* 신규건수 - AS-IS 로직을 TO-BE 기준으로 변환 */
          FROM TB_FEAM_WELS_NRCTR_MM_CL T1      /* 순주문파트너계약월마감 */
         INNER JOIN TB_OGBS_MM_PRTNR_IZ      T2      /* 월파트너               */
            ON T2.BASE_YM        = T1.BASE_YM
           AND T2.OG_TP_CD       = T1.OG_TP_CD         /* 2023.05.02 조건 추가 */
           AND T2.PRTNR_NO       = T1.PRTNR_NO
         INNER JOIN TB_OGBS_MM_OG_IZ O1 /* 2023.08.22 조인 추가 */
            ON T2.BASE_YM = O1.BASE_YM
           AND T2.OG_ID = O1.OG_ID
           AND T2.OG_TP_CD = O1.OG_TP_CD
         INNER JOIN TB_SSCT_CNTR_BAS         T3      /* 계약기본               */
            ON T3.CNTR_NO        = T1.CNTR_NO
         INNER JOIN TB_CUBS_CST_BAS          T4      /* 고객기본               */
            ON T4.CST_NO         = T3.CNTR_CST_NO
         INNER JOIN TB_SSCT_CNTR_DTL         T5      /* 계약상세               */
            ON T5.CNTR_NO        = T1.CNTR_NO
           AND T5.CNTR_SN        = T1.CNTR_SN
         INNER JOIN TB_PDBS_PD_BAS           T6      /* 상품기본               */
            ON T6.PD_CD          = T5.BASE_PD_CD
        /* 2023.10.06 추가 ************************/
          LEFT OUTER JOIN TB_SVPD_CST_SV_EXCN_IZ    S1 /* 고객서비스수행내역    */
            ON S1.CNTR_NO = T1.CNTR_NO
           AND S1.CNTR_SN = T1.CNTR_SN
          LEFT OUTER JOIN TB_PDBS_PD_BAS            P1 /* 상품기본 - 서비스상품 */
            ON P1.PD_CD   = S1.SV_PD_CD
          LEFT OUTER JOIN  ( SELECT OJ_DTL_CNTR_NO CNTR_NO
                                  , OJ_DTL_CNTR_SN CNTR_SN
                                  , CASE WHEN COUNT(1) > 0 THEN '1' ELSE '2' END  SPP_DV_CD /* 결합구분 - 1결합, 2미결합 */
                               FROM TB_SSCT_CNTR_REL /* 계약관계 */
                              WHERE VL_STRT_DTM     <![CDATA[<=]]> SUBSTR(#{perfYm},0,6) || '01'  --유효시작일시
                                AND VL_END_DTM      >= SUBSTR(#{perfYm},0,6) || '01'  --유효종료일시
                                AND CNTR_REL_DTL_CD IN ('214')         --계약관계상세코드 정기배송(214)
                                AND DTA_DL_YN       = 'N'
                              GROUP BY OJ_DTL_CNTR_NO, OJ_DTL_CNTR_SN ) T7 /* 계약관계             */
            ON T7.CNTR_NO = T1.CNTR_NO
           AND T7.CNTR_SN = T1.CNTR_SN
         WHERE 1=1
           AND T1.BASE_YM             = #{perfYm}
           AND T2.OG_TP_CD            = 'W04'               /* 조직유형코드          W04-온라인B2B           */
           AND T1.CNTR_PERF_CRT_DV_CD = '01'                /* 계약실적생성구분코드 01-순주문집계            */
           AND T1.DTA_DL_YN           = 'N'
           <if test='@MybatisUtils@isNotEmpty(feeTcntDvCd)'>
           AND T1.FEE_TCNT_DV_CD      = #{feeTcntDvCd}
           </if>
           <if test='@MybatisUtils@isNotEmpty(strtYm) and @MybatisUtils@isNotEmpty(endYm)'>
           AND SUBSTR(T1.RCPDT,0,6) BETWEEN SUBSTR(#{strtYm},0,6) AND SUBSTR(#{endYm},0,6)
           </if>
           <if test='@MybatisUtils@isNotEmpty(cancelStrtYm) and @MybatisUtils@isNotEmpty(cancelEndYm)'>
           AND SUBSTR(T1.CAN_DT,0,6) BETWEEN SUBSTR(#{cancelStrtYm},0,6) AND SUBSTR(#{cancelEndYm},0,6)
           </if>
    </select>

    <select id='selectB2bFee' resultType="com.kyowon.sms.wells.web.fee.calculation.dto.WfebB2bFeeMgtDto$Fee">
        SELECT T1.BASE_YM
             , T1.FEE_TCNT_DV_CD
	         , T1.CO_CD                             /* 업체코드          */
             , O1.HOO_PRTNR_NM AS CO_CD_NM   /* 업체명   - T1.CO_CD */
             , T3.OG_CD
             , T1.PRTNR_NO                          /* 번호              */
             , T3.PRTNR_KNM                         /* 판매자            */
             /* 20230823 수정 */
             , MAX(NVL(T9.CNT, 0)) CNT              /* 실적(계약건수)    */
             , SUM(CASE WHEN T1.FEE_CD = 'W040001' THEN T1.FEE_CTR_CNFM_AMT ELSE 0 END) AS AMT_W040001  /* 수수료-기본수수료 */
             , SUM(CASE WHEN T1.FEE_CD = 'W040005' THEN T1.FEE_CTR_CNFM_AMT ELSE 0 END) AS AMT_W040005  /* 수수료-알선수수료 */
             , SUM(CASE WHEN T1.FEE_CD = 'W040004' THEN T1.FEE_CTR_CNFM_AMT ELSE 0 END) AS AMT_W040004  /* 수수료-프로모션   */
             , SUM(CASE WHEN T1.FEE_CD = 'W040020' THEN T1.FEE_CTR_CNFM_AMT ELSE 0 END) AS AMT_W040020  /* 수수료-재지급     */
             , SUM(CASE WHEN T1.FEE_CD = 'W040003' THEN T1.FEE_CTR_CNFM_AMT ELSE 0 END) AS AMT_W040003  /* 수수료-인센티브   */
        	 /* 20230823 수정 */
             -- , SUM(CASE WHEN T2.FEE_DDTN_TP_CD = '01' THEN T2.FEE_DDTN_CNFM_AMT ELSE 0 END)  AS AMT_01  /* 공제-보증예치금   */
             -- , MAX(CASE WHEN T2.FEE_DDTN_TP_CD = '01' THEN T2.FEE_CTR_RSON_CN ELSE '' END)  AS AMT_01_CN /* 공제-보증예치금 조정사유내용 */
             -- , SUM(CASE WHEN T2.FEE_DDTN_TP_CD = '08' THEN T2.FEE_DDTN_CNFM_AMT ELSE 0 END)  AS AMT_08  /* 공제-환수되물림   */
             , MAX(NVL(T2.SUM_01, 0)) AMT_01 /* 공제-보증예치금 */
             , MAX(NVL(T2.RSON_01, ''))  AMT_01_CN /* 공제-보증예치금 조정사유내용 */
             , MAX(NVL(T2.SUM_08, 0)) AMT_08 /* 공제-환수되물림 */
          FROM TB_FEAM_FEE_CALC_BAS T1         /* 수수료계산기본    */
          /* 20230823 수정 */
          LEFT OUTER JOIN ( SELECT DDTN_YM
                                , CO_CD
                                , OG_TP_CD
                                , PRTNR_NO
                                , FEE_TCNT_DV_CD
                                , SUM(CASE WHEN FEE_DDTN_TP_CD = '01' THEN FEE_DDTN_CNFM_AMT ELSE 0 END) SUM_01
                                , MAX(CASE WHEN FEE_DDTN_TP_CD = '01' THEN FEE_CTR_RSON_CN ELSE '' END) RSON_01
                                , SUM(CASE WHEN FEE_DDTN_TP_CD = '08' THEN FEE_DDTN_CNFM_AMT ELSE 0 END) SUM_08
                             FROM TB_FEAM_FEE_DDTN_IZ /* 수수료공제내역 */
                            WHERE DDTN_YM        = #{perfYm}
                              <if test='@MybatisUtils@isNotEmpty(feeTcntDvCd)'>
                              AND FEE_TCNT_DV_CD = #{feeTcntDvCd}
                              </if>
                              AND OG_TP_CD       = 'W04'
                              AND DTA_DL_YN      = 'N'
                              AND SPMT_DSB_DV_CD = '01'
                              AND FEE_DDTN_CRT_CD = 'W0404'
                            GROUP BY DDTN_YM, CO_CD, OG_TP_CD, PRTNR_NO, FEE_TCNT_DV_CD ) T2
            ON T2.DDTN_YM         = T1.BASE_YM
           AND T2.CO_CD           = T1.CO_CD
           AND T2.OG_TP_CD        = T1.OG_TP_CD
           AND T2.PRTNR_NO        = T1.PRTNR_NO
           AND T2.FEE_TCNT_DV_CD  = T1.FEE_TCNT_DV_CD
         INNER JOIN TB_OGBS_MM_PRTNR_IZ  T3         /* 월파트너          */
            ON T3.BASE_YM    = T1.BASE_YM
           AND T3.OG_TP_CD   = T1.OG_TP_CD
           AND T3.PRTNR_NO   = T1.PRTNR_NO
         INNER JOIN TB_OGBS_MM_OG_IZ O1 /* 2023.08.22 조인 추가 */
            ON T3.BASE_YM = O1.BASE_YM
           AND T3.OG_ID = O1.OG_ID
           AND T3.OG_TP_CD = O1.OG_TP_CD
          LEFT OUTER JOIN T_CMZ_CD_D    C0         /* 공통코드 - 업체명 */
            ON C0.TENANT_ID  = #{session.tenantId}
           AND C0.CD_ID      = 'CO_CD'    /* 업체명 */
           AND C0.CD_VLD_VAL = T1.CO_CD
         /* 20231120 수정 */
          LEFT OUTER JOIN ( SELECT X.BASE_YM
                                  , X.CO_CD
                                  , X.OG_TP_CD
                                  , X.PRTNR_NO
                                  , COUNT(X.PERF_VAL)  AS CNT
                               FROM TB_FEAM_NTORP_CNTR_MM_CL X
                              WHERE 1 = 1
                                AND X.BASE_YM = X.PERF_YM
                                AND X.BASE_YM = #{perfYm}
                                <if test='@MybatisUtils@isNotEmpty(feeTcntDvCd)'>
                                AND X.FEE_TCNT_DV_CD = #{feeTcntDvCd}
                               </if>
                                AND X.OG_TP_CD  = 'W04'
                                AND X.PERF_ATC_CD = 'W04P00001'
                                AND X.PERF_VAL > 0
                              GROUP BY X.BASE_YM, X.CO_CD, X.OG_TP_CD, X.PRTNR_NO ) T9
            ON T9.BASE_YM        = T1.BASE_YM
           AND T9.CO_CD          = T1.CO_CD
           AND T9.OG_TP_CD       = T1.OG_TP_CD
           AND T9.PRTNR_NO       = T1.PRTNR_NO
         WHERE T1.BASE_YM        = #{perfYm}
           <if test='@MybatisUtils@isNotEmpty(feeTcntDvCd)'>
           AND T1.FEE_TCNT_DV_CD      = #{feeTcntDvCd}
           </if>
           AND T1.OG_TP_CD       = 'W04'
           AND T1.DTA_DL_YN      = 'N'
           AND T1.FEE_CALC_TP_CD = '01' /* 수수료계산 (2023.04.26 추가) */
         GROUP BY T1.BASE_YM, T1.FEE_TCNT_DV_CD, T1.CO_CD, O1.HOO_PRTNR_NM, T3.OG_CD, T1.PRTNR_NO, T3.PRTNR_KNM
    </select>


    <update id="updateCalcFee">
        MERGE INTO TB_FEAM_FEE_CALC_BAS T1  /* 수수료계산기본 */
        USING ( SELECT #{baseYm}          AS BASE_YM           /* 기준년월 */
                     , #{perfYm}         AS PERF_YM           /* 실적년월 */
                     , #{ojDsbYm}        AS OJ_DSB_YM         /* 대상지급년월 */
                     , #{coCd}           AS CO_CD             /* 회사코드 */
                     , #{ogTpCd}         AS OG_TP_CD          /* 조직유형코드 */
                     , #{prtnrNo}        AS PRTNR_NO          /* 파트너번호 */
                     , #{feeCd}          AS FEE_CD            /* 수수료코드 */
                     , #{dtaCrtFeeCd}    AS DTA_CRT_FEE_CD    /* 데이터생성수수료코드 */
                     , #{feeTcntDvCd}    AS FEE_TCNT_DV_CD    /* 수수료차수구분코드 */
                     , #{spmtDsbDvCd}    AS SPMT_DSB_DV_CD    /* 추가지급구분코드 */
                     , #{feeCalcTpCd}    AS FEE_CALC_TP_CD    /* 수수료계산유형코드 */
                     , #{feeCalcAmt}     AS FEE_CALC_AMT      /* 수수료계산금액 */
                     , #{feeCtrCnfmAmt}  AS FEE_CTR_CNFM_AMT  /* 수수료조정확정금액 */
                     , #{feeCtrRsonCn}   AS FEE_CTR_RSON_CN   /* 수수료조정사유내용 */
                     , #{feeCtrOgTpCd}   AS FEE_CTR_OG_TP_CD  /* 수수료조정조직유형코드 */
                     , #{feeCtrPrtnrNo}  AS FEE_CTR_PRTNR_NO  /* 수수료조정파트너번호 */
                     , #{feeCalcVarbVal1} AS FEE_CALC_VARB_VAL1 /* 수수료계산변수값1 */
                     , #{feeCalcVarbVal2} AS FEE_CALC_VARB_VAL2 /* 수수료계산변수값2 */
                     , NVL((SELECT FNL_FEE_YN
                          FROM TB_FEAM_FEE_BASE_DTL /* 수수료기준상세 */
                         WHERE FEE_CD           = #{feeCd}
                           AND #{baseYm} BETWEEN APY_STRT_YM AND APY_END_YM
                           AND FEE_BASE_STAT_CD = '02'
                           AND DTA_DL_YN        = 'N' ),'N')  AS FNL_FEE_YN
                     , #{dtaDlYn}        AS DTA_DL_YN         /* 데이터삭제여부 */
                  FROM DUAL ) T2
           ON (   T1.BASE_YM = T2.BASE_YM           /* 기준년월 */
              AND T1.PERF_YM = T2.PERF_YM           /* 실적년월 */
              AND T1.OJ_DSB_YM = T2.OJ_DSB_YM         /* 대상지급년월 */
              AND T1.CO_CD = T2.CO_CD             /* 회사코드 */
              AND T1.OG_TP_CD = T2.OG_TP_CD          /* 조직유형코드 */
              AND T1.PRTNR_NO = T2.PRTNR_NO          /* 파트너번호 */
              AND T1.FEE_CD = T2.FEE_CD            /* 수수료코드 */
              AND T1.DTA_CRT_FEE_CD = T2.DTA_CRT_FEE_CD    /* 데이터생성수수료코드 */
              AND T1.FEE_TCNT_DV_CD = T2.FEE_TCNT_DV_CD    /* 수수료차수구분코드 */
              AND T1.SPMT_DSB_DV_CD = T2.SPMT_DSB_DV_CD    /* 추가지급구분코드 */
              AND T1.FEE_CALC_TP_CD = T2.FEE_CALC_TP_CD    /* 수수료계산유형코드 */
           )
         WHEN MATCHED THEN
       UPDATE
          SET FEE_CALC_AMT = T2.FEE_CALC_AMT
            , FEE_CTR_CNFM_AMT = T2.FEE_CTR_CNFM_AMT
              <include refid="COMMON.updateSystemField"/>
        WHEN NOT MATCHED THEN
      INSERT (
             BASE_YM
           , PERF_YM
           , OJ_DSB_YM
           , CO_CD
           , OG_TP_CD
           , PRTNR_NO
           , FEE_CD
           , DTA_CRT_FEE_CD
           , FEE_TCNT_DV_CD
           , SPMT_DSB_DV_CD
           , FEE_CALC_TP_CD
           , FEE_CALC_AMT
           , FEE_CTR_CNFM_AMT
           , FEE_CTR_RSON_CN
           , FEE_CTR_OG_TP_CD
           , FEE_CTR_PRTNR_NO
           , FEE_CALC_VARB_VAL1
           , FEE_CALC_VARB_VAL2
           , FNL_FEE_YN
           , DTA_DL_YN
           <include refid="COMMON.insertSystemField" />
      ) VALUES (
             T2.BASE_YM
           , T2.PERF_YM
           , T2.OJ_DSB_YM
           , T2.CO_CD
           , T2.OG_TP_CD
           , T2.PRTNR_NO
           , T2.FEE_CD
           , T2.DTA_CRT_FEE_CD
           , T2.FEE_TCNT_DV_CD
           , T2.SPMT_DSB_DV_CD
           , T2.FEE_CALC_TP_CD
           , T2.FEE_CALC_AMT
           , T2.FEE_CTR_CNFM_AMT
           , T2.FEE_CTR_RSON_CN
           , T2.FEE_CTR_OG_TP_CD
           , T2.FEE_CTR_PRTNR_NO
           , T2.FEE_CALC_VARB_VAL1
           , T2.FEE_CALC_VARB_VAL2
           , T2.FNL_FEE_YN
           , T2.DTA_DL_YN
            <include refid="COMMON.insertSystemFieldValue" />
      )
    </update>

    <update id="updateCalcDtlFee">
        MERGE INTO TB_FEAM_FEE_DDTN_IZ  T1  /* 수수료공제내역  */
        USING ( SELECT  #{ddtnYm} AS DDTN_YM           /* 공제년월 */
                      , #{coCd} AS CO_CD             /* 회사코드 */
                      , #{ogTpCd} AS OG_TP_CD          /* 조직유형코드 */
                      , #{prtnrNo} AS PRTNR_NO          /* 파트너번호 */
                      , #{feeDdtnTpCd} AS FEE_DDTN_TP_CD    /* 수수료공제유형코드 */
                      , #{feeTcntDvCd} AS FEE_TCNT_DV_CD    /* 수수료차수구분코드 */
                      , #{spmtDsbDvCd} AS SPMT_DSB_DV_CD    /* 추가지급구분코드 */
                      , #{feeDdtnCrtCd} AS FEE_DDTN_CRT_CD   /* 수수료공제생성코드 */
                      , #{feeDdctam} AS FEE_DDCTAM        /* 수수료공제금액 */
                      , #{feeCtrRsonCn} AS FEE_CTR_RSON_CN   /* 수수료조정사유내용 */
                      , #{feeDdtnCnfmAmt} AS FEE_DDTN_CNFM_AMT /* 수수료공제확정금액 */
                      , #{feeCtrOgTpCd} AS FEE_CTR_OG_TP_CD  /* 수수료조정조직유형코드 */
                      , #{feeCtrPrtnrNo} AS FEE_CTR_PRTNR_NO  /* 수수료조정파트너번호 */
                      , #{dtaDlYn} AS DTA_DL_YN         /* 데이터삭제여부 */
                  FROM DUAL ) T2
           ON ( T1.DDTN_YM = T2.DDTN_YM           /* 공제년월 */
            AND T1.CO_CD = T2.CO_CD             /* 회사코드 */
            AND T1.OG_TP_CD = T2.OG_TP_CD          /* 조직유형코드 */
            AND T1.PRTNR_NO = T2.PRTNR_NO          /* 파트너번호 */
            AND T1.FEE_DDTN_TP_CD = T2.FEE_DDTN_TP_CD    /* 수수료공제유형코드 */
            AND T1.FEE_TCNT_DV_CD = T2.FEE_TCNT_DV_CD    /* 수수료차수구분코드 */
            AND T1.SPMT_DSB_DV_CD = T2.SPMT_DSB_DV_CD    /* 추가지급구분코드 */
            AND T1.FEE_DDTN_CRT_CD = T2.FEE_DDTN_CRT_CD   /* 수수료공제생성코드 */
           )
         WHEN MATCHED THEN
       UPDATE
          SET FEE_DDTN_CNFM_AMT = T2.FEE_DDTN_CNFM_AMT
            , FEE_CTR_RSON_CN = T2.FEE_CTR_RSON_CN
              <include refid="COMMON.updateSystemField"/>
        WHEN NOT MATCHED THEN
      INSERT (
             DDTN_YM
           , CO_CD
           , OG_TP_CD
           , PRTNR_NO
           , FEE_DDTN_TP_CD
           , FEE_TCNT_DV_CD
           , SPMT_DSB_DV_CD
           , FEE_DDTN_CRT_CD
           , FEE_DDCTAM
           , FEE_CTR_RSON_CN
           , FEE_DDTN_CNFM_AMT
           , FEE_CTR_OG_TP_CD
           , FEE_CTR_PRTNR_NO
           , DTA_DL_YN
           <include refid="COMMON.insertSystemField" />
      ) VALUES (
             T2.DDTN_YM
           , T2.CO_CD
           , T2.OG_TP_CD
           , T2.PRTNR_NO
           , T2.FEE_DDTN_TP_CD
           , T2.FEE_TCNT_DV_CD
           , T2.SPMT_DSB_DV_CD
           , T2.FEE_DDTN_CRT_CD
           , T2.FEE_DDCTAM
           , T2.FEE_CTR_RSON_CN
           , T2.FEE_DDTN_CNFM_AMT
           , T2.FEE_CTR_OG_TP_CD
           , T2.FEE_CTR_PRTNR_NO
           , T2.DTA_DL_YN
            <include refid="COMMON.insertSystemFieldValue" />
      )
    </update>

    <select id="selectCheckB2bConfrim" resultType="int">
        SELECT COUNT(1) AS CT
          FROM TB_FEAM_NRCTR_MM_CL T1  /* 순주문파트너월마감 */
         WHERE T1.BASE_YM             = #{perfYm}
           AND T1.FEE_TCNT_DV_CD      = NVL(#{feeTcntDvCd}, '02')
           AND T1.CNTR_PERF_CRT_DV_CD = '01'
           AND T1.NTOR_CNFM_STAT_CD   = '02'
    </select>

    <delete id="deleteWelsNetOrders">
        DELETE FROM TB_FEAM_WELS_NRCTR_MM_CL
         WHERE 1=1
           AND BASE_YM = #{perfYm}
           AND FEE_TCNT_DV_CD = NVL(#{feeTcntDvCd}, '02') /* 차수 */
           AND CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
           AND OG_TP_CD = 'W04'
           AND NVL(ACC_NINC_YN, 'N') = 'N'
    </delete>

    <delete id="deleteAggregateNtorMmCl">
        DELETE FROM TB_FEAM_NTOR_MM_CL T1
         WHERE T1.BASE_YM             = #{perfYm}
           AND T1.FEE_TCNT_DV_CD      = NVL(#{feeTcntDvCd}, '02')
           AND T1.PERF_AGRG_CRT_DV_CD = '401'
    </delete>

    <delete id="deleteAggregateNtorCntrMmCl">
        DELETE FROM TB_FEAM_NTORP_CNTR_MM_CL T1
         WHERE T1.BASE_YM             = #{perfYm}
           AND T1.FEE_TCNT_DV_CD      = NVL(#{feeTcntDvCd}, '02')
           AND T1.PERF_AGRG_CRT_DV_CD = '401'
           AND T1.OG_TP_CD         = 'W04'
    </delete>

    <delete id="deleteAggregateNtorPerfMmCl">
        DELETE FROM TB_FEAM_NTORP_PERF_MM_CL T1
         WHERE T1.BASE_YM             = #{perfYm}
           AND T1.FEE_TCNT_DV_CD      = NVL(#{feeTcntDvCd}, '02')
           AND T1.PERF_AGRG_CRT_DV_CD = '401'
           AND T1.OG_TP_CD            = 'W04'
    </delete>

    <insert id="insertEtcNetOrders">
        INSERT INTO TB_FEAM_WELS_NRCTR_MM_CL
               ( BASE_YM
               , PERF_YM
               , FEE_TCNT_DV_CD
               , CNTR_NO
               , CNTR_SN
               , CNTR_PERF_CRT_DV_CD
               , CO_CD
               , OG_TP_CD
               , PRTNR_NO
               , PD_CD
               , REF_PD_CLSF_VAL
               , PERF_TP_CD
               , SELL_TP_CD
               , SELL_DSC_DV_CD
               , SELL_DSCR_CD
               , RECAP_DUTY_PTRM_N
               , PMOT_USWY_DV_CD
               , BFSVC_PRD_CD
               , MCHN_CH_YN
               , SELL_DSC_TP_CD
               , MCHN_CH_TP_CD
               , RSTL_YN
               , FEE_ACKMT_DV_CD
               , HDQ_OG_ID
               , VTSEL_SODBT_CHNL_DV_CD
               , SELL_AMT
               , SL_AMT
               , REDF_ADSB_OJ_AMT
               , VAT
               , ACKMT_PERF_RT
               , ACKMT_PERF_AMT
               , ACKMT_PERF_CT
               , CVT_PERF_AMT
               , BOO_SELL_YN
               , RCPDT
               , SL_DT
               , CAN_DT
               , STPL_PTRM_MCN
               , FEE_CPSN_REDF_ID
               , OJ_PRCSDT
               , SRC_CO_CD
               , DTA_DL_YN
               <include refid="COMMON.insertSystemField" />
               )
        SELECT #{perfYm} AS BASE_YM
             , #{perfYm} AS PERF_YM
             , #{feeTcntDvCd} AS FEE_TCNT_DV_CD
             , A.CNTR_NO
             , A.CNTR_SN
             , '01' AS CNTR_PERF_CRT_DV_CD
             , '2000' AS CO_CD
             , B.OG_TP_CD AS OG_TP_CD
             , A.SELL_PRTNR_NO AS PRTNR_NO
             , A.BASE_PD_CD AS PD_CD
             , '' AS REF_PD_CLSF_VAL
             , '' AS PERF_TP_CD
             , A.SELL_TP_CD
             , A.SELL_DSC_DV_CD
             , CASE WHEN A.SELL_DSC_DV_CD IN ('1', '3', '8') THEN
                         DECODE(A.STPL_PTRM, '12', '1', '24', '2', '36', '3', '48', '4', '60', '5', '72', '6')
                    WHEN A.SELL_DSC_DV_CD = '5' THEN
                         A.SELL_DSCR_CD
                    ELSE
                        '0'
                    END AS SELL_DSCR_CD
             , CASE WHEN A.SELL_DSC_DV_CD != '5' THEN A.STPL_PTRM ELSE 0 END AS RECAP_DUTY_PTRM_N
             , P.SV_PD_TP_CD AS PMOT_USWY_DV_CD /* 일시불 = 0 */
             , A.SV_PRD AS BFSVC_PRD_CD
             , CASE WHEN A.SELL_TP_CD = '1' THEN 'N' /* 일시불 = '' */
                    WHEN D.MCHN_CH_TP_CD IS NOT NULL THEN 'Y'
                    ELSE 'N'
               END AS MCHN_CH_YN
             , CASE WHEN A.SELL_TP_CD = '1' THEN '' /* 일시불 = 0 */
                    ELSE A.SELL_DSC_TP_CD
               END AS SELL_DSC_TP_CD
             , CASE WHEN A.SELL_TP_CD = '1' THEN '0' /* 일시불 = 0 */
                    WHEN A.SELL_TP_CD = '6' THEN '0' /* 정기배송 = 0 */
                    ELSE NVL(D.MCHN_CH_TP_CD,0)
               END AS MCHN_CH_TP_CD
             , A.RSTL_YN
             , CASE WHEN NVL(A.FEE_ACKMT_CT, 0) > 0 AND NVL(A.FEE_ACKMT_BASE_AMT, 0) > 0 THEN '01'
                    WHEN NVL(A.FEE_ACKMT_BASE_AMT, 0) > 0 THEN '02'
                    WHEN NVL(A.FEE_ACKMT_CT, 0) > 0 THEN '03'
                    END AS FEE_ACKMT_DV_CD
             , B.OG_ID AS HDQ_OG_ID
             , CASE WHEN A.SELL_INFLW_CHNL_DTL_CD = '8050' THEN '4'
                    WHEN A.SELL_INFLW_CHNL_DTL_CD = '1090' THEN '3'
                    WHEN A.SELL_INFLW_CHNL_DTL_CD = '5010' THEN '2'
                    WHEN A.SELL_INFLW_CHNL_DTL_CD IN ('1010', '1030', '1040', '1050') THEN '1'
                    ELSE '@'
                    END AS VTSEL_SODBT_CHNL_DV_CD
             , '' AS SELL_AMT
             , '' AS SL_AMT
             , '' AS REDF_ADSB_OJ_AMT
             , '' AS VAT
             , '' AS ACKMT_PERF_RT
             , NVL(A.ACKMT_PERF_AMT,0) AS ACKMT_PERF_AMT
             , NVL(A.FEE_ACKMT_CT,0) AS ACKMT_PERF_CT
             , '' AS CVT_PERF_AMT
             , CASE WHEN NVL(A.BOO_SELL_TP_CD,0) = 2 THEN 'Y'
                    ELSE 'N'
               END AS BOO_SELL_YN
             , SUBSTR(A.CNTR_CNFM_DTM, 1, 8) AS RCPDT
             , SUBSTR(A.CNTR_PD_STRTDT, 1, 8) AS SL_DT
             , CASE WHEN A.CNTR_DTL_STAT_CD IN ('301','303') THEN SUBSTR(A.CNTR_PD_ENDDT,1,8) END AS CAN_DT
             , CASE WHEN A.SELL_TP_CD = '1' THEN 0 /* 일시불 = 0 */
                    ELSE NVL(A.STPL_PTRM,0)
               END AS STPL_PTRM_MCN
             , '' AS FEE_CPSN_REDF_ID
             , TO_CHAR(SYSDATE,'YYYYMMDD') AS OJ_PRCSDT
             , A.CO_CD AS SRC_CO_CD
             , 'N' AS DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue" />
          FROM ( /* 일시불 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , BAS.SELL_INFLW_CHNL_DTL_CD
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , DTL.CNTR_PD_STRTDT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.FEE_ACKMT_BASE_AMT
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                      , DTL.CNTR_DTL_STAT_CD
                      , DTL.CO_CD
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.DTA_DL_YN = 'N'
                  WHERE 1 = 1
                    AND BAS.SELL_OG_TP_CD = 'W04'
                    AND DTL.SELL_TP_CD = '1'  /* 일시불/할부 */
                    AND BAS.SELL_INFLW_CHNL_DTL_CD != '9020' -- 직원구매제외
                    AND DTL.BASE_PD_CD NOT IN ( 'WP07110294', 'WP07110295', 'WM07100678', 'WM07100677', 'WM07107040') /*상품코드 스태킹키트 제외*/
                    AND (
                               -- 예약판매는 당월접수, 예약판매가 아닌 경우 당월매출 발생 + 당월취소가 아닌 경우 대상
                               ( DTL.BOO_SELL_TP_CD = '2' AND BAS.CNTR_CNFM_DTM LIKE #{perfYm} || '%' )
                            OR ( DTL.BOO_SELL_TP_CD IS NULL AND DTL.CNTR_DTL_STAT_CD != '401' AND DTL.CNTR_PD_STRTDT LIKE #{perfYm} || '%' AND SUBSTR(DTL.CNTR_PD_STRTDT, 1, 6) != SUBSTR(DTL.CNTR_PD_ENDDT, 1, 6) )
                            OR ( DTL.BOO_SELL_TP_CD IS NULL AND DTL.CNTR_DTL_STAT_CD = '401' AND DTL.CNTR_PD_STRTDT LIKE #{perfYm} || '%' )
                         )
                  UNION ALL
                  /* 렌탈 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , BAS.SELL_INFLW_CHNL_DTL_CD
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , DTL.CNTR_PD_STRTDT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.FEE_ACKMT_BASE_AMT
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                      , DTL.CNTR_DTL_STAT_CD
                      , DTL.CO_CD
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.DTA_DL_YN = 'N'
                  WHERE BAS.SELL_OG_TP_CD = 'W04'
                    AND DTL.SELL_TP_CD = '2'  /* 렌탈 */
                    AND BAS.SELL_INFLW_CHNL_DTL_CD != '9020' -- 직원구매제외
                    AND (
                               -- 예약판매는 당월접수, 예약판매가 아닌 경우 당월매출 발생 + 당월취소가 아닌 경우 대상
                               ( DTL.BOO_SELL_TP_CD = '2' AND BAS.CNTR_CNFM_DTM LIKE #{perfYm} || '%' )
                            OR ( DTL.BOO_SELL_TP_CD IS NULL AND DTL.CNTR_PD_STRTDT LIKE #{perfYm} || '%' AND SUBSTR(DTL.CNTR_PD_STRTDT, 1, 6) != SUBSTR(DTL.CNTR_PD_ENDDT, 1, 6) )
                         )
                    AND NOT EXISTS (SELECT 1 FROM TB_SSCT_RENTAL_RSTL_IZ X WHERE DTL.CNTR_NO = X.CNTR_NO AND DTL.CNTR_SN = X.CNTR_SN)
                  UNION ALL
                  /* 정기배송 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , BAS.SELL_INFLW_CHNL_DTL_CD
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , DTL.CNTR_PD_STRTDT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.FEE_ACKMT_BASE_AMT
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                      , DTL.CNTR_DTL_STAT_CD
                      , DTL.CO_CD
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.DTA_DL_YN = 'N'
                  WHERE 1 = 1
                    AND BAS.SELL_OG_TP_CD = 'W04'
                    AND DTL.SELL_TP_CD = '6'  /* 정기배송 */
                    AND DTL.STPL_PTRM >= 6
                    AND BAS.SELL_INFLW_CHNL_DTL_CD != '9020' -- 직원구매제외
                    AND (
                               -- 예약판매는 당월접수, 예약판매가 아닌 경우 당월매출 발생 + 당월취소가 아닌 경우 대상
                               ( DTL.BOO_SELL_TP_CD = '2' AND BAS.CNTR_CNFM_DTM LIKE #{perfYm} || '%' )
                            OR ( DTL.BOO_SELL_TP_CD IS NULL AND DTL.CNTR_PD_STRTDT LIKE #{perfYm} || '%' AND SUBSTR(DTL.CNTR_PD_STRTDT, 1, 6) != SUBSTR(DTL.CNTR_PD_ENDDT, 1, 6) )
                         )
                  UNION ALL
                 /* 멤버십 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , BAS.SELL_INFLW_CHNL_DTL_CD
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , DTL.CNTR_PD_STRTDT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.FEE_ACKMT_BASE_AMT
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                      , DTL.CNTR_DTL_STAT_CD
                      , DTL.CO_CD
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.DTA_DL_YN = 'N'
                  WHERE 1 = 1
                    AND BAS.SELL_OG_TP_CD = 'W04'
                    AND DTL.SELL_TP_CD = '3'  /* 멤버십 */
                    AND DTL.STPL_PTRM >= 6
                    AND DTL.CNTRW_TP_CD = '5'
                    AND DTL.CNTR_DTL_STAT_CD <![CDATA[<]]>> '203'
                    AND BAS.SELL_INFLW_CHNL_DTL_CD != '9020' -- 직원구매제외
                    AND DTL.CNTR_PD_STRTDT LIKE #{perfYm} || '%'
                  ) A
            INNER JOIN TB_OGBS_MM_PRTNR_IZ B /* T월파트너내역T */
               ON A.SELL_OG_TP_CD = B.OG_TP_CD
              AND A.SELL_PRTNR_NO = B.PRTNR_NO
              AND B.BASE_YM = #{perfYm}
             LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ D  /*T기기변경내역T*/
               ON A.CNTR_NO = D.BASE_CNTR_NO
              AND A.CNTR_SN = D.BASE_CNTR_SN
            LEFT OUTER JOIN TB_SVPD_CST_SV_EXCN_IZ S /* 고객서비스수행내역    */
               ON A.CNTR_NO = S.CNTR_NO
              AND A.CNTR_SN = S.CNTR_SN
            LEFT OUTER JOIN TB_PDBS_PD_BAS P /* 상품기본 - 서비스상품 */
               ON S.SV_PD_CD = P.PD_CD
            WHERE 1=1
              AND EXISTS (SELECT 1 FROM TB_OGBS_MM_PRTNR_IZ O1 WHERE SUBSTR(A.CNTR_CNFM_DTM, 1, 6) = O1.BASE_YM AND A.SELL_OG_TP_CD = O1.OG_TP_CD AND A.SELL_PRTNR_NO = O1.PRTNR_NO AND O1.HIR_FOM_CD = '4') -- 법인영업수수료대상
              AND NOT EXISTS (
               SELECT /*+ index(S1 IX_FEDD_FEE_PERF_EXCD_OJ_BAS_01) */
                      '1'
                 FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS S1 /* 수수료실적제외대상기본 */
                INNER JOIN TB_FEDD_FEE_PERF_EXCD_OJ_DTL S2 /* 수수료실적제외대상상세 */
                   ON S1.FEE_PERF_EXCD_OJ_ID = S2.FEE_PERF_EXCD_OJ_ID /* 수수료실적제외대상ID */
                  AND S2.DTA_DL_YN = 'N'
                WHERE 1=1
                  AND S1.DTA_DL_YN = 'N'
                  AND S1.FEE_PERF_EXCD_DV_CD = '01' /* 수수료실적제외구분코드 = 01 : 실적제외 */
<!--                  AND #{perfYm} BETWEEN S1.APY_STRT_YM AND S1.APY_END_YM /* 적용시작년월, 적용종료년월 */-->
                  AND S2.PERF_DV_CD = '0' /* 실적구분코드 = 0 : 개인판매 */
                  AND S2.OG_TP_CD = A.SELL_OG_TP_CD /* 조직유형코드 */
                  AND S1.CNTR_NO = A.CNTR_NO /* 계약번호 */
                  AND S1.CNTR_SN = A.CNTR_SN /* 계약일련번호 */
               )
    </insert>


    <insert id="insertAggregateNtorMmCl">
        INSERT INTO TB_FEAM_NTOR_MM_CL (
               BASE_YM
             , FEE_TCNT_DV_CD
             , PERF_AGRG_CRT_DV_CD
             , NTOR_CNFM_STAT_CD
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField" />
        )
        SELECT #{perfYm}          AS BASE_YM
             , NVL(#{feeTcntDvCd}, '02') AS FEE_TCNT_DV_CD
             , '401'              AS PERF_AGRG_CRT_DV_CD
             , '01'               AS NTOR_CNFM_STAT_CD
             , 'N'                AS DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue" />
          FROM DUAL
    </insert>

    <insert id="insertAggregateNtorCntrMmCl">
        INSERT INTO TB_FEAM_NTORP_CNTR_MM_CL (
               BASE_YM
             , PERF_YM
             , FEE_TCNT_DV_CD
             , PERF_AGRG_CRT_DV_CD
             , PERF_ATC_CD
             , CO_CD
             , OG_TP_CD
             , PRTNR_NO
             , PERF_DV_CD
             , CNTR_NO
             , CNTR_SN
             , CNTR_PERF_CRT_DV_CD
             , PERF_VAL
             , DTA_DL_YN
              <include refid="COMMON.insertSystemField" />
        )
        SELECT U.BASE_YM
             , U.PERF_YM
             , U.FEE_TCNT_DV_CD
             , '401'                    AS PERF_AGRG_CRT_DV_CD
             , U.PERF_ATC_CD            AS PERF_ATC_CD
             , '2000'    AS CO_CD
             , U.OG_TP_CD
             , U.PRTNR_NO
             , '0'  AS PERF_DV_CD
             , U.CNTR_NO
             , U.CNTR_SN
             , U.CNTR_PERF_CRT_DV_CD
             , U.PERF_VAL
             , 'N'                      AS DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue" />
            FROM (
                SELECT T1.BASE_YM
                     , T1.PERF_YM
                     , T1.FEE_TCNT_DV_CD
                     , T1.OG_TP_CD
                     , T1.PRTNR_NO
                     , T1.CNTR_NO
                     , T1.CNTR_SN
                     , T1.CNTR_PERF_CRT_DV_CD
                     , T1.PERF_VAL AS W04P00001 /*기본수수료*/
                     , (CASE WHEN T1.SODM IS NOT NULL THEN T1.LCCN31 ELSE 0 END) AS W04P00002 /*삼성ODM수량*/
                     , T1.LCCN31 AS W04P00003 /*일반건수(렌탈수량)*/
                     , T1.LCCN32 AS W04P00004 /*기변１건수*/
                     , T1.LCCN33 AS W04P00005 /*기변2건수*/
                     , T1.LCCN34 AS W04P00006 /*기변3건수*/
                     , T1.LCCN35 AS W04P00007 /*단체할인일반*/
                     , T1.LCCN51 AS W04P00008 /*홈케어일시수*/
                     , T1.LCCN52 AS W04P00009 /*홈케어멤버수*/
                     , (T1.LCCN31 + T1.LCCN35 + T1.LCCN51 + T1.LCCN52) AS W04P00010 /*총건수*/
                FROM (
                        SELECT T1.*
                             , (CASE WHEN T1.SELL_TP_CD = '1' THEN
                                        (CASE WHEN T1.SELL_DSC_DV_CD ='9' AND T1.SELL_DSCR_CD ='99' THEN 0
                                              WHEN T1.SELL_DSC_DV_CD ='5' AND T1.SELL_DSCR_CD IN ('11','12','13','14') AND T1.ACKMT_PERF_AMT > 0 THEN 0
                                              WHEN T1.ENVR_ELHM_YN = 'Y' /* 환경가전여부 = Y  */
                                               AND T1.SELL_TP_DTL_CD != '12'
                                               AND T1.FEE_FXAM_YN = 'N'
                                               AND T1.ACKMT_PERF_AMT > 0 THEN T1.ACKMT_PERF_CT
                                              ELSE 0 END)
                                     WHEN T1.SELL_TP_CD = '2' THEN
                                        (CASE WHEN T1.SELL_DSC_DV_CD ='5' AND T1.SELL_DSCR_CD IN ('5','6','9') AND T1.ACKMT_PERF_AMT > 2 THEN 0
                                              WHEN T1.PD_CD IN ('WP05120457', 'WP05120458', 'WP05120459') THEN 0 /*커피원두*/
                                              WHEN T1.ACKMT_PERF_EXCD_YN = 'N' AND T1.SELL_DSC_DV_CD !='5' AND T1.MCHN_CH_YN = 'Y' AND T1.MCHN_CH_TP_CD = '0' AND T1.ACKMT_PERF_AMT > 0 THEN T1.FEE_ACKMT_CT
                                              WHEN T1.ACKMT_PERF_EXCD_YN = 'N' AND T1.SELL_DSC_DV_CD !='5' AND T1.MCHN_CH_YN = 'N' AND T1.ACKMT_PERF_AMT > 0 THEN T1.FEE_ACKMT_CT
                                              ELSE 0 END)
                                     WHEN T1.SELL_TP_CD = '3' THEN
                                        (CASE WHEN T1.SELL_TP_DTL_CD = '33' AND T1.SELL_DSC_TP_CD = 'P1' THEN 1 ELSE 0 END)
                                     ELSE 0 END) AS LCCN31 /*일반건수(렌탈수량)*/
                             , (CASE WHEN T1.SELL_TP_CD = '1' THEN 0
                                     WHEN T1.SELL_TP_CD = '2' THEN
                                        (CASE WHEN T1.ACKMT_PERF_EXCD_YN = 'N'
                                               AND T1.SELL_DSC_DV_CD !='5'
                                               AND T1.MCHN_CH_YN = 'Y'
                                               AND T1.MCHN_CH_TP_CD = '18' THEN T1.FEE_ACKMT_CT
                                              ELSE 0 END)
                                     WHEN T1.SELL_TP_CD = '3' THEN 0
                                     ELSE 0 END) AS LCCN32 /*기변１건수*/
                             , (CASE WHEN T1.SELL_TP_CD = '1' THEN 0
                                     WHEN T1.SELL_TP_CD = '2' THEN
                                        (CASE WHEN T1.ACKMT_PERF_EXCD_YN = 'N'
                                               AND T1.SELL_DSC_DV_CD !='5'
                                               AND T1.MCHN_CH_YN = 'Y'
                                               AND T1.MCHN_CH_TP_CD = '1' THEN T1.FEE_ACKMT_CT
                                              ELSE 0 END)
                                     WHEN T1.SELL_TP_CD = '3' THEN 0
                                     ELSE 0 END) AS LCCN33 /*기변2건수*/
                             , (CASE WHEN T1.SELL_TP_CD = '1' THEN 0
                                     WHEN T1.SELL_TP_CD = '2' THEN
                                        (CASE WHEN T1.ACKMT_PERF_EXCD_YN = 'N'
                                               AND T1.SELL_DSC_DV_CD !='5'
                                               AND T1.MCHN_CH_YN = 'Y'
                                               AND T1.MCHN_CH_TP_CD IN ('15','16','19') THEN T1.FEE_ACKMT_CT
                                              ELSE 0 END)
                                     WHEN T1.SELL_TP_CD = '3' THEN 0
                                     ELSE 0 END) AS LCCN34 /*기변3건수*/
                             , (CASE WHEN T1.SELL_TP_CD = '1' THEN 0
                                     WHEN T1.SELL_TP_CD = '2' THEN
                                        (CASE WHEN T1.ACKMT_PERF_EXCD_YN = 'N'
                                               AND T1.SELL_DSC_DV_CD ='5'
                                               AND T1.ACKMT_PERF_AMT > 0
                                               AND T1.MCHN_CH_TP_CD = '0' THEN T1.FEE_ACKMT_CT
                                              ELSE 0 END)
                                     WHEN T1.SELL_TP_CD = '3' THEN 0
                                     ELSE 0 END) AS LCCN35 /*단체할인일반*/
                             , (CASE WHEN T1.SELL_TP_CD = '1' THEN (CASE WHEN T1.SELL_TP_DTL_CD = '12' THEN 1 ELSE 0 END)
                                     WHEN T1.SELL_TP_CD = '2' THEN 0
                                     WHEN T1.SELL_TP_CD = '3' THEN 0
                                     ELSE 0 END) AS LCCN51 /*홈케어일시수*/
                             , (CASE WHEN T1.SELL_TP_CD = '1' THEN 0
                                     WHEN T1.SELL_TP_CD = '2' THEN 0
                                     WHEN T1.SELL_TP_CD = '3' THEN 1
                                     ELSE 0 END) AS LCCN52 /*홈케어멤버수*/
                             , T4.PD_PRP_VAL02 AS SODM /*삼성ODM*/
                          FROM (
                                SELECT A.*
                                     , NVL(P3.PD_PRP_VAL11, 'N') AS ENVR_ELHM_YN
                                     , CASE WHEN D.MCHN_CPS_APYR = 0 THEN 'Y'
                                            WHEN A.MCHN_CH_YN = 'Y' AND A.ACKMT_PERF_AMT = 0 THEN 'Y'
                                            ELSE 'N'
                                            END ACKMT_PERF_EXCD_YN /*실적제외여부*/
                                  FROM (
                                        SELECT *
                                          FROM (
                                                SELECT T1.*
                                                     , NVL(F1.SELL_FEE, 0) AS PERF_VAL   -- 판매수수료(총판) - As-Is의 LC1250P.LCAM01
                                                     , ROW_NUMBER() OVER(PARTITION BY T1.CNTR_NO, T1.CNTR_SN ORDER BY NVL(F1.HGR_PD_CD, '0') DESC, F1.SV_PRD DESC, F1.FST_RGST_DTM DESC) SEQ
                                                  FROM (
                                                            SELECT N1.BASE_YM
                                                                 , N1.PERF_YM
                                                                 , N1.CNTR_PERF_CRT_DV_CD
                                                                 , N1.FEE_TCNT_DV_CD
                                                                 , N1.CNTR_NO
                                                                 , N1.CNTR_SN
                                                                 , N1.SELL_TP_CD
                                                                 , N1.PD_CD
                                                                 , N1.OG_TP_CD
                                                                 , N1.PRTNR_NO
                                                                 , C2.FEE_ACKMT_BASE_AMT
                                                                 , C2.SELL_AMT
                                                                 , C2.SELL_FEE
                                                                 , C2.ACKMT_PERF_AMT
                                                                 , C2.HGR_PD_CD
                                                                 , (SELECT X1.OJ_PD_CD
                                                                      FROM TB_SSCT_CNTR_PD_REL X1
                                                                     WHERE N1.CNTR_NO = X1.CNTR_NO
                                                                       AND N1.CNTR_SN = X1.CNTR_SN
                                                                       AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN X1.VL_STRT_DTM AND X1.VL_END_DTM
                                                                       AND X1.PD_REL_TP_CD = '03'
                                                                       AND X1.BASE_PD_CD = N1.PD_CD) AS SV_PD_CD
                                                                 , C2.SELL_DSC_TP_CD
                                                                 , C2.SELL_DSC_DV_CD
                                                                 , N1.SELL_DSCR_CD
                                                                 , N1.BFSVC_PRD_CD AS SV_PRD
                                                                 , C3.HCR_DV_CD
                                                                 , NVL(C2.FEE_FXAM_YN, 'N') AS FEE_FXAM_YN
                                                                 , NVL(N1.MCHN_CH_TP_CD,'0') AS MCHN_CH_TP_CD
                                                                 , NVL(N1.MCHN_CH_YN, 'N') AS MCHN_CH_YN
                                                                 , C2.SELL_TP_DTL_CD
                                                                 , C2.FEE_ACKMT_CT
                                                                 , N1.ACKMT_PERF_CT
                                                              FROM TB_FEAM_WELS_NRCTR_MM_CL N1
                                                        INNER JOIN TB_SSCT_CNTR_BAS C1
                                                                ON N1.CNTR_NO = C1.CNTR_NO
                                                        INNER JOIN TB_SSCT_CNTR_DTL C2
                                                                ON N1.CNTR_NO = C2.CNTR_NO
                                                               AND N1.CNTR_SN = C2.CNTR_SN
                                                        INNER JOIN TB_SSCT_CNTR_WELLS_DTL C3
                                                                ON N1.CNTR_NO = C3.CNTR_NO
                                                               AND N1.CNTR_SN = C3.CNTR_SN
                                                             WHERE 1 = 1
                                                               AND N1.BASE_YM = #{perfYm}
                                                               AND N1.OG_TP_CD = 'W04'
                                                               AND N1.CNTR_PERF_CRT_DV_CD = '01' --계약실적생성구분코드 - 01순주문
                                                               AND N1.FEE_TCNT_DV_CD = NVL(#{feeTcntDvCd}, '02')
                                                               AND NVL(N1.ACKMT_PERF_CT, 0) > 0
                                                        ) T1
                                            LEFT OUTER JOIN TB_PDBS_PD_BAS P1
                                                    ON T1.SV_PD_CD = P1.PD_CD
                                            LEFT OUTER JOIN TB_FEAM_NCHN_FEE_BAS F1  --신채널수수료기본
                                                    ON T1.SELL_TP_CD = F1.SELL_TP_CD
                                                   AND T1.PD_CD = F1.PD_CD
                                                   /* 상위상품코드는 판매유형코드(SELL_TP_CD)가 렌탈(2)인 경우만 적용 */
                                                   AND (
                                                            ( T1.SELL_TP_CD != '2' AND 1 = 1 )
                                                         OR ( T1.SELL_TP_CD = '2' AND ( T1.HGR_PD_CD = F1.HGR_PD_CD OR F1.HGR_PD_CD IS NULL ) )
                                                       )
                                                   -- AND NVL(P1.SV_PD_TP_CD, 'X') = NVL(F1.USWY_TP_CD, 'X')
                                                   AND F1.USWY_TP_CD IN (NVL(P1.SV_PD_TP_CD,'0'), 'A')
                                                   AND NVL(T1.SELL_DSC_TP_CD, 'X') = NVL(F1.PMOT_CD, 'X')
                                                   AND NVL(T1.SELL_DSC_DV_CD, 'X') = NVL(F1.SELL_DSC_DV_CD, 'X')
                                                   AND NVL(T1.SELL_DSCR_CD, 'X') = NVL(F1.SELL_DSCR_CD, 'X')
                                                   AND F1.SV_PRD IN (T1.SV_PRD, '0')
                                                   AND F1.FEEC_DV_CD = 'W' --WB2B
                                                   AND #{perfYm} BETWEEN SUBSTR(F1.APY_STRTDT, 1, 6) AND SUBSTR(F1.APY_ENDDT, 1, 6)
                                                 WHERE 1 = 1
                                              ) Y1
                                        WHERE 1 = 1
                                          AND Y1.SEQ = 1
                                ) A
                                LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL P3
                                             ON A.PD_CD = P3.PD_CD
                                            AND P3.PD_EXTS_PRP_GRP_CD = 'IND'
                                LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ D  /*T기기변경내역T*/
                                             ON A.CNTR_NO = D.BASE_CNTR_NO
                                            AND A.CNTR_SN = D.BASE_CNTR_SN
                          ) T1
                      INNER JOIN TB_FEAM_NRCTR_MM_CL T2  /* 순주문계약월마감 */
                         ON T2.BASE_YM             = T1.BASE_YM
                        AND T2.FEE_TCNT_DV_CD      = T1.FEE_TCNT_DV_CD
                        AND T2.CNTR_PERF_CRT_DV_CD = T1.CNTR_PERF_CRT_DV_CD
                        AND T2.NTOR_CNFM_STAT_CD   = '02'   -- 순주문확정상태코드 - 01임시저장, 02확정
                     LEFT JOIN TB_PDBS_PD_ECOM_PRP_DTL T4
                            ON T4.PD_CD = T1.PD_CD
                           AND T4.PD_EXTS_PRP_GRP_CD = 'SPP'
                           AND T4.PD_PRP_VAL02 = 'S'
                           AND T4.DTA_DL_YN = 'N'
          ) T1
       )
       UNPIVOT ( PERF_VAL FOR PERF_ATC_CD IN ( W04P00001 AS 'W04P00001', W04P00002 AS 'W04P00002', W04P00003 AS 'W04P00003', W04P00004 AS 'W04P00004', W04P00005 AS 'W04P00005'
                                             , W04P00006 AS 'W04P00006', W04P00007 AS 'W04P00007', W04P00008 AS 'W04P00008', W04P00009 AS 'W04P00009', W04P00010 AS 'W04P00010'
                                             )
               ) U
    </insert>

    <insert id="insertAggregateNtorPerfMmCl">
        INSERT INTO TB_FEAM_NTORP_PERF_MM_CL (
            BASE_YM
          , PERF_YM
          , FEE_TCNT_DV_CD
          , PERF_AGRG_CRT_DV_CD
          , PERF_ATC_CD
          , CO_CD
          , OG_TP_CD
          , PRTNR_NO
          , PERF_DV_CD
          , PERF_VAL
          , DTA_DL_YN
          <include refid="COMMON.insertSystemField" />
        )
        SELECT T1.BASE_YM
             , T1.PERF_YM
             , T1.FEE_TCNT_DV_CD
             , T1.PERF_AGRG_CRT_DV_CD
             , T1.PERF_ATC_CD
             , T1.CO_CD
             , T1.OG_TP_CD
             , T1.PRTNR_NO
             , '0'                AS PERF_DV_CD
             , SUM(T1.PERF_VAL)   AS PERF_VAL
             , 'N'                AS DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue" />
          FROM TB_FEAM_NTORP_CNTR_MM_CL T1 /* 순주문파트너계약월마감 */
         WHERE T1.BASE_YM             = #{perfYm}
           AND T1.FEE_TCNT_DV_CD      =  NVL(#{feeTcntDvCd}, '02')
           AND T1.PERF_AGRG_CRT_DV_CD = '401'
           /* AND T1.PERF_ATC_CD         = 'W04P00001' 2023.12.26*/
           AND T1.OG_TP_CD            = 'W04'
           AND T1.PERF_DV_CD          = '0'
         GROUP BY T1.BASE_YM
                , T1.PERF_YM
                , T1.FEE_TCNT_DV_CD
                , T1.PERF_AGRG_CRT_DV_CD
                , T1.PERF_ATC_CD
                , T1.CO_CD
                , T1.OG_TP_CD
                , T1.PRTNR_NO
    </insert>

    <insert id="insertOgAggregateNtorPerfMmCl">
        INSERT INTO TB_FEAM_NTORP_PERF_MM_CL (
            BASE_YM
          , PERF_YM
          , FEE_TCNT_DV_CD
          , PERF_AGRG_CRT_DV_CD
          , PERF_ATC_CD
          , CO_CD
          , OG_TP_CD
          , PRTNR_NO
          , PERF_DV_CD
          , PERF_VAL
          , DTA_DL_YN
          <include refid="COMMON.insertSystemField" />
        )
        SELECT T1.BASE_YM
             , T1.PERF_YM
             , T1.FEE_TCNT_DV_CD
             , T1.PERF_AGRG_CRT_DV_CD
             , T1.PERF_ATC_CD
             , T1.CO_CD
             , T1.OG_TP_CD
             , T3.DGR3_LEVL_DG_PRTNR_NO
             , '2'                   AS PERF_DV_CD
             , SUM(T1.PERF_VAL)      AS PERF_VAL
             , 'N'                   AS DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue" />
          FROM TB_FEAM_NTORP_PERF_MM_CL T1  /* 순주문파트너실적월마감 */
         INNER JOIN       TB_OGBS_MM_PRTNR_IZ      T2  /* 월파트너내역           */
            ON T2.BASE_YM  = T1.BASE_YM
           AND T2.OG_TP_CD = T1.OG_TP_CD
           AND T2.PRTNR_NO = T1.PRTNR_NO
         INNER JOIN       TB_OGBS_MM_OG_IZ         T3  /* 월조직내역             */
            ON T3.BASE_YM  = T2.BASE_YM
           AND T3.OG_ID    = T2.OG_ID
         WHERE T1.BASE_YM             = #{perfYm}
           AND T1.FEE_TCNT_DV_CD      = NVL(#{feeTcntDvCd}, '02')
           AND T1.PERF_AGRG_CRT_DV_CD = '401'
           /* AND T1.PERF_ATC_CD         = 'W04P00001' 2023.12.26 */
           AND T1.OG_TP_CD            = 'W04'
           AND T1.PERF_DV_CD          = '0'
        GROUP BY T1.BASE_YM
               , T1.PERF_YM
               , T1.FEE_TCNT_DV_CD
               , T1.PERF_AGRG_CRT_DV_CD
               , T1.PERF_ATC_CD
               , T1.CO_CD
               , T1.OG_TP_CD
               , T3.DGR3_LEVL_DG_PRTNR_NO
    </insert>

    <insert id="insertAggregateNtorPerfPointMmCl">
        INSERT INTO TB_FEAM_NTORP_PERF_MM_CL (
               BASE_YM
             , PERF_YM
             , FEE_TCNT_DV_CD
             , PERF_AGRG_CRT_DV_CD
             , PERF_ATC_CD
             , CO_CD
             , OG_TP_CD
             , PRTNR_NO
             , PERF_DV_CD
             , PERF_VAL
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField" />
        )
        SELECT T1.BASE_YM
             , T1.PERF_YM
             , T1.FEE_TCNT_DV_CD
             , T1.PERF_AGRG_CRT_DV_CD
             , T1.PERF_ATC_CD
             , T1.CO_CD
             , T1.OG_TP_CD
             , T3.DGR3_LEVL_DG_PRTNR_NO
             , '2'                  AS PERF_DV_CD     /* 지국(지점)실적 */
             , SUM(T1.PERF_VAL)     AS PERF_VAL
             , 'N'                                     AS DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue" />
          FROM TB_FEAM_NTORP_PERF_MM_CL T1
         INNER JOIN
               TB_OGBS_MM_PRTNR_IZ T2
            ON T2.BASE_YM  = T1.BASE_YM
           AND T2.OG_TP_CD = T1.OG_TP_CD
           AND T2.PRTNR_NO = T1.PRTNR_NO
        -- INNER JOIN   -- 월조직내역 들어오면 주석 풀자.
          LEFT OUTER JOIN
               TB_OGBS_MM_OG_IZ T3
            ON T3.BASE_YM  = T2.BASE_YM
           AND T3.OG_ID    = T2.OG_ID
         WHERE T1.BASE_YM             = #{perfYm}
           AND T1.FEE_TCNT_DV_CD      = NVL(#{feeTcntDvCd}, '02')
           AND T1.PERF_AGRG_CRT_DV_CD = '401'
           /* AND T1.PERF_ATC_CD         = 'W04P00001' 2023.12.26 */
        -- AND T1.CO_CD               = '2000'
           AND T1.OG_TP_CD            = 'W04'
           AND T1.PERF_DV_CD          = '0'
         GROUP BY T1.BASE_YM
                , T1.PERF_YM
                , T1.FEE_TCNT_DV_CD
                , T1.PERF_AGRG_CRT_DV_CD
                , T1.PERF_ATC_CD
                , T1.CO_CD
                , T1.OG_TP_CD
                , T3.DGR3_LEVL_DG_PRTNR_NO
    </insert>

    <update id="updateAggregateNtorMmCl">
        UPDATE TB_FEAM_NTOR_MM_CL T1
           SET T1.NTOR_CNFM_STAT_CD = '02'
               <include refid="COMMON.updateSystemField"/>
         WHERE T1.BASE_YM             = #{perfYm}
           AND T1.FEE_TCNT_DV_CD      = NVL(#{feeTcntDvCd}, '02')
           AND T1.PERF_AGRG_CRT_DV_CD = '401'
    </update>
</mapper>
