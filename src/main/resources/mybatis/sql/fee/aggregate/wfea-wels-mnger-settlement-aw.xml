<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.aggregate.mapper.WfeaWelsMngerSettlementAwMapper">

    <sql id="selectPlarQlf">
      SELECT THMQ.OG_TP_CD
           , THMQ.PRTNR_NO
           , THMQ.QLF_DV_CD
           , NMNQ.QLF_DV_CD                                        AS M1_QLF_DV_CD /* M+1  WM 자격 */
           , SUBSTR(THMQ.CV_DT,1,6)                                AS CV_DT /* WM전환월 */
           , CASE WHEN TO_CHAR(SYSDATE,'YYYYMM')
               BETWEEN THMQ.STRTDT AND THMQ.ENDDT
                  THEN 'Y' ELSE 'N' END                            AS BZ_STAT_CD /* WM - 활동여부 */
           , NVL(BSQ.STRTDT, THMQ.STRTDT)                          AS CNTR_DT /* 계약일 */
           , THMQ.ENDDT                                            AS CLTN_DT
           , NVL(FQ.FST_CNTR_DT,NVL(BSQ.STRTDT, THMQ.STRTDT))      AS FST_CNTR_DT
           , FQ.FNL_CLTN_DT
        FROM TB_OGPS_PLAR_QLF_CH_IZ THMQ /* 당월 플래너 자격 */
        LEFT OUTER JOIN TB_OGPS_PLAR_QLF_CH_IZ BSQ /* BS프리매니저에서 웰스플래너로 바뀐 자격 내역 */
          ON BSQ.OG_TP_CD = THMQ.OG_TP_CD
         AND BSQ.PRTNR_NO = THMQ.PRTNR_NO
         AND THMQ.QLF_DV_CD = '3'
         AND BSQ.QLF_DV_CD = '6'
         AND BSQ.ENDDT != '99991231'
         AND BSQ.ENDDT = TO_CHAR(TO_DATE(THMQ.STRTDT, 'YYYYMMDD') - 1, 'YYYYMMDD')
         AND BSQ.QLF_APLC_DV_CD IN ('1', '2')
         AND BSQ.DTA_DL_YN = 'N'
        LEFT OUTER JOIN TB_OGPS_PLAR_QLF_CH_IZ NMNQ /* 차월 플래너 자격 */
          ON NMNQ.OG_TP_CD = THMQ.OG_TP_CD
         AND NMNQ.PRTNR_NO = THMQ.PRTNR_NO
         AND NMNQ.QLF_APLC_DV_CD IN ('1', '2')
         AND TO_CHAR(LAST_DAY(ADD_MONTHS(TO_DATE(#{baseYm} || '01', 'YYYYMMDD'), 1)), 'YYYYMMDD') BETWEEN NMNQ.STRTDT AND NMNQ.ENDDT
         AND NMNQ.DTA_DL_YN = 'N'
        LEFT OUTER JOIN (
                SELECT PRTNR_NO
                     , MIN(FNLQ.STRTDT) AS FST_CNTR_DT
                     , MAX(FNLQ.ENDDT)  AS FNL_CLTN_DT
                  FROM TB_OGPS_PLAR_QLF_CH_IZ FNLQ /* 최초계약, 최종해약 조회 */
                 WHERE FNLQ.OG_TP_CD = 'W02'
                   AND FNLQ.QLF_DV_CD IN ('3', '6')
                   AND FNLQ.QLF_APLC_DV_CD IN ('1', '2')
                   AND FNLQ.DTA_DL_YN = 'N'
                   AND NVL(FNLQ.ENDDT, '99991231') <![CDATA[<]]> #{baseYm}
                 GROUP BY PRTNR_NO
             ) FQ
          ON FQ.PRTNR_NO = THMQ.PRTNR_NO
       WHERE 1=1
         AND THMQ.OG_TP_CD = 'W02'
         AND THMQ.QLF_DV_CD IN ('3','6')
         AND TO_CHAR(LAST_DAY(TO_DATE(#{baseYm} || '01', 'YYYYMMDD')), 'YYYYMMDD') BETWEEN THMQ.STRTDT AND THMQ.ENDDT
         AND THMQ.QLF_APLC_DV_CD IN ('1', '2')
         AND THMQ.DTA_DL_YN = 'N'
      UNION
      SELECT NMNQ.OG_TP_CD
           , NMNQ.PRTNR_NO
           , THMQ.QLF_DV_CD
           , NMNQ.QLF_DV_CD                                        AS M1_QLF_DV_CD /* M+1  WM 자격 */
           , SUBSTR(NMNQ.CV_DT,1,6)                                AS CV_DT /* WM전환월 */
           , CASE WHEN TO_CHAR(SYSDATE,'YYYYMM')
               BETWEEN NMNQ.STRTDT AND NMNQ.ENDDT
                  THEN 'Y' ELSE 'N' END                            AS BZ_STAT_CD /* WM - 활동여부 */
           , NVL(BSQ.STRTDT, NMNQ.STRTDT)                          AS CNTR_DT /* 계약일 */
           , NMNQ.ENDDT                                            AS CLTN_DT
           , NVL(FQ.FST_CNTR_DT,NVL(BSQ.STRTDT, NMNQ.STRTDT))      AS FST_CNTR_DT
           , FQ.FNL_CLTN_DT
        FROM TB_OGPS_PLAR_QLF_CH_IZ NMNQ /* 차월 플래너 자격 */
        LEFT OUTER JOIN TB_OGPS_PLAR_QLF_CH_IZ BSQ /* BS프리매니저에서 웰스플래너로 바뀐 자격 내역 */
          ON BSQ.OG_TP_CD = NMNQ.OG_TP_CD
         AND BSQ.PRTNR_NO = NMNQ.PRTNR_NO
         AND NMNQ.QLF_DV_CD = '3'
         AND BSQ.QLF_DV_CD = '6'
         AND BSQ.ENDDT != '99991231'
         AND BSQ.ENDDT = TO_CHAR(TO_DATE(NMNQ.STRTDT, 'YYYYMMDD') - 1, 'YYYYMMDD')
         AND BSQ.QLF_APLC_DV_CD IN ('1', '2')
         AND BSQ.DTA_DL_YN = 'N'
        LEFT OUTER JOIN (
                SELECT PRTNR_NO
                     , MIN(FNLQ.STRTDT) AS FST_CNTR_DT
                     , MAX(FNLQ.ENDDT)  AS FNL_CLTN_DT
                  FROM TB_OGPS_PLAR_QLF_CH_IZ FNLQ /* 최초계약, 최종해약 조회 */
                 WHERE FNLQ.OG_TP_CD = 'W02'
                   AND FNLQ.QLF_DV_CD IN ('3', '6')
                   AND FNLQ.QLF_APLC_DV_CD IN ('1', '2')
                   AND FNLQ.DTA_DL_YN = 'N'
                   AND NVL(FNLQ.ENDDT, '99991231') <![CDATA[<]]> #{baseYm}
                 GROUP BY PRTNR_NO
             ) FQ
          ON FQ.PRTNR_NO = NMNQ.PRTNR_NO
        LEFT OUTER JOIN TB_OGPS_PLAR_QLF_CH_IZ THMQ /* 당월 플래너 자격 */
          ON NMNQ.OG_TP_CD = THMQ.OG_TP_CD
         AND NMNQ.PRTNR_NO = THMQ.PRTNR_NO
         AND NMNQ.QLF_APLC_DV_CD IN ('1', '2')
         AND TO_CHAR(LAST_DAY(TO_DATE(#{baseYm} || '01', 'YYYYMMDD')), 'YYYYMMDD') BETWEEN THMQ.STRTDT AND THMQ.ENDDT
         AND NMNQ.DTA_DL_YN = 'N'
       WHERE 1=1
         AND NMNQ.OG_TP_CD = 'W02'
         AND NMNQ.QLF_DV_CD IN ('3','6')
         AND TO_CHAR(LAST_DAY(ADD_MONTHS(TO_DATE(#{baseYm} || '01', 'YYYYMMDD'), 1)), 'YYYYMMDD') BETWEEN NMNQ.STRTDT AND NMNQ.ENDDT
         AND NMNQ.QLF_APLC_DV_CD IN ('1', '2')
         AND NMNQ.DTA_DL_YN = 'N'
    </sql>

    <select id="selectWelsMngers"
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaWelsMngerSettlementAwDto$SearchRes">
            SELECT NVL(MO.DGR1_LEVL_OG_NM, MO.DGR1_LEVL_OG_CD)           AS DGR1_LEVL_OG_NM
                 , NVL(MO.DGR2_LEVL_OG_NM, MO.DGR2_LEVL_OG_CD)           AS DGR2_LEVL_OG_NM
                 , MO.OG_CD
                 , MO.BLD_NM
                 , WM.PRTNR_NO
                 , MP.PRTNR_KNM
                 , MP.RSB_DV_CD /* 직책명 */
                 , WM.QLF_DV_CD /* M조직 웰스매니저 자격 */
                 , WM.M1_QLF_DV_CD /* M+1  WM 자격 */
                 , WM.CV_DT /* WM전환월 */
                 , WM.BZ_STAT_CD /* WM - 활동여부 */
                 , WM.CNTR_DT /* 계약일 */
                 , WM.CLTN_DT /* 해약일 */
                 , WM.FST_CNTR_DT /* 최초계약일 */
                 , WM.FNL_CLTN_DT /* 최종해약일 */
                 , ED.EDU96_YM                                           AS STRTUP_DT /* 스타트업 */
                 , ED.EDU143_YM                                          AS PRE_STRTUP_DT /* 프리스타트업 */
                 , NVL(W3.OPNG_CD, '9')                                  AS OPNG_CD
                 , #{baseYm}                                             AS BASE_YM
                 , #{tcntDvCd}                                           AS TCNT_DV_CD
                 , #{cnfmStatYn}                                         AS CNFM_STAT_YN
              FROM (
                    <include refid="selectPlarQlf"/>
                   ) WM
              LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ MP
                ON MP.BASE_YM = #{baseYm}
               AND MP.OG_TP_CD = WM.OG_TP_CD
               AND MP.PRTNR_NO = WM.PRTNR_NO
              LEFT OUTER JOIN TB_OGBS_MM_OG_IZ MO
                ON MO.BASE_YM = MP.BASE_YM
               AND MO.OG_ID = MP.OG_ID
              LEFT OUTER JOIN (
                      SELECT OG_TP_CD
                           , PRTNR_NO
                           , EDU96_YM
                           , EDU143_YM
                      FROM (
                              SELECT A.OG_TP_CD
                                   , A.PRTNR_NO
                                   , A.EDUC_CRSE_NO
                                   , A.EDUC_CRSE_CRT_BASE_YM
                                FROM TB_PSCA_MCPTN_EDUC_IZ A
                               WHERE 1 = 1
                                 AND A.EDUC_CRSE_NO IN ('96', '143')
                                 AND A.EDUC_CPC_ACKMT_YN = 'Y'
                                 AND A.DTA_DL_YN = 'N'
                           ) A
                     PIVOT ( MAX(EDUC_CRSE_CRT_BASE_YM) FOR EDUC_CRSE_NO IN ('96' AS EDU96_YM,'143' AS EDU143_YM))
                   ) ED
                ON MP.OG_TP_CD = ED.OG_TP_CD
               AND MP.PRTNR_NO = ED.PRTNR_NO
              LEFT OUTER JOIN TB_FEAM_WELS_MNGER_OPNG_BAS W3 /* 웰스매니저개시기본 */
                ON W3.BASE_YM = #{baseYm}
               AND MP.OG_TP_CD = W3.OG_TP_CD
               AND MP.PRTNR_NO = W3.PRTNR_NO
               AND W3.TCNT_DV_CD = #{tcntDvCd}
             WHERE 1=1
                <choose>
                    <when test="@MybatisUtils@equals(divCd, '01')">
               AND WM.CNTR_DT LIKE #{baseYm} || '%'
                    </when>
                    <when test="@MybatisUtils@equals(divCd, '02')">
               AND WM.CLTN_DT LIKE #{baseYm} || '%'
                    </when>
                    <when test="@MybatisUtils@equals(divCd, '03')">
               AND NVL(SUBSTR(WM.CLTN_DT,1,6),'999912') >= #{baseYm}
                    </when>
                </choose>
                <if test="@MybatisUtils@isNotEmpty(rsbDvCd)">
               AND MP.RSB_DV_CD = #{rsbDvCd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
               AND WM.PRTNR_NO = #{prtnrNo}
                </if>
             ORDER BY TO_NUMBER(WM.PRTNR_NO)
    </select>

    <select id='selectWelsMngersOld'
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaWelsMngerSettlementAwDto$SearchRes">
        SELECT T2.DGR1_LEVL_OG_NM AS OG1_NM /* 총괄단 */
             , T2.DGR2_LEVL_OG_NM AS OG2_NM  /* 지역단 */
             , T1.OG_CD AS OG_ID  /* 소속 */
             , T2.BLD_NM     /* 빌딩명 */
             , T1.PRTNR_NO  /* 번호 */
             , T1.PRTNR_KNM  /* 성명 */
             , T1.RSB_DV_CD /* 직책 */
             , T1.QLF_DV_CD AS QLF_DV_CD
             , T7.QLF_DV_CD AS NEXT_QLF_DV_CD /* M+1자격 */
             , SUBSTR(T4.MNGR2_ATC, 0, 6) AS PROCS_DTM   /* WM전환월 */
             , T8.EDU096  AS SRTUP /* 스타트업 */
             , T8.EDU143  AS FREE_SRTUP /* 프리스타트업 */
             , CASE WHEN T1.BZ_STAT_CD = '1' THEN 'Y' /* 사업상태코드 = 1 사업 */
                    ELSE 'N'                          /* 사업상태코드 = (2,3) 해약, 휴업 */
               END AS BZ_STAT_CD  /* 활동여부 */
             , T3.MNGR1_ATC AS FST_CNTR_DT /*매니저개시-최초개시월*/
             , CASE WHEN T3.MNGR1_ATC = T4.MNGR2_ATC THEN ''
                    ELSE T4.MNGR2_ATC
               END AS CNTR_DT /*매니저개시-재개시월*/
             , CASE WHEN T5.MNGR3_ATC = T6.MNGR4_ATC THEN ''
                    ELSE T5.MNGR3_ATC
               END AS FNL_CLTN_DT /*매니저개시-최종해약월*/
             , T6.MNGR4_ATC AS CLTN_DT /*매니저개시-업무해약월*/
             , NVL(T9.OPNG_CD,'9') AS OPNG_CD
             , T1.BASE_YM
             , T9.TCNT_DV_CD
             , NVL(T9.CNFM_STAT_YN,'X') AS CNFM_STAT_YN
          FROM TB_OGBS_MM_PRTNR_IZ T1  /* 월 파트너*/
         INNER JOIN TB_OGBS_MM_OG_IZ T2  /* 월 조직 */
            ON T1.OG_ID = T2.OG_ID
           AND T1.OG_TP_CD = T2.OG_TP_CD
           AND T1.BASE_YM = T2.BASE_YM

          LEFT OUTER JOIN
             (
               SELECT MIN(STRTDT) AS MNGR1_ATC /* 매니저 최초게시일 */
                    , PRTNR_NO
                 FROM TB_OGPS_PLAR_QLF_CH_IZ
                WHERE 1=1
                  AND SUBSTR(STRTDT, 0, 6) <![CDATA[<=]]> #{baseYm}
                  AND OG_TP_CD = 'W02'
                  AND QLF_DV_CD IN (3)
                  AND NVL(QLF_APLC_DV_CD, '0') IN ('1', '2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                  <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                       AND PRTNR_NO = #{prtnrNo}
                  </if>
                  AND DTA_DL_YN = 'N'

                GROUP BY PRTNR_NO
             ) T3
            ON T1.PRTNR_NO = T3.PRTNR_NO

          LEFT OUTER JOIN
             (
               SELECT STRTDT AS MNGR2_ATC /* 매니저 재개시월 */
                    , PRTNR_NO
                 FROM TB_OGPS_PLAR_QLF_CH_IZ
                WHERE 1=1
                  AND #{baseYm} BETWEEN SUBSTR(STRTDT, 0, 6) AND SUBSTR(ENDDT, 0, 6)
                  AND OG_TP_CD = 'W02'
                  AND QLF_DV_CD IN (3)
                  AND NVL(QLF_APLC_DV_CD, '0') IN ('1', '2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                  <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                       AND PRTNR_NO = #{prtnrNo}
                  </if>
                  AND DTA_DL_YN = 'N'

                UNION ALL

               SELECT STRTDT AS MNGR2_ATC /* 매니저 재개시월 */
                    , PRTNR_NO
                 FROM TB_OGPS_PLAR_QLF_CH_IZ
                WHERE 1=1
                  AND SUBSTR(STRTDT, 0, 6) = TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), 1), 'YYYYMM')
                  AND OG_TP_CD = 'W02'
                  AND QLF_DV_CD IN (3)
                  AND NVL(QLF_APLC_DV_CD, '0') IN ('1', '2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                  <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                       AND PRTNR_NO = #{prtnrNo}
                  </if>
                  AND DTA_DL_YN = 'N'
             ) T4
            ON T1.PRTNR_NO = T4.PRTNR_NO

          LEFT OUTER JOIN
             (
               SELECT MAX (ENDDT) AS MNGR3_ATC /* 매니저 최종해약월 */
                    , PRTNR_NO
                 FROM TB_OGPS_PLAR_QLF_CH_IZ
                WHERE 1=1
                  AND SUBSTR(ENDDT, 0, 6) <![CDATA[<=]]> #{baseYm}
                  AND OG_TP_CD = 'W02'
                  AND QLF_DV_CD IN (3)
                  AND NVL(QLF_APLC_DV_CD, '0') IN ('1', '2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                  <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                       AND PRTNR_NO = #{prtnrNo}
                  </if>
                  AND DTA_DL_YN = 'N'
                GROUP BY PRTNR_NO
             ) T5
            ON T1.PRTNR_NO = T5.PRTNR_NO

          LEFT OUTER JOIN
             (
               SELECT CASE WHEN MAX(ENDDT) = '99991231' THEN ''
                           ELSE MAX(ENDDT)
                      END AS MNGR4_ATC /* 매니저 업무해약월 */
                    , PRTNR_NO
                 FROM TB_OGPS_PLAR_QLF_CH_IZ
                WHERE 1=1
                  AND OG_TP_CD = 'W02'
                  AND QLF_DV_CD IN (3)
                  AND NVL(QLF_APLC_DV_CD, '0') IN ('1', '2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                  <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                       AND PRTNR_NO = #{prtnrNo}
                  </if>
                  AND DTA_DL_YN = 'N'
                GROUP BY PRTNR_NO
             ) T6
            ON T1.PRTNR_NO = T6.PRTNR_NO

          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ T7
            ON T1.PRTNR_NO = T7.PRTNR_NO
           AND T1.OG_TP_CD = T7.OG_TP_CD
           AND T7.BASE_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), 1),'YYYYMM')

          LEFT OUTER JOIN
             (
               SELECT B.PRTNR_NO
                    , MAX(B.EDU096) AS EDU096
                    , MAX(B.EDU143) AS EDU143
                 FROM
                    (
                      SELECT A.PRTNR_NO
                           , CASE WHEN A.EDUC_CRSE_NO = '96' THEN A.EDUC_CRSE_CRT_BASE_YM END AS EDU096
                           , CASE WHEN A.EDUC_CRSE_NO = '143' THEN A.EDUC_CRSE_CRT_BASE_YM END AS EDU143
                        FROM TB_PSCA_MCPTN_EDUC_IZ A
                       WHERE 1=1
                         AND A.EDUC_CRSE_CRT_BASE_YM = #{baseYm}
                         AND A.EDUC_CRSE_NO IN ('96','143')
                         AND A.EDUC_CPC_ACKMT_YN = 'Y'
                    ) B
                GROUP BY B.PRTNR_NO
             ) T8
            ON T1.PRTNR_NO = T8.PRTNR_NO
          LEFT OUTER JOIN TB_FEAM_WELS_MNGER_OPNG_BAS T9
            ON T1.BASE_YM  = T9.BASE_YM
           AND T1.OG_TP_CD = T9.OG_TP_CD
           AND T1.PRTNR_NO = T9.PRTNR_NO
           AND T9.TCNT_DV_CD = #{tcntDvCd}
         WHERE T1.BASE_YM = #{baseYm}
           AND T1.OG_TP_CD = 'W02'
           AND T1.QLF_DV_CD IN ('2','6','3')  /* 프리매니저, BS프리매니저, 웰스매니저 */

           <if test="prtnrNo != null and prtnrNo != ''">
               AND T1.PRTNR_NO = #{prtnrNo}
           </if>
           <if test="rsbDvCd != null and rsbDvCd != ''">
               AND T1.RSB_DV_CD = #{rsbDvCd}
           </if>
           <if test="prtnrKnm != null and prtnrKnm != ''">
               AND T1.PRTNR_KNM LIKE '%'||#{prtnrKnm}||'%'
           </if>

           <if test="divCd != null and divCd != ''">
               <if test="divCd == '01'">
                   AND T9.BASE_YM IS NOT NULL  /* 해당월 개시자 */
               </if>
               <if test="divCd == '02'">
                   AND SUBSTR(T1.CLTN_DT,0,6) = #{baseYm}  /* 해약자 */
               </if>
               <if test="divCd == '03'">
                   AND SUBSTR(T1.CLTN_DT,0,6) IS NULL /* 해약자 제외 */
               </if>
           </if>

         ORDER BY T2.DGR1_LEVL_OG_NM, T2.DGR2_LEVL_OG_NM, T9.OPNG_CD
    </select>

    <select id="selectCheckWelsMngerOpng"
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaWelsMngerSettlementAwDto$SearchEtcRes">
        SELECT CASE WHEN NVL(T1.NTOR_CNFM_STAT_CD, 'N') != 'N' THEN 'Y' ELSE 'N' END AS FEE_CNFM_YN  /* 수수료마감여부 */
             , CASE WHEN NVL(T2.CNFM_YN,'N') != 'N' THEN 'Y' ELSE 'N' END AS OPNG_CNFM_YN /* 개시구분 확정 여부 */
             , NVL(T2.OPNG_CNT,0) AS OPNG_CNFM_CNT           /* 개시구분 데이터 카운트 */
          FROM DUAL
          LEFT OUTER JOIN ( SELECT BASE_YM
                                 , NTOR_CNFM_STAT_CD
                              FROM TB_FEAM_NRCTR_MM_CL
                             WHERE BASE_YM = #{baseYm}
                               AND FEE_TCNT_DV_CD = #{tcntDvCd} /* 차수구분 코드 */
                               AND CNTR_PERF_CRT_DV_CD = '01'   /* 순주문 집계 */
                               AND NTOR_CNFM_STAT_CD = '02'     /* 확정 */
                               AND DTA_DL_YN = 'N'
                          ) T1
            ON 1 = 1
          LEFT OUTER JOIN ( SELECT BASE_YM
                                 , COUNT(*) AS OPNG_CNT
                                 , MAX(CNFM_STAT_YN) AS CNFM_YN
                              FROM ( SELECT BASE_YM
                                          , TCNT_DV_CD
                                          , CNFM_STAT_YN
                                       FROM TB_FEAM_WELS_MNGER_OPNG_BAS
                                      WHERE BASE_YM = #{baseYm}
                                        AND TCNT_DV_CD = #{tcntDvCd}      /* 차수구분 코드 */
                                   )
                             GROUP BY BASE_YM
                          ) T2
            ON 1 = 1
    </select>





    <insert id="insertWelsMngerOpng">
        INSERT INTO TB_FEAM_WELS_MNGER_OPNG_BAS
        ( BASE_YM
        , OG_TP_CD
        , PRTNR_NO
        , TCNT_DV_CD
        , OPNG_CD
        , PRGS_NMN_N
        , CNFM_STAT_YN
        <include refid="COMMON.insertSystemField" />
        )
        SELECT T1.BASE_YM
             , T1.OG_TP_CD
             , T1.PRTNR_NO
             , #{tcntDvCd}
             , NVL((CASE
                        WHEN WM.CNTR_DT IS NOT NULL AND
                             (CASE
                                  WHEN '202304' <![CDATA[<]]> SUBSTR(WM.CNTR_DT, 1, 6) THEN 0 /* 계약년월 2023 04월이전 = 0 */
                                  ELSE MONTHS_BETWEEN(TO_DATE('202304' || '01'), TO_DATE(SUBSTR(WM.CNTR_DT, 1, 6) || '01')) + 1 /* 계약년월 2023 04월이후 = 202304 - 계약년월 */
                              END) > 5 THEN '' /* 5 차월 초과자 */
                        WHEN NVL(A1.JJ_CNT, 0) != 0 THEN '' /* 지점장이상 경력자 */
                        WHEN WM.FNL_CLTN_DT IS NULL /* 최종해약일자 없음 */
                            AND NVL(B1.BSP_CNT, 0) = 0 /* 수석플래너 경력없음 */
                            THEN '1' /* 최초개시자 */
                        WHEN WM.FNL_CLTN_DT IS NULL /* 최종해약일자 없음 */
                            AND NVL(B1.BSP_CNT, 0) != 0 /* 수석플래너 경력있음 */
                            AND WM.M1_QLF_DV_CD = '6' /* 차월 BS프리매니저 */
                            THEN '1' /* 최초개시자(BS프리개시자) */
                        WHEN WM.FNL_CLTN_DT IS NULL /* 최종해약일자 없음 */
                            AND NVL(B1.BSP_CNT, 0) != 0 /* 수석플래너 경력있음 */
                            AND NVL(C1.JC_CNT, 0) = 0 /* 정착수수료 수령자 경력없음 */
                            AND WM.CNTR_DT > '20230401'
                            THEN '4' /* 최초개시 수석경력 (수석경력자 중 수석정착수당 미수령자 ) */
                        WHEN WM.FNL_CLTN_DT IS NULL /* 최종해약일자 없음 */
                            AND NVL(B1.BSP_CNT, 0) != 0 /* 수석플래너 경력있음 */
                            THEN '2' /* 수석플래너 경력자료 재개시자로 처리 */
                        WHEN WM.FNL_CLTN_DT IS NOT NULL
                            AND WM.CNTR_DT IS NOT NULL
                            AND MONTHS_BETWEEN(TO_DATE(SUBSTR(WM.CNTR_DT, 1, 6) || '01'), TO_DATE(SUBSTR(WM.FNL_CLTN_DT, 1, 6) || '01')) > 12 /* 계약년월-최종해약년월 = 12 이상*/
                            AND WM.M1_QLF_DV_CD = '3' /* 차월 웰스매니저 */
                            THEN '3' /* 해약 13개월후 재개시자는 재개시자로 처리 */
                        ELSE ''
                    END), ''
               ) AS OPNG_CD
             , CASE WHEN NVL(D1.PYD,0) != '0'
                         AND MONTHS_BETWEEN(TO_DATE(#{baseYm},'YYYYMM'), TO_DATE(D1.PYD,'YYYYMM')) <![CDATA[>=]]> 0
                         THEN MONTHS_BETWEEN(TO_DATE(#{baseYm},'YYYYMM'), TO_DATE(D1.PYD,'YYYYMM')) + 1
                    ELSE 0
               END AS PRGS_NMN_N
             , 'N'
        <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_OGBS_MM_PRTNR_IZ T1    /* 월 파트너*/
          LEFT OUTER JOIN (
                 <include refid="selectPlarQlf"/>
               ) WM
            ON WM.OG_TP_CD = T1.OG_TP_CD
           AND WM.PRTNR_NO = T1.PRTNR_NO
          LEFT OUTER JOIN ( SELECT PRTNR_NO
                                 , COUNT(1) AS ASP_CNT
                              FROM TB_OGPS_TOPMR_PLAR_APLC_IZ
                             WHERE OG_TP_CD = 'W02'
                               AND MNGT_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), 1),'YYYYMM')            /*관리년월 = 기준년월+1*/
                               AND UPGR_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), 1),'YYYYMM')            /*승급년월 = 기준년월+1*/
                               AND UPGR_DMTN_DV_CD = '1'  /*승급강등구분코드 = 1: 승급 */
                             GROUP BY PRTNR_NO
                          ) AK06 /* 익월 수석플래너 대상자 조회 */
            ON T1.PRTNR_NO = AK06.PRTNR_NO
          LEFT OUTER JOIN (
                  SELECT PRTNR_NO
                       , COUNT(1) AS JJ_CNT
                    FROM TB_OGBS_MM_PRTNR_IZ
                   WHERE OG_TP_CD = 'W02'
                     AND BASE_YM <![CDATA[<=]]> #{baseYm} /*관리년월 = 기준년월 이하*/
                     AND PSTN_DV_CD <![CDATA[<=]]> 7 /* 직급 7급 이상 */
                   GROUP BY PRTNR_NO
                ) A1 /* 지점장 이상 경력자 체크 */
            ON T1.PRTNR_NO = A1.PRTNR_NO
          LEFT OUTER JOIN (
                  SELECT PRTNR_NO
                       , COUNT(1) AS BSP_CNT
                    FROM TB_OGPS_PLAR_QLF_CH_IZ
                   WHERE OG_TP_CD = 'W02'
                     AND QLF_DV_CD = '1'
                     AND NVL(ENDDT,'99991231') <![CDATA[<=]]> #{baseYm}
                     AND DTA_DL_YN = 'N'
                     AND QLF_APLC_DV_CD IN ('1','2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                   GROUP BY PRTNR_NO
               )B1  /* 수석플래너 경력자 체크 */
            ON T1.PRTNR_NO = B1.PRTNR_NO
          LEFT OUTER JOIN (
                  SELECT CB.PRTNR_NO
                       , COUNT(1) AS JC_CNT
                    FROM TB_FEAM_FEE_CALC_BAS CB
                   INNER JOIN TB_OGPS_PLAR_QLF_CH_IZ QCI
                      ON QCI.OG_TP_CD = CB.OG_TP_CD
                     AND QCI.QLF_DV_CD = '1'
                     AND CB.BASE_YM BETWEEN SUBSTR(QCI.STRTDT,1,6) AND SUBSTR(QCI.ENDDT,1,6)
                     AND QCI.DTA_DL_YN = 'N'
                     AND QCI.QLF_APLC_DV_CD IN ('1','2')
                     AND QCI.PRTNR_NO = CB.PRTNR_NO
                   WHERE 1 = 1
                     AND CB.FEE_CD IN ('W020081','W020080')
                     AND CB.BASE_YM = CB.PERF_YM
                     AND CB.OG_TP_CD = 'W02'
                     AND CB.FEE_TCNT_DV_CD = '02'
                     AND CB.OJ_DSB_YM >= '201904'
                     AND CB.FEE_CTR_CNFM_AMT > 0
                   GROUP BY CB.PRTNR_NO
               ) C1  /* 정착수수료 수령자 */
            ON T1.PRTNR_NO = C1.PRTNR_NO
          LEFT OUTER JOIN (
                  SELECT SUBSTR(MAX(A.CV_DT), 1, 6) AS PYD
                       , A.PRTNR_NO
                    FROM TB_OGPS_PLAR_QLF_CH_IZ A /*플래너 자격 변경내역*/
                   WHERE A.OG_TP_CD = 'W02'
                     AND A.QLF_DV_CD = '3' /* 웰스매니저 */
                     AND A.QLF_APLC_DV_CD = '1' /* 승급 */
                     AND A.DTA_DL_YN = 'N'
                   GROUP BY A.PRTNR_NO
               ) D1
            ON T1.PRTNR_NO = D1.PRTNR_NO
         WHERE T1.BASE_YM = #{baseYm}
           AND T1.OG_TP_CD = 'W02'
           AND T1.QLF_DV_CD IN ('2','6','3')  /* 프리매니저, BS프리매니저, 웰스매니저 */
           AND NVL(SUBSTR(WM.CLTN_DT,0,6),'999912') <![CDATA[>=]]> #{baseYm}  /* 해약년월 기준년월 이상 */
           AND SUBSTR(WM.CNTR_DT,0,6) <![CDATA[<=]]> TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), 1),'YYYYMM') /* 계약년월 기준년월+1월(익월) 이하 */
           AND ( CASE WHEN #{baseYm} <![CDATA[<]]> SUBSTR(WM.CNTR_DT,0,6) THEN 0  /* 기준년월이 계약년월 이전이면 0 */
                      ELSE MONTHS_BETWEEN(TO_DATE(#{baseYm}||'01'), TO_DATE(SUBSTR(WM.CNTR_DT,0,6)||'01')) + 1
                 END
               ) <![CDATA[<=]]> 5  /* 개시차월 (기준년월 - 계약년월+1) 이 5개월 이하 */
           AND ( WM.BZ_STAT_CD = 'Y' /* 활동여부 Y */
                 OR WM.BZ_STAT_CD != 'Y' /* 활동여부 N */
                 AND ( NVL(SUBSTR(WM.CLTN_DT,0,6),'999912')  <![CDATA[>]]> #{baseYm} /* 해약년월 기준일자 이상*/
                       OR NVL(AK06.ASP_CNT,0) != 0 /* 익월 수석플래너 대상자 */
                     )
               )
           AND NOT EXISTS ( SELECT 1
                              FROM TB_FEAM_WELS_MNGER_OPNG_BAS X
                             WHERE X.PRTNR_NO = T1.PRTNR_NO
                               AND X.BASE_YM = #{baseYm}
                               AND TCNT_DV_CD = #{tcntDvCd}
                          ) /* 기 입력자 제외 AS-IS 확정=Y 였으나 DB구조상 조건 제외*/
    </insert>

    <delete id="deleteWelsMngerOpng">
        DELETE FROM TB_FEAM_WELS_MNGER_OPNG_BAS
         WHERE BASE_YM = #{baseYm}
           AND TCNT_DV_CD = #{tcntDvCd}
    </delete>

    <update id="updateWelsMnger">
        UPDATE TB_FEAM_WELS_MNGER_OPNG_BAS
           SET OPNG_CD = CASE WHEN #{opngCd} = '9' THEN '' ELSE #{opngCd} END
        <include refid="COMMON.updateSystemField"/>
         WHERE BASE_YM = #{baseYm}
           AND TCNT_DV_CD = #{tcntDvCd}
           AND PRTNR_NO = #{prtnrNo}
    </update>

    <update id="updateWelsMngerConfirm">
        UPDATE TB_FEAM_WELS_MNGER_OPNG_BAS
           SET CNFM_STAT_YN = #{cnfmStatYn}
        <include refid="COMMON.updateSystemField"/>
         WHERE BASE_YM = #{baseYm}
           AND TCNT_DV_CD = #{tcntDvCd}
    </update>

</mapper>
