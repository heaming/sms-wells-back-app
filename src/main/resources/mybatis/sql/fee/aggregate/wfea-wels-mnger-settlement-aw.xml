<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.aggregate.mapper.WfeaWelsMngerSettlementAwMapper">

    <select id='selectWelsMngers'
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaWelsMngerSettlementAwDto$SearchRes">
        SELECT T2.DGR1_LEVL_OG_NM AS OG1_NM /* 총괄단 */
             , T2.DGR2_LEVL_OG_NM AS OG2_NM  /* 지역단 */
             , T1.OG_ID  /* 소속 */
             , T2.BLD_NM     /* 빌딩명 */
             , T1.PRTNR_NO  /* 번호 */
             , T1.PRTNR_KNM  /* 성명 */
             , CD.CD_CNTN AS RSB_DV_CD  /* 직책 */
             , CASE WHEN T1.QLF_DV_CD = '2' THEN '프리매니저'
                    WHEN T1.QLF_DV_CD = '3' THEN '웰스매니저'
                    WHEN T1.QLF_DV_CD = '6' THEN 'BS프리매니저'
               END AS QLF_DV_CD
             , CASE WHEN T4.QLF_DV_CD = '2' THEN '프리매니저'
                    WHEN T4.QLF_DV_CD = '3' THEN '웰스매니저'
                    WHEN T4.QLF_DV_CD = '6' THEN 'BS프리매니저'
               END AS NEXT_QLF_DV_CD /* M+1자격 */
             , T3.PYM AS PROCS_DTM   /* WM전환월 */
             , T5.EDU096  AS SRTUP /* 스타트업 */
             , T5.EDU143  AS FREE_SRTUP /* 프리스타트업 */
             , CASE WHEN T1.BZ_STAT_CD = '1' THEN 'Y' /* 사업상태코드 = 1 사업 */
                    ELSE 'N'                          /* 사업상태코드 = (2,3) 해약, 휴업 */
               END AS BZ_STAT_CD  /* 활동여부 */
             , T1.CNTR_DT /* 계약일 */
             , T1.CLTN_DT/* 해약일 */
             , T1.FST_CNTR_DT /* 최초계약일 */
             , T1.FNL_CLTN_DT/* 최종해약일 */
             , NVL(T6.OPNG_CD,'5') AS OPNG_CD
             , T1.BASE_YM
             , T6.TCNT_DV_CD
             , NVL(T6.CNFM_STAT_YN,'X') AS CNFM_STAT_YN
          FROM TB_OGBS_MM_PRTNR_IZ T1  /* 월 파트너*/
         INNER JOIN TB_OGBS_MM_OG_IZ T2  /* 월 조직 */
            ON T1.OG_ID = T2.OG_ID
           AND T1.OG_TP_CD = T2.OG_TP_CD
           AND T1.BASE_YM = T2.BASE_YM
        INNER JOIN T_CMZ_CD_D CD
           ON T1.RSB_DV_CD = CD.CD_VLD_VAL
          AND CD.CD_ID = 'RSB_DV_CD'
          AND CD.TENANT_ID = 'TNT_WELLS'
        LEFT OUTER JOIN ( SELECT ROW_NUMBER() OVER (PARTITION BY PRTNR_NO ORDER BY CV_DT DESC) AS RANK
                               , SUBSTR(CV_DT,0,6) AS PYM
                               , PRTNR_NO
                            FROM TB_OGPS_PLAR_QLF_CH_IZ /*플래너 자격 변경내역*/
                           WHERE OG_TP_CD = 'W02'
                             AND QLF_DV_CD = '3'  /* 웰스매니저 */
                             AND QLF_APLC_DV_CD = '1'  /* 승급 */
                             AND DTA_DL_YN = 'N'
                        )T3
            ON T1.PRTNR_NO = T3.PRTNR_NO
           AND T3.RANK = 1
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ T4
            ON T1.PRTNR_NO = T4.PRTNR_NO
           AND T1.OG_TP_CD = T4.OG_TP_CD
           AND T4.BASE_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), 1),'YYYYMM')
          LEFT OUTER JOIN ( SELECT B.PRTNR_NO
                                 , MAX(B.EDU096) AS EDU096
                                 , MAX(B.EDU143) AS EDU143
                              FROM ( SELECT A.PRTNR_NO
                                          , CASE WHEN A.EDUC_CRSE_NO = '96' THEN A.AGRG_YM END AS EDU096
                                          , CASE WHEN A.EDUC_CRSE_NO = '143' THEN A.AGRG_YM END AS EDU143
                                       FROM TB_PSCA_MCPTN_EDUC_AGRG A
                                      WHERE A.AGRG_YM = #{baseYm}
                                        AND A.EDUC_CRSE_NO IN ('96','143')
                                        AND A.EDUC_CPC_ACKMT_YN = 'Y'
                                        AND A.PSTN_DV_CD = '15'
                                   ) B
                                     GROUP BY B.PRTNR_NO
                           ) T5
            ON T1.PRTNR_NO = T5.PRTNR_NO
          LEFT OUTER JOIN TB_FEAM_WELS_MNGER_OPNG_BAS T6
            ON T1.BASE_YM  = T6.BASE_YM
           AND T1.OG_TP_CD = T6.OG_TP_CD
           AND T1.PRTNR_NO = T6.PRTNR_NO
           AND T6.TCNT_DV_CD = #{tcntDvCd}
         WHERE T1.BASE_YM = #{baseYm}
           AND T1.OG_TP_CD = 'W02'
           AND T1.QLF_DV_CD IN ('2','6','3')  /* 프리매니저, BS프리매니저, 웰스매니저 */
      <if test="prtnrNo != null and prtnrNo != ''">
           AND T1.PRTNR_NO = #{prtnrNo}
      </if>
      <if test="schRsbDvCd != null and schRsbDvCd != ''">
           AND T1.RSB_DV_CD = #{schRsbDvCd}
      </if>
      <if test="prtnrKnm != null and prtnrKnm != ''">
           AND T1.PRTNR_KNM LIKE '%'||#{prtnrKnm}||'%'
      </if>
      <if test="schDiv != null and schDiv != ''">
           <if test="schDiv == '01'">
           AND T6.BASE_YM IS NOT NULL  /* 해당월 개시자 */
           </if>
           <if test="schDiv == '02'">
           AND SUBSTR(T1.CLTN_DT,0,6) = #{baseYm}  /* 해약자 */
           </if>
           <if test="schDiv == '03'">
           AND SUBSTR(T1.CLTN_DT,0,6) IS NULL /* 해약자 제외 */
           </if>
      </if>
         ORDER BY T2.DGR1_LEVL_OG_NM
                , T2.DGR2_LEVL_OG_NM
                , T1.OG_ID
                , T1.PRTNR_KNM
    </select>

    <select id="selectCheckWelsMngerOpng"
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaWelsMngerSettlementAwDto$SearchEtcRes">
        SELECT NVL(T1.NTOR_CNFM_STAT_CD,'N') AS FEE_CNFM_YN  /* 수수료마감여부 */
             , CASE WHEN NVL(T2.CNFM_YN,'N')!= 'N' THEN 'Y' ELSE 'N' END AS OPNG_CNFM_YN /* 개시구분 확정 여부 */
             , NVL(T2.OPNG_CNT,0) AS OPNG_CNFM_CNT           /* 개시구분 데이터 카운트 */
          FROM DUAL
          LEFT OUTER JOIN ( SELECT BASE_YM
                                 , NTOR_CNFM_STAT_CD
                              FROM TB_FEAM_WELS_NRCTR_MM_CL
                             WHERE BASE_YM = #{baseYm}
                               AND CNTR_PERF_CRT_DV_CD = '01'  /*순주문 집계*/
                               AND OG_TP_CD = 'W02'            /* M조직 */
                               AND NTOR_CNFM_STAT_CD = '02'    /* 확정 */
                               AND DTA_DL_YN = 'N'
                             GROUP BY BASE_YM, NTOR_CNFM_STAT_CD
                          )T1
            ON 1 = 1
          LEFT OUTER JOIN ( SELECT BASE_YM
                                 , COUNT(*) AS OPNG_CNT
                                 , MAX(CNFM_STAT_YN) AS CNFM_YN
                              FROM ( SELECT BASE_YM
                                          , TCNT_DV_CD
                                          , CNFM_STAT_YN
                                       FROM TB_FEAM_WELS_MNGER_OPNG_BAS
                                      WHERE BASE_YM = #{baseYm}
                                        AND TCNT_DV_CD = #{tcntDvCd}      /* 차수구분 코드 */
                                      GROUP BY BASE_YM, TCNT_DV_CD, CNFM_STAT_YN
                                   )
                             GROUP BY BASE_YM
                          )T2
            ON 1 = 1
    </select>





    <insert id="insertWelsMngerOpng">
        INSERT INTO TB_FEAM_WELS_MNGER_OPNG_BAS
        ( BASE_YM
        , OG_TP_CD
        , PRTNR_NO
        , TCNT_DV_CD
        , OPNG_CD
        , CNFM_STAT_YN
        <include refid="COMMON.insertSystemField" />
        )
        SELECT T1.BASE_YM
             , T1.OG_TP_CD
             , T1.PRTNR_NO
             , #{tcntDvCd}
             , NVL( ( CASE WHEN ( CASE WHEN '202304' &lt; SUBSTR(CNTR_DT,0,6) THEN 0                           /* 계약년월 2023 04월이전 = 0 */
                                       ELSE MONTHS_BETWEEN(TO_DATE('202304'||'01'),TO_DATE(SUBSTR(CNTR_DT,0,6)||'01'))+1   /* 계약년월 2023 04월이후 = 202304 - 계약년월 */
                                  END
                                ) &gt; 5 THEN '' /* 5 차월 초과자 */
                           WHEN NVL(A1.JJ_CNT,0) != 0 THEN '' /* 지점장이상 경력자 */
                           WHEN NVL(T1.FNL_CLTN_DT,0) = 0 /* 최종해약일자 없음 */
                                AND NVL(B1.BSP_CNT,0) = 0  /* 수석플래너 경력없음 */
                                THEN '1' /* 최초개시자 */
                           WHEN NVL(B1.BSP_CNT,0) != 0  /* 수석플래너 경력있음 */
                                AND NVL(C1.JC_CNT,0) = 0  /* 정착수수료 수령자 경력없음 */
                                AND MONTHS_BETWEEN(TO_DATE(SUBSTR(CNTR_DT,0,6)||'01'),TO_DATE(SUBSTR(FNL_CLTN_DT,0,6)||'01')) &lt;= 12  /* 계약년월-최종해약년월 12 이하*/
                                THEN '4'  /* 최초개시 수석경력 (수석경력자 중 수석정착수당 미수령자 ) */
                           WHEN NVL(T1.FNL_CLTN_DT,0) = 0 /* 최종해약일자 없음 */
                                AND NVL(B1.BSP_CNT,0) != 0  /* 수석플래너 경력있음 */
                                THEN '2' /* 수석플래너 경력자료 재개시자로 처리 */
                           WHEN MONTHS_BETWEEN(TO_DATE(SUBSTR(CNTR_DT,0,6)||'01'),TO_DATE(SUBSTR(FNL_CLTN_DT,0,6)||'01')) &gt; 12  /* 계약년월-최종해약년월 = 12 이상*/
                                THEN '3' /* 해약 13개월후 재개시자는 재개시자로 처리 */
                           ELSE ''
                      END
                    ),''
                  )
             , 'N'
        <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_OGBS_MM_PRTNR_IZ T1    /* 월 파트너*/
          LEFT OUTER JOIN ( SELECT APLCNS_PRTNR_NO AS PRTNR_NO
                                         , COUNT(1) AS ASP_CNT
                                      FROM TB_OGPS_TOPMR_PLAR_APLC_IZ
                                     WHERE APLCNS_OG_TP_CD = 'W02'
                                       AND MNGT_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), 1),'YYYYMM')            /*관리년월 = 기준년월+1*/
                                       AND UPGR_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), 1),'YYYYMM')            /*승급년월 = 기준년월+1*/
                                       AND TOPMR_PLAR_APLC_STAT_CD = '01' /*수석플래너신청상태코드 = '정상신청' 현재 확인되지 않아 임시!!*/
                                       AND UPGR_DMTN_DV_CD = '01'  /*승급강등구분코드 = '승급' 현재 확인되지 않아 임시!!*/
                                       AND UPGR_DMTN_CNFM_YN = 'Y' /*승급강등확정여부 = 'Y' 현재 확인되지 않아 임시!!*/
                                     GROUP BY APLCNS_PRTNR_NO
                                  )AK06 /* 익월 수석플래너 대상자 조회 */
            ON T1.PRTNR_NO = AK06.PRTNR_NO
          LEFT OUTER JOIN ( SELECT PRTNR_NO
                                         , COUNT(1) AS JJ_CNT
                                      FROM TB_OGBS_MM_PRTNR_IZ
                                     WHERE OG_TP_CD = 'W02'
                                       AND BASE_YM &lt;= #{baseYm}         /*관리년월 = 기준년월 이하*/
                                       AND PSTN_DV_CD &lt;= 7              /* 직급 7급 이상 */
                                     GROUP BY PRTNR_NO
                                  )A1   /* 지점장 이상 경력자 체크 */
            ON T1.PRTNR_NO = A1.PRTNR_NO
          LEFT OUTER JOIN ( SELECT APLCNS_PRTNR_NO AS PRTNR_NO
                                         , COUNT(1) AS BSP_CNT
                                      FROM TB_OGPS_TOPMR_PLAR_APLC_IZ
                                     WHERE APLCNS_OG_TP_CD = 'W02'
                                       AND MNGT_YM &lt;= #{baseYm}            /*관리년월 = 기준년월 이하*/
                                       AND TOPMR_PLAR_APLC_STAT_CD = '01' /*수석플래너신청상태코드 = '정상신청' 현재 확인되지 않아 임시!!*/
                                       AND UPGR_DMTN_DV_CD = '01'  /*승급강등구분코드 = '승급' 현재 확인되지 않아 임시!!*/
                                       AND UPGR_DMTN_CNFM_YN = 'Y' /*승급강등확정여부 = 'Y' 현재 확인되지 않아 임시!!*/
                                     GROUP BY APLCNS_PRTNR_NO
                                  )B1  /* 수석플래너 경력자 체크 */
            ON T1.PRTNR_NO = B1.PRTNR_NO
          LEFT OUTER JOIN ( SELECT PRTNR_NO
                                         , COUNT(1) AS JC_CNT
                                      FROM TB_FEAM_WPTN_SV_PERF_AGRG
                                     WHERE OG_TP_CD = 'W02'
                                       AND BASE_YM  &gt;= '201904'
                                       AND CL_DV_CD = '02'
                                       AND PRTNR_SV_PERF_ATC_CD = 'SV03050101'
                                     GROUP BY PRTNR_NO
                                  )C1  /* 정착수수료 수령자 */
            ON T1.PRTNR_NO = C1.PRTNR_NO
         WHERE T1.BASE_YM = #{baseYm}
           AND T1.OG_TP_CD = 'W02'
           AND T1.QLF_DV_CD IN ('2','6','3')  /* 프리매니저, BS프리매니저, 웰스매니저 */
           AND SUBSTR(T1.CLTN_DT,0,6) &gt;= #{baseYm}  /* 해약년월 기준년월 이상 */
           AND SUBSTR(T1.CNTR_DT,0,6) &lt;= TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), 1),'YYYYMM') /* 계약년월 기준년월+1월(익월) 이하 */
           AND ( CASE WHEN #{baseYm} &lt; SUBSTR(T1.CLTN_DT,0,6) THEN 0  /* 기준년월이 계약년월 이전이면 0 */
                      ELSE MONTHS_BETWEEN(TO_DATE(#{baseYm}||'01'), TO_DATE(SUBSTR(T1.CNTR_DT,0,6)||'01')) + 1
                 END
               ) &lt;= 5  /* 개시차월 (기준년월 - 계약년월+1) 이 5개월 이하 */
           AND ( T1.BZ_STAT_CD = '1' /* 활동여부 Y */
                 OR T1.BZ_STAT_CD != '1' /* 활동여부 N */
                 AND ( SUBSTR(T1.CLTN_DT,0,6)  &gt; #{baseYm} /* 해약년월 기준일자 이상*/
                       OR NVL(AK06.ASP_CNT,0) != 0 /* 익월 수석플래너 대상자 */
                     )
               )
           AND NOT EXISTS ( SELECT 1
                              FROM TB_FEAM_WELS_MNGER_OPNG_BAS X
                             WHERE X.PRTNR_NO = T1.PRTNR_NO
                               AND X.BASE_YM = #{baseYm}
                               AND TCNT_DV_CD = #{tcntDvCd}
                          ) /* 기 입력자 제외 AS-IS 확정=Y 였으나 DB구조상 조건 제외*/
    </insert>

    <update id="updateWelsMnger">
        UPDATE TB_FEAM_WELS_MNGER_OPNG_BAS
        SET OPNG_CD = #{opngCd}
        <include refid="COMMON.updateSystemField"/>
        WHERE BASE_YM = #{baseYm}
          AND TCNT_DV_CD = #{tcntDvCd}
          AND PRTNR_NO = #{prtnrNo}
    </update>

    <update id="updateWelsMngerConfirm">
        UPDATE TB_FEAM_WELS_MNGER_OPNG_BAS
           SET CNFM_STAT_YN = #{cnfmStatYn}
        <include refid="COMMON.updateSystemField"/>
         WHERE BASE_YM = #{baseYm}
           AND TCNT_DV_CD = #{tcntDvCd}
    </update>

</mapper>
