<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.aggregate.mapper.WfeaNetOrderMapper">

    <select id='selectNetOrders' resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaNetOrderDto$SearchRes">
        SELECT T1.OG_TP_CD AS SELL_OG
             , T1.OG_ID AS BLG
             , T1.PRTNR_NO
             , T1.PRTNR_KNM
             , T2.SELL_TP_CD
             , CASE WHEN T1.OG_TP_CD = 'W01' THEN T5.FEE_PDCT_TP_CD2
                    ELSE T5.FEE_PDCT_TP_CD1
               END AS PDCT_TP /* 제품유형 !!!*/
             , T2.CNTR_DTL_NO
             , T1.COPN_DV_CD AS CST_DV
             , T3.PD_NM AS PRDT_NM
             , T2.PRDT_CD
             , T3.HGR_PD_CD AS PKG_CD
             , T2.ISTM
             , CASE WHEN T2.SELL_TP_CD = '1' THEN 0 /* 일시불 = 0 */
                    WHEN T2.RSTL_YN = 'Y' THEN 0 /* 재약정 = '' */
                    ELSE T2.STPL_PTRM
               END AS STPL_MCNT
             , SUBSTR(T2.CNTR_DATE,0,6) AS CNTR_DATE
             , SUBSTR(T2.SL_DT,0,6) AS SL_DT
             , SUBSTR(T2.CAN_DT,0,6) AS CAN_DT
             , SUBSTR(T4.REQD_DT,0,6) AS DEM_DT
             , T2.RTLFE
          FROM TB_OGBS_MM_PRTNR_IZ T1  /* 월파트너 */
         INNER JOIN TB_OGBS_MM_OG_IZ OG
            ON T1.BASE_YM = OG.BASE_YM
           AND T1.OG_ID = OG.OG_ID
           AND T1.OG_TP_CD = OG.OG_TP_CD
      <if test='@MybatisUtils@isNotEmpty(ogLevl1Id)'>
           AND OG.DGR1_LEVL_OG_ID = #{ogLevl1Id}
      </if>
      <if test='@MybatisUtils@isNotEmpty(ogLevl2Id)'>
           AND OG.DGR2_LEVL_OG_ID = #{ogLevl2Id}
      </if>
      <if test='@MybatisUtils@isNotEmpty(ogLevl3Id)'>
           AND OG.DGR3_LEVL_OG_ID = #{ogLevl3Id}
      </if>
         INNER JOIN ( SELECT CD.CNTR_SN     /* 재약정 제외 목록*/
                           , CB.SELL_OG_TP_CD AS OG_TP_CD
                           , CB.SELL_PRTNR_NO AS PRTNR_NO
                           , CD.SELL_TP_CD
                           , CD.CNTR_NO AS CNTR_DTL_NO
                           , CD.BASE_PD_CD AS PRDT_CD
                           , CD.ISTM_MCN AS ISTM
                           , CB.CNTR_CNFM_DTM AS CNTR_DATE
                           , SC.SL_RCOG_DT AS SL_DT
                           , CB.CNTR_CAN_DTM AS CAN_DT
                           , CASE WHEN CD.SELL_TP_CD = '2' THEN CD.SELL_AMT END AS RTLFE  /* 계약유형이 렌탈일때만 렌탈료 */
                           , 'N' AS RSTL_YN
                           , CD.STPL_PTRM
                        FROM TB_SSCT_CNTR_BAS CB
                       INNER JOIN TB_SSCT_CNTR_DTL CD
                          ON CB.CNTR_NO = CD.CNTR_NO
                         AND NOT EXISTS (SELECT 1 FROM TB_SSCT_RENTAL_RSTL_IZ X WHERE X.CNTR_NO = CD.CNTR_NO AND CD.CNTR_SN = CD.CNTR_SN ) /*재약정 제외*/
                    <if test='@MybatisUtils@equals(divCd, "02")'> /* 예약 */
                         AND CD.BOO_SELL_TP_CD = '2'
                    </if>
                    <if test='@MybatisUtils@equals(DivCd, "03")'> /* 매출 */
                         AND NVL(CD.BOO_SELL_TP_CD,0) != '2'
                    </if>
                    <if test='@MybatisUtils@isNotEmpty (selTpCd)'>
                        <if test='!@MybatisUtils@equals(selTpCd, "7")'>
                         AND CD.SELL_TP_CD = #{selTpCd}
                        </if>
                        <if test='@MybatisUtils@equals(selTpCd, "7")'>
                         AND 1 = #{selTpCd}
                        </if>
                    </if>
                    <if test='@MybatisUtils@equals(divCd, "01") or @MybatisUtils@equals(divCd, "02")'>
                        LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC   /*T WELLS매출확정기본 T*/
                          ON CD.CNTR_NO = SC.CNTR_NO
                         AND CD.CNTR_SN = SC.CNTR_SN
                         AND CB.SELL_OG_TP_CD = SC.OG_TP_CD
                       WHERE 1 = 1
                         AND CB.CNTR_CNFM_DTM BETWEEN #{strtDt} AND  #{endDt} /* 계약 확정일자*/
                    </if>
                    <if test='@MybatisUtils@equals(divCd, "03")'>   /* 매출 */
                       INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC   /*T WELLS매출확정기본 T*/
                          ON CD.CNTR_NO = SC.CNTR_NO
                         AND CD.CNTR_SN = SC.CNTR_SN
                         AND CB.SELL_OG_TP_CD = SC.OG_TP_CD
                         AND SC.SL_RCOG_DT BETWEEN #{strtDt} AND #{endDt}  /* 매출 확정일자 */
                       WHERE 1=1
                    </if>
                    <if test='@MybatisUtils@isNotEmpty(cancStrtDt)'>
                         AND CB.CNTR_CAN_DTM &gt;= #{cancStrtDt}                /* 계약취소 시작일자 */
                    </if>
                    <if test='@MybatisUtils@isNotEmpty(cancEndDt)'>
                         AND CB.CNTR_CAN_DTM &lt;= #{cancEndDt}  /* 계약취소 종료일자 */
                    </if>
                    <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                         AND CB.SELL_PRTNR_NO  = #{prtnrNo}
                    </if>
                    <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
                        <if test='!@MybatisUtils@equals(ogDvCd, "W06")'>
                         AND CB.SELL_OG_TP_CD  = #{ogDvCd}
                        </if>
                        <if test='@MybatisUtils@equals(ogDvCd, "W06")'>
                         AND CB.SELL_OG_TP_CD NOT IN ('W01','W02','W03','W04','W05')
                        </if>
                    </if>
                    <if test='@MybatisUtils@isEmpty(selTpCd) or @MybatisUtils@equals(selTpCd, "7")'>
                       UNION ALL     /* 판매구분이 전체 혹은 재약정일때 UNION ALL 재약정 */
                      SELECT CD.CNTR_SN
                           , CB.SELL_OG_TP_CD AS OG_TP_CD
                           , CB.SELL_PRTNR_NO AS PRTNR_NO
                           , CD.SELL_TP_CD
                           , CD.CNTR_NO AS CNTR_DTL_NO
                           , CD.BASE_PD_CD AS PRDT_CD
                           , CD.ISTM_MCN AS ISTM
                           , RI.STPL_STRTDT AS CNTR_DATE
                           , SC.SL_RCOG_DT AS SL_DT
                           , RI.STPL_CAN_DTM AS CAN_DT
                           , CD.SELL_AMT AS RTLFE
                           , 'Y' AS RSTL_YN
                           , CD.STPL_PTRM
                        FROM TB_SSCT_CNTR_BAS CB
                       INNER JOIN TB_SSCT_CNTR_DTL CD
                          ON CB.CNTR_NO = CD.CNTR_NO
                         AND CD.SELL_TP_CD = '2'     /* 렌탈 */
                         <if test='@MybatisUtils@equals(divCd, "02")'> /* 예약 */
                         AND CD.BOO_SELL_TP_CD = '2'
                         </if>
                         <if test='@MybatisUtils@equals(divCd, "03")'> /* 매출 */
                         AND NVL(CD.BOO_SELL_TP_CD,0) != '2'
                         </if>
                       INNER JOIN TB_SSCT_RENTAL_RSTL_IZ RI /* 재약정내역 테이블 */
                          ON CD.CNTR_NO = RI.CNTR_NO
                         AND CD.CNTR_SN = RI.CNTR_SN
                         <if test='@MybatisUtils@isNotEmpty(cancStrtDt)'>
                         AND RI.STPL_CAN_DTM &gt;= #{cancStrtDt}                /* 약정취소 시작일자 */
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(cancEndDt)'>
                         AND RI.STPL_CAN_DTM &lt;= #{cancEndDt}  /* 약정취소 종료일자 */
                         </if>
                         <if test='@MybatisUtils@equals(divCd, "01") or @MybatisUtils@equals(divCd, "02")'>
                         AND RI.STPL_STRTDT BETWEEN #{strtDt} AND  #{endDt} /* 약정 시작일자*/
                        LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC   /*T WELLS매출확정기본 T*/
                          ON CD.CNTR_NO = SC.CNTR_NO
                         AND CD.CNTR_SN = SC.CNTR_SN
                         AND CB.SELL_OG_TP_CD = SC.OG_TP_CD
                       WHERE 1 = 1
                         </if>
                         <if test='@MybatisUtils@equals(divCd, "03")'>    /* 매출 */
                       INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC   /*T WELLS매출확정기본 T*/
                          ON CD.CNTR_NO = SC.CNTR_NO
                         AND CD.CNTR_SN = SC.CNTR_SN
                         AND CB.SELL_OG_TP_CD = SC.OG_TP_CD
                         AND SC.SL_RCOG_DT BETWEEN #{strtDt} AND #{endDt}  /* 매출 확정일자 */
                       WHERE 1=1
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                         AND CB.SELL_PRTNR_NO  = #{prtnrNo}
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
                             <if test="ogDvCd != 'W06'">
                         AND CB.SELL_OG_TP_CD  = #{ogDvCd}
                             </if>
                             <if test='@MybatisUtils@equals(ogDvCd, "W06")'>
                         AND CB.SELL_OG_TP_CD NOT IN ('W01','W02','W03','W04','W05')
                             </if>
                         </if>
                    </if>
                    )T2
            ON T1.PRTNR_NO = T2.PRTNR_NO
           AND T1.OG_TP_CD = T2.OG_TP_CD
         INNER JOIN TB_PDBS_PD_BAS T3
            ON T2.PRDT_CD = T3.PD_CD
      <if test='@MybatisUtils@isNotEmpty(pdStrtCd)'>
           AND T3.PD_CD &gt;= #{pdStrtCd}
      </if>
      <if test='@MybatisUtils@isNotEmpty(pdEndCd)'>
           AND T3.PD_CD &lt;= #{pdEndCd}
      </if>
      <if test='@MybatisUtils@isNotEmpty(pkgStrtCd)'>
           AND T3.HGR_PD_CD &gt;= #{pkgStrtCd}
      </if>
      <if test='@MybatisUtils@isNotEmpty(pkgEndCd)'>
           AND T3.HGR_PD_CD &lt;= #{pkgEndCd}
      </if>
         INNER JOIN TB_SSCT_CNTR_WELLS_DTL T4
            ON T2.CNTR_DTL_NO = T4.CNTR_NO
           AND T2.CNTR_SN = T4.CNTR_SN
        INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T5
           ON T2.PRDT_CD = T5.BASE_PD_CD
          AND SUBSTR(#{strtDt},0,6) BETWEEN T5.APY_STRT_YM AND T5.APY_END_YM
        <if test='@MybatisUtils@isNotEmpty(pdctTpCd)'>
          AND ( CASE WHEN T1.OG_TP_CD = 'W01' THEN T5.FEE_PDCT_TP_CD2
                     ELSE T5.FEE_PDCT_TP_CD1
                END ) = #{pdctTpCd}
        </if>
        WHERE T1.BASE_YM = SUBSTR(#{strtDt},0,6)
        <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
            <if test="ogDvCd != 'W06'">
                AND T1.OG_TP_CD  = #{ogDvCd}
            </if>
            <if test='@MybatisUtils@equals(ogDvCd, "W06")'>
                AND T1.OG_TP_CD NOT IN ('W01','W02','W03','W04','W05')
            </if>
        </if>
    </select>

    <select id='selectAggreateNetOrders' resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaNetOrderDto$SearchRes">
        SELECT T4.CD_CNTN AS SELL_OG
             , T2.OG_ID AS BLG
             , T1.PRTNR_NO
             , T2.PRTNR_KNM
             , T1.SELL_TP_CD
             , CASE WHEN T1.OG_TP_CD = 'W01' THEN T7.FEE_PDCT_TP_CD2
                    ELSE T7.FEE_PDCT_TP_CD1
               END AS PDCT_TP /* 제품유형 !!!*/
             , T1.CNTR_NO AS CNTR_DTL_NO
             , T2.COPN_DV_CD AS CST_DV
             , T3.PD_NM AS PRDT_NM
             , T1.PD_CD AS PRDT_CD
             , T3.HGR_PD_CD AS PKG_CD
             , T5.ISTM_MCN AS ISTM
             , T1.STPL_PTRM_MCN AS STPL_MCNT
             , SUBSTR(T4.CNTR_CNFM_DTM,0,6) AS CNTR_DATE
             , T1.SL_DT
             , T1.CAN_DT
             , T6.REQD_DT AS DEM_DT
             , CASE WHEN T1.SELL_TP_CD = '2' THEN T5.SELL_AMT END AS RTLFE  /*계약유형이 렌탈일때만 렌탈료*/
          FROM TB_FEAM_WELS_NRCTR_MM_CL T1
         INNER JOIN TB_OGBS_MM_PRTNR_IZ T2 /* 월파트너 */
            ON T1.BASE_YM = T2.BASE_YM
           AND T1.PRTNR_NO = T2.PRTNR_NO
           AND T1.OG_TP_CD = T2.OG_TP_CD
         INNER JOIN TB_PDBS_PD_BAS T3 /* 상품기본 */
            ON T1.PD_CD = T3.PD_CD
         INNER JOIN TB_SSCT_CNTR_BAS T4
            ON T1.CNTR_NO = T4.CNTR_NO
         INNER JOIN TB_SSCT_CNTR_DTL T5
            ON T1.CNTR_NO = T5.CNTR_NO
           AND T1.CNTR_SN = T5.CNTR_SN
          LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T6
            ON T1.CNTR_NO = T6.CNTR_NO
           AND T1.CNTR_SN = T6.CNTR_SN
         INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T7
            ON T1.PD_CD = T7.BASE_PD_CD
           AND #{perfYm} BETWEEN T7.APY_STRT_YM AND T7.APY_END_YM
          LEFT OUTER JOIN TB_SSCT_CNTR_DTL T3
            ON T3.CNTR_NO = T1.CNTR_NO
           AND T3.CNTR_SN = T1.CNTR_SN
           AND T3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN T_CMZ_CD_D T4
            ON T1.OG_TP_CD = T4.CD_VLD_VAL
           AND T4.CD_ID = 'OG_TP_CD'
           AND T4.TENANT_ID = #{session.tenantId}
         WHERE T1.BASE_YM = #{perfYm} /* 기준년월 */
           AND T1.FEE_TCNT_DV_CD = #{tcntDvCd} /* 차수 */
           AND T1.CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
      <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
           <if test="ogDvCd != 'W06'">
           AND T1.OG_TP_CD  = #{ogDvCd}
           </if>
           <if test='@MybatisUtils@equals(ogDvCd, "W06")'>
           AND T1.OG_TP_CD NOT IN ('W01','W02','W03','W04','W05')
          </if>
      </if>
    </select>

    <select id='selectNetOrderFees' resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaNetOrderDto$SearchFeeRes">
        SELECT CASE WHEN T3.CD_VLD_VAL = 'W06' THEN '기타' ELSE T3.CD_CNTN END AS SELL_OG
             , NVL(M.RENT_CNT + SPAY_CNT + RGLR_CNT + RSTL_CNT + MSH_CNT,0) AS TOT_CT
             , NVL(M.RENT_CNT,0) AS RENTAL
             , NVL(M.SPAY_CNT,0) AS SNGL_PMNT
             , NVL(M.RGLR_CNT,0) AS REG_DLVR
             , NVL(M.RSTL_CNT,0) AS RSTL
             , NVL(M.MSH_CNT,0) AS HCR_MSH
             , NVL(M.ENVR_CNT,0) AS ENVR
             , NVL(M.WELSF_CNT,0) AS WELSF
             , NVL(M.BH_CNT,0) AS BH
             , NVL(M.CAPSL_CNT,0) AS CAPSL
             , NVL(M.HOME_CARE_CNT,0) AS HOME_CARE
             , NVL(M.CSMB_CNT,0) AS CSMB
             , NVL(M.ACSR_CNT,0) AS ACSR
           FROM T_CMZ_CD_D T3
           LEFT OUTER JOIN ( SELECT T.OG_TP_CD
                                  , SUM(T.RENT_CNT) AS RENT_CNT
                                  , SUM(T.SPAY_CNT) AS SPAY_CNT
                                  , SUM(T.RGLR_CNT) AS RGLR_CNT
                                  , SUM(T.RSTL_CNT) AS RSTL_CNT
                                  , SUM(T.MSH_CNT) AS MSH_CNT
                                  , SUM(T.ENVR_CNT) AS ENVR_CNT
                                  , SUM(T.WELSF_CNT) AS WELSF_CNT
                                  , SUM(T.BH_CNT) AS BH_CNT
                                  , SUM(T.CAPSL_CNT) AS CAPSL_CNT
                                  , SUM(T.HOME_CARE_CNT) AS HOME_CARE_CNT
                                  , SUM(T.CSMB_CNT) AS CSMB_CNT
                                  , SUM(T.ACSR_CNT) AS ACSR_CNT
                               FROM ( SELECT CASE WHEN ( T1.OG_TP_CD = 'W01' OR T1.OG_TP_CD = 'W02'
                                                            OR T1.OG_TP_CD = 'W03' OR T1.OG_TP_CD = 'W04'
                                                            OR T1.OG_TP_CD = 'W05' ) /* 기타코드가 따로 없음 W06으로 임시처리 */
                                                       THEN T1.OG_TP_CD
                                                  ELSE 'W06'
                                             END AS OG_TP_CD
                                           , T1.SELL_TP_CD
                                           , T1.SELL_TP_CD
                                           , CASE WHEN T1.SELL_TP_CD = '2' AND NVL(T3.CNTR_NO,'N') = 'N' THEN 1 ELSE 0 END AS RENT_CNT
                                           , CASE WHEN T1.SELL_TP_CD = '1' THEN 1 ELSE 0 END  AS SPAY_CNT
                                           , CASE WHEN T1.SELL_TP_CD = '6' THEN 1 ELSE 0 END  AS RGLR_CNT
                                           , CASE WHEN T1.SELL_TP_CD = '2' AND NVL(T3.CNTR_NO,'N') != 'N' THEN 1 ELSE 0 END  AS RSTL_CNT
                                           , CASE WHEN T1.SELL_TP_CD = '3' THEN 1 ELSE 0 END  AS MSH_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'A' THEN 1
                                                  WHEN T2.FEE_PDCT_TP_CD1 = 'A' THEN 1
                                             END AS ENVR_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'B' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'B' THEN 1
                                             END AS WELSF_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'C' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'C' THEN 1
                                             END AS BH_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'D' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'D' THEN 1
                                             END AS CAPSL_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'E' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'E' THEN 1
                                             END AS HOME_CARE_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'F' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'F' THEN 1
                                             END AS CSMB_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'G' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'G' THEN 1
                                             END AS ACSR_CNT
                                        FROM TB_FEAM_WELS_NRCTR_MM_CL T1
                                       INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T2
                                          ON T1.PD_CD = T2.BASE_PD_CD
                                         AND #{perfYm} BETWEEN T2.APY_STRT_YM AND T2.APY_END_YM
                                        LEFT OUTER JOIN TB_SSCT_RENTAL_RSTL_IZ T3
                                          ON T1.CNTR_NO = T3.CNTR_NO
                                         AND T1.CNTR_SN = T3.CNTR_SN
                                       WHERE T1.BASE_YM = #{perfYm} /* 기준년월 */
                                         AND T1.FEE_TCNT_DV_CD = #{tcntDvCd} /* 차수 */
                                         AND T1.CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
                                    <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
                                         <if test="ogDvCd != 'W06'">
                                         AND T1.OG_TP_CD  = #{ogDvCd}
                                         </if>
                                         <if test='@MybatisUtils@equals(ogDvCd, "W06")'>
                                         AND T1.OG_TP_CD NOT IN ('W01','W02','W03','W04','W05')
                                         </if>
                                    </if>
                                    )T
                              GROUP BY T.OG_TP_CD
                           )M
             ON M.OG_TP_CD = T3.CD_VLD_VAL
          WHERE T3.CD_ID = 'OG_TP_CD'
            AND T3.TENANT_ID = #{session.tenantId}
        <if test='@MybatisUtils@isEmpty(ogDvCd)'>
            AND T3.CD_VLD_VAL IN ('W01','W02','W03','W04','W05','W06')
        </if>
        <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
            AND T3.CD_VLD_VAL  = #{ogDvCd}
        </if>
          ORDER BY T3.CD_VLD_VAL
    </select>

    <select id='selectNetAggregateConfirm' resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaNetOrderDto$SearchConfirmRes">
        SELECT CASE WHEN NTOR_CNFM_STAT_CD = '02' THEN 'Y'
                    ELSE 'N'
               END AS CNFM_CHK
          FROM TB_FEAM_NRCTR_MM_CL T1
         WHERE BASE_YM = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM')
           AND T1.FEE_TCNT_DV_CD =  #{tcntDvCd} /* 차수 */
           AND T1.CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
    </select>

    <delete id="deleteWelsNetOrders">
        DELETE FROM TB_FEAM_WELS_NRCTR_MM_CL
         WHERE BASE_YM = #{perfYm}
           AND FEE_TCNT_DV_CD = #{tcntDvCd} /* 차수 */
           AND CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
    </delete>

    <delete id="deleteNetOrders">
        DELETE FROM TB_FEAM_NRCTR_MM_CL
        WHERE BASE_YM = #{perfYm}
        AND FEE_TCNT_DV_CD = #{tcntDvCd} /* 차수 */
        AND CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
    </delete>

    <insert id="insertNetOrder">
        INSERT INTO TB_FEAM_NRCTR_MM_CL
               ( BASE_YM
               , FEE_TCNT_DV_CD
               , CNTR_PERF_CRT_DV_CD
               , NTOR_CNFM_STAT_CD
               , DTA_DL_YN
               <include refid="COMMON.insertSystemField" />
               )
        VALUES ( #{perfYm}
               , #{tcntDvCd} /* 차수 */
               , '01' /* 순주문 */
               , '01' /* 임시 */
               , 'N'
               <include refid="COMMON.insertSystemFieldValue" />
               )
    </insert>

    <insert id="insertManagerNetOrders">
        INSERT INTO TB_FEAM_WELS_NRCTR_MM_CL
        SELECT #{perfYm} AS BASE_YM
             , #{perfYm} AS PERF_YM
             , #{tcntDvCd} AS FEE_TCNT_DV_CD
             , A.CNTR_NO
             , A.CNTR_SN
             , '01' AS CNTR_PERF_CRT_DV_CD   /* 순주문 */
             , #{session.companyCode} AS CO_CD
             , 'W02' AS OG_TP_CD             /* M조직 */
             , A.SELL_PRTNR_NO AS PRTNR_NO
             , A.BASE_PD_CD AS PD_CD
             , '' AS REF_PD_CLSF_VAL
             , '' AS PERF_TP_CD
             , A.SELL_TP_CD
             , A.SELL_DSC_DV_CD
             , CASE WHEN A.SELL_DSC_DV_CD = '5' THEN A.SELL_DSCR_CD ELSE '0' END AS SELL_DSCR_CD
             , CASE WHEN A.SELL_DSC_DV_CD != '5' THEN A.STPL_PTRM ELSE 0 END AS RECAP_DUTY_PTRM_N
             , CASE WHEN A.RSTL_YN = 'Y' THEN '' /* 재약정 = '' */
                    WHEN A.SELL_TP_CD = '2'
                         THEN ( CASE WHEN A.SELL_DSC_TP_CD = '' THEN '0' ELSE A.SELL_DSC_TP_CD END )
                    ELSE '0'
               END AS PMOT_USWY_DV_CD /* 일시불 = 0 */
             , A.SV_PRD AS BFSVC_PRD_CD
             , CASE WHEN A.SELL_TP_CD = '1' THEN '' /* 일시불 = '' */
                    WHEN A.RSTL_YN = 'Y' THEN '' /* 재약정 = '' */
                    WHEN D.MCHN_CH_TP_CD IS NOT NULL THEN 'Y'
                    ELSE 'N'
               END AS MCHN_CH_YN
             , CASE WHEN A.SELL_TP_CD = '1' THEN '' /* 일시불 = 0 */
                    WHEN A.RSTL_YN = 'Y' THEN '' /* 재약정 = '' */
                    ELSE A.SELL_DSC_TP_CD
               END AS SELL_DSC_TP_CD
             , CASE WHEN A.SELL_TP_CD = '1' THEN '0' /* 일시불 = 0 */
                    WHEN A.SELL_TP_CD = '6' THEN '0' /* 정기배송 = 0 */
                    WHEN A.RSTL_YN = 'Y' THEN '0' /* 재약정 = 0 */
                    ELSE NVL(D.MCHN_CH_TP_CD,0)
               END AS MCHN_CH_TP_CD
             , A.RSTL_YN
             , '1' AS FEE_ACKMT_DV_CD
             , B.OG_ID AS HDQ_OG_ID
             , '1' AS VTSEL_SODBT_CHNL_DV_CD
             , '' AS SELL_AMT
             , '' AS SL_AMT
             , '' AS REDF_ADSB_OJ_AMT
             , '' AS VAT
             , '' AS ACKMT_PERF_RT
             , A.ACKMT_PERF_AMT
             , A.FEE_ACKMT_CT AS ACKMT_PERF_CT
             , '' AS CVT_PERF_AMT
             , CASE WHEN NVL(A.BOO_SELL_TP_CD,0) = 2 THEN 'Y' ELSE 'N' END AS BOO_SELL_YN
             , A.CNTR_RCP_FSH_DTM AS RCPDT
             , A.SL_RCOG_DT AS SL_DT
             , A.CNTR_PD_ENDDT AS CAN_DT
             , CASE WHEN A.SELL_TP_CD = '1' THEN 0 /* 일시불 = 0 */
                    WHEN A.RSTL_YN = 'Y' THEN 0 /* 재약정 = '' */
                    ELSE A.STPL_PTRM
               END AS STPL_PTRM_MCN
             , '' AS FEE_CPSN_REDF_ID
             , TO_CHAR(SYSDATE,'YYYYMMDD') AS OJ_PRCSDT
             , 'N' AS DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM ( /* 일시불 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '1'  /* 일시불/할부 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) = '2'   /* 예약판매 = Y  */
                    AND DTL.BASE_PD_CD NOT IN ( 'WP07110297', 'WP07110298', 'WM07100678', 'WM07100680', 'WM07100681', 'WP07110295' ) /*상품코드 스태킹키트 제외*/
                   LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                  WHERE BAS.SELL_OG_TP_CD = 'W02'
                    AND BAS.CNTR_CNFM_DTM = #{perfYm}  /* 계약년월 */
                  UNION ALL
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '1'  /* 일시불/할부 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) != '2'   /* 예약판매 = N  */
                    AND DTL.BASE_PD_CD NOT IN ( 'WP07110297', 'WP07110298', 'WM07100678', 'WM07100680', 'WM07100681', 'WP07110295' ) /*상품코드 스태킹키트 제외*/
                  INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) = #{perfYm}  /* 설치일자(매출년월) */
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) != BAS.CNTR_CAN_DTM /* 설치일자(매출년월) != 취소년월 */
                  WHERE BAS.SELL_OG_TP_CD = 'W02'
                  UNION ALL
                  /* 렌탈 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '2'  /* 렌탈 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) = '2'   /* 예약판매 = Y  */
                   LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                  WHERE BAS.SELL_OG_TP_CD = 'W02'
                    AND BAS.CNTR_CNFM_DTM = #{perfYm}  /* 계약년월 */
                  UNION ALL
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '2'  /* 렌탈 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) != '2'   /* 예약판매 = N  */
                    AND NOT EXISTS (SELECT 1 FROM TB_SSCT_RENTAL_RSTL_IZ X WHERE DTL.CNTR_NO = X.CNTR_NO AND DTL.CNTR_SN = X.CNTR_SN)
                  INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) = #{perfYm}  /* 설치일자(매출년월) */
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) != BAS.CNTR_CAN_DTM /* 설치일자(매출년월) != 취소년월 */
                  WHERE BAS.SELL_OG_TP_CD = 'W02'
                  UNION ALL
                  /* 정기배송 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '6'  /* 정기배송 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) = '2'   /* 예약판매 = Y  */
                   LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                    AND DTL.STPL_PTRM >= 6
                  WHERE BAS.SELL_OG_TP_CD = 'W02'
                    AND BAS.CNTR_CNFM_DTM = #{perfYm}  /* 계약년월 */
                  UNION ALL
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '6'  /* 정기배송 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) != '2'   /* 예약판매 = N  */
                  INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) = #{perfYm}  /* 설치일자(매출년월) */
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) != BAS.CNTR_CAN_DTM /* 설치일자(매출년월) != 취소년월 */
                    AND DTL.STPL_PTRM >= 6
                  WHERE BAS.SELL_OG_TP_CD = 'W02'
                  UNION ALL
                  /* 멤버십 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '3'  /* 멤버십 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) != '2'   /* 예약판매 = N  */
                   LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                    AND DTL.STPL_PTRM >= 6
                  WHERE BAS.SELL_OG_TP_CD = 'W02'
                    AND SUBSTR(BAS.CNTR_CNFM_DTM,0,6) = #{perfYm}  /* 계약년월 */
                    AND SUBSTR(BAS.CNTR_CNFM_DTM,0,6) != SUBSTR(BAS.CNTR_CAN_DTM,0,6)  /* 당월취소 제외 */
                  UNION ALL
                  /* 재약정 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , '' AS SELL_DSC_DV_CD /* 할인구분코드 */
                      , '' AS SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'Y' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_RENTAL_RSTL_IZ RI /* T 재계약내역 T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON RI.CNTR_NO = DTL.CNTR_NO
                    AND RI.CNTR_SN = DTL.CNTR_SN
                    AND DTL.SELL_TP_CD = '2'  /* 렌탈 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) = '2'   /* 예약판매 = Y  */
                    AND DTL.CNTR_DTL_STAT_CD NOT IN ('302','303')  /* 연체해약, 계약취소 제외 */
                  INNER JOIN TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                     ON RI.CNTR_NO = BAS.CNTR_NO
                    AND BAS.SELL_OG_TP_CD = 'W02'
                   LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                  WHERE SUBSTR(RI.STPL_STRTDT,0,6) = #{perfYm}  /* 약정시작년월 */
                    AND SUBSTR(RI.STPL_STRTDT,0,6) != SUBSTR(RI.STPL_CAN_DTM,0,6)  /* 당월취소 제외 */
               ) A
         INNER JOIN TB_OGBS_MM_PRTNR_IZ B /* T월파트너내역T */
            ON A.CNTR_CNFM_DTM = B.BASE_YM
           AND A.SELL_OG_TP_CD = B.OG_TP_CD
           AND A.SELL_PRTNR_NO = B.PRTNR_NO
           AND B.OG_ID NOT LIKE 'Z95%'      /* 총판제외 */
          LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ D  /*T기기변경내역T*/
            ON A.CNTR_NO = D.BASE_CNTR_NO
           AND A.CNTR_SN = D.BASE_CNTR_SN
         WHERE NOT EXISTS (SELECT 1 FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS X WHERE A.CNTR_NO = X.CNTR_NO AND A.CNTR_SN = X.CNTR_SN AND X.FEE_PERF_EXCD_DV_CD = '01') /*수수료실적제외대상 제외*/

    </insert>

    <insert id="insertPlannerNetOrders">
        INSERT INTO TB_FEAM_WELS_NRCTR_MM_CL
        SELECT #{perfYm} AS BASE_YM
             , #{perfYm} AS PERF_YM
             , #{tcntDvCd} AS FEE_TCNT_DV_CD
             , A.CNTR_NO
             , A.CNTR_SN
             , '01' AS CNTR_PERF_CRT_DV_CD
             , #{session.companyCode} AS CO_CD
             , 'W01' AS OG_TP_CD
             , A.SELL_PRTNR_NO
             , A.BASE_PD_CD AS PD_CD
             , '' AS REF_PD_CLSF_VAL
             , '' AS PERF_TP_CD
             , A.SELL_TP_CD
             , A.SELL_DSC_DV_CD AS DSC_DV_CD
             , CASE WHEN A.SELL_DSC_DV_CD = '5' THEN A.SELL_DSCR_CD ELSE '0' END AS SELL_DSCR_CD
             , CASE WHEN A.SELL_DSC_DV_CD != '5' THEN A.STPL_PTRM ELSE 0 END AS RECAP_DUTY_PTRM_N
             , CASE WHEN A.SELL_TP_CD = '2' THEN (CASE WHEN A.SELL_DSC_TP_CD = '' THEN '0' ELSE A.SELL_DSC_TP_CD END) /* 렌탈 */
                    ELSE '0'
               END AS PMOT_USWY_DV_CD
             , A.SV_PRD AS BFSVC_PRD_CD
             , CASE WHEN A.SELL_TP_CD = '2' THEN (CASE WHEN D.MCHN_CH_TP_CD IS NOT NULL THEN 'Y' ELSE 'N' END) /* 렌탈 */
                    ELSE ''
               END AS MCHN_CH_YN
             , CASE WHEN A.SELL_TP_CD = '2' THEN A.SELL_DSC_TP_CD /* 렌탈 */
                    ELSE ''
               END AS SELL_DSC_TP_CD
             , CASE WHEN A.SELL_TP_CD = '2' THEN NVL(D.MCHN_CH_TP_CD,0)
                    ELSE '0'
               END AS MCHN_CH_TP_CD
             , 'N' AS RSTL_YN
             , '1' AS FEE_ACKMT_DV_CD
             , B.OG_ID AS HDQ_OG_ID
             , '1' AS VTSEL_SODBT_CHNL_DV_CD
             , '' AS SELL_AMT
             , '' AS SL_AMT
             , '' AS REDF_ADSB_OJ_AMT
             , '' AS VAT
             , '' AS ACKMT_PERF_RT
             , A.ACKMT_PERF_AMT
             , A.FEE_ACKMT_CT AS ACKMT_PERF_CT
             , '' AS CVT_PERF_AMT
             , CASE WHEN NVL(A.BOO_SELL_TP_CD,0) = 2 THEN 'Y' ELSE 'N' END AS BOO_SELL_YN
             , A.CNTR_RCP_FSH_DTM AS RCPDT
             , A.SL_RCOG_DT AS SL_DT
             , A.CNTR_PD_ENDDT AS CAN_DT
             , CASE WHEN A.SELL_TP_CD = '1' THEN 0 /* 일시불 = 0 */
                    WHEN A.SELL_TP_CD = '3' THEN A.ISTM_MCN /* 멤버십 */
                    WHEN A.SELL_TP_CD = '6' THEN 0 /* 정기배송 = 0 */
                    ELSE A.STPL_PTRM
               END AS STPL_PTRM_MCN
             , '' AS FEE_CPSN_REDF_ID
             , TO_CHAR(SYSDATE,'YYYYMMDD') AS OJ_PRCSDT
             , 'N' AS DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue"/>
           FROM ( /* 일시불 */
                  SELECT BAS.CNTR_NO /*계약번호*/
                       , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                       , BAS.CNTR_CNFM_DTM /* 계약년월 */
                       , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                       , BAS.SELL_PRTNR_NO /* 파트너번호 */
                       , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                       , DTL.BASE_PD_CD /* 상품코드 */
                       , DTL.CNTR_SN /* 계약sq*/
                       , SC.SL_RCOG_DT /* 매출년월 */
                       , DTL.CNTR_PD_ENDDT /* 취소일자 */
                       , DTL.SELL_TP_CD /* 판매유형 코드 */
                       , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                       , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                       , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                       , DTL.SV_PRD /* BS주기코드 */
                       , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                       , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                       , DTL.ISTM_MCN /* 할부개월수 */
                       , DTL.STPL_PTRM  /*약정기간*/
                    FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                   INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                      ON BAS.CNTR_NO = DTL.CNTR_NO
                     AND DTL.SELL_TP_CD = '1'  /* 일시불/할부 */
                     AND NVL(DTL.BOO_SELL_TP_CD,0) = '2'   /* 예약판매 = Y  */
                    LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                      ON DTL.CNTR_NO = SC.CNTR_NO
                     AND DTL.CNTR_SN = SC.CNTR_SN
                   WHERE BAS.SELL_OG_TP_CD = 'W01'
                     AND BAS.CNTR_CNFM_DTM = #{perfYm}  /* 계약년월 */
                   UNION ALL
                  SELECT BAS.CNTR_NO /*계약번호*/
                       , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                       , BAS.CNTR_CNFM_DTM /* 계약년월 */
                       , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                       , BAS.SELL_PRTNR_NO /* 파트너번호 */
                       , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                       , DTL.BASE_PD_CD /* 상품코드 */
                       , DTL.CNTR_SN /* 계약sq*/
                       , SC.SL_RCOG_DT /* 매출년월 */
                       , DTL.CNTR_PD_ENDDT /* 취소일자 */
                       , DTL.SELL_TP_CD /* 판매유형 코드 */
                       , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                       , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                       , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                       , DTL.SV_PRD /* BS주기코드 */
                       , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                       , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                       , DTL.ISTM_MCN /* 할부개월수 */
                       , DTL.STPL_PTRM  /*약정기간*/
                    FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                   INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                      ON BAS.CNTR_NO = DTL.CNTR_NO
                     AND DTL.SELL_TP_CD = '1'  /* 일시불/할부 */
                     AND NVL(DTL.BOO_SELL_TP_CD,0) != '2'   /* 예약판매 = N  */
                   INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                      ON DTL.CNTR_NO = SC.CNTR_NO
                     AND DTL.CNTR_SN = SC.CNTR_SN
                     AND SUBSTR(SC.SL_RCOG_DT,0,6) = #{perfYm}  /* 설치일자(매출년월) */
                     AND SUBSTR(SC.SL_RCOG_DT,0,6) != BAS.CNTR_CAN_DTM /* 설치일자(매출년월) != 취소년월 */
                   WHERE BAS.SELL_OG_TP_CD = 'W01'
                   UNION ALL
                   /* 렌탈 */
                  SELECT BAS.CNTR_NO /*계약번호*/
                       , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                       , BAS.CNTR_CNFM_DTM /* 계약년월 */
                       , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                       , BAS.SELL_PRTNR_NO /* 파트너번호 */
                       , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                       , DTL.BASE_PD_CD /* 상품코드 */
                       , DTL.CNTR_SN /* 계약sq*/
                       , SC.SL_RCOG_DT /* 매출년월 */
                       , DTL.CNTR_PD_ENDDT /* 취소일자 */
                       , DTL.SELL_TP_CD /* 판매유형 코드 */
                       , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                       , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                       , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                       , DTL.SV_PRD /* BS주기코드 */
                       , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                       , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                       , DTL.ISTM_MCN /* 할부개월수 */
                       , DTL.STPL_PTRM  /*약정기간*/
                    FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                   INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                      ON BAS.CNTR_NO = DTL.CNTR_NO
                     AND DTL.SELL_TP_CD = '2'  /* 렌탈 */
                     AND NVL(DTL.BOO_SELL_TP_CD,0) = '2'   /* 예약판매 = Y  */
                    LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                      ON DTL.CNTR_NO = SC.CNTR_NO
                     AND DTL.CNTR_SN = SC.CNTR_SN
                   WHERE BAS.SELL_OG_TP_CD = 'W01'
                     AND BAS.CNTR_CNFM_DTM = #{perfYm}  /* 계약년월 */
                   UNION ALL
                  SELECT BAS.CNTR_NO /*계약번호*/
                       , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                       , BAS.CNTR_CNFM_DTM /* 계약년월 */
                       , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                       , BAS.SELL_PRTNR_NO /* 파트너번호 */
                       , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                       , DTL.BASE_PD_CD /* 상품코드 */
                       , DTL.CNTR_SN /* 계약sq*/
                       , SC.SL_RCOG_DT /* 매출년월 */
                       , DTL.CNTR_PD_ENDDT /* 취소일자 */
                       , DTL.SELL_TP_CD /* 판매유형 코드 */
                       , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                       , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                       , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                       , DTL.SV_PRD /* BS주기코드 */
                       , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                       , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                       , DTL.ISTM_MCN /* 할부개월수 */
                       , DTL.STPL_PTRM  /*약정기간*/
                    FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                   INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                      ON BAS.CNTR_NO = DTL.CNTR_NO
                     AND DTL.SELL_TP_CD = '2'  /* 렌탈 */
                     AND NVL(DTL.BOO_SELL_TP_CD,0) != '2'   /* 예약판매 = N  */
                   INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                      ON DTL.CNTR_NO = SC.CNTR_NO
                     AND DTL.CNTR_SN = SC.CNTR_SN
                     AND SUBSTR(SC.SL_RCOG_DT,0,6) = #{perfYm}  /* 설치일자(매출년월) */
                     AND SUBSTR(SC.SL_RCOG_DT,0,6) != BAS.CNTR_CAN_DTM /* 설치일자(매출년월) != 취소년월 */
                   WHERE BAS.SELL_OG_TP_CD = 'W01'
                   UNION ALL
                  /* 멤버십 */
                  SELECT BAS.CNTR_NO /*계약번호*/
                       , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                       , BAS.CNTR_CNFM_DTM /* 계약년월 */
                       , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                       , BAS.SELL_PRTNR_NO /* 파트너번호 */
                       , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                       , DTL.BASE_PD_CD /* 상품코드 */
                       , DTL.CNTR_SN /* 계약sq*/
                       , SC.SL_RCOG_DT /* 매출년월 */
                       , DTL.CNTR_PD_ENDDT /* 취소일자 */
                       , DTL.SELL_TP_CD /* 판매유형 코드 */
                       , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                       , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                       , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                       , DTL.SV_PRD /* BS주기코드 */
                       , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                       , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                       , DTL.ISTM_MCN /* 할부개월수 */
                       , DTL.STPL_PTRM  /*약정기간*/
                    FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                   INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                      ON BAS.CNTR_NO = DTL.CNTR_NO
                     AND DTL.SELL_TP_CD = '3'  /* 멤버십 */
                    LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                      ON DTL.CNTR_NO = SC.CNTR_NO
                     AND DTL.CNTR_SN = SC.CNTR_SN
                   WHERE BAS.SELL_OG_TP_CD = 'W01'
                     AND BAS.CNTR_CNFM_DTM = #{perfYm}  /* 계약년월 */
                     AND BAS.CNTR_CNFM_DTM != BAS.CNTR_CAN_DTM /* 설치일자 != 취소년월 */
                   UNION ALL
                  /* 정기배송 */
                  SELECT BAS.CNTR_NO /*계약번호*/
                       , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                       , BAS.CNTR_CNFM_DTM /* 계약년월 */
                       , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                       , BAS.SELL_PRTNR_NO /* 파트너번호 */
                       , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                       , DTL.BASE_PD_CD /* 상품코드 */
                       , DTL.CNTR_SN /* 계약sq*/
                       , SC.SL_RCOG_DT /* 매출년월 */
                       , DTL.CNTR_PD_ENDDT /* 취소일자 */
                       , DTL.SELL_TP_CD /* 판매유형 코드 */
                       , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                       , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                       , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                       , DTL.SV_PRD /* BS주기코드 */
                       , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                       , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                       , DTL.ISTM_MCN /* 할부개월수 */
                       , DTL.STPL_PTRM  /*약정기간*/
                    FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                   INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                      ON BAS.CNTR_NO = DTL.CNTR_NO
                     AND DTL.SELL_TP_CD = '6'  /* 정기배송 */
                     AND NVL(DTL.BOO_SELL_TP_CD,0) = '2'   /* 예약판매 = Y  */
                    LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                      ON DTL.CNTR_NO = SC.CNTR_NO
                     AND DTL.CNTR_SN = SC.CNTR_SN
                     AND DTL.STPL_PTRM >= 6
                   WHERE BAS.SELL_OG_TP_CD = 'W01'
                     AND BAS.CNTR_CNFM_DTM = #{perfYm}  /* 계약년월 */
                   UNION ALL
                  SELECT BAS.CNTR_NO /*계약번호*/
                       , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                       , BAS.CNTR_CNFM_DTM /* 계약년월 */
                       , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                       , BAS.SELL_PRTNR_NO /* 파트너번호 */
                       , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                       , DTL.BASE_PD_CD /* 상품코드 */
                       , DTL.CNTR_SN /* 계약sq*/
                       , SC.SL_RCOG_DT /* 매출년월 */
                       , DTL.CNTR_PD_ENDDT /* 취소일자 */
                       , DTL.SELL_TP_CD /* 판매유형 코드 */
                       , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                       , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                       , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                       , DTL.SV_PRD /* BS주기코드 */
                       , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                       , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                       , DTL.ISTM_MCN /* 할부개월수 */
                       , DTL.STPL_PTRM  /*약정기간*/
                    FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                   INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                      ON BAS.CNTR_NO = DTL.CNTR_NO
                     AND DTL.SELL_TP_CD = '6'  /* 정기배송 */
                     AND NVL(DTL.BOO_SELL_TP_CD,0) != '2'   /* 예약판매 = N  */
                   INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                      ON DTL.CNTR_NO = SC.CNTR_NO
                     AND DTL.CNTR_SN = SC.CNTR_SN
                     AND DTL.STPL_PTRM >= 6
                     AND SUBSTR(SC.SL_RCOG_DT,0,6) = #{perfYm}  /* 설치일자(매출년월) */
                     AND SUBSTR(SC.SL_RCOG_DT,0,6) != BAS.CNTR_CAN_DTM /* 설치일자(매출년월) != 취소년월 */
                     WHERE BAS.SELL_OG_TP_CD = 'W01'
                ) A
          INNER JOIN TB_OGBS_MM_PRTNR_IZ B /* T월파트너내역T */
             ON A.CNTR_CNFM_DTM = B.BASE_YM
            AND A.SELL_OG_TP_CD = B.OG_TP_CD
            AND A.SELL_PRTNR_NO = B.PRTNR_NO
           LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ D  /*T기기변경내역T*/
             ON A.CNTR_NO = D.BASE_CNTR_NO
            AND A.CNTR_SN = D.BASE_CNTR_SN
          WHERE NOT EXISTS (SELECT 1 FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS X WHERE A.CNTR_NO = X.CNTR_NO AND A.CNTR_SN = X.CNTR_SN AND X.FEE_PERF_EXCD_DV_CD = '01') /*수수료실적제외대상 제외*/
    </insert>

    <insert id="insertHomeMasterNetOrders">
        INSERT INTO TB_FEAM_WELS_NRCTR_MM_CL
        SELECT #{perfYm} AS BASE_YM
             , #{perfYm} AS PERF_YM
             , #{tcntDvCd} AS FEE_TCNT_DV_CD
             , A.CNTR_NO
             , A.CNTR_SN
             , '01' AS CNTR_PERF_CRT_DV_CD
             , #{session.companyCode} AS CO_CD
             , 'W03' AS OG_TP_CD
             , A.SELL_PRTNR_NO AS PRTNR_NO
             , A.BASE_PD_CD AS PD_CD
             , '' AS REF_PD_CLSF_VAL
             , '' AS PERF_TP_CD
             , A.SELL_TP_CD
             , A.SELL_DSC_DV_CD
             , CASE WHEN A.SELL_DSC_DV_CD = '5' THEN A.SELL_DSCR_CD ELSE '0' END AS SELL_DSCR_CD
             , CASE WHEN A.SELL_DSC_DV_CD != '5' THEN A.STPL_PTRM ELSE 0 END AS RECAP_DUTY_PTRM_N
             , CASE WHEN A.SELL_TP_CD = '2'
                    THEN (CASE WHEN A.SELL_DSC_TP_CD = '' THEN '0' ELSE A.SELL_DSC_TP_CD END)
                    ELSE '0'
               END AS PMOT_USWY_DV_CD /* 일시불 = 0 */
             , A.SV_PRD AS BFSVC_PRD_CD
             , CASE WHEN A.SELL_TP_CD = '1' THEN '' /* 일시불 = '' */
                    WHEN D.MCHN_CH_TP_CD IS NOT NULL THEN 'Y' ELSE 'N' END AS MCHN_CH_YN
             , CASE WHEN A.SELL_TP_CD = '1' THEN '' /* 일시불 = 0 */
                    ELSE A.SELL_DSC_TP_CD END AS SELL_DSC_TP_CD
             , CASE WHEN A.SELL_TP_CD = '1' THEN '0' /* 일시불 = 0 */
                    WHEN A.SELL_TP_CD = '6' THEN '0' /* 정기배송 = 0 */
                    ELSE NVL(D.MCHN_CH_TP_CD,0)
               END AS MCHN_CH_TP_CD
             , A.RSTL_YN
             , '1' AS FEE_ACKMT_DV_CD
             , B.OG_ID AS HDQ_OG_ID
             , '3' AS VTSEL_SODBT_CHNL_DV_CD
             , '' AS SELL_AMT
             , '' AS SL_AMT
             , '' AS REDF_ADSB_OJ_AMT
             , '' AS VAT
             , '' AS ACKMT_PERF_RT
             , A.ACKMT_PERF_AMT
             , A.FEE_ACKMT_CT AS ACKMT_PERF_CT
             , '' AS CVT_PERF_AMT
             , CASE WHEN NVL(A.BOO_SELL_TP_CD,0) = 2 THEN 'Y'
                    ELSE 'N'
               END AS BOO_SELL_YN
             , A.CNTR_RCP_FSH_DTM AS RCPDT
             , A.SL_RCOG_DT AS SL_DT
             , A.CNTR_PD_ENDDT AS CAN_DT
             , CASE WHEN A.SELL_TP_CD = '1' THEN 0 /* 일시불 = 0 */
                    ELSE A.STPL_PTRM
               END AS STPL_PTRM_MCN
             , '' AS FEE_CPSN_REDF_ID
             , TO_CHAR(SYSDATE,'YYYYMMDD') AS OJ_PRCSDT
             , 'N' AS DTA_DL_YN
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM ( /* 일시불 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '1'  /* 일시불/할부 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) = '2'   /* 예약판매 = Y  */
                    AND DTL.BASE_PD_CD NOT IN ( 'WP07110297', 'WP07110298', 'WM07100678', 'WM07100680', 'WM07100681', 'WP07110295' ) /*상품코드 스태킹키트 제외*/
                   LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                  WHERE BAS.SELL_OG_TP_CD = 'W03'
                    AND BAS.CNTR_CNFM_DTM = #{perfYm}  /* 계약년월 */
                  UNION ALL
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '1'  /* 일시불/할부 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) != '2'   /* 예약판매 = N  */
                    AND DTL.BASE_PD_CD NOT IN ( 'WP07110297', 'WP07110298', 'WM07100678', 'WM07100680', 'WM07100681', 'WP07110295' ) /*상품코드 스태킹키트 제외*/
                  INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) = #{perfYm}  /* 설치일자(매출년월) */
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) != BAS.CNTR_CAN_DTM /* 설치일자(매출년월) != 취소년월 */
                  WHERE BAS.SELL_OG_TP_CD = 'W03'
                  UNION ALL
                  /* 렌탈 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '2'  /* 렌탈 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) = '2'   /* 예약판매 = Y  */
                   LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                  WHERE BAS.SELL_OG_TP_CD = 'W03'
                    AND BAS.CNTR_CNFM_DTM = #{perfYm}  /* 계약년월 */
                  UNION ALL
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '2'  /* 렌탈 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) != '2'   /* 예약판매 = N  */
                  INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) = #{perfYm}  /* 설치일자(매출년월) */
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) != BAS.CNTR_CAN_DTM /* 설치일자(매출년월) != 취소년월 */
                  WHERE BAS.SELL_OG_TP_CD = 'W03'
                  UNION ALL
                  /* 정기배송 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '6'  /* 정기배송 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) = '2'   /* 예약판매 = Y  */
                   LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                    AND DTL.STPL_PTRM >= 6
                  WHERE BAS.SELL_OG_TP_CD = 'W03'
                    AND BAS.CNTR_CNFM_DTM = #{perfYm}  /* 계약년월 */
                  UNION ALL
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '6'  /* 정기배송 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) != '2'   /* 예약판매 = N  */
                  INNER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) = #{perfYm}  /* 설치일자(매출년월) */
                    AND SUBSTR(SC.SL_RCOG_DT,0,6) != BAS.CNTR_CAN_DTM /* 설치일자(매출년월) != 취소년월 */
                    AND DTL.STPL_PTRM >= 6
                  WHERE BAS.SELL_OG_TP_CD = 'W03'
                  UNION ALL
                  /* 멤버십 */
                 SELECT BAS.CNTR_NO /*계약번호*/
                      , BAS.CNTR_RCP_FSH_DTM /*접수일자*/
                      , BAS.CNTR_CNFM_DTM /* 계약년월 */
                      , BAS.SELL_OG_TP_CD /* 조직유형코드*/
                      , BAS.SELL_PRTNR_NO /* 파트너번호 */
                      , DTL.BOO_SELL_TP_CD /*예약판매코드*/
                      , DTL.BASE_PD_CD /* 상품코드 */
                      , DTL.CNTR_SN /* 계약sq*/
                      , SC.SL_RCOG_DT /* 매출년월 */
                      , DTL.CNTR_PD_ENDDT /* 취소일자 */
                      , DTL.SELL_TP_CD /* 판매유형 코드 */
                      , DTL.SELL_DSC_DV_CD /* 할인구분코드 */
                      , DTL.SELL_DSC_TP_CD /* 할인유형코드 */
                      , DTL.SELL_DSCR_CD /* 판매할인율코드 */
                      , DTL.SV_PRD /* BS주기코드 */
                      , DTL.FEE_ACKMT_CT /*수수료인정건수*/
                      , DTL.ACKMT_PERF_AMT /*수수료인정실적금액*/
                      , 'N' AS RSTL_YN   /* 재약정여부 */
                      , DTL.STPL_PTRM  /*약정기간*/
                   FROM TB_SSCT_CNTR_BAS BAS /* T계약기본T */
                  INNER JOIN TB_SSCT_CNTR_DTL DTL /* T계약상세T */
                     ON BAS.CNTR_NO = DTL.CNTR_NO
                    AND DTL.SELL_TP_CD = '3'  /* 멤버십 */
                    AND NVL(DTL.BOO_SELL_TP_CD,0) != '2'   /* 예약판매 = N  */
                   LEFT OUTER JOIN TB_CBCL_WELLS_SL_CNFM_BAS SC /*T WELLS매출확정기본 T*/
                     ON DTL.CNTR_NO = SC.CNTR_NO
                    AND DTL.CNTR_SN = SC.CNTR_SN
                    AND DTL.STPL_PTRM >= 6
                  WHERE BAS.SELL_OG_TP_CD = 'W03'
                    AND BAS.CNTR_CNFM_DTM = #{perfYm}  /* 계약년월 */
                    AND BAS.CNTR_CNFM_DTM != BAS.CNTR_CAN_DTM /*당월가입_당월취소는 제외*/
               ) A
         INNER JOIN TB_OGBS_MM_PRTNR_IZ B /* T월파트너내역T */
            ON A.CNTR_CNFM_DTM = B.BASE_YM
           AND A.SELL_OG_TP_CD = B.OG_TP_CD
           AND A.SELL_PRTNR_NO = B.PRTNR_NO
           AND B.OG_ID NOT LIKE 'Z95%'      /* 총판제외 */
          LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ D  /*T기기변경내역T*/
            ON A.CNTR_NO = D.BASE_CNTR_NO
           AND A.CNTR_SN = D.BASE_CNTR_SN
         WHERE NOT EXISTS (SELECT 1 FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS X WHERE A.CNTR_NO = X.CNTR_NO AND A.CNTR_SN = X.CNTR_SN AND X.FEE_PERF_EXCD_DV_CD = '01') /*수수료실적제외대상 제외*/
    </insert>

    <update id="updateNetOrders">
        UPDATE TB_FEAM_NRCTR_MM_CL
           SET NTOR_CNFM_STAT_CD = '02' /* 확정 */
         WHERE BASE_YM = #{perfYm}
           AND FEE_TCNT_DV_CD = #{tcntDvCd} /* 차수 */
           AND CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
           AND NTOR_CNFM_STAT_CD = '01' /* 임시 */
    </update>

</mapper>
