<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.aggregate.mapper.WfeaNetOrderMapper">

    <select id='selectNetOrders' resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaNetOrderDto$SearchRes">
        SELECT T1.OG_TP_CD AS SELL_OG
             , T1.OG_CD AS BLG
             , T1.PRTNR_NO
             , T1.PRTNR_KNM
             , T2.SELL_TP_CD
             , CASE WHEN T1.OG_TP_CD = 'W01' AND NVL(T5.FEE_PDCT_TP_CD2,'0')!= '0' THEN T5.FEE_PDCT_TP_CD2
                    WHEN NVL(T5.FEE_PDCT_TP_CD2,'0') = '0' THEN '등록되지 않은 제품유형'
                    ELSE T5.FEE_PDCT_TP_CD1
               END AS PDCT_TP /* 제품유형 !!!*/
             , T2.CNTR_DTL_NO
             , T1.COPN_DV_CD AS CST_DV
             , T3.PD_NM AS PRDT_NM
             , T2.PRDT_CD
             , T3.HGR_PD_CD AS PKG_CD
             , T2.ISTM
             , CASE WHEN T2.SELL_TP_CD = '1' THEN 0 /* 일시불 = 0 */
                    WHEN T2.RSTL_YN = 'Y' THEN 0 /* 재약정 = '' */
                    ELSE T2.STPL_PTRM
               END AS STPL_MCNT
             , SUBSTR(T2.CNTR_DATE,0,6) AS CNTR_DATE
             , SUBSTR(T2.SL_DT,0,6) AS SL_DT
             , SUBSTR(T2.CAN_DT,0,6) AS CAN_DT
             , SUBSTR(T4.REQD_DT,0,6) AS DEM_DT
             , T2.RTLFE
          FROM TB_OGBS_MM_PRTNR_IZ T1  /* 월파트너 */
         INNER JOIN TB_OGBS_MM_OG_IZ OG
            ON T1.BASE_YM = OG.BASE_YM
           AND T1.OG_ID = OG.OG_ID
           AND T1.OG_TP_CD = OG.OG_TP_CD
      <if test='@MybatisUtils@isNotEmpty(ogLevl1Id)'>
           AND OG.DGR1_LEVL_OG_ID = #{ogLevl1Id}
      </if>
      <if test='@MybatisUtils@isNotEmpty(ogLevl2Id)'>
           AND OG.DGR2_LEVL_OG_ID = #{ogLevl2Id}
      </if>
      <if test='@MybatisUtils@isNotEmpty(ogLevl3Id)'>
           AND OG.DGR3_LEVL_OG_ID = #{ogLevl3Id}
      </if>
         INNER JOIN ( SELECT CD.CNTR_SN     /* 재약정 제외 목록*/
                           , CB.SELL_OG_TP_CD AS OG_TP_CD
                           , CB.SELL_PRTNR_NO AS PRTNR_NO
                           , CD.SELL_TP_CD
                           , CD.CNTR_NO AS CNTR_DTL_NO
                           , CD.BASE_PD_CD AS PRDT_CD
                           , CD.ISTM_MCN AS ISTM
                           , CB.CNTR_CNFM_DTM AS CNTR_DATE
                           , TO_CHAR(TO_DATE(CD.CNTR_PD_STRTDT),'YYYYMM') AS SL_DT
                           , CASE WHEN CD.CNTR_DTL_STAT_CD IN ('301','303') THEN CD.CNTR_PD_ENDDT
                                  ELSE '-'
                             END AS CAN_DT
                           , CASE WHEN CD.SELL_TP_CD = '2' THEN CD.SELL_AMT END AS RTLFE  /* 계약유형이 렌탈일때만 렌탈료 */
                           , 'N' AS RSTL_YN
                           , CD.STPL_PTRM
                        FROM TB_SSCT_CNTR_BAS CB
                       INNER JOIN TB_SSCT_CNTR_DTL CD
                          ON CB.CNTR_NO = CD.CNTR_NO
                         AND NOT EXISTS (SELECT 1 FROM TB_SSCT_RENTAL_RSTL_IZ X WHERE X.CNTR_NO = CD.CNTR_NO AND CD.CNTR_SN = CD.CNTR_SN ) /*재약정 제외*/
                         AND CD.CNTRW_TP_CD = (CASE WHEN CD.SELL_TP_CD = '3' THEN '5' ELSE CD.CNTRW_TP_CD END)
                    <if test='@MybatisUtils@equals(divCd, "02")'> /* 예약 */
                         AND CD.BOO_SELL_TP_CD = '2'
                    </if>
                    <if test='@MybatisUtils@equals(DivCd, "03")'> /* 매출 */
                         AND NVL(CD.BOO_SELL_TP_CD,0) != '2'
                    </if>
                    <if test='@MybatisUtils@isNotEmpty (selTpCd)'>
                        <if test='!@MybatisUtils@equals(selTpCd, "7")'>
                         AND CD.SELL_TP_CD = #{selTpCd}
                        </if>
                        <if test='@MybatisUtils@equals(selTpCd, "7")'>
                         AND 1 = #{selTpCd}
                        </if>
                    </if>
                    <if test='@MybatisUtils@equals(divCd, "01") or @MybatisUtils@equals(divCd, "02")'>
                       WHERE 1 = 1
                         AND CB.CNTR_CNFM_DTM BETWEEN #{strtDt} AND  #{endDt} /* 계약 확정일자*/
                    </if>
                    <if test='@MybatisUtils@equals(divCd, "03")'>   /* 매출 */
                         AND CD.CNTR_PD_STRTDT BETWEEN #{strtDt} AND #{endDt}  /* 매출 확정일자 */
                       WHERE 1=1
                    </if>
                    <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                         AND CB.SELL_PRTNR_NO  = #{prtnrNo}
                    </if>
                    <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
                        <if test='!@MybatisUtils@equals(ogDvCd, "W06")'>
                         AND CB.SELL_OG_TP_CD  = #{ogDvCd}
                        </if>
                        <if test='@MybatisUtils@equals(ogDvCd, "W06")'>
                         AND CB.SELL_OG_TP_CD NOT IN ('W01','W02','W03','W04','W05')
                        </if>
                    </if>
                    <if test='@MybatisUtils@isEmpty(selTpCd) or @MybatisUtils@equals(selTpCd, "7")'>
                       UNION ALL     /* 판매구분이 전체 혹은 재약정일때 UNION ALL 재약정 */
                      SELECT CD.CNTR_SN
                           , CB.SELL_OG_TP_CD AS OG_TP_CD
                           , CB.SELL_PRTNR_NO AS PRTNR_NO
                           , CD.SELL_TP_CD
                           , CD.CNTR_NO AS CNTR_DTL_NO
                           , CD.BASE_PD_CD AS PRDT_CD
                           , CD.ISTM_MCN AS ISTM
                           , RI.STPL_STRTDT AS CNTR_DATE
                           , TO_CHAR(TO_DATE(CD.CNTR_PD_STRTDT),'YYYYMM') AS SL_DT
                           , RI.STPL_CAN_DTM AS CAN_DT
                           , CD.SELL_AMT AS RTLFE
                           , 'Y' AS RSTL_YN
                           , CD.STPL_PTRM
                        FROM TB_SSCT_CNTR_BAS CB
                       INNER JOIN TB_SSCT_CNTR_DTL CD
                          ON CB.CNTR_NO = CD.CNTR_NO
                         AND CD.SELL_TP_CD = '2'     /* 렌탈 */
                         <if test='@MybatisUtils@equals(divCd, "02")'> /* 예약 */
                         AND CD.BOO_SELL_TP_CD = '2'
                         </if>
                         <if test='@MybatisUtils@equals(divCd, "03")'> /* 매출 */
                         AND NVL(CD.BOO_SELL_TP_CD,0) != '2'
                         </if>
                       INNER JOIN TB_SSCT_RENTAL_RSTL_IZ RI /* 재약정내역 테이블 */
                          ON CD.CNTR_NO = RI.CNTR_NO
                         AND CD.CNTR_SN = RI.CNTR_SN
                         <if test='@MybatisUtils@equals(divCd, "01") or @MybatisUtils@equals(divCd, "02")'>
                         AND RI.STPL_STRTDT BETWEEN #{strtDt} AND  #{endDt} /* 약정 시작일자*/
                       WHERE 1 = 1
                         </if>
                         <if test='@MybatisUtils@equals(divCd, "03")'>    /* 매출 */
                         AND RI.STPL_CNFM_DTM BETWEEN #{strtDt} AND #{endDt}  /* 매출 확정일자 */
                       WHERE 1=1
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                         AND CB.SELL_PRTNR_NO  = #{prtnrNo}
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
                             <if test="ogDvCd != 'W06'">
                         AND CB.SELL_OG_TP_CD  = #{ogDvCd}
                             </if>
                             <if test='@MybatisUtils@equals(ogDvCd, "W06")'>
                         AND CB.SELL_OG_TP_CD NOT IN ('W01','W02','W03','W04','W05')
                             </if>
                         </if>
                    </if>
                    )T2
            ON T1.PRTNR_NO = T2.PRTNR_NO
           AND T1.OG_TP_CD = T2.OG_TP_CD
         INNER JOIN TB_PDBS_PD_BAS T3
            ON T2.PRDT_CD = T3.PD_CD
      <if test='@MybatisUtils@isNotEmpty(cancStrtDt)'>
           AND T2.CAN_DT &gt;= #{cancStrtDt}                /* 약정취소 시작일자 */
      </if>
      <if test='@MybatisUtils@isNotEmpty(cancEndDt)'>
           AND T2.CAN_DT &lt;= #{cancEndDt}  /* 약정취소 종료일자 */
      </if>
      <if test='@MybatisUtils@isNotEmpty(pdStrtCd)'>
          AND T3.PD_CD &gt;= #{pdStrtCd}
      </if>
      <if test='@MybatisUtils@isNotEmpty(pdEndCd)'>
           AND T3.PD_CD &lt;= #{pdEndCd}
      </if>
      <if test='@MybatisUtils@isNotEmpty(pkgStrtCd)'>
           AND T3.HGR_PD_CD &gt;= #{pkgStrtCd}
      </if>
      <if test='@MybatisUtils@isNotEmpty(pkgEndCd)'>
           AND T3.HGR_PD_CD &lt;= #{pkgEndCd}
      </if>
         INNER JOIN TB_SSCT_CNTR_WELLS_DTL T4
            ON T2.CNTR_DTL_NO = T4.CNTR_NO
           AND T2.CNTR_SN = T4.CNTR_SN
         LEFT OUTER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T5
           ON T2.PRDT_CD = T5.BASE_PD_CD
          AND SUBSTR(#{strtDt},0,6) BETWEEN T5.APY_STRT_YM AND T5.APY_END_YM
        <if test='@MybatisUtils@isNotEmpty(pdctTpCd)'>
          AND ( CASE WHEN T1.OG_TP_CD = 'W01' THEN T5.FEE_PDCT_TP_CD2
                     ELSE T5.FEE_PDCT_TP_CD1
                END ) = #{pdctTpCd}
        </if>
        WHERE T1.BASE_YM = SUBSTR(#{strtDt},0,6)
        <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
            <if test="ogDvCd != 'W06'">
                AND T1.OG_TP_CD  = #{ogDvCd}
            </if>
            <if test='@MybatisUtils@equals(ogDvCd, "W06")'>
                AND T1.OG_TP_CD NOT IN ('W01','W02','W03','W04','W05')
            </if>
        </if>
    </select>

    <select id='selectAggreateNetOrders' resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaNetOrderDto$SearchRes">
        SELECT CASE WHEN T1.OG_TP_CD IN ('W01', 'W02', 'W03', 'W04', 'W05') THEN T8.CD_CNTN
                    ELSE '기타'
               END AS SELL_OG
             , T2.OG_CD AS BLG
             , T1.PRTNR_NO
             , T2.PRTNR_KNM
             , T1.SELL_TP_CD
             , CASE WHEN T1.OG_TP_CD = 'W01' AND NVL(T7.FEE_PDCT_TP_CD2,'0')!= '0' THEN T7.FEE_PDCT_TP_CD2
                    WHEN NVL(T7.FEE_PDCT_TP_CD2,'0') = '0' THEN '등록되지 않은 제품유형'
                    ELSE T7.FEE_PDCT_TP_CD1
               END AS PDCT_TP /* 제품유형 !!!*/
             , T1.CNTR_NO AS CNTR_DTL_NO
             , T2.COPN_DV_CD AS CST_DV
             , T3.PD_NM AS PRDT_NM
             , T1.PD_CD AS PRDT_CD
             , T3.HGR_PD_CD AS PKG_CD
             , T5.ISTM_MCN AS ISTM
             , T1.STPL_PTRM_MCN AS STPL_MCNT
             , SUBSTR(T4.CNTR_CNFM_DTM,0,6) AS CNTR_DATE
             , T1.SL_DT
             , CASE WHEN T5.CNTR_DTL_STAT_CD IN ('301','303') THEN T5.CNTR_PD_ENDDT
                    ELSE '-'
               END AS CAN_DT
             , T6.REQD_DT AS DEM_DT
             , CASE WHEN T1.SELL_TP_CD = '2' THEN T5.SELL_AMT END AS RTLFE  /*계약유형이 렌탈일때만 렌탈료*/
          FROM TB_FEAM_WELS_NRCTR_MM_CL T1
         INNER JOIN TB_OGBS_MM_PRTNR_IZ T2 /* 월파트너 */
            ON T1.BASE_YM = T2.BASE_YM
           AND T1.PRTNR_NO = T2.PRTNR_NO
           AND T1.OG_TP_CD = T2.OG_TP_CD
         INNER JOIN TB_PDBS_PD_BAS T3 /* 상품기본 */
            ON T1.PD_CD = T3.PD_CD
         INNER JOIN TB_SSCT_CNTR_BAS T4
            ON T1.CNTR_NO = T4.CNTR_NO
         INNER JOIN TB_SSCT_CNTR_DTL T5
            ON T1.CNTR_NO = T5.CNTR_NO
           AND T1.CNTR_SN = T5.CNTR_SN
          LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T6
            ON T1.CNTR_NO = T6.CNTR_NO
           AND T1.CNTR_SN = T6.CNTR_SN
          LEFT OUTER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T7
            ON T1.PD_CD = T7.BASE_PD_CD
           AND #{perfYm} BETWEEN T7.APY_STRT_YM AND T7.APY_END_YM
          LEFT OUTER JOIN T_CMZ_CD_D T8
            ON T1.OG_TP_CD = T8.CD_VLD_VAL
           AND T8.CD_ID = 'OG_TP_CD'
           AND T8.TENANT_ID = #{session.tenantId}
         WHERE T1.BASE_YM = #{perfYm} /* 기준년월 */
           AND T1.FEE_TCNT_DV_CD = #{tcntDvCd} /* 차수 */
           AND T1.CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
           AND NVL(T1.ACC_NINC_YN,'N') = 'N'
        <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
           <if test="ogDvCd != 'W06'">
           AND T1.OG_TP_CD  = #{ogDvCd}
           </if>
           <if test='@MybatisUtils@equals(ogDvCd, "W06")'>
           AND T1.OG_TP_CD NOT IN ('W01','W02','W03','W04','W05')
          </if>
      </if>
    </select>

    <select id='selectNetOrderFees' resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaNetOrderDto$SearchFeeRes">
        SELECT CASE WHEN T3.CD_VLD_VAL = 'W06' THEN '기타' ELSE T3.CD_CNTN END AS SELL_OG
             , NVL(M.RENT_CNT + SPAY_CNT + RGLR_CNT + RSTL_CNT + MSH_CNT,0) AS TOT_CT
             , NVL(M.RENT_CNT,0) AS RENTAL
             , NVL(M.SPAY_CNT,0) AS SNGL_PMNT
             , NVL(M.RGLR_CNT,0) AS REG_DLVR
             , NVL(M.RSTL_CNT,0) AS RSTL
             , NVL(M.MSH_CNT,0) AS HCR_MSH
             , NVL(M.ENVR_CNT,0) AS ENVR
             , NVL(M.WELSF_CNT,0) AS WELSF
             , NVL(M.BH_CNT,0) AS BH
             , NVL(M.CAPSL_CNT,0) AS CAPSL
             , NVL(M.HOME_CARE_CNT,0) AS HOME_CARE
             , NVL(M.CSMB_CNT,0) AS CSMB
             , NVL(M.ACSR_CNT,0) AS ACSR
             , NVL(M.NOPD_CNT,0) AS NOPD
           FROM T_CMZ_CD_D T3
           LEFT OUTER JOIN ( SELECT T.OG_TP_CD
                                  , SUM(T.RENT_CNT) AS RENT_CNT
                                  , SUM(T.SPAY_CNT) AS SPAY_CNT
                                  , SUM(T.RGLR_CNT) AS RGLR_CNT
                                  , SUM(T.RSTL_CNT) AS RSTL_CNT
                                  , SUM(T.MSH_CNT) AS MSH_CNT
                                  , SUM(T.ENVR_CNT) AS ENVR_CNT
                                  , SUM(T.WELSF_CNT) AS WELSF_CNT
                                  , SUM(T.BH_CNT) AS BH_CNT
                                  , SUM(T.CAPSL_CNT) AS CAPSL_CNT
                                  , SUM(T.HOME_CARE_CNT) AS HOME_CARE_CNT
                                  , SUM(T.CSMB_CNT) AS CSMB_CNT
                                  , SUM(T.ACSR_CNT) AS ACSR_CNT
                                  , SUM(T.NOPD_CNT) AS NOPD_CNT
                               FROM ( SELECT CASE WHEN ( T1.OG_TP_CD = 'W01' OR T1.OG_TP_CD = 'W02'
                                                            OR T1.OG_TP_CD = 'W03' OR T1.OG_TP_CD = 'W04'
                                                            OR T1.OG_TP_CD = 'W05' ) /* 기타코드가 따로 없음 W06으로 임시처리 */
                                                       THEN T1.OG_TP_CD
                                                  ELSE 'W06'
                                             END AS OG_TP_CD
                                           , T1.SELL_TP_CD
                                           , CASE WHEN T1.SELL_TP_CD = '2' AND NVL(T3.CNTR_NO,'N') = 'N' THEN 1 ELSE 0 END AS RENT_CNT
                                           , CASE WHEN T1.SELL_TP_CD = '1' THEN 1 ELSE 0 END  AS SPAY_CNT
                                           , CASE WHEN T1.SELL_TP_CD = '6' THEN 1 ELSE 0 END  AS RGLR_CNT
                                           , CASE WHEN T1.SELL_TP_CD = '2' AND NVL(T3.CNTR_NO,'N') != 'N' THEN 1 ELSE 0 END  AS RSTL_CNT
                                           , CASE WHEN T1.SELL_TP_CD = '3' THEN 1 ELSE 0 END  AS MSH_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'A' THEN 1
                                                  WHEN T2.FEE_PDCT_TP_CD1 = 'A' THEN 1
                                             END AS ENVR_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'B' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'B' THEN 1
                                             END AS WELSF_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'C' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'C' THEN 1
                                             END AS BH_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'D' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'D' THEN 1
                                             END AS CAPSL_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'E' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'E' THEN 1
                                             END AS HOME_CARE_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'F' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'F' THEN 1
                                             END AS CSMB_CNT
                                           , CASE WHEN T1.OG_TP_CD = 'W01' AND T2.FEE_PDCT_TP_CD2 = 'G' THEN 1
                                                  WHEN T1.OG_TP_CD != 'W01' AND T2.FEE_PDCT_TP_CD1 = 'G' THEN 1
                                             END AS ACSR_CNT
                                           , CASE WHEN T2.FEE_PDCT_TP_CD1 IS NULL AND T2.FEE_PDCT_TP_CD2 IS NULL THEN 1 END AS NOPD_CNT
                                        FROM TB_FEAM_WELS_NRCTR_MM_CL T1
                                       INNER JOIN TB_OGBS_MM_PRTNR_IZ T4 /* 월파트너 */
                                          ON T1.BASE_YM = T4.BASE_YM
                                         AND T1.PRTNR_NO = T4.PRTNR_NO
                                         AND T1.OG_TP_CD = T4.OG_TP_CD
                                        LEFT OUTER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T2
                                          ON T1.PD_CD = T2.BASE_PD_CD
                                         AND #{perfYm} BETWEEN T2.APY_STRT_YM AND T2.APY_END_YM
                                        LEFT OUTER JOIN LATERAL ( SELECT A.CNTR_NO
                                                                       , RANK() OVER (PARTITION BY (A.CNTR_NO) ORDER BY A.STPL_TN DESC) AS RK_NUM
                                                                    FROM TB_SSCT_RENTAL_RSTL_IZ A
                                                                   WHERE A.CNTR_NO = T1.CNTR_NO
                                                                     AND A.CNTR_SN = T1.CNTR_SN
                                                                )T3
                                          ON 1=1
                                         AND T3.RK_NUM = 1
                                       WHERE T1.BASE_YM = #{perfYm} /* 기준년월 */
                                         AND T1.FEE_TCNT_DV_CD = #{tcntDvCd} /* 차수 */
                                         AND T1.CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
                                         AND NVL(T1.ACC_NINC_YN,'N') = 'N'
                                    <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
                                         <if test="ogDvCd != 'W06'">
                                         AND T1.OG_TP_CD  = #{ogDvCd}
                                         </if>
                                         <if test='@MybatisUtils@equals(ogDvCd, "W06")'>
                                         AND T1.OG_TP_CD NOT IN ('W01','W02','W03','W04','W05')
                                         </if>
                                    </if>
                                    )T
                              GROUP BY T.OG_TP_CD
                           )M
             ON M.OG_TP_CD = T3.CD_VLD_VAL
          WHERE T3.CD_ID = 'OG_TP_CD'
            AND T3.TENANT_ID = #{session.tenantId}
        <if test='@MybatisUtils@isEmpty(ogDvCd)'>
            AND T3.CD_VLD_VAL IN ('W01','W02','W03','W04','W05','W06')
        </if>
        <if test='@MybatisUtils@isNotEmpty(ogDvCd)'>
            AND T3.CD_VLD_VAL  = #{ogDvCd}
        </if>
          ORDER BY T3.CD_VLD_VAL
    </select>

    <select id='selectNetAggregateConfirm' resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaNetOrderDto$SearchConfirmRes">
        SELECT CASE WHEN NTOR_CNFM_STAT_CD = '02' THEN 'Y'
                    ELSE 'N'
               END AS CNFM_CHK
          FROM TB_FEAM_NRCTR_MM_CL T1
         WHERE BASE_YM = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM')
           AND T1.FEE_TCNT_DV_CD =  #{tcntDvCd} /* 차수 */
           AND T1.CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
    </select>

    <update id="updateNetOrders">
        UPDATE TB_FEAM_NRCTR_MM_CL
           SET NTOR_CNFM_STAT_CD = '02' /* 확정 */
         WHERE BASE_YM = #{perfYm}
           AND FEE_TCNT_DV_CD = #{tcntDvCd} /* 차수 */
           AND CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
           AND NTOR_CNFM_STAT_CD = '01' /* 임시 */
    </update>

</mapper>
