<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.aggregate.mapper.WfeaOrganizationNetOrderMapper">

    <select id='selectHomeMasters'
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaOrganizationNetOrderDto$SearchHmstRes">
        SELECT T.DGR2_LEVL_OG_NM AS OG2_LV
             , T.DGR3_LEVL_OG_NM AS OG3_LV
             , T.PRTNR_NO AS SEQUENCE_NUMBER /* 번호 !!!*/
             , T.PRTNR_KNM AS EMPL_NM /* 성명 !!!*/
             , T.SELL_TP_CD AS SEL_TYPE /* 판매유형 !!!*/
             , T.FEE_PERF_TP_CD AS PDCT_TP  /* 제품유형 !!!*/
             , T.RGLR_SPP_PRC_DV_CD AS PRC_TP  /* 가격유형 !!!*/
             , T.MCHN_CH_TP_CD AS CHDVC_TP  /* 기변유형 !!!*/
             , T.FEE_PDCT_TP_CD AS FEE  /* 수수료 실적유형 !!!*/
             , T.CNTR_DTL_CD AS CNTR_DTL_NO   /* 계약상세번호 !!!*/
             , T.LCCGUB AS CST_DV   /* 고객구분 !!!*/
             , T.PD_NM AS PRDT_NM    /* 상품명 !!!*/
             , T.PD_CD AS PRDT_CODE    /* 상품코드 !!!*/
             , CASE WHEN T.SELL_TP_CD = '1' THEN F_CMZ_CD_NM(#{session.tenantId}, 'SPAY_DSC_DV_CD', T.LCETC3)
                    WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_DSC_DV_CD', T.LCETC3)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'MSH_DSC_DV_CD', T.LCETC3)
                    ELSE T.LCETC3
               END AS PD_DC_CLASS /* 할인구분 !!!*/
             , CASE WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_CRP_DSCR_CD', T.LCETC4)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'PMOT_CD', T.LCETC4)
                    ELSE T.LCETC4
               END AS DISC_CODE /* 할인유형 !!!*/
             , CASE WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_DSC_TP_CD', T.SELL_DSC_TP_CD)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'MSH_DSC_TP_CD', T.SELL_DSC_TP_CD)
                    ELSE T.SELL_DSC_TP_CD END AS DSC_SYST /* 할인제도 !!!*/
             , T.LCST04 AS COMBI_DV /* 결합구분 !!!*/
             , T.LCMONT AS ISTM  /* 할부 !!!*/
             , T.STPL_PTRM AS STPL_MCNT           /* 약정개월 !!!*/
             , T.LCFLG3 AS MNGT_PRD          /* 관리주기 !!!*/
             , T.LCPAMT AS PD_ACC_RSLT   /* 인정실적 !!!*/
             , T.LCBAMT AS BASE_PRC  /* 기준가격 !!!*/
             , T.HOMCARE AS HOME_CARE /* 홈케어 !!!*/
             , T.HOMCARE3_YEAR AS HCR_MSH_Y3 /* 홈케어멤버십3년 !!!!*/
             , T.LCST13 AS FXAM_YN /* 정액여부 !!!*/
             , T.LEASE_YN AS FNN_LEASE /* 금융리스  일단임시 */
             , T.LCPCNT AS ELHM_ACKMT_CT /* 가정 인정건수 !!!*/
             , T.NEW_LCPCNT AS NW_SELL_CT /* 신규판매건수  일단임시*/
             , T.BS_DAESANG AS OBJ /* BS대상 !!!!*/
             , T.RSTL_YN AS RECOMMITMENT           /* 재약정여부 !!!*/
             , T.LCCRTT AS CNTR_DATE /* 계약일자 !!!*/
             , T.LCSLET AS SL_DT /* 매출일자 !!!*/
             , T.LCCANT AS CANC_DT /* 취소일자 !!!*/
             , T.LCDELDT AS DEM_DT /* 철거일자 일단 임시*/
             , T.AKDBON AS BRMGR_NO /* 지점장번호 !!!*/
             , T.AKDBNM AS BRMGR_FNM /* 지점장성명 !!!*/
             , T.LCAMT1 AS RTLFE /* 렌탈료 !!!*/
             , T.LCCK02 AS PMOT_NO /* 프로모션번호!!!!! */
             , T.LCRCDE AS PKG_PD_NO /*패키지 상품번호!!!!!*/
             , '0' AS PKG_SN    /* 패키지 일련번호!!!!! */
             , T.INTM_ORDR_NO AS MCHN_PRTNR /* 기기고객코드!!!! */
             , CASE WHEN NVL(T.INTM_ORDR_PRDT,'0') != '0'
                         THEN SUBSTR(T.INTM_ORDR_PRDT,2,4)||'-'||SUBSTR(T.INTM_ORDR_PRDT,6,8)
               END AS MCHN_PD /* 기기상품코드!!! */
             , NVL(T.EX_YN,'N') AS PERF_EXCD /*실적제외등록여부!!! */
          FROM ( SELECT MO.DGR2_LEVL_OG_NM
                      , MO.DGR3_LEVL_OG_NM
                      , MP.PRTNR_NO  /* 번호 !!!*/
                      , MP.PRTNR_KNM  /* 성명 !!!*/
                      , CD.SELL_TP_CD /* 판매유형 !!!*/
                      , PF.FEE_PERF_TP_CD  /* 제품유형 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '6' THEN PSP.RGLR_SPP_PRC_DV_CD END AS RGLR_SPP_PRC_DV_CD  /* 가격유형 !!!*/
                      , MC.MCHN_CH_TP_CD  /* 기변유형 !!!*/
                      , PF.FEE_PDCT_TP_CD  /* 수수료 실적유형 !!!*/
                      , CD.CNTR_NO||CD.CNTR_SN AS CNTR_DTL_CD   /* 계약상세번호 !!!*/
                      , CASE WHEN CB.COPN_DV_CD = '2' THEN  '사업' ELSE '개인' END AS LCCGUB    /* 고객구분 !!!*/
                      , PP.PD_NM     /* 상품명 !!!*/
                      , PP.PD_CD     /* 상품코드 !!!*/
                      , CD.SELL_DSC_DV_CD AS LCETC3  /* 할인구분 !!!*/
                      , CD.SELL_DSCR_CD AS LCETC4  /* 할인유형 !!!*/
                      , CD.SELL_DSC_TP_CD /* 할인제도 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '2' AND (
                                SELECT 1
                                  FROM TB_SSCT_CNTR_REL SCR
                                 INNER JOIN TB_SSCT_CNTR_DTL CD2
                                    ON CD2.CNTR_NO = SCR.BASE_DTL_CNTR_NO
                                   AND CD2.CNTR_SN = SCR.BASE_DTL_CNTR_SN
                                   AND CD2.SELL_TP_CD = '6'                /* 정기배송 */
                                 WHERE SCR.OJ_DTL_CNTR_NO = CD.CNTR_NO
                                   AND SCR.OJ_DTL_CNTR_SN = CD.CNTR_SN
                                   AND SCR.VL_END_DTM = '99991231235959'
                                   AND SCR.DTA_DL_YN = 'N'
                                   AND SCR.CNTR_REL_DTL_CD = '216' /* 모종의 경우만 결합 구분 */
                                   AND ROWNUM = 1) > 0
                             THEN 'Y' END AS LCST04 /* 결합구분 !!!*/
                      , CD.ISTM_MCN AS LCMONT   /* 할부 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '1' THEN 0
                             ELSE CD.STPL_PTRM END AS STPL_PTRM /* 약정개월 !!!*/
                      , CD.SV_PRD AS LCFLG3           /* 관리주기 !!!*/
                      , CD.ACKMT_PERF_AMT AS LCPAMT   /* 인정실적 !!!*/
                      , CD.FEE_ACKMT_BASE_AMT AS LCBAMT   /* 기준가격 !!!*/
                      , CASE WHEN PF.FEE_PDCT_TP_CD = 'E' THEN ( CASE WHEN CD.SELL_TP_CD = '6' THEN (CD.SELL_AMT- CD.CNTRAM_DSC_AMT) / CD.SV_PRD
                                                                      ELSE CD.SELL_AMT
                                                                 END )
                             ELSE 0
                        END AS HOMCARE /* 홈케어 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '3' AND CD.STPL_PTRM = '36' THEN 'Y'
                             ELSE ' '
                        END  AS HOMCARE3_YEAR /* 홈케어멤버십3년 !!!!*/
                      , CD.FEE_FXAM_YN AS LCST13 /* 정액여부 !!!*/
                      , CASE WHEN CD.SELL_TP_DTL_CD IN ('22','24','25') THEN 'Y' ELSE 'N' END AS LEASE_YN  /* 금융리스 !!! */
                      , CASE WHEN CD.SELL_TP_CD IN ('1', '6') THEN CD.FEE_ACKMT_CT
                             WHEN CD.SELL_TP_CD = '2' THEN ( CASE WHEN NVL(MC.OJ_CNTR_NO, '0') != '0' AND MC.MCHN_CH_TP_CD IN ('1','18') THEN 0
                                                                  ELSE CD.FEE_ACKMT_CT
                                                             END )
                             WHEN CD.SELL_TP_CD = '3' THEN ( CASE WHEN CD.CNTRW_TP_CD = '5' AND CD.SELL_TP_DTL_CD = '33' AND CP.PMOT_CD = 'P1' THEN 1
                                                                  ELSE 0
                                                             END )
                        END AS LCPCNT /* 가정 인정건수 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '1' THEN
                            CASE WHEN NVL(PD.ENVR_SFT_YN, 'N') = 'Y'
                                  AND CD.SELL_TP_DTL_CD != '12'
                                  AND CD.FEE_FXAM_YN = 'N'
                                  AND CD.ACKMT_PERF_AMT > 0
                                  AND CD.FEE_ACKMT_CT > 0
                                  AND NVL(WS.ROW_SCNT, 0) > 0 THEN 1 ELSE 0 END /* 일시불-신규건수 */
                             WHEN CD.SELL_TP_CD = '2' THEN
                            CASE WHEN PC.REF_PD_CLSF_VAL NOT IN ('05003002')
                                AND NVL(EX.EX_SCNT, 0) = 0
                                AND MC.MCHN_CH_TP_CD IS NULL
                                AND CD.ACKMT_PERF_AMT > 0
                                AND CD.FEE_ACKMT_CT > 0
                                AND NVL(WS.ROW_SCNT, 0) > 0 THEN 1 ELSE 0 END /* 렌탈-신규건수 */
                             WHEN CD.SELL_TP_CD = '3' THEN 0
                             ELSE 0 END AS NEW_LCPCNT
                      , CASE WHEN WS.ROW_SCNT >= 1 THEN 'Y' END AS BS_DAESANG /* BS대상 !!!!*/
                      , CD.RSTL_YN            /* 재약정여부 !!!*/
                      , CB.CNTR_CNFM_DTM AS LCCRTT /* 계약일자 !!!*/
                      , SUBSTR(CD.CNTR_PD_STRTDT,1,8) AS LCSLET /* 매출일자 !!!*/
                      , CASE WHEN CD.CNTR_DTL_STAT_CD IN ('301','303') THEN CNTR_PD_ENDDT END AS LCCANT  /* 취소일자 !!!*/
                      , WD.REQD_DT AS LCDELDT  /* 철거일자!!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NO AS AKDBON /* 지점장번호 !!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NM AS AKDBNM /* 지점장성명 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '6' THEN CD.FNL_AMT / CD.SV_PRD
                             ELSE CD.FNL_AMT END AS LCAMT1 /* 렌탈료 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN CP.PMOT_CD
                             ELSE '0'
                        END AS LCCK02 /* 프로모션번호!!!!! */
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN CD.HGR_PD_CD
                             ELSE '0'
                        END AS LCRCDE /*패키지 상품번호!!!!!*/
                      , CASE WHEN CD.SELL_TP_CD = '6' THEN SUBSTR(CB.CNTR_NO,2,4) ||'-'||SUBSTR(CB.CNTR_NO,6,7)
                        END AS INTM_ORDR_NO /* 기기고객코드!!!! */
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN (SELECT CR.BASE_DTL_CNTR_NO /* 렌탈의 경우 정기배송 모종 계약 찾기 */
                                                              FROM TB_SSCT_CNTR_REL CR
                                                             WHERE CR.OJ_DTL_CNTR_NO = CD.CNTR_NO
                                                               AND CR.OJ_DTL_CNTR_SN = CD.CNTR_SN
                                                               AND CR.CNTR_REL_DTL_CD IN ('214','216') /* 정기배송, 모종의 경우만 기기코드 표기*/
                                                               AND ROWNUM = 1)
                             WHEN CD.SElL_TP_CD = '6' THEN (SELECT CR.OJ_DTL_CNTR_NO /* 모종 정기배송의 경우 렌탈 계약 찾기 */
                                                              FROM TB_SSCT_CNTR_REL CR
                                                             WHERE CR.BASE_DTL_CNTR_NO = CD.CNTR_NO
                                                               AND CR.BASE_DTL_CNTR_SN = CD.CNTR_SN
                                                               AND CR.CNTR_REL_DTL_CD IN ('214','216') /* 정기배송, 모종의 경우만 기기코드 표기*/
                                                               AND ROWNUM = 1)
                        END AS INTM_ORDR_PRDT/* 기기코드!!! */
                      , CASE WHEN EX.EX_SCNT = 1 THEN 'Y'
                        END AS EX_YN  /*실적제외등록여부!!! */
                   FROM TB_SSCT_CNTR_BAS CB
                  INNER JOIN TB_SSCT_CNTR_DTL CD
                     ON CB.CNTR_NO = CD.CNTR_NO
                    AND CD.CNTRW_TP_CD = (CASE WHEN CD.SELL_TP_CD = '3' THEN '5' ELSE CD.CNTRW_TP_CD END)
                    AND CD.DTA_DL_YN = 'N'
               <if test='@MybatisUtils@equals(sellTpCd, "0")'>
                    AND CD.SELL_TP_CD IN ('1','2','3','6')
               </if>
               <if test='@MybatisUtils@equals(sellTpCd, "7")'>
                    AND 1 = 2 /* 재약정은 따로 조회*/
               </if>
               <if test='!@MybatisUtils@equals(sellTpCd, "0") and !@MybatisUtils@equals(sellTpCd, "7")'>
                    AND CD.SELL_TP_CD = #{sellTpCd}
               </if>
               <if test='@MybatisUtils@equals(divCd, "03")'> /* 예약 */
                    AND CD.BOO_SELL_TP_CD = '2'
               </if>
               <if test='@MybatisUtils@equals(divCd, "01")'> /* 매출 */
                    AND NVL(CD.BOO_SELL_TP_CD,0) != '2'
               </if>

               <choose>
                   <when test='@MybatisUtils@isNotEmpty(pkgStrtCd) and @MybatisUtils@isNotEmpty(pkgEndCd)'>
                       AND (CD.HGR_PD_CD BETWEEN #{pkgStrtCd} AND #{pkgEndCd} OR CD.HGR_PD_CD BETWEEN #{pkgEndCd} AND #{pkgStrtCd})
                   </when>
                   <when test='@MybatisUtils@isNotEmpty(pkgStrtCd)'>
                       AND CD.HGR_PD_CD &gt;= #{pkgStrtCd}
                   </when>
                   <when test='@MybatisUtils@isNotEmpty(pkgEndCd)'>
                       AND CD.HGR_PD_CD &lt;= #{pkgEndCd}
                   </when>
               </choose>

               <if test='@MybatisUtils@equals(divCd, "01")'> /* 매출 */
                    AND TO_CHAR(TO_DATE(CD.CNTR_PD_STRTDT),'YYYYMMDD') BETWEEN #{strtDt} AND #{endDt}  /* 매출 확정일자 */
               </if>
                  INNER JOIN TB_OGBS_MM_PRTNR_IZ MP  /* 월파트너 */
                     ON CB.SELL_PRTNR_NO = MP.PRTNR_NO
                    AND CB.SELL_OG_TP_CD = MP.OG_TP_CD
                    AND MP.BASE_YM = SUBSTR(#{strtDt},1,6)
               <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                    AND MP.PRTNR_NO = #{prtnrNo}
               </if>
                  INNER JOIN TB_OGBS_MM_OG_IZ MO  /* 월조직 */
                     ON MP.BASE_YM = MO.BASE_YM
                    AND MP.OG_ID = MO.OG_ID
                    AND MP.OG_TP_CD = MO.OG_TP_CD
               <if test='@MybatisUtils@isNotEmpty(og1LevlId)'>
                    AND MO.DGR1_LEVL_OG_ID = #{og1LevlId}
               </if>
               <if test='@MybatisUtils@isNotEmpty(og2LevlId)'>
                    AND MO.DGR2_LEVL_OG_ID = #{og2LevlId}
               </if>
               <if test='@MybatisUtils@isNotEmpty(og3LevlId)'>
                    AND MO.DGR3_LEVL_OG_ID = #{og3LevlId}
               </if>
                  INNER JOIN TB_PDBS_PD_BAS PP
                     ON CD.BASE_PD_CD = PP.PD_CD
                     <choose>
                         <when test='@MybatisUtils@isNotEmpty(pdStrtCd) and @MybatisUtils@isNotEmpty(pdEndCd)'>
                             AND (PP.PD_CD BETWEEN #{pdStrtCd} AND #{pdEndCd} OR PP.PD_CD BETWEEN #{pdEndCd} AND #{pdStrtCd})
                         </when>
                         <when test='@MybatisUtils@isNotEmpty(pdStrtCd)'>
                             AND PP.PD_CD &gt;= #{pdStrtCd}
                         </when>
                         <when test='@MybatisUtils@isNotEmpty(pdEndCd)'>
                             AND PP.PD_CD &lt;=  #{pdEndCd}
                         </when>
                     </choose>
                  INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS PD
                     ON CD.BASE_PD_CD = PD.BASE_PD_CD
                    AND SUBSTR(#{strtDt},1,6) BETWEEN APY_STRT_YM AND APY_END_YM
                  INNER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS PF
                     ON PD.FEE_PDCT_TP_CD1 = PF.FEE_PDCT_TP_CD
                    AND CD.SELL_TP_CD = PF.SELL_TP_CD
               <if test='@MybatisUtils@isNotEmpty(pdctTpCd)'>
                    AND PF.FEE_PDCT_TP_CD = #{pdctTpCd}
               </if>
               <if test='@MybatisUtils@isNotEmpty(feePerfCd)'>
                    AND PF.FEE_PERF_TP_CD = #{feePerfCd}
               </if>
                   LEFT OUTER JOIN TB_PDBS_SDING_PRC_BAS PSP
                     ON CD.BASE_PD_CD = PSP.PDCT_PD_CD
                    AND CB.CNTR_CNFM_DTM BETWEEN PSP.APY_STRTDT AND PSP.APY_ENDDT
                   LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ MC
                     ON CD.CNTR_NO = MC.BASE_CNTR_NO
                    AND CD.CNTR_SN = MC.BASE_CNTR_SN
                   LEFT OUTER JOIN LATERAL ( SELECT A.PMOT_CD
                                                  , A.PMOT_TP_CD
                                                  , RANK() OVER (PARTITION BY (A.DTL_CNTR_NO || A.DTL_CNTR_SN) ORDER BY CNTR_PMOT_ID DESC) AS RK_NUM
                                               FROM TB_SSCT_CNTR_PMOT_IZ A
                                              WHERE A.DTL_CNTR_NO = CD.CNTR_NO
                                                AND A.DTL_CNTR_SN = CD.CNTR_SN
                                           )CP /* T프로모션 계약내역T */
                     ON 1=1
                    AND CP.RK_NUM = 1
                   LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL WD
                     ON CD.CNTR_NO = WD.CNTR_NO
                    AND CD.CNTR_SN = WD.CNTR_SN
                   LEFT OUTER JOIN (
                            SELECT PD_CD
                                 , PD_PRP_VAL11 AS ENVR_SFT_YN
                              FROM TB_PDBS_PD_ECOM_PRP_DTL
                             WHERE DTA_DL_YN = 'N'
                               AND PD_EXTS_PRP_GRP_CD = 'IND'
                        ) PD
                     ON PD.PD_CD = CD.BASE_PD_CD
                   LEFT OUTER JOIN TB_PDBS_PD_CLSF_BAS PC /* 상품분류기본 */
                     ON PC.PD_CLSF_ID = CD.PD_LCLSF_ID
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS ROW_SCNT
                                               FROM TB_FEAM_WELS_SV_FEE_BAS A
                                              WHERE A.BASE_PD_CD = CD.BASE_PD_CD
                                                AND A.VST_MCN = 0
                                                AND SUBSTR(CB.CNTR_CNFM_DTM,1,6) BETWEEN A.APY_STRT_YM AND A.APY_END_YM
                                           )WS
                     ON 1=1
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS EX_SCNT
                                               FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS A
                                              WHERE A.CNTR_NO = CD.CNTR_NO
                                                AND A.CNTR_SN = CD.CNTR_SN
                                                AND A.FEE_PERF_EXCD_DV_CD = '01'
                                           )EX
                     ON 1=1
                  WHERE CB.SELL_OG_TP_CD   = 'W03'
                    AND CB.DTA_DL_YN = 'N'
               <if test='!@MybatisUtils@equals(divCd, "01")'>
                    AND CB.CNTR_CNFM_DTM BETWEEN #{strtDt} AND  #{endDt} /* 계약확정일시 */
               </if>

               <choose>
                   <when test='@MybatisUtils@isNotEmpty(cancStrtDt) and @MybatisUtils@isNotEmpty(cancEndDt)'>
                       AND CD.CNTR_DTL_STAT_CD IN ('301','303')
                       AND (CD.CNTR_PD_ENDDT BETWEEN #{cancStrtDt} AND #{cancEndDt} OR CD.CNTR_PD_ENDDT BETWEEN #{cancEndDt} AND #{cancStrtDt})
                   </when>
                   <when test='@MybatisUtils@isNotEmpty(cancStrtDt)'>
                       AND (CD.CNTR_DTL_STAT_CD IN ('301','303') AND CD.CNTR_PD_ENDDT <![CDATA[>=]]> #{cancStrtDt})
                   </when>
                   <when test='@MybatisUtils@isNotEmpty(cancEndDt)'>
                       AND (CD.CNTR_DTL_STAT_CD IN ('301','303') AND CD.CNTR_PD_ENDDT <![CDATA[<=]]> #{cancEndDt})
                   </when>
               </choose>

               <if test='@MybatisUtils@equals(sellTpCd, "0") or @MybatisUtils@equals(sellTpCd, "7")'>
                   <if test='!@MybatisUtils@equals(divCd, "02")'>
                  UNION ALL
                 SELECT MO.DGR2_LEVL_OG_NM
                      , MO.DGR3_LEVL_OG_NM
                      , MP.PRTNR_NO  /* 번호 !!!*/
                      , MP.PRTNR_KNM  /* 성명 !!!*/
                      , CD.SELL_TP_CD /* 판매유형 !!!*/
                      , PF.FEE_PERF_TP_CD  /* 제품유형 !!!*/
                      , '' AS RGLR_SPP_PRC_DV_CD  /* 가격유형 !!!*/
                      , MC.MCHN_CH_TP_CD  /* 기변유형 !!!*/
                      , PF.FEE_PDCT_TP_CD  /* 수수료 실적유형 !!!*/
                      , CD.CNTR_NO||CD.CNTR_SN AS CNTR_DTL_CD    /* 계약상세번호 !!!*/
                      , CASE WHEN CB.COPN_DV_CD = '2' THEN  '사업' ELSE '개인' END AS LCCGUB    /* 고객구분 !!!*/
                      , PP.PD_NM     /* 상품명 !!!*/
                      , PP.PD_CD     /* 상품코드 !!!*/
                      , CD.SELL_DSC_DV_CD AS LCETC3  /* 할인구분 !!!*/
                      , CD.SELL_DSCR_CD AS LCETC4  /* 할인유형 !!!*/
                      , CD.SELL_DSC_TP_CD AS PMOT_TP_CD /* 할인제도 !!!*/
                      , '' AS LCST04 /* 결합구분 !!!*/
                      , CD.ISTM_MCN AS LCMONT   /* 할부 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '1' THEN 0
                             ELSE CD.STPL_PTRM END AS STPL_PTRM /* 약정개월 !!!*/
                      , CD.SV_PRD AS LCFLG3           /* 관리주기 !!!*/
                      , CD.ACKMT_PERF_AMT AS LCPAMT   /* 인정실적 !!!*/
                      , CD.FEE_ACKMT_BASE_AMT AS LCBAMT   /* 기준가격 !!!*/
                      , 0 AS HOMCARE /* 홈케어 !!!*/
                      , '' AS HOMCARE3_YEAR /* 홈케어멤버십3년 !!!!*/
                      , CD.FEE_FXAM_YN AS LCST13 /* 정액여부 !!!*/
                      , CASE WHEN CD.SELL_TP_DTL_CD IN ('22','24','25') THEN 'Y' ELSE 'N' END AS LEASE_YN  /* 금융리스 !!! */
                      , CD.FEE_ACKMT_CT AS LCPCNT /* 가정 인정건수 !!!*/
                      , 0    AS NEW_LCPCNT /* 신규판매건수  일단임시*/
                      , CASE WHEN WS.ROW_SCNT >= 1 THEN 'Y' END  AS BS_DAESANG /* BS대상 !!!!*/
                      , CD.RSTL_YN            /* 재약정여부 !!!*/
                      , RI.STPL_STRTDT AS LCCRTT /* 계약일자 !!!*/
                      , SUBSTR(RI.STPL_CNFM_DTM,1,8) AS LCSLET /* 매출일자 !!!*/
                      , CASE WHEN CD.CNTR_DTL_STAT_CD IN ('301','303') THEN CNTR_PD_ENDDT END AS LCCANT  /* 취소일자 !!!*/
                      , WD.REQD_DT AS LCDELDT  /* 철거일자!!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NO AS AKDBON /* 지점장번호 !!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NM AS AKDBNM /* 지점장성명 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '6' THEN CD.FNL_AMT / CD.SV_PRD
                             ELSE CD.FNL_AMT END AS LCAMT1 /* 렌탈료 !!!*/
                      , '0' AS LCCK02 /* 프로모션번호!!!!! */
                      , '' AS LCRCDE /*패키지 상품번호!!!!!*/
                      , '' AS INTM_ORDR_NO /* 기기고객코드!!!! */
                      , '' AS INTM_ORDR_PRDT/* 기기상품코드!!! */
                      , CASE WHEN EX.EX_SCNT = 1 THEN 'Y' END AS EX_YN  /*실적제외등록여부!!! */
                   FROM ( SELECT A.CNTR_NO
                               , A.CNTR_SN
                               , A.STPL_STRTDT
                               , A.STPL_CNFM_DTM
                               , A.RCP_PRTNR_NO
                               , A.RCP_OG_TP_CD
                               , RANK() OVER (PARTITION BY (A.CNTR_NO) ORDER BY A.STPL_TN DESC) AS RK_NUM
                            FROM TB_SSCT_RENTAL_RSTL_IZ A
                           WHERE 1=1
                             AND A.RCP_OG_TP_CD = 'W03'
                        <if test='!@MybatisUtils@equals(divCd, "01")'>
                             AND A.STPL_STRTDT BETWEEN #{strtDt} AND  #{endDt} /* 계약확정일시 */
                        </if>
                        <if test='@MybatisUtils@equals(divCd, "01")'> /* 매출 */
                             AND SUBSTR(A.STPL_CNFM_DTM,1,6) BETWEEN #{strtDt} AND #{endDt}  /* 매출 확정일자 */
                        </if>

                        <choose>
                            <when test='@MybatisUtils@isNotEmpty(cancStrtDt) and @MybatisUtils@isNotEmpty(cancEndDt)'>
                                AND (A.STPL_CAN_DTM BETWEEN #{cancStrtDt} AND #{cancEndDt} OR A.STPL_CAN_DTM BETWEEN #{cancEndDt} AND #{cancStrtDt})
                            </when>
                            <when test='@MybatisUtils@isNotEmpty(cancStrtDt)'>
                                AND A.STPL_CAN_DTM &gt;= #{cancStrtDt}
                            </when>
                            <when test='@MybatisUtils@isNotEmpty(cancEndDt)'>
                                AND A.STPL_CAN_DTM &lt;= #{cancEndDt}
                            </when>
                        </choose>
                       )RI
                  INNER JOIN TB_SSCT_CNTR_BAS CB
                     ON RI.CNTR_NO = CB.CNTR_NO
                    AND RI.RCP_OG_TP_CD = CB.SELL_OG_TP_CD
                    AND CB.DTA_DL_YN = 'N'
                  INNER JOIN TB_SSCT_CNTR_DTL CD
                     ON RI.CNTR_NO = CD.CNTR_NO
                    AND RI.CNTR_SN = CD.CNTR_SN
                    AND CD.DTA_DL_YN = 'N'
                    AND CD.SELL_TP_CD = '2'
                        <if test='@MybatisUtils@equals(divCd, "03")'> /* 예약 */
                    AND CD.BOO_SELL_TP_CD = '2'
                        </if>
                        <if test='@MybatisUtils@equals(divCd, "01")'> /* 매출 */
                    AND NVL(CD.BOO_SELL_TP_CD,0) != '2'
                        </if>

                       <choose>
                           <when test='@MybatisUtils@isNotEmpty(pkgStrtCd) and @MybatisUtils@isNotEmpty(pkgEndCd)'>
                               AND (CD.HGR_PD_CD BETWEEN #{pkgStrtCd} AND #{pkgEndCd} OR CD.HGR_PD_CD BETWEEN #{pkgEndCd} AND #{pkgStrtCd})
                           </when>
                           <when test='@MybatisUtils@isNotEmpty(pkgStrtCd)'>
                               AND CD.HGR_PD_CD &gt;= #{pkgStrtCd}
                           </when>
                           <when test='@MybatisUtils@isNotEmpty(pkgEndCd)'>
                               AND CD.HGR_PD_CD &lt;= #{pkgEndCd}
                           </when>
                       </choose>

                        <if test='@MybatisUtils@equals(divCd, "01")'> /* 매출 */
                    AND TO_CHAR(TO_DATE(CD.CNTR_PD_STRTDT),'YYYYMMDD') BETWEEN #{strtDt} AND #{endDt}  /* 매출 확정일자 */
                        </if>
                  INNER JOIN TB_OGBS_MM_PRTNR_IZ MP  /* 월파트너 */
                     ON RI.RCP_PRTNR_NO = MP.PRTNR_NO
                    AND RI.RCP_OG_TP_CD = MP.OG_TP_CD
                    AND MP.BASE_YM = SUBSTR(#{strtDt},1,6)
                        <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                    AND MP.PRTNR_NO = #{prtnrNo}
                        </if>
                  INNER JOIN TB_OGBS_MM_OG_IZ MO  /* 월조직 */
                     ON MP.BASE_YM = MO.BASE_YM
                    AND MP.OG_ID = MO.OG_ID
                    AND MP.OG_TP_CD = MO.OG_TP_CD
                        <if test='@MybatisUtils@isNotEmpty(og1LevlId)'>
                    AND MO.DGR1_LEVL_OG_ID = #{og1LevlId}
                        </if>
                        <if test='@MybatisUtils@isNotEmpty(og2LevlId)'>
                    AND MO.DGR2_LEVL_OG_ID = #{og2LevlId}
                        </if>
                        <if test='@MybatisUtils@isNotEmpty(og3LevlId)'>
                    AND MO.DGR3_LEVL_OG_ID = #{og3LevlId}
                        </if>
                  INNER JOIN TB_PDBS_PD_BAS PP
                     ON CD.BASE_PD_CD = PP.PD_CD
                     <choose>
                         <when test='@MybatisUtils@isNotEmpty(pdStrtCd) and @MybatisUtils@isNotEmpty(pdEndCd)'>
                             AND (PP.PD_CD BETWEEN #{pdStrtCd} AND #{pdEndCd} OR PP.PD_CD BETWEEN #{pdEndCd} AND #{pdStrtCd})
                         </when>
                         <when test='@MybatisUtils@isNotEmpty(pdStrtCd)'>
                             AND PP.PD_CD &gt;= #{pdStrtCd}
                         </when>
                         <when test='@MybatisUtils@isNotEmpty(pdEndCd)'>
                             AND PP.PD_CD &lt;=  #{pdEndCd}
                         </when>
                     </choose>
                  INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS PD
                     ON CD.BASE_PD_CD = PD.BASE_PD_CD
                    AND SUBSTR(#{strtDt},1,6) BETWEEN APY_STRT_YM AND APY_END_YM
                  INNER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS PF
                     ON PD.FEE_PDCT_TP_CD1 = PF.FEE_PDCT_TP_CD
                    AND CD.SELL_TP_CD = PF.SELL_TP_CD
                        <if test='@MybatisUtils@isNotEmpty(pdctTpCd)'>
                    AND PF.FEE_PDCT_TP_CD = #{pdctTpCd}
                        </if>
                        <if test='@MybatisUtils@isNotEmpty(feePerfCd)'>
                    AND PF.FEE_PERF_TP_CD = #{feePerfCd}
                        </if>
                   LEFT OUTER JOIN TB_PDBS_SDING_PRC_BAS PSP
                     ON CD.BASE_PD_CD = PSP.PDCT_PD_CD
                    AND RI.STPL_STRTDT BETWEEN PSP.APY_STRTDT AND PSP.APY_ENDDT
                   LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ MC
                     ON RI.CNTR_NO = MC.BASE_CNTR_NO
                    AND RI.CNTR_SN = MC.BASE_CNTR_SN
                   LEFT OUTER JOIN LATERAL ( SELECT A.PMOT_CD
                                                  , A.PMOT_TP_CD
                                                  , RANK() OVER (PARTITION BY (A.DTL_CNTR_NO || A.DTL_CNTR_SN) ORDER BY CNTR_PMOT_ID DESC) AS RK_NUM
                                               FROM TB_SSCT_CNTR_PMOT_IZ A
                                              WHERE A.DTL_CNTR_NO = RI.CNTR_NO
                                                AND A.DTL_CNTR_SN = RI.CNTR_SN
                                           )CP /* T프로모션 계약내역T */
                     ON 1=1
                    AND CP.RK_NUM = 1
                   LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL WD
                     ON RI.CNTR_NO = WD.CNTR_NO
                    AND RI.CNTR_SN = WD.CNTR_SN
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS ROW_SCNT
                                               FROM TB_FEAM_WELS_SV_FEE_BAS A
                                              WHERE A.BASE_PD_CD = CD.BASE_PD_CD
                                                AND A.VST_MCN = 0
                                                AND SUBSTR(RI.STPL_STRTDT,1,6) BETWEEN A.APY_STRT_YM AND A.APY_END_YM
                                           )WS
                     ON 1=1
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS EX_SCNT
                                               FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS A
                                              WHERE A.CNTR_NO = RI.CNTR_NO
                                                AND A.CNTR_SN = RI.CNTR_SN
                                                AND A.FEE_PERF_EXCD_DV_CD = '01'
                                           )EX
                     ON 1=1
                  WHERE RI.RK_NUM = 1
                   </if>
               </if>
               ) T
    </select>

    <select id='selectHomeMasterFees'
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaOrganizationNetOrderDto$SearchHmstFeeRes">
        SELECT T.DGR2_LEVL_OG_NM AS OG2_LV
             , T.DGR3_LEVL_OG_NM AS OG3_LV
             , T.PRTNR_NO AS SEQUENCE_NUMBER /* 번호 !!!*/
             , T.PRTNR_KNM AS EMPL_NM /* 성명 !!!*/
             , T.SELL_TP_CD AS SEL_TYPE /* 판매유형 !!!*/
             , T.FEE_PERF_TP_CD AS PDCT_TP  /* 제품유형 !!!*/
             , T.RGLR_SPP_PRC_DV_CD AS PRC_TP  /* 가격유형 !!!*/
             , T.MCHN_CH_TP_CD AS CHDVC_TP  /* 기변유형 !!!*/
             , T.FEE_PDCT_TP_CD AS FEE  /* 수수료 실적유형 !!!*/
             , T.CNTR_DTL_CD AS CNTR_DTL_NO   /* 계약상세번호 !!!*/
             , T.LCCGUB AS CST_DV   /* 고객구분 !!!*/
             , T.PD_NM AS PRDT_NM    /* 상품명 !!!*/
             , T.PD_CD AS PRDT_CODE    /* 상품코드 !!!*/
             , CASE WHEN T.SELL_TP_CD = '1' THEN F_CMZ_CD_NM(#{session.tenantId}, 'SPAY_DSC_DV_CD', T.LCETC3)
                    WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_DSC_DV_CD', T.LCETC3)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'MSH_DSC_DV_CD', T.LCETC3)
                    ELSE T.LCETC3
               END AS PD_DC_CLASS /* 할인구분 !!!*/
             , CASE WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_CRP_DSCR_CD', T.LCETC4)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'PMOT_CD', T.LCETC4)
                    ELSE T.LCETC4
               END AS DISC_CODE /* 할인유형 !!!*/
             , CASE WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_DSC_TP_CD', T.SELL_DSC_TP_CD)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'MSH_DSC_TP_CD', T.SELL_DSC_TP_CD)
                    ELSE T.SELL_DSC_TP_CD END AS DSC_SYST /* 할인제도 !!!*/
             , T.LCST04 AS COMBI_DV /* 결합구분 !!!*/
             , T.LCMONT AS ISTM  /* 할부 !!!*/
             , T.STPL_PTRM AS STPL_MCNT           /* 약정개월 !!!*/
             , T.LCFLG3 AS MNGT_PRD          /* 관리주기 !!!*/
             , T.LCPAMT AS PD_ACC_RSLT   /* 인정실적 !!!*/
             , T.LCBAMT AS BASE_PRC  /* 기준가격 !!!*/
             , T.HOMCARE AS HOME_CARE /* 홈케어 !!!*/
             , T.HOMCARE3_YEAR AS HCR_MSH_Y3 /* 홈케어멤버십3년 !!!!*/
             , T.LCST13 AS FXAM_YN /* 정액여부 !!!*/
             , T.LEASE_YN AS FNN_LEASE /* 금융리스  일단임시 */
             , T.LCPCNT AS ELHM_ACKMT_CT /* 가정 인정건수 !!!*/
             , T.NEW_LCPCNT AS NW_SELL_CT /* 신규판매건수  일단임시*/
             , T.BS_DAESANG AS OBJ /* BS대상 !!!!*/
             , T.RSTL_YN AS RECOMMITMENT           /* 재약정여부 !!!*/
             , T.LCCRTT AS CNTR_DATE /* 계약일자 !!!*/
             , T.LCSLET AS SL_DT /* 매출일자 !!!*/
             , T.LCCANT AS CANC_DT /* 취소일자 !!!*/
             , T.LCDELDT AS DEM_DT /* 철거일자 일단 임시*/
             , T.AKDBON AS BRMGR_NO /* 지점장번호 !!!*/
             , T.AKDBNM AS BRMGR_FNM /* 지점장성명 !!!*/
             , T.LCAMT1 AS RTLFE /* 렌탈료 !!!*/
             , T.LCCK02 AS PMOT_NO /* 프로모션번호!!!!! */
             , T.LCRCDE AS PKG_PD_NO /*패키지 상품번호!!!!!*/
             , '0' AS PKG_SN    /* 패키지 일련번호!!!!! */
             , T.INTM_ORDR_NO AS MCHN_PRTNR /* 기기고객코드!!!! */
             , CASE WHEN NVL(T.INTM_ORDR_PRDT,'0') != '0'
                         THEN SUBSTR(T.INTM_ORDR_PRDT,2,4)||'-'||SUBSTR(T.INTM_ORDR_PRDT,6,8)
               END AS MCHN_PD /* 기기상품코드!!! */
             , NVL(T.EX_YN,'N') AS PERF_EXCD /*실적제외등록여부!!! */
          FROM ( SELECT MO.DGR2_LEVL_OG_NM
                      , MO.DGR3_LEVL_OG_NM
                      , MP.PRTNR_NO  /* 번호 !!!*/
                      , MP.PRTNR_KNM  /* 성명 !!!*/
                      , NM.SELL_TP_CD /* 판매유형 !!!*/
                      , PF.FEE_PERF_TP_CD  /* 제품유형 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '6' THEN PSP.RGLR_SPP_PRC_DV_CD END AS RGLR_SPP_PRC_DV_CD  /* 가격유형 !!!*/
                      , DECODE(NM.MCHN_CH_TP_CD, 0, NULL, NM.MCHN_CH_TP_CD) AS MCHN_CH_TP_CD  /* 기변유형 !!!*/
                      , PF.FEE_PDCT_TP_CD  /* 수수료 실적유형 !!!*/
                      , NM.CNTR_NO || '-' || NM.CNTR_SN AS CNTR_DTL_CD   /* 계약상세번호 !!!*/
                      , CASE WHEN CB.COPN_DV_CD = '2' THEN '사업' ELSE '개인' END AS LCCGUB    /* 고객구분 !!!*/
                      , PP.PD_NM     /* 상품명 !!!*/
                      , PP.PD_CD     /* 상품코드 !!!*/
                      , NM.SELL_DSC_DV_CD AS LCETC3  /* 할인구분 !!!*/
                      , NM.SELL_DSCR_CD AS LCETC4  /* 할인유형 !!!*/
                      , NM.SELL_DSC_TP_CD /* 할인제도 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '2' AND (
                                SELECT 1
                                  FROM TB_SSCT_CNTR_REL SCR
                                 INNER JOIN TB_SSCT_CNTR_DTL CD2
                                    ON CD2.CNTR_NO = SCR.BASE_DTL_CNTR_NO
                                   AND CD2.CNTR_SN = SCR.BASE_DTL_CNTR_SN
                                   AND CD2.SELL_TP_CD = '6'                /* 정기배송 */
                                 WHERE SCR.OJ_DTL_CNTR_NO = CD.CNTR_NO
                                   AND SCR.OJ_DTL_CNTR_SN = CD.CNTR_SN
                                   AND SCR.VL_END_DTM = '99991231235959'
                                   AND SCR.DTA_DL_YN = 'N'
                                   AND SCR.CNTR_REL_DTL_CD = '216' /* 모종의 경우만 결합 구분 */
                                   AND ROWNUM = 1) > 0
                             THEN 'Y' END AS LCST04 /* 결합구분 !!!*/
                      , CD.ISTM_MCN AS LCMONT   /* 할부 !!!*/
                      , CASE WHEN NM.SELL_TP_CD = '1' THEN 0
                             ELSE NM.STPL_PTRM_MCN END AS STPL_PTRM /* 약정개월 !!!*/
                      , CD.SV_PRD AS LCFLG3           /* 관리주기 !!!*/
                      , NM.ACKMT_PERF_AMT AS LCPAMT   /* 인정실적 !!!*/
                      , CD.FEE_ACKMT_BASE_AMT AS LCBAMT   /* 기준가격 !!!*/
                      , CASE WHEN PF.FEE_PDCT_TP_CD = 'E' THEN ( CASE WHEN CD.SELL_TP_CD = '6' THEN (CD.SELL_AMT - CD.CNTRAM_DSC_AMT) / CD.SV_PRD
                                                                      ELSE CD.SELL_AMT
                                                                 END )
                             ELSE 0
                        END AS HOMCARE /* 홈케어 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '3' AND CD.STPL_PTRM = '36' THEN 'Y'
                             ELSE ' '
                        END  AS HOMCARE3_YEAR /* 홈케어멤버십3년 !!!!*/
                      , CD.FEE_FXAM_YN AS LCST13 /* 정액여부 !!!*/
                      , CASE WHEN CD.SELL_TP_DTL_CD IN ('22','24','25') THEN 'Y' ELSE 'N' END AS LEASE_YN  /* 금융리스 !!! */
                      , NCM.ELHM_ACKMT_CT AS LCPCNT  /* 가전인정건수 !!! */
                      , NCM.NW_ACKMT_CT AS NEW_LCPCNT   /* 신규건수 !!! */
                      , CASE WHEN WS.ROW_SCNT >= 1 THEN 'Y' END AS BS_DAESANG /* BS대상 !!!!*/
                      , NM.RSTL_YN            /* 재약정여부 !!!*/
                      , CB.CNTR_CNFM_DTM AS LCCRTT /* 계약일자 !!!*/
                      , SUBSTR(CD.CNTR_PD_STRTDT,1,8) AS LCSLET /* 매출일자 !!!*/
                      , CASE WHEN CD.CNTR_DTL_STAT_CD IN ('301','303') THEN CNTR_PD_ENDDT END AS LCCANT  /* 취소일자 !!!*/
                      , WD.REQD_DT AS LCDELDT  /* 철거일자!!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NO AS AKDBON /* 지점장번호 !!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NM AS AKDBNM /* 지점장성명 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '6' THEN CD.FNL_AMT / CD.SV_PRD
                             ELSE CD.FNL_AMT END AS LCAMT1 /* 렌탈료 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN CP.PMOT_CD
                             ELSE '0'
                        END AS LCCK02 /* 프로모션번호!!!!! */
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN CD.HGR_PD_CD
                             ELSE '0'
                        END AS LCRCDE /*패키지 상품번호!!!!!*/
                      , CASE WHEN CD.SELL_TP_CD = '6' THEN SUBSTR(CB.CNTR_NO,2,4) ||'-'||SUBSTR(CB.CNTR_NO,6,7)
                        END AS INTM_ORDR_NO /* 기기고객코드!!!! */
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN (SELECT CR.BASE_DTL_CNTR_NO /* 렌탈의 경우 정기배송 모종 계약 찾기 */
                                                              FROM TB_SSCT_CNTR_REL CR
                                                             WHERE CR.OJ_DTL_CNTR_NO = CD.CNTR_NO
                                                               AND CR.OJ_DTL_CNTR_SN = CD.CNTR_SN
                                                               AND CR.CNTR_REL_DTL_CD IN ('214','216') /* 정기배송, 모종의 경우만 기기코드 표기*/
                                                               AND ROWNUM = 1)
                             WHEN CD.SElL_TP_CD = '6' THEN (SELECT CR.OJ_DTL_CNTR_NO /* 모종 정기배송의 경우 렌탈 계약 찾기 */
                                                              FROM TB_SSCT_CNTR_REL CR
                                                             WHERE CR.BASE_DTL_CNTR_NO = CD.CNTR_NO
                                                               AND CR.BASE_DTL_CNTR_SN = CD.CNTR_SN
                                                               AND CR.CNTR_REL_DTL_CD IN ('214','216') /* 정기배송, 모종의 경우만 기기코드 표기*/
                                                               AND ROWNUM = 1)
                        END AS INTM_ORDR_PRDT/* 기기코드!!! */
                      , CASE WHEN EX.EX_SCNT = 1 THEN 'Y'
                        END AS EX_YN  /*실적제외등록여부!!! */
                   FROM TB_FEAM_WELS_NRCTR_MM_CL NM  /* 웰스순주문계약월마감 */
                  INNER JOIN TB_SSCT_CNTR_DTL CD
                     ON CD.CNTR_NO = NM.CNTR_NO
                    AND CD.CNTR_SN = NM.CNTR_SN
                    AND CD.DTA_DL_YN = 'N'
                  INNER JOIN TB_SSCT_CNTR_BAS CB
                     ON CB.CNTR_NO = CD.CNTR_NO
                    AND CB.DTA_DL_YN = 'N'
                  INNER JOIN TB_OGBS_MM_PRTNR_IZ MP  /* 월파트너 */
                     ON MP.PRTNR_NO = NM.PRTNR_NO
                    AND MP.OG_TP_CD = NM.OG_TP_CD
                    AND MP.BASE_YM = NM.BASE_YM
                  INNER JOIN TB_OGBS_MM_OG_IZ MO  /* 월조직 */
                     ON MP.BASE_YM = MO.BASE_YM
                    AND MP.OG_ID = MO.OG_ID
                    AND MP.OG_TP_CD = MO.OG_TP_CD
               <if test='@MybatisUtils@isNotEmpty(og1LevlId)'>
                    AND MO.DGR1_LEVL_OG_ID = #{og1LevlId}
               </if>
               <if test='@MybatisUtils@isNotEmpty(og2LevlId)'>
                    AND MO.DGR2_LEVL_OG_ID = #{og2LevlId}
               </if>
               <if test='@MybatisUtils@isNotEmpty(og3LevlId)'>
                    AND MO.DGR3_LEVL_OG_ID = #{og3LevlId}
               </if>
                  INNER JOIN TB_PDBS_PD_BAS PP
                     ON CD.BASE_PD_CD = PP.PD_CD
                  INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS PD
                     ON CD.BASE_PD_CD = PD.BASE_PD_CD
                    AND SUBSTR(#{strtDt},1,6) BETWEEN APY_STRT_YM AND APY_END_YM
                  INNER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS PF
                     ON PD.FEE_PDCT_TP_CD1 = PF.FEE_PDCT_TP_CD
                    AND CD.SELL_TP_CD = PF.SELL_TP_CD
                   LEFT OUTER JOIN TB_PDBS_SDING_PRC_BAS PSP
                     ON CD.BASE_PD_CD = PSP.PDCT_PD_CD
                    AND CB.CNTR_CNFM_DTM BETWEEN PSP.APY_STRTDT AND PSP.APY_ENDDT
                   LEFT OUTER JOIN LATERAL ( SELECT A.PMOT_CD
                                                  , A.PMOT_TP_CD
                                                  , RANK() OVER (PARTITION BY (A.DTL_CNTR_NO || A.DTL_CNTR_SN) ORDER BY CNTR_PMOT_ID DESC) AS RK_NUM
                                               FROM TB_SSCT_CNTR_PMOT_IZ A
                                              WHERE A.DTL_CNTR_NO = CD.CNTR_NO
                                                AND A.DTL_CNTR_SN = CD.CNTR_SN
                                           )CP /* T프로모션 계약내역T */
                     ON 1=1
                    AND CP.RK_NUM = 1
                   LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL WD
                     ON CD.CNTR_NO = WD.CNTR_NO
                    AND CD.CNTR_SN = WD.CNTR_SN
                   LEFT OUTER JOIN TB_PDBS_PD_CLSF_BAS PC /* 상품분류기본 */
                     ON PC.PD_CLSF_ID = CD.PD_LCLSF_ID
                   LEFT OUTER JOIN (
                        SELECT *
                          FROM (
                              SELECT NCM1.PRTNR_NO
                                   , NCM1.CNTR_NO
                                   , NCM1.CNTR_SN
                                   , NCM1.PERF_ATC_CD
                                   , NCM1.PERF_VAL
                                FROM TB_FEAM_NTORP_CNTR_MM_CL NCM1  /* 순주문파트너계약월마감 */
                               WHERE NCM1.BASE_YM = #{perfYm}
                                 AND NCM1.PERF_YM = #{perfYm}
                                 AND NCM1.FEE_TCNT_DV_CD = #{feeTcntDvCd}
                                 AND NCM1.PERF_AGRG_CRT_DV_CD = '301'
                                 AND NCM1.CO_CD = '2000'
                                 AND NCM1.OG_TP_CD = 'W03'
                                 AND NCM1.PERF_DV_CD = '0'
                                 AND NCM1.CNTR_PERF_CRT_DV_CD = '01'
                                 AND NCM1.DTA_DL_YN = 'N'
                               )
                         PIVOT (
                                SUM(PERF_VAL) FOR PERF_ATC_CD IN (
                                    'W00P00011' AS ELHM_ACKMT_CT,  /* BS판매인정건수 */
                                    'W00P00036' AS NW_ACKMT_CT     /* 렌탈순주문건수 */
                                )
                               )
                        ) NCM
                     ON NCM.PRTNR_NO = NM.PRTNR_NO
                    AND NCM.CNTR_NO = NM.CNTR_NO
                    AND NCM.CNTR_SN = NM.CNTR_SN
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS ROW_SCNT
                                               FROM TB_FEAM_WELS_SV_FEE_BAS A
                                              WHERE A.BASE_PD_CD = CD.BASE_PD_CD
                                                AND A.VST_MCN = 0
                                                AND SUBSTR(CB.CNTR_CNFM_DTM,1,6) BETWEEN A.APY_STRT_YM AND A.APY_END_YM
                                           )WS
                     ON 1=1
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS EX_SCNT
                                               FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS A
                                              WHERE A.CNTR_NO = CD.CNTR_NO
                                                AND A.CNTR_SN = CD.CNTR_SN
                                                AND A.FEE_PERF_EXCD_DV_CD = '01'
                                           )EX
                     ON 1=1
                  WHERE NM.BASE_YM = #{perfYm}
                    AND NM.PERF_YM = #{perfYm}
                    AND NM.FEE_TCNT_DV_CD = #{feeTcntDvCd}
                    AND NM.OG_TP_CD = 'W03'  /* W03: 홈마스터 */
                    AND NM.CNTR_PERF_CRT_DV_CD = '01'  /* 01: 순주문생성 */
               <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                    AND NM.PRTNR_NO = #{prtnrNo}
               </if>
                    AND NM.DTA_DL_YN = 'N'
               ) T
    </select>

    <select id='selectManagerDetailOrders'
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaOrganizationNetOrderDto$SearchMngerDetailRes">
        SELECT A2.OG_CD /* 조직코드 */
             , A1.PRTNR_NO /* 파트너번호 */
             , A2.PRTNR_KNM /* 파트너명 */
             , CASE WHEN A1.SELL_TP_CD = '1' THEN '01' /* 일시불 */
                    WHEN A1.SELL_TP_CD = '2' THEN '02' /* 렌탈/리스 */
                    WHEN A1.SELL_TP_CD = '3' THEN '03' /* 멤버십 */
                    WHEN A1.SELL_TP_CD = '6' THEN '04' /* 정기배송 */
                    WHEN A1.SELL_TP_CD = '05' THEN '05' /* 재약정 */
               END AS SELL_TP_CD /* 판매유형코드 */
             , A1.FEE_PDCT_TP_CD /* 수수료제품유형코드 */
             , A1.RGLR_SPP_PRC_DV_CD /* 정기배송가격구분코드 */
             , A1.MCHN_CH_TP_CD /* 기기변경유형코드 */
             , A1.FEE_PERF_TP_CD /* 수수료실적유형코드 */
             , A1.CNTR_NO || '-' || A1.CNTR_SN AS CNTR_NO /* 계약번호, 계약일련번호 */
             , A1.COPN_DV_CD /* 법인격구분코드 */
             , A1.PD_NM /* 상품명 */
             , A1.BASE_PD_CD /* 기준상품코드 */
             , CASE WHEN A1.SELL_TP_CD = '1' THEN F_CMZ_CD_NM('TNT_WELLS', 'SPAY_DSC_DV_CD', A1.SELL_DSC_DV_CD)
                    WHEN A1.SELL_TP_CD = '2' THEN F_CMZ_CD_NM('TNT_WELLS', 'RENTAL_DSC_DV_CD', A1.SELL_DSC_DV_CD)
                    WHEN A1.SELL_TP_CD = '3' THEN F_CMZ_CD_NM('TNT_WELLS', 'MSH_DSC_DV_CD', A1.SELL_DSC_DV_CD)
               END AS SELL_DSC_DV_CD /* 판매할인구분코드 */
             , CASE WHEN A1.SELL_TP_CD = '1' THEN F_CMZ_CD_NM('TNT_WELLS', 'SPAY_DSCR_CD', A1.SELL_DSCR_CD)
                    WHEN A1.SELL_TP_CD = '2' THEN F_CMZ_CD_NM('TNT_WELLS', 'RENTAL_CRP_DSCR_CD', A1.SELL_DSCR_CD)
               END AS SELL_DSCR_CD /* 판매할인율코드 */
             , CASE WHEN A1.SELL_TP_CD = '2' THEN F_CMZ_CD_NM('TNT_WELLS', 'RENTAL_DSC_TP_CD', A1.SELL_DSC_TP_CD)
                    WHEN A1.SELL_TP_CD = '3' THEN F_CMZ_CD_NM('TNT_WELLS', 'MSH_DSC_TP_CD', A1.SELL_DSC_TP_CD)
               END AS SELL_DSC_TP_CD /* 판매할인유형코드 */
             , A1.COMBI_DV /* 결합구분코드 */
             , A1.CNTR_PTRM /* 계약기간 */
             , A1.STPL_PTRM /* 약정기간 */
             , A1.SV_PRD /* 서비스주기 */
             , A1.ACKMT_PERF_AMT /* 인정실적금액 */
             , A1.FEE_ACKMT_BASE_AMT /* 수수료인정기준금액 */
             , A1.HCR /* 홈케어 */
             , A1.HCR_MSH_Y3 /* 홈케어멤버십3년 */
             , A1.FEE_FXAM_YN /* 정액여부 */
             , A1.FNN_LEASE /* 금융리스 */
             , A1.FEE_ACKMT_CT /* 수수료인정건수 */
             , A1.NW_SELL_CT /* 신규판매건수 */
             , A1.BFSVC_OJ_YN /* BS대상여부 */
             , A1.RSTL_YN /* 재약정여부 */
             , A2.DGR3_LEVL_DG_PRTNR_NO /* 3차레벨대표파트너번호 */
             , A2.DGR3_LEVL_DG_PRTNR_NM /* 3차레벨대표파트너명 */
             , A1.SELL_AMT /* 판매금액 */
             , A1.PMOT_NO /* 프로모션번호 */
             , A1.PKG_CD /* 패키지코드 */
             , A1.PKG_SN /* 패키지일련번호 */
             , A1.CNTR_CNFM_DTM /* 계약확정일시 */
             , A1.SL_DT /* 매출일자 */
             , A1.CAN_DT /* 취소일자 */
             , A1.REQD_DT /* 철거일자 */
             , A1.OJ_DTL_CNTR_NO AS MCHN_CST_CD /* 기기고객코드 */
             , A1.MCHN_PD_CD /* 기기상품코드 */
             , A1.PERF_EXCD_RGST_YN /* 실적제외등록여부 */
          FROM
             (
               <if test='!@MybatisUtils@equals(sellTpCd, "05")'> /* 판매유형 = 05 : 재약정 */
                   SELECT
                         <choose>
                             <when test='@MybatisUtils@equals(dvCd, "01") or @MybatisUtils@equals(dvCd, "02")'> /* 구분 = 01 : 접수, 02 : 예약 */
                                 SUBSTR(T1.CNTR_RCP_FSH_DTM, 0, 6) AS BASE_YM /* 기준년월 */
                             </when>
                             <when test='@MybatisUtils@equals(dvCd, "03")'>  /* 구분 = 03 : 매출 */
                                 SUBSTR(T2.CNTR_PD_STRTDT, 0, 6) AS BASE_YM /* 기준년월 */
                             </when>
                         </choose>
                        , T1.SELL_OG_TP_CD AS OG_TP_CD /* 조직유형코드 */
                        , T1.SELL_PRTNR_NO AS PRTNR_NO /* 파트너번호 */
                        , T2.SELL_TP_CD /* 판매유형코드 */
                        , T5.FEE_PDCT_TP_CD1 AS FEE_PDCT_TP_CD /* 수수료제품유형코드 */
                        , T7.PD_PRP_VAL13 AS RGLR_SPP_PRC_DV_CD /* 정기배송가격구분코드 */
                        , T8.MCHN_CH_TP_CD /* 기기변경유형코드 */
                        , T9.FEE_PERF_TP_CD /* 수수료실적유형코드 */
                        , T2.CNTR_NO /* 계약번호 */
                        , T2.CNTR_SN /* 계약일련번호 */
                        , T1.COPN_DV_CD /* 법인격구분코드 */
                        , T3.PD_NM /* 상품명 */
                        , T2.BASE_PD_CD /* 기준상품코드 */
                        , T2.SELL_DSC_DV_CD /* 판매할인구분코드 */
                        , T2.SELL_DSCR_CD /* 판매할인율코드 */
                        , T2.SELL_DSC_TP_CD /* 판매할인유형코드 */
                        , CASE WHEN T12.COMBI_DV_CNT <![CDATA[>]]> 0 THEN 'Y'
                          END AS COMBI_DV /* 결합구분코드 */
                        , T2.CNTR_PTRM /* 계약기간 */
                        , T2.STPL_PTRM /* 약정기간 */
                        , T2.SV_PRD /* 서비스주기 */
                        , T2.ACKMT_PERF_AMT /* 인정실적금액 */
                        , CASE WHEN T2.SELL_TP_CD = '6' THEN /* 정기배송 */
                               CASE WHEN T9.FEE_PDCT_TP_CD = 'B' AND T2.ACKMT_PERF_AMT <![CDATA[>]]> 2 THEN
                                    T2.FEE_ACKMT_BASE_AMT
                                    ELSE 0
                               END
                               WHEN T2.SELL_TP_CD = '2' THEN /* 렌탈/리스 */
                               CASE WHEN NVL(T13.ROW_SCNT, 0) + NVL(T14.ROW_SCNT, 0) = 0 THEN
                                    0
                                    ELSE T2.FEE_ACKMT_BASE_AMT
                               END
                               ELSE T2.FEE_ACKMT_BASE_AMT
                          END AS FEE_ACKMT_BASE_AMT /* 수수료인정기준금액 */
                        , CASE WHEN T9.FEE_PDCT_TP_CD = 'E' THEN
                               (CASE WHEN T2.SELL_TP_CD = '6' THEN NVL((NVL(T2.FNL_AMT, 0)- NVL(T2.CNTRAM_DSC_AMT, 0)) / DECODE(T2.SV_PRD, 0, NULL, T2.SV_PRD), 0) ELSE T2.SELL_AMT END )
                               ELSE 0
                          END AS HCR /* 홈케어 */
                        , CASE WHEN T9.FEE_PDCT_TP_CD = 'E' AND T2.STPL_PTRM = '36' THEN 'Y'
                               ELSE ''
                          END AS HCR_MSH_Y3 /* 홈케어맴버십3년 */
                        , T2.FEE_FXAM_YN /* 정액여부 */
                        , CASE WHEN T2.SELL_TP_DTL_CD IN ('22', '24', '25', '26') THEN 'Y' ELSE 'N' END AS FNN_LEASE /* 금융리스 */
                        , CASE WHEN T2.SELL_TP_CD = '2' THEN /* 렌탈 */
                               CASE WHEN T8.MCHN_CH_TP_CD IN (1, 18) THEN 0
                                    ELSE T2.FEE_ACKMT_CT
                               END
                               ELSE T2.FEE_ACKMT_CT
                          END AS FEE_ACKMT_CT /* 수수료인정건수 */
                        , CASE WHEN T2.SELL_TP_CD = '1' THEN /* 일시불 */
                               CASE WHEN T8.MCHN_CH_TP_CD IS NOT NULL AND T2.SELL_TP_DTL_CD != '12'
                                         AND T2.FEE_FXAM_YN = 'N' AND T2.ACKMT_PERF_AMT <![CDATA[>]]> 0
                                         AND T2.FEE_ACKMT_CT <![CDATA[>]]> 0 AND NVL(T13.ROW_SCNT, 0) + NVL(T14.ROW_SCNT, 0) <![CDATA[>]]> 0 THEN 1
                                    ELSE 0
                               END
                               WHEN T2.SELL_TP_CD = '2' THEN /* 렌탈 */
                               CASE WHEN T8.MCHN_CH_TP_CD IS NOT NULL OR T2.ACKMT_PERF_AMT = 0
                                         OR T2.FEE_ACKMT_CT = 0 OR NVL(T13.ROW_SCNT, 0) + NVL(T14.ROW_SCNT, 0) = 0 THEN 0
                                    ELSE 1
                               END
                               WHEN T2.SELL_TP_CD = '6' THEN /* 정기배송 */
                               CASE WHEN T8.MCHN_CH_TP_CD IS NOT NULL THEN 0
                                    WHEN T2.SELL_TP_DTL_CD = '62' AND T2.ACKMT_PERF_AMT <![CDATA[>]]> 2 THEN 1
                                    WHEN T2.ACKMT_PERF_AMT = 0 OR T2.FEE_ACKMT_CT = 0 OR NVL(T13.ROW_SCNT, 0) + NVL(T14.ROW_SCNT, 0) = 0 THEN 0
                                    ELSE 1
                               END
                          END AS NW_SELL_CT /* 신규판매건수 */
                        , CASE WHEN T5.FEE_PDCT_TP_CD1 != 'B' AND NVL(T13.ROW_SCNT, 0) + NVL(T14.ROW_SCNT, 0) <![CDATA[>]]> 0 THEN 'Y' END AS BFSVC_OJ_YN /* BS대상여부 */
                        , '' AS RSTL_YN /* 재약정여부 */
                        , SUBSTR(T1.CNTR_RCP_FSH_DTM, 0, 8) AS CNTR_CNFM_DTM /* 계약접수완료일시 */
                        , SUBSTR(T2.CNTR_PD_STRTDT, 0, 8) AS SL_DT /* 매출일자 */
                        , CASE WHEN T2.CNTR_DTL_STAT_CD IN ('301', '303') THEN T2.CNTR_PD_ENDDT
                               ELSE ''
                          END AS CAN_DT /* 취소일자 */
                        , T6.REQD_DT /* 철거일자 */
                        , CASE WHEN T2.SELL_TP_CD = '6' THEN NVL((NVL(T2.FNL_AMT, 0)- NVL(T2.CNTRAM_DSC_AMT, 0)) / DECODE(T2.SV_PRD, 0, NULL, T2.SV_PRD), 0)
                               ELSE T2.SELL_AMT
                          END AS SELL_AMT /* 판매금액 */
                        , T15.PMOT_CD AS PMOT_NO /* 프로모션번호 */
                        , T2.HGR_PD_CD AS PKG_CD /* 상위상품코드 */
                        , T16.CNTR_CST_GRP_ID AS PKG_SN /* 계약고객그룹ID */
                        , T11.OJ_DTL_CNTR_NO /* 대상상세계약번호 */
                        , T11.BASE_PD_CD AS MCHN_PD_CD /* 기기상품코드 */
                        , CASE WHEN NVL(T10.CNTR_NO, 'N') = 'N' THEN 'N'
                               ELSE 'Y'
                          END AS PERF_EXCD_RGST_YN /* 실적제외등록여부 */
                     FROM TB_SSCT_CNTR_BAS T1 /* 계약기본 */
                    INNER JOIN TB_SSCT_CNTR_DTL T2 /* 계약상세 */
                       ON T1.CNTR_NO = T2.CNTR_NO /* 계약번호 */
                      AND T2.DTA_DL_YN = 'N'
                    INNER JOIN TB_PDBS_PD_BAS T3 /* 상품기본 */
                       ON T2.BASE_PD_CD = T3.PD_CD /* 상품코드 */
                      AND T3.DTA_DL_YN = 'N'
                    INNER JOIN TB_PDBS_PD_CLSF_BAS T4 /* 상품분류기본 */
                       ON T3.PD_CLSF_ID = T4.PD_CLSF_ID /* 상품분류ID */
                      AND T4.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T5 /* 웰스수수료제품유형기본 */
                       ON T2.BASE_PD_CD = T5.BASE_PD_CD /* 기준상품코드 */
                      AND SUBSTR(#{rcpDtFrom}, 0, 6) BETWEEN T5.APY_STRT_YM AND T5.APY_END_YM /* 적용시작년월, 적용종료년월 */
                      AND T5.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T6 /* 계약WELLS상세 */
                       ON T2.CNTR_NO = T6.CNTR_NO /* 계약번호 */
                      AND T2.CNTR_SN = T6.CNTR_SN /* 계약일련번호 */
                      AND T6.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL T7 /* 상품각사속성상세 */
                       ON T2.BASE_PD_CD = T7.PD_CD /* 상품코드 */
                      AND T7.PD_EXTS_PRP_GRP_CD = 'CNTR' /* 상품확장속성그룹코드 */
                      AND T7.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ T8 /* 기기변경내역 */
                       ON T2.CNTR_NO = T8.BASE_CNTR_NO /* 기준계약번호 */
                      AND T2.CNTR_SN = T8.BASE_CNTR_SN /* 기준계약일련번호 */
                      AND T8.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS T9 /* 웰스수수료실적유형기본 */
                       ON T5.FEE_PDCT_TP_CD1 = T9.FEE_PDCT_TP_CD /* 수수료제품유형코드 */
                      AND T2.SELL_TP_CD = T9.SELL_TP_CD /* 판매유형코드 */
                      AND T9.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_FEDD_FEE_PERF_EXCD_OJ_BAS T10 /* 수수료실적제외대상기본 */
                       ON T2.CNTR_NO = T10.CNTR_NO /* 계약번호 */
                      AND T2.CNTR_SN = T10.CNTR_SN /* 계약일련번호 */
                      AND T10.FEE_PERF_EXCD_DV_CD = '01' /* 수수료실적제외구분코드 = 01 : 실적제외 */
                      AND SUBSTR(#{rcpDtFrom}, 0, 6) BETWEEN T10.APY_STRT_YM AND T10.APY_END_YM /* 적용시작년월, 적용종료년월 */
                      AND T10.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN LATERAL
                        (
                          SELECT S1.OJ_DTL_CNTR_NO /* 대상상세계약번호 */
                               , S2.BASE_PD_CD /* 기기상품코드 */
                            FROM TB_SSCT_CNTR_REL S1 /* 계약관계 */
                           INNER JOIN TB_SSCT_CNTR_DTL S2 /* 계약상세 */
                              ON S1.OJ_DTL_CNTR_NO = S2.CNTR_NO /* 계약번호 */
                             AND S1.OJ_DTL_CNTR_SN = S2.CNTR_SN /* 계약일련번호 */
                             AND S2.DTA_DL_YN = 'N'
                           WHERE 1=1
                             AND S1.BASE_DTL_CNTR_NO = T2.CNTR_NO /* 기준상세계약번호 */
                             AND S1.BASE_DTL_CNTR_SN = T2.CNTR_SN /* 기준상세계약일련번호 */
                             AND SUBSTR(T1.CNTR_RCP_FSH_DTM, 0, 8) BETWEEN SUBSTR(S1.VL_STRT_DTM, 0 ,8) AND SUBSTR(S1.VL_END_DTM, 0, 8) /* 유효시작일시, 유효종료일시 */
                             AND S1.CNTR_REL_DTL_CD = '216' /* 계약관계상세코드 = 216 : 모종결합 */
                             AND S1.DTA_DL_YN  = 'N'
                        ) T11
                       ON 1=1
                     LEFT OUTER JOIN LATERAL
                        (
                          SELECT COUNT(*) AS COMBI_DV_CNT
                            FROM TB_SSCT_CNTR_REL /* 계약관계 */
                           WHERE 1=1
                             AND DTA_DL_YN  = 'N'
                             AND OJ_DTL_CNTR_NO = T2.CNTR_NO /* 대상상세계약번호 */
                             AND OJ_DTL_CNTR_SN = T2.CNTR_SN /* 대상상세계약일련번호 */
                             AND SUBSTR(T1.CNTR_RCP_FSH_DTM, 0, 8) BETWEEN SUBSTR(VL_STRT_DTM, 0 ,8) AND SUBSTR(VL_END_DTM, 0, 8) /* 유효시작일시, 유효종료일시 */
                             AND CNTR_REL_DTL_CD = '216' /* 계약관계상세코드 = 216 : 모종결합 */
                        ) T12
                       ON 1=1
                     LEFT OUTER JOIN LATERAL
                        (
                          SELECT COUNT(*) AS ROW_SCNT
                            FROM TB_FEAM_WELS_SV_FEE_BAS /* 웰스서비스수수료기본 */
                           WHERE 1=1
                             AND BASE_PD_CD = T2.BASE_PD_CD /* 기준상품코드 */
                             AND VST_MCN = 0 /* 방문개월수 */
                             AND SUBSTR(#{rcpDtFrom}, 0, 6) BETWEEN APY_STRT_YM AND APY_END_YM /* 적용시작년월, 적용종료년월 */
                             AND DTA_DL_YN = 'N'
                         ) T13
                       ON 1=1
                     LEFT OUTER JOIN LATERAL
                        (
                          SELECT COUNT(*) AS ROW_SCNT
                            FROM TB_FEAM_WELS_SV_FEE_BAS /* 웰스서비스수수료기본 */
                           WHERE 1=1
                             AND DTA_DL_YN = 'N'
                             AND VST_MCN = 0 /* 방문개월수 */
                             AND SUBSTR(#{rcpDtFrom}, 0, 6) BETWEEN APY_STRT_YM AND APY_END_YM /* 적용시작년월, 적용종료년월 */
                             AND BASE_PD_CD IN /* 기준상품코드 */
                               (
                                 SELECT S2.OJ_PD_CD /* 상품코드 */
                                   FROM TB_PDBS_PD_BAS S1 /* 상품기본 */
                                  INNER JOIN TB_PDBS_PD_REL S2 /* 상품관계 */
                                     ON S2.BASE_PD_CD = S1.PD_CD /* 상품코드 */
                                    AND S2.PD_REL_TP_CD = '05' /* 상품관계유형코드 = 05 : 기준-제품 */
                                    AND SUBSTR(#{rcpDtFrom}, 0, 8) BETWEEN S2.VL_STRT_DTM  AND S2.VL_END_DTM /* 유효시작일시, 유효종료일시 */
                                    AND S2.DTA_DL_YN = 'N'
                                  INNER JOIN TB_PDBS_PD_BAS S3 /* 상품기본 */
                                     ON S3.PD_CD = S2.OJ_PD_CD /* 대상상품코드 */
                                    AND S3.DTA_DL_YN = 'N'
                                    AND S3.PD_TP_CD='M' /* 상품유형코드 = M : 교재제품 */
                                  WHERE 1=1
                                    AND S1.DTA_DL_YN = 'N'
                                    AND S1.PD_CD = T2.BASE_PD_CD /* 기준상품코드 */
                               )
                        ) T14
                       ON 1=1
                     LEFT OUTER JOIN LATERAL
                        (
                          SELECT PMOT_CD /* 프로모션코드 */
                               , RANK() OVER (PARTITION BY DTL_CNTR_NO, DTL_CNTR_SN ORDER BY PMOT_TP_CD, PMOT_CD) AS RK_NUM
                            FROM TB_SSCT_CNTR_PMOT_IZ /* 계약프로모션내역 */
                           WHERE 1=1
                             AND DTL_CNTR_NO = T2.CNTR_NO /* 상세계약번호 */
                             AND DTL_CNTR_SN = T2.CNTR_SN /* 상세계약일련번호 */
                             AND DTA_DL_YN = 'N'
                        ) T15
                       ON 1=1
                      AND RK_NUM = 1
                     LEFT OUTER JOIN TB_SSCT_CNTR_REL T16 /* 계약관계 */
                       ON T16.BASE_DTL_CNTR_NO = T2.CNTR_NO /* 기준상세계약번호 */
                      AND T16.BASE_DTL_CNTR_SN = T2.CNTR_SN /* 기준상세계약일련번호 */
                      AND T16.CNTR_REL_DTL_CD = '22W' /* 계약관계상세코드 = 22W : 패키지상품 */
                      AND SUBSTR(T1.CNTR_RCP_FSH_DTM, 0, 8) BETWEEN SUBSTR(T16.VL_STRT_DTM, 0 ,8) AND SUBSTR(T16.VL_END_DTM, 0, 8) /* 유효시작일시, 유효종료일시 */
                      AND T16.DTA_DL_YN = 'N'
                    WHERE 1=1
                      AND T1.DTA_DL_YN = 'N'
                      AND T1.SELL_OG_TP_CD = 'W02' /* 판매조직유형코드 */

                      <choose>
                          <when test='@MybatisUtils@equals(dvCd, "01") or @MybatisUtils@equals(dvCd, "02")'> /* 구분 = 01 : 접수, 02 : 예약 */
                              AND SUBSTR(T1.CNTR_RCP_FSH_DTM, 0, 8) BETWEEN #{rcpDtFrom} AND #{rcpDtTo} /* 계약접수완료일시 */
                              <if test='@MybatisUtils@equals(dvCd, "02")'> /* 구분 = 02 : 예약 */
                                  AND T2.BOO_SELL_TP_CD IS NOT NULL /* 예약판매유형코드 */
                              </if>
                          </when>
                          <when test='@MybatisUtils@equals(dvCd, "03")'> /* 구분 = 03 : 매출 */
                              AND T2.CNTR_PD_STRTDT BETWEEN #{rcpDtFrom} AND #{rcpDtTo} /* 계약상품시작일자 */
                              AND T2.BOO_SELL_TP_CD IS NULL /* 예약판매유형코드 */
                          </when>
                      </choose>

                      <if test='@MybatisUtils@isEmpty(sellTpCd)'>
                          AND
                            (
                              T2.SELL_TP_CD IN ('1', '2', '6') OR (T2.SELL_TP_CD = '3' AND T2.SELL_TP_DTL_CD = '33')
                            )
                      </if>

                      <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
                          <choose>
                              <when test='@MybatisUtils@equals(sellTpCd, "01")'> /* 판매유형 = 01 : 일시불 */
                                  AND T2.SELL_TP_CD = '1' /* 판매유형코드 = 1 : 일시불 */
                              </when>
                              <when test='@MybatisUtils@equals(sellTpCd, "02")'> /* 판매유형 = 02 : 렌탈/리스 */
                                  AND T2.SELL_TP_CD = '2' /* 판매유형코드 = 2 : 렌탈/리스 */
                              </when>
                              <when test='@MybatisUtils@equals(sellTpCd, "03")'> /* 판매유형 = 03 : 홈케어멤버십 */
                                  AND T2.SELL_TP_CD = '3' /* 판매유형코드 = 3 : 멤버십 */
                                  AND T2.SELL_TP_DTL_CD = '33' /* 판매유형상세코드 = 33 : 홈케어 멤버십 */
                              </when>
                              <when test='@MybatisUtils@equals(sellTpCd, "04")'> /* 판매유형 = 04 : 정기배송 */
                                  AND T2.SELL_TP_CD = '6' /* 판매유형코드 = 6 : 정기배송 */
                              </when>
                          </choose>
                      </if>

                      <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                          AND T1.SELL_PRTNR_NO = #{prtnrNo} /* 파트너번호 */
                      </if>
               </if>

               <if test='@MybatisUtils@isEmpty(sellTpCd) or @MybatisUtils@equals(sellTpCd, "05")'> /* 판매유형 = '' : 전체, 05 : 재약정 */

                   <if test='@MybatisUtils@isEmpty(sellTpCd)'> /* 판매유형 = '' : 전체 */
                       UNION ALL
                   </if>

                   SELECT
                         <choose>
                             <when test='@MybatisUtils@equals(dvCd, "01") or @MybatisUtils@equals(dvCd, "02")'> /* 구분 = 01 : 접수, 02 : 예약 */
                                 SUBSTR(T1.STPL_RCP_DTM, 0, 6) AS BASE_YM /* 기준년월 */
                             </when>
                             <when test='@MybatisUtils@equals(dvCd, "03")'>  /* 구분 = 03 : 매출 */
                                 SUBSTR(T1.STPL_CNFM_DTM, 0, 6) AS BASE_YM /* 기준년월 */
                             </when>
                         </choose>
                        , T1.RCP_OG_TP_CD AS OG_TP_CD /* 조직유형코드 */
                        , T1.RCP_PRTNR_NO AS PRTNR_NO /* 파트너번호 */
                        , '05' AS SELL_TP_CD /* 판매유형코드 */
                        , T6.FEE_PDCT_TP_CD1 AS FEE_PDCT_TP_CD /* 수수료제품유형코드 */
                        , T8.PD_PRP_VAL13 AS RGLR_SPP_PRC_DV_CD /* 정기배송가격구분코드 */
                        , T9.MCHN_CH_TP_CD /* 기기변경유형코드 */
                        , T10.FEE_PERF_TP_CD /* 수수료실적유형코드 */
                        , T1.CNTR_NO /* 계약번호 */
                        , T1.CNTR_SN /* 계약일련번호 */
                        , T2.COPN_DV_CD /* 법인격구분코드 */
                        , T4.PD_NM /* 상품명 */
                        , T3.BASE_PD_CD /* 기준상품코드 */
                        , T3.SELL_DSC_DV_CD /* 판매할인구분코드 */ --할인구분
                        , T3.SELL_DSCR_CD /* 판매할인율코드 */
                        , T3.SELL_DSC_TP_CD /* 판매할인유형코드 */
                        , CASE WHEN T13.COMBI_DV_CNT <![CDATA[>]]> 0 THEN 'Y'
                          END AS COMBI_DV /* 결합구분코드 */
                        , T3.CNTR_PTRM /* 계약기간 */
                        , T3.STPL_PTRM /* 약정기간 */
                        , T3.SV_PRD /* 서비스주기 */
                        , T3.ACKMT_PERF_AMT /* 인정실적금액 */
                        , T1.FEE_ACKMT_BASE_AMT /* 수수료인정기준금액 */
                        , CASE WHEN T10.FEE_PDCT_TP_CD = 'E' THEN
                               (CASE WHEN T3.SELL_TP_CD = '6' THEN (NVL(T3.FNL_AMT, 0)- NVL(T3.CNTRAM_DSC_AMT, 0)) / NVL(T3.SV_PRD, 0) ELSE T3.SELL_AMT END )
                               ELSE 0
                          END AS HCR /* 홈케어 */
                        , CASE WHEN T10.FEE_PDCT_TP_CD = 'E' AND T3.STPL_PTRM = '36' THEN 'Y'
                               ELSE ''
                          END AS HCR_MSH_Y3 /* 홈케어맴버십3년 */
                        , T3.FEE_FXAM_YN /* 정액여부 */
                        , CASE WHEN T3.SELL_TP_DTL_CD IN ('22', '24', '25', '26') THEN 'Y' ELSE 'N' END AS FNN_LEASE /* 금융리스 */
                        , T1.FEE_ACKMT_CT /* 수수료인정건수 */
                        , 0 AS NW_SELL_CT /* 신규판매건수 */
                        , '' AS BFSVC_OJ_YN /* BS대상여부 */
                        , 'Y' AS RSTL_YN /* 재약정여부 */

                         <choose>
                             <when test='@MybatisUtils@equals(dvCd, "01") or @MybatisUtils@equals(dvCd, "02")'> /* 구분 = 01 : 접수, 02 : 예약 */
                                 , SUBSTR(T1.STPL_RCP_DTM, 0, 8) AS CNTR_CNFM_DTM /* 계약확정일시 */
                             </when>
                             <when test='@MybatisUtils@equals(dvCd, "03")'>  /* 구분 = 03 : 매출 */
                                 , SUBSTR(T1.STPL_CNFM_DTM, 0, 8) AS CNTR_CNFM_DTM /* 계약확정일시 */
                             </when>
                         </choose>

                        , SUBSTR(T1.STPL_STRTDT, 0, 8) AS SL_DT /* 약정시작일자 */
                        , T1.STPL_CAN_DTM AS CAN_DT /* 취소일자 */
                        , T7.REQD_DT /* 철거일자 */
                        , NVL(T3.FNL_AMT, 0) - NVL(T1.STPL_DSC_AMT, 0) SELL_AMT /* 판매금액 */
                        , '' AS PMOT_NO /* 프로모션번호 */
                        , T3.HGR_PD_CD AS PKG_CD /* 상위상품코드 */
                        , T14.CNTR_CST_GRP_ID AS PKG_SN /* 계약고객그룹ID */
                        , T12.OJ_DTL_CNTR_NO /* 대상상세계약번호 */
                        , T12.BASE_PD_CD AS MCHN_PD_CD /* 기기상품코드 */
                        , CASE WHEN NVL(T11.CNTR_NO, 'N') = 'N' THEN 'N'
                               ELSE 'Y'
                          END AS PERF_EXCD_RGST_YN /* 실적제외등록여부 */
                     FROM TB_SSCT_RENTAL_RSTL_IZ T1 /* 렌탈재약정내역 */
                    INNER JOIN TB_SSCT_CNTR_BAS T2 /* 계약기본 */
                       ON T1.CNTR_NO = T2.CNTR_NO /* 계약번호 */
                      AND T2.DTA_DL_YN = 'N'
                    INNER JOIN TB_SSCT_CNTR_DTL T3 /* 계약상세 */
                       ON T1.CNTR_NO = T3.CNTR_NO /* 계약번호 */
                      AND T1.CNTR_SN = T3.CNTR_SN /* 계약일련번호 */
                      AND T3.DTA_DL_YN = 'N'
                    INNER JOIN TB_PDBS_PD_BAS T4 /* 상품기본 */
                       ON T3.BASE_PD_CD = T4.PD_CD /* 상품코드 */
                      AND T4.DTA_DL_YN = 'N'
                    INNER JOIN TB_PDBS_PD_CLSF_BAS T5 /* 상품분류기본 */
                       ON T4.PD_CLSF_ID = T5.PD_CLSF_ID /* 상품분류ID */
                      AND T5.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T6 /* 웰스수수료제품유형기본 */
                       ON T3.BASE_PD_CD = T6.BASE_PD_CD /* 기준상품코드 */
                      AND SUBSTR(#{rcpDtFrom}, 0, 6) BETWEEN T6.APY_STRT_YM AND T6.APY_END_YM /* 적용시작년월, 적용종료년월 */
                      AND T6.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T7 /* 계약WELLS상세 */
                       ON T3.CNTR_NO = T7.CNTR_NO /* 계약번호 */
                      AND T3.CNTR_SN = T7.CNTR_SN /* 계약일련번호 */
                      AND T7.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL T8 /* 상품각사속성상세 */
                       ON T3.BASE_PD_CD = T8.PD_CD /* 상품코드 */
                      AND T8.PD_EXTS_PRP_GRP_CD = 'CNTR' /* 상품확장속성그룹코드 */
                      AND T8.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ T9 /* 기기변경내역 */
                       ON T3.CNTR_NO = T9.BASE_CNTR_NO /* 기준계약번호 */
                      AND T3.CNTR_SN = T9.BASE_CNTR_SN /* 기준계약일련번호 */
                      AND T8.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS T10 /* 웰스수수료실적유형기본 */
                       ON T6.FEE_PDCT_TP_CD1 = T10.FEE_PDCT_TP_CD /* 수수료제품유형코드 */
                      AND T3.SELL_TP_CD = T10.SELL_TP_CD /* 판매유형코드 */
                      AND T10.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN TB_FEDD_FEE_PERF_EXCD_OJ_BAS T11 /* 수수료실적제외대상기본 */
                       ON T1.CNTR_NO = T11.CNTR_NO /* 계약번호 */
                      AND T1.CNTR_SN = T11.CNTR_SN /* 계약일련번호 */
                      AND T11.FEE_PERF_EXCD_DV_CD = '01' /* 수수료실적제외구분코드 = 01 : 실적제외 */
                      AND SUBSTR(#{rcpDtFrom}, 0, 6) BETWEEN T11.APY_STRT_YM AND T11.APY_END_YM /* 적용시작년월, 적용종료년월 */
                      AND T11.DTA_DL_YN = 'N'
                     LEFT OUTER JOIN LATERAL
                        (
                          SELECT S1.OJ_DTL_CNTR_NO /* 대상상세계약번호 */
                               , S2.BASE_PD_CD /* 기기상품코드 */
                            FROM TB_SSCT_CNTR_REL S1 /* 계약관계 */
                           INNER JOIN TB_SSCT_CNTR_DTL S2 /* 계약상세 */
                              ON S1.OJ_DTL_CNTR_NO = S2.CNTR_NO /* 계약번호 */
                             AND S1.OJ_DTL_CNTR_SN = S2.CNTR_SN /* 계약일련번호 */
                             AND S2.DTA_DL_YN = 'N'
                           WHERE 1=1
                             AND S1.BASE_DTL_CNTR_NO = T1.CNTR_NO /* 기준상세계약번호 */
                             AND S1.BASE_DTL_CNTR_SN = T1.CNTR_SN /* 기준상세계약일련번호 */

                             <choose>
                                 <when test='@MybatisUtils@equals(dvCd, "01") or @MybatisUtils@equals(dvCd, "02")'> /* 구분 = 01 : 접수, 02 : 예약 */
                                     AND SUBSTR(T1.STPL_RCP_DTM, 0, 8) BETWEEN SUBSTR(S1.VL_STRT_DTM, 0 ,8) AND SUBSTR(S1.VL_END_DTM, 0, 8) /* 유효시작일시, 유효종료일시 */
                                 </when>
                                 <when test='@MybatisUtils@equals(dvCd, "03")'>  /* 구분 = 03 : 매출 */
                                     AND SUBSTR(T1.STPL_CNFM_DTM, 0, 8) BETWEEN SUBSTR(S1.VL_STRT_DTM, 0 ,8) AND SUBSTR(S1.VL_END_DTM, 0, 8) /* 유효시작일시, 유효종료일시 */
                                 </when>
                             </choose>

                             AND S1.CNTR_REL_DTL_CD = '216' /* 계약관계상세코드 = 216 : 모종결합 */
                             AND S1.DTA_DL_YN  = 'N'
                        ) T12
                       ON 1=1
                     LEFT OUTER JOIN LATERAL
                        (
                          SELECT COUNT(*) AS COMBI_DV_CNT
                            FROM TB_SSCT_CNTR_REL /* 계약관계 */
                           WHERE 1=1
                             AND DTA_DL_YN  = 'N'
                             AND OJ_DTL_CNTR_NO = T1.CNTR_NO /* 대상상세계약번호 */
                             AND OJ_DTL_CNTR_SN = T1.CNTR_SN /* 대상상세계약일련번호 */

                             <choose>
                                 <when test='@MybatisUtils@equals(dvCd, "01") or @MybatisUtils@equals(dvCd, "02")'> /* 구분 = 01 : 접수, 02 : 예약 */
                                     AND SUBSTR(T1.STPL_RCP_DTM, 0, 8) BETWEEN SUBSTR(VL_STRT_DTM, 0 ,8) AND SUBSTR(VL_END_DTM, 0, 8) /* 유효시작일시, 유효종료일시 */
                                 </when>
                                 <when test='@MybatisUtils@equals(dvCd, "03")'>  /* 구분 = 03 : 매출 */
                                     AND SUBSTR(T1.STPL_CNFM_DTM, 0, 8) BETWEEN SUBSTR(VL_STRT_DTM, 0 ,8) AND SUBSTR(VL_END_DTM, 0, 8) /* 유효시작일시, 유효종료일시 */
                                 </when>
                             </choose>

                             AND CNTR_REL_DTL_CD = '216' /* 계약관계상세코드 = 216 : 모종결합 */
                        ) T13
                       ON 1=1
                     LEFT OUTER JOIN TB_SSCT_CNTR_REL T14 /* 계약관계 */
                       ON T14.BASE_DTL_CNTR_NO = T1.CNTR_NO /* 기준상세계약번호 */
                      AND T14.BASE_DTL_CNTR_SN = T1.CNTR_SN /* 기준상세계약일련번호 */
                      AND T14.CNTR_REL_DTL_CD = '22W' /* 계약관계상세코드 = 22W : 패키지상품 */
                      AND SUBSTR(T1.STPL_RCP_DTM, 0, 8) BETWEEN SUBSTR(T14.VL_STRT_DTM, 0 ,8) AND SUBSTR(T14.VL_END_DTM, 0, 8) /* 유효시작일시, 유효종료일시 */
                      AND T14.DTA_DL_YN = 'N'
                    WHERE 1=1
                      AND T1.DTA_DL_YN = 'N'
                      AND T1.STPL_TP_CD = 'A' /* 약정유형코드 */
                      AND T1.RCP_OG_TP_CD = 'W02' /* 판매조직유형코드 */

                      <choose>
                          <when test='@MybatisUtils@equals(dvCd, "01") or @MybatisUtils@equals(dvCd, "02")'> /* 구분 = 01 : 접수, 02 : 예약 */
                              AND SUBSTR(T1.STPL_RCP_DTM, 0, 8) BETWEEN #{rcpDtFrom} AND #{rcpDtTo} /* 약정접수일시 */
                              <if test='@MybatisUtils@equals(dvCd, "02")'> /* 구분 = 02 : 예약 */
                                  AND T3.BOO_SELL_TP_CD IS NOT NULL /* 예약판매유형코드 */
                              </if>
                          </when>
                          <when test='@MybatisUtils@equals(dvCd, "03")'>  /* 구분 = 03 : 매출 */
                              AND SUBSTR(T1.STPL_CNFM_DTM, 0, 8) BETWEEN #{rcpDtFrom} AND #{rcpDtTo} /* 약정확정일시 */
                          </when>
                      </choose>

                      <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                          AND T1.RCP_PRTNR_NO = #{prtnrNo} /* 파트너번호 */
                      </if>
               </if>
             ) A1
         INNER JOIN
             (
               SELECT T1.BASE_YM /* 기준년월 */
                    , T1.OG_TP_CD /* 조직유형코드 */
                    , T1.OG_CD /* 조직코드 */
                    , T2.PRTNR_NO /* 파트너번호 */
                    , T2.PRTNR_KNM /* 파트너명 */
                    , T1.DGR1_LEVL_DG_PRTNR_NO /* 1차레벨대표파트너번호 */
                    , T1.DGR2_LEVL_DG_PRTNR_NO /* 2차레벨대표파트너번호 */
                    , T1.DGR3_LEVL_DG_PRTNR_NO /* 3차레벨대표파트너번호 */
                    , T1.DGR4_LEVL_DG_PRTNR_NO /* 4차레벨대표파트너번호 */
                    , T1.DGR5_LEVL_DG_PRTNR_NO /* 5차레벨대표파트너번호 */
                    , T1.DGR1_LEVL_DG_PRTNR_NM /* 1차레벨대표파트너명 */
                    , T1.DGR2_LEVL_DG_PRTNR_NM /* 2차레벨대표파트너명 */
                    , T1.DGR3_LEVL_DG_PRTNR_NM /* 3차레벨대표파트너명 */
                    , T1.DGR4_LEVL_DG_PRTNR_NM /* 4차레벨대표파트너명 */
                    , T1.DGR5_LEVL_DG_PRTNR_NM /* 5차레벨대표파트너명 */
                 FROM TB_OGBS_MM_OG_IZ T1 /* 월조직내역 */
                INNER JOIN TB_OGBS_MM_PRTNR_IZ T2 /* 월파트너내역 */
                   ON T1.BASE_YM = T2.BASE_YM /* 기준년월 */
                  AND T1.OG_TP_CD = T2.OG_TP_CD /* 조직유형코드 */
                  AND T1.OG_ID = T2.OG_ID /* 조직ID */
                  AND T2.DTA_DL_YN = 'N'
                WHERE 1=1
                  AND T1.DTA_DL_YN = 'N'
                  AND T1.BASE_YM = SUBSTR(#{rcpDtFrom}, 0, 6) /* 기준년월 */
                  AND T1.OG_TP_CD = 'W02'

                  <if test='@MybatisUtils@isNotEmpty(ogLevl1)'>
                      AND T1.DGR1_LEVL_OG_ID = #{ogLevl1}
                  </if>

                  <if test='@MybatisUtils@isNotEmpty(ogLevl2)'>
                      AND T1.DGR2_LEVL_OG_ID = #{ogLevl2}
                  </if>

                  <if test='@MybatisUtils@isNotEmpty(ogLevl3)'>
                      AND T1.DGR3_LEVL_OG_ID = #{ogLevl3}
                  </if>

                  <if test='@MybatisUtils@isNotEmpty(ogLevl4)'>
                      AND T1.DGR4_LEVL_OG_ID = #{ogLevl4}
                  </if>

                  <if test='@MybatisUtils@isNotEmpty(ogLevl5)'>
                      AND T1.DGR5_LEVL_OG_ID = #{ogLevl5}
                  </if>

                  <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                      AND T2.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
                  </if>
             ) A2
            ON A1.BASE_YM = A2.BASE_YM
           AND A1.OG_TP_CD = A2.OG_TP_CD
           AND A1.PRTNR_NO = A2.PRTNR_NO
         WHERE 1=1

         <if test='@MybatisUtils@isNotEmpty(feePerfTpCd)'>
             AND A1.FEE_PERF_TP_CD = #{feePerfTpCd} /* 수수료실적유형코드 */
         </if>

         <choose>
             <when test='@MybatisUtils@isNotEmpty(cancDtFrom) and @MybatisUtils@isNotEmpty(cancDtTo)'>
                 AND (A1.CAN_DT BETWEEN #{cancDtFrom} AND #{cancDtTo} OR A1.CAN_DT BETWEEN #{cancDtTo} AND #{cancDtFrom})/* 취소일자 */
             </when>
             <when test='@MybatisUtils@isNotEmpty(cancDtFrom)'>
                 AND A1.CAN_DT <![CDATA[>=]]> #{cancDtFrom} /* 취소일자 */
             </when>
             <when test='@MybatisUtils@isNotEmpty(cancDtTo)'>
                 AND A1.CAN_DT <![CDATA[<=]]> #{cancDtTo} /* 취소일자 */
             </when>
         </choose>

         <choose>
             <when test='@MybatisUtils@isNotEmpty(pdCdFrom) and @MybatisUtils@isNotEmpty(pdCdTo)'>
                 AND (A1.BASE_PD_CD BETWEEN #{pdCdFrom} AND #{pdCdTo} OR A1.BASE_PD_CD BETWEEN #{pdCdTo} AND #{pdCdFrom}) /* 상품코드 */
             </when>
             <when test='@MybatisUtils@isNotEmpty(pdCdFrom)'>
                 AND A1.BASE_PD_CD <![CDATA[>=]]> #{pdCdFrom} /* 상품코드 */
             </when>
             <when test='@MybatisUtils@isNotEmpty(pdCdTo)'>
                 AND A1.BASE_PD_CD <![CDATA[<=]]> #{pdCdTo} /* 상품코드 */
             </when>
         </choose>

         <choose>
             <when test='@MybatisUtils@isNotEmpty(pkgCdFrom) and @MybatisUtils@isNotEmpty(pkgCdTo)'>
                 AND (A1.PKG_CD BETWEEN #{pkgCdFrom} AND #{pkgCdTo} OR A1.PKG_CD BETWEEN #{pkgCdTo} AND #{pkgCdFrom}) /* 패키지코드 */
             </when>
             <when test='@MybatisUtils@isNotEmpty(pkgCdFrom)'>
                 AND A1.PKG_CD <![CDATA[>=]]> #{pkgCdFrom} /* 패키지코드 */
             </when>
             <when test='@MybatisUtils@isNotEmpty(pkgCdTo)'>
                 AND A1.PKG_CD <![CDATA[<=]]> #{pkgCdTo} /* 패키지코드 */
             </when>
         </choose>

         <if test='@MybatisUtils@isNotEmpty(feePdctTpCd)'> /* 수수료제품유형코드 */
             AND A1.FEE_PDCT_TP_CD = #{feePdctTpCd} /* 수수료제품유형코드 */
         </if>

        ORDER BY A1.OG_TP_CD, A2.OG_CD, A1.PRTNR_NO
    </select>

    <select id='selectManagerAggregateOrders'
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaOrganizationNetOrderDto$SearchMngerAggregateRes">
        SELECT A2.OG_CD /* 조직코드 */
             , A1.PRTNR_NO /* 파트너번호 */
             , A2.PRTNR_KNM /* 파트너명 */
             , CASE WHEN A1.SELL_TP_CD = '1' THEN '01' /* 일시불 */
                    WHEN A1.SELL_TP_CD = '2' THEN '02' /* 렌탈/리스 */
                    WHEN A1.SELL_TP_CD = '3' THEN '03' /* 멤버십 */
                    WHEN A1.SELL_TP_CD = '6' THEN '04' /* 정기배송 */
                    WHEN A1.SELL_TP_CD = '05' THEN '05' /* 재약정 */
               END AS SELL_TP_CD /* 판매유형코드 */
             , A1.FEE_PDCT_TP_CD /* 수수료제품유형코드 */
             , A1.RGLR_SPP_PRC_DV_CD /* 정기배송가격구분코드 */
             , A1.MCHN_CH_TP_CD /* 기기변경유형코드 */
             , A1.FEE_PERF_TP_CD /* 수수료실적유형코드 */
             , A1.CNTR_NO || '-' || A1.CNTR_SN AS CNTR_NO /* 계약번호, 계약일련번호 */
             , A1.COPN_DV_CD /* 법인격구분코드 */
             , A1.PD_NM /* 상품명 */
             , A1.BASE_PD_CD /* 기준상품코드 */
             , CASE WHEN A1.SELL_TP_CD = '1' THEN F_CMZ_CD_NM('TNT_WELLS', 'SPAY_DSC_DV_CD', A1.SELL_DSC_DV_CD)
                    WHEN A1.SELL_TP_CD = '2' THEN F_CMZ_CD_NM('TNT_WELLS', 'RENTAL_DSC_DV_CD', A1.SELL_DSC_DV_CD)
                    WHEN A1.SELL_TP_CD = '3' THEN F_CMZ_CD_NM('TNT_WELLS', 'MSH_DSC_DV_CD', A1.SELL_DSC_DV_CD)
               END AS SELL_DSC_DV_CD /* 판매할인구분코드 */
             , CASE WHEN A1.SELL_TP_CD = '1' THEN F_CMZ_CD_NM('TNT_WELLS', 'SPAY_DSCR_CD', A1.SELL_DSCR_CD)
                    WHEN A1.SELL_TP_CD = '2' THEN F_CMZ_CD_NM('TNT_WELLS', 'RENTAL_CRP_DSCR_CD', A1.SELL_DSCR_CD)
               END AS SELL_DSCR_CD /* 판매할인율코드 */
             , CASE WHEN A1.SELL_TP_CD = '2' THEN F_CMZ_CD_NM('TNT_WELLS', 'RENTAL_DSC_TP_CD', A1.SELL_DSC_TP_CD)
                    WHEN A1.SELL_TP_CD = '3' THEN F_CMZ_CD_NM('TNT_WELLS', 'MSH_DSC_TP_CD', A1.SELL_DSC_TP_CD)
               END AS SELL_DSC_TP_CD /* 판매할인유형코드 */
             , A1.COMBI_DV /* 결합구분코드 */
             , A1.CNTR_PTRM /* 계약기간 */
             , A1.STPL_PTRM /* 약정기간 */
             , A1.SV_PRD /* 서비스주기 */
             , A1.ACKMT_PERF_AMT /* 인정실적금액 */
             , A1.FEE_ACKMT_BASE_AMT /* 수수료인정기준금액 */
             , A1.HCR /* 홈케어 */
             , A1.HCR_MSH_Y3 /* 홈케어멤버십3년 */
             , A1.FEE_FXAM_YN /* 정액여부 */
             , A1.FNN_LEASE /* 금융리스 */
             , A1.FEE_ACKMT_CT /* 수수료인정건수 */
             , CASE WHEN A1.SELL_TP_CD IN (1, 2) THEN /* 일시불, 렌탈 */
                    CASE WHEN A1.FEE_ACKMT_CT = 0 THEN 0
                         WHEN A1.SELL_TP_CD = '6' OR A1.RSTL_YN = 'Y' THEN A1.FEE_ACKMT_CT
                         WHEN A1.BS_FEE_ACKMT_CT1 + A1.BS_FEE_ACKMT_CT2 + A1.BS_FEE_ACKMT_CT3 + A1.BS_FEE_ACKMT_CT4 = 0 THEN 0
                         WHEN NVL(A1.ROW_SCNT1, 0) + NVL(A1.ROW_SCNT2, 0) = 0 THEN 0
                         ELSE 1
                    END
                    WHEN A1.SELL_TP_CD IN (6) THEN /* 정기배송 */
                         CASE WHEN A1.SELL_TP_DTL_CD = '62' AND A1.ACKMT_PERF_AMT <![CDATA[>]]> 2 THEN 1
                              ELSE 0
                         END
                    ELSE A1.ACKMT_PERF_AMT
               END AS BS_FEE_ACKMT_CT /* BS수수료인정건수 */
             , A1.NW_SELL_CT /* 신규판매건수 */
             , A1.BFSVC_OJ_YN /* BS대상여부 */
             , A1.RSTL_YN /* 재약정여부 */
             , A2.DGR3_LEVL_DG_PRTNR_NO /* 3차레벨대표파트너번호 */
             , A2.DGR3_LEVL_DG_PRTNR_NM /* 3차레벨대표파트너명 */
             , A1.SELL_AMT /* 판매금액 */
             , A1.PMOT_NO /* 프로모션번호 */
             , A1.PKG_CD /* 패키지코드 */
             , A1.PKG_SN /* 패키지일련번호 */
             , A1.CNTR_CNFM_DTM /* 계약확정일시 */
             , A1.SL_DT /* 매출일자 */
             , A1.CAN_DT /* 취소일자 */
             , A1.REQD_DT /* 철거일자 */
             , A1.OJ_DTL_CNTR_NO AS MCHN_CST_CD /* 기기고객코드 */
             , A1.MCHN_PD_CD /* 기기상품코드 */
             , A1.PERF_EXCD_RGST_YN /* 실적제외등록여부 */
          FROM
             (
               SELECT T1.BASE_YM /* 기준년월 */
                    , T1.OG_TP_CD /* 조직유형코드 */
                    , T1.PRTNR_NO /* 파트너번호 */
                    , T3.SELL_TP_CD /* 판매유형코드 */
                    , T6.FEE_PDCT_TP_CD1 AS FEE_PDCT_TP_CD /* 수수료제품유형코드 */
                    , T8.PD_PRP_VAL13 AS RGLR_SPP_PRC_DV_CD /* 정기배송가격구분코드 */
                    , T9.MCHN_CH_TP_CD /* 기기변경유형코드 */
                    , T10.FEE_PERF_TP_CD /* 수수료실적유형코드 */
                    , T1.CNTR_NO /* 계약번호 */
                    , T1.CNTR_SN /* 계약일련번호 */
                    , T2.COPN_DV_CD /* 법인격구분코드 */
                    , T4.PD_NM /* 상품명 */
                    , T3.BASE_PD_CD /* 기준상품코드 */
                    , T3.SELL_DSC_DV_CD /* 판매할인구분코드 */
                    , T3.SELL_DSCR_CD /* 판매할인율코드 */
                    , T3.SELL_DSC_TP_CD /* 판매할인유형코드 */
                    , CASE WHEN T13.COMBI_DV_CNT <![CDATA[>]]> 0 THEN 'Y'
                      END AS COMBI_DV /* 결합구분코드 */
                    , T3.CNTR_PTRM /* 계약기간 */
                    , T3.STPL_PTRM /* 약정기간 */
                    , T3.SV_PRD /* 서비스주기 */
                    , T3.ACKMT_PERF_AMT /* 인정실적금액 */
                    , T3.FEE_ACKMT_BASE_AMT /* 수수료인정기준금액 */
                    , CASE WHEN T10.FEE_PDCT_TP_CD = 'E' THEN
                           (CASE WHEN T3.SELL_TP_CD = '6' THEN (NVL(T3.FNL_AMT, 0) - NVL(T3.CNTRAM_DSC_AMT, 0)) / NVL(T3.SV_PRD, 0) ELSE T3.SELL_AMT END)
                           ELSE 0
                      END AS HCR /* 홈케어 */
                    , CASE WHEN T10.FEE_PDCT_TP_CD = 'E' AND T3.STPL_PTRM = '36' THEN 'Y'
                           ELSE ''
                      END AS HCR_MSH_Y3 /* 홈케어맴버십3년 */
                    , T3.FEE_FXAM_YN /* 정액여부 */
                    , CASE WHEN T3.SELL_TP_DTL_CD IN ('22', '24', '25', '26') THEN 'Y' ELSE 'N' END AS FNN_LEASE /* 금융리스 */
                    , T3.SELL_TP_DTL_CD /* 판매유형상세코드 */
                    , T3.FEE_ACKMT_CT /* 수수료인정건수 */
                    , CASE WHEN T3.SELL_TP_CD = '1' THEN /* 일시불 */
                           CASE WHEN T3.SELL_TP_DTL_CD != '12' AND T4.PD_CD != 'WP05110351'
                                     AND (T10.FEE_PERF_TP_CD = 'EH' OR T3.FEE_ACKMT_CT <![CDATA[>]]> 0)
                                     AND T3.ACKMT_PERF_AMT <![CDATA[>]]> 0 THEN T3.FEE_ACKMT_CT
                                ELSE 0
                           END
                           WHEN T3.SELL_TP_CD = '2' THEN /* 렌탈 */
                           CASE WHEN T3.SELL_DSC_DV_CD ='5' AND T3.SELL_DSCR_CD IN ('5','6','9') AND T3.ACKMT_PERF_AMT <![CDATA[>]]> 2 THEN 0
                                WHEN T10.FEE_PERF_TP_CD != 'EH' THEN 0 /* 환경가전  */
                                WHEN (
                                       CASE WHEN T3.SELL_TP_CD = '2' THEN /* 렌탈 */
                                            CASE WHEN T9.MCHN_CPS_APYR = 0 THEN 'Y'
                                                 WHEN T1.MCHN_CH_YN = 'Y' AND T3.ACKMT_PERF_AMT = 0 THEN 'Y'
                                                 ELSE 'N'
                                            END
                                       END
                                     ) = 'N'
                                     AND T3.SELL_DSC_DV_CD !='5' AND T1.MCHN_CH_YN = 'Y' AND T9.MCHN_CH_TP_CD = '0' AND T3.ACKMT_PERF_AMT <![CDATA[>]]> 0 THEN T3.FEE_ACKMT_CT
                                WHEN (
                                       CASE WHEN T3.SELL_TP_CD = '2' THEN /* 렌탈 */
                                            CASE WHEN T9.MCHN_CPS_APYR = 0 THEN 'Y'
                                                 WHEN T1.MCHN_CH_YN = 'Y' AND T3.ACKMT_PERF_AMT = 0 THEN 'Y'
                                                 ELSE 'N'
                                            END
                                       END
                                     ) = 'N'
                                     AND T3.SELL_DSC_DV_CD !='5' AND T1.MCHN_CH_YN = 'N' AND T3.ACKMT_PERF_AMT <![CDATA[>]]> 0 THEN T3.FEE_ACKMT_CT
                                ELSE 0
                           END
<!--                           WHEN T3.SELL_TP_CD = '3' THEN /* 맴버십 */-->
<!--                           CASE WHEN T3.SELL_TP_DTL_CD = '33' AND T3.SELL_DSC_TP_CD = 'P1' THEN 1-->
<!--                                ELSE 0-->
<!--                           END-->
<!--                           WHEN T3.SELL_TP_CD = '6' THEN /* 정기배송 */-->
<!--                           CASE WHEN T3.SELL_TP_DTL_CD != '63' AND T3.ACKMT_PERF_AMT <![CDATA[>]]> 0 THEN T3.FEE_ACKMT_CT-->
<!--                                ELSE 0-->
<!--                           END-->
                      END AS BS_FEE_ACKMT_CT1 /* BS수수료인정건수1 */
                    , CASE WHEN T3.SELL_TP_CD = '2' THEN /* 렌탈 */
                           CASE WHEN (
                                       CASE WHEN T3.SELL_TP_CD = '2' THEN /* 렌탈 */
                                            CASE WHEN T9.MCHN_CPS_APYR = 0 THEN 'Y'
                                                 WHEN T1.MCHN_CH_YN = 'Y' AND T3.ACKMT_PERF_AMT = 0 THEN 'Y'
                                                 ELSE 'N'
                                            END
                                       END
                                     ) = 'N'
                                     AND T10.FEE_PERF_TP_CD = 'EH' AND T3.SELL_DSC_DV_CD !='5'
                                     AND T1.MCHN_CH_YN = 'Y'
                                     AND T9.MCHN_CH_TP_CD IN ('15','16','19') THEN T3.FEE_ACKMT_CT
                                ELSE 0
                           END
                      END AS BS_FEE_ACKMT_CT2 /* BS수수료인정건수2 */
                    , CASE WHEN T3.SELL_TP_CD = '2' THEN /* 렌탈 */
                           CASE WHEN (
                                       CASE WHEN T3.SELL_TP_CD = '2' THEN /* 렌탈 */
                                            CASE WHEN T9.MCHN_CPS_APYR = 0 THEN 'Y'
                                                 WHEN T1.MCHN_CH_YN = 'Y' AND T3.ACKMT_PERF_AMT = 0 THEN 'Y'
                                                 ELSE 'N'
                                            END
                                       END
                                     ) = 'N'
                                     AND T10.FEE_PERF_TP_CD = 'EH' AND T3.SELL_DSC_DV_CD ='5'
                                     AND T3.ACKMT_PERF_AMT <![CDATA[>]]> 0
                                     AND T9.MCHN_CH_TP_CD = '0' THEN T3.FEE_ACKMT_CT
                                ELSE 0
                           END
                      END AS BS_FEE_ACKMT_CT3 /* BS수수료인정건수3 */
                    , CASE WHEN T3.SELL_TP_CD = '2' THEN /* 렌탈 */
                           CASE WHEN (
                                       CASE WHEN T3.SELL_TP_CD = '2' THEN /* 렌탈 */
                                            CASE WHEN T9.MCHN_CPS_APYR = 0 THEN 'Y'
                                                 WHEN T1.MCHN_CH_YN = 'Y' AND T3.ACKMT_PERF_AMT = 0 THEN 'Y'
                                                 ELSE 'N'
                                            END
                                       END
                                     ) = 'N'
                                     AND T10.FEE_PERF_TP_CD = 'EH' AND T3.SELL_DSC_DV_CD ='5'
                                     AND T3.ACKMT_PERF_AMT <![CDATA[>]]> 0
                                     AND T9.MCHN_CH_TP_CD IN ('15','16','19') THEN T3.FEE_ACKMT_CT
                                ELSE 0
                           END
                      END AS BS_FEE_ACKMT_CT4 /* BS수수료인정건수4 */
                    , CASE WHEN T3.SELL_TP_CD = '1' THEN /* 일시불 */
                           CASE WHEN T1.MCHN_CH_YN = 'Y' AND T3.SELL_TP_DTL_CD != '12'
                                     AND T3.FEE_FXAM_YN = 'N' AND T3.ACKMT_PERF_AMT <![CDATA[>]]> 0
                                     AND T3.FEE_ACKMT_CT <![CDATA[>]]> 0 AND NVL(T14.ROW_SCNT, 0) + NVL(T15.ROW_SCNT, 0) <![CDATA[>]]> 0 THEN 1
                                ELSE 0
                           END
                           WHEN T3.SELL_TP_CD = '2' THEN /* 렌탈 */
                           CASE WHEN T1.MCHN_CH_YN = 'Y' OR T3.ACKMT_PERF_AMT = 0
                                     OR T3.FEE_ACKMT_CT = 0 OR NVL(T14.ROW_SCNT, 0) + NVL(T15.ROW_SCNT, 0) = 0 THEN 0
                                ELSE 1
                           END
                           WHEN T3.SELL_TP_CD = '6' THEN /* 정기배송 */
                           CASE WHEN T1.MCHN_CH_YN = 'Y' THEN 0
                                WHEN T3.SELL_TP_DTL_CD = '62' AND T3.ACKMT_PERF_AMT <![CDATA[>]]> 2 THEN 1
                                WHEN T3.ACKMT_PERF_AMT = 0 OR T3.FEE_ACKMT_CT = 0 OR NVL(T14.ROW_SCNT, 0) + NVL(T15.ROW_SCNT, 0) = 0 THEN 0
                                ELSE 1
                           END
                      END AS NW_SELL_CT /* 신규판매건수 */
                    , CASE WHEN T9.MCHN_CPS_APYR = 0 THEN 'Y'
                           WHEN T1.MCHN_CH_YN = 'Y' AND T3.ACKMT_PERF_AMT = 0 THEN 'Y'
                           ELSE 'N'
                      END AS ACKMT_PERF_EXCD_YN
                    , CASE WHEN T6.FEE_PDCT_TP_CD1 != 'B' AND NVL(T14.ROW_SCNT, 0) + NVL(T15.ROW_SCNT, 0) <![CDATA[>]]> 0 THEN 'Y' END AS BFSVC_OJ_YN /* BS대상여부 */
                    , T1.RSTL_YN /* 재약정여부 */
                    , SUBSTR(T2.CNTR_RCP_FSH_DTM, 0, 8) AS CNTR_CNFM_DTM /* 계약접수완료일시 */
                    , T1.SL_DT /* 매출일자 */
                    , T1.CAN_DT /* 취소일자 */
                    , T7.REQD_DT /* 철거일자 */
                    , CASE WHEN T3.SELL_TP_CD = '6' THEN (NVL(T3.FNL_AMT, 0)- NVL(T3.CNTRAM_DSC_AMT, 0)) / NVL(T3.SV_PRD, 0)
                           ELSE T3.SELL_AMT
                      END AS SELL_AMT /* 판매금액 */
                    , T16.PMOT_CD AS PMOT_NO /* 프로모션번호 */
                    , T3.HGR_PD_CD AS PKG_CD /* 상위상품코드 */
                    , T17.CNTR_CST_GRP_ID AS PKG_SN /* 계약고객그룹ID */
                    , T12.OJ_DTL_CNTR_NO /* 대상상세계약번호 */
                    , T12.BASE_PD_CD AS MCHN_PD_CD /* 기기상품코드 */
                    , CASE WHEN NVL(T11.CNTR_NO, 'N') = 'N' THEN 'N'
                           ELSE 'Y'
                      END AS PERF_EXCD_RGST_YN /* 실적제외등록여부 */
                    , NVL(T14.ROW_SCNT, 0) AS ROW_SCNT1
                    , NVL(T15.ROW_SCNT, 0) AS ROW_SCNT2
                 FROM TB_FEAM_WELS_NRCTR_MM_CL T1 /* 웰스순주문계약월마감 */
                INNER JOIN TB_SSCT_CNTR_BAS T2 /* 계약기본 */
                   ON T1.CNTR_NO = T2.CNTR_NO /* 계약번호 */
                  AND T2.DTA_DL_YN = 'N'
                INNER JOIN TB_SSCT_CNTR_DTL T3 /* 계약상세 */
                   ON T1.CNTR_NO = T3.CNTR_NO /* 계약번호 */
                  AND T1.CNTR_SN = T3.CNTR_SN /* 계약일련번호 */
                  AND T3.DTA_DL_YN = 'N'
                INNER JOIN TB_PDBS_PD_BAS T4 /* 상품기본 */
                   ON T3.BASE_PD_CD = T4.PD_CD /* 상품코드 */
                  AND T4.DTA_DL_YN = 'N'
                INNER JOIN TB_PDBS_PD_CLSF_BAS T5 /* 상품분류기본 */
                   ON T4.PD_CLSF_ID = T5.PD_CLSF_ID /* 상품분류ID */
                  AND T5.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T6 /* 웰스수수료제품유형기본 */
                   ON T3.BASE_PD_CD = T6.BASE_PD_CD /* 기준상품코드 */
                  AND SUBSTR(#{perfYm}, 0, 6) BETWEEN T6.APY_STRT_YM AND T6.APY_END_YM /* 적용시작년월, 적용종료년월 */
                  AND T6.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T7 /* 계약WELLS상세 */
                   ON T3.CNTR_NO = T7.CNTR_NO /* 계약번호 */
                  AND T3.CNTR_SN = T7.CNTR_SN /* 계약일련번호 */
                  AND T7.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL T8 /* 상품각사속성상세 */
                   ON T3.BASE_PD_CD = T8.PD_CD /* 상품코드 */
                  AND T8.PD_EXTS_PRP_GRP_CD = 'CNTR' /* 상품확장속성그룹코드 */
                  AND T8.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ T9 /* 기기변경내역 */
                   ON T1.CNTR_NO = T9.BASE_CNTR_NO /* 기준계약번호 */
                  AND T1.CNTR_SN = T9.BASE_CNTR_SN /* 기준계약일련번호 */
                  AND T9.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS T10 /* 웰스수수료실적유형기본 */
                   ON T6.FEE_PDCT_TP_CD1 = T10.FEE_PDCT_TP_CD /* 수수료제품유형코드 */
                  AND T3.SELL_TP_CD = T10.SELL_TP_CD /* 판매유형코드 */
                  AND T10.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN TB_FEDD_FEE_PERF_EXCD_OJ_BAS T11 /* 수수료실적제외대상기본 */
                   ON T1.CNTR_NO = T11.CNTR_NO /* 계약번호 */
                  AND T1.CNTR_SN = T11.CNTR_SN /* 계약일련번호 */
                  AND T11.FEE_PERF_EXCD_DV_CD = '01' /* 수수료실적제외구분코드 = 01 : 실적제외 */
                  AND SUBSTR(#{perfYm}, 0, 6) BETWEEN T11.APY_STRT_YM AND T11.APY_END_YM /* 적용시작년월, 적용종료년월 */
                  AND T11.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN LATERAL
                    (
                      SELECT S1.OJ_DTL_CNTR_NO /* 대상상세계약번호 */
                           , S2.BASE_PD_CD /* 기기상품코드 */
                        FROM TB_SSCT_CNTR_REL S1 /* 계약관계 */
                       INNER JOIN TB_SSCT_CNTR_DTL S2 /* 계약상세 */
                          ON S1.OJ_DTL_CNTR_NO = S2.CNTR_NO /* 계약번호 */
                         AND S1.OJ_DTL_CNTR_SN = S2.CNTR_SN /* 계약일련번호 */
                         AND S2.DTA_DL_YN = 'N'
                       WHERE 1=1
                         AND S1.BASE_DTL_CNTR_NO = T1.CNTR_NO /* 기준상세계약번호 */
                         AND S1.BASE_DTL_CNTR_SN = T1.CNTR_SN /* 기준상세계약일련번호 */
                         AND SUBSTR(T2.CNTR_RCP_FSH_DTM, 0, 8) BETWEEN SUBSTR(S1.VL_STRT_DTM, 0 ,8) AND SUBSTR(S1.VL_END_DTM, 0, 8) /* 유효시작일시, 유효종료일시 */
                         AND S1.CNTR_REL_DTL_CD = '216' /* 계약관계상세코드 = 216 : 모종결합 */
                         AND S1.DTA_DL_YN  = 'N'
                    ) T12
                   ON 1=1
                 LEFT OUTER JOIN LATERAL
                    (
                      SELECT COUNT(*) AS COMBI_DV_CNT
                        FROM TB_SSCT_CNTR_REL /* 계약관계 */
                       WHERE 1=1
                         AND DTA_DL_YN  = 'N'
                         AND OJ_DTL_CNTR_NO = T1.CNTR_NO /* 대상상세계약번호 */
                         AND OJ_DTL_CNTR_SN = T1.CNTR_SN /* 대상상세계약일련번호 */
                         AND SUBSTR(T2.CNTR_RCP_FSH_DTM, 0, 8) BETWEEN SUBSTR(VL_STRT_DTM, 0 ,8) AND SUBSTR(VL_END_DTM, 0, 8) /* 유효시작일시, 유효종료일시 */
                         AND CNTR_REL_DTL_CD = '216' /* 계약관계상세코드 = 216 : 모종결합 */
                    ) T13
                   ON 1=1
                 LEFT OUTER JOIN LATERAL
                    (
                      SELECT COUNT(*) AS ROW_SCNT
                        FROM TB_FEAM_WELS_SV_FEE_BAS /* 웰스서비스수수료기본 */
                       WHERE 1=1
                         AND BASE_PD_CD = T3.BASE_PD_CD /* 기준상품코드 */
                         AND VST_MCN = 0 /* 방문개월수 */
                         AND SUBSTR(#{perfYm}, 0, 6) BETWEEN APY_STRT_YM AND APY_END_YM /* 적용시작년월, 적용종료년월 */
                         AND DTA_DL_YN = 'N'
                    ) T14
                   ON 1=1
                 LEFT OUTER JOIN LATERAL
                    (
                      SELECT COUNT(*) AS ROW_SCNT
                        FROM TB_FEAM_WELS_SV_FEE_BAS /* 웰스서비스수수료기본 */
                       WHERE 1=1
                         AND DTA_DL_YN = 'N'
                         AND VST_MCN = 0 /* 방문개월수 */
                         AND SUBSTR(#{perfYm}, 0, 6) BETWEEN APY_STRT_YM AND APY_END_YM /* 적용시작년월, 적용종료년월 */
                         AND BASE_PD_CD IN /* 기준상품코드 */
                           (
                             SELECT S2.OJ_PD_CD /* 상품코드 */
                               FROM TB_PDBS_PD_BAS S1 /* 상품기본 */
                              INNER JOIN TB_PDBS_PD_REL S2 /* 상품관계 */
                                 ON S2.BASE_PD_CD = S1.PD_CD /* 상품코드 */
                                AND S2.PD_REL_TP_CD = '05' /* 상품관계유형코드 = 05 : 기준-제품 */
                                AND SUBSTR(#{perfYm}, 0, 6) BETWEEN SUBSTR(S2.VL_STRT_DTM, 0, 6)  AND SUBSTR(S2.VL_END_DTM, 0, 6) /* 유효시작일시, 유효종료일시 */
                                AND S2.DTA_DL_YN = 'N'
                              INNER JOIN TB_PDBS_PD_BAS S3 /* 상품기본 */
                                 ON S3.PD_CD = S2.OJ_PD_CD /* 대상상품코드 */
                                AND S3.PD_TP_CD = 'M' /* 상품유형코드 = M : 교재제품 */
                                AND S3.DTA_DL_YN = 'N'
                              WHERE 1=1
                                AND S1.DTA_DL_YN = 'N'
                                AND S1.PD_CD = T3.BASE_PD_CD /* 기준상품코드 */
                           )
                    ) T15
                   ON 1=1
                 LEFT OUTER JOIN LATERAL
                    (
                      SELECT PMOT_CD /* 프로모션코드 */
                           , RANK() OVER (PARTITION BY DTL_CNTR_NO, DTL_CNTR_SN ORDER BY PMOT_TP_CD, PMOT_CD) AS RK_NUM
                        FROM TB_SSCT_CNTR_PMOT_IZ /* 계약프로모션내역 */
                       WHERE 1=1
                         AND DTL_CNTR_NO = T1.CNTR_NO /* 상세계약번호 */
                         AND DTL_CNTR_SN = T1.CNTR_SN /* 상세계약일련번호 */
                         AND DTA_DL_YN = 'N'
                    ) T16
                   ON 1=1
                  AND RK_NUM = 1
                 LEFT OUTER JOIN TB_SSCT_CNTR_REL T17 /* 계약관계 */
                   ON T17.BASE_DTL_CNTR_NO = T1.CNTR_NO /* 기준상세계약번호 */
                  AND T17.BASE_DTL_CNTR_SN = T1.CNTR_SN /* 기준상세계약일련번호 */
                  AND T17.CNTR_REL_DTL_CD = '22W' /* 계약관계상세코드 = 22W : 패키지상품 */
                  AND SUBSTR(T2.CNTR_RCP_FSH_DTM, 0, 8) BETWEEN SUBSTR(T17.VL_STRT_DTM, 0 ,8) AND SUBSTR(T17.VL_END_DTM, 0, 8) /* 유효시작일시, 유효종료일시 */
                  AND T17.DTA_DL_YN = 'N'
                WHERE 1=1
                  AND T1.DTA_DL_YN = 'N'
                  AND NVL(T1.ACC_NINC_YN, 'N') = 'N' /* 계정순증여부 */
                  AND T1.CNTR_PERF_CRT_DV_CD = '01' /* 계약실적생성구분코드 = 01 : 순주문 */
                  AND T1.BASE_YM = #{perfYm} /* 기준년월 */
                  AND T1.PERF_YM = #{perfYm} /* 실적년월 */
                  AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
                  AND T1.FEE_TCNT_DV_CD = #{feeTcntDvCd} /* 수수료차수구분코드 */
             ) A1
          LEFT OUTER JOIN
             (
               SELECT T1.BASE_YM /* 기준년월 */
                    , T1.OG_TP_CD /* 조직유형코드 */
                    , T1.OG_CD /* 조직코드 */
                    , T2.PRTNR_NO /* 파트너번호 */
                    , T2.PRTNR_KNM /* 파트너명 */
                    , T1.DGR1_LEVL_OG_ID /* 1차레벨조직ID */
                    , T1.DGR2_LEVL_OG_ID /* 2차레벨조직ID */
                    , T1.DGR3_LEVL_OG_ID /* 3차레벨조직ID */
                    , T1.DGR4_LEVL_OG_ID /* 4차레벨조직ID */
                    , T1.DGR5_LEVL_OG_ID /* 5차레벨조직ID */
                    , T1.DGR1_LEVL_DG_PRTNR_NO /* 1차레벨대표파트너번호 */
                    , T1.DGR2_LEVL_DG_PRTNR_NO /* 2차레벨대표파트너번호 */
                    , T1.DGR3_LEVL_DG_PRTNR_NO /* 3차레벨대표파트너번호 */
                    , T1.DGR4_LEVL_DG_PRTNR_NO /* 4차레벨대표파트너번호 */
                    , T1.DGR5_LEVL_DG_PRTNR_NO /* 5차레벨대표파트너번호 */
                    , T1.DGR1_LEVL_DG_PRTNR_NM /* 1차레벨대표파트너명 */
                    , T1.DGR2_LEVL_DG_PRTNR_NM /* 2차레벨대표파트너명 */
                    , T1.DGR3_LEVL_DG_PRTNR_NM /* 3차레벨대표파트너명 */
                    , T1.DGR4_LEVL_DG_PRTNR_NM /* 4차레벨대표파트너명 */
                    , T1.DGR5_LEVL_DG_PRTNR_NM /* 5차레벨대표파트너명 */
                 FROM TB_OGBS_MM_OG_IZ T1 /* 월조직내역 */
                INNER JOIN TB_OGBS_MM_PRTNR_IZ T2 /* 월파트너내역 */
                   ON T1.BASE_YM = T2.BASE_YM /* 기준년월 */
                  AND T1.OG_TP_CD = T2.OG_TP_CD /* 조직유형코드 */
                  AND T1.OG_ID = T2.OG_ID /* 조직ID */
                  AND T2.DTA_DL_YN = 'N'
                WHERE 1=1
                  AND T1.DTA_DL_YN = 'N'
                  AND T1.BASE_YM = #{perfYm} /* 기준년월 */
                  AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
             ) A2
            ON A1.BASE_YM = A2.BASE_YM /* 기준년월 */
           AND A1.OG_TP_CD = A2.OG_TP_CD /* 조직유형코드 */
           AND A1.PRTNR_NO = A2.PRTNR_NO /* 파트너번호 */
         WHERE 1=1

           <if test='@MybatisUtils@isNotEmpty(ogLevl1)'>
               AND A2.DGR1_LEVL_OG_ID = #{ogLevl1}
           </if>

           <if test='@MybatisUtils@isNotEmpty(ogLevl2)'>
               AND A2.DGR2_LEVL_OG_ID = #{ogLevl2}
           </if>

           <if test='@MybatisUtils@isNotEmpty(ogLevl3)'>
               AND A2.DGR3_LEVL_OG_ID = #{ogLevl3}
           </if>

           <if test='@MybatisUtils@isNotEmpty(ogLevl4)'>
               AND A2.DGR4_LEVL_OG_ID = #{ogLevl4}
           </if>

           <if test='@MybatisUtils@isNotEmpty(ogLevl5)'>
               AND A2.DGR5_LEVL_OG_ID = #{ogLevl5}
           </if>

           <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
               AND A1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
           </if>

         ORDER BY A1.OG_TP_CD, A2.OG_CD, A1.PRTNR_NO
    </select>

    <select id='selectManagerStatusOrders'
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaOrganizationNetOrderDto$SearchMngerStatusRes">
        SELECT A2.OG_CD /* 조직코드 */
             , A1.PRTNR_NO /* 파트너번호 */
             , A2.PRTNR_KNM /* 파트너명 */
             , A2.PSTN_DV_CD /* 직급구분코드 */
             , MAX(A1.EH_CNT) AS EH_CNT /* 가전건수 */
             , MAX(A1.EX_CNT) AS EX_CNT /* 가전외건수 */
             , MAX(A1.ET_CNT) AS ET_CNT /* 기타건수 */
             , MAX(A1.UP_CNT) AS UP_CNT /* 미지급건수 */
             , MAX(A1.EH_CNT)+ MAX(A1.EX_CNT)+ MAX(A1.ET_CNT)+ MAX(A1.UP_CNT) AS TOT_CNT /* 총 건수 */
             , MAX(A1.EH_AMT) AS EH_AMT /* 가전금액 */
             , MAX(A1.EX_AMT) AS EX_AMT /* 가전외금액 */
             , MAX(A1.ET_AMT) AS ET_AMT /* 기타금액 */
             , MAX(A1.UP_AMT) AS UP_AMT /* 미지급금액 */
             , MAX(A1.EH_AMT)+ MAX(A1.EX_AMT)+ MAX(A1.ET_AMT)+ MAX(A1.UP_AMT) AS TOT_AMT /* 총 금액 */
             , MAX(A1.ELHM_ACKMT_CT) AS ELHM_ACKMT_CT /* 가전인정건수 */
             , MAX(A1.RENTAL_BASE_PRC) AS RENTAL_BASE_PRC /* 렌탈기준가 */
             , MAX(A1.SNGL_PMNT_BASE_PRC) AS SNGL_PMNT_BASE_PRC /* 일시불기준가 */
             , MAX(A1.CHNG) AS CHNG /* 기변 */
             , MAX(A1.NINC) AS NINC /* 순증 */
             , MAX(A1.FXAM_CT) AS FXAM_CT /* 정액건수 */
             , MAX(A1.RSTL_CT) AS RSTL_CT /* 재약정건수 */
             , MAX(A1.LIVE_PAKG) AS LIVE_PAKG /* 라이브팩 */
             , MAX(A1.MMBR) AS MMBR /* 멤버십 */
          FROM
             (
               SELECT S1.PRTNR_NO /* 파트너번호 */
                    , NVL(SUM(S1.EH_CNT), 0) AS EH_CNT /* 가전건수 */
                    , NVL(SUM(S1.EX_CNT), 0) AS EX_CNT /* 가전외건수 */
                    , NVL(SUM(S1.ET_CNT), 0) AS ET_CNT /* 기타건수 */
                    , NVL(SUM(S1.UP_CNT), 0) AS UP_CNT /* 미지급건수 */
                    , 0 AS EH_AMT /* 가전금액 */
                    , 0 AS EX_AMT /* 가전외금액 */
                    , 0 AS ET_AMT /* 기타금액 */
                    , 0 AS UP_AMT /* 미지급금액 */
                    , 0 AS ELHM_ACKMT_CT /* 가전인정건수 */
                    , 0 AS RENTAL_BASE_PRC /* 렌탈기준가 */
                    , 0 AS SNGL_PMNT_BASE_PRC /* 일시불기준가 */
                    , 0 AS CHNG /* 기변 */
                    , 0 AS NINC /* 순증 */
                    , 0 AS FXAM_CT /* 정액건수 */
                    , 0 AS RSTL_CT /* 재약정건수 */
                    , 0 AS LIVE_PAKG /* 라이브팩 */
                    , 0 AS MMBR /* 멤버십 */
                 FROM
                    (
                      SELECT T1.PRTNR_NO /* 파트너번호 */
                           , CASE WHEN T3.FEE_PERF_TP_CD = 'EH' THEN T1.ACKMT_PERF_CT END AS EH_CNT /* 가전건수 */
                           , CASE WHEN T3.FEE_PERF_TP_CD = 'EX' THEN T1.ACKMT_PERF_CT END AS EX_CNT /* 가전외건수 */
                           , CASE WHEN T3.FEE_PERF_TP_CD = 'ET' THEN T1.ACKMT_PERF_CT END AS ET_CNT /* 기타건수 */
                           , CASE WHEN T3.FEE_PERF_TP_CD = 'UP' THEN T1.ACKMT_PERF_CT END AS UP_CNT /* 미지급건수 */
                        FROM TB_FEAM_WELS_NRCTR_MM_CL T1 /* 웰스순주문계약월마감 */
                       INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T2 /* 웰스수수료제품유형기본 */
                          ON T1.PD_CD = T2.BASE_PD_CD /* 상품코드 */
                         AND #{perfYm} BETWEEN T2.APY_STRT_YM AND T2.APY_END_YM /* 적용시작년월, 적용종료년월 */
                         AND T2.DTA_DL_YN = 'N'
                       INNER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS T3 /* 웰스수수료실적유형기본 */
                          ON T2.FEE_PDCT_TP_CD1 = T3.FEE_PDCT_TP_CD /* 수수료제품유형코드1 */
                         AND T1.SELL_TP_CD = T3.SELL_TP_CD /* 판매유형코드 */
                         AND T3.DTA_DL_YN = 'N'
                       WHERE 1=1
                         AND T1.DTA_DL_YN = 'N'
                         AND T1.BASE_YM = #{perfYm} /* 기준년월 */
                         AND T1.PERF_YM = #{perfYm} /* 실적년월 */
                         AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
                         AND T1.FEE_TCNT_DV_CD = #{feeTcntDvCd} /* 수수료차수구분코드 */
                         AND T1.CNTR_PERF_CRT_DV_CD = '01' /* 계약실적생성구분코드 */
                         AND T1.ACKMT_PERF_CT <![CDATA[>]]> 0 /* 인정실적건수 */
                         AND NVL(T1.ACC_NINC_YN,'N') = 'N' /* 계정순증여부 */
                     ) S1
                 GROUP BY S1.PRTNR_NO

                 UNION ALL

                SELECT S1.PRTNR_NO /* 파트너번호 */
                     , 0 AS EH_CNT /* 가전건수 */
                     , 0 AS EX_CNT /* 가전외건수 */
                     , 0 AS ET_CNT /* 기타건수 */
                     , 0 AS UP_CNT /* 미지급건수 */
                     , NVL(SUM(S1.EH_AMT), 0) AS EH_AMT /* 가전금액 */
                     , NVL(SUM(S1.EX_AMT), 0) AS EX_AMT /* 가전외금액 */
                     , NVL(SUM(S1.ET_AMT), 0) AS ET_AMT /* 기타금액 */
                     , NVL(SUM(S1.UP_AMT), 0) AS UP_AMT /* 미지급금액 */
                     , 0 AS ELHM_ACKMT_CT /* 가전인정건수 */
                     , 0 AS RENTAL_BASE_PRC /* 렌탈기준가 */
                     , 0 AS SNGL_PMNT_BASE_PRC /* 일시불기준가 */
                     , 0 AS CHNG /* 기변 */
                     , 0 AS NINC /* 순증 */
                     , 0 AS FXAM_CT /* 정액건수 */
                     , 0 AS RSTL_CT /* 재약정건수 */
                     , 0 AS LIVE_PAKG /* 라이브팩 */
                     , 0 AS MMBR /* 멤버십 */
                  FROM
                     (
                       SELECT T1.PRTNR_NO /* 파트너번호 */
                            , CASE WHEN T3.FEE_PERF_TP_CD = 'EH' THEN T1.ACKMT_PERF_AMT END AS EH_AMT /* 가전금액 */
                            , CASE WHEN T3.FEE_PERF_TP_CD = 'EX' THEN T1.ACKMT_PERF_AMT END AS EX_AMT /* 가전외금액 */
                            , CASE WHEN T3.FEE_PERF_TP_CD = 'ET' THEN T1.ACKMT_PERF_AMT END AS ET_AMT /* 기타금액 */
                            , CASE WHEN T3.FEE_PERF_TP_CD = 'UP' THEN T1.ACKMT_PERF_AMT END AS UP_AMT /* 미지급금액 */
                         FROM TB_FEAM_WELS_NRCTR_MM_CL T1 /* 웰스순주문계약월마감 */
                        INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T2 /* 웰스수수료제품유형기본 */
                           ON T1.PD_CD = T2.BASE_PD_CD /* 상품코드 */
                          AND #{perfYm} BETWEEN T2.APY_STRT_YM AND T2.APY_END_YM /* 적용시작년월, 적용종료년월 */
                          AND T2.DTA_DL_YN = 'N'
                        INNER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS T3 /* 웰스수수료실적유형기본 */
                           ON T2.FEE_PDCT_TP_CD1 = T3.FEE_PDCT_TP_CD /* 수수료제품유형코드1 */
                          AND T1.SELL_TP_CD = T3.SELL_TP_CD /* 판매유형코드 */
                          AND T3.DTA_DL_YN = 'N'
                        WHERE 1=1
                          AND T1.DTA_DL_YN = 'N'
                          AND T1.BASE_YM = #{perfYm} /* 기준년월 */
                          AND T1.PERF_YM = #{perfYm} /* 실적년월 */
                          AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
                          AND T1.FEE_TCNT_DV_CD = #{feeTcntDvCd} /* 수수료차수구분코드 */
                          AND T1.CNTR_PERF_CRT_DV_CD = '01' /* 계약실적생성구분코드 */
                          AND T1.ACKMT_PERF_AMT <![CDATA[>]]> 0 /* 인정실적금액 */
                          AND NVL(T1.ACC_NINC_YN,'N') = 'N' /* 계정순증여부 */
                     ) S1
                 GROUP BY S1.PRTNR_NO

                 UNION ALL

                SELECT S1.PRTNR_NO /* 파트너번호 */
                     , 0 AS EH_CNT /* 가전건수 */
                     , 0 AS EX_CNT /* 가전외건수 */
                     , 0 AS ET_CNT /* 기타건수 */
                     , 0 AS UP_CNT /* 미지급건수 */
                     , 0 AS EH_AMT /* 가전금액 */
                     , 0 AS EX_AMT /* 가전외금액 */
                     , 0 AS ET_AMT /* 기타금액 */
                     , 0 AS UP_AMT /* 미지급금액 */
                     , NVL(SUM(ELHM_ACKMT_CT), 0) AS ELHM_ACKMT_CT /* 가전인정건수 */
                     , NVL(SUM(RENTAL_BASE_PRC), 0) AS RENTAL_BASE_PRC /* 렌탈기준가 */
                     , NVL(SUM(SNGL_PMNT_BASE_PRC), 0) AS SNGL_PMNT_BASE_PRC /* 일시불기준가 */
                     , NVL(SUM(CHNG1), 0) + NVL(SUM(CHNG2), 0) AS CHNG /* 기변 */
                     , NVL(SUM(NINC), 0) AS NINC /* 순증 */
                     , NVL(SUM(FXAM1), 0) + NVL(SUM(FXAM2), 0) AS FXAM_CT /* 정액 */
                     , NVL(SUM(RSTL_CT), 0) AS RSTL_CT /* 재약정금액 */
                     , NVL(SUM(LIVE_PAKG), 0) AS LIVE_PAKG /* 라이브팩 */
                     , NVL(SUM(MMBR), 0) AS MMBR /* 멤버십 */
                  FROM
                     (
                       SELECT T1.PRTNR_NO /* 파트너번호 */
                            , CASE WHEN T1.PERF_ATC_CD = 'W00P00011' THEN T1.PERF_VAL END AS ELHM_ACKMT_CT /* 가전인정건수 */
                            , CASE WHEN T1.PERF_ATC_CD = 'W00P00003' THEN T1.PERF_VAL END AS RENTAL_BASE_PRC /* 렌탈기준가 */
                            , CASE WHEN T1.PERF_ATC_CD = 'W00P00004' THEN T1.PERF_VAL END AS SNGL_PMNT_BASE_PRC /* 일시불기준가 */
                            , CASE WHEN T1.PERF_ATC_CD = 'W00P00014' THEN T1.PERF_VAL END AS CHNG1 /* 기변 */
                            , CASE WHEN T1.PERF_ATC_CD = 'W00P00018' THEN T1.PERF_VAL END AS CHNG2 /* 기변 */
                            , CASE WHEN T1.PERF_ATC_CD = 'W02P00113' THEN T1.PERF_VAL END AS NINC /* 순증 */
                            , CASE WHEN T1.PERF_ATC_CD = 'W00P00005' THEN T1.PERF_VAL END AS FXAM1 /* 환경-정액 */
                            , CASE WHEN T1.PERF_ATC_CD = 'W00P00007' THEN T1.PERF_VAL END AS FXAM2 /* 환경외-정액 */
                            , CASE WHEN T1.PERF_ATC_CD = 'W00P00078' THEN T1.PERF_VAL END AS RSTL_CT /* 재약정금액 */
                            , CASE WHEN T1.PERF_ATC_CD = 'W02P00105' THEN T1.PERF_VAL END AS LIVE_PAKG /* 라이브팩 */
                            , CASE WHEN T1.PERF_ATC_CD = 'W02P00086' THEN T1.PERF_VAL END AS MMBR /* 멤버십 */
                         FROM TB_FEAM_NTORP_PERF_MM_CL T1 /* 순주문파트너실적월마감 */
                        WHERE 1=1
                          AND T1.BASE_YM = #{perfYm} /* 기준년월 */
                          AND T1.PERF_YM = #{perfYm} /* 실적년월 */
                          AND T1.FEE_TCNT_DV_CD = #{feeTcntDvCd} /* 수수료차수구분코드 */
                          AND T1.PERF_AGRG_CRT_DV_CD = '201' /* 실적집계생성구분코드 */
                          AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
                          AND T1.PERF_VAL <![CDATA[>]]> 0 /* 실적값 */
                          AND DTA_DL_YN = 'N'
                          AND T1.PERF_DV_CD = '0' /* 실적구분코드 */

                          /* 실적항목코드 */
                          AND T1.PERF_ATC_CD IN ('W00P00011', 'W00P00003', 'W00P00004', /* 가전인정건수, 렌탈기준가, 일시불기준가 */
                                                 'W00P00014', 'W00P00018', 'W02P00113', 'W00P00005', /* 기변, 순증, 환경-정액 */
                                                 'W00P00007', 'W00P00078', 'W02P00105', 'W02P00086') /* 환경외-정액, 재약정금액, 라이브팩, 멤버십 */
                     ) S1
                 GROUP BY S1.PRTNR_NO
             ) A1
         INNER JOIN
             (
               SELECT T1.BASE_YM /* 기준년월 */
                    , T1.OG_TP_CD /* 조직유형코드 */
                    , T1.OG_CD /* 조직코드 */
                    , T2.PRTNR_NO /* 파트너번호 */
                    , T2.PRTNR_KNM /* 파트너명 */
                    , T2.PSTN_DV_CD /* 직급구분코드 */
                    , T1.DGR1_LEVL_DG_PRTNR_NO /* 1차레벨대표파트너번호 */
                    , T1.DGR2_LEVL_DG_PRTNR_NO /* 2차레벨대표파트너번호 */
                    , T1.DGR3_LEVL_DG_PRTNR_NO /* 3차레벨대표파트너번호 */
                    , T1.DGR4_LEVL_DG_PRTNR_NO /* 4차레벨대표파트너번호 */
                    , T1.DGR5_LEVL_DG_PRTNR_NO /* 5차레벨대표파트너번호 */
                    , T1.DGR1_LEVL_DG_PRTNR_NM /* 1차레벨대표파트너명 */
                    , T1.DGR2_LEVL_DG_PRTNR_NM /* 2차레벨대표파트너명 */
                    , T1.DGR3_LEVL_DG_PRTNR_NM /* 3차레벨대표파트너명 */
                    , T1.DGR4_LEVL_DG_PRTNR_NM /* 4차레벨대표파트너명 */
                    , T1.DGR5_LEVL_DG_PRTNR_NM /* 5차레벨대표파트너명 */
                 FROM TB_OGBS_MM_OG_IZ T1 /* 월조직내역 */
                INNER JOIN TB_OGBS_MM_PRTNR_IZ T2 /* 월파트너내역 */
                   ON T1.BASE_YM = T2.BASE_YM /* 기준년월 */
                  AND T1.OG_TP_CD = T2.OG_TP_CD /* 조직유형코드 */
                  AND T1.OG_ID = T2.OG_ID /* 조직ID */
                  AND T2.DTA_DL_YN = 'N'
                WHERE 1=1
                  AND T1.DTA_DL_YN = 'N'
                  AND T1.BASE_YM = #{perfYm} /* 기준년월 */
                  AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */

                  <if test='@MybatisUtils@isNotEmpty(ogLevl1)'>
                      AND T1.DGR1_LEVL_OG_ID = #{ogLevl1}
                  </if>

                  <if test='@MybatisUtils@isNotEmpty(ogLevl2)'>
                      AND T1.DGR2_LEVL_OG_ID = #{ogLevl2}
                  </if>

                  <if test='@MybatisUtils@isNotEmpty(ogLevl3)'>
                      AND T1.DGR3_LEVL_OG_ID = #{ogLevl3}
                  </if>

                  <if test='@MybatisUtils@isNotEmpty(ogLevl4)'>
                      AND T1.DGR4_LEVL_OG_ID = #{ogLevl4}
                  </if>

                  <if test='@MybatisUtils@isNotEmpty(ogLevl5)'>
                      AND T1.DGR5_LEVL_OG_ID = #{ogLevl5}
                  </if>

                  <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                      AND T2.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
                  </if>

                  <if test='@MybatisUtils@isNotEmpty(rsbDvCd)'>
                      AND T2.RSB_DV_CD = #{rsbDvCd}
                  </if>
             ) A2
           ON A1.PRTNR_NO = A2.PRTNR_NO /* 파트너번호 */
         WHERE 1=1
         GROUP BY A2.OG_CD, A1.PRTNR_NO, A2.PRTNR_KNM, A2.PSTN_DV_CD
    </select>

    <select id='selectPlanners'
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaOrganizationNetOrderDto$SearchPlarRes">
        SELECT T.OG1_LV /* 총괄단 !!!*/
             , T.OG2_LV /* 지역단 !!!*/
             , T.OG3_LV /* 지점 !!!*/
             , T.PRTNR_NO AS SEQUENCE_NUMBER /* 번호 !!!*/
             , T.PRTNR_KNM AS EMPL_NM /* 성명 !!!*/
             , T.SELL_TP_CD AS SEL_TYPE /* 판매유형 !!!*/
             , T.FEE_PERF_TP_CD AS PDCT_TP  /* 제품유형 !!!*/
             , T.MCHN_CH_TP_CD AS CHDVC_TP  /* 기변유형 !!!*/
             , T.FEE_PDCT_TP_CD AS FEE  /* 수수료 실적유형 !!!*/
             , T.CNTR_DTL_CD AS CNTR_DTL_NO   /* 계약상세번호 !!!*/
             , T.LCCGUB AS CST_DV   /* 고객구분 !!!*/
             , T.PD_NM AS PRDT_NM    /* 상품명 !!!*/
             , T.PD_CD AS PRDT_CODE    /* 상품코드 !!!*/
             , T.SV_PD_TP_CD AS USWY            /* 용도!!! */
             , CASE WHEN T.SELL_TP_CD = '1' THEN F_CMZ_CD_NM(#{session.tenantId}, 'SPAY_DSC_DV_CD', T.LCETC3)
                    WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_DSC_DV_CD', T.LCETC3)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'MSH_DSC_DV_CD', T.LCETC3)
                    ELSE T.LCETC3
                END AS PD_DC_CLASS /* 할인구분 !!!*/
             , CASE WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_CRP_DSCR_CD', T.LCETC4)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'PMOT_CD', T.LCETC4)
                    ELSE T.LCETC4
                END AS DISC_CODE /* 할인유형 !!!*/
             , CASE WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_DSC_TP_CD', T.SELL_DSC_TP_CD)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'MSH_DSC_TP_CD', T.SELL_DSC_TP_CD)
                    ELSE T.SELL_DSC_TP_CD END AS DSC_SYST /* 할인제도 !!!*/
             , T.LCST04 AS COMBI_DV /* 결합구분 !!!*/
             , CASE WHEN T.SELL_TP_CD = '1' THEN T.LCPAMT
                    WHEN T.SELL_TP_CD = '2' THEN TRUNC(T.FNL_AMT / 1.1 ) * 12
                    WHEN T.SELL_TP_CD = '6' AND T.STPL_PTRM > 0 THEN
                        CASE WHEN T.CNTRW_TP_CD = 6 THEN T.LCPAMT / (T.STPL_PTRM / 12)
                             ELSE T.LCPAMT * (T.STPL_PTRM / 12) END
                END AS DP_PERF /* 입금실적 !!!*/
             , T.LCMONT AS ISTM  /* 할부 !!!*/
             , T.HOMCARE AS HOME_CARE /* 홈케어 !!!*/
             , T.HOMCARE3_YEAR AS HCR_MSH_Y3 /* 홈케어멤버십3년 !!!!*/
             , T.LCST13 AS FXAM_YN /* 정액여부 !!!*/
             , T.LEASE_YN AS FNN_LEASE /* 금융리스  일단임시 */
             , T.RSTL_YN AS RECOMMITMENT           /* 재약정여부 !!!*/
             , T.LCCRTT AS CNTR_DATE /* 계약일자 !!!*/
             , T.LCSLET AS SL_DT /* 매출일자 !!!*/
             , T.LCCANT AS CANC_DT /* 취소일자 !!!*/
             , T.AKDBON AS BRMGR_NO /* 지점장번호 !!!*/
             , T.AKDBNM AS BRMGR_FNM /* 지점장성명 !!!*/
             , T.LCAMT1 AS RTLFE /* 렌탈료 !!!*/
             , T.STPL_PTRM AS STPL_MCNT           /* 약정개월 !!!*/
             , CASE WHEN T.SELL_TP_CD = '2' THEN
                 (SELECT MAX(P1.PD_PRP_VAL02)
                    FROM TB_PDBS_PD_ECOM_PRP_DTL P1
                   INNER JOIN TB_SSCT_CNTR_PD_REL P2
                      ON P1.PD_CD = P2.OJ_PD_CD
                     AND P2.CNTR_NO = SUBSTR(T.CNTR_DTL_CD,1,12)
                     AND P2.CNTR_SN = SUBSTR(T.CNTR_DTL_CD,13,1)
                     AND P2.PD_REL_TP_CD = '03'
                     AND P2.DTA_DL_YN = 'N'
                     AND NVL(T.CNTR_TEMP_SAVE_DTM,NVL(T.LCSLET,T.LCCANT)) BETWEEN P2.VL_STRT_DTM AND P2.VL_END_DTM
                   WHERE P1.DTA_DL_YN = 'N')
                END AS MNGT_PRD  /* 관리주기 !!!*/
             , T.LCPAMT AS PD_ACC_RSLT   /* 인정실적 !!!*/
             , T.LCCK02 AS PMOT_NO /* 프로모션번호!!!!! */
             , '0' AS PKG_SN    /* 패키지 일련번호!!!!! */
             , T.LCRCDE AS PKG_NO /*패키지 번호!!!!!*/
             , T2.BASE_YM AS NTOR_MM
             , CASE WHEN NVL(T.INTM_ORDR_PRDT,'0') != '0'
                         THEN SUBSTR(T.INTM_ORDR_PRDT,2,4)||'-'||SUBSTR(T.INTM_ORDR_PRDT,6,8)
               END AS MCHN_PD /* 기기상품코드!!! */
             , NVL(T.EX_YN,'N') AS PERF_EXCD /*실적제외등록여부!!! */
             , SUBSTR(T.CNTR_DT,1,6) AS BIZ_RGST_MM /*업무등록월 !!!*/
             , TRUNC(MONTHS_BETWEEN(TO_DATE(#{strtDt},'YYYYMMDD'),TO_DATE(SUBSTR(T.CNTR_DT,1,6)||'01','YYYYMMDD'))) AS BIZ_RGST_NM /*업무등록차월 !!!*/
             , CASE WHEN CAB.MEXNO_ENCR = PB.MEXNO_ENCR
                     AND CAB.CRAL_IDV_TNO = PB.CRAL_IDV_TNO
                     AND CAB.RCGVP_KNM = PB.PRTNR_KNM
                    THEN CASE WHEN MP.CLTN_DT IS NULL THEN '내부-재직' ELSE '내부-퇴사' END
                    WHEN CAB.MEXNO_ENCR = PB_L3.MEXNO_ENCR
                     AND CAB.CRAL_IDV_TNO = PB_L3.CRAL_IDV_TNO
                     AND CAB.RCGVP_KNM = PB_L3.PRTNR_KNM
                    THEN CASE WHEN MP_L3.CLTN_DT IS NULL THEN '내부(지점)-재직' ELSE '내부(지점)-퇴사' END
                    WHEN CAB.MEXNO_ENCR = PB_L2.MEXNO_ENCR
                     AND CAB.CRAL_IDV_TNO = PB_L2.CRAL_IDV_TNO
                     AND CAB.RCGVP_KNM = PB_L2.PRTNR_KNM
                    THEN CASE WHEN MP_L2.CLTN_DT IS NULL THEN '내부(지역)-재직' ELSE '내부(지역)-퇴사' END
                    WHEN CAB.MEXNO_ENCR = PB_L1.MEXNO_ENCR
                     AND CAB.CRAL_IDV_TNO = PB_L1.CRAL_IDV_TNO
                     AND CAB.RCGVP_KNM = PB_L1.PRTNR_KNM
                    THEN CASE WHEN MP_L1.CLTN_DT IS NULL THEN '내부(총괄)-재직' ELSE '내부(총괄)-퇴사' END
                END HS_PRCHS /* 본인구매 */
          FROM ( SELECT MO.DGR1_LEVL_OG_NM AS OG1_LV /* 총괄단 !!!*/
                      , MO.DGR2_LEVL_OG_NM AS OG2_LV /* 지역단 !!!*/
                      , MO.DGR3_LEVL_OG_NM AS OG3_LV /* 지점 !!!*/
                      , MP.PRTNR_NO  /* 번호 !!!*/
                      , MP.PRTNR_KNM  /* 성명 !!!*/
                      , CD.SELL_TP_CD /* 판매유형 !!!*/
                      , PF.FEE_PERF_TP_CD  /* 제품유형 !!!*/
                      , MC.MCHN_CH_TP_CD  /* 기변유형 !!!*/
                      , PF.FEE_PDCT_TP_CD
                      , CD.CNTR_NO||CD.CNTR_SN AS CNTR_DTL_CD   /* 계약상세번호 !!!*/
                      , CASE WHEN CB.COPN_DV_CD = '2' THEN  '사업' ELSE '개인' END AS LCCGUB    /* 고객구분 !!!*/
                      , PP.PD_NM     /* 상품명 !!!*/
                      , PP.PD_CD     /* 상품코드 !!!*/
                      , CD.SELL_DSC_DV_CD AS LCETC3  /* 할인구분 !!!*/
                      , CD.SELL_DSCR_CD  AS LCETC4  /* 할인유형 !!!*/
                      , CD.SELL_DSC_TP_CD /* 할인제도 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '2' AND (SELECT 1
                                                             FROM TB_SSCT_CNTR_REL SCR
                                                            INNER JOIN TB_SSCT_CNTR_DTL CD2
                                                               ON CD2.CNTR_NO = SCR.BASE_DTL_CNTR_NO
                                                              AND CD2.CNTR_SN = SCR.BASE_DTL_CNTR_SN
                                                              AND CD2.SELL_TP_CD = '6'                /* 정기배송 */
                                                            WHERE SCR.OJ_DTL_CNTR_NO = CD.CNTR_NO
                                                              AND SCR.OJ_DTL_CNTR_SN = CD.CNTR_SN
                                                              AND SCR.VL_END_DTM = '99991231235959'
                                                              AND SCR.DTA_DL_YN = 'N'
                                                              AND SCR.CNTR_REL_DTL_CD = '216' /* 모종의 경우만 결합 구분 */
                                                              AND ROWNUM = 1) > 0
                             THEN 'Y' END AS LCST04 /* 결합구분 !!!*/
                      , CD.ISTM_MCN AS LCMONT   /* 할부 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '1' THEN 0
                             ELSE CD.STPL_PTRM END AS STPL_PTRM /* 약정개월 !!!*/
                      , CD.ACKMT_PERF_AMT AS LCPAMT   /* 인정실적 !!!*/
                      , CASE WHEN PF.FEE_PDCT_TP_CD = 'E' THEN ( CASE WHEN CD.SELL_TP_CD = '6' THEN (CD.SELL_AMT- CD.CNTRAM_DSC_AMT )/ CD.SV_PRD
                                                                      ELSE CD.SELL_AMT
                                                                 END )
                             ELSE 0
                        END AS HOMCARE /* 홈케어 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '3' AND CD.STPL_PTRM = '36' THEN 'Y'
                             ELSE ' '
                        END  AS HOMCARE3_YEAR /* 홈케어멤버십3년 !!!!*/
                      , CD.FEE_FXAM_YN AS LCST13 /* 정액여부 !!!*/
                      , CASE WHEN CD.SELL_TP_DTL_CD IN ('22','24','25') THEN 'Y' ELSE 'N' END AS LEASE_YN  /* 금융리스 !!! */
                      , CD.RSTL_YN            /* 재약정여부 !!!*/
                      , SUBSTR(CB.CNTR_CNFM_DTM,1,8) AS LCCRTT /* 계약일자 !!!*/
                      , SUBSTR(CD.CNTR_PD_STRTDT,1,8) AS LCSLET /* 매출일자 !!!*/
                      , CASE WHEN CD.CNTR_DTL_STAT_CD IN ('301','303') THEN CNTR_PD_ENDDT END AS LCCANT  /* 취소일자 !!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NO AS AKDBON /* 지점장번호 !!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NM AS AKDBNM /* 지점장성명 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '6' THEN CD.FNL_AMT / CD.SV_PRD
                             ELSE CD.FNL_AMT END AS LCAMT1 /* 렌탈료 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN CP.PMOT_CD
                             ELSE '0'
                        END AS LCCK02 /* 프로모션번호!!!!! */
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN CD.HGR_PD_CD
                             ELSE '0'
                        END AS LCRCDE /*패키지 상품번호!!!!!*/
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN (SELECT CR.BASE_DTL_CNTR_NO /* 렌탈의 경우 정기배송 모종 계약 찾기 */
                                                              FROM TB_SSCT_CNTR_REL CR
                                                             WHERE CR.OJ_DTL_CNTR_NO = CD.CNTR_NO
                                                               AND CR.OJ_DTL_CNTR_SN = CD.CNTR_SN
                                                               AND CR.CNTR_REL_DTL_CD IN ('214','216') /* 정기배송, 모종의 경우만 기기코드 표기*/
                                                               AND ROWNUM = 1)
                             WHEN CD.SElL_TP_CD = '6' THEN (SELECT CR.OJ_DTL_CNTR_NO /* 모종 정기배송의 경우 렌탈 계약 찾기 */
                                                              FROM TB_SSCT_CNTR_REL CR
                                                             WHERE CR.BASE_DTL_CNTR_NO = CD.CNTR_NO
                                                               AND CR.BASE_DTL_CNTR_SN = CD.CNTR_SN
                                                               AND CR.CNTR_REL_DTL_CD IN ('214','216') /* 정기배송, 모종의 경우만 기기코드 표기*/
                                                               AND ROWNUM = 1)
                        END AS INTM_ORDR_PRDT/* 기기코드!!! */
                      , CASE WHEN EX.EX_SCNT = 1 THEN 'Y'
                        END AS EX_YN  /*실적제외등록여부!!! */
                      , MP.BASE_YM
                      , MP.OG_TP_CD
                      , MP.CNTR_DT
                      , PP.SV_PD_TP_CD
                      , CB.CNTR_TEMP_SAVE_DTM
                      , CD.FNL_AMT
                      , CD.SV_PRD
                      , CD.CNTRW_TP_CD
                   FROM TB_SSCT_CNTR_BAS CB
                  INNER JOIN TB_SSCT_CNTR_DTL CD
                     ON CB.CNTR_NO = CD.CNTR_NO
                    AND CD.CNTRW_TP_CD = (CASE WHEN CD.SELL_TP_CD = '3' THEN '5' ELSE CD.CNTRW_TP_CD END)
               <if test='@MybatisUtils@equals(sellTpCd, "0")'>
                    AND CD.SELL_TP_CD IN ('1','2','3','6')
               </if>
               <if test='@MybatisUtils@equals(sellTpCd, "7")'>
                    AND 1 = 2 /* 재약정은 따로 조회*/
               </if>
               <if test='!@MybatisUtils@equals(sellTpCd, "0") and !@MybatisUtils@equals(sellTpCd, "7")'>
                    AND CD.SELL_TP_CD = #{sellTpCd}
               </if>
               <if test='@MybatisUtils@equals(divCd, "03")'> /* 예약 */
                    AND CD.BOO_SELL_TP_CD = '2'
               </if>
               <if test='@MybatisUtils@equals(divCd, "01")'> /* 매출 */
                    AND NVL(CD.BOO_SELL_TP_CD,0) != '2'
               </if>

               <choose>
                   <when test='@MybatisUtils@isNotEmpty(pkgStrtCd) and @MybatisUtils@isNotEmpty(pkgEndCd)'>
                       AND (CD.HGR_PD_CD BETWEEN #{pkgStrtCd} AND #{pkgEndCd} OR CD.HGR_PD_CD BETWEEN #{pkgEndCd} AND #{pkgStrtCd})
                   </when>
                   <when test='@MybatisUtils@isNotEmpty(pkgStrtCd)'>
                       AND CD.HGR_PD_CD &gt;= #{pkgStrtCd}
                   </when>
                   <when test='@MybatisUtils@isNotEmpty(pkgEndCd)'>
                       AND CD.HGR_PD_CD &lt;= #{pkgEndCd}
                   </when>
               </choose>

               <if test='@MybatisUtils@equals(divCd, "01")'> /* 매출 */
                    AND TO_CHAR(TO_DATE(CD.CNTR_PD_STRTDT),'YYYYMMDD') BETWEEN #{strtDt} AND #{endDt}  /* 매출 확정일자 */
               </if>
                  INNER JOIN TB_OGBS_MM_PRTNR_IZ MP  /* 월파트너 */
                     ON CB.SELL_PRTNR_NO = MP.PRTNR_NO
                    AND CB.SELL_OG_TP_CD = MP.OG_TP_CD
                    AND MP.BASE_YM = SUBSTR(#{strtDt},1,6)
               <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                    AND MP.PRTNR_NO = #{prtnrNo}
               </if>
                  INNER JOIN TB_OGBS_MM_OG_IZ MO  /* 월조직 */
                     ON MP.BASE_YM = MO.BASE_YM
                    AND MP.OG_ID = MO.OG_ID
                    AND MP.OG_TP_CD = MO.OG_TP_CD
               <if test='@MybatisUtils@isNotEmpty(og1LevlId)'>
                    AND MO.DGR1_LEVL_OG_ID = #{og1LevlId}
               </if>
               <if test='@MybatisUtils@isNotEmpty(og2LevlId)'>
                    AND MO.DGR2_LEVL_OG_ID = #{og2LevlId}
               </if>
               <if test='@MybatisUtils@isNotEmpty(og3LevlId)'>
                    AND MO.DGR3_LEVL_OG_ID = #{og3LevlId}
               </if>
                  INNER JOIN TB_PDBS_PD_BAS PP
                     ON CD.BASE_PD_CD = PP.PD_CD
                     <choose>
                         <when test='@MybatisUtils@isNotEmpty(pdStrtCd) and @MybatisUtils@isNotEmpty(pdEndCd)'>
                             AND (PP.PD_CD BETWEEN #{pdStrtCd} AND #{pdEndCd} OR PP.PD_CD BETWEEN #{pdEndCd} AND #{pdStrtCd})
                         </when>
                         <when test='@MybatisUtils@isNotEmpty(pdStrtCd)'>
                             AND PP.PD_CD &gt;= #{pdStrtCd}
                         </when>
                         <when test='@MybatisUtils@isNotEmpty(pdEndCd)'>
                             AND PP.PD_CD &lt;=  #{pdEndCd}
                         </when>
                     </choose>
                  INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS PD
                     ON CD.BASE_PD_CD = PD.BASE_PD_CD
                    AND SUBSTR(#{strtDt},1,6) BETWEEN APY_STRT_YM AND APY_END_YM
                  INNER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS PF
                     ON PD.FEE_PDCT_TP_CD2 = PF.FEE_PDCT_TP_CD
                    AND CD.SELL_TP_CD = PF.SELL_TP_CD
               <if test='@MybatisUtils@isNotEmpty(pdctTpCd)'>
                    AND PF.FEE_PDCT_TP_CD = #{pdctTpCd}
               </if>
               <if test='@MybatisUtils@isNotEmpty(feePerfCd)'>
                    AND PF.FEE_PERF_TP_CD = #{feePerfCd}
               </if>
                   LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ MC
                     ON CD.CNTR_NO = MC.BASE_CNTR_NO
                    AND CD.CNTR_SN = MC.BASE_CNTR_SN
                   LEFT OUTER JOIN LATERAL ( SELECT A.PMOT_CD
                                                  , A.PMOT_TP_CD
                                                  , RANK() OVER (PARTITION BY (A.DTL_CNTR_NO || A.DTL_CNTR_SN) ORDER BY CNTR_PMOT_ID DESC) AS RK_NUM
                                               FROM TB_SSCT_CNTR_PMOT_IZ A
                                              WHERE A.DTL_CNTR_NO = CD.CNTR_NO
                                                AND A.DTL_CNTR_SN = CD.CNTR_SN
                                           )CP /* T프로모션 계약내역T */
                     ON 1=1
                    AND CP.RK_NUM = 1
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS ROW_SCNT
                                               FROM TB_FEAM_WELS_SV_FEE_BAS A
                                              WHERE A.BASE_PD_CD = CD.BASE_PD_CD
                                                AND A.VST_MCN = 0
                                                AND SUBSTR(CB.CNTR_CNFM_DTM,1,6) BETWEEN A.APY_STRT_YM AND A.APY_END_YM
                                           )WS
                     ON 1=1
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS EX_SCNT
                                               FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS A
                                              WHERE A.CNTR_NO = CD.CNTR_NO
                                                AND A.CNTR_SN = CD.CNTR_SN
                                                AND A.FEE_PERF_EXCD_DV_CD = '01'
                                           )EX
                     ON 1=1
                  WHERE CB.SELL_OG_TP_CD   = 'W01'
                    AND CB.DTA_DL_YN = 'N'
               <if test='!@MybatisUtils@equals(divCd, "01")'>
                    AND CB.CNTR_CNFM_DTM BETWEEN #{strtDt} AND  #{endDt} /* 계약확정일시 */
               </if>

               <choose>
                   <when test='@MybatisUtils@isNotEmpty(cancStrtDt) and @MybatisUtils@isNotEmpty(cancEndDt)'>
                       AND CD.CNTR_DTL_STAT_CD IN ('301','303')
                       AND (CD.CNTR_PD_ENDDT BETWEEN #{cancStrtDt} AND #{cancEndDt} OR CD.CNTR_PD_ENDDT BETWEEN #{cancEndDt} AND #{cancStrtDt})
                   </when>
                   <when test='@MybatisUtils@isNotEmpty(cancStrtDt)'>
                       AND (CD.CNTR_DTL_STAT_CD IN ('301','303') AND CD.CNTR_PD_ENDDT <![CDATA[>=]]> #{cancStrtDt})
                   </when>
                   <when test='@MybatisUtils@isNotEmpty(cancEndDt)'>
                       AND (CD.CNTR_DTL_STAT_CD IN ('301','303') AND CD.CNTR_PD_ENDDT <![CDATA[<=]]> #{cancEndDt})
                   </when>
               </choose>

               <if test='@MybatisUtils@equals(sellTpCd, "0") or @MybatisUtils@equals(sellTpCd, "7")'>
                    <if test='!@MybatisUtils@equals(divCd, "02")'>
                 UNION ALL
                 SELECT MO.DGR1_LEVL_OG_NM AS OG1_LV /* 총괄단 !!!*/
                      , MO.DGR2_LEVL_OG_NM AS OG2_LV /* 지역단 !!!*/
                      , MO.DGR3_LEVL_OG_NM AS OG3_LV /* 지점 !!!*/
                      , MP.PRTNR_NO  /* 번호 !!!*/
                      , MP.PRTNR_KNM  /* 성명 !!!*/
                      , CD.SELL_TP_CD /* 판매유형 !!!*/
                      , PF.FEE_PERF_TP_CD  /* 제품유형 !!!*/
                      , MC.MCHN_CH_TP_CD  /* 기변유형 !!!*/
                      , PF.FEE_PDCT_TP_CD
                      , CD.CNTR_NO||CD.CNTR_SN AS CNTR_DTL_CD    /* 계약상세번호 !!!*/
                      , CASE WHEN CB.COPN_DV_CD = '2' THEN  '사업' ELSE '개인' END AS LCCGUB    /* 고객구분 !!!*/
                      , PP.PD_NM     /* 상품명 !!!*/
                      , PP.PD_CD     /* 상품코드 !!!*/
                      , CD.SELL_DSC_DV_CD AS LCETC3  /* 할인구분 !!!*/
                      , CD.SELL_DSCR_CD  AS LCETC4  /* 할인유형 !!!*/
                      , CD.SELL_DSC_TP_CD /* 할인제도 !!!*/
                      , '' AS LCST04 /* 결합구분 !!!*/
                      , CD.ISTM_MCN AS LCMONT   /* 할부 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '1' THEN 0
                             ELSE CD.STPL_PTRM END AS STPL_PTRM /* 약정개월 !!!*/
                      , CD.ACKMT_PERF_AMT AS LCPAMT   /* 인정실적 !!!*/
                      , 0 AS HOMCARE /* 홈케어 !!!*/
                      , '' AS HOMCARE3_YEAR /* 홈케어멤버십3년 !!!!*/
                      , CD.FEE_FXAM_YN AS LCST13 /* 정액여부 !!!*/
                      , CASE WHEN CD.SELL_TP_DTL_CD IN ('22','24','25') THEN 'Y' ELSE 'N' END AS LEASE_YN  /* 금융리스 !!! */
                      , CD.RSTL_YN            /* 재약정여부 !!!*/
                      , SUBSTR(RI.STPL_STRTDT,1,8) AS LCCRTT /* 계약일자 !!!*/
                      , SUBSTR(RI.STPL_CNFM_DTM,1,8) AS LCSLET /* 매출일자 !!!*/
                      , CASE WHEN CD.CNTR_DTL_STAT_CD IN ('301','303') THEN CNTR_PD_ENDDT END AS LCCANT  /* 취소일자 !!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NO AS AKDBON /* 지점장번호 !!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NM AS AKDBNM /* 지점장성명 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '6' THEN CD.FNL_AMT / CD.SV_PRD
                             ELSE CD.FNL_AMT END AS LCAMT1 /* 렌탈료 !!!*/
                      , '0' AS LCCK02 /* 프로모션번호!!!!! */
                      , '' AS LCRCDE /*패키지 상품번호!!!!!*/
                      , '' AS INTM_ORDR_PRDT/* 기기코드!!! */
                      , CASE WHEN EX.EX_SCNT = 1 THEN 'Y' END AS EX_YN  /*실적제외등록여부!!! */
                      , MP.BASE_YM
                      , MP.OG_TP_CD
                      , MP.CNTR_DT
                      , PP.SV_PD_TP_CD
                      , CB.CNTR_TEMP_SAVE_DTM
                      , CD.FNL_AMT
                      , CD.SV_PRD
                      , CD.CNTRW_TP_CD
                   FROM ( SELECT A.CNTR_NO
                               , A.CNTR_SN
                               , A.STPL_STRTDT
                               , A.STPL_CNFM_DTM
                               , A.RCP_PRTNR_NO
                               , A.RCP_OG_TP_CD
                               , RANK() OVER (PARTITION BY (A.CNTR_NO) ORDER BY A.STPL_TN DESC) AS RK_NUM
					        FROM TB_SSCT_RENTAL_RSTL_IZ A
						   WHERE 1=1
                             AND A.RCP_OG_TP_CD = 'W01'
                         <if test='!@MybatisUtils@equals(divCd, "01")'>
                             AND A.STPL_STRTDT BETWEEN #{strtDt} AND  #{endDt} /* 계약확정일시 */
                         </if>
                         <if test='@MybatisUtils@equals(divCd, "01")'> /* 매출 */
                             AND SUBSTR(A.STPL_CNFM_DTM,1,8) BETWEEN #{strtDt} AND #{endDt}  /* 매출 확정일자 */
                         </if>

                         <choose>
                             <when test='@MybatisUtils@isNotEmpty(cancStrtDt) and @MybatisUtils@isNotEmpty(cancEndDt)'>
                                 AND (A.STPL_CAN_DTM BETWEEN #{cancStrtDt} AND #{cancEndDt} OR A.STPL_CAN_DTM BETWEEN #{cancEndDt} AND #{cancStrtDt})
                             </when>
                             <when test='@MybatisUtils@isNotEmpty(cancStrtDt)'>
                                 AND A.STPL_CAN_DTM &gt;= #{cancStrtDt}
                             </when>
                             <when test='@MybatisUtils@isNotEmpty(cancEndDt)'>
                                 AND A.STPL_CAN_DTM &lt;= #{cancEndDt}
                             </when>
                         </choose>
						)RI
                  INNER JOIN TB_SSCT_CNTR_BAS CB
                     ON RI.CNTR_NO = CB.CNTR_NO
                    AND RI.RCP_OG_TP_CD = CB.SELL_OG_TP_CD
                    AND CB.DTA_DL_YN = 'N'
                  INNER JOIN TB_SSCT_CNTR_DTL CD
                     ON RI.CNTR_NO = CD.CNTR_NO
                    AND RI.CNTR_SN = CD.CNTR_SN
                    AND CD.SELL_TP_CD = '2'
                        <if test='@MybatisUtils@equals(divCd, "03")'> /* 예약 */
                    AND CD.BOO_SELL_TP_CD = '2'
                        </if>
                        <if test='@MybatisUtils@equals(divCd, "01")'> /* 매출 */
                    AND NVL(CD.BOO_SELL_TP_CD,0) != '2'
                        </if>

                        <choose>
                            <when test='@MybatisUtils@isNotEmpty(pkgStrtCd) and @MybatisUtils@isNotEmpty(pkgEndCd)'>
                                AND (CD.HGR_PD_CD BETWEEN #{pkgStrtCd} AND #{pkgEndCd} OR CD.HGR_PD_CD BETWEEN #{pkgEndCd} AND #{pkgStrtCd})
                            </when>
                            <when test='@MybatisUtils@isNotEmpty(pkgStrtCd)'>
                                AND CD.HGR_PD_CD &gt;= #{pkgStrtCd}
                            </when>
                            <when test='@MybatisUtils@isNotEmpty(pkgEndCd)'>
                                AND CD.HGR_PD_CD &lt;= #{pkgEndCd}
                            </when>
                        </choose>

                  INNER JOIN TB_OGBS_MM_PRTNR_IZ MP  /* 월파트너 */
                     ON RI.RCP_PRTNR_NO = MP.PRTNR_NO
                    AND RI.RCP_OG_TP_CD = MP.OG_TP_CD
                    AND MP.BASE_YM = SUBSTR(#{strtDt},1,6)
                         <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                    AND MP.PRTNR_NO = #{prtnrNo}
                         </if>
                  INNER JOIN TB_OGBS_MM_OG_IZ MO  /* 월조직 */
                     ON MP.BASE_YM = MO.BASE_YM
                    AND MP.OG_ID = MO.OG_ID
                    AND MP.OG_TP_CD = MO.OG_TP_CD
                         <if test='@MybatisUtils@isNotEmpty(og1LevlId)'>
                    AND MO.DGR1_LEVL_OG_ID = #{og1LevlId}
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(og2LevlId)'>
                    AND MO.DGR2_LEVL_OG_ID = #{og2LevlId}
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(og3LevlId)'>
                    AND MO.DGR3_LEVL_OG_ID = #{og3LevlId}
                         </if>
                  INNER JOIN TB_PDBS_PD_BAS PP
                     ON CD.BASE_PD_CD = PP.PD_CD
                     <choose>
                         <when test='@MybatisUtils@isNotEmpty(pdStrtCd) and @MybatisUtils@isNotEmpty(pdEndCd)'>
                             AND (PP.PD_CD BETWEEN #{pdStrtCd} AND #{pdEndCd} OR PP.PD_CD BETWEEN #{pdEndCd} AND #{pdStrtCd})
                         </when>
                         <when test='@MybatisUtils@isNotEmpty(pdStrtCd)'>
                             AND PP.PD_CD &gt;= #{pdStrtCd}
                         </when>
                         <when test='@MybatisUtils@isNotEmpty(pdEndCd)'>
                             AND PP.PD_CD &lt;=  #{pdEndCd}
                         </when>
                     </choose>
                  INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS PD
                     ON CD.BASE_PD_CD = PD.BASE_PD_CD
                    AND SUBSTR(#{strtDt},1,6) BETWEEN APY_STRT_YM AND APY_END_YM
                  INNER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS PF
                     ON PD.FEE_PDCT_TP_CD2 = PF.FEE_PDCT_TP_CD
                    AND CD.SELL_TP_CD = PF.SELL_TP_CD
                         <if test='@MybatisUtils@isNotEmpty(pdctTpCd)'>
                    AND PF.FEE_PDCT_TP_CD = #{pdctTpCd}
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(feePerfCd)'>
                    AND PF.FEE_PERF_TP_CD = #{feePerfCd}
                         </if>
                   LEFT OUTER JOIN TB_PDBS_SDING_PRC_BAS PSP
                     ON CD.BASE_PD_CD = PSP.PDCT_PD_CD
                    AND RI.STPL_STRTDT BETWEEN PSP.APY_STRTDT AND PSP.APY_ENDDT
                   LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ MC
                     ON RI.CNTR_NO = MC.BASE_CNTR_NO
                    AND RI.CNTR_SN = MC.BASE_CNTR_SN
                   LEFT OUTER JOIN LATERAL ( SELECT A.PMOT_CD
                                                  , A.PMOT_TP_CD
                                                  , RANK() OVER (PARTITION BY (A.DTL_CNTR_NO || A.DTL_CNTR_SN) ORDER BY CNTR_PMOT_ID DESC) AS RK_NUM
                                               FROM TB_SSCT_CNTR_PMOT_IZ A
                                              WHERE A.DTL_CNTR_NO = RI.CNTR_NO
                                                AND A.DTL_CNTR_SN = RI.CNTR_SN
                                           )CP /* T프로모션 계약내역T */
                     ON 1=1
                    AND CP.RK_NUM = 1
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS ROW_SCNT
                                               FROM TB_FEAM_WELS_SV_FEE_BAS A
                                              WHERE A.BASE_PD_CD = CD.BASE_PD_CD
                                                AND A.VST_MCN = 0
                                                AND SUBSTR(RI.STPL_STRTDT,1,6) BETWEEN A.APY_STRT_YM AND A.APY_END_YM
                                           )WS
                     ON 1=1
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS EX_SCNT
                                               FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS A
                                              WHERE A.CNTR_NO = RI.CNTR_NO
                                                AND A.CNTR_SN = RI.CNTR_SN
                                                AND A.FEE_PERF_EXCD_DV_CD = '01'
                                           )EX
                     ON 1=1
                  WHERE RI.RK_NUM = 1
                    </if>
               </if>
               )T
          LEFT OUTER JOIN TB_FEAM_WELS_NRCTR_MM_CL T2
            ON T.BASE_YM = T2.BASE_YM
           AND T.OG_TP_CD = T2.OG_TP_CD
           AND T.PRTNR_NO = T2.PRTNR_NO
           AND T.CNTR_DTL_CD = T2.CNTR_NO||T2.CNTR_SN
           AND T2.FEE_TCNT_DV_CD = '02'
           AND T2.CNTR_PERF_CRT_DV_CD = '01'
           AND NVL(T2.ACC_NINC_YN,'N') = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_ADR_REL CAR /* 계약주소관계 */
            ON CAR.DTL_CNTR_NO = SUBSTR(T.CNTR_DTL_CD,1,12)
           AND CAR.DTL_CNTR_SN = SUBSTR(T.CNTR_DTL_CD,13,1)
           AND CAR.ADRPC_TP_CD = '1' /* 계약 주소 */
           AND T.LCCRTT BETWEEN SUBSTR(CAR.VL_STRT_DTM,1,6) AND SUBSTR(CAR.VL_END_DTM,1,6)
           AND CAR.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS CAB /* 계약주소지기본 */
            ON CAB.CNTR_ADRPC_ID = CAR.CNTR_ADRPC_ID
           AND CAB.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS PB
            ON PB.PRTNR_NO = T.PRTNR_NO
           AND PB.OG_TP_CD = T.OG_TP_CD
           AND PB.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ MP
            ON MP.PRTNR_NO = PB.PRTNR_NO
           AND MP.OG_TP_CD = PB.OG_TP_CD
           AND MP.BASE_YM = T.BASE_YM
          LEFT OUTER JOIN TB_OGBS_MM_OG_IZ MO
            ON MO.BASE_YM = MP.BASE_YM
           AND MO.OG_ID = MP.OG_ID
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS PB_L3
            ON PB_L3.PRTNR_NO = MO.DGR3_LEVL_DG_PRTNR_NO
           AND PB_L3.OG_TP_CD = MO.OG_TP_CD
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ MP_L3
            ON MP_L3.PRTNR_NO = PB_L3.PRTNR_NO
           AND MP_L3.OG_TP_CD = PB_L3.OG_TP_CD
           AND MP_L3.BASE_YM = MO.BASE_YM
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS PB_L2
            ON PB_L2.PRTNR_NO = MO.DGR2_LEVL_DG_PRTNR_NO
           AND PB_L2.OG_TP_CD = MO.OG_TP_CD
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ MP_L2
            ON MP_L2.PRTNR_NO = PB_L2.PRTNR_NO
           AND MP_L2.OG_TP_CD = PB_L2.OG_TP_CD
           AND MP_L2.BASE_YM = MO.BASE_YM
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS PB_L1
            ON PB_L1.PRTNR_NO = MO.DGR1_LEVL_DG_PRTNR_NO
           AND PB_L1.OG_TP_CD = MO.OG_TP_CD
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ MP_L1
            ON MP_L1.PRTNR_NO = PB_L1.PRTNR_NO
           AND MP_L1.OG_TP_CD = PB_L1.OG_TP_CD
           AND MP_L1.BASE_YM = MO.BASE_YM
    </select>

    <select id='selectPlannerFees'
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaOrganizationNetOrderDto$SearchPlarSellFeeRes">
           SELECT T.OG1_LV /* 총괄단 !!!*/
             , T.OG2_LV /* 지역단 !!!*/
             , T.OG3_LV /* 지점 !!!*/
             , T.PRTNR_NO AS SEQUENCE_NUMBER /* 번호 !!!*/
             , T.PRTNR_KNM AS EMPL_NM /* 성명 !!!*/
             , T.SELL_TP_CD AS SEL_TYPE /* 판매유형 !!!*/
             , T.FEE_PERF_TP_CD AS PDCT_TP  /* 제품유형 !!!*/
             , T.MCHN_CH_TP_CD AS CHDVC_TP  /* 기변유형 !!!*/
             , T.FEE_PDCT_TP_CD AS FEE  /* 수수료 실적유형 !!!*/
             , T.CNTR_DTL_CD AS CNTR_DTL_NO   /* 계약상세번호 !!!*/
             , T.LCCGUB AS CST_DV   /* 고객구분 !!!*/
             , T.PD_NM AS PRDT_NM    /* 상품명 !!!*/
             , T.PD_CD AS PRDT_CODE    /* 상품코드 !!!*/
             , T.SV_PD_TP_CD AS USWY            /* 용도!!! */
             , CASE WHEN T.SELL_TP_CD = '1' THEN F_CMZ_CD_NM(#{session.tenantId}, 'SPAY_DSC_DV_CD', T.LCETC3)
                    WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_DSC_DV_CD', T.LCETC3)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'MSH_DSC_DV_CD', T.LCETC3)
                    ELSE T.LCETC3
                END AS PD_DC_CLASS /* 할인구분 !!!*/
             , CASE WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_CRP_DSCR_CD', T.LCETC4)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'PMOT_CD', T.LCETC4)
                    ELSE T.LCETC4
                END AS DISC_CODE /* 할인유형 !!!*/
             , CASE WHEN T.SELL_TP_CD = '2' THEN F_CMZ_CD_NM(#{session.tenantId}, 'RENTAL_DSC_TP_CD', T.SELL_DSC_TP_CD)
                    WHEN T.SELL_TP_CD = '3' THEN F_CMZ_CD_NM(#{session.tenantId}, 'MSH_DSC_TP_CD', T.SELL_DSC_TP_CD)
                    ELSE T.SELL_DSC_TP_CD END AS DSC_SYST /* 할인제도 !!!*/
             , T.LCST04 AS COMBI_DV /* 결합구분 !!!*/
             , T.DP_PERF        /* 입금실적 !!!*/
             , T.LCMONT AS ISTM  /* 할부 !!!*/
             , T.HOMCARE AS HOME_CARE /* 홈케어 !!!*/
             , T.HOMCARE3_YEAR AS HCR_MSH_Y3 /* 홈케어멤버십3년 !!!!*/
             , T.LCST13 AS FXAM_YN /* 정액여부 !!!*/
             , T.LEASE_YN AS FNN_LEASE /* 금융리스  일단임시 */
             , T.RSTL_YN AS RECOMMITMENT           /* 재약정여부 !!!*/
             , T.LCCRTT AS CNTR_DATE /* 계약일자 !!!*/
             , T.LCSLET AS SL_DT /* 매출일자 !!!*/
             , T.LCCANT AS CANC_DT /* 취소일자 !!!*/
             , T.AKDBON AS BRMGR_NO /* 지점장번호 !!!*/
             , T.AKDBNM AS BRMGR_FNM /* 지점장성명 !!!*/
             , T.LCAMT1 AS RTLFE /* 렌탈료 !!!*/
             , T.STPL_PTRM AS STPL_MCNT           /* 약정개월 !!!*/
             , T.LCFLG3 AS MNGT_PRD          /* 관리주기 !!!*/
             , T.LCPAMT AS PD_ACC_RSLT   /* 인정실적 !!!*/
             , T.LCCK02 AS PMOT_NO /* 프로모션번호!!!!! */
             , '0' AS PKG_SN    /* 패키지 일련번호!!!!! */
             , T.LCRCDE AS PKG_NO /*패키지 번호!!!!!*/
             , T2.BASE_YM AS NTOR_MM
             , CASE WHEN NVL(T.INTM_ORDR_PRDT,'0') != '0'
                         THEN SUBSTR(T.INTM_ORDR_PRDT,2,4)||'-'||SUBSTR(T.INTM_ORDR_PRDT,6,8)
               END AS MCHN_PD /* 기기상품코드!!! */
             , NVL(T.EX_YN,'N') AS PERF_EXCD /*실적제외등록여부!!! */
             , SUBSTR(T.CNTR_DT,1,6) AS BIZ_RGST_MM /*업무등록월 !!!*/
             , TRUNC(MONTHS_BETWEEN(TO_DATE(T.LCCRTT,'YYYY-MM-DD'),TO_DATE(T.CNTR_DT,'YYYY-MM-DD'))) AS BIZ_RGST_NM /*업무등록차월 !!!*/
             , CASE WHEN CAB.MEXNO_ENCR = PB.MEXNO_ENCR
                     AND CAB.CRAL_IDV_TNO = PB.CRAL_IDV_TNO
                     AND CAB.RCGVP_KNM = PB.PRTNR_KNM
                    THEN CASE WHEN MP.CLTN_DT IS NULL THEN '내부-재직' ELSE '내부-퇴사' END
                    WHEN CAB.MEXNO_ENCR = PB_L3.MEXNO_ENCR
                     AND CAB.CRAL_IDV_TNO = PB_L3.CRAL_IDV_TNO
                     AND CAB.RCGVP_KNM = PB_L3.PRTNR_KNM
                    THEN CASE WHEN MP_L3.CLTN_DT IS NULL THEN '내부(지점)-재직' ELSE '내부(지점)-퇴사' END
                    WHEN CAB.MEXNO_ENCR = PB_L2.MEXNO_ENCR
                     AND CAB.CRAL_IDV_TNO = PB_L2.CRAL_IDV_TNO
                     AND CAB.RCGVP_KNM = PB_L2.PRTNR_KNM
                    THEN CASE WHEN MP_L2.CLTN_DT IS NULL THEN '내부(지역)-재직' ELSE '내부(지역)-퇴사' END
                    WHEN CAB.MEXNO_ENCR = PB_L1.MEXNO_ENCR
                     AND CAB.CRAL_IDV_TNO = PB_L1.CRAL_IDV_TNO
                     AND CAB.RCGVP_KNM = PB_L1.PRTNR_KNM
                    THEN CASE WHEN MP_L1.CLTN_DT IS NULL THEN '내부(총괄)-재직' ELSE '내부(총괄)-퇴사' END
                END HS_PRCHS /* 본인구매 */
          FROM ( SELECT MO.DGR1_LEVL_OG_NM AS OG1_LV /* 총괄단 !!!*/
                      , MO.DGR2_LEVL_OG_NM AS OG2_LV /* 지역단 !!!*/
                      , MO.DGR3_LEVL_OG_NM AS OG3_LV /* 지점 !!!*/
                      , MP.PRTNR_NO  /* 번호 !!!*/
                      , MP.PRTNR_KNM  /* 성명 !!!*/
                      , CD.SELL_TP_CD /* 판매유형 !!!*/
                      , PF.FEE_PERF_TP_CD  /* 제품유형 !!!*/
                      , MC.MCHN_CH_TP_CD  /* 기변유형 !!!*/
                      , PF.FEE_PDCT_TP_CD
                      , CD.CNTR_NO||CD.CNTR_SN AS CNTR_DTL_CD   /* 계약상세번호 !!!*/
                      , CASE WHEN CB.COPN_DV_CD = '2' THEN  '사업' ELSE '개인' END AS LCCGUB    /* 고객구분 !!!*/
                      , PP.PD_NM     /* 상품명 !!!*/
                      , PP.PD_CD     /* 상품코드 !!!*/
                      , CD.SELL_DSC_DV_CD AS LCETC3  /* 할인구분 !!!*/
                      , CD.SELL_DSCR_CD  AS LCETC4  /* 할인유형 !!!*/
                      , CD.SELL_DSC_TP_CD /* 할인제도 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '2' AND (SELECT 1
                                                             FROM TB_SSCT_CNTR_REL SCR
                                                            INNER JOIN TB_SSCT_CNTR_DTL CD2
                                                               ON CD2.CNTR_NO = SCR.BASE_DTL_CNTR_NO
                                                              AND CD2.CNTR_SN = SCR.BASE_DTL_CNTR_SN
                                                              AND CD2.SELL_TP_CD = '6'                /* 정기배송 */
                                                            WHERE SCR.OJ_DTL_CNTR_NO = CD.CNTR_NO
                                                              AND SCR.OJ_DTL_CNTR_SN = CD.CNTR_SN
                                                              AND SCR.VL_END_DTM = '99991231235959'
                                                              AND SCR.DTA_DL_YN = 'N'
                                                              AND SCR.CNTR_REL_DTL_CD = '216' /* 모종의 경우만 결합 구분 */
                                                              AND ROWNUM = 1) > 0
                             THEN 'Y' END AS LCST04 /* 결합구분 !!!*/
                      , CPC.FNL_VAL AS DP_PERF  /* 입금실적 */
                      , CD.ISTM_MCN AS LCMONT   /* 할부 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '1' THEN 0
                             ELSE CD.STPL_PTRM END AS STPL_PTRM /* 약정개월 !!!*/
                      , T1.BFSVC_PRD_CD AS LCFLG3           /* 관리주기 !!!*/
                      , CD.ACKMT_PERF_AMT AS LCPAMT   /* 인정실적 !!!*/
                      , CASE WHEN PF.FEE_PDCT_TP_CD = 'E' THEN ( CASE WHEN CD.SELL_TP_CD = '6' THEN (CD.SELL_AMT- CD.CNTRAM_DSC_AMT )/ CD.SV_PRD
                                                                      ELSE CD.SELL_AMT
                                                                 END )
                             ELSE 0
                        END AS HOMCARE /* 홈케어 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '3' AND CD.STPL_PTRM = '36' THEN 'Y'
                             ELSE ' '
                        END  AS HOMCARE3_YEAR /* 홈케어멤버십3년 !!!!*/
                      , CD.FEE_FXAM_YN AS LCST13 /* 정액여부 !!!*/
                      , CASE WHEN CD.SELL_TP_DTL_CD IN ('22','24','25') THEN 'Y' ELSE 'N' END AS LEASE_YN  /* 금융리스 !!! */
                      , CD.RSTL_YN            /* 재약정여부 !!!*/
                      , SUBSTR(CB.CNTR_CNFM_DTM,1,8) AS LCCRTT /* 계약일자 !!!*/
                      , SUBSTR(CD.CNTR_PD_STRTDT,1,8) AS LCSLET /* 매출일자 !!!*/
                      , CASE WHEN CD.CNTR_DTL_STAT_CD IN ('301','303') THEN CNTR_PD_ENDDT END AS LCCANT  /* 취소일자 !!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NO AS AKDBON /* 지점장번호 !!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NM AS AKDBNM /* 지점장성명 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '6' THEN CD.FNL_AMT / CD.SV_PRD
                             ELSE CD.FNL_AMT END AS LCAMT1 /* 렌탈료 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN CP.PMOT_CD
                             ELSE '0'
                        END AS LCCK02 /* 프로모션번호!!!!! */
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN CD.HGR_PD_CD
                             ELSE '0'
                        END AS LCRCDE /*패키지 상품번호!!!!!*/
                      , CASE WHEN CD.SELL_TP_CD = '2' THEN (SELECT CR.BASE_DTL_CNTR_NO /* 렌탈의 경우 정기배송 모종 계약 찾기 */
                                                              FROM TB_SSCT_CNTR_REL CR
                                                             WHERE CR.OJ_DTL_CNTR_NO = CD.CNTR_NO
                                                               AND CR.OJ_DTL_CNTR_SN = CD.CNTR_SN
                                                               AND CR.CNTR_REL_DTL_CD IN ('214','216') /* 정기배송, 모종의 경우만 기기코드 표기*/
                                                               AND ROWNUM = 1)
                             WHEN CD.SElL_TP_CD = '6' THEN (SELECT CR.OJ_DTL_CNTR_NO /* 모종 정기배송의 경우 렌탈 계약 찾기 */
                                                              FROM TB_SSCT_CNTR_REL CR
                                                             WHERE CR.BASE_DTL_CNTR_NO = CD.CNTR_NO
                                                               AND CR.BASE_DTL_CNTR_SN = CD.CNTR_SN
                                                               AND CR.CNTR_REL_DTL_CD IN ('214','216') /* 정기배송, 모종의 경우만 기기코드 표기*/
                                                               AND ROWNUM = 1)
                        END AS INTM_ORDR_PRDT/* 기기코드!!! */
                      , CASE WHEN EX.EX_SCNT = 1 THEN 'Y'
                        END AS EX_YN  /*실적제외등록여부!!! */
                      , MP.BASE_YM
                      , MP.OG_TP_CD
                      , MP.CNTR_DT
                      , PP.SV_PD_TP_CD
                   FROM TB_FEAM_WELS_NRCTR_MM_CL T1
                  INNER JOIN TB_SSCT_CNTR_BAS CB
	                 ON T1.CNTR_NO = CB.CNTR_NO
                    AND CB.DTA_DL_YN = 'N'
                  INNER JOIN TB_SSCT_CNTR_DTL CD
                     ON T1.CNTR_NO = CD.CNTR_NO
                    AND T1.CNTR_SN = CD.CNTR_SN
                  INNER JOIN TB_OGBS_MM_PRTNR_IZ MP  /* 월파트너 */
                     ON CB.SELL_PRTNR_NO = MP.PRTNR_NO
                    AND CB.SELL_OG_TP_CD = MP.OG_TP_CD
                    AND MP.BASE_YM = T1.BASE_YM
               <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                    AND MP.PRTNR_NO = #{prtnrNo}
               </if>
                  INNER JOIN TB_OGBS_MM_OG_IZ MO  /* 월조직 */
                     ON MP.BASE_YM = MO.BASE_YM
                    AND MP.OG_ID = MO.OG_ID
                    AND MP.OG_TP_CD = MO.OG_TP_CD
               <if test='@MybatisUtils@isNotEmpty(og1LevlId)'>
                    AND MO.DGR1_LEVL_OG_ID = #{og1LevlId}
               </if>
               <if test='@MybatisUtils@isNotEmpty(og2LevlId)'>
                    AND MO.DGR2_LEVL_OG_ID = #{og2LevlId}
               </if>
               <if test='@MybatisUtils@isNotEmpty(og3LevlId)'>
                    AND MO.DGR3_LEVL_OG_ID = #{og3LevlId}
               </if>
                  INNER JOIN TB_PDBS_PD_BAS PP
                     ON CD.BASE_PD_CD = PP.PD_CD
                  INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS PD
                     ON CD.BASE_PD_CD = PD.BASE_PD_CD
                    AND T1.BASE_YM BETWEEN APY_STRT_YM AND APY_END_YM
                  INNER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS PF
                     ON PD.FEE_PDCT_TP_CD2 = PF.FEE_PDCT_TP_CD
                    AND CD.SELL_TP_CD = PF.SELL_TP_CD
                   LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ MC
                     ON CD.CNTR_NO = MC.BASE_CNTR_NO
                    AND CD.CNTR_SN = MC.BASE_CNTR_SN
                   LEFT OUTER JOIN LATERAL ( SELECT A.PMOT_CD
                                                  , A.PMOT_TP_CD
                                                  , RANK() OVER (PARTITION BY (A.DTL_CNTR_NO || A.DTL_CNTR_SN) ORDER BY CNTR_PMOT_ID DESC) AS RK_NUM
                                               FROM TB_SSCT_CNTR_PMOT_IZ A
                                              WHERE A.DTL_CNTR_NO = CD.CNTR_NO
                                                AND A.DTL_CNTR_SN = CD.CNTR_SN
                                           )CP /* T프로모션 계약내역T */
                     ON 1=1
                    AND CP.RK_NUM = 1
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS ROW_SCNT
                                               FROM TB_FEAM_WELS_SV_FEE_BAS A
                                              WHERE A.BASE_PD_CD = CD.BASE_PD_CD
                                                AND A.VST_MCN = 0
                                                AND SUBSTR(CB.CNTR_CNFM_DTM,1,6) BETWEEN A.APY_STRT_YM AND A.APY_END_YM
                                           )WS
                     ON 1=1
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS EX_SCNT
                                               FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS A
                                              WHERE A.CNTR_NO = CD.CNTR_NO
                                                AND A.CNTR_SN = CD.CNTR_SN
                                                AND A.FEE_PERF_EXCD_DV_CD = '01'
                                           )EX
                     ON 1=1
                   LEFT OUTER JOIN TB_SSCT_CNTR_PRC_CMPT_IZ CPC
                     ON CD.CNTR_NO = CPC.CNTR_NO
                    AND CD.CNTR_SN = CPC.CNTR_SN
                  WHERE T1.BASE_YM = #{perfYm}
                    AND T1.FEE_TCNT_DV_CD = #{feeTcntDvCd}
                    AND T1.OG_TP_CD = 'W01'
                    AND T1.CNTR_PERF_CRT_DV_CD = '01'
                    AND NVL(T1.ACC_NINC_YN,'N') = 'N'
	 			    AND T1.RSTL_YN = 'N'
	 			    AND T1.DTA_DL_YN = 'N'
                  UNION ALL
                 SELECT MO.DGR1_LEVL_OG_NM AS OG1_LV /* 총괄단 !!!*/
                      , MO.DGR2_LEVL_OG_NM AS OG2_LV /* 지역단 !!!*/
                      , MO.DGR3_LEVL_OG_NM AS OG3_LV /* 지점 !!!*/
                      , MP.PRTNR_NO  /* 번호 !!!*/
                      , MP.PRTNR_KNM  /* 성명 !!!*/
                      , CD.SELL_TP_CD /* 판매유형 !!!*/
                      , PF.FEE_PERF_TP_CD  /* 제품유형 !!!*/
                      , MC.MCHN_CH_TP_CD  /* 기변유형 !!!*/
                      , PF.FEE_PDCT_TP_CD
                      , CD.CNTR_NO||CD.CNTR_SN AS CNTR_DTL_CD    /* 계약상세번호 !!!*/
                      , CASE WHEN CB.COPN_DV_CD = '2' THEN  '사업' ELSE '개인' END AS LCCGUB    /* 고객구분 !!!*/
                      , PP.PD_NM     /* 상품명 !!!*/
                      , PP.PD_CD     /* 상품코드 !!!*/
                      , CD.SELL_DSC_DV_CD AS LCETC3  /* 할인구분 !!!*/
                      , CD.SELL_DSCR_CD  AS LCETC4  /* 할인유형 !!!*/
                      , CD.SELL_DSC_TP_CD /* 할인제도 !!!*/
                      , '' AS LCST04 /* 결합구분 !!!*/
                      , CPC.FNL_VAL AS DP_PERF  /* 입금실적 */
                      , CD.ISTM_MCN AS LCMONT   /* 할부 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '1' THEN 0
                             ELSE CD.STPL_PTRM END AS STPL_PTRM /* 약정개월 !!!*/
                      , T1.BFSVC_PRD_CD AS LCFLG3           /* 관리주기 !!!*/
                      , CD.ACKMT_PERF_AMT AS LCPAMT   /* 인정실적 !!!*/
                      , 0 AS HOMCARE /* 홈케어 !!!*/
                      , '' AS HOMCARE3_YEAR /* 홈케어멤버십3년 !!!!*/
                      , CD.FEE_FXAM_YN AS LCST13 /* 정액여부 !!!*/
                      , CASE WHEN CD.SELL_TP_DTL_CD IN ('22','24','25') THEN 'Y' ELSE 'N' END AS LEASE_YN  /* 금융리스 !!! */
                      , CD.RSTL_YN            /* 재약정여부 !!!*/
                      , SUBSTR(RI.STPL_STRTDT,1,8) AS LCCRTT /* 계약일자 !!!*/
                      , SUBSTR(RI.STPL_CNFM_DTM,1,8) AS LCSLET /* 매출일자 !!!*/
                      , CASE WHEN CD.CNTR_DTL_STAT_CD IN ('301','303') THEN CNTR_PD_ENDDT END AS LCCANT  /* 취소일자 !!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NO AS AKDBON /* 지점장번호 !!!*/
                      , MO.DGR3_LEVL_DG_PRTNR_NM AS AKDBNM /* 지점장성명 !!!*/
                      , CASE WHEN CD.SELL_TP_CD = '6' THEN CD.FNL_AMT / CD.SV_PRD
                             ELSE CD.FNL_AMT END AS LCAMT1 /* 렌탈료 !!!*/
                      , '0' AS LCCK02 /* 프로모션번호!!!!! */
                      , '' AS LCRCDE /*패키지 상품번호!!!!!*/
                      , '' AS INTM_ORDR_PRDT/* 기기코드!!! */
                      , CASE WHEN EX.EX_SCNT = 1 THEN 'Y' END AS EX_YN  /*실적제외등록여부!!! */
                      , MP.BASE_YM
                      , MP.OG_TP_CD
                      , MP.CNTR_DT
                      , PP.SV_PD_TP_CD
                   FROM TB_FEAM_WELS_NRCTR_MM_CL T1
  				   LEFT OUTER JOIN LATERAL ( SELECT A.CNTR_NO
                                                  , A.CNTR_SN
                                                  , A.STPL_STRTDT
                                                  , A.STPL_CNFM_DTM
                                                  , A.RCP_PRTNR_NO
                                                  , A.RCP_OG_TP_CD
                                                  , RANK() OVER (PARTITION BY (A.CNTR_NO) ORDER BY A.STPL_TN DESC) AS RK_NUM
					 						   FROM TB_SSCT_RENTAL_RSTL_IZ A
					 					      WHERE A.CNTR_NO = T1.CNTR_NO
											    AND A.CNTR_SN = T1.CNTR_SN
										   )RI
				     ON 1=1
				    AND RI.RK_NUM = 1
                  INNER JOIN TB_SSCT_CNTR_BAS CB
                     ON RI.CNTR_NO = CB.CNTR_NO
                    AND CB.DTA_DL_YN = 'N'
                  INNER JOIN TB_SSCT_CNTR_DTL CD
                     ON RI.CNTR_NO = CD.CNTR_NO
                    AND RI.CNTR_SN = CD.CNTR_SN
                    AND CD.SELL_TP_CD = '2'
                  INNER JOIN TB_OGBS_MM_PRTNR_IZ MP  /* 월파트너 */
                     ON RI.RCP_PRTNR_NO = MP.PRTNR_NO
                    AND RI.RCP_OG_TP_CD = MP.OG_TP_CD
                    AND MP.BASE_YM = T1.BASE_YM
                         <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                    AND MP.PRTNR_NO = #{prtnrNo}
                         </if>
                  INNER JOIN TB_OGBS_MM_OG_IZ MO  /* 월조직 */
                     ON MP.BASE_YM = MO.BASE_YM
                    AND MP.OG_ID = MO.OG_ID
                    AND MP.OG_TP_CD = MO.OG_TP_CD
                         <if test='@MybatisUtils@isNotEmpty(og1LevlId)'>
                    AND MO.DGR1_LEVL_OG_ID = #{og1LevlId}
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(og2LevlId)'>
                    AND MO.DGR2_LEVL_OG_ID = #{og2LevlId}
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(og3LevlId)'>
                    AND MO.DGR3_LEVL_OG_ID = #{og3LevlId}
                         </if>
                  INNER JOIN TB_PDBS_PD_BAS PP
                     ON CD.BASE_PD_CD = PP.PD_CD
                  INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS PD
                     ON CD.BASE_PD_CD = PD.BASE_PD_CD
                    AND T1.BASE_YM BETWEEN APY_STRT_YM AND APY_END_YM
                  INNER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS PF
                     ON PD.FEE_PDCT_TP_CD2 = PF.FEE_PDCT_TP_CD
                    AND CD.SELL_TP_CD = PF.SELL_TP_CD
                   LEFT OUTER JOIN TB_PDBS_SDING_PRC_BAS PSP
                     ON CD.BASE_PD_CD = PSP.PDCT_PD_CD
                    AND RI.STPL_STRTDT BETWEEN PSP.APY_STRTDT AND PSP.APY_ENDDT
                   LEFT OUTER JOIN TB_SSCT_MCHN_CH_IZ MC
                     ON RI.CNTR_NO = MC.BASE_CNTR_NO
                    AND RI.CNTR_SN = MC.BASE_CNTR_SN
                   LEFT OUTER JOIN LATERAL ( SELECT A.PMOT_CD
                                                  , A.PMOT_TP_CD
                                                  , RANK() OVER (PARTITION BY (A.DTL_CNTR_NO || A.DTL_CNTR_SN) ORDER BY CNTR_PMOT_ID DESC) AS RK_NUM
                                               FROM TB_SSCT_CNTR_PMOT_IZ A
                                              WHERE A.DTL_CNTR_NO = RI.CNTR_NO
                                                AND A.DTL_CNTR_SN = RI.CNTR_SN
                                           )CP /* T프로모션 계약내역T */
                     ON 1=1
                    AND CP.RK_NUM = 1
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS ROW_SCNT
                                               FROM TB_FEAM_WELS_SV_FEE_BAS A
                                              WHERE A.BASE_PD_CD = CD.BASE_PD_CD
                                                AND A.VST_MCN = 0
                                                AND SUBSTR(RI.STPL_STRTDT,1,6) BETWEEN A.APY_STRT_YM AND A.APY_END_YM
                                           )WS
                     ON 1=1
                   LEFT OUTER JOIN LATERAL ( SELECT COUNT(1) AS EX_SCNT
                                               FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS A
                                              WHERE A.CNTR_NO = RI.CNTR_NO
                                                AND A.CNTR_SN = RI.CNTR_SN
                                                AND A.FEE_PERF_EXCD_DV_CD = '01'
                                           )EX
                     ON 1=1
                   LEFT OUTER JOIN TB_SSCT_CNTR_PRC_CMPT_IZ CPC
                     ON CD.CNTR_NO = CPC.CNTR_NO
                    AND CD.CNTR_SN = CPC.CNTR_SN
                 WHERE T1.BASE_YM = #{perfYm}
                   AND T1.FEE_TCNT_DV_CD = #{feeTcntDvCd}
                   AND T1.OG_TP_CD = 'W01'
                   AND T1.CNTR_PERF_CRT_DV_CD = '01'
                   AND NVL(T1.ACC_NINC_YN,'N') = 'N'
				   AND T1.RSTL_YN = 'Y'
				   AND T1.DTA_DL_YN = 'N'
               )T
          LEFT OUTER JOIN TB_FEAM_WELS_NRCTR_MM_CL T2
            ON T.BASE_YM = T2.BASE_YM
           AND T.OG_TP_CD = T2.OG_TP_CD
           AND T.PRTNR_NO = T2.PRTNR_NO
           AND T.CNTR_DTL_CD = T2.CNTR_NO||T2.CNTR_SN
           AND T2.FEE_TCNT_DV_CD = #{feeTcntDvCd}
           AND T2.CNTR_PERF_CRT_DV_CD = '01'
           AND NVL(T2.ACC_NINC_YN,'N') = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_ADR_REL CAR /* 계약주소관계 */
            ON CAR.DTL_CNTR_NO = SUBSTR(T.CNTR_DTL_CD,1,12)
           AND CAR.DTL_CNTR_SN = SUBSTR(T.CNTR_DTL_CD,13,1)
           AND CAR.ADRPC_TP_CD = '1' /* 계약 주소 */
           AND T.LCCRTT BETWEEN SUBSTR(CAR.VL_STRT_DTM,1,6) AND SUBSTR(CAR.VL_END_DTM,1,6)
           AND CAR.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS CAB /* 계약주소지기본 */
            ON CAB.CNTR_ADRPC_ID = CAR.CNTR_ADRPC_ID
           AND CAB.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS PB
            ON PB.PRTNR_NO = T.PRTNR_NO
           AND PB.OG_TP_CD = T.OG_TP_CD
           AND PB.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ MP
            ON MP.PRTNR_NO = PB.PRTNR_NO
           AND MP.OG_TP_CD = PB.OG_TP_CD
           AND MP.BASE_YM = T.BASE_YM
          LEFT OUTER JOIN TB_OGBS_MM_OG_IZ MO
            ON MO.BASE_YM = MP.BASE_YM
           AND MO.OG_ID = MP.OG_ID
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS PB_L3
            ON PB_L3.PRTNR_NO = MO.DGR3_LEVL_DG_PRTNR_NO
           AND PB_L3.OG_TP_CD = MO.OG_TP_CD
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ MP_L3
            ON MP_L3.PRTNR_NO = PB_L3.PRTNR_NO
           AND MP_L3.OG_TP_CD = PB_L3.OG_TP_CD
           AND MP_L3.BASE_YM = MO.BASE_YM
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS PB_L2
            ON PB_L2.PRTNR_NO = MO.DGR2_LEVL_DG_PRTNR_NO
           AND PB_L2.OG_TP_CD = MO.OG_TP_CD
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ MP_L2
            ON MP_L2.PRTNR_NO = PB_L2.PRTNR_NO
           AND MP_L2.OG_TP_CD = PB_L2.OG_TP_CD
           AND MP_L2.BASE_YM = MO.BASE_YM
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS PB_L1
            ON PB_L1.PRTNR_NO = MO.DGR1_LEVL_DG_PRTNR_NO
           AND PB_L1.OG_TP_CD = MO.OG_TP_CD
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ MP_L1
            ON MP_L1.PRTNR_NO = PB_L1.PRTNR_NO
           AND MP_L1.OG_TP_CD = PB_L1.OG_TP_CD
           AND MP_L1.BASE_YM = MO.BASE_YM
    </select>



    <select id='selectPlannerAggregation'
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaOrganizationNetOrderDto$SearchPlarAgrgRes">
        SELECT T2.OG_CD AS OG_ID
             , M.PRTNR_NO
             , T2.PRTNR_KNM
             , T2.PSTN_DV_CD
             , MAX(M.EH_CNT) AS EH_CNT
             , MAX(M.EX_CNT) AS EX_CNT
             , MAX(M.ET_CNT) AS ET_CNT
             , MAX(M.UP_CNT) AS UP_CNT
             , MAX(M.EH_CNT)+ MAX(M.EX_CNT)+ MAX(M.ET_CNT)+ MAX(M.UP_CNT) AS TOT_CNT
             , MAX(M.EH_AMT) AS EH_AMT
             , MAX(M.EX_AMT) AS EX_AMT
             , MAX(M.ET_AMT) AS ET_AMT
             , MAX(M.UP_AMT) AS UP_AMT
             , MAX(M.EH_AMT)+ MAX(M.EX_AMT)+ MAX(M.ET_AMT)+ MAX(M.UP_AMT) AS TOT_AMT
          FROM ( SELECT T.PRTNR_NO
                      , NVL(SUM(EH_CNT),0) AS EH_CNT
                      , NVL(SUM(EX_CNT),0) AS EX_CNT
                      , NVL(SUM(ET_CNT),0) AS ET_CNT
                      , NVL(SUM(UP_CNT),0) AS UP_CNT
                      , 0 AS EH_AMT
                      , 0 AS EX_AMT
                      , 0 AS ET_AMT
                      , 0 AS UP_AMT
                   FROM ( SELECT T1.PRTNR_NO
                               , CASE WHEN T3.FEE_PERF_TP_CD = 'EH' THEN T2.FEE_ACKMT_CT END AS EH_CNT
                               , CASE WHEN T3.FEE_PERF_TP_CD = 'EX' THEN T2.FEE_ACKMT_CT END AS EX_CNT
                               , CASE WHEN T3.FEE_PERF_TP_CD = 'ET' THEN T2.FEE_ACKMT_CT END AS ET_CNT
                               , CASE WHEN T3.FEE_PERF_TP_CD = 'UP' THEN T2.FEE_ACKMT_CT END AS UP_CNT
                            FROM TB_FEAM_WELS_NRCTR_MM_CL T1
                           INNER JOIN TB_SSCT_CNTR_DTL T2 ON T2.CNTR_NO = T1.CNTR_NO AND T2.CNTR_SN = T1.CNTR_SN
                           INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T2
                              ON T1.PD_CD = T2.BASE_PD_CD
                             AND #{perfYm} BETWEEN APY_STRT_YM AND APY_END_YM
                           INNER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS T3
                              ON T2.FEE_PDCT_TP_CD2 = T3.FEE_PDCT_TP_CD
                             AND T1.SELL_TP_CD = T3.SELL_TP_CD
                           WHERE T1.BASE_YM = #{perfYm}
                             AND T1.OG_TP_CD = 'W01'
                             AND T1.FEE_TCNT_DV_CD = #{feeTcntDvCd}
                             AND T1.CNTR_PERF_CRT_DV_CD = '01'
                             AND T2.FEE_ACKMT_CT > 0
                             AND NVL(T1.ACC_NINC_YN,'N') = 'N'
                        )T
                  GROUP BY T.PRTNR_NO
                  UNION ALL
                 SELECT T.PRTNR_NO
                      , 0 AS EH_CNT
                      , 0 AS EX_CNT
                      , 0 AS ET_CNT
                      , 0 AS UP_CNT
                      , NVL(SUM(EH_AMT),0) AS EH_AMT
                      , NVL(SUM(EX_AMT),0) AS EX_AMT
                      , NVL(SUM(ET_AMT),0) AS ET_AMT
                      , NVL(SUM(UP_AMT),0) AS UP_AMT
                   FROM ( SELECT T1.PRTNR_NO
                               , CASE WHEN T3.FEE_PERF_TP_CD = 'EH' THEN T1.ACKMT_PERF_AMT END AS EH_AMT
                               , CASE WHEN T3.FEE_PERF_TP_CD = 'EX' THEN T1.ACKMT_PERF_AMT END AS EX_AMT
                               , CASE WHEN T3.FEE_PERF_TP_CD = 'ET' THEN T1.ACKMT_PERF_AMT END AS ET_AMT
                               , CASE WHEN T3.FEE_PERF_TP_CD = 'UP' THEN T1.ACKMT_PERF_AMT END AS UP_AMT
                            FROM TB_FEAM_WELS_NRCTR_MM_CL T1
                           INNER JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS T2
                              ON T1.PD_CD = T2.BASE_PD_CD
                             AND #{perfYm} BETWEEN APY_STRT_YM AND APY_END_YM
                           INNER JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS T3
                              ON T2.FEE_PDCT_TP_CD2 = T3.FEE_PDCT_TP_CD
                             AND T1.SELL_TP_CD = T3.SELL_TP_CD
                           WHERE T1.BASE_YM = #{perfYm}
                             AND T1.OG_TP_CD = 'W01'
                             AND T1.FEE_TCNT_DV_CD = #{feeTcntDvCd}
                             AND T1.CNTR_PERF_CRT_DV_CD = '01'
                             AND T1.ACKMT_PERF_AMT > 0
                             AND NVL(T1.ACC_NINC_YN,'N') = 'N'
                        )T
                  GROUP BY T.PRTNR_NO
               )M
         INNER JOIN TB_OGBS_MM_PRTNR_IZ T2  /* 월파트너 */
            ON M.PRTNR_NO = T2.PRTNR_NO
           AND T2.OG_TP_CD = 'W01'
           AND T2.BASE_YM = #{perfYm}
      <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
           AND T2.PRTNR_NO = #{prtnrNo}
      </if>
      <if test='@MybatisUtils@equals(rsbDvCd, "00")'>
           AND T2.PSTN_DV_CD IN ('7','15')
      </if>
      <if test='!@MybatisUtils@equals(rsbDvCd, "00")'>
           AND T2.PSTN_DV_CD = #{rsbDvCd}
      </if>
         INNER JOIN TB_OGBS_MM_OG_IZ T3  /* 월조직 */
            ON T2.BASE_YM = T3.BASE_YM
           AND T2.OG_ID = T3.OG_ID
           AND T2.OG_TP_CD = T3.OG_TP_CD
      <if test='@MybatisUtils@isNotEmpty(og1LevlId)'>
           AND T3.DGR1_LEVL_OG_ID = #{og1LevlId}
      </if>
      <if test='@MybatisUtils@isNotEmpty(og2LevlId)'>
           AND T3.DGR2_LEVL_OG_ID = #{og2LevlId}
      </if>
      <if test='@MybatisUtils@isNotEmpty(og3LevlId)'>
           AND T3.DGR3_LEVL_OG_ID = #{og3LevlId}
      </if>
         GROUP BY T2.OG_CD, M.PRTNR_NO, T2.PRTNR_KNM, T2.PSTN_DV_CD
    </select>

    <update id="updateNtorMmClConfirm">
        UPDATE TB_FEAM_NTOR_MM_CL
           SET NTOR_CNFM_STAT_CD = '02' /*순주문확정상태코드 01-임시저장, 02-확정*/
           <include refid="COMMON.updateSystemField"/>
         WHERE BASE_YM = #{perfYm}
           AND FEE_TCNT_DV_CD = #{feeTcntDvCd}
           AND PERF_AGRG_CRT_DV_CD = #{perfAgrgCrtDvCd}
    </update>

    <update id="updateNtorMmClCancel">
        UPDATE TB_FEAM_NTOR_MM_CL
           SET NTOR_CNFM_STAT_CD = '01' /*순주문확정상태코드 01-임시저장, 02-확정*/
           <include refid="COMMON.updateSystemField"/>
         WHERE BASE_YM = #{perfYm}
           AND FEE_TCNT_DV_CD = #{feeTcntDvCd}
           AND PERF_AGRG_CRT_DV_CD = #{perfAgrgCrtDvCd}
    </update>

    <select id="selectFeeNetOrderPdCnt" resultType="int">
        SELECT COUNT(T1.PD_CD) AS P_CNT
          FROM TB_FEAM_WELS_NRCTR_MM_CL T1
         WHERE T1.BASE_YM = #{perfYm}
           AND T1.FEE_TCNT_DV_CD = #{feeTcntDvCd}
           AND T1.OG_TP_CD = #{ogTpCd}
           AND T1.CNTR_PERF_CRT_DV_CD = '01' /* 순주문 */
           AND NVL(T1.ACC_NINC_YN,'N') = 'N'
           AND NOT EXISTS ( SELECT 1 FROM TB_FEAM_WELS_FEE_PDCT_TP_BAS X
                             WHERE T1.PD_CD = X.BASE_PD_CD
                               AND #{perfYm} BETWEEN X.APY_STRT_YM AND X.APY_END_YM
                          )
    </select>

    <select id="selectHomeMasterFees2"
            resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaOrganizationNetOrderDto$SearchHmstFeeRes2">
        SELECT PR.OG_NM
             , PR.PRTNR_NO
             , PR.PRTNR_KNM
             , WN.CNTR_NO
             , WN.RCPDT
             , WN.SL_DT
             , WN.CAN_DT
             , PT.FEE_PERF_TP_CD
             , WN.PD_CD
             , PD.PD_NM
             , WN.ACKMT_PERF_AMT
             , WN.ACKMT_PERF_CT
             , CASE WHEN WN.MCHN_CH_TP_CD = '0' THEN '' ELSE WN.MCHN_CH_TP_CD END AS MCHN_CH_TP_CD
          FROM TB_FEAM_WELS_NRCTR_MM_CL WN /* 웰스순주문계약월마감 */
          JOIN TB_OGBS_MM_PRTNR_IZ PR /* 월파트너내역 */
            ON PR.BASE_YM = WN.BASE_YM
           AND PR.OG_TP_CD = WN.OG_TP_CD
           AND PR.PRTNR_NO = WN.PRTNR_NO
          JOIN TB_OGBS_MM_OG_IZ OG /* 월조직내역 */
            ON OG.BASE_YM = PR.BASE_YM
           AND OG.OG_ID = PR.OG_ID
          JOIN TB_FEAM_WELS_FEE_PDCT_TP_BAS PB /* 웰스수수료제품유형기본 */
            ON PB.BASE_PD_CD = WN.PD_CD
           AND WN.BASE_YM BETWEEN PB.APY_STRT_YM AND PB.APY_END_YM
          JOIN TB_FEAM_WELS_FEE_PERF_TP_BAS PT /* 웰스수수료실적유형기본 */
            ON PB.FEE_PDCT_TP_CD1 = PT.FEE_PDCT_TP_CD
           AND WN.SELL_TP_CD = PT.SELL_TP_CD
          JOIN TB_PDBS_PD_BAS PD /* 상품기본 */
            ON PD.PD_CD = WN.PD_CD
         WHERE WN.BASE_YM = #{perfYm}
           AND WN.OG_TP_CD = 'W03'
           AND WN.FEE_TCNT_DV_CD = #{feeTcntDvCd}
           AND WN.CO_CD = '2000'
           AND WN.DTA_DL_YN = 'N'
        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
           AND WN.PRTNR_NO = #{prtnrNo}
        </if>
        <if test="@MybatisUtils@isNotEmpty(og1LevlId)">
           AND OG.DGR1_LEVL_OG_ID = #{og1LevlId}
        </if>
        <if test="@MybatisUtils@isNotEmpty(og2LevlId)">
           AND OG.DGR2_LEVL_OG_ID = #{og2LevlId}
        </if>
        <if test="@MybatisUtils@isNotEmpty(og3LevlId)">
           AND OG.DGR3_LEVL_OG_ID = #{og3LevlId}
        </if>
    </select>

</mapper>
