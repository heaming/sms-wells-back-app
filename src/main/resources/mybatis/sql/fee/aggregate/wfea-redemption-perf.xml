<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.aggregate.mapper.WfeaRedemptionPerfMapper">
    <select id="selectRedemptionConfirmStatus" resultType="java.lang.Integer">
        SELECT COUNT(1)
          FROM TB_FEAM_NTOR_MM_CL
         WHERE BASE_YM = #{baseYm}
           AND PERF_AGRG_CRT_DV_CD = #{perfAgrgCrtDvCd} -- EDU영업부 103, EDU 신채널 203
           AND NTOR_CNFM_STAT_CD = '02' -- 확정
    </select>

    <update id="insertRedemptionStatus">
        MERGE INTO TB_FEAM_NTOR_MM_CL T01
        USING (SELECT #{baseYm} AS BASE_YM
                    , '02'      AS FEE_TCNT_DV_CD      -- 확정으로 고정
                    , #{perfAgrgCrtDvCd}     AS PERF_AGRG_CRT_DV_CD
                 FROM DUAL) T02
        ON (T01.BASE_YM = T02.BASE_YM AND T01.FEE_TCNT_DV_CD = T02.FEE_TCNT_DV_CD AND
            T01.PERF_AGRG_CRT_DV_CD = T02.PERF_AGRG_CRT_DV_CD)
        WHEN NOT MATCHED THEN
            INSERT (
                     BASE_YM
                   , FEE_TCNT_DV_CD
                   , PERF_AGRG_CRT_DV_CD
                   , NTOR_CNFM_STAT_CD
                   <include refid="COMMON.insertSystemField" />
            ) VALUES (
                 T02.BASE_YM
               , T02.FEE_TCNT_DV_CD
               , T02.PERF_AGRG_CRT_DV_CD
               , '01'
                <include refid="COMMON.insertSystemFieldValue" />  )
    </update>

    <delete id="deleteCommonRedempPerfData">
        DELETE ${tableName}
        WHERE BASE_YM = #{baseYm}
          AND PERF_AGRG_CRT_DV_CD = #{perfAgrgCrtDvCd}
          AND OG_TP_CD = #{ogTpCd}
    </delete>

    <insert id="insertContractDataFromNtorp">
        INSERT INTO TB_FEAM_NTORP_CNTR_MM_CL(
                                              BASE_YM
                                            , PERF_YM
                                            , FEE_TCNT_DV_CD
                                            , PERF_AGRG_CRT_DV_CD
                                            , PERF_ATC_CD
                                            , CO_CD
                                            , OG_TP_CD
                                            , PRTNR_NO
                                            , PERF_DV_CD
                                            , CNTR_NO
                                            , CNTR_SN
                                            , CNTR_PERF_CRT_DV_CD
                                            , PERF_VAL
                                            <include refid="COMMON.insertSystemField" />
        )
        SELECT #{baseYm}                                       AS BASE_YM
             , T1.PERF_YM
             , T1.FEE_TCNT_DV_CD
             , #{perfAgrgCrtDvCd} AS PERF_AGRG_CRT_DV_CD
             , T2.PERF_ATC_CD
             , T2.CO_CD
             , T1.OG_TP_CD
             , T1.PRTNR_NO
             , '0'                                             AS PERF_DV_CD
             , T1.CNTR_NO
             , T1.CNTR_SN
             , T1.CNTR_PERF_CRT_DV_CD
             , T2.PERF_VAL - T1.REDF_ADSB_OJ_AMT               AS PERF_VAL
            <include refid="COMMON.insertSystemFieldValue" />
          FROM (SELECT PERF_YM
                     , FEE_TCNT_DV_CD
                     , CNTR_NO
                     , CNTR_SN
                     , OG_TP_CD
                     , PRTNR_NO
                     , CNTR_PERF_CRT_DV_CD
                     , REDF_ADSB_OJ_AMT
                  FROM TB_FEAM_EDU_NRCTR_MM_CL
                 WHERE BASE_YM = #{baseYm}
                   AND CNTR_PERF_CRT_DV_CD = #{cntrPerfCrtDvCd}     -- 되물림
                   AND PERF_TP_CD NOT IN ('10', '11') -- 연체, 장기보류는 별도 처리
                   AND OG_TP_CD = #{ogTpCd}) T1
               INNER JOIN TB_FEAM_NTORP_CNTR_MM_CL T2
                          ON (T1.PERF_YM = T2.PERF_YM AND T1.PERF_YM = T2.BASE_YM AND
                              T1.FEE_TCNT_DV_CD = T2.FEE_TCNT_DV_CD AND
                              T1.CNTR_NO = T2.CNTR_NO AND T1.CNTR_SN = T2.CNTR_SN AND
                              T1.OG_TP_CD = T2.OG_TP_CD AND
                              T1.PRTNR_NO = T2.PRTNR_NO)
         WHERE T2.PERF_AGRG_CRT_DV_CD = #{perfAgrgCrtDvCd} -- 순주문
           AND T2.PERF_VAL > 0
           AND T2.PERF_ATC_CD IN
            <foreach item="perfAtcCd" collection="perfAtcCds" open="(" separator="," close=")">
                    #{perfAtcCd}
            </foreach>
    </insert>

    <insert id="insertIndivContractDataFromLife">
        INSERT INTO TB_FEAM_NTORP_CNTR_MM_CL(
                                              BASE_YM
                                            , PERF_YM
                                            , FEE_TCNT_DV_CD
                                            , PERF_AGRG_CRT_DV_CD
                                            , PERF_ATC_CD
                                            , CO_CD
                                            , OG_TP_CD
                                            , PRTNR_NO
                                            , PERF_DV_CD
                                            , CNTR_NO
                                            , CNTR_SN
                                            , CNTR_PERF_CRT_DV_CD
                                            , PERF_VAL
                                            <include refid="COMMON.insertSystemField" />
        )
        SELECT T2.FEE_REDF_YM    AS BASE_YM
             , T1.BASE_YM        AS PERF_YM
             , '02'              AS FEE_TCNT_DV_CD
             , #{perfAgrgCrtDvCd} AS PERF_AGRG_CRT_DV_CD
             , #{perfAtcCd}       AS PERF_ATC_CD
             , '2000'            AS CO_CD
             , #{ogTpCd}         AS OG_TP_CD
             , T1.PRTNR_NO
             , '0'               AS PERF_DV_CD
             , T1.CNTR_NO
             , T1.CNTR_SN
             , '02'              AS CNTR_PERF_CRT_DV_CD
             , 0                 AS PERF_VAL
            <include refid="COMMON.insertSystemFieldValue" />
          FROM TB_IFIN_LIF_ALNC_FEE_CNTR_IZ T1
               INNER JOIN TB_IFIN_LIF_ALNC_FEE_CNTR_IZ T2
                          ON (T1.CNTR_NO = T2.CNTR_NO AND T1.CNTR_SN = T2.CNTR_SN AND T1.OG_TP_CD = T2.OG_TP_CD)
         WHERE T2.FEE_REDF_YM = ${baseYm}
           AND T2.LIF_CNTR_STAT_CD = '1' /* 취소 */
           AND T1.LIF_CNTR_STAT_CD = '0'
           AND NVL(T1.FEE_DSB_YM, '0') > '0'
           AND T1.OG_TP_CD = #{ogTpCd}
           AND T2.CNFM_YN = 'Y'
           AND NVL(T1.FEE_DSB_YM, '0') <![CDATA[<]]> NVL(T2.FEE_REDF_YM,'0')
    </insert>

    <insert id="insertOrgContractDataFromLife">
        INSERT INTO TB_FEAM_NTORP_CNTR_MM_CL(
                                                      BASE_YM
                                                    , PERF_YM
                                                    , FEE_TCNT_DV_CD
                                                    , PERF_AGRG_CRT_DV_CD
                                                    , PERF_ATC_CD
                                                    , CO_CD
                                                    , OG_TP_CD
                                                    , PRTNR_NO
                                                    , PERF_DV_CD
                                                    , CNTR_NO
                                                    , CNTR_SN
                                                    , CNTR_PERF_CRT_DV_CD
                                                    , PERF_VAL
                                                    <include refid="COMMON.insertSystemField" />
                )
                SELECT T2.FEE_REDF_YM    AS BASE_YM
                     , T1.BASE_YM        AS PERF_YM
                     , '02'              AS FEE_TCNT_DV_CD
                     , #{perfAgrgCrtDvCd} AS PERF_AGRG_CRT_DV_CD
                     , #{perfAtcCd}       AS PERF_ATC_CD
                     , '2000'            AS CO_CD
                     , #{ogTpCd}         AS OG_TP_CD
                     , T1.PRTNR_NO
                     , '0'               AS PERF_DV_CD
                     , T1.CNTR_NO
                     , T1.CNTR_SN
                     , '02'              AS CNTR_PERF_CRT_DV_CD
                     , 0                 AS PERF_VAL
                    <include refid="COMMON.insertSystemFieldValue" />
                  FROM TB_IFIN_LIF_ALNC_FEE_CNTR_IZ T1
                       INNER JOIN TB_IFIN_LIF_ALNC_FEE_CNTR_IZ T2
                                  ON (T1.CNTR_NO = T2.CNTR_NO AND T1.CNTR_SN = T2.CNTR_SN AND T1.OG_TP_CD = T2.OG_TP_CD)
                       INNER JOIN TB_OGBS_MM_PRTNR_IZ T3
                                  ON (T1.BASE_YM = T3.BASE_YM AND T1.OG_TP_CD = T3.OG_TP_CD AND T1.PRTNR_NO = T3.PRTNR_NO)
                 WHERE T2.FEE_REDF_YM = ${baseYm}
                   AND T2.LIF_CNTR_STAT_CD = '1' /* 취소 */
                   AND T1.LIF_CNTR_STAT_CD = '0'
                   AND NVL(T1.FEE_DSB_YM, '0') > '0'
                   AND T1.OG_TP_CD = #{ogTpCd}
                   AND T3.PSTN_DV_CD != '7' /* 지점장 실적은 제외 */
                   AND T2.CNFM_YN = 'Y'
                   AND NVL(T1.FEE_DSB_YM, '0') <![CDATA[<]]> NVL(T2.FEE_REDF_YM,'0')
    </insert>

    <insert id="insertSumOfCntrDataToPrtnrForIndiv">
        INSERT INTO TB_FEAM_NTORP_PERF_MM_CL ( /* 순주문파트너실적월마감 */
                                               BASE_YM /* 기준년월 */
                                             , PERF_YM /* 실적년월 */
                                             , FEE_TCNT_DV_CD /* 수수료차수구분코드 */
                                             , PERF_AGRG_CRT_DV_CD /* 실적집계생성구분코드 */
                                             , PERF_ATC_CD /* 실적항목코드 */
                                             , CO_CD /* 회사코드 */
                                             , OG_TP_CD /* 조직유형코드 */
                                             , PRTNR_NO /* 파트너번호 */
                                             , PERF_DV_CD /* 실적구분코드 */
                                             , PERF_VAL /* 실적값 */
                                            <include refid="COMMON.insertSystemField"/>
        )
        SELECT BASE_YM
             , PERF_YM
             , FEE_TCNT_DV_CD
             , #{perfAgrgCrtDvCd} AS PERF_AGRG_CRT_DV_CD
             , PERF_ATC_CD
             , CO_CD
             , OG_TP_CD
             , PRTNR_NO
             , PERF_DV_CD
             , SUM(PERF_VAL)    AS PERF_VAL
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM (SELECT /*+ use_nl(REDF_PTN CNTR_MM) leading(REDF_PTN) */
                       #{baseYm}                                                     AS BASE_YM
                     , CNTR_MM.PERF_YM
                     , CNTR_MM.FEE_TCNT_DV_CD
                     , CNTR_MM.PERF_ATC_CD
                     , CNTR_MM.CO_CD
                     , CNTR_MM.OG_TP_CD
                     , CNTR_MM.PRTNR_NO
                     , CNTR_MM.PERF_DV_CD
                     , CNTR_MM.PERF_VAL
                     , CNTR_MM.CNTR_NO
                     , CNTR_MM.CNTR_SN
                     , ROW_NUMBER() OVER (PARTITION BY CNTR_MM.PERF_YM, CNTR_MM.PERF_ATC_CD, CNTR_MM.CO_CD, CNTR_MM.OG_TP_CD, CNTR_MM.PRTNR_NO, CNTR_MM.CNTR_NO, CNTR_MM.CNTR_SN
                  ORDER BY CNTR_MM.BASE_YM DESC, CNTR_MM.PERF_AGRG_CRT_DV_CD DESC) AS RN
                  FROM TB_FEAM_NTORP_CNTR_MM_CL CNTR_MM
                       INNER JOIN (SELECT DISTINCT PERF_YM
                                                 , CO_CD
                                                 , OG_TP_CD
                                                 , PRTNR_NO
                                                 , FEE_TCNT_DV_CD
                                                 , PERF_ATC_CD
                                     FROM TB_FEAM_NTORP_CNTR_MM_CL
                                    WHERE BASE_YM = #{baseYm}
                                      AND PERF_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -60), 'YYYYMM') AND TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -1), 'YYYYMM') -- 5년치 데이터
                                      AND PERF_AGRG_CRT_DV_CD IN ('103', '203')
                                      AND OG_TP_CD = #{ogTpCd}
                                      AND PERF_ATC_CD IN
                                                      <foreach item="perfAtcCd" collection="perfAtcCds" open="(" separator="," close=")">
                                                               #{perfAtcCd}
                                                      </foreach>
                                      AND DTA_DL_YN = 'N') REDF_PTN
                                  ON (CNTR_MM.PERF_YM = REDF_PTN.PERF_YM AND CNTR_MM.CO_CD = REDF_PTN.CO_CD AND
                                      CNTR_MM.OG_TP_CD = REDF_PTN.OG_TP_CD AND CNTR_MM.PRTNR_NO = REDF_PTN.PRTNR_NO AND
                                      CNTR_MM.FEE_TCNT_DV_CD = REDF_PTN.FEE_TCNT_DV_CD AND
                                      CNTR_MM.PERF_ATC_CD = REDF_PTN.PERF_ATC_CD)
                 WHERE CNTR_MM.BASE_YM BETWEEN REDF_PTN.PERF_YM AND #{baseYm})
         WHERE RN = 1
         GROUP BY BASE_YM
                , PERF_YM
                , FEE_TCNT_DV_CD
                , PERF_ATC_CD
                , CO_CD
                , OG_TP_CD
                , PRTNR_NO
                , PERF_DV_CD
    </insert>

    <insert id="insertSumOfCntrDataToPrtnrForOg">
        INSERT INTO TB_FEAM_NTORP_PERF_MM_CL ( /* 순주문파트너실적월마감 */
                                               BASE_YM /* 기준년월 */
                                             , PERF_YM /* 실적년월 */
                                             , FEE_TCNT_DV_CD /* 수수료차수구분코드 */
                                             , PERF_AGRG_CRT_DV_CD /* 실적집계생성구분코드 */
                                             , PERF_ATC_CD /* 실적항목코드 */
                                             , CO_CD /* 회사코드 */
                                             , OG_TP_CD /* 조직유형코드 */
                                             , PRTNR_NO /* 파트너번호 */
                                             , PERF_DV_CD /* 실적구분코드 */
                                             , PERF_VAL /* 실적값 */
                                            <include refid="COMMON.insertSystemField"/>
        )
        SELECT BASE_YM
             , PERF_YM
             , FEE_TCNT_DV_CD
             , #{perfAgrgCrtDvCd} AS PERF_AGRG_CRT_DV_CD
             , PERF_ATC_CD
             , CO_CD
             , OG_TP_CD
             , PRTNR_NO
             , PERF_DV_CD
             , SUM(PERF_VAL)           AS PERF_VAL
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM (SELECT /*+ LEADING(B) use_nl(B A) index(B IX_FEAM_MM_PRTNR_HOO_IZ_01) index(A IX_FEAM_NTORP_PERF_MM_CL_04) */
                       #{baseYm}        AS BASE_YM
                     , A.PERF_YM
                     , A.FEE_TCNT_DV_CD
                     , A.PERF_ATC_CD
                     , A.CO_CD
                     , A.OG_TP_CD
                     , B.HOO_PRTNR_NO       AS PRTNR_NO
                     , B.PERF_DV_CD
                     , A.PERF_VAL
                     , ROW_NUMBER() OVER (PARTITION BY A.PERF_YM, A.PERF_ATC_CD, A.CO_CD, A.OG_TP_CD, B.PERF_DV_CD, A.PRTNR_NO
                                              ORDER BY A.BASE_YM DESC, A.PERF_AGRG_CRT_DV_CD DESC) AS RN
                  FROM TB_FEAM_NTORP_PERF_MM_CL A
                 INNER JOIN TB_FEAM_MM_PRTNR_HOO_IZ B
                 ON (A.PERF_YM = B.BASE_YM AND A.OG_TP_CD = B.OG_TP_CD AND A.PRTNR_NO = B.PRTNR_NO)
                 INNER JOIN
                       (SELECT DISTINCT
                               T1.PERF_YM
                             , T1.CO_CD
                             , T1.OG_TP_CD
                             , T2.HOO_PRTNR_NO
                             , T2.PERF_DV_CD
                             , T1.FEE_TCNT_DV_CD
                             , T1.PERF_ATC_CD
                          FROM TB_FEAM_NTORP_PERF_MM_CL T1
                         INNER JOIN TB_FEAM_MM_PRTNR_HOO_IZ T2
                            ON (T1.PERF_YM    = T2.BASE_YM AND T1.OG_TP_CD   = T2.OG_TP_CD AND T1.PRTNR_NO   = T2.PRTNR_NO)
                         WHERE T1.BASE_YM    = #{baseYm}
                           AND T1.PERF_YM  BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -60), 'YYYYMM') AND TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -1), 'YYYYMM')
                           AND T1.OG_TP_CD = #{ogTpCd}
                           AND T1.PERF_AGRG_CRT_DV_CD = #{perfAgrgCrtDvCd}
                           AND T1.PERF_ATC_CD IN
                                <foreach item="perfAtcCd" collection="perfAtcCds" open="(" separator="," close=")">
                                    #{perfAtcCd}
                                </foreach>
                           AND T1.PERF_DV_CD = '0'
                           AND T2.PERF_DV_CD = '2'
                           AND T1.DTA_DL_YN  = 'N'
                       ) C
                    ON (A.PERF_YM        = C.PERF_YM AND A.CO_CD          = C.CO_CD AND B.OG_TP_CD       = C.OG_TP_CD AND B.hoo_prtnr_no       = C.hoo_prtnr_no
                   AND A.FEE_TCNT_DV_CD = C.FEE_TCNT_DV_CD AND A.PERF_ATC_CD    = C.PERF_ATC_CD AND A.PERF_DV_CD     = C.PERF_DV_CD)
                 WHERE A.BASE_YM  BETWEEN C.PERF_YM AND #{baseYm}
               ) A
         WHERE A.RN = 1
         GROUP BY A.BASE_YM, A.PERF_YM, A.FEE_TCNT_DV_CD, A.PERF_ATC_CD, A.CO_CD, A.OG_TP_CD, A.PRTNR_NO, A.PERF_DV_CD
    </insert>

    <insert id="insertActiPplNForPorganization">
        INSERT INTO TB_FEAM_PRTNR_PERF_MM_CL (  /* 파트너실적월마감 */
                                               BASE_YM             /* 기준년월 */
                                             , PERF_YM             /* 실적년월 */
                                             , FEE_TCNT_DV_CD      /* 수수료차수구분코드 */
                                             , PERF_AGRG_CRT_DV_CD /* 실적집계생성구분코드 */
                                             , PERF_ATC_CD         /* 실적항목코드 */
                                             , CO_CD               /* 회사코드 */
                                             , OG_TP_CD            /* 조직유형코드 */
                                             , PRTNR_NO            /* 파트너번호 */
                                             , PERF_VAL            /* 실적값 */
                                             <include refid="COMMON.insertSystemField" />)
    SELECT BASE_YM
         , PERF_YM
         , FEE_TCNT_DV_CD
         , '102'    AS PERF_AGRG_CRT_DV_CD
         , 'W01P00020' AS PERF_ATC_CD
         , CO_CD
         , OG_TP_CD
         , PRTNR_NO
         , COUNT(1) AS PERF_VAL
        <include refid="COMMON.insertSystemFieldValue" />
      FROM (SELECT T.BASE_YM                                       AS BASE_YM
                 , C.PERF_YM
                 , C.FEE_TCNT_DV_CD
                 , C.PERF_ATC_CD
                 , C.CO_CD
                 , C.OG_TP_CD
                 , B.HOO_PRTNR_NO                                  AS PRTNR_NO
                 , B.PERF_DV_CD
                 , C.PERF_VAL
                 , ROW_NUMBER() OVER (PARTITION BY C.PERF_YM, C.PERF_ATC_CD, C.CO_CD, C.OG_TP_CD, B.PERF_DV_CD, C.PRTNR_NO
              ORDER BY C.BASE_YM DESC, C.PERF_AGRG_CRT_DV_CD DESC) AS RN
              FROM (SELECT DISTINCT T1.BASE_YM
                                  , T1.PERF_YM
                                  , T1.CO_CD
                                  , T1.OG_TP_CD
                                  , T2.HOO_PRTNR_NO
                                  , T2.PERF_DV_CD
                                  , T1.FEE_TCNT_DV_CD
                                  , T1.PERF_ATC_CD
                      FROM TB_FEAM_NTORP_PERF_MM_CL T1
                           INNER JOIN TB_FEAM_MM_PRTNR_HOO_IZ T2
                                      ON T1.PERF_YM = T2.BASE_YM
                                          AND T1.OG_TP_CD = T2.OG_TP_CD
                                          AND T1.PRTNR_NO = T2.PRTNR_NO
                       AND T1.BASE_YM = #{baseYm}
                       AND T1.PERF_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -60), 'YYYYMM') AND TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -1), 'YYYYMM')
                       AND T1.PERF_AGRG_CRT_DV_CD = '102'
                       AND T1.PERF_ATC_CD = 'W01P00009'
                       AND T1.PERF_DV_CD = '0'
                       AND T2.PERF_DV_CD = '2'
                       AND T1.DTA_DL_YN = 'N'
                       AND T2.PRTNR_NO != T2.HOO_PRTNR_NO /* 본인이 지국장인 경우 제외 */
                     WHERE 1 = 1) T
                   INNER JOIN TB_FEAM_MM_PRTNR_HOO_IZ B
                              ON T.PERF_YM = B.BASE_YM
                                  AND T.OG_TP_CD = B.OG_TP_CD
                                  AND T.HOO_PRTNR_NO = B.HOO_PRTNR_NO
                                  AND T.PERF_DV_CD = B.PERF_DV_CD
                   INNER JOIN TB_FEAM_NTORP_PERF_MM_CL C
                              ON T.PERF_YM = C.PERF_YM
                                  AND T.CO_CD = C.CO_CD
                                  AND B.OG_TP_CD = C.OG_TP_CD
                                  AND B.PRTNR_NO = C.PRTNR_NO
                                  AND T.PERF_ATC_CD = C.PERF_ATC_CD
                                  AND T.FEE_TCNT_DV_CD = C.FEE_TCNT_DV_CD
                                  AND C.PERF_DV_CD = '0'
             WHERE 1 = 1
               AND C.BASE_YM BETWEEN T.PERF_YM AND T.BASE_YM
               AND B.PRTNR_NO != B.HOO_PRTNR_NO /* 본인이 지국장인 경우 제외 */) A
     WHERE A.RN = 1
       AND PERF_VAL >= 2500000
    GROUP BY BASE_YM, PERF_YM, FEE_TCNT_DV_CD, PERF_ATC_CD, CO_CD, OG_TP_CD, PRTNR_NO
    </insert>
</mapper>
