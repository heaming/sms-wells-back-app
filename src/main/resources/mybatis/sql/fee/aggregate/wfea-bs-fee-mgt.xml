<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.aggregate.mapper.WfeaBsFeeMgtMapper">

    <select id="selectBsFees" resultType="com.kyowon.sms.wells.web.fee.aggregate.dto.WfeaBsFeeMgtDto$SearchRes">
        SELECT T1.PRTNR_NO
             , T4.OG_CD
             , T4.PRTNR_KNM
             , T1.CNTR_NO	/*계약번호*/
             , T1.BASE_PD_CD	/*상품코드*/
             , T2.PD_NM /*상품명*/
             , BAS.SV_FEE_PD_DV_CD	/*BS상품군*/
             , F_CMZ_CD_NM('TNT_WELLS', 'SV_FEE_PD_DV_CD', BAS.SV_FEE_PD_DV_CD) AS SV_FEE_PD_DV_NM	/*BS상품군*/
             , NVL(BAS.SV_FEE_BASE_AMT, 0) AS SV_FEE_BASE_AMT	/*BS기본수수료*/
             , NVL(T1.FEE_CALC_AMT, 0) AS FEE_CALC_AMT	/*방문수수료*/
             , T1.SV_BIZ_DCLSF_CD	/*작업유형코드*/
             , T1.VST_RGLVL_GD_CD	/*방문급지*/
             , CASE T1.VST_RGLVL_GD_CD WHEN '1' THEN
                    CASE T4.OG_TP_CD WHEN 'W02' THEN 'N' ELSE 'A' END
               WHEN '2' THEN
                    CASE T4.OG_TP_CD WHEN 'W02' THEN 'G' ELSE 'B' END
               WHEN '3' THEN
                    CASE T4.OG_TP_CD WHEN 'W02' THEN 'W1' ELSE 'C' END
               WHEN '4' THEN
                    CASE T4.OG_TP_CD WHEN 'W02' THEN 'W2' ELSE 'D' END
               WHEN '5' THEN 'W3'
               WHEN '6' THEN 'S1'
               WHEN '7' THEN 'S2'
               ELSE '*' END AS VST_RGLVL_GD_NM /*방문급지*/
             , CASE T1.FILT_SELL_TP_CD WHEN '1' THEN ' 할부'
               WHEN '2' THEN ' 렌탈'
               WHEN '3' THEN ' 멤버십'
               WHEN '4' THEN ' 회사'
               ELSE ' ****'
               END  AS SELL_TP_NM	/*판매구분*/
             , T1.PD_USWY_CD || '-' || F_CMZ_CD_NM('TNT_WELLS', 'PD_USWY_CD', T1.PD_USWY_CD) AS USWY_NM	/*용도구분*/
             , CASE WHEN T1.SV_BIZ_DCLSF_CD = '2240' THEN 'Y' ELSE 'N' END AS PRR_VST_YN	/*사전방문여부*/
             , T1.VST_DUEDT	/*방문예정일자*/
             , T1.WK_EXCN_DT	/*방문일자*/
             , CASE WHEN T1.VST_TP_DV_CD = '2' THEN	'Y'
               ELSE 'N' END AS CAN_YN	/*취소여부*/
         FROM TB_FEAM_WELS_SV_PERF_IZ T1	/*웰스서비스실적내역*/
         LEFT OUTER JOIN
             ( SELECT A.PD_CD
             		, A.PD_NM
                    , A.PD_CLSF_ID
                    , B.REF_PD_CLSF_VAL
                 FROM TB_PDBS_PD_BAS A
                INNER JOIN TB_PDBS_PD_CLSF_BAS B
                   ON A.PD_CLSF_ID = B.PD_CLSF_ID
                  AND B.DTA_DL_YN = 'N'
                WHERE A.DTA_DL_YN = 'N'
             ) T2	/*상품*/
            ON T1.BASE_PD_CD = T2.PD_CD
          LEFT OUTER JOIN LATERAL
             ( /*
                * 웰스팜 기기 + 모종 결합 계약인 경우, 웰스팜 기기 방문에 수수료 지급
                * => 정기배송 패키지 상품(모종)이고 결합 계약인 것을 제외함
                * */
                SELECT NULL AS HCR_DV_CD
                    , CASE WHEN C3.CNTR_REL_DTL_CD = '216'	/*모종결합*/ THEN 'Y' ELSE 'N' END AS COMBI_YN	/*결합제외여부*/
                 FROM TB_SSCT_CNTR_DTL C1	/*계약상세*/
                 LEFT OUTER JOIN TB_SSCT_CNTR_REL C3	/*계약관계*/
                   ON C3.OJ_DTL_CNTR_NO = C1.CNTR_NO
                  AND C3.OJ_DTL_CNTR_SN = C1.CNTR_SN
                  AND C3.DTA_DL_YN = 'N'
                WHERE C1.DTA_DL_YN = 'N'
                  AND C1.CNTR_NO = T1.CNTR_NO
                  AND C1.CNTR_SN = T1.CNTR_SN
                  AND C1.SELL_TP_CD = '6'	/*정기배송*/
                UNION ALL
                 /*멤버십*/
               SELECT C2.HCR_DV_CD
                    , 'N' AS COMBI_YN	/*결합여부*/
                 FROM TB_SSCT_CNTR_DTL C1	/*계약상세*/
                INNER JOIN TB_SSCT_CNTR_WELLS_DTL C2
                   ON C1.CNTR_NO = C2.CNTR_NO
                  AND C1.CNTR_SN = C2.CNTR_SN
                WHERE C1.CNTR_NO = T1.CNTR_NO
                  AND C1.CNTR_SN = T1.CNTR_SN
                  AND C1.SELL_TP_CD = '3'	/*멤버십*/
                  AND C1.DTA_DL_YN = 'N'
                UNION ALL
                 /*
                  * 렌탈
                  * 웰스팜 기기이고 결합이 아니면 제외
                  * */
               SELECT NULL AS HCR_DV_CD
                    , CASE WHEN T2.REF_PD_CLSF_VAL LIKE '05001003%' AND C3.CNTR_REL_DTL_CD != '216' THEN 'Y' ELSE 'N' END AS COMBI_YN	/*결합제외여부*/
                 FROM TB_SSCT_CNTR_DTL C1	/*계약상세*/
                 LEFT OUTER JOIN TB_SSCT_CNTR_REL C3	/*계약관계*/
                   ON C3.BASE_DTL_CNTR_NO = C1.CNTR_NO
                  AND C3.BASE_DTL_CNTR_SN = C1.CNTR_SN
                  AND C3.DTA_DL_YN = 'N'
                INNER JOIN TB_SSCT_CNTR_WELLS_DTL C4	/*계약WELLS상세*/
                   ON C4.CNTR_NO = C1.CNTR_NO
                  AND C4.CNTR_SN = C1.CNTR_SN
                  AND C4.DTA_DL_YN = 'N'
                WHERE C1.DTA_DL_YN = 'N'
                  AND C1.CNTR_NO = T1.CNTR_NO
                  AND C1.CNTR_SN = T1.CNTR_SN
                  AND C1.SELL_TP_CD = '2'	/*렌탈/리스*/
                UNION ALL
                 /*
                  * 할부판매(일시불)
                  * 웰스팜 기기이고 결합이 아니면 제외
                  * */
               SELECT C4.HCR_DV_CD
                    , CASE WHEN T2.REF_PD_CLSF_VAL LIKE '05001003%' AND C3.CNTR_REL_DTL_CD != '216' THEN 'Y' ELSE 'N' END AS COMBI_YN	/*결합제외여부*/
                FROM TB_SSCT_CNTR_DTL C1	/*계약상세*/
                LEFT OUTER JOIN TB_SSCT_CNTR_REL C3	/*계약관계*/
                  ON C3.BASE_DTL_CNTR_NO = C1.CNTR_NO
                 AND C3.BASE_DTL_CNTR_SN = C1.CNTR_SN
                 AND C3.DTA_DL_YN = 'N'
               INNER JOIN TB_SSCT_CNTR_WELLS_DTL C4	/*계약WELLS상세*/
                  ON C4.CNTR_NO = C1.CNTR_NO
                 AND C4.CNTR_SN = C1.CNTR_SN
                 AND C4.DTA_DL_YN = 'N'
               WHERE C1.DTA_DL_YN = 'N'
                 AND C1.CNTR_NO = T1.CNTR_NO
                 AND C1.CNTR_SN = T1.CNTR_SN
                 AND C1.SELL_TP_CD = '1'	/*일시불*/
            ) T3 ON 1=1
         LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ T4 /* 월파트너내역 */
           ON T1.BASE_YM = T4.BASE_YM
          AND T1.OG_TP_CD = T4.OG_TP_CD
          AND T1.PRTNR_NO = T4.PRTNR_NO
          AND T4.DTA_DL_YN = 'N'
         LEFT OUTER JOIN LATERAL
            ( SELECT SV_FEE_BASE_AMT	/*BS기본수수료*/
                   , SV_FEE_PD_DV_CD	/*BS상품그룹*/
                FROM TB_FEAM_WELS_SV_FEE_BAS C
               WHERE BASE_PD_CD = T1.BASE_PD_CD
                 AND VST_MCN = 0
                 AND SV_FEE_DV_CD = CASE WHEN T4.OG_TP_CD = 'W03' THEN '2' ELSE '1' END
                 AND HCR_DV_CD = CASE WHEN T2.REF_PD_CLSF_VAL NOT LIKE '06%' THEN HCR_DV_CD ELSE NVL(T3.HCR_DV_CD, '') END
                 AND #{perfYm} BETWEEN APY_STRT_YM AND APY_END_YM
                 AND DTA_DL_YN = 'N'
               ORDER BY BASE_PD_CD, VST_MCN, SV_FEE_DV_CD, HCR_DV_CD ASC, BASE_CH_TCNT DESC
               FETCH FIRST ROWS ONLY
            ) BAS
           ON 1=1
        WHERE T1.BASE_YM = #{perfYm}
          AND T1.CL_DV_CD = #{feeTcntDvCd}
          AND T1.OG_TP_CD = #{ogTpCd}
          AND (T1.WK_EXCN_DT IS NOT NULL OR T1.WK_EXCN_DT != '0')	/*작업수행일자*/
          AND T3.COMBI_YN != 'Y' /*모종이고 결합이면 제외, 기기이고 결합이 아니면 제외*/
          AND EXISTS
         	( SELECT 1
	            FROM TB_FEAM_WPTN_SV_PERF_AGRG A	/*웰스파트너서비스실적집계*/
	           INNER JOIN TB_FEAM_NTORP_PERF_MM_CL B	/*순주문파트너실적월마감*/
	              ON A.BASE_YM = B.BASE_YM
	             AND A.BASE_YM = B.PERF_YM
	             AND A.CL_DV_CD = B.FEE_TCNT_DV_CD
	             AND A.OG_TP_CD = B.OG_TP_CD
	             AND A.PRTNR_NO = B.PRTNR_NO
	             AND B.DTA_DL_YN = 'N'
	             AND B.PERF_DV_CD = '0'
                <if test='@MybatisUtils@equals(ogTpCd, "W02")'>
                 AND B.PERF_ATC_CD IN ('W02P00085', 'W02P00095')
                </if>
	            <if test='@MybatisUtils@equals(ogTpCd, "W03")'>
                 AND B.PERF_ATC_CD IN ('W03P00085', 'W03P00095')
                </if>
	           WHERE A.DTA_DL_YN = 'N'
	             AND A.BASE_YM = #{perfYm}
	             AND A.CL_DV_CD = #{feeTcntDvCd}
	             AND A.OG_TP_CD = #{ogTpCd}
         	)   /*2023.08.04 BS실적집계가 되어야 조회 가능하도록 수정*/
        <if test='@MybatisUtils@isNotEmpty(strtPdCd)'>
          AND T1.BASE_PD_CD <![CDATA[>=]]> #{strtPdCd}	/*상품코드*/
        </if>
        <if test='@MybatisUtils@isNotEmpty(endPdCd)'>
          AND T1.BASE_PD_CD <![CDATA[<=]]> #{endPdCd}	/*상품코드*/
        </if>
        <if test='@MybatisUtils@isNotEmpty(strtVstDt) and @MybatisUtils@isNotEmpty(endVstDt)'>
          AND T1.WK_EXCN_DT BETWEEN #{strtVstDt} AND #{endVstDt}	/*방문일자*/
        </if>
        <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
          AND T1.PRTNR_NO = #{prtnrNo}
        </if>
        ORDER BY T1.PRTNR_NO, T1.CNTR_NO
    </select>

</mapper>
