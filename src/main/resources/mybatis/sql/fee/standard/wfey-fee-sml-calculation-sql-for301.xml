<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.standard.mapper.WfeyFeeSmlCalculationSqlFor301Mapper">

    <insert id='insertEarlSettleFee'>
        /* 조기정착수수료 기준*/
        INSERT INTO TB_FEAM_FEE_SML_BAS (  /* 수수료시뮬레이션기본 */
               BASE_YM            /* 기준년월 */
             , PERF_YM            /* 실적년월 */
             , OJ_DSB_YM          /* 대상지급년월 */
             , CO_CD              /* 회사코드 */
             , OG_TP_CD           /* 조직유형코드 */
             , PRTNR_NO           /* 파트너번호 */
             , FEE_CD             /* 수수료코드 */
             , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
             , FEE_DSB_MTHD_CD    /* 수수료지급방식코드 */
             , SML_CRT_TP_CD      /* 시뮬레이션생성유형코드 */
             , FEE_CALC_AMT       /* 수수료계산금액 */
             , FNL_FEE_YN         /* 최종수수료여부 */
             <include refid="COMMON.insertSystemField" />
                                            )
        SELECT Z.BASE_YM
             , Z.BASE_YM        AS PERF_YM
             , Z.BASE_YM        AS OJ_DSB_YM
             , #{coCd}          AS CO_CD          -- 고정
             , Z.OG_TP_CD
             , Z.PRTNR_NO
             , #{feeCd}         AS FEE_CD
             , NVL(#{dtaCrtFeeCd}, #{feeCd})    AS DTA_CRT_FEE_CD
             , '01'             AS FEE_DSB_MTHD_CD -- 수수료지급방식코드
             , #{smlCrtTpCd}    AS SML_CRT_TP_CD
             , Z.FEE_CALC_AMT   AS FEE_CALC_AMT
             , #{fnlFeeYn}      AS FNL_FEE_YN
        <include refid="COMMON.insertSystemFieldValue" />
          FROM (
                    /* 0차월 */
           SELECT A.BASE_YM
                 ,A.CO_CD
                 ,A.OG_TP_CD
                 ,A.PRTNR_NO
           --      ,NVL(B.FEE_PERF_ATC_VAL,'N')   -- 교육이수여부
           --      ,NVL(C.PERF_VAL,0)             -- 서비스 건수
           --      ,NVL(D.CNT_SELL,0)             -- 렌탈 판매 건수
                 ,CASE WHEN NVL(C.PERF_VAL,0) >= 100 AND NVL(D.CNT_SELL,0) >= 1 THEN 700000
                       WHEN NVL(C.PERF_VAL,0) >= 75                             THEN 500000
                       WHEN NVL(C.PERF_VAL,0) >= 20                             THEN 300000
                       ELSE 0 END  AS FEE_CALC_AMT
                 ,CASE WHEN NVL(C.PERF_VAL,0) >= 100 AND NVL(D.CNT_SELL,0) >= 1 THEN 700000
                       WHEN NVL(C.PERF_VAL,0) >= 75                             THEN 500000
                       WHEN NVL(C.PERF_VAL,0) >= 20                             THEN 300000
                       ELSE 0 END  AS FEE_CTR_CNFM_AMT
                 ,#{fnlFeeYn}                       AS FNL_FEE_YN
             FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL A
                 JOIN TB_OGBS_MM_PRTNR_IZ Z
                 ON  A.BASE_YM             = Z.BASE_YM
                 AND A.OG_TP_CD            = Z.OG_TP_CD
                 AND A.PRTNR_NO            = Z.PRTNR_NO
                 AND NVL(Z.PERF_EXCD_OJ_YN,'N') = 'N'
                 LEFT OUTER JOIN  TB_FEAM_PRTNR_PERF_MM_ACU_CL B
                 ON A.MM_ACU_PERF_AGRG_CRT_DV_CD  = B.MM_ACU_PERF_AGRG_CRT_DV_CD
                 AND A.BASE_YM                    = B.BASE_YM
                 AND A.PERF_AGRG_CRT_DV_CD        = B.PERF_AGRG_CRT_DV_CD
                 AND A.CO_CD                      = B.CO_CD
                 AND A.OG_TP_CD                   = B.OG_TP_CD
                 AND A.PRTNR_NO                   = B.PRTNR_NO
                 AND 'W03P00112'                  = B.PERF_ATC_CD                   /* 교육수료  */
                 LEFT OUTER JOIN  TB_FEAM_MACUP_PERF_CL C
                 ON A.MM_ACU_PERF_AGRG_CRT_DV_CD  = C.MM_ACU_PERF_AGRG_CRT_DV_CD
                 AND A.BASE_YM                    = C.BASE_YM
                 AND A.PERF_AGRG_CRT_DV_CD        = C.PERF_AGRG_CRT_DV_CD
                 AND A.CO_CD                      = C.CO_CD
                 AND A.OG_TP_CD                   = C.OG_TP_CD
                 AND A.PRTNR_NO                   = C.PRTNR_NO
                 AND 'W03P00085'                  = C.PERF_ATC_CD                   /* 서비스건수  */
                 AND '0'                          = C.PERF_DV_CD                     /* 개인실적  */
                 LEFT OUTER JOIN (SELECT  D.OG_TP_CD, D.PRTNR_NO, COUNT(D.CNTR_NO) CNT_SELL
                   FROM TB_FEAM_WELS_MM_ACU_CNTR_CL D             -- 총주문
                   WHERE 1 = 1
                     AND D.MM_ACU_PERF_AGRG_CRT_DV_CD = #{mmAcuPerfAgrgCrtDvCd}
                     AND D.BASE_YM          = #{baseYm}
                     AND D.OG_TP_CD         = #{ogTpCd}
                     AND D.SELL_TP_CD       = '2'      /* 렌탈/리스  */
                     AND NVL(D.CAN_DT,'0')  = '0'
                    GROUP BY  D.OG_TP_CD, D.PRTNR_NO) D
                 ON  A.OG_TP_CD            = D.OG_TP_CD
                 AND A.PRTNR_NO            = D.PRTNR_NO
            WHERE 1 = 1
              AND A.MM_ACU_PERF_AGRG_CRT_DV_CD = #{mmAcuPerfAgrgCrtDvCd}
              AND A.BASE_YM          = #{baseYm}    -- 변수
              AND A.OG_TP_CD         = #{ogTpCd}       -- 고정
              AND A.PERF_ATC_CD      = 'W03P00124' -- 고정
              AND A.PERF_VAL         = 0           -- 고정 ( 0차월 )
 	        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
	           AND A.PRTNR_NO = #{prtnrNo}
	        </if>
           UNION ALL
           /* 1차월 */
           SELECT A.BASE_YM
                 ,A.CO_CD
                 ,A.OG_TP_CD
                 ,A.PRTNR_NO
           --      ,NVL(B.FEE_PERF_ATC_VAL,'N')   -- 교육이수여부
           --      ,NVL(C.PERF_VAL,0)             -- 서비스 건수
           --      ,NVL(D.CNT_SELL,0)             -- 렌탈 판매 건수
                 ,CASE WHEN NVL(B.FEE_PERF_ATC_VAL,'N') = 'Y' AND NVL(C.PERF_VAL,0) >= 100 AND NVL(D.CNT_SELL,0) >= 1 THEN 700000
                       WHEN NVL(B.FEE_PERF_ATC_VAL,'N') = 'Y' AND NVL(C.PERF_VAL,0) >= 75                             THEN 500000
                       ELSE 0 END  AS FEE_CALC_AMT
                 ,CASE WHEN NVL(B.FEE_PERF_ATC_VAL,'N') = 'Y' AND NVL(C.PERF_VAL,0) >= 100 AND NVL(D.CNT_SELL,0) >= 1 THEN 700000
                       WHEN NVL(B.FEE_PERF_ATC_VAL,'N') = 'Y' AND NVL(C.PERF_VAL,0) >= 75                             THEN 500000
                       ELSE 0 END  AS FEE_CTR_CNFM_AMT
                 ,'Y'                       AS FNL_FEE_YN
             FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL A
                 JOIN TB_OGBS_MM_PRTNR_IZ Z
                 ON  A.BASE_YM             = Z.BASE_YM
                 AND A.OG_TP_CD            = Z.OG_TP_CD
                 AND A.PRTNR_NO            = Z.PRTNR_NO
                 AND NVL(Z.PERF_EXCD_OJ_YN,'N') = 'N'
                 LEFT OUTER JOIN  TB_FEAM_PRTNR_PERF_MM_ACU_CL B
                 ON A.MM_ACU_PERF_AGRG_CRT_DV_CD  = B.MM_ACU_PERF_AGRG_CRT_DV_CD
                 AND A.BASE_YM                    = B.BASE_YM
                 AND A.PERF_AGRG_CRT_DV_CD        = B.PERF_AGRG_CRT_DV_CD
                 AND A.CO_CD                      = B.CO_CD
                 AND A.OG_TP_CD                   = B.OG_TP_CD
                 AND A.PRTNR_NO                   = B.PRTNR_NO
                 AND 'W03P00112'                  = B.PERF_ATC_CD                   /* 교육수료  */
                 LEFT OUTER JOIN  TB_FEAM_MACUP_PERF_CL C
                 ON A.MM_ACU_PERF_AGRG_CRT_DV_CD  = C.MM_ACU_PERF_AGRG_CRT_DV_CD
                 AND A.BASE_YM                    = C.BASE_YM
                 AND A.PERF_AGRG_CRT_DV_CD        = C.PERF_AGRG_CRT_DV_CD
                 AND A.CO_CD                      = C.CO_CD
                 AND A.OG_TP_CD                   = C.OG_TP_CD
                 AND A.PRTNR_NO                   = C.PRTNR_NO
                 AND 'W03P00085'                  = C.PERF_ATC_CD                   /* 서비스건수  */
                 AND '0'                          = C.PERF_DV_CD                     /* 개인실적  */
                 LEFT OUTER JOIN (SELECT  D.OG_TP_CD, D.PRTNR_NO, COUNT(D.CNTR_NO) CNT_SELL
                   FROM TB_FEAM_WELS_MM_ACU_CNTR_CL D             -- 총주문
                   WHERE 1 = 1
                     AND D.MM_ACU_PERF_AGRG_CRT_DV_CD = #{mmAcuPerfAgrgCrtDvCd}
                     AND D.BASE_YM          = #{baseYm}
                     AND D.OG_TP_CD         = #{ogTpCd}
                     AND D.SELL_TP_CD       = '2'      /* 렌탈/리스  */
                     AND NVL(D.CAN_DT,'0')  = '0'
                   GROUP BY  D.OG_TP_CD, D.PRTNR_NO  ) D
                 ON  A.OG_TP_CD            = D.OG_TP_CD
                 AND A.PRTNR_NO            = D.PRTNR_NO
            WHERE 1 = 1
              AND A.MM_ACU_PERF_AGRG_CRT_DV_CD = #{mmAcuPerfAgrgCrtDvCd}
              AND A.BASE_YM          = #{baseYm}    -- 변수
              AND A.OG_TP_CD         = #{ogTpCd}       -- 고정
              AND A.PERF_ATC_CD      = 'W03P00124' -- 고정
              AND A.PERF_VAL         = 1           -- 고정 ( 1차월 )
	        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
	           AND A.PRTNR_NO = #{prtnrNo}
	        </if>
           UNION ALL
           /* 2차월 */
           SELECT A.BASE_YM
                 ,A.CO_CD
                 ,A.OG_TP_CD
                 ,A.PRTNR_NO
           --      ,NVL(B.FEE_PERF_ATC_VAL,'N')   -- 교육이수여부
           --      ,NVL(C.PERF_VAL,0)             -- 서비스 건수
           --      ,NVL(D.CNT_SELL,0)             -- 렌탈 판매 건수
                 ,CASE WHEN NVL(B.FEE_PERF_ATC_VAL,'N') = 'Y' AND NVL(C.PERF_VAL,0) >= 100 AND NVL(D.CNT_SELL,0) >= 1 THEN 700000
                       ELSE 0 END  AS FEE_CALC_AMT
                 ,CASE WHEN NVL(B.FEE_PERF_ATC_VAL,'N') = 'Y' AND NVL(C.PERF_VAL,0) >= 100 AND NVL(D.CNT_SELL,0) >= 1 THEN 700000
                       ELSE 0 END  AS FEE_CTR_CNFM_AMT
                 ,'Y'                       AS FNL_FEE_YN
             FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL A
                 JOIN TB_OGBS_MM_PRTNR_IZ Z
                 ON  A.BASE_YM             = Z.BASE_YM
                 AND A.OG_TP_CD            = Z.OG_TP_CD
                 AND A.PRTNR_NO            = Z.PRTNR_NO
                 AND NVL(Z.PERF_EXCD_OJ_YN,'N') = 'N'
                 LEFT OUTER JOIN  TB_FEAM_PRTNR_PERF_MM_ACU_CL B
                 ON A.MM_ACU_PERF_AGRG_CRT_DV_CD  = B.MM_ACU_PERF_AGRG_CRT_DV_CD
                 AND A.BASE_YM                    = B.BASE_YM
                 AND A.PERF_AGRG_CRT_DV_CD        = B.PERF_AGRG_CRT_DV_CD
                 AND A.CO_CD                      = B.CO_CD
                 AND A.OG_TP_CD                   = B.OG_TP_CD
                 AND A.PRTNR_NO                   = B.PRTNR_NO
                 AND 'W03P00112'                  = B.PERF_ATC_CD                   /* 교육수료  */
                 LEFT OUTER JOIN  TB_FEAM_MACUP_PERF_CL C
                 ON A.MM_ACU_PERF_AGRG_CRT_DV_CD  = C.MM_ACU_PERF_AGRG_CRT_DV_CD
                 AND A.BASE_YM                    = C.BASE_YM
                 AND A.PERF_AGRG_CRT_DV_CD        = C.PERF_AGRG_CRT_DV_CD
                 AND A.CO_CD                      = C.CO_CD
                 AND A.OG_TP_CD                   = C.OG_TP_CD
                 AND A.PRTNR_NO                   = C.PRTNR_NO
                 AND 'W03P00085'                  = C.PERF_ATC_CD                   /* 서비스건수  */
                 AND '0'                          = C.PERF_DV_CD                     /* 개인실적  */
                 LEFT OUTER JOIN (SELECT  D.OG_TP_CD, D.PRTNR_NO, COUNT(D.CNTR_NO) CNT_SELL   /* 2차월은 지난 3개월 중 판매건수 본다  */
                   FROM TB_FEAM_WELS_MM_ACU_CNTR_CL D             -- 총주문
                   WHERE 1 = 1
                     AND D.MM_ACU_PERF_AGRG_CRT_DV_CD = #{mmAcuPerfAgrgCrtDvCd}
                     AND D.BASE_YM          >= TO_CHAR(ADD_MONTHS(#{baseYm}||'01',-2),'YYYYMM')    -- 변수 (기준년월)
                     AND D.BASE_YM          <![CDATA[<=]]> #{baseYm}    -- 변수
                     AND D.OG_TP_CD         = #{ogTpCd}
                     AND D.SELL_TP_CD       = '2'      /* 렌탈/리스  */
                     AND NVL(D.CAN_DT,'0')  = '0'
                    GROUP BY  D.OG_TP_CD, D.PRTNR_NO  ) D
                 ON  A.OG_TP_CD            = D.OG_TP_CD
                 AND A.PRTNR_NO            = D.PRTNR_NO
            WHERE 1 = 1
              AND A.MM_ACU_PERF_AGRG_CRT_DV_CD = #{mmAcuPerfAgrgCrtDvCd}
              AND A.BASE_YM          = #{baseYm}    -- 변수
              AND A.OG_TP_CD         = #{ogTpCd}       -- 고정
              AND A.PERF_ATC_CD      = 'W03P00124' -- 고정
              AND A.PERF_VAL         = 2           -- 고정 ( 2차월 )
	        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
	           AND A.PRTNR_NO = #{prtnrNo}
	        </if>
               ) Z
         WHERE 1 = 1
           AND Z.FEE_CALC_AMT > 0
    </insert>


    <insert id='insertEducationFee'>
        /* 교육수수료 기준*/
        INSERT INTO TB_FEAM_FEE_SML_BAS (  /* 수수료시뮬레이션기본 */
               BASE_YM            /* 기준년월 */
             , PERF_YM            /* 실적년월 */
             , OJ_DSB_YM          /* 대상지급년월 */
             , CO_CD              /* 회사코드 */
             , OG_TP_CD           /* 조직유형코드 */
             , PRTNR_NO           /* 파트너번호 */
             , FEE_CD             /* 수수료코드 */
             , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
             , FEE_DSB_MTHD_CD    /* 수수료지급방식코드 */
             , SML_CRT_TP_CD      /* 시뮬레이션생성유형코드 */
             , FEE_CALC_AMT       /* 수수료계산금액 */
             , FNL_FEE_YN         /* 최종수수료여부 */
             <include refid="COMMON.insertSystemField" />
                                            )
        SELECT Z.BASE_YM
             , Z.PERF_YM
             , Z.OJ_DSB_YM
             , #{coCd}          AS CO_CD          -- 고정
             , Z.OG_TP_CD
             , Z.PRTNR_NO
             , #{feeCd}         AS FEE_CD
             , NVL(#{dtaCrtFeeCd}, #{feeCd})    AS DTA_CRT_FEE_CD
             , '01'             AS FEE_DSB_MTHD_CD -- 수수료지급방식코드
             , #{smlCrtTpCd}    AS SML_CRT_TP_CD
             , Z.FEE_CALC_AMT   AS FEE_CALC_AMT
             , #{fnlFeeYn}      AS FNL_FEE_YN
        <include refid="COMMON.insertSystemFieldValue" />
         FROM ( /* 지난달 시작건 복사  */
		        SELECT A.BASE_YM
		              ,A.PERF_YM
		              ,A.OJ_DSB_YM
		              ,A.OG_TP_CD
		              ,A.PRTNR_NO
		              ,A.FEE_CALC_AMT
		          FROM TB_FEAM_FEE_CALC_BAS A
		         WHERE 1 = 1
		           AND A.OJ_DSB_YM = #{baseYm}
		           AND A.FEE_TCNT_DV_CD = '02'  -- 고정
		           AND A.BASE_YM != A.OJ_DSB_YM -- 과거에 만들어 둔거
		           AND A.FEE_CD = 'W030011'     -- 고정
		           AND A.DTA_DL_YN = 'N'
	 	        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
		           AND A.PRTNR_NO = #{prtnrNo}
		        </if>
		           AND A.PRTNR_NO  IN (SELECT B.PRTNR_NO /* 월파트너에 존재하면 복사...  */
		                                    FROM TB_OGBS_MM_PRTNR_IZ B
		                                   WHERE 1 = 1
		                                     AND B.BASE_YM = #{baseYm}
		                                     AND B.OG_TP_CD = #{ogTpCd}
		                                     AND B.PSTN_DV_CD = '15' -- 고정
		                               )
		         UNION ALL
			        SELECT A.BASE_YM
			             , A.BASE_YM AS PERF_YM
			             , A.BASE_YM AS OJ_DSB_YM
			             , A.OG_TP_CD
			             , A.PRTNR_NO
			             , 75000     AS FEE_CALC_AMT
			          FROM TB_OGBS_MM_PRTNR_IZ A
			         WHERE 1 = 1
			           AND A.BASE_YM = #{baseYm}
			           AND A.OG_TP_CD = #{ogTpCd}
			           AND A.PSTN_DV_CD = '15'               -- 고정
			           AND NVL(A.PERF_EXCD_OJ_YN, 'N') = 'N' -- 고정 (실직제외여부)
			           AND A.FST_CNTR_DT >= '20230901'       -- 고정 (시스템 적용 월부터)
		 	        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
			           AND A.PRTNR_NO = #{prtnrNo}
			        </if>
			           AND A.PRTNR_NO NOT IN (SELECT B.PRTNR_NO
			                                    FROM TB_FEAM_FEE_CALC_BAS B
			                                   WHERE 1 = 1
			                                     AND B.BASE_YM <![CDATA[<]]> #{baseYm}
			                                     AND B.FEE_TCNT_DV_CD = '02'
			                                     AND B.FEE_CD = #{feeCd}
			                                     AND B.FEE_CTR_CNFM_AMT > 0
			                                     AND B.DTA_DL_YN = 'N') /* 지난달까지 교육 수수료 지급 이력이 있으면 대상 제외  */
			           AND A.PRTNR_NO IN (SELECT C.PRTNR_NO
			                                FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL C
			                               WHERE 1 = 1
			                                 AND C.MM_ACU_PERF_AGRG_CRT_DV_CD = #{mmAcuPerfAgrgCrtDvCd}
			                                 AND C.BASE_YM = #{baseYm}
			                                 AND C.OG_TP_CD = #{ogTpCd}
			                                 AND C.PERF_ATC_CD = 'W03P00112' -- 고정 (교육)
			                                 AND C.FEE_PERF_ATC_VAL = 'Y') -- 고정 (수료)
			           AND A.PRTNR_NO IN (SELECT D.PRTNR_NO
			                                FROM TB_FEAM_MACUP_PERF_CL D
			                               WHERE 1 = 1
			                                 AND D.MM_ACU_PERF_AGRG_CRT_DV_CD = #{mmAcuPerfAgrgCrtDvCd}
			                                 AND D.BASE_YM <![CDATA[<=]]> #{baseYm}
			                                 AND D.OG_TP_CD = #{ogTpCd}
			                                 AND D.PERF_ATC_CD = 'W03P00085' -- 서비스건수
			                                 AND D.PERF_DV_CD = '0'
			                               GROUP BY D.PRTNR_NO
			                              HAVING SUM(D.PERF_VAL) >= 20) /* 서비스 누적 실적 건수 20건 이상  */
              ) Z
    </insert>

</mapper>
