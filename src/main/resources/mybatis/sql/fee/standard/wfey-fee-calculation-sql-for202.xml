<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.standard.mapper.WfeyFeeCalculationSqlFor202Mapper">

    <insert id='insertOrganizationEjectFee'>
        INSERT INTO TB_FEAM_FEE_CALC_BAS (  /* 수수료계산계약상세내역 */
                                                  BASE_YM            /* 기준년월 */
                                                , PERF_YM            /* 실적년월 */
                                                , OJ_DSB_YM          /* 대상지급년월 */
                                                , CO_CD              /* 회사코드 */
                                                , OG_TP_CD           /* 조직유형코드 */
                                                , PRTNR_NO           /* 파트너번호 */
                                                , FEE_CD             /* 수수료코드 */
                                                , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
                                                , FEE_TCNT_DV_CD     /* 수수료차수구분코드 */
                                                , SPMT_DSB_DV_CD     /* 추가지급구분코드 */
                                                , FEE_CALC_TP_CD     /* 수수료계산유형코드 */
                                                , FEE_CALC_AMT       /* 수수료계산금액 */
                                                , FEE_CTR_CNFM_AMT   /* 수수료조정확정금액 */
                                                , FNL_FEE_YN         /* 최종수수료여부 */
                                                <include refid="COMMON.insertSystemField" />)
        SELECT AA.BASE_YM
             , AA.BASE_YM         AS PERF_YM
             , AA.BASE_YM         AS OJ_DSB_YM
             , #{coCd}             AS CO_CD
             , AA.OG_TP_CD
             , AA.PRTNR_NO
             , #{feeCd}          AS FEE_CD
             , #{dtaCrtFeeCd}          AS DTA_CRT_FEE_CD
             , AA.FEE_TCNT_DV_CD
             , '01'               AS SPMT_DSB_DV_CD -- 추후 확인 필요 01/정상지급, 02/추가지급
             , '01'               AS FEE_CALC_TP_CD -- 01 / 수수료계산
             , SUM(AA.AMT_AKSD09) AS FEE_CALC_AMT
             , SUM(AA.AMT_AKSD09) AS FEE_CTR_CNFM_AMT
             , #{fnlFeeYn}        AS FNL_FEE_YN
        <include refid="COMMON.insertSystemFieldValue" />
          FROM (SELECT A.BASE_YM
                     , #{feeTcntDvCd}                             AS FEE_TCNT_DV_CD      -- 수수료차수(변수)
                     , A.OG_TP_CD
                     , A.PRTNR_NO
                     , NVL(B.PERF_VAL, 0)               AS CNT_DEQ00           -- 인정건수
                     , NVL(C.BASE_PRTNR_NO, ' ')                               -- 배출자사번
                     , NVL(C.OJ_PRTNR_PSTN_DV_CD, '99') AS OJ_PRTNR_PSTN_DV_CD -- 피배출자 직급
                     , NVL(C.EJT_NMN_N, 99)             AS EJT_NMN_N           -- 피배출자 차월수
                     , NVL(C.OG_EJT_GD_CD, '99')        AS OG_EJT_GD_CD        -- 배출등급   1,6 : 신규    4,7 : 경력
                     , CASE
                           WHEN NVL(C.OJ_PRTNR_PSTN_DV_CD, '99') IN ('6', '7') THEN ( -- 피배출자 직급이 6,7인 경우만 집계
                               CASE
                                   WHEN NVL(C.OG_EJT_GD_CD, '99') IN ('1', '6') THEN ( -- 배출등급 신규
                                       CASE
                                           WHEN NVL(C.EJT_NMN_N, 99) = 1 AND NVL(B.PERF_VAL, 0) >= 30 THEN 1000000 -- 1차월
                                           WHEN NVL(C.EJT_NMN_N, 99) = 1 AND NVL(B.PERF_VAL, 0) >= 20 THEN 800000
                                           WHEN NVL(C.EJT_NMN_N, 99) = 2 AND NVL(B.PERF_VAL, 0) >= 30 THEN 800000 -- 2차월
                                           WHEN NVL(C.EJT_NMN_N, 99) = 2 AND NVL(B.PERF_VAL, 0) >= 20 THEN 600000
                                           WHEN NVL(C.EJT_NMN_N, 99) = 3 AND NVL(B.PERF_VAL, 0) >= 30 THEN 700000 -- 3차월
                                           WHEN NVL(C.EJT_NMN_N, 99) = 3 AND NVL(B.PERF_VAL, 0) >= 20 THEN 500000
                                           WHEN NVL(C.EJT_NMN_N, 99) IN (4, 5, 6) AND NVL(B.PERF_VAL, 0) >= 30
                                               THEN 500000 -- 4,5,6차월
                                           WHEN NVL(C.EJT_NMN_N, 99) IN (4, 5, 6) AND NVL(B.PERF_VAL, 0) >= 20 THEN 300000
                                           ELSE 0 END)
                                   WHEN NVL(C.OG_EJT_GD_CD, '99') IN ('4', '7') THEN ( -- 배출등급 경력
                                       CASE
                                           WHEN NVL(C.EJT_NMN_N, 99) IN (1, 2, 3, 4, 5, 6) AND NVL(B.PERF_VAL, 0) >= 30
                                               THEN 500000
                                           WHEN NVL(C.EJT_NMN_N, 99) IN (1, 2, 3, 4, 5, 6) AND NVL(B.PERF_VAL, 0) >= 20
                                               THEN 300000
                                           ELSE 0 END)
                                   ELSE 0 END)
                           ELSE 0 END                   AS AMT_AKSD09
                  FROM TB_OGBS_MM_PRTNR_IZ A -- 파트너
                       LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL B -- 순주문실적
                                       ON A.BASE_YM = B.BASE_YM
                                           AND A.BASE_YM = B.PERF_YM
                                           AND '02' = B.FEE_TCNT_DV_CD -- 수수료차수(변수)
                                           AND A.OG_TP_CD = B.OG_TP_CD
                                           AND A.PRTNR_NO = B.PRTNR_NO
                                           AND 'W02P00002' = B.PERF_ATC_CD --  실적건수(고정)
                                           AND '2' = B.PERF_DV_CD -- 지점장 집계
                       LEFT OUTER JOIN TB_OGPS_PRTNR_EJT_REL C -- 배출-조직
                                       ON A.BASE_YM = C.MNGT_YM
                                           AND A.OG_TP_CD = C.BASE_OG_TP_CD
                                           AND A.PRTNR_NO = C.BASE_PRTNR_NO
                                           AND '10' = C.OG_EJT_DV_CD -- 피배출자
                                           AND 'Y' = C.ACKMT_YN -- 인정여부
                 WHERE 1 = 1
                   AND A.BASE_YM = #{baseYm}
                   AND A.OG_TP_CD = #{ogTpCd}
                   AND A.PSTN_DV_CD = 7) AA
         GROUP BY AA.BASE_YM
                , AA.OG_TP_CD
                , AA.PRTNR_NO
                , AA.FEE_TCNT_DV_CD
        HAVING SUM(AA.AMT_AKSD09) > 0
    </insert>

    <insert id="insertNewEstablishmentBranchFee">
        INSERT INTO TB_FEAM_FEE_CALC_BAS (  /* 수수료계산기본 */
               BASE_YM            /* 기준년월 */
             , PERF_YM            /* 실적년월 */
             , OJ_DSB_YM          /* 대상지급년월 */
             , CO_CD              /* 회사코드 */
             , OG_TP_CD           /* 조직유형코드 */
             , PRTNR_NO           /* 파트너번호 */
             , FEE_CD             /* 수수료코드 */
             , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
             , FEE_TCNT_DV_CD     /* 수수료차수구분코드 */
             , SPMT_DSB_DV_CD     /* 추가지급구분코드 */
             , FEE_CALC_TP_CD     /* 수수료계산유형코드 */
             , FEE_CALC_AMT       /* 수수료계산금액 */
             , FEE_CTR_CNFM_AMT   /* 수수료조정확정금액 */
             , FNL_FEE_YN         /* 최종수수료여부 */
             <include refid="COMMON.insertSystemField" />)
        /*
         * 신설지점 수수료
         *  - 피배출자 지점장에게 지급함
         *  - 수수료 정책이 바뀌어도 배출된 년월 기준으로 수수료 정책이 적용됨.
         *  - 오픈시 23년 4월 정책만 적용하면 됨.
         *  - 추후 정책이 바뀌면  TB_OGPS_PRTNR_EJT_REL.EJT_YM (배출년월) 기준으로 정책이 적용되어야 함.
         *  - 현재는 TB_OGPS_PRTNR_EJT_REL.EJT_YM 상관없이 SQL 반영되어 있음. ( 23년 4월 수수료 규정에 "기존 승진자 해당 기준 적용" 문구 때문 )
         *  - 23년 4월 수수료 규정의 "23년 한정 제도"는 수작업 관리하므로 계산식에 제외함. - 시스템 운영자 확인 완료
         * */
        SELECT AA.BASE_YM
             , AA.PERF_YM
             , AA.OJ_DSB_YM
             , AA.CO_CD
             , AA.OG_TP_CD
             , AA.PRTNR_NO
             , AA.FEE_CD
             , AA.DTA_CRT_FEE_CD
             , AA.FEE_TCNT_DV_CD
             , AA.SPMT_DSB_DV_CD
             , AA.FEE_CALC_TP_CD
             , AA.FEE_CALC_AMT
             , AA.FEE_CALC_AMT AS FEE_CTR_CNFM_AMT
             , AA.FNL_FEE_YN AS FNL_FEE_YN
        <include refid="COMMON.insertSystemFieldValue" />
          FROM (SELECT A.BASE_YM
                     , A.BASE_YM                 AS PERF_YM
                     , A.BASE_YM                 AS OJ_DSB_YM
                     , #{coCd}                    AS CO_CD
                     , A.OG_TP_CD
                     , A.PRTNR_NO
                     , #{feeCd}                 AS FEE_CD
                     , #{dtaCrtFeeCd}                 AS DTA_CRT_FEE_CD
                     , #{feeTcntDvCd}                     AS FEE_TCNT_DV_CD -- 수수료차수(변수)
                     , '01'                      AS SPMT_DSB_DV_CD -- 추후 확인 필요 01/정상지급, 02/추가지급
                     , '01'                      AS FEE_CALC_TP_CD -- 01 / 수수료계산
                     , NVL(B.PERF_VAL, 0)        AS CNT_DEQ00      -- 인정건수
                     , NVL(C.OG_EJT_GD_CD, '99') AS OG_EJT_GD_CD
                     , CASE
                           WHEN NVL(C.EJT_NMN_N, 99) = 1 AND NVL(B.PERF_VAL, 0) >= 30 THEN 700000 -- 1차월
                           WHEN NVL(C.EJT_NMN_N, 99) = 1 AND NVL(B.PERF_VAL, 0) >= 20 THEN 600000
                           WHEN NVL(C.EJT_NMN_N, 99) = 2 AND NVL(B.PERF_VAL, 0) >= 30 THEN 600000 -- 2차월
                           WHEN NVL(C.EJT_NMN_N, 99) = 2 AND NVL(B.PERF_VAL, 0) >= 20 THEN 500000
                           WHEN NVL(C.EJT_NMN_N, 99) = 3 AND NVL(B.PERF_VAL, 0) >= 30 THEN 500000 -- 3차월
                           WHEN NVL(C.EJT_NMN_N, 99) = 3 AND NVL(B.PERF_VAL, 0) >= 20 THEN 400000
                           WHEN NVL(C.EJT_NMN_N, 99) IN (4, 5, 6) AND NVL(B.PERF_VAL, 0) >= 30 THEN 400000 -- 4,5,6차월
                           WHEN NVL(C.EJT_NMN_N, 99) IN (4, 5, 6) AND NVL(B.PERF_VAL, 0) >= 20 THEN 300000
                           ELSE 0 END            AS FEE_CALC_AMT
                     , #{fnlFeeYn} AS FNL_FEE_YN
                  FROM TB_OGBS_MM_PRTNR_IZ A -- 파트너
                       LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL B -- 순주문실적
                                       ON A.BASE_YM = B.BASE_YM
                                           AND A.BASE_YM = B.PERF_YM
                                           AND B.FEE_TCNT_DV_CD = #{feeTcntDvCd}
                                           AND A.OG_TP_CD = B.OG_TP_CD
                                           AND A.PRTNR_NO = B.PRTNR_NO
                                           AND B.PERF_ATC_CD = 'W02P00002'
                                           AND '2' = B.PERF_DV_CD -- 지점장 집계
                       LEFT OUTER JOIN TB_OGPS_PRTNR_EJT_REL C -- 배출-조직
                                       ON A.BASE_YM = C.MNGT_YM
                                           AND A.OG_TP_CD = C.OJ_OG_TP_CD -- 피배출자
                                           AND A.PRTNR_NO = C.OJ_PRTNR_NO -- 피배출자
                                           AND '10' = C.OG_EJT_DV_CD -- 피배출자
                                           AND 'Y' = C.ACKMT_YN -- 인정여부
                 WHERE 1 = 1
                   AND A.BASE_YM = #{baseYm}
                   AND A.OG_TP_CD = #{ogTpCd}
                   AND A.PSTN_DV_CD = '7'
                   AND A.PERF_EXCD_OJ_YN = 'N') AA
         WHERE 1 = 1
           AND AA.FEE_CALC_AMT > 0
    </insert>

    <insert id="insertNetIncreseManagementFee">
        INSERT INTO TB_FEAM_FEE_CALC_BAS (  /* 수수료계산기본 */
               BASE_YM            /* 기준년월 */
             , PERF_YM            /* 실적년월 */
             , OJ_DSB_YM          /* 대상지급년월 */
             , CO_CD              /* 회사코드 */
             , OG_TP_CD           /* 조직유형코드 */
             , PRTNR_NO           /* 파트너번호 */
             , FEE_CD             /* 수수료코드 */
             , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
             , FEE_TCNT_DV_CD     /* 수수료차수구분코드 */
             , SPMT_DSB_DV_CD     /* 추가지급구분코드 */
             , FEE_CALC_TP_CD     /* 수수료계산유형코드 */
             , FEE_CALC_AMT       /* 수수료계산금액 */
             , FEE_CTR_CNFM_AMT   /* 수수료조정확정금액 */
             , FNL_FEE_YN         /* 최종수수료여부 */
             <include refid="COMMON.insertSystemField" />)
        SELECT ZZZ.BASE_YM               AS BASE_YM
              ,ZZZ.BASE_YM               AS PERF_YM
              ,ZZZ.BASE_YM               AS OJ_DSB_YM
              ,#{ogTpCd}                    AS CO_CD
              ,ZZZ.OG_TP_CD              AS OG_TP_CD
              ,ZZZ.PRTNR_NO              AS PRTNR_NO
              ,#{feeCd}                 AS FEE_CD
              ,#{dtaCrtFeeCd}                 AS DTA_CRT_FEE_CD
              ,#{feeTcntDvCd}                      AS FEE_TCNT_DV_CD        -- 수수료차수(변수)
              ,'01'                      AS SPMT_DSB_DV_CD        -- 추후 확인 필요 01/정상지급, 02/추가지급
              ,'01'                      AS FEE_CALC_TP_CD        -- 01 / 수수료계산
              ,ZZZ.FEE_CALC_AMT          AS FEE_CALC_AMT
              ,ZZZ.FEE_CALC_AMT          AS FEE_CTR_CNFM_AMT
              , #{fnlFeeYn} AS FNL_FEE_YN
            <include refid="COMMON.insertSystemFieldValue" />
          FROM (
           SELECT ZZ.BASE_YM
                 ,ZZ.OG_TP_CD
                 ,ZZ.PRTNR_NO
                 , TRUNC(CASE WHEN ZZ.AB80_CNT >= ZZ.KIZUN_CNT THEN /* 실활동 인원이 기준인원수 보다 큰 경우  */
                                                              CASE WHEN LINK_DEQ02 >= 20  THEN DEQ2_CNT * 3000     /* 순증 급간으로 BS건수 활용 수수료 계산   */
                                                                   WHEN LINK_DEQ02 >= 15  THEN DEQ2_CNT * 2400
                                                                   WHEN LINK_DEQ02 >= 10  THEN DEQ2_CNT * 1800
                                                                   WHEN LINK_DEQ02 >= 5   THEN DEQ2_CNT * 1400
                                                                   WHEN LINK_DEQ02 >= 0   THEN DEQ2_CNT * 1000
                                                                   WHEN LINK_DEQ02 >= -5  THEN DEQ2_CNT * 800
                                                                   WHEN LINK_DEQ02 >= -10 THEN DEQ2_CNT * 700
                                                                   WHEN LINK_DEQ02 >= -15 THEN DEQ2_CNT * 600
                                                                                          ELSE DEQ2_CNT * 500  END
                        ELSE 0 END
                     *  /* 곱하기  */
                      CASE WHEN  LINK_DEQ03 <![CDATA[<]]> 90     THEN 0.9         /* 지점 BS 처리율로 곱하기 처리 */
                           WHEN  LINK_DEQ03 <![CDATA[<]]> 95     THEN 0.95
                                                     ELSE 1 END
                     - /* 빼기 */
                      ( ZZ.LC56_CNT * 50000 ))    /* 허위발생 대상 웰스매니저 수  */
                      AS  FEE_CALC_AMT           /*허위가 많으면 ""0""보자 작을 수도 있음.   */
             FROM (
             SELECT AA.BASE_YM
                   ,AA.OG_TP_CD
                   ,AA.PRTNR_NO
                   ,AA.AB80_CNT  /* 실활동인원수  */
                   ,AA.LINK_DEQ02   /* 순증건수  */
                   ,AA.LINK_DEQ03    /* 지점처리율  */
                   ,CASE WHEN AA.AKDRIS <![CDATA[<=]]> 6 THEN 2 ELSE 3 END  AS KIZUN_CNT                          /* 실활동 기준건수 - 진급계월수 기준으로   */
                   ,CASE WHEN AA.CNT_BS > AA.CNT_SIL THEN AA.CNT_SIL ELSE AA.CNT_BS END AS DEQ2_CNT   /* 수수료 지급 BS 건수 - 무조건 1,200 건이 max 가 되게... */
                   ,BB.LC56_CNT                                                                       /* 지점내 허위방문 웰스매니저 수 */
               FROM (
                SELECT A.BASE_YM
                      ,A.OG_TP_CD
                      ,A.PRTNR_NO
                      ,NVL(B.PERF_VAL,0)  AS AB80_CNT
                      ,CASE WHEN  NVL(B.PERF_VAL,0)*180  > 1200 THEN 1200 ELSE NVL(B.PERF_VAL,0)*180 END  AS CNT_SIL
                      ,NVL(C.PERF_VAL,0) - NVL(D.PERF_VAL,0)   AS CNT_BS /* 지점  BS  건수 ( 지점장님 본인 건 제외 )    */
                      ,A.PRFMT_DT
                      ,MONTHS_BETWEEN( TO_DATE(A.BASE_YM||'01','YYYYMMDD'),TO_DATE(NVL(SUBSTR(A.PRFMT_DT,1,6),A.BASE_YM)||'01','YYYYMMDD') ) + 1    AS AKDRIS /* 승진개월수 */
                      ,NVL(E.PERF_VAL,0)  AS LINK_DEQ03    /* 지점처리율  */
                      ,NVL(F.PERF_VAL,0)  AS LINK_DEQ02   /* 순증건수  */
                  FROM TB_OGBS_MM_PRTNR_IZ A  /* M조직 기본   */
                       LEFT OUTER JOIN TB_FEAM_PRTNR_PERF_MM_CL B
                               ON  A.BASE_YM  = B.BASE_YM
                              AND  A.BASE_YM  = B.PERF_YM
                              AND  #{feeTcntDvCd}       = B.FEE_TCNT_DV_CD     -- 변수(차수)
                              AND  A.OG_TP_CD = B.OG_TP_CD
                              AND  A.PRTNR_NO = B.PRTNR_NO
                              AND  'W02P00111'= B.PERF_ATC_CD        -- 고정 실활동인원
                       LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL C
                               ON  A.BASE_YM  = C.BASE_YM
                              AND  A.BASE_YM  = C.PERF_YM
                              AND  #{feeTcntDvCd}       = C.FEE_TCNT_DV_CD     -- 변수(차수)
                              AND  A.OG_TP_CD = C.OG_TP_CD
                              AND  A.PRTNR_NO = C.PRTNR_NO
                              AND  'W02P00085'= C.PERF_ATC_CD        -- 고정 BS건수
                              AND  '2'        = C.PERF_DV_CD         -- 고정 조직실적
                       LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL D
                               ON  A.BASE_YM  = D.BASE_YM
                              AND  A.BASE_YM  = D.PERF_YM
                              AND  #{feeTcntDvCd}       = D.FEE_TCNT_DV_CD     -- 변수(차수)
                              AND  A.OG_TP_CD = D.OG_TP_CD
                              AND  A.PRTNR_NO = D.PRTNR_NO
                              AND  'W02P00085'= D.PERF_ATC_CD        -- 고정 BS건수
                              AND  '0'        = D.PERF_DV_CD         -- 고정 개인실적(지점장)
                       LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL E
                               ON  A.BASE_YM  = E.BASE_YM
                              AND  A.BASE_YM  = E.PERF_YM
                              AND  #{feeTcntDvCd}       = E.FEE_TCNT_DV_CD     -- 변수(차수)
                              AND  A.OG_TP_CD = E.OG_TP_CD
                              AND  A.PRTNR_NO = E.PRTNR_NO
                              AND  'W02P00114'= E.PERF_ATC_CD        -- 고정 지점BS처리율
                              AND  '2'        = E.PERF_DV_CD         -- 고정 조직실적
                       LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL F
                               ON  A.BASE_YM  = F.BASE_YM
                              AND  A.BASE_YM  = F.PERF_YM
                              AND  #{feeTcntDvCd}       = F.FEE_TCNT_DV_CD     -- 변수(차수)
                              AND  A.OG_TP_CD = F.OG_TP_CD
                              AND  A.PRTNR_NO = F.PRTNR_NO
                              AND  'W02P00113'= F.PERF_ATC_CD        -- 고정 순증
                              AND  '2'        = F.PERF_DV_CD         -- 고정 조직실적
                 WHERE 1 = 1
                   AND A.BASE_YM    = #{baseYm}                       -- 변수
                   AND A.OG_TP_CD   = #{ogTpCd}                          -- 변수
                   AND A.PSTN_DV_CD = '7'
                  ) AA
                  JOIN (
                SELECT M.BASE_YM
                      ,M.OG_TP_CD
                      ,M.PRTNR_NO         /* 지점장님  */
                      ,SUM(CASE WHEN NVL(P.PERF_VAL,0) > 0 THEN 1 ELSE 0 END)  AS LC56_CNT /* 허위방문 이력이 있는 매니저 수  */
                  FROM TB_OGBS_MM_OG_IZ L
                       JOIN TB_OGBS_MM_PRTNR_IZ M   /* 지점장님  */
                       ON  L.BASE_YM = M.BASE_YM
                       AND L.OG_ID   = M.OG_ID
                       AND '7'       = M.PSTN_DV_CD
                       JOIN TB_OGBS_MM_PRTNR_IZ N  /* 지점장님 포함 하위 웰스매니저  */
                       ON  L.BASE_YM = N.BASE_YM
                       AND L.OG_ID   = N.OG_ID
                       LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL P
                       ON  N.BASE_YM  = P.BASE_YM
                       AND N.BASE_YM  = P.PERF_YM
                       AND #{feeTcntDvCd}       = P.FEE_TCNT_DV_CD     -- 변수(차수)
                       AND N.OG_TP_CD = P.OG_TP_CD
                    AND N.PRTNR_NO = P.PRTNR_NO
                    AND 'W02P00097'= P.PERF_ATC_CD        -- 허위방문건수
                    AND '0'        = P.PERF_DV_CD         -- 고정 판매자개인
                    AND N.PSTN_DV_CD IN ('7','15')
                 WHERE 1 = 1
                   AND L.BASE_YM    = #{baseYm}                       -- 변수
                   AND L.OG_TP_CD   = #{feeTcntDvCd}                          -- 변수
                GROUP BY M.BASE_YM, M.OG_TP_CD, M.PRTNR_NO
                  ) BB
                  ON  AA.BASE_YM   = BB.BASE_YM
                     AND AA.OG_TP_CD  = BB.OG_TP_CD
                     AND AA.PRTNR_NO  = BB.PRTNR_NO
                ) ZZ
              ) ZZZ
        WHERE 1 = 1
          AND ZZZ.FEE_CALC_AMT > 0
    </insert>

    <insert id="insertBsEncouragementFeeForBrmgr">
        /* BS장려(지점장)수수료(W020123) 계산 SQL (소스 : LC56U111, 컬럼 : AKSD41) */
        INSERT INTO TB_FEAM_FEE_CALC_BAS (  /* 수수료계산계약상세내역 */
                                                  BASE_YM            /* 기준년월 */
                                                , PERF_YM            /* 실적년월 */
                                                , OJ_DSB_YM          /* 대상지급년월 */
                                                , CO_CD              /* 회사코드 */
                                                , OG_TP_CD           /* 조직유형코드 */
                                                , PRTNR_NO           /* 파트너번호 */
                                                , FEE_CD             /* 수수료코드 */
                                                , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
                                                , FEE_TCNT_DV_CD     /* 수수료차수구분코드 */
                                                , SPMT_DSB_DV_CD     /* 추가지급구분코드 */
                                                , FEE_CALC_TP_CD     /* 수수료계산유형코드 */
                                                , FEE_CALC_AMT       /* 수수료계산금액 */
                                                , FEE_CTR_CNFM_AMT   /* 수수료조정확정금액 */
                                                , FNL_FEE_YN         /* 최종수수료여부 */
                                                <include refid="COMMON.insertSystemField" />)
        SELECT AAA.BASE_YM
             , AAA.BASE_YM      AS PERF_YM
             , AAA.BASE_YM      AS OJ_DSB_YM
             , #{coCd}           AS CO_CD
             , AAA.OG_TP_CD
             , AAA.PRTNR_NO
             , #{feeCd}        AS FEE_CD
             , #{dtaCrtFeeCd}        AS DTA_CRT_FEE_CD
             , #{feeTcntDvCd}             AS FEE_TCNT_DV_CD -- 수수료차수(변수)
             , '01'             AS SPMT_DSB_DV_CD -- 추후 확인 필요 01/정상지급, 02/추가지급
             , '01'             AS FEE_CALC_TP_CD -- 01 / 수수료계산
             , AAA.FEE_CALC_AMT
             , AAA.FEE_CALC_AMT AS FEE_CTR_CNFM_AMT
             , #{fnlFeeYn}      AS FNL_FEE_YN
        <include refid="COMMON.insertSystemFieldValue" />
          FROM (SELECT AA.BASE_YM
                     , AA.OG_TP_CD
                     , AA.PRTNR_NO
                     , TRUNC(
                          CASE
                              WHEN AA.TXT_BIGO = 'A' THEN AA.CNT_BS_UNDER * 4000 + CNT_BS_OVER * 2500
                              WHEN AA.TXT_BIGO = 'B' THEN AA.CNT_BS_UNDER * 3800 + CNT_BS_OVER * 2200
                              WHEN AA.TXT_BIGO = 'C' THEN AA.CNT_BS_UNDER * 3500 + CNT_BS_OVER * 2000
                              WHEN AA.TXT_BIGO = 'D' THEN AA.CNT_BS_UNDER * 2800 + CNT_BS_OVER * 1500
                              WHEN AA.TXT_BIGO = 'E' THEN AA.CNT_BS_UNDER * 2000 + CNT_BS_OVER * 900
                              WHEN AA.TXT_BIGO = 'F' THEN AA.CNT_BS_UNDER * 1200 + CNT_BS_OVER * 700
                              WHEN AA.TXT_BIGO = 'G' THEN AA.CNT_BS_UNDER * 500 + CNT_BS_OVER * 300
                              WHEN AA.TXT_BIGO = 'H' THEN AA.CNT_BS_UNDER * 200
                              ELSE 0 END * CNT_RATE * CNT_RATE_JIJUM
                  ) AS FEE_CALC_AMT
                  FROM (SELECT A.BASE_YM
                             , A.OG_TP_CD
                             , A.PRTNR_NO
                             , NVL(B.PERF_VAL, 0)                                                                            AS CNT_SUNZEON    -- 순증건수
                             , NVL(C.PERF_VAL, 0)                                                                            AS CNT_FSVST      -- 허위방문건수
                             , NVL(D.PERF_VAL, 0)                                                                            AS CNT_BS         -- BS건수
                             , NVL(E.PERF_VAL, 0)                                                                            AS CNT_PAN        -- 가전(판매)건수
                             , MONTHS_BETWEEN(TO_DATE(A.BASE_YM || '01', 'YYYYMMDD'),
                                              TO_DATE(SUBSTR(NVL(A.RCNTR_DT, A.FST_CNTR_DT), 1, 6) || '01', 'YYYYMMDD')) +
                               1                                                                                             AS CNT_MON
                             , CASE
                                   WHEN NVL(D.PERF_VAL, 0) >= 250 THEN 250
                                   ELSE NVL(D.PERF_VAL, 0) END                                                               AS CNT_BS_UNDER
                             , CASE
                                   WHEN NVL(D.PERF_VAL, 0) >= 250 THEN NVL(D.PERF_VAL, 0) - 250
                                   ELSE 0 END                                                                                AS CNT_BS_OVER
                             , CASE
                                   WHEN NVL(E.PERF_VAL, 0) >= 20 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 2 THEN 'A' -- 20건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 20 AND NVL(C.PERF_VAL, 0) >= 2 THEN 'B' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 15 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 2 THEN 'B' -- 15건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 15 AND NVL(C.PERF_VAL, 0) >= 2 THEN 'C' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 12 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 2 THEN 'C' -- 12건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 12 AND NVL(C.PERF_VAL, 0) >= 2 THEN 'D' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 10 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 2 THEN 'D' -- 10건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 10 AND NVL(C.PERF_VAL, 0) >= 2 THEN 'E' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 8 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 2 THEN 'E' -- 8건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 8 AND NVL(C.PERF_VAL, 0) >= 2 THEN 'F' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 6 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 2 THEN 'F' -- 6건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 6 AND NVL(C.PERF_VAL, 0) >= 2 THEN 'G' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 4 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 2 THEN 'G' -- 4건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 4 AND NVL(C.PERF_VAL, 0) >= 2 THEN 'H' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 2 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 2 THEN 'H' -- 2건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 2 AND NVL(C.PERF_VAL, 0) >= 2 THEN 'I' -- 한칸 하위
                                   ELSE 'I' END                                                                              AS TXT_BIGO
                             , CASE
                                   WHEN MONTHS_BETWEEN(TO_DATE(A.BASE_YM || '01', 'YYYYMMDD'),
                                                       TO_DATE(SUBSTR(NVL(A.RCNTR_DT, A.FST_CNTR_DT), 1, 6) || '01',
                                                               'YYYYMMDD')) + 1 <![CDATA[<=]]> 6 THEN 1
                                   ELSE (CASE
                                             WHEN NVL(B.PERF_VAL, 0) >= 2 THEN 1.1
                                             WHEN NVL(B.PERF_VAL, 0) >= 0 THEN 1
                                             WHEN NVL(B.PERF_VAL, 0) >= -2 THEN 0.9
                                             ELSE 0.8 END)
                          END                                                                                                AS CNT_RATE
                             , CASE
                                   WHEN NVL(D.PERF_VAL, 0) >= 120 THEN 0.7
                                   ELSE 1 END                                                                                AS CNT_RATE_JIJUM -- 지점장 전용 추가 RATE
                          FROM TB_OGBS_MM_PRTNR_IZ A /* M조직 기본   */
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL B
                                               ON A.BASE_YM = B.BASE_YM
                                                   AND A.BASE_YM = B.PERF_YM
                                                   AND #{feeTcntDvCd} = B.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = B.OG_TP_CD
                                                   AND A.PRTNR_NO = B.PRTNR_NO
                                                   AND 'W02P00113' = B.PERF_ATC_CD -- 순증
                                                   AND '0' = B.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL C
                                               ON A.BASE_YM = C.BASE_YM
                                                   AND A.BASE_YM = C.PERF_YM
                                                   AND #{feeTcntDvCd} = C.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = C.OG_TP_CD
                                                   AND A.PRTNR_NO = C.PRTNR_NO
                                                   AND 'W02P00097' = C.PERF_ATC_CD -- 허위방문
                                                   AND '0' = C.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL D
                                               ON A.BASE_YM = D.BASE_YM
                                                   AND A.BASE_YM = D.PERF_YM
                                                   AND #{feeTcntDvCd} = D.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = D.OG_TP_CD
                                                   AND A.PRTNR_NO = D.PRTNR_NO
                                                   AND 'W02P00085' = D.PERF_ATC_CD -- 고정 BS건수
                                                   AND '0' = D.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL E
                                               ON A.BASE_YM = E.BASE_YM
                                                   AND A.BASE_YM = E.PERF_YM
                                                   AND #{feeTcntDvCd} = E.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = E.OG_TP_CD
                                                   AND A.PRTNR_NO = E.PRTNR_NO
                                                   AND 'W02P00002' = E.PERF_ATC_CD -- 고정 판매건수
                                                   AND '0' = E.PERF_DV_CD -- 고정 개인실적
                         WHERE 1 = 1
                           AND A.BASE_YM = #{baseYm} -- 변수
                           AND A.OG_TP_CD = #{ogTpCd}   -- 변수
                           AND A.PSTN_DV_CD = '7') AA) AAA
         WHERE AAA.FEE_CALC_AMT > 0
    </insert>
</mapper>
