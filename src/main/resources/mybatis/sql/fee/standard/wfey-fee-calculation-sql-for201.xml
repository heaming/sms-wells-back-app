<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.standard.mapper.WfeyFeeCalculationSqlFor201Mapper">

    <insert id='insertBsEncouragementFeeForSeller'>
        /* BS장려(판매자)수수료(W020122) 계산 SQL (소스 : LC56U111, 컬럼 : AKSD41) */
        INSERT INTO TB_FEAM_FEE_CALC_BAS (  /* 수수료계산계약상세내역 */
                                                  BASE_YM            /* 기준년월 */
                                                , PERF_YM            /* 실적년월 */
                                                , OJ_DSB_YM          /* 대상지급년월 */
                                                , CO_CD              /* 회사코드 */
                                                , OG_TP_CD           /* 조직유형코드 */
                                                , PRTNR_NO           /* 파트너번호 */
                                                , FEE_CD             /* 수수료코드 */
                                                , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
                                                , FEE_TCNT_DV_CD     /* 수수료차수구분코드 */
                                                , SPMT_DSB_DV_CD     /* 추가지급구분코드 */
                                                , FEE_CALC_TP_CD     /* 수수료계산유형코드 */
                                                , FEE_CALC_AMT       /* 수수료계산금액 */
                                                , FEE_CTR_CNFM_AMT   /* 수수료조정확정금액 */
                                                , FNL_FEE_YN         /* 최종수수료여부 */
                                                <include refid="COMMON.insertSystemField" />)
        SELECT AAA.BASE_YM
             , AAA.BASE_YM      AS PERF_YM
             , AAA.BASE_YM      AS OJ_DSB_YM
             , #{coCd}          AS CO_CD
             , AAA.OG_TP_CD
             , AAA.PRTNR_NO
             , #{feeCd}         AS FEE_CD
             , #{dtaCrtFeeCd}   AS DTA_CRT_FEE_CD
             , #{feeTcntDvCd}   AS FEE_TCNT_DV_CD -- 수수료차수(변수)
             , '01'             AS SPMT_DSB_DV_CD -- 추후 확인 필요 01/정상지급, 02/추가지급
             , '01'             AS FEE_CALC_TP_CD -- 01 / 수수료계산
             , AAA.FEE_CALC_AMT
             , AAA.FEE_CALC_AMT AS FEE_CTR_CNFM_AMT
             , #{fnlFeeYn}      AS FNL_FEE_YN
            <include refid="COMMON.insertSystemFieldValue" />
          FROM (SELECT AA.BASE_YM
                     , AA.OG_TP_CD
                     , AA.PRTNR_NO
                     , TRUNC(
                          CASE
                              WHEN AA.TXT_BIGO = 'A' THEN AA.CNT_BS_UNDER * 4000 + CNT_BS_OVER * 2500
                              WHEN AA.TXT_BIGO = 'B' THEN AA.CNT_BS_UNDER * 3800 + CNT_BS_OVER * 2200
                              WHEN AA.TXT_BIGO = 'C' THEN AA.CNT_BS_UNDER * 3500 + CNT_BS_OVER * 2000
                              WHEN AA.TXT_BIGO = 'D' THEN AA.CNT_BS_UNDER * 2800 + CNT_BS_OVER * 1500
                              WHEN AA.TXT_BIGO = 'E' THEN AA.CNT_BS_UNDER * 2000 + CNT_BS_OVER * 900
                              WHEN AA.TXT_BIGO = 'F' THEN AA.CNT_BS_UNDER * 1200 + CNT_BS_OVER * 700
                              WHEN AA.TXT_BIGO = 'G' THEN AA.CNT_BS_UNDER * 500 + CNT_BS_OVER * 300
                              WHEN AA.TXT_BIGO = 'H' THEN AA.CNT_BS_UNDER * 200
                              ELSE 0 END * CNT_RATE
                  ) AS FEE_CALC_AMT
                  FROM (SELECT A.BASE_YM
                             , A.OG_TP_CD
                             , A.PRTNR_NO
                             , NVL(B.PERF_VAL, 0)                                                                            AS CNT_SUNZEON -- 순증건수
                             , NVL(C.PERF_VAL, 0)                                                                            AS CNT_FSVST   -- 허위방문건수
                             , NVL(D.PERF_VAL, 0)                                                                            AS CNT_BS      -- BS건수
                             , NVL(E.PERF_VAL, 0)                                                                            AS CNT_PAN     -- 가전(판매)건수
                             , MONTHS_BETWEEN(TO_DATE(A.BASE_YM||'01','YYYYMMDD'),TO_DATE(NVL(F.STRTDT,A.BASE_YM||'01'),'YYYYMMDD')) + 1 AS CNT_MON
                             , CASE
                                   WHEN NVL(D.PERF_VAL, 0) >= 250 THEN 250
                                   ELSE NVL(D.PERF_VAL, 0) END                                                               AS CNT_BS_UNDER
                             , CASE
                                   WHEN NVL(D.PERF_VAL, 0) >= 250 THEN NVL(D.PERF_VAL, 0) - 250
                                   ELSE 0 END                                                                                AS CNT_BS_OVER
                             , CASE
                                   WHEN NVL(E.PERF_VAL, 0) >= 20 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'A' -- 20건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 20 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'B' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 15 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'B' -- 15건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 15 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'C' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 12 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'C' -- 12건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 12 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'D' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 10 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'D' -- 10건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 10 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'E' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 8 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'E' -- 8건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 8 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'F' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 6 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'F' -- 6건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 6 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'G' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 4 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'G' -- 4건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 4 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'H' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 2 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'H' -- 2건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 2 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'I' -- 한칸 하위
                                   ELSE 'I' END                                                                              AS TXT_BIGO
                             , CASE WHEN CEIL(MONTHS_BETWEEN(TO_DATE(A.BASE_YM||'01','YYYYMMDD'),TO_DATE(NVL(F.STRTDT,A.BASE_YM||'01'),'YYYYMMDD'))) + 1 <![CDATA[<= 6]]> THEN  1
                                   ELSE (CASE
                                             WHEN NVL(B.PERF_VAL, 0) >= 2 THEN 1.1
                                             WHEN NVL(B.PERF_VAL, 0) >= 0 THEN 1
                                             WHEN NVL(B.PERF_VAL, 0) >= -2 THEN 0.9
                                             ELSE 0.8 END)
                          END                                                                                                AS CNT_RATE
                          FROM TB_OGBS_MM_PRTNR_IZ A /* M조직 기본   */
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL B
                                               ON A.BASE_YM = B.BASE_YM
                                                   AND A.BASE_YM = B.PERF_YM
                                                   AND #{feeTcntDvCd} = B.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = B.OG_TP_CD
                                                   AND A.PRTNR_NO = B.PRTNR_NO
                                                   AND 'W02P00113' = B.PERF_ATC_CD -- 순증
                                                   AND '0' = B.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL C
                                               ON A.BASE_YM = C.BASE_YM
                                                   AND A.BASE_YM = C.PERF_YM
                                                   AND #{feeTcntDvCd} = C.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = C.OG_TP_CD
                                                   AND A.PRTNR_NO = C.PRTNR_NO
                                                   AND 'W02P00097' = C.PERF_ATC_CD -- 허위방문
                                                   AND '0' = C.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL D
                                               ON A.BASE_YM = D.BASE_YM
                                                   AND A.BASE_YM = D.PERF_YM
                                                   AND #{feeTcntDvCd} = D.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = D.OG_TP_CD
                                                   AND A.PRTNR_NO = D.PRTNR_NO
                                                   AND 'W02P00085' = D.PERF_ATC_CD -- 고정 BS건수
                                                   AND '0' = D.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL E
                                               ON A.BASE_YM = E.BASE_YM
                                                   AND A.BASE_YM = E.PERF_YM
                                                   AND #{feeTcntDvCd} = E.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = E.OG_TP_CD
                                                   AND A.PRTNR_NO = E.PRTNR_NO
                                                   AND 'W02P00002' = E.PERF_ATC_CD -- 고정 판매건수
                                                   AND '0' = E.PERF_DV_CD -- 고정 개인실적
                                LEFT OUTER JOIN (SELECT A.og_tp_Cd,A.prtnr_no ,CASE WHEN A.CV_DT IS NOT NULL THEN NVL(B.STRTDT,A.STRTDT) ELSE A.STRTDT END  AS STRTDT
                                                   FROM WSMDBS.TB_OGPS_PLAR_QLF_CH_IZ A
                                                   LEFT OUTER JOIN TB_OGPS_PLAR_QLF_CH_IZ B
                                                                ON  A.og_tp_Cd  = B.og_tp_Cd
                                                               AND  A.prtnr_no  = B.prtnr_no
                                                               AND  A.QLF_DV_CD = 3           /* BS프리매니저에서 웰스플래너로 바뀐 분들  */
                                                               AND  B.QLF_DV_CD = 6
                                                               AND  A.STRTDT = TO_CHAR(TO_DATE(B.ENDDT,'YYYYMMDD') + 1,'YYYYMMDD')
                                                               AND  B.ENDDT != '99991231'
                                                  WHERE 1 = 1
                                                   AND A.og_tp_Cd = #{ogTpCd}                               -- 변수
                                                   AND #{baseYm}||'01'  BETWEEN A.STRTDT AND A.ENDDT     -- 변수  기준년월 BASE_YM  = 202305
                                                   ) F
					                            ON  A.OG_TP_CD = F.OG_TP_CD AND  A.PRTNR_NO = F.PRTNR_NO
                         WHERE 1 = 1
                           AND A.BASE_YM = #{baseYm} -- 변수
                           AND A.OG_TP_CD = #{ogTpCd} -- 변수
                           AND A.PSTN_DV_CD = '15'
                           AND A.PERF_EXCD_OJ_YN = 'N') AA) AAA
         WHERE AAA.FEE_CALC_AMT > 0
    </insert>

    <insert id="insertUniformFeesForSeller">
        /****
        * 유니폼 재지급 대상 기준 : 수수료 기준년월 23년 2월 ( 23년 3월 집계 및 지급 ) 인 경우
          CASE 1.
                - 유니폼 신청일자가 22년8월1일 ~ 22년8월31일 이며, 최종 확정된 경우
                - 22년9월 ~ 23년2월까지 6개월간 매월 BS 실적 건수가 50계정 이상인 경우
                - 유니폼 신청 당시 활동물품 금액의 50% 수수료 생성
                - 수수료 기준년월 퇴직(예정)자 제외
          CASE 2.
                - 유니폼 신청일자가 22년2월1일 ~ 22년2월28일 이며, 최종 확정된 경우
                - 22년3월 ~ 23년2월까지 12개월간 매월 BS 실적 건수가 50계정 이상인 경우
                - 유니폼 신청 당시 활동물품 금액의 50% 수수료 생성
                - 수수료 기준년월 퇴직(예정)자 제외
        ****/
        INSERT INTO TB_FEAM_FEE_CALC_BAS (  /* 수수료계산기본 */
                                                  BASE_YM            /* 기준년월 */
                                                , PERF_YM            /* 실적년월 */
                                                , OJ_DSB_YM          /* 대상지급년월 */
                                                , CO_CD              /* 회사코드 */
                                                , OG_TP_CD           /* 조직유형코드 */
                                                , PRTNR_NO           /* 파트너번호 */
                                                , FEE_CD             /* 수수료코드 */
                                                , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
                                                , FEE_TCNT_DV_CD     /* 수수료차수구분코드 */
                                                , SPMT_DSB_DV_CD     /* 추가지급구분코드 */
                                                , FEE_CALC_TP_CD     /* 수수료계산유형코드 */
                                                , FEE_CALC_AMT       /* 수수료계산금액 */
                                                , FEE_CTR_CNFM_AMT   /* 수수료조정확정금액 */
                                                , FNL_FEE_YN         /* 최종수수료여부 */
                                                <include refid="COMMON.insertSystemField" />)
        SELECT MST.BASE_YM      AS BASE_YM
             , MST.BASE_YM      AS PERF_YM
             , MST.BASE_YM      AS OJ_DSB_YM
             , #{coCd}           AS CO_CD
             , MST.OG_TP_CD     AS OG_TP_CD
             , MST.PRTNR_NO     AS PRTNR_NO
             , #{feeCd}        AS FEE_CD
             , #{dtaCrtFeeCd}        AS DTA_CRT_FEE_CD
             , #{feeTcntDvCd}             AS FEE_TCNT_DV_CD -- 변수 FEE_TCNT_DV_CD
             , '01'             AS SPMT_DSB_DV_CD
             , '01'             AS FEE_CALC_TP_CD
             , SUM(MST.FEE_AMT) AS FEE_CALC_AMT
             , SUM(MST.FEE_AMT) AS FEE_CTR_CNFM_AMT
             , #{fnlFeeYn}      AS FNL_FEE_YN
            <include refid="COMMON.insertSystemFieldValue" />
          FROM ( --CASE 1. 6개월
              SELECT AAA.BASE_YM
                   , AAA.OG_TP_CD
                   , AAA.PRTNR_NO
                   , BBB.ACTI_GDS_APLC_ID
                   , BBB.FEE_AMT
                FROM (SELECT BB.BASE_YM
                           , AA.OG_TP_CD
                           , AA.PRTNR_NO
                           , BB.CLTN_DT
                           , SUM(CASE WHEN AA.PERF_VAL >= 50 THEN 1 ELSE 0 END) AS CNT_BS
                        FROM (SELECT A.BASE_YM, A.OG_TP_CD, A.PRTNR_NO, A.PERF_VAL
                                FROM TB_FEAM_NTORP_PERF_MM_CL A
                               WHERE 1 = 1
                                 AND A.BASE_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -5), 'YYYYMM') AND TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -1), 'YYYYMM') -- 지난 5개월   변수 BASE_YM
                                 AND A.FEE_TCNT_DV_CD = '02'                                                                                                                             -- 고정 지난 5개월은 2차수로 고정
                                 AND A.PERF_AGRG_CRT_DV_CD = '201'                                                                                                                       -- 수수료 집계
                                 AND A.PERF_ATC_CD = 'W02P00085'                                                                                                                         -- BS건수
                                 AND A.PERF_DV_CD = '0'                                                                                                                                  -- 개인
                               UNION ALL
                              SELECT A.BASE_YM, A.OG_TP_CD, A.PRTNR_NO, A.PERF_VAL
                                FROM TB_FEAM_NTORP_PERF_MM_CL A
                               WHERE 1 = 1
                                 AND A.BASE_YM = #{baseYm}          -- 당월   변수 BASE_YM
                                 AND A.FEE_TCNT_DV_CD = #{feeTcntDvCd}       -- 변수 FEE_TCNT_DV_CD
                                 AND A.PERF_AGRG_CRT_DV_CD = '201' -- 수수료 집계
                                 AND A.PERF_ATC_CD = 'W02P00085'   -- BS건수
                                 AND A.PERF_DV_CD = '0' -- 개인
                        ) AA
                             INNER JOIN TB_OGBS_MM_PRTNR_IZ BB
                                        ON BB.BASE_YM = #{baseYm} -- 당월   변수 BASE_YM
                                            AND BB.OG_TP_CD = 'W02'
                                            AND AA.OG_TP_CD = BB.OG_TP_CD
                                            AND AA.PRTNR_NO = BB.PRTNR_NO
                                            AND BB.PSTN_DV_CD = '15'
                       WHERE 1 = 1
                         AND BB.CLTN_DT IS NULL --퇴직자 제외
                       GROUP BY BB.BASE_YM, AA.OG_TP_CD, AA.PRTNR_NO, BB.CLTN_DT
                      HAVING SUM(CASE WHEN AA.PERF_VAL >= 50 THEN 1 ELSE 0 END) = 6 --6개월간 매월 bs 50건 이상
                ) AAA -- 6개월 BS 활동 만족
                   , (SELECT A.ACTI_GDS_APLC_ID -- 신청번호
                           , A.OG_TP_CD
                           , A.PRTNR_NO
                           , A.ACTI_GDS_CD
                           , A.ACTI_GDS_SN
                           , TRUNC(B.ACTI_GDS_AMT * A.APLC_QTY * 0.5) AS FEE_AMT
                        FROM TB_PSGA_ACTI_GDS_APLC_IZ A -- 활동물품신청내역
                             INNER JOIN TB_PSGA_ACTI_GDS_BAS B
                                        ON A.OG_TP_CD = B.OG_TP_CD
                                            AND A.ACTI_GDS_CD = B.ACTI_GDS_CD
                                            AND A.ACTI_GDS_SN = B.ACTI_GDS_SN
                       WHERE 1 = 1
                         AND A.ACTI_GDS_APLC_ID IN (SELECT DISTINCT AA.ACTI_GDS_APLC_ID
                                                      FROM (SELECT A.ACTI_GDS_APLC_ID
                                                                 , MAX(A.APLC_DT)               AS APLC_DT
                                                                 , MAX(A.ACTI_GDS_APLC_STAT_CD) AS ACTI_GDS_APLC_STAT_CD
                                                              FROM TB_PSGA_ACTI_GDS_APLC_STAT_IZ A
                                                             WHERE 1 = 1
                                                             GROUP BY A.ACTI_GDS_APLC_ID
                                                            HAVING MAX(A.ACTI_GDS_APLC_STAT_CD) = '01') AA
                                                           INNER JOIN (SELECT DISTINCT ACTI_GDS_APLC_ID FROM TB_PSGA_ACTI_GDS_DDTN_IZ) BB -- 공제 이력 존재
                                                                      ON AA.ACTI_GDS_APLC_ID = BB.ACTI_GDS_APLC_ID
                                                     WHERE 1 = 1
                                                       AND AA.APLC_DT LIKE
                                                           TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -6), 'YYYYMM') ||
                                                           '%' -- 당월   변수 BASE_YM
                       ) /* 6개월전 신청  */
                ) BBB -- 6개월전 유니폼 신청
               WHERE 1 = 1
                 AND AAA.OG_TP_CD = BBB.OG_TP_CD
                 AND AAA.PRTNR_NO = BBB.PRTNR_NO
               UNION ALL
              SELECT AAA.BASE_YM --CASE 2. 12개월
                   , AAA.OG_TP_CD
                   , AAA.PRTNR_NO
                   , BBB.ACTI_GDS_APLC_ID
                   , BBB.FEE_AMT
                FROM (SELECT BB.BASE_YM
                           , AA.OG_TP_CD
                           , AA.PRTNR_NO
                           , BB.CLTN_DT
                           , SUM(CASE WHEN AA.PERF_VAL >= 50 THEN 1 ELSE 0 END) AS CNT_BS
                        FROM (SELECT A.BASE_YM, A.OG_TP_CD, A.PRTNR_NO, A.PERF_VAL
                                FROM TB_FEAM_NTORP_PERF_MM_CL A
                               WHERE 1 = 1
                                 AND A.BASE_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -11), 'YYYYMM') AND TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -1), 'YYYYMM') -- 지난 11개월   변수 BASE_YM
                                 AND A.FEE_TCNT_DV_CD = '02'                                                                                                                              -- 고정 지난 5개월은 2차수로 고정
                                 AND A.PERF_AGRG_CRT_DV_CD = '201'                                                                                                                        -- 수수료 집계
                                 AND A.PERF_ATC_CD = 'W02P00085'                                                                                                                          -- BS건수
                                 AND A.PERF_DV_CD = '0'                                                                                                                                   -- 개인
                               UNION ALL
                              SELECT A.BASE_YM, A.OG_TP_CD, A.PRTNR_NO, A.PERF_VAL
                                FROM TB_FEAM_NTORP_PERF_MM_CL A
                               WHERE 1 = 1
                                 AND A.BASE_YM = #{baseYm}          -- 당월   변수 BASE_YM
                                 AND A.FEE_TCNT_DV_CD = #{feeTcntDvCd}      -- 변수 FEE_TCNT_DV_CD
                                 AND A.PERF_AGRG_CRT_DV_CD = '201' -- 수수료 집계
                                 AND A.PERF_ATC_CD = 'W02P00085'   -- BS건수
                                 AND A.PERF_DV_CD = '0' -- 개인
                        ) AA
                             INNER JOIN TB_OGBS_MM_PRTNR_IZ BB
                                        ON BB.BASE_YM = #{baseYm} -- 당월   변수 BASE_YM
                                            AND BB.OG_TP_CD = 'W02'
                                            AND AA.OG_TP_CD = BB.OG_TP_CD
                                            AND AA.PRTNR_NO = BB.PRTNR_NO
                                            AND BB.PSTN_DV_CD = '15'
                       WHERE 1 = 1
                         AND BB.CLTN_DT IS NULL --퇴직자 제외
                       GROUP BY BB.BASE_YM, AA.OG_TP_CD, AA.PRTNR_NO, BB.CLTN_DT
                      HAVING SUM(CASE WHEN AA.PERF_VAL >= 50 THEN 1 ELSE 0 END) = 12 --6개월간 매월 bs 50건 이상
                ) AAA -- 12개월 BS 활동 만족
                   , (SELECT A.ACTI_GDS_APLC_ID -- 신청번호
                           , A.OG_TP_CD
                           , A.PRTNR_NO
                           , A.ACTI_GDS_CD
                           , A.ACTI_GDS_SN
                           ,
                        (B.ACTI_GDS_AMT * A.APLC_QTY) - TRUNC(B.ACTI_GDS_AMT * A.APLC_QTY * 0.5) AS FEE_AMT /* 12개월차는 잔액  */
                        FROM TB_PSGA_ACTI_GDS_APLC_IZ A -- 활동물품신청내역
                             INNER JOIN TB_PSGA_ACTI_GDS_BAS B
                                        ON A.OG_TP_CD = B.OG_TP_CD
                                            AND A.ACTI_GDS_CD = B.ACTI_GDS_CD
                                            AND A.ACTI_GDS_SN = B.ACTI_GDS_SN
                       WHERE 1 = 1
                         AND A.ACTI_GDS_APLC_ID IN (SELECT DISTINCT AA.ACTI_GDS_APLC_ID
                                                      FROM (SELECT A.ACTI_GDS_APLC_ID
                                                                 , MAX(A.APLC_DT)               AS APLC_DT
                                                                 , MAX(A.ACTI_GDS_APLC_STAT_CD) AS ACTI_GDS_APLC_STAT_CD
                                                              FROM TB_PSGA_ACTI_GDS_APLC_STAT_IZ A
                                                             WHERE 1 = 1
                                                             GROUP BY A.ACTI_GDS_APLC_ID
                                                            HAVING MAX(A.ACTI_GDS_APLC_STAT_CD) = '01') AA
                                                           INNER JOIN (SELECT DISTINCT ACTI_GDS_APLC_ID FROM TB_PSGA_ACTI_GDS_DDTN_IZ) BB -- 공제 이력 존재
                                                                      ON AA.ACTI_GDS_APLC_ID = BB.ACTI_GDS_APLC_ID
                                                     WHERE 1 = 1
                                                       AND AA.APLC_DT LIKE
                                                           TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -12), 'YYYYMM') || '%' -- 당월   변수 BASE_YM
                       ) /* 12개월전 신청  */
                ) BBB -- 12개월전 유니폼 신청
               WHERE 1 = 1
                 AND AAA.OG_TP_CD = BBB.OG_TP_CD
                 AND AAA.PRTNR_NO = BBB.PRTNR_NO) MST
         WHERE 1 = 1
         GROUP BY MST.BASE_YM, MST.OG_TP_CD, MST.PRTNR_NO
    </insert>
</mapper>
