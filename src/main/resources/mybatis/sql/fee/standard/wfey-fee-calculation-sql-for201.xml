<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.standard.mapper.WfeyFeeCalculationSqlFor201Mapper">

    <insert id='insertBsEncouragementFeeForSeller'>
        /* BS장려(판매자)수수료(W020122) 계산 SQL (소스 : LC56U111, 컬럼 : AKSD41) */
        INSERT INTO TB_FEAM_FEE_CALC_BAS (  /* 수수료계산계약상세내역 */
                                                  BASE_YM            /* 기준년월 */
                                                , PERF_YM            /* 실적년월 */
                                                , OJ_DSB_YM          /* 대상지급년월 */
                                                , CO_CD              /* 회사코드 */
                                                , OG_TP_CD           /* 조직유형코드 */
                                                , PRTNR_NO           /* 파트너번호 */
                                                , FEE_CD             /* 수수료코드 */
                                                , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
                                                , FEE_TCNT_DV_CD     /* 수수료차수구분코드 */
                                                , SPMT_DSB_DV_CD     /* 추가지급구분코드 */
                                                , FEE_CALC_TP_CD     /* 수수료계산유형코드 */
                                                , FEE_CALC_AMT       /* 수수료계산금액 */
                                                , FEE_CTR_CNFM_AMT   /* 수수료조정확정금액 */
                                                , FNL_FEE_YN         /* 최종수수료여부 */
                                                <include refid="COMMON.insertSystemField" />)
        SELECT AAA.BASE_YM
             , AAA.BASE_YM      AS PERF_YM
             , AAA.BASE_YM      AS OJ_DSB_YM
             , #{coCd}          AS CO_CD
             , AAA.OG_TP_CD
             , AAA.PRTNR_NO
             , #{feeCd}         AS FEE_CD
             , #{dtaCrtFeeCd}   AS DTA_CRT_FEE_CD
             , #{feeTcntDvCd}   AS FEE_TCNT_DV_CD -- 수수료차수(변수)
             , '01'             AS SPMT_DSB_DV_CD -- 추후 확인 필요 01/정상지급, 02/추가지급
             , '01'             AS FEE_CALC_TP_CD -- 01 / 수수료계산
             , AAA.FEE_CALC_AMT
             , AAA.FEE_CALC_AMT AS FEE_CTR_CNFM_AMT
             , #{fnlFeeYn}      AS FNL_FEE_YN
            <include refid="COMMON.insertSystemFieldValue" />
          FROM (SELECT AA.BASE_YM
                     , AA.OG_TP_CD
                     , AA.PRTNR_NO
                     , TRUNC(
                          CASE
                              WHEN AA.TXT_BIGO = 'A' THEN AA.CNT_BS_UNDER * 4000 + CNT_BS_OVER * 2500
                              WHEN AA.TXT_BIGO = 'B' THEN AA.CNT_BS_UNDER * 3800 + CNT_BS_OVER * 2200
                              WHEN AA.TXT_BIGO = 'C' THEN AA.CNT_BS_UNDER * 3500 + CNT_BS_OVER * 2000
                              WHEN AA.TXT_BIGO = 'D' THEN AA.CNT_BS_UNDER * 2800 + CNT_BS_OVER * 1500
                              WHEN AA.TXT_BIGO = 'E' THEN AA.CNT_BS_UNDER * 2000 + CNT_BS_OVER * 900
                              WHEN AA.TXT_BIGO = 'F' THEN AA.CNT_BS_UNDER * 1200 + CNT_BS_OVER * 700
                              WHEN AA.TXT_BIGO = 'G' THEN AA.CNT_BS_UNDER * 500 + CNT_BS_OVER * 300
                              WHEN AA.TXT_BIGO = 'H' THEN AA.CNT_BS_UNDER * 200
                              ELSE 0 END * CNT_RATE
                  ) AS FEE_CALC_AMT
                  FROM (SELECT A.BASE_YM
                             , A.OG_TP_CD
                             , A.PRTNR_NO
                             , NVL(B.PERF_VAL, 0)                                                                            AS CNT_SUNZEON -- 순증건수
                             , NVL(C.PERF_VAL, 0)                                                                            AS CNT_FSVST   -- 허위방문건수
                             , NVL(D.PERF_VAL, 0)                                                                            AS CNT_BS      -- BS건수
                             , NVL(E.PERF_VAL, 0)                                                                            AS CNT_PAN     -- 가전(판매)건수
                             , MONTHS_BETWEEN(TO_DATE(A.BASE_YM||'01','YYYYMMDD'),TO_DATE(NVL(F.STRTDT,A.BASE_YM||'01'),'YYYYMMDD')) + 1 AS CNT_MON
                             , CASE
                                   WHEN NVL(D.PERF_VAL, 0) >= 250 THEN 250
                                   ELSE NVL(D.PERF_VAL, 0) END                                                               AS CNT_BS_UNDER
                             , CASE
                                   WHEN NVL(D.PERF_VAL, 0) >= 250 THEN NVL(D.PERF_VAL, 0) - 250
                                   ELSE 0 END                                                                                AS CNT_BS_OVER
                             , CASE
                                   WHEN NVL(E.PERF_VAL, 0) >= 20 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'A' -- 20건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 20 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'B' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 15 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'B' -- 15건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 15 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'C' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 12 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'C' -- 12건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 12 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'D' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 10 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'D' -- 10건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 10 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'E' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 8 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'E' -- 8건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 8 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'F' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 6 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'F' -- 6건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 6 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'G' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 4 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'G' -- 4건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 4 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'H' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 2 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'H' -- 2건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 2 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'I' -- 한칸 하위
                                   ELSE 'I' END                                                                              AS TXT_BIGO
                             , CASE WHEN MONTHS_BETWEEN(TO_DATE(A.BASE_YM||'01','YYYYMMDD'),TO_DATE(NVL(F.STRTDT,A.BASE_YM||'01'),'YYYYMMDD')) + 1 <![CDATA[<= 6]]> THEN  1
                                   ELSE (CASE
                                             WHEN NVL(B.PERF_VAL, 0) >= 2 THEN 1.1
                                             WHEN NVL(B.PERF_VAL, 0) >= 0 THEN 1
                                             WHEN NVL(B.PERF_VAL, 0) >= -2 THEN 0.9
                                             ELSE 0.8 END)
                          END                                                                                                AS CNT_RATE
                          FROM TB_OGBS_MM_PRTNR_IZ A /* M조직 기본   */
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL B
                                               ON A.BASE_YM = B.BASE_YM
                                                   AND A.BASE_YM = B.PERF_YM
                                                   AND #{feeTcntDvCd} = B.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = B.OG_TP_CD
                                                   AND A.PRTNR_NO = B.PRTNR_NO
                                                   AND 'W02P00113' = B.PERF_ATC_CD -- 순증
                                                   AND '0' = B.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL C
                                               ON A.BASE_YM = C.BASE_YM
                                                   AND A.BASE_YM = C.PERF_YM
                                                   AND #{feeTcntDvCd} = C.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = C.OG_TP_CD
                                                   AND A.PRTNR_NO = C.PRTNR_NO
                                                   AND 'W02P00097' = C.PERF_ATC_CD -- 허위방문
                                                   AND '0' = C.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL D
                                               ON A.BASE_YM = D.BASE_YM
                                                   AND A.BASE_YM = D.PERF_YM
                                                   AND #{feeTcntDvCd} = D.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = D.OG_TP_CD
                                                   AND A.PRTNR_NO = D.PRTNR_NO
                                                   AND 'W02P00085' = D.PERF_ATC_CD -- 고정 BS건수
                                                   AND '0' = D.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_NTORP_PERF_MM_CL E
                                               ON A.BASE_YM = E.BASE_YM
                                                   AND A.BASE_YM = E.PERF_YM
                                                   AND #{feeTcntDvCd} = E.FEE_TCNT_DV_CD -- 변수(차수)
                                                   AND A.OG_TP_CD = E.OG_TP_CD
                                                   AND A.PRTNR_NO = E.PRTNR_NO
                                                   AND 'W02P00002' = E.PERF_ATC_CD -- 고정 판매건수
                                                   AND '0' = E.PERF_DV_CD -- 고정 개인실적
                                LEFT OUTER JOIN (SELECT A.og_tp_Cd,A.prtnr_no ,NVL(B.STRTDT,A.STRTDT)  AS STRTDT
                                                   FROM WSMDBS.TB_OGPS_PLAR_QLF_CH_IZ A
                                                   LEFT OUTER JOIN TB_OGPS_PLAR_QLF_CH_IZ B
                                                                ON  A.og_tp_Cd  = B.og_tp_Cd
                                                               AND  A.prtnr_no  = B.prtnr_no
                                                               AND  A.QLF_DV_CD = 3           /* BS프리매니저에서 웰스플래너로 바뀐 분들  */
                                                               AND  B.QLF_DV_CD = 6
                                                               AND  TO_CHAR(ADD_MONTHS( TO_DATE(A.STRTDT,'YYYYMMDD'),-1),'YYYYMM') = SUBSTR(B.ENDDT,1,6)
                                                  WHERE 1 = 1
                                                   AND A.og_tp_Cd = #{ogTpCd}                               -- 변수
                                                   AND #{baseYm}||'01'  BETWEEN A.STRTDT AND A.ENDDT     -- 변수  기준년월 BASE_YM  = 202305
                                                ) F
					                            ON  A.OG_TP_CD = F.OG_TP_CD AND  A.PRTNR_NO = F.PRTNR_NO
                         WHERE 1 = 1
                           AND A.BASE_YM = #{baseYm} -- 변수
                           AND A.OG_TP_CD = #{ogTpCd} -- 변수
                           AND A.PSTN_DV_CD = '15') AA) AAA
         WHERE AAA.FEE_CALC_AMT > 0
    </insert>
</mapper>
