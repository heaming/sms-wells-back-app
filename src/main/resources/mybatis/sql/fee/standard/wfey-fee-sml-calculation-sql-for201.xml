<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.standard.mapper.WfeyFeeSmlCalculationSqlFor201Mapper">
    <insert id="insertSettlementFeesForSeller">
        /** 정착수수료(판매자) : W020081 소스 : LC56U114, 컬럼 : AKSD48 */
        INSERT INTO TB_FEAM_FEE_SML_BAS (  /* 수수료시뮬레이션기본 */
               BASE_YM            /* 기준년월 */
             , PERF_YM            /* 실적년월 */
             , OJ_DSB_YM          /* 대상지급년월 */
             , CO_CD              /* 회사코드 */
             , OG_TP_CD           /* 조직유형코드 */
             , PRTNR_NO           /* 파트너번호 */
             , FEE_CD             /* 수수료코드 */
             , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
             , FEE_DSB_MTHD_CD    /* 수수료지급방식코드 */
             , SML_CRT_TP_CD      /* 시뮬레이션생성유형코드 */
             , FEE_CALC_AMT       /* 수수료계산금액 */
             , FNL_FEE_YN         /* 최종수수료여부 */
             <include refid="COMMON.insertSystemField" />
                                           )
        SELECT RESULT.BASE_YM
             , RESULT.BASE_YM     AS PERF_YM
             , RESULT.BASE_YM     AS OJ_DSB_YM
             , #{coCd}            AS CO_CD
             , RESULT.OG_TP_CD
             , RESULT.PRTNR_NO
             , #{feeCd}           AS FEE_CD
             , #{dtaCrtFeeCd}     AS DTA_CRT_FEE_CD
             , '01'               AS FEE_DSB_MTHD_CD -- 수수료지급방식코드
             , #{smlCrtTpCd}      AS SML_CRT_TP_CD
             , RESULT.FEE_CALC_AMT
             , #{fnlFeeYn} AS FNL_FEE_YN
            <include refid="COMMON.insertSystemFieldValue" />
          FROM (SELECT Z.BASE_YM
                     , Z.OG_TP_CD
                     , Z.PRTNR_NO
                     , CASE
                           WHEN Z.OPNG_CD IN ('1', '4') THEN -- 최초개시
                               CASE
                                   WHEN Z.QLF_DV_CD = '3' THEN -- 웰스매니저
                                       CASE
                                           WHEN Z.NMN_N = 0 THEN -- 차수
                                               CASE
                                                   WHEN T02_PERF_VAL >= 50 THEN 500000 /* 차월 배정 */
                                                   ELSE 0 END
                                           WHEN Z.NMN_N = 1 THEN -- 차수
                                               CASE
                                                   WHEN T03_PERF_VAL >= 50 AND M01_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 3
                                                       THEN 500000
                                                   WHEN T03_PERF_VAL >= 50 AND M01_FEE_PERF_ATC_VAL = 'Y' THEN 200000
                                                   ELSE 0 END
                                           WHEN Z.NMN_N = 2 THEN -- 차수
                                               CASE
                                                   WHEN T03_PERF_VAL >= 50 AND M02_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 6
                                                       THEN 500000
                                                   WHEN T03_PERF_VAL >= 50 AND M02_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 3
                                                       THEN 300000
                                                   ELSE 0 END
                                           WHEN Z.NMN_N IN (3, 4, 5) THEN -- 차수
                                               CASE
                                                   WHEN T03_PERF_VAL >= 50 AND M03_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 6
                                                       THEN 500000
                                                   WHEN T03_PERF_VAL >= 50 AND M03_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 3
                                                       THEN 300000
                                                   ELSE 0 END
                                           ELSE 0 END
                                   WHEN Z.QLF_DV_CD = '6' THEN -- 프리매니저
                                       CASE
                                           WHEN Z.NMN_N = 0 THEN -- 차수
                                               CASE
                                                   WHEN T02_PERF_VAL >= 20 AND T01_PERF_VAL >= 3 THEN 200000 /* 차월 배정 */
                                                   ELSE 0 END
                                           WHEN Z.NMN_N = 1 THEN -- 차수
                                               CASE
                                                   WHEN T03_PERF_VAL >= 20 AND F01_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 3
                                                       THEN 200000
                                                   ELSE 0 END
                                           WHEN Z.NMN_N = 2 THEN -- 차수
                                               CASE
                                                   WHEN T03_PERF_VAL >= 20 AND F02_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 3
                                                       THEN 200000
                                                   ELSE 0 END
                                           WHEN Z.NMN_N = 3 THEN -- 차수
                                               CASE
                                                   WHEN T03_PERF_VAL >= 20 AND F03_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 3
                                                       THEN 200000
                                                   ELSE 0 END
                                           WHEN Z.NMN_N = 4 THEN -- 차수
                                               CASE
                                                   WHEN T03_PERF_VAL >= 20 AND F04_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 3
                                                       THEN 200000
                                                   ELSE 0 END
                                           WHEN Z.NMN_N = 5 THEN -- 차수
                                               CASE
                                                   WHEN T03_PERF_VAL >= 20 AND F05_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 3
                                                       THEN 200000
                                                   ELSE 0 END
                                           ELSE 0 END
                                   ELSE 0 END
                           WHEN Z.OPNG_CD IN ('2', '3') THEN -- 재개시
                               CASE
                                   WHEN Z.QLF_DV_CD = '3' THEN -- 웰스매니저
                                       CASE
                                           WHEN Z.NMN_N = 1 THEN -- 차수
                                               CASE
                                                   WHEN T03_PERF_VAL >= 50 AND M01_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 3
                                                       THEN 150000
                                                   ELSE 0 END
                                           WHEN Z.NMN_N = 2 THEN -- 차수
                                               CASE
                                                   WHEN T03_PERF_VAL >= 50 AND M02_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 6
                                                       THEN 250000
                                                   WHEN T03_PERF_VAL >= 50 AND M02_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 3
                                                       THEN 150000
                                                   ELSE 0 END
                                           WHEN Z.NMN_N IN (3, 4, 5) THEN -- 차수
                                               CASE
                                                   WHEN T03_PERF_VAL >= 50 AND M03_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 6
                                                       THEN 250000
                                                   WHEN T03_PERF_VAL >= 50 AND M03_FEE_PERF_ATC_VAL = 'Y' AND T01_PERF_VAL >= 3
                                                       THEN 150000
                                                   ELSE 0 END
                                           ELSE 0 END
                                   ELSE 0 END
                           ELSE 0 END AS FEE_CALC_AMT
                  FROM (SELECT AA.BASE_YM
                             , AA.OG_TP_CD
                             , AA.PRTNR_NO
                             , NVL(BB.OPNG_CD,NVL(CC.OPNG_CD,'0'))  AS OPNG_CD  -- 당월 없으면, 전월
                             , NVL(FF.QLF_DV_CD, NVL(GG.QLF_DV_CD, '0'))                     AS QLF_DV_CD            -- 자격
                             , NVL(CEIL(MONTHS_BETWEEN(TO_DATE(AA.BASE_YM || '01', 'YYYYMMDD'),
                                                       TO_DATE(FF.STRTDT, 'YYYYMMDD'))) + 1,
                                   CEIL(MONTHS_BETWEEN(TO_DATE(AA.BASE_YM || '01', 'YYYYMMDD'),
                                                       TO_DATE(GG.STRTDT, 'YYYYMMDD'))) + 1) AS NMN_N                -- 차월수
                             , NVL(T01.PERF_VAL, 0)                                          AS T01_PERF_VAL         -- 판매건수
                             , NVL(T02.PERF_VAL, 0)                                          AS T02_PERF_VAL         -- BS차월배정건수
                             , NVL(T03.PERF_VAL, 0)                                          AS T03_PERF_VAL         -- 매니저BS실적건수
                             , NVL(M01.FEE_PERF_ATC_VAL, 'N')                                AS M01_FEE_PERF_ATC_VAL -- 매니저정착1(4)수료여부
                             , NVL(M02.FEE_PERF_ATC_VAL, 'N')                                AS M02_FEE_PERF_ATC_VAL -- 매니저정착2(119)수료여부
                             , NVL(M03.FEE_PERF_ATC_VAL, 'N')                                AS M03_FEE_PERF_ATC_VAL -- 매니저정착345(140)수료여부
                             , NVL(F01.FEE_PERF_ATC_VAL, 'N')                                AS F01_FEE_PERF_ATC_VAL -- 프리1정수기(144)수료여부
                             , NVL(F02.FEE_PERF_ATC_VAL, 'N')                                AS F02_FEE_PERF_ATC_VAL -- 프리2비데 기타(145)수료여부
                             , NVL(F03.FEE_PERF_ATC_VAL, 'N')                                AS F03_FEE_PERF_ATC_VAL -- 프리3세일즈(146)수료여부
                             , NVL(F04.FEE_PERF_ATC_VAL, 'N')                                AS F04_FEE_PERF_ATC_VAL -- 프리4Wells live(147)수료여부
                             , NVL(F05.FEE_PERF_ATC_VAL, 'N')                                AS F05_FEE_PERF_ATC_VAL -- 프리5Wells live(148)수료여부
                          FROM TB_OGBS_MM_PRTNR_IZ AA
                               LEFT OUTER JOIN (SELECT A.BASE_YM, A.OG_TP_CD, A.PRTNR_NO, A.OPNG_CD AS OPNG_CD
                                       FROM TB_FEAM_WELS_MNGER_OPNG_BAS A
                                            JOIN (SELECT B.BASE_YM, B.OG_TP_CD, B.PRTNR_NO, MAX(B.TCNT_DV_CD) AS TCNT_DV_CD
                                                    FROM TB_FEAM_WELS_MNGER_OPNG_BAS B
                                                   WHERE 1 = 1
                                                     AND B.BASE_YM = #{baseYm}                           -- 변수 BASE_YM
                                                     AND B.OG_TP_CD = #{ogTpCd}
                                                   GROUP BY B.BASE_YM, B.OG_TP_CD, B.PRTNR_NO) B
                                                 ON A.BASE_YM = B.BASE_YM
                                                     AND A.OG_TP_CD = B.OG_TP_CD
                                                     AND A.PRTNR_NO = B.PRTNR_NO
                                                     AND A.TCNT_DV_CD = B.TCNT_DV_CD) BB
                                    ON AA.BASE_YM = BB.BASE_YM
                                        AND AA.OG_TP_CD = BB.OG_TP_CD
                                        AND AA.PRTNR_NO = BB.PRTNR_NO
                               LEFT OUTER JOIN (SELECT #{baseYm} AS BASE_YM
                                                      ,A.OG_TP_CD, A.PRTNR_NO, A.OPNG_CD AS OPNG_CD      -- 전월 웰스매니저 정착수당 대상자
                                       FROM TB_FEAM_WELS_MNGER_OPNG_BAS A
                                            JOIN (SELECT B.BASE_YM, B.OG_TP_CD, B.PRTNR_NO, MAX(B.TCNT_DV_CD) AS TCNT_DV_CD
                                                    FROM TB_FEAM_WELS_MNGER_OPNG_BAS B
                                                   WHERE 1 = 1
                                                     AND B.BASE_YM = TO_CHAR( ADD_MONTHS( TO_DATE( #{baseYm} ||'01','YYYYMMDD' ) , -1 )  ,'YYYYMM'  )                       -- 변수 BASE_YM
                                                     AND B.OG_TP_CD = #{ogTpCd}
                                                   GROUP BY B.BASE_YM, B.OG_TP_CD, B.PRTNR_NO) B
                                                 ON A.BASE_YM = B.BASE_YM
                                                     AND A.OG_TP_CD = B.OG_TP_CD
                                                     AND A.PRTNR_NO = B.PRTNR_NO
                                                     AND A.TCNT_DV_CD = B.TCNT_DV_CD) CC
                                    ON AA.BASE_YM = CC.BASE_YM
                                        AND AA.OG_TP_CD = CC.OG_TP_CD
                                        AND AA.PRTNR_NO = CC.PRTNR_NO
                               LEFT OUTER JOIN (SELECT A.OG_TP_CD
                                                     , A.PRTNR_NO
                                                     , A.QLF_DV_CD
                                                     , CASE
                                                           WHEN A.CV_DT IS NOT NULL THEN NVL(B.STRTDT, A.STRTDT)
                                                           ELSE A.STRTDT END AS STRTDT
                                                  FROM TB_OGPS_PLAR_QLF_CH_IZ A
                                                       LEFT OUTER JOIN TB_OGPS_PLAR_QLF_CH_IZ B
                                                                       ON A.OG_TP_CD = B.OG_TP_CD
                                                                           AND A.PRTNR_NO = B.PRTNR_NO
                                                                           AND A.QLF_DV_CD = '3' /* BS프리매니저에서 웰스플래너로 바뀐 분들  */
                                                                           AND B.QLF_DV_CD = '6'
                                                                           AND A.STRTDT =
                                                                               TO_CHAR(TO_DATE(B.ENDDT, 'YYYYMMDD') + 1, 'YYYYMMDD')
                                                                           AND B.ENDDT != '99991231'
                                                                           AND  NVL(B.QLF_APLC_DV_CD,'0') IN ('1','2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                                                 WHERE 1 = 1
                                                   AND A.OG_TP_CD = #{ogTpCd}                           -- 변수
                                                   AND TO_CHAR(LAST_DAY(TO_DATE(#{baseYm}||'01','YYYYMMDD') ),'YYYYMMDD' )  BETWEEN A.STRTDT AND A.ENDDT -- 변수  기준년월 BASE_YM  = 202305
                                                   AND A.QLF_DV_CD IN ('3', '6')
                                                   AND NVL(A.QLF_APLC_DV_CD,'0') IN ('1','2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                                                ) FF
                                               ON AA.OG_TP_CD = FF.OG_TP_CD
                                                   AND AA.PRTNR_NO = FF.PRTNR_NO
                               LEFT OUTER JOIN ( -- 다음달 자격 구하기
                              SELECT A.OG_TP_CD, A.PRTNR_NO, A.QLF_DV_CD, A.STRTDT
                                FROM TB_OGPS_PLAR_QLF_CH_IZ A
                               WHERE A.STRTDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm} || '01', 'YYYYMMDD'), 1), 'YYYYMM') || '%' --  변수  기준년월 BASE_YM  = 202305
                                 AND A.QLF_DV_CD IN ('3', '6')
                                 AND NVL(A.QLF_APLC_DV_CD,'0') IN ('1','2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                              ) GG
                                               ON AA.OG_TP_CD = GG.OG_TP_CD
                                                   AND AA.PRTNR_NO = GG.PRTNR_NO
                               LEFT OUTER JOIN TB_FEAM_MACUP_PERF_CL T01
                                               ON AA.BASE_YM = T01.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = T01.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = T01.OG_TP_CD
                                                   AND AA.PRTNR_NO = T01.PRTNR_NO
                                                   AND 'W02P00002' = T01.PERF_ATC_CD -- 고정 판매건수
                                                   AND '0' = T01.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_MACUP_PERF_CL T02
                                               ON AA.BASE_YM = T02.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = T02.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = T02.OG_TP_CD
                                                   AND AA.PRTNR_NO = T02.PRTNR_NO
                                                   AND 'W02P00098' = T02.PERF_ATC_CD -- 고정 BS차월배정건수
                                                   AND '0' = T02.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_MACUP_PERF_CL T03
                                               ON AA.BASE_YM = T03.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = T03.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = T03.OG_TP_CD
                                                   AND AA.PRTNR_NO = T03.PRTNR_NO
                                                   AND 'W02P00085' = T03.PERF_ATC_CD -- 고정 매니저BS실적건수
                                                   AND '0' = T03.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_PRTNR_PERF_MM_ACU_CL M01
                                               ON AA.BASE_YM = M01.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = M01.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = M01.OG_TP_CD
                                                   AND AA.PRTNR_NO = M01.PRTNR_NO
                                                   AND 'W02P00124' = M01.PERF_ATC_CD -- 고정  매니저정착1(4)수료여부
                               LEFT OUTER JOIN TB_FEAM_PRTNR_PERF_MM_ACU_CL M02
                                               ON  AA.BASE_YM = M02.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = M02.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = M02.OG_TP_CD
                                                   AND AA.PRTNR_NO = M02.PRTNR_NO
                                                   AND 'W02P00125' = M02.PERF_ATC_CD -- 고정  매니저정착2(119)수료여부
                               LEFT OUTER JOIN TB_FEAM_PRTNR_PERF_MM_ACU_CL M03
                                               ON  AA.BASE_YM = M03.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = M03.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = M03.OG_TP_CD
                                                   AND AA.PRTNR_NO = M03.PRTNR_NO
                                                   AND 'W02P00126' = M03.PERF_ATC_CD -- 고정  매니저정착345(140)수료여부
                               LEFT OUTER JOIN TB_FEAM_PRTNR_PERF_MM_ACU_CL F01
                                               ON  AA.BASE_YM = F01.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = F01.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = F01.OG_TP_CD
                                                   AND AA.PRTNR_NO = F01.PRTNR_NO
                                                   AND 'W02P00127' = F01.PERF_ATC_CD -- 고정  프리1정수기(144)수료여부
                               LEFT OUTER JOIN TB_FEAM_PRTNR_PERF_MM_ACU_CL F02
                                               ON  AA.BASE_YM = F02.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = F02.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = F02.OG_TP_CD
                                                   AND AA.PRTNR_NO = F02.PRTNR_NO
                                                   AND 'W02P00128' = F02.PERF_ATC_CD -- 고정  프리2비데 기타(145)수료여부
                               LEFT OUTER JOIN TB_FEAM_PRTNR_PERF_MM_ACU_CL F03
                                               ON  AA.BASE_YM = F03.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = F03.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = F03.OG_TP_CD
                                                   AND AA.PRTNR_NO = F03.PRTNR_NO
                                                   AND 'W02P00129' = F03.PERF_ATC_CD -- 고정  프리3세일즈(146)수료여부
                               LEFT OUTER JOIN TB_FEAM_PRTNR_PERF_MM_ACU_CL F04
                                               ON  AA.BASE_YM = F04.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = F04.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = F04.OG_TP_CD
                                                   AND AA.PRTNR_NO = F04.PRTNR_NO
                                                   AND 'W02P00130' = F04.PERF_ATC_CD -- 고정  프리4Wells live(147)수료여부
                               LEFT OUTER JOIN TB_FEAM_PRTNR_PERF_MM_ACU_CL F05
                                               ON  AA.BASE_YM = F05.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = F05.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = F05.OG_TP_CD
                                                   AND AA.PRTNR_NO = F05.PRTNR_NO
                                                   AND 'W02P00131' = F05.PERF_ATC_CD -- 고정  프리5Wells live(148)수료여부
                         WHERE 1 = 1
                           AND AA.BASE_YM = #{baseYm} --  변수  기준년월 BASE_YM  = 202305
				        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
				           AND AA.PRTNR_NO = #{prtnrNo}
				        </if>
                           AND AA.PSTN_DV_CD = '15'
                           AND NVL(BB.OPNG_CD,NVL(CC.OPNG_CD,'0'))       IN ('1', '2', '3', '4')    -- 당월 없으면 전월
                           AND NVL(FF.QLF_DV_CD, NVL(GG.QLF_DV_CD, '0')) IN ('3', '6')
                           AND AA.PERF_EXCD_OJ_YN = 'N') Z
                UNION ALL
                --  수석플래너 정착
                SELECT SUB.BASE_YM
                     , SUB.OG_TP_CD
                     , SUB.PRTNR_NO
                     , CASE
                           WHEN SUB.BASE_YM <![CDATA[<=]]> '202309' AND SUB.S01_FEE_PERF_ATC_VAL = 'Y' AND S02_FEE_PERF_ATC_VAL = 'Y' AND
                                T01_PERF_VAL >= 6 THEN -- 고정  2023년 9월까지만
                               CASE
                                   WHEN NMN_N IN (1, 2, 3, 4) THEN 300000
                                   WHEN NMN_N IN (5, 6, 7, 8) THEN 250000
                                   WHEN NMN_N IN (9, 10, 11, 12) THEN 200000
                                   ELSE 0 END
                           ELSE 0 END AS FEE_CALC_AMT
                  FROM (SELECT AA.BASE_YM
                             , AA.OG_TP_CD
                             , AA.PRTNR_NO
                             , GG.QLF_DV_CD
                             , ZZ.QLF_DV_CD
                             , ZZ.STRTDT
                             , CEIL(MONTHS_BETWEEN(TO_DATE(AA.BASE_YM || '01', 'YYYYMMDD'), TO_DATE(ZZ.STRTDT, 'YYYYMMDD'))) +
                               1                                 AS NMN_N                -- 승격차월
                             , NVL(T01.PERF_VAL, 0)              AS T01_PERF_VAL         -- 판매건수
                             , NVL(S01.FEE_PERF_ATC_VAL, 'N')    AS S01_FEE_PERF_ATC_VAL -- 보수교육최종(129)수료여부
                             , (SELECT NVL(MAX(Q.EDUC_CPC_ACKMT_YN), 'N')
                                  FROM TB_PSCA_MCPTN_EDUC_IZ Q
                                 WHERE 1 = 1
                                   AND Q.EDUC_CRSE_NO IN ('100', '106')                                 -- 수석플래너 정착 교육
                                   AND Q.EDUC_CRSE_CRT_BASE_YM >= SUBSTR(ZZ.STRTDT, 1, 6)
                                   AND Q.EDUC_CRSE_CRT_BASE_YM <![CDATA[<=]]>
                                       TO_CHAR(ADD_MONTHS(TO_DATE(ZZ.STRTDT, 'YYYYMMDD'), 2), 'YYYYMM') -- 두달안에 교육받으신 분
                                   AND Q.OG_TP_CD = AA.OG_TP_CD
                                   AND Q.PRTNR_NO = AA.PRTNR_NO) AS S02_FEE_PERF_ATC_VAL -- 수석플래너 정착 교육
                          FROM TB_OGBS_MM_PRTNR_IZ AA
                               LEFT OUTER JOIN ( -- 다음달 자격 구하기
                              SELECT A.OG_TP_CD, A.PRTNR_NO, A.QLF_DV_CD, A.STRTDT
                                FROM TB_OGPS_PLAR_QLF_CH_IZ A
                               WHERE A.STRTDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm} || '01', 'YYYYMMDD'), 1), 'YYYYMM') || '%' --  변수  기준년월 BASE_YM  = 202305
                                 AND A.QLF_DV_CD IN ('3', '6')
                                 AND NVL(A.QLF_APLC_DV_CD,'0') IN ('1','2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                             ) GG
                                               ON AA.OG_TP_CD = GG.OG_TP_CD
                                                   AND AA.PRTNR_NO = GG.PRTNR_NO
                               LEFT OUTER JOIN ( -- 다음달 자격 구하기
                              SELECT A.OG_TP_CD, A.PRTNR_NO, A.QLF_DV_CD, A.STRTDT
                                FROM TB_OGPS_PLAR_QLF_CH_IZ A
                               WHERE TO_CHAR(LAST_DAY(TO_DATE('202304', 'YYYYMM')), 'YYYYMMDD') BETWEEN A.STRTDT AND A.ENDDT -- 고정  2023년4월의 수석플래너 찾기
                                 AND A.QLF_DV_CD IN ('1')
                                 AND NVL(A.QLF_APLC_DV_CD,'0') IN ('1','2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                             ) ZZ
                                               ON AA.OG_TP_CD = ZZ.OG_TP_CD
                                                   AND AA.PRTNR_NO = ZZ.PRTNR_NO
                               LEFT OUTER JOIN TB_FEAM_MACUP_PERF_CL T01
                                               ON AA.BASE_YM = T01.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = T01.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = T01.OG_TP_CD
                                                   AND AA.PRTNR_NO = T01.PRTNR_NO
                                                   AND 'W02P00002' = T01.PERF_ATC_CD -- 고정 판매건수
                                                   AND '0' = T01.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_PRTNR_PERF_MM_ACU_CL S01
                                               ON  AA.BASE_YM = S01.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = S01.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND AA.OG_TP_CD = S01.OG_TP_CD
                                                   AND AA.PRTNR_NO = S01.PRTNR_NO
                                                   AND 'W02P00116' = S01.PERF_ATC_CD -- 고정  보수교육최종(129)수료여부
                         WHERE 1 = 1
                           AND AA.BASE_YM = #{baseYm} --  변수  기준년월 BASE_YM  = 202305
				        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
				           AND AA.PRTNR_NO = #{prtnrNo}
				        </if>
                           AND AA.OG_TP_CD = 'W02'
                           AND AA.PSTN_DV_CD = '15'
                           AND AA.QLF_DV_CD NOT IN ('3', '6') /* 당월 자격 확인  */
                           AND NVL(GG.QLF_DV_CD, '2') NOT IN ('3', '6') /* 차월 자격 확인  */
                           AND ZZ.QLF_DV_CD = '1' /* 4월 자격 수석 플래너 */
                           AND AA.PERF_EXCD_OJ_YN = 'N'
                  ) SUB) RESULT
         WHERE 1 = 1
           AND RESULT.FEE_CALC_AMT > 0
    </insert>

    <insert id='insertBsEncouragementFeeForSeller'>
        /* BS장려(판매자)수수료(W020122) 계산 SQL (소스 : LC56U111, 컬럼 : AKSD41) */
        INSERT INTO TB_FEAM_FEE_SML_BAS (  /* 수수료시뮬레이션기본 */
               BASE_YM            /* 기준년월 */
             , PERF_YM            /* 실적년월 */
             , OJ_DSB_YM          /* 대상지급년월 */
             , CO_CD              /* 회사코드 */
             , OG_TP_CD           /* 조직유형코드 */
             , PRTNR_NO           /* 파트너번호 */
             , FEE_CD             /* 수수료코드 */
             , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
             , FEE_DSB_MTHD_CD    /* 수수료지급방식코드 */
             , SML_CRT_TP_CD      /* 시뮬레이션생성유형코드 */
             , FEE_CALC_AMT       /* 수수료계산금액 */
             , FNL_FEE_YN         /* 최종수수료여부 */
             <include refid="COMMON.insertSystemField" />
                                            )
        SELECT AAA.BASE_YM
             , AAA.BASE_YM      AS PERF_YM
             , AAA.BASE_YM      AS OJ_DSB_YM
             , #{coCd}          AS CO_CD
             , AAA.OG_TP_CD
             , AAA.PRTNR_NO
             , #{feeCd}         AS FEE_CD
             , #{dtaCrtFeeCd}   AS DTA_CRT_FEE_CD
             , '01'             AS FEE_DSB_MTHD_CD -- 수수료지급방식코드
             , #{smlCrtTpCd}    AS SML_CRT_TP_CD
             , AAA.FEE_CALC_AMT
             , #{fnlFeeYn}      AS FNL_FEE_YN
            <include refid="COMMON.insertSystemFieldValue" />
          FROM (SELECT AA.BASE_YM
                     , AA.OG_TP_CD
                     , AA.PRTNR_NO
                     , TRUNC(
                          CASE
                              WHEN AA.TXT_BIGO = 'A' THEN AA.CNT_BS_UNDER * 4000 + CNT_BS_OVER * 2500
                              WHEN AA.TXT_BIGO = 'B' THEN AA.CNT_BS_UNDER * 3800 + CNT_BS_OVER * 2200
                              WHEN AA.TXT_BIGO = 'C' THEN AA.CNT_BS_UNDER * 3500 + CNT_BS_OVER * 2000
                              WHEN AA.TXT_BIGO = 'D' THEN AA.CNT_BS_UNDER * 2800 + CNT_BS_OVER * 1500
                              WHEN AA.TXT_BIGO = 'E' THEN AA.CNT_BS_UNDER * 2000 + CNT_BS_OVER * 900
                              WHEN AA.TXT_BIGO = 'F' THEN AA.CNT_BS_UNDER * 1200 + CNT_BS_OVER * 700
                              WHEN AA.TXT_BIGO = 'G' THEN AA.CNT_BS_UNDER * 500 + CNT_BS_OVER * 300
                              WHEN AA.TXT_BIGO = 'H' THEN AA.CNT_BS_UNDER * 200
                              ELSE 0 END * CNT_RATE
                  ) AS FEE_CALC_AMT
                  FROM (SELECT A.BASE_YM
                             , A.OG_TP_CD
                             , A.PRTNR_NO
                             , NVL(B.PERF_VAL, 0)                                                                            AS CNT_SUNZEON -- 순증건수
                             , NVL(C.PERF_VAL, 0)                                                                            AS CNT_FSVST   -- 허위방문건수
                             , NVL(D.PERF_VAL, 0)                                                                            AS CNT_BS      -- BS건수
                             , NVL(E.PERF_VAL, 0)                                                                            AS CNT_PAN     -- 가전(판매)건수
                             , MONTHS_BETWEEN(TO_DATE(A.BASE_YM||'01','YYYYMMDD'),TO_DATE(NVL(F.STRTDT,A.BASE_YM||'01'),'YYYYMMDD')) + 1 AS CNT_MON
                             , CASE
                                   WHEN NVL(D.PERF_VAL, 0) >= 250 THEN 250
                                   ELSE NVL(D.PERF_VAL, 0) END                                                               AS CNT_BS_UNDER
                             , CASE
                                   WHEN NVL(D.PERF_VAL, 0) >= 250 THEN NVL(D.PERF_VAL, 0) - 250
                                   ELSE 0 END                                                                                AS CNT_BS_OVER
                             , CASE
                                   WHEN NVL(E.PERF_VAL, 0) >= 20 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'A' -- 20건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 20 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'B' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 15 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'B' -- 15건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 15 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'C' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 12 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'C' -- 12건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 12 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'D' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 10 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'D' -- 10건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 10 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'E' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 8 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'E' -- 8건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 8 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'F' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 6 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'F' -- 6건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 6 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'G' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 4 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'G' -- 4건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 4 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'H' -- 한칸 하위
                                   WHEN NVL(E.PERF_VAL, 0) >= 2 AND NVL(C.PERF_VAL, 0) <![CDATA[<]]> 1 THEN 'H' -- 2건 이상
                                   WHEN NVL(E.PERF_VAL, 0) >= 2 AND NVL(C.PERF_VAL, 0) >= 1 THEN 'I' -- 한칸 하위
                                   ELSE 'I' END                                                                              AS TXT_BIGO
                             , CASE WHEN CEIL(MONTHS_BETWEEN(TO_DATE(A.BASE_YM||'01','YYYYMMDD'),TO_DATE(NVL(F.STRTDT,A.BASE_YM||'01'),'YYYYMMDD'))) + 1 <![CDATA[<= 6]]> THEN  1
                                   ELSE (CASE
                                             WHEN NVL(B.PERF_VAL, 0) >= 2 THEN 1.1
                                             WHEN NVL(B.PERF_VAL, 0) >= 0 THEN 1
                                             WHEN NVL(B.PERF_VAL, 0) >= -2 THEN 0.9
                                             ELSE 0.8 END)
                          END                                                                                                AS CNT_RATE
                          FROM TB_OGBS_MM_PRTNR_IZ A /* M조직 기본   */
                               LEFT OUTER JOIN TB_FEAM_MACUP_PERF_CL B
                                               ON A.BASE_YM = B.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = B.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND A.OG_TP_CD = B.OG_TP_CD
                                                   AND A.PRTNR_NO = B.PRTNR_NO
                                                   AND 'W02P00113' = B.PERF_ATC_CD -- 순증
                                                   AND '0' = B.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_MACUP_PERF_CL C
                                               ON A.BASE_YM = C.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = C.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND A.OG_TP_CD = C.OG_TP_CD
                                                   AND A.PRTNR_NO = C.PRTNR_NO
                                                   AND 'W02P00097' = C.PERF_ATC_CD -- 허위방문
                                                   AND '0' = C.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_MACUP_PERF_CL D
                                               ON A.BASE_YM = D.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = D.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND A.OG_TP_CD = D.OG_TP_CD
                                                   AND A.PRTNR_NO = D.PRTNR_NO
                                                   AND 'W02P00132' = D.PERF_ATC_CD -- 고정 BS건수
                                                   AND '0' = D.PERF_DV_CD -- 고정 개인실적
                               LEFT OUTER JOIN TB_FEAM_MACUP_PERF_CL E
                                               ON A.BASE_YM = E.BASE_YM
                                                   AND #{mmAcuPerfAgrgCrtDvCd} = E.MM_ACU_PERF_AGRG_CRT_DV_CD
                                                   AND A.OG_TP_CD = E.OG_TP_CD
                                                   AND A.PRTNR_NO = E.PRTNR_NO
                                                   AND 'W02P00002' = E.PERF_ATC_CD -- 고정 판매건수
                                                   AND '0' = E.PERF_DV_CD -- 고정 개인실적
                                LEFT OUTER JOIN (SELECT A.og_tp_Cd,A.prtnr_no ,CASE WHEN A.CV_DT IS NOT NULL THEN NVL(B.STRTDT,A.STRTDT) ELSE A.STRTDT END  AS STRTDT
                                                   FROM WSMDBS.TB_OGPS_PLAR_QLF_CH_IZ A
                                                   LEFT OUTER JOIN TB_OGPS_PLAR_QLF_CH_IZ B
                                                                ON  A.og_tp_Cd  = B.og_tp_Cd
                                                               AND  A.prtnr_no  = B.prtnr_no
                                                               AND  A.QLF_DV_CD = 3           /* BS프리매니저에서 웰스플래너로 바뀐 분들  */
                                                               AND  B.QLF_DV_CD = 6
                                                               AND  A.STRTDT = TO_CHAR(TO_DATE(B.ENDDT,'YYYYMMDD') + 1,'YYYYMMDD')
                                                               AND  B.ENDDT != '99991231'
                                                               AND NVL(B.QLF_APLC_DV_CD,'0') IN ('1','2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                                                  WHERE 1 = 1
                                                   AND A.og_tp_Cd = #{ogTpCd}                               -- 변수
                                                   AND TO_CHAR(LAST_DAY(TO_DATE(#{baseYm}||'01','YYYYMMDD') ),'YYYYMMDD' )  BETWEEN A.STRTDT AND A.ENDDT      -- 변수  기준년월 BASE_YM  = 202305
                                                   AND NVL(A.QLF_APLC_DV_CD,'0') IN ('1','2')  -- 승격,자격해제(과거)  3 : 보류 는 제외
                                                   ) F
					                            ON A.OG_TP_CD = F.OG_TP_CD
					                           AND A.PRTNR_NO = F.PRTNR_NO
                         WHERE 1 = 1
                           AND A.BASE_YM = #{baseYm} -- 변수
                           AND A.OG_TP_CD = #{ogTpCd} -- 변수
				        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
				           AND A.PRTNR_NO = #{prtnrNo}
				        </if>
                           AND A.PSTN_DV_CD = '15'
                           AND A.PERF_EXCD_OJ_YN = 'N') AA) AAA
         WHERE AAA.FEE_CALC_AMT > 0
    </insert>

    <insert id="insertUniformFeesForSeller">
        /****
        * 유니폼 재지급 대상 기준 : 수수료 기준년월 23년 2월 ( 23년 3월 집계 및 지급 ) 인 경우
          CASE 1.
                - 유니폼 신청일자가 22년8월1일 ~ 22년8월31일 이며, 최종 확정된 경우
                - 22년9월 ~ 23년2월까지 6개월간 매월 BS 실적 건수가 50계정 이상인 경우
                - 유니폼 신청 당시 활동물품 금액의 50% 수수료 생성
                - 수수료 기준년월 퇴직(예정)자 제외
          CASE 2.
                - 유니폼 신청일자가 22년2월1일 ~ 22년2월28일 이며, 최종 확정된 경우
                - 22년3월 ~ 23년2월까지 12개월간 매월 BS 실적 건수가 50계정 이상인 경우
                - 유니폼 신청 당시 활동물품 금액의 50% 수수료 생성
                - 수수료 기준년월 퇴직(예정)자 제외
        ****/
        INSERT INTO TB_FEAM_FEE_SML_BAS (  /* 수수료시뮬레이션기본 */
               BASE_YM            /* 기준년월 */
             , PERF_YM            /* 실적년월 */
             , OJ_DSB_YM          /* 대상지급년월 */
             , CO_CD              /* 회사코드 */
             , OG_TP_CD           /* 조직유형코드 */
             , PRTNR_NO           /* 파트너번호 */
             , FEE_CD             /* 수수료코드 */
             , DTA_CRT_FEE_CD     /* 데이터생성수수료코드 */
             , FEE_DSB_MTHD_CD    /* 수수료지급방식코드 */
             , SML_CRT_TP_CD      /* 시뮬레이션생성유형코드 */
             , FEE_CALC_AMT       /* 수수료계산금액 */
             , FNL_FEE_YN         /* 최종수수료여부 */
             <include refid="COMMON.insertSystemField" />
                                            )
        SELECT MST.BASE_YM      AS BASE_YM
             , MST.BASE_YM      AS PERF_YM
             , MST.BASE_YM      AS OJ_DSB_YM
             , #{coCd}           AS CO_CD
             , MST.OG_TP_CD     AS OG_TP_CD
             , MST.PRTNR_NO     AS PRTNR_NO
             , #{feeCd}        AS FEE_CD
             , #{dtaCrtFeeCd}        AS DTA_CRT_FEE_CD
             , '01'             AS FEE_DSB_MTHD_CD -- 수수료지급방식코드
             , #{smlCrtTpCd}    AS SML_CRT_TP_CD
             , SUM(MST.FEE_AMT) AS FEE_CALC_AMT
             , #{fnlFeeYn}      AS FNL_FEE_YN
            <include refid="COMMON.insertSystemFieldValue" />
          FROM ( --CASE 1. 6개월
              SELECT AAA.BASE_YM
                   , AAA.OG_TP_CD
                   , AAA.PRTNR_NO
                   , BBB.ACTI_GDS_APLC_ID
                   , BBB.FEE_AMT
                FROM (SELECT BB.BASE_YM
                           , AA.OG_TP_CD
                           , AA.PRTNR_NO
                           , BB.CLTN_DT
                           , SUM(CASE WHEN AA.PERF_VAL >= 50 THEN 1 ELSE 0 END) AS CNT_BS
                        FROM (SELECT A.BASE_YM, A.OG_TP_CD, A.PRTNR_NO, A.PERF_VAL
                                FROM TB_FEAM_NTORP_PERF_MM_CL A
                               WHERE 1 = 1
                                 AND A.BASE_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -5), 'YYYYMM') AND TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -1), 'YYYYMM') -- 지난 5개월   변수 BASE_YM
                                 AND A.FEE_TCNT_DV_CD = '02'                                                                                                                             -- 고정 지난 5개월은 2차수로 고정
                                 AND A.PERF_AGRG_CRT_DV_CD = '201'                                                                                                                       -- 수수료 집계
                                 AND A.PERF_ATC_CD = 'W02P00085'                                                                                                                         -- BS건수
                                 AND A.PERF_DV_CD = '0'                                                                                                                                  -- 개인
                               UNION ALL
                              SELECT A.BASE_YM, A.OG_TP_CD, A.PRTNR_NO, A.PERF_VAL
                                FROM TB_FEAM_MACUP_PERF_CL A                                -- 이것만 총주문!!!!!
                               WHERE 1 = 1
                                 AND A.BASE_YM = #{baseYm}          -- 당월   변수 BASE_YM
                                 AND A.MM_ACU_PERF_AGRG_CRT_DV_CD = #{mmAcuPerfAgrgCrtDvCd}
                                 AND A.PERF_ATC_CD = 'W02P00085'   -- BS건수
                                 AND A.PERF_DV_CD = '0' -- 개인
                        ) AA
                             INNER JOIN TB_OGBS_MM_PRTNR_IZ BB
                                        ON BB.BASE_YM = #{baseYm} -- 당월   변수 BASE_YM
                                            AND BB.OG_TP_CD = 'W02'
                                            AND AA.OG_TP_CD = BB.OG_TP_CD
                                            AND AA.PRTNR_NO = BB.PRTNR_NO
                                            AND BB.PSTN_DV_CD = '15'
                       WHERE 1 = 1
                         AND BB.CLTN_DT IS NULL --퇴직자 제외
                       GROUP BY BB.BASE_YM, AA.OG_TP_CD, AA.PRTNR_NO, BB.CLTN_DT
                      HAVING SUM(CASE WHEN AA.PERF_VAL >= 50 THEN 1 ELSE 0 END) = 6 --6개월간 매월 bs 50건 이상
                ) AAA -- 6개월 BS 활동 만족
                   , (SELECT A.ACTI_GDS_APLC_ID -- 신청번호
                           , A.OG_TP_CD
                           , A.PRTNR_NO
                           , A.ACTI_GDS_CD
                           , A.ACTI_GDS_SN
                           , TRUNC(B.ACTI_GDS_AMT * A.APLC_QTY * 0.5) AS FEE_AMT
                        FROM TB_PSGA_ACTI_GDS_APLC_IZ A -- 활동물품신청내역
                             INNER JOIN TB_PSGA_ACTI_GDS_BAS B
                                        ON A.OG_TP_CD = B.OG_TP_CD
                                            AND A.ACTI_GDS_CD = B.ACTI_GDS_CD
                                            AND A.ACTI_GDS_SN = B.ACTI_GDS_SN
                       WHERE 1 = 1
                         AND A.ACTI_GDS_APLC_ID IN (SELECT DISTINCT AA.ACTI_GDS_APLC_ID
                                                      FROM (SELECT A.ACTI_GDS_APLC_ID
                                                                 , MAX(A.APLC_DT)               AS APLC_DT
                                                                 , MAX(A.ACTI_GDS_APLC_STAT_CD) AS ACTI_GDS_APLC_STAT_CD
                                                              FROM TB_PSGA_ACTI_GDS_APLC_STAT_IZ A
                                                             WHERE 1 = 1
                                                             GROUP BY A.ACTI_GDS_APLC_ID
                                                            HAVING MAX(A.ACTI_GDS_APLC_STAT_CD) = '01') AA
                                                           INNER JOIN (SELECT DISTINCT ACTI_GDS_APLC_ID FROM TB_PSGA_ACTI_GDS_DDTN_IZ) BB -- 공제 이력 존재
                                                                      ON AA.ACTI_GDS_APLC_ID = BB.ACTI_GDS_APLC_ID
                                                     WHERE 1 = 1
                                                       AND AA.APLC_DT LIKE
                                                           TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -6), 'YYYYMM') ||
                                                           '%' -- 당월   변수 BASE_YM
                       ) /* 6개월전 신청  */
                ) BBB -- 6개월전 유니폼 신청
               WHERE 1 = 1
                 AND AAA.OG_TP_CD = BBB.OG_TP_CD
                 AND AAA.PRTNR_NO = BBB.PRTNR_NO
		        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
	             AND AAA.PRTNR_NO = #{prtnrNo}
		        </if>
               UNION ALL
              SELECT AAA.BASE_YM --CASE 2. 12개월
                   , AAA.OG_TP_CD
                   , AAA.PRTNR_NO
                   , BBB.ACTI_GDS_APLC_ID
                   , BBB.FEE_AMT
                FROM (SELECT BB.BASE_YM
                           , AA.OG_TP_CD
                           , AA.PRTNR_NO
                           , BB.CLTN_DT
                           , SUM(CASE WHEN AA.PERF_VAL >= 50 THEN 1 ELSE 0 END) AS CNT_BS
                        FROM (SELECT A.BASE_YM, A.OG_TP_CD, A.PRTNR_NO, A.PERF_VAL
                                FROM TB_FEAM_NTORP_PERF_MM_CL A
                               WHERE 1 = 1
                                 AND A.BASE_YM BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -11), 'YYYYMM') AND TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -1), 'YYYYMM') -- 지난 11개월   변수 BASE_YM
                                 AND A.FEE_TCNT_DV_CD = '02'                                                                                                                              -- 고정 지난 5개월은 2차수로 고정
                                 AND A.PERF_AGRG_CRT_DV_CD = '201'                                                                                                                        -- 수수료 집계
                                 AND A.PERF_ATC_CD = 'W02P00085'                                                                                                                          -- BS건수
                                 AND A.PERF_DV_CD = '0'                                                                                                                                   -- 개인
                               UNION ALL
                              SELECT A.BASE_YM, A.OG_TP_CD, A.PRTNR_NO, A.PERF_VAL
                                FROM TB_FEAM_MACUP_PERF_CL A                                -- 이것만 총주문!!!!!
                               WHERE 1 = 1
                                 AND A.BASE_YM = #{baseYm}          -- 당월   변수 BASE_YM
                                 AND A.MM_ACU_PERF_AGRG_CRT_DV_CD = #{mmAcuPerfAgrgCrtDvCd}
                                 AND A.PERF_ATC_CD = 'W02P00085'   -- BS건수
                                 AND A.PERF_DV_CD = '0' -- 개인
                        ) AA
                             INNER JOIN TB_OGBS_MM_PRTNR_IZ BB
                                        ON BB.BASE_YM = #{baseYm} -- 당월   변수 BASE_YM
                                            AND BB.OG_TP_CD = 'W02'
                                            AND AA.OG_TP_CD = BB.OG_TP_CD
                                            AND AA.PRTNR_NO = BB.PRTNR_NO
                                            AND BB.PSTN_DV_CD = '15'
                       WHERE 1 = 1
                         AND BB.CLTN_DT IS NULL --퇴직자 제외
                       GROUP BY BB.BASE_YM, AA.OG_TP_CD, AA.PRTNR_NO, BB.CLTN_DT
                      HAVING SUM(CASE WHEN AA.PERF_VAL >= 50 THEN 1 ELSE 0 END) = 12 --6개월간 매월 bs 50건 이상
                ) AAA -- 12개월 BS 활동 만족
                   , (SELECT A.ACTI_GDS_APLC_ID -- 신청번호
                           , A.OG_TP_CD
                           , A.PRTNR_NO
                           , A.ACTI_GDS_CD
                           , A.ACTI_GDS_SN
                           ,
                        (B.ACTI_GDS_AMT * A.APLC_QTY) - TRUNC(B.ACTI_GDS_AMT * A.APLC_QTY * 0.5) AS FEE_AMT /* 12개월차는 잔액  */
                        FROM TB_PSGA_ACTI_GDS_APLC_IZ A -- 활동물품신청내역
                             INNER JOIN TB_PSGA_ACTI_GDS_BAS B
                                        ON A.OG_TP_CD = B.OG_TP_CD
                                            AND A.ACTI_GDS_CD = B.ACTI_GDS_CD
                                            AND A.ACTI_GDS_SN = B.ACTI_GDS_SN
                       WHERE 1 = 1
                         AND A.ACTI_GDS_APLC_ID IN (SELECT DISTINCT AA.ACTI_GDS_APLC_ID
                                                      FROM (SELECT A.ACTI_GDS_APLC_ID
                                                                 , MAX(A.APLC_DT)               AS APLC_DT
                                                                 , MAX(A.ACTI_GDS_APLC_STAT_CD) AS ACTI_GDS_APLC_STAT_CD
                                                              FROM TB_PSGA_ACTI_GDS_APLC_STAT_IZ A
                                                             WHERE 1 = 1
                                                             GROUP BY A.ACTI_GDS_APLC_ID
                                                            HAVING MAX(A.ACTI_GDS_APLC_STAT_CD) = '01') AA
                                                           INNER JOIN (SELECT DISTINCT ACTI_GDS_APLC_ID FROM TB_PSGA_ACTI_GDS_DDTN_IZ) BB -- 공제 이력 존재
                                                                      ON AA.ACTI_GDS_APLC_ID = BB.ACTI_GDS_APLC_ID
                                                     WHERE 1 = 1
                                                       AND AA.APLC_DT LIKE
                                                           TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -12), 'YYYYMM') || '%' -- 당월   변수 BASE_YM
                       ) /* 12개월전 신청  */
                ) BBB -- 12개월전 유니폼 신청
               WHERE 1 = 1
                 AND AAA.OG_TP_CD = BBB.OG_TP_CD
                 AND AAA.PRTNR_NO = BBB.PRTNR_NO
		        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
	             AND AAA.PRTNR_NO = #{prtnrNo}
		        </if>
            ) MST
         WHERE 1 = 1
         GROUP BY MST.BASE_YM, MST.OG_TP_CD, MST.PRTNR_NO
    </insert>

    <insert id="insertSupplementaryEncrgFeeForPlanner">
        /* 추가장려(플래너) : W020124, 소스 : AB80C00, 컬럼 : AKSD06 */

    </insert>

    <insert id="insertManagerLifeAlncFee3">
    /* 2024.01 이후 상조개인 W020125, W020127 (15, 7) (계약단위) 수수료 계산 SQL */
    INSERT INTO TB_FEAM_FEE_SML_CNTR_DTL_IZ(
                   BASE_YM           /* 기준년월 */
                 , PERF_YM           /* 실적년월 */
                 , OJ_DSB_YM         /* 대상지급년월 */
                 , CO_CD             /* 회사코드 */
                 , OG_TP_CD          /* 조직유형코드 */
                 , PRTNR_NO          /* 파트너번호 */
                 , FEE_CD            /* 수수료코드 */
                 , DTA_CRT_FEE_CD    /* 데이터생성수수료코드 */
                 , SML_CRT_TP_CD    /* 시뮬레이션생성유형코드 */
                 , CNTR_NO           /* 계약번호 */
                 , CNTR_SN           /* 계약일련번호 */
                 , FEE_CALC_AMT      /* 수수료계산금액 */
             <include refid="COMMON.insertSystemField" />
             )
      SELECT MST.BASE_YM
             , MST.PERF_YM
             , MST.OJ_DSB_YM
             , #{coCd}          AS CO_CD
             , MST.OG_TP_CD
             , MST.PRTNR_NO
             , #{feeCd}         AS FEE_CD
             , #{dtaCrtFeeCd}   AS DTA_CRT_FEE_CD
             , #{smlCrtTpCd}    AS SML_CRT_TP_CD
             , MST.CNTR_NO
             , MST.CNTR_SN
             , MST.FEE_CALC_AMT
            <include refid="COMMON.insertSystemFieldValue" />
        FROM (
              SELECT A.BASE_YM
                   , A.BASE_YM      AS PERF_YM
                   , A.BASE_YM      AS OJ_DSB_YM
                   , A.OG_TP_CD
                   , A.PRTNR_NO
                   , B.CNTR_NO
                   , B.CNTR_SN
                   , (NVL(B.PRE_CNT, 0) * 50000 + NVL(B.NXT_CNT, 0) * 40000) AS FEE_CALC_AMT
               FROM TB_OGBS_MM_PRTNR_IZ A
               LEFT OUTER JOIN (
                     SELECT M.FEE_DSB_YM BASE_YM
                            ,M.OG_TP_CD
                            ,M.PRTNR_NO
                            ,M.CNTR_NO
                            ,M.CNTR_SN
                            ,SUM(CASE WHEN SUBSTR(M.CNTR_DT, 1, 6) <![CDATA[>=]]> '202401' THEN 1 ELSE 0 END) NXT_CNT
                            ,SUM(CASE WHEN SUBSTR(M.CNTR_DT, 1, 6) <![CDATA[<]]> '202401' THEN 1 ELSE 0 END) PRE_CNT
                       FROM TB_IFIN_LIF_ALNC_FEE_CNTR_IZ M
                      WHERE FEE_DSB_YM = #{baseYm}
                        AND M.ET_CNFM_DV_CD = '01' /* 예상 */
                        AND NVL(M.CAN_DT,0) = 0    /* 취소X */
                        AND M.LIF_CNTR_STAT_CD = 0 /* 수수료 */
                        AND M.OG_TP_CD = 'W02' /* M영업 조직 */
                        AND M.DTA_DL_YN = 'N'
                      GROUP BY M.FEE_DSB_YM, M.OG_TP_CD, M.PRTNR_NO, M.CNTR_NO, M.CNTR_SN
                    ) B
                 ON (A.BASE_YM = B.BASE_YM
                    AND A.OG_TP_CD = B.OG_TP_CD
                    AND A.PRTNR_NO = B.PRTNR_NO)
              WHERE 1 = 1
                AND A.BASE_YM = #{baseYm} -- 변수
                AND A.PSTN_DV_CD = (CASE WHEN #{feeCd} = 'W020127' THEN '7'
                                         ELSE '15' END)
                AND A.OG_TP_CD = 'W02'
             ) MST
       WHERE 1 = 1
         AND MST.FEE_CALC_AMT <![CDATA[>]]> 0
   </insert>


</mapper>
