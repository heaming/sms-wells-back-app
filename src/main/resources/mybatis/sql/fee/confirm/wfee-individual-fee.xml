<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.confirm.mapper.WfeeIndividualFeeMapper">
    <select id='selectIndividualPerformanceMngerDetails'
            resultType="com.kyowon.sms.wells.web.fee.confirm.dto.WfeeIndividualFeeDto$SearchMngerRes">
        SELECT PRTNR_NO	/*파트너번호*/
	         , PRTNR_KNM	/*성명*/
             , RCPDT	/*접수일자*/
             , SL_DT	/*매출일자*/
             , CAN_DT	/*취소일자*/
             , CNTR_NO	/*계약번호*/
             , PD_NM	/*상품명*/
             , CST_KNM	/*고객명*/
             , SALE_DIV	/*판매구분*/
             , NVL(PERF_BS_PD_ACC_CNT, 0) AS PERF_BS_PD_ACC_CNT	/*가전인정건수*/
             , NVL(PERF_ELHM_EXCP_ACKMT, 0) AS PERF_ELHM_EXCP_ACKMT	/*가전외인정실적*/
             , NVL(PD_ACC_CNT, 0) AS PD_ACC_CNT	/*인정건수*/
             , NVL(PERF_RENTAL, 0) AS PERF_RENTAL	/*가전기준가*/
             , NVL(PERF_SNGL_PMNT, 0) AS PERF_SNGL_PMNT	/*환경가전일시불*/
             , NVL(PERF_FXAM, 0) AS PERF_FXAM	/*환경가전정액*/
          FROM
	         ( SELECT A1.PRTNR_NO
                    , (SELECT C.PRTNR_KNM FROM TB_OGBS_MM_PRTNR_IZ C WHERE C.BASE_YM = #{perfYm} AND C.OG_TP_CD = #{ogTpCd} AND C.PRTNR_NO = A1.PRTNR_NO AND C.DTA_DL_YN = 'N') AS PRTNR_KNM
                    , A1.RCPDT	/*접수일자*/
                    , A1.SL_DT	/*매출일자*/
                    , A2.CNTR_PD_ENDDT AS CAN_DT	/*취소일자*/
                    , A1.CNTR_NO
                    , (SELECT C.PD_NM FROM TB_PDBS_PD_BAS C WHERE C.DTA_DL_YN = 'N' AND C.PD_CD = A1.PD_CD) AS PD_NM
                    , (SELECT C.CST_KNM FROM TB_CUBS_CST_BAS C WHERE C.DTA_DL_YN = 'N' AND C.CST_NO = A2.CNTR_CST_NO ) AS CST_KNM
                    , CASE WHEN A1.MCHN_CH_YN = 'Y' AND A1.MCHN_CH_TP_CD IN (15, 16, 19) THEN '재렌탈'
                                 WHEN A1.MCHN_CH_YN = 'Y' AND A1.MCHN_CH_TP_CD IN (1, 18) THEN '기변'
                                 ELSE '신규' END SALE_DIV		/*판매구분*/
                    , A1.PERF_ATC_CD
                    , NVL(A1.PERF_VAL, 0) AS PERF_VAL	/*실적값*/
                 FROM
                    ( SELECT B1.CNTR_NO
                           , B1.CNTR_SN
                           , B1.PRTNR_NO
                           , B2.RCPDT	/*접수일자*/
                           , B2.SL_DT	/*매출일자*/
                           , B2.CAN_DT	/*취소일자*/
                           , B2.PD_CD
                           , B2.MCHN_CH_YN	/*기기변경여부*/
                           , B2.MCHN_CH_TP_CD	/*기기변경유형코드*/
                           , B1.PERF_ATC_CD	/*실적항목코드*/
                           , B1.PERF_VAL
		                FROM
                           /*인정건수*/
                           ( SELECT CNTR_NO
                                  , CNTR_SN
                                  , PRTNR_NO
                                  , 'W00P00000' AS PERF_ATC_CD
                                  , SUM(NVL(PERF_VAL, 0)) AS PERF_VAL
			                   FROM TB_FEAM_NTORP_CNTR_MM_CL	/*순주문파트너계약월마감*/
			                  WHERE DTA_DL_YN = 'N'
                                AND BASE_YM = #{perfYm}
                                AND PERF_YM = #{perfYm}
                                AND FEE_TCNT_DV_CD = '02'
                                AND CNTR_PERF_CRT_DV_CD = '01'	/*순주문집계*/
                                AND PERF_DV_CD = '0'	/*개인판매*/
                                AND PERF_AGRG_CRT_DV_CD = '201'	/*M조직순주문실적*/
                                AND CO_CD = '2000'	/*교원프라퍼티*/
                                AND OG_TP_CD = 'W02'	/*M조직*/
                                AND PRTNR_NO = #{prtnrNo}
                                AND PERF_ATC_CD IN ('W00P00012', 'W00P00013', 'W00P00016', 'W00P00017')
			                  GROUP BY CNTR_NO, CNTR_SN, PRTNR_NO
                              UNION ALL
                              /*환경가전렌탈,환경가전일시불,환경가전정액,BS인정건수*/
                             SELECT CNTR_NO
                                  , CNTR_SN
                                  , PRTNR_NO
                                  , PERF_ATC_CD
                                  , NVL(PERF_VAL, 0) AS PERF_VAL
                               FROM TB_FEAM_NTORP_CNTR_MM_CL	/*순주문파트너계약월마감*/
                              WHERE DTA_DL_YN = 'N'
                                AND BASE_YM = #{perfYm}
                                AND PERF_YM = #{perfYm}
                                AND FEE_TCNT_DV_CD = '02'
                                AND CNTR_PERF_CRT_DV_CD = '01'	/*순주문집계*/
                                AND PERF_DV_CD = '0'	/*개인판매*/
                                AND PERF_AGRG_CRT_DV_CD = '201'	/*M조직순주문실적*/
                                AND CO_CD = '2000'	/*교원프라퍼티*/
                                AND OG_TP_CD = 'W02'	/*M조직*/
                                AND PRTNR_NO = #{prtnrNo}
                                AND PERF_ATC_CD IN ('W00P00003', 'W00P00004', 'W00P00005', 'W00P00011', 'W02P00112')
                           ) B1
                       INNER JOIN TB_FEAM_WELS_NRCTR_MM_CL B2	/*웰스순주문계약월마감*/
                          ON B2.FEE_TCNT_DV_CD = '02'
                         AND B1.CNTR_NO = B2.CNTR_NO
                         AND B1.CNTR_SN = B2.CNTR_SN
                         AND B2.CNTR_PERF_CRT_DV_CD ='01'
                         AND B2.DTA_DL_YN = 'N'
                       WHERE B2.SL_DT BETWEEN #{perfYm}||'01' AND #{perfYm}||'31'   /*매출일자가 당월인 것만 조회함. 1566 결함수정*/
	               ) A1
                LEFT OUTER JOIN
                   ( SELECT B1.CNTR_NO
                          , B1.CNTR_CST_NO
                          , B2.CNTRW_TP_CD
                          , CASE WHEN B2.CNTR_DTL_STAT_CD IN ('301','303') THEN B2.CNTR_PD_ENDDT END CNTR_PD_ENDDT
                       FROM TB_SSCT_CNTR_BAS B1	/*계약기본*/
                      INNER JOIN TB_SSCT_CNTR_DTL B2 	/*계약상세*/
                         ON B1.CNTR_NO = B2.CNTR_NO
                        AND B2.DTA_DL_YN = 'N'
                      WHERE B1.DTA_DL_YN = 'N'
                        AND B1.SELL_PRTNR_NO = #{prtnrNo}
                   ) A2
                  ON A1.CNTR_NO = A2.CNTR_NO
               ORDER BY A1.RCPDT, A1.SL_DT
            )
            PIVOT
	            ( SUM(PERF_VAL) FOR PERF_ATC_CD IN
                     ( 'W00P00000' AS PD_ACC_CNT
                     , 'W00P00003' AS PERF_RENTAL
                     , 'W00P00004' AS PERF_SNGL_PMNT
                     , 'W00P00005' AS PERF_FXAM
                     , 'W00P00011' AS PERF_BS_PD_ACC_CNT
                     , 'W02P00112' AS PERF_ELHM_EXCP_ACKMT )
               )
    </select>

    <select id='selectIndividualPerformanceHmstDetails'
            resultType="com.kyowon.sms.wells.web.fee.confirm.dto.WfeeIndividualFeeDto$SearchHmstRes">
        SELECT PRTNR_NO	/*파트너번호*/
	         , PRTNR_KNM	/*성명*/
             , RCPDT	/*접수일자*/
             , SL_DT	/*매출일자*/
             , CNTR_NO	/*계약번호*/
             , PD_NM	/*상품명*/
             , CST_KNM	/*고객명*/
             , SALE_DIV	/*판매구분*/
             , NVL(PD_ACC_CNT, 0) AS PD_ACC_CNT	/*인정건수*/
             , NVL(PERF_RENTAL, 0) AS PERF_RENTAL	/*렌탈*/
             , NVL(PERF_SNGL_PMNT, 0) AS PERF_SNGL_PMNT	/*일시불*/
          FROM
	         ( SELECT A1.PRTNR_NO
                    , (SELECT C.PRTNR_KNM FROM TB_OGBS_MM_PRTNR_IZ C WHERE C.BASE_YM = #{perfYm} AND C.OG_TP_CD = 'W03' AND C.PRTNR_NO = A1.PRTNR_NO AND C.DTA_DL_YN = 'N') AS PRTNR_KNM
                    , A1.RCPDT	/*접수일자*/
                    , A1.SL_DT	/*매출일자*/
                    , A1.CNTR_NO
                    , (SELECT C.PD_NM FROM TB_PDBS_PD_BAS C WHERE C.DTA_DL_YN = 'N' AND C.PD_CD = A1.PD_CD) AS PD_NM
                    , (SELECT C.CST_KNM FROM TB_CUBS_CST_BAS C WHERE C.DTA_DL_YN = 'N' AND C.CST_NO = A2.CNTR_CST_NO ) AS CST_KNM
                    , CASE WHEN A1.MCHN_CH_YN = 'Y' AND A1.MCHN_CH_TP_CD IN (15, 16, 19) THEN '재렌탈'
                                 WHEN A1.MCHN_CH_YN = 'Y' AND A1.MCHN_CH_TP_CD IN (1, 18) THEN '기변'
                                 ELSE '신규' END SALE_DIV		/*판매구분*/
                    , A1.PERF_ATC_CD
                    , NVL(A1.PERF_VAL, 0) AS PERF_VAL	/*실적값*/
	             FROM
		            ( SELECT B1.CNTR_NO
                           , B1.CNTR_SN
                           , B1.PRTNR_NO
                           , B2.RCPDT	/*접수일자*/
                           , B2.SL_DT	/*매출일자*/
                           , B2.PD_CD
                           , B2.MCHN_CH_YN	/*기기변경여부*/
                           , B2.MCHN_CH_TP_CD	/*기기변경유형코드*/
                           , B1.PERF_ATC_CD	/*실적항목코드*/
                           , B1.PERF_VAL
		                FROM
                           /*렌탈료*/
                           ( SELECT CNTR_NO
                                  , CNTR_SN
                                  , PRTNR_NO
                                  , 'W00P00031' AS PERF_ATC_CD
                                  , SUM(NVL(PERF_VAL, 0)) AS PERF_VAL
			                   FROM TB_FEAM_NTORP_CNTR_MM_CL	/*순주문파트너계약월마감*/
			                  WHERE DTA_DL_YN = 'N'
                                AND BASE_YM = #{perfYm}
                                AND PERF_YM = #{perfYm}
                                AND FEE_TCNT_DV_CD = '02'
                                AND CNTR_PERF_CRT_DV_CD = '01'	/*순주문집계*/
                                AND PERF_DV_CD = '0'	/*개인판매*/
                                AND PERF_AGRG_CRT_DV_CD = '301'	/*홈마스터순주문실적*/
                                AND CO_CD = '2000'	/*교원프라퍼티*/
                                AND OG_TP_CD = 'W03'	/*홈마스터*/
                                AND PRTNR_NO = #{no}
                                AND PERF_ATC_CD IN ('W00P00031', 'W00P00003', 'W00P00005')	/*메트리스렌탈료,환경가전렌탈료,환경가전정액*/
                              GROUP BY CNTR_NO, CNTR_SN, PRTNR_NO
                              UNION ALL
                                /*일시불*/
                             SELECT CNTR_NO
                                  , CNTR_SN
                                  , PRTNR_NO
                                  , 'W00P00004' AS PERF_ATC_CD
                                  , SUM(NVL(PERF_VAL, 0)) AS PERF_VAL
                               FROM TB_FEAM_NTORP_CNTR_MM_CL	/*순주문파트너계약월마감*/
                              WHERE DTA_DL_YN = 'N'
                                AND BASE_YM = #{perfYm}
                                AND PERF_YM = #{perfYm}
                                AND FEE_TCNT_DV_CD = '02'
                                AND CNTR_PERF_CRT_DV_CD = '01'	/*순주문집계*/
                                AND PERF_DV_CD = '0'	/*개인판매*/
                                AND PERF_AGRG_CRT_DV_CD = '301'	/*홈마스터순주문실적*/
                                AND CO_CD = '2000'	/*교원프라퍼티*/
                                AND OG_TP_CD = 'W03'	/*홈마스터*/
                                AND PRTNR_NO = #{no}
                                AND PERF_ATC_CD IN ('W00P00004', 'W00P00006')	/*환경가전일시불,환경외일시불*/
                              GROUP BY CNTR_NO, CNTR_SN, PRTNR_NO
			                  UNION ALL
			                    /*인정건수*/
                             SELECT CNTR_NO
                                  , CNTR_SN
                                  , PRTNR_NO
                                  , PERF_ATC_CD
                                  , NVL(PERF_VAL, 0) AS PERF_VAL
			                   FROM TB_FEAM_NTORP_CNTR_MM_CL	/*순주문파트너계약월마감*/
			                  WHERE DTA_DL_YN = 'N'
                                AND BASE_YM = #{perfYm}
                                AND PERF_YM = #{perfYm}
                                AND FEE_TCNT_DV_CD = '02'
                                AND CNTR_PERF_CRT_DV_CD = '01'	/*순주문집계*/
                                AND PERF_DV_CD = '0'	/*개인판매*/
                                AND PERF_AGRG_CRT_DV_CD = '301'	/*홈마스터순주문실적*/
                                AND CO_CD = '2000'	/*교원프라퍼티*/
                                AND OG_TP_CD = 'W03'	/*홈마스터*/
                                AND PRTNR_NO = #{no}
                                AND PERF_ATC_CD = 'W03P00002'
		                   ) B1
		               INNER JOIN TB_FEAM_WELS_NRCTR_MM_CL B2	/*웰스순주문계약월마감*/
		                  ON B2.FEE_TCNT_DV_CD = '02'
                         AND B1.CNTR_NO = B2.CNTR_NO
                         AND B1.CNTR_SN = B2.CNTR_SN
                         AND B2.CNTR_PERF_CRT_DV_CD ='01'
                         AND B2.DTA_DL_YN = 'N'
                       WHERE B2.SL_DT BETWEEN #{perfYm}||'01' AND #{perfYm}||'31'   /*매출일자가 당월인 것만 조회함. 1566 결함수정*/
	               ) A1
	            LEFT OUTER JOIN
		           ( SELECT B1.CNTR_NO
                          , B1.CNTR_CST_NO
                          , B2.CNTRW_TP_CD
		               FROM TB_SSCT_CNTR_BAS B1	/*계약기본*/
                      INNER JOIN TB_SSCT_CNTR_DTL B2 	/*계약상세*/
		                 ON B1.CNTR_NO = B2.CNTR_NO
		                AND B2.DTA_DL_YN = 'N'
		              WHERE B1.DTA_DL_YN = 'N'
			            AND B1.SELL_PRTNR_NO = #{no}
	               ) A2
	              ON A1.CNTR_NO = A2.CNTR_NO
             )
         PIVOT
             ( SUM(PERF_VAL) FOR PERF_ATC_CD IN
               ( 'W00P00031' AS PERF_RENTAL
               , 'W00P00004' AS PERF_SNGL_PMNT
               , 'W03P00002' AS PD_ACC_CNT )
             )
    </select>

    <select id='selectMngerBasic'
            resultType="com.kyowon.sms.wells.web.fee.confirm.dto.WfeeIndividualFeeDto$FindMngerBasicRes">
        SELECT T1.BASE_YM AS PERF_YM /* 실적년월 */
             , T1.OG_CD /* 조직코드 */
             , T1.DGR1_LEVL_OG_ID /* 1차레벨조직ID */
             , T1.DGR2_LEVL_OG_ID /* 2차레벨조직ID */
             , T1.DGR3_LEVL_OG_ID /* 3차레벨조직ID */
             , T1.DGR4_LEVL_OG_ID /* 4차레벨조직ID */
             , T1.DGR5_LEVL_OG_ID /* 5차레벨조직ID */
             , T2.PRTNR_NO /* 파트너번호 */
             , T2.PRTNR_KNM /* 파트너명 */
             , T2.RSB_DV_CD /* 직책구분코드 */
             , T3.INTBS_AMT /* 소득과표금액 */
             , T3.DDCTAM /* 공제금액 */
             , T3.DSB_OJ_AMT /* 지급대상금액 */
             , T4.BNK_NM /* 은행명 */
             , T4.ACNO_ENCR /* 계좌번호암호화 */
             , NVL(T5.MNGT_CT, 0) AS MNGT_CT /* 관리건수 */
             , NVL(T5.VST_CT, 0) AS VST_CT /* 방문건수 */
             , NVL(T5.PROCS_RT, 0) AS PROCS_RT /* 처리율 */
          FROM TB_OGBS_MM_OG_IZ T1 /* 월조직내역 */
         INNER JOIN TB_OGBS_MM_PRTNR_IZ T2 /* 월파트너내역 */
            ON T1.BASE_YM = T2.BASE_YM /* 기준년월 */
           AND T1.OG_TP_CD = T2.OG_TP_CD /* 조직유형코드 */
           AND T1.OG_ID = T2.OG_ID /* 조직ID */
           AND T2.DTA_DL_YN = 'N'
         INNER JOIN TB_FEAM_FEE_DSB_IZ T3 /* 수수료지급내역 */
            ON T2.BASE_YM = T3.DSB_YM /* 지급년월 */
           AND T2.OG_TP_CD = T3.OG_TP_CD /* 조직유형코드 */
           AND T2.PRTNR_NO = T3.PRTNR_NO /* 파트너번호 */
           AND T3.DTA_DL_YN = 'N'
           AND T3.FEE_TCNT_DV_CD = '02' /* 수수료차수구분코드 = 02 : 2차 */
           AND T3.INTBS_AMT > 0 /* 소득과표금액 */
           AND T3.SPMT_DSB_DV_CD = '01' /* 추가지급구분코드 = 01 : 정상지급 */
          LEFT OUTER JOIN
             (
               SELECT T1.OG_TP_CD               /* 조직유형코드 */
                    , T1.PRTNR_NO               /* 파트너번호 */
                    , T1.ACNO_ENCR            /* 계좌번호암호화 */
                    , T2.BNK_NM                 /* 은행명 */
                 FROM TB_OGBS_PRTNR_AC_BAS T1   /* 파트너계좌기본 */
                INNER JOIN TB_RVDW_FNIT_CD_USE_DV_IZ T2         /* 금융기관코드사용구분내역 */
                   ON T2.DTA_DL_YN = 'N'
                  AND T1.FNIT_CD = T2.FNIT_CD   /* 금융기관코드 */
                  AND T2.VNCO_DV_CD ='001'      /* VAN사구분코드 */
                  AND T2.BNK_BIZ_DV_CD='03' /* 수수료계좌 */
                  AND #{perfYm} || '01' BETWEEN T2.VL_STRTDT AND T2.VL_ENDDT    /* 유효시작일시, 유효종료일시 */
                WHERE 1=1
                  AND T1.DTA_DL_YN = 'N'
                  AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
                  AND T1.PRTNR_AC_USWY_CD = '1'  /* 파트너계좌기본 */
                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T1.VL_STRT_DTM AND T1.VL_END_DTM     /* 유효시작일시, 유효종료일시 */
                  AND T1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
             ) T4
            ON T3.OG_TP_CD = T4.OG_TP_CD
           AND T3.PRTNR_NO = T4.PRTNR_NO
          LEFT OUTER JOIN
             (
               SELECT SUM(DECODE(PRTNR_SV_PERF_ATC_CD, 'SV01999901', PERF_VAL, 0) - DECODE(PRTNR_SV_PERF_ATC_CD, 'SV01909001', PERF_VAL, 0)) AS MNGT_CT
                    , SUM(DECODE(PRTNR_SV_PERF_ATC_CD, 'SV01999902', PERF_VAL, 0) + DECODE(PRTNR_SV_PERF_ATC_CD, 'SV01999903', PERF_VAL, 0)) AS VST_CT
                    , ROUND(SUM(DECODE(PRTNR_SV_PERF_ATC_CD, 'SV01999902', PERF_VAL, 0) + DECODE(PRTNR_SV_PERF_ATC_CD, 'SV01999903', PERF_VAL, 0)) / SUM(DECODE(PRTNR_SV_PERF_ATC_CD, 'SV01999901', PERF_VAL, 0) - DECODE(PRTNR_SV_PERF_ATC_CD, 'SV01909001', PERF_VAL, 0)) * 100.0, 1) AS PROCS_RT
                    , #{prtnrNo} AS PRTNR_NO /* 파트너번호 */
                 FROM TB_FEAM_WPTN_SV_PERF_AGRG /* 웰스파트너서비스실적집계 */
                WHERE 1=1
                  AND DTA_DL_YN = 'N'
                  AND CL_DV_CD = '02' /* 마감구분코드 */
                  AND PRTNR_SV_PERF_ATC_CD IN ('SV01999901', 'SV01909001', 'SV01999902', 'SV01999903')
                  /*
                   * 파트너서비스실적항목코드
                   * SV01999901 : 방문(상품)-합계-합계-관리건수
                   * SV01909001 : 방문(상품)-취소-취소-관리건수
                   * SV01999902 : 방문(상품)-합계-합계-방문건수
                   * SV01999903 : 방문(상품)-합계-합계-전월건수
                   * */
                  AND BASE_YM = #{perfYm} /* 기준년월 */
                  AND OG_TP_CD = 'W02' /* 조직유형코드 */
                  AND PRTNR_NO = #{prtnrNo} /* 파트너번호 */
             ) T5
            ON T3.PRTNR_NO = T5.PRTNR_NO
         WHERE 1=1
           AND T1.DTA_DL_YN = 'N'
           AND T1.BASE_YM = #{perfYm} /* 기준년월 */
           AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
           AND T3.CO_CD = '2000' /* 회사코드 */
           AND T2.PRTNR_NO = #{prtnrNo}
    </select>

    <select id='selectMngerSellEtcs'
            resultType="com.kyowon.sms.wells.web.fee.confirm.dto.WfeeIndividualFeeDto$SearchMngerSellEtcsRes">
        WITH WITH_PERF AS
           (
             SELECT BASE_YM /* 기준년월 */
                  , PRTNR_NO /* 파트너번호 */
                  , PERF_ATC_CD /* 실적항목코드 */
                  , PERF_DV_CD /* 실적구분코드 */
                  , SUM(PERF_VAL) AS PERF_VAL /* 실적값 */
               FROM TB_FEAM_NTORP_PERF_MM_CL /* 순주문파트너실적월마감 */
              WHERE 1=1
                AND BASE_YM = #{perfYm} /* 기준년월 */
                AND PERF_YM = #{perfYm} /* 실적년월 */
                AND FEE_TCNT_DV_CD = '02' /* 수수료차수구분코드 */
                AND PERF_AGRG_CRT_DV_CD = '201' /* 실적집계생성구분코드 */
                AND OG_TP_CD = 'W02' /* 조직유형코드 */
                AND PRTNR_NO = #{prtnrNo} /* 파트너번호 */
                AND DTA_DL_YN = 'N'
              GROUP BY BASE_YM, PRTNR_NO, PERF_ATC_CD, PERF_DV_CD
           )

      SELECT '가전인정건수' AS PERF_ITEM1
           , '가전인정건수' AS PERF_ITEM2
           , '개인BS완료' AS PERF_ITEM3
           , '정액건수' AS PERF_ITEM4
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W00P00011' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL1 /* 개인실적-가전인정건수 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W00P00011' AND T2.PERF_DV_CD = 2 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL2 /* 조직실적-가전인정건수 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W02P00085' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL3 /* BS실적-개인BS완료 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W00P00005' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL4 /* 기타-정액건수 */
        FROM TB_OGBS_MM_PRTNR_IZ T1 /* 월파트너내역 */
       INNER JOIN WITH_PERF T2
          ON T1.BASE_YM = T2.BASE_YM /* 기준년월 */
         AND T1.PRTNR_NO = T2.PRTNR_NO /* 파트너번호 */
       WHERE 1=1
         AND T1.BASE_YM = #{perfYm} /* 기준년월 */
         AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
         AND T1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
       GROUP BY T1.PRTNR_NO, T1.PRTNR_KNM, T1.OG_CD

       UNION ALL

      SELECT '렌탈기준가' AS PERF_ITEM1
           , '렌탈기준가' AS PERF_ITEM2
           , 'W1급지' AS PERF_ITEM3
           , '재약정건수' AS PERF_ITEM4
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W00P00003' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL1 /* 개인실적-렌탈기준가 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W00P00003' AND T2.PERF_DV_CD = 2 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL2 /* 조직실적-렌탈기준가 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W02P00121' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL3 /* BS실적-W1급지 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W00P00057' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL4 /* 기타-재약정건수 */
        FROM TB_OGBS_MM_PRTNR_IZ T1 /* 월파트너내역 */
       INNER JOIN WITH_PERF T2
          ON T1.BASE_YM = T2.BASE_YM /* 기준년월 */
         AND T1.PRTNR_NO = T2.PRTNR_NO /* 파트너번호 */
       WHERE 1=1
         AND T1.BASE_YM = #{perfYm} /* 기준년월 */
         AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
         AND T1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
       GROUP BY T1.PRTNR_NO, T1.PRTNR_KNM, T1.OG_CD

       UNION ALL

      SELECT '일시불기준가' AS PERF_ITEM1
           , '일시불기준가' AS PERF_ITEM2
           , 'W2급지' AS PERF_ITEM3
           , '라이브팩' AS PERF_ITEM4
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W00P00004' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL1 /* 개인실적-일시불기준가 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W00P00004' AND T2.PERF_DV_CD = 2 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL2 /* 조직실적-일시불기준가 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W02P00122' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL3 /* BS실적-W2급지 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W02P00105' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL4 /* 기타-라이브팩 */
        FROM TB_OGBS_MM_PRTNR_IZ T1 /* 월파트너내역 */
       INNER JOIN WITH_PERF T2
          ON T1.BASE_YM = T2.BASE_YM /* 기준년월 */
         AND T1.PRTNR_NO = T2.PRTNR_NO /* 파트너번호 */
       WHERE 1=1
         AND T1.BASE_YM = #{perfYm} /* 기준년월 */
         AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
         AND T1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
       GROUP BY T1.PRTNR_NO, T1.PRTNR_KNM, T1.OG_CD

       UNION ALL

      SELECT '가전외인정실적' AS PERF_ITEM1
           , '가전외인정실적' AS PERF_ITEM2
           , '조직BS완료' AS PERF_ITEM3
           , '멤버십' AS PERF_ITEM4
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W02P00112' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL1 /* 개인실적-가전외인정실적 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W02P00112' AND T2.PERF_DV_CD = 2 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL2 /* 조직실적-가전외인정실적 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W02P00085' AND T2.PERF_DV_CD = 2 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL3 /* BS실적-조직BS완료 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W02P00086' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL4 /* 기타-멤버십 */
        FROM TB_OGBS_MM_PRTNR_IZ T1 /* 월파트너내역 */
       INNER JOIN WITH_PERF T2
          ON T1.BASE_YM = T2.BASE_YM /* 기준년월 */
         AND T1.PRTNR_NO = T2.PRTNR_NO /* 파트너번호 */
       WHERE 1=1
         AND T1.BASE_YM = #{perfYm} /* 기준년월 */
         AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
         AND T1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
       GROUP BY T1.PRTNR_NO, T1.PRTNR_KNM, T1.OG_CD

       UNION ALL

      SELECT '기변' AS PERF_ITEM1
           , '기변' AS PERF_ITEM2
           , '' AS PERF_ITEM3
           , '' AS PERF_ITEM4
           , MAX(CASE WHEN T2.PERF_ATC_CD IN ('W00P00014', 'W00P00018') AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL1 /* 개인실적-기변 */
           , MAX(CASE WHEN T2.PERF_ATC_CD IN ('W00P00014', 'W00P00018') AND T2.PERF_DV_CD = 2 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL2 /* 조직실적-기변 */
           , NULL AS PERF_VAL3
           , NULL AS PERF_VAL4
        FROM TB_OGBS_MM_PRTNR_IZ T1 /* 월파트너내역 */
       INNER JOIN WITH_PERF T2
          ON T1.BASE_YM = T2.BASE_YM /* 기준년월 */
         AND T1.PRTNR_NO = T2.PRTNR_NO /* 파트너번호 */
       WHERE 1=1
         AND T1.BASE_YM = #{perfYm} /* 기준년월 */
         AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
         AND T1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
       GROUP BY T1.PRTNR_NO, T1.PRTNR_KNM, T1.OG_CD

       UNION ALL

      SELECT '순증' AS PERF_ITEM1
           , '순증' AS PERF_ITEM2
           , '' AS PERF_ITEM3
           , '' AS PERF_ITEM4
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W02P00113' AND T2.PERF_DV_CD = 0 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL1 /* 개인실적-순증 */
           , MAX(CASE WHEN T2.PERF_ATC_CD = 'W02P00113' AND T2.PERF_DV_CD = 2 THEN T2.PERF_VAL ELSE 0 END) AS PERF_VAL2 /* 조직실적-순증 */
           , NULL AS PERF_VAL3
           , NULL AS PERF_VAL4
        FROM TB_OGBS_MM_PRTNR_IZ T1 /* 월파트너내역 */
       INNER JOIN WITH_PERF T2
          ON T1.BASE_YM = T2.BASE_YM /* 기준년월 */
         AND T1.PRTNR_NO = T2.PRTNR_NO /* 파트너번호 */
       WHERE 1=1
         AND T1.BASE_YM = #{perfYm} /* 기준년월 */
         AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
         AND T1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
       GROUP BY T1.PRTNR_NO, T1.PRTNR_KNM, T1.OG_CD
    </select>

    <select id='selectMngerBeforeServices'
            resultType="com.kyowon.sms.wells.web.fee.confirm.dto.WfeeIndividualFeeDto$SearchMngerBeforeServiceRes">
        SELECT CD_NM AS CD_NM /* 상품명 */
             , MAX(GE_MNGT_CT) AS GE_MNGT_CT /* 일반-관리건수 */
             , MAX(GE_VST_CT) AS GE_VST_CT /* 일반-방문건수 */
             , MAX(GE_AMT) AS GE_AMT /* 일반-금액 */
             , MAX(FXAM_MNGT_CT) AS FXAM_MNGT_CT /* 정액-관리건수 */
             , MAX(FXAM_VST_CT) AS FXAM_VST_CT /* 정액-방문건수 */
             , MAX(FXAM_AMT) AS FXAM_AMT /* 정액-금액 */
             , MAX(GE_AMT) + MAX(FXAM_AMT) AS SUM_AMT /* 합계 */
          FROM
             (
               SELECT CD_NM /* 상품명 */
                    , SV_CD
                    , SV_CD2
                    , NVL(SUM(GE_MNGT_CT),0) AS GE_MNGT_CT /* 일반-관리건수 */
                    , NVL(SUM(GE_VST_CT),0) + NVL(SUM(GE_LSTMM_VST_CT),0) AS GE_VST_CT /* 일반-방문건수 */
                    , NVL(SUM(GE_AMT),0) AS GE_AMT /* 일반-금액 */
                    , 0 AS FXAM_MNGT_CT /* 정액-관리건수 */
                    , 0 AS FXAM_VST_CT /* 정액-방문건수 */
                    , 0 AS FXAM_AMT /* 정액-금액 */
                 FROM
                    (
                      SELECT S2.PRTNR_PERF_DTLP_ATC_CDN2 AS CD_NM /* 파트너실적세부항목코드값명2 */
                           , S2.PRTNR_PERF_DTLP_ATC_CDV1 || S2.PRTNR_PERF_DTLP_ATC_CDV2 AS SV_CD /* 파트너실적세부항목코드값1, 파트너실적세부항목코드값2 */
                           , S2.PRTNR_PERF_DTLP_ATC_CDV2 AS SV_CD2 /* 파트너실적세부항목코드값2 */
                           , CASE WHEN S2.PRTNR_PERF_DTLP_ATC_CDV4 = '01' THEN S1.PERF_VAL END AS GE_MNGT_CT /* 01 : 배정 */
                           , CASE WHEN S2.PRTNR_PERF_DTLP_ATC_CDV4 = '02' THEN S1.PERF_VAL END AS GE_VST_CT /* 02 : 당월방문 */
                           , CASE WHEN S2.PRTNR_PERF_DTLP_ATC_CDV4 = '03' THEN S1.PERF_VAL END AS GE_LSTMM_VST_CT /* 03 : 전월방문 */
                           , CASE WHEN S2.PRTNR_PERF_DTLP_ATC_CDV4 = '04' THEN S1.PERF_VAL END AS GE_AMT /* 04 : 금액 */
                        FROM TB_FEAM_WPTN_SV_PERF_AGRG S1 /* 웰스파트너서비스실적집계 */
                       INNER JOIN TB_FEAM_WPTN_SV_PERF_ATC_CD S2 /* 웰스파트너서비스실적항목코드 */
                          ON S1.PRTNR_SV_PERF_ATC_CD = S2.PRTNR_SV_PERF_ATC_CD /* 파트너서비스실적항목코드 */
                         AND SUBSTR(S2.PRTNR_SV_PERF_ATC_CD,1,4) = CASE WHEN S1.BASE_YM <![CDATA[<]]> '202207' THEN 'SV01' ELSE 'SV08' END /* 202207년 이후는 구분코드 08 */
                         AND S2.PRTNR_PERF_DTLP_ATC_CDV3 = '01' /* 파트너실적세부항목코드값3 = 01 : 일반 */
                         AND S2.PRTNR_PERF_DTLP_ATC_CDV2 != '99' /* 파트너실적세부항목코드값2 */
                         AND S2.DTA_DL_YN = 'N'
                       WHERE 1=1
                         AND S1.BASE_YM = #{perfYm} /* 기준년월 */
                         AND S1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
                         AND S1.CL_DV_CD = '02' /* 마감구분코드 */
                         AND S1.OG_TP_CD = 'W02' /* 조직유형코드 */
                         AND S1.DTA_DL_YN = 'N'
                    )
                GROUP BY CD_NM, SV_CD, SV_CD2

                UNION ALL

               SELECT CD_NM /* 상품명 */
                    , SV_CD
                    , SV_CD2
                    , 0 AS GE_MNGT_CT /* 일반-관리건수 */
                    , 0 AS GE_VST_CT /* 일반-방문건수 */
                    , 0 AS GE_AMT /* 일반-금액 */
                    , CASE WHEN BASE_YM <![CDATA[<]]> '202207' THEN 0 ELSE NVL(SUM(FXAM_MNGT_CT),0) END AS FXAM_MNGT_CT /* 정액-관리건수 202007 이전은 정액 0원 */
                    , CASE WHEN BASE_YM <![CDATA[<]]> '202207' THEN 0 ELSE NVL(SUM(FXAM_VST_CT),0) + NVL(SUM(FXAM_LSTMM_VST_CT),0) END AS FXAM_VST_CT /* 정액-방문건수 */
                    , CASE WHEN BASE_YM <![CDATA[<]]> '202207' THEN 0 ELSE NVL(SUM(FXAM_AMT),0) END AS FXAM_AMT /* 정액-금액 */
                 FROM
                    (
                      SELECT S2.PRTNR_PERF_DTLP_ATC_CDN2 AS CD_NM /* 파트너실적세부항목코드값명2 */
                           , PRTNR_PERF_DTLP_ATC_CDV1 || PRTNR_PERF_DTLP_ATC_CDV2 AS SV_CD /* 파트너실적세부항목코드값1, 파트너실적세부항목코드값2 */
                           , PRTNR_PERF_DTLP_ATC_CDV2 AS SV_CD2 /* 파트너실적세부항목코드값2 */
                           , S1.BASE_YM /* 기준년월 */
                           , CASE WHEN S2.PRTNR_PERF_DTLP_ATC_CDV4 = '01' THEN S1.PERF_VAL END AS FXAM_MNGT_CT /* 01 : 배정 */
                           , CASE WHEN S2.PRTNR_PERF_DTLP_ATC_CDV4 = '02' THEN S1.PERF_VAL END AS FXAM_VST_CT /* 02 : 당월방문 */
                           , CASE WHEN S2.PRTNR_PERF_DTLP_ATC_CDV4 = '03' THEN S1.PERF_VAL END AS FXAM_LSTMM_VST_CT /* 03 : 전월방문 */
                           , CASE WHEN S2.PRTNR_PERF_DTLP_ATC_CDV4 = '04' THEN S1.PERF_VAL END AS FXAM_AMT /* 04 : 금액 */
                        FROM TB_FEAM_WPTN_SV_PERF_AGRG S1 /* 웰스파트너서비스실적집계 */
                       INNER JOIN TB_FEAM_WPTN_SV_PERF_ATC_CD S2 /* 웰스파트너서비스실적항목코드 */
                          ON S1.PRTNR_SV_PERF_ATC_CD = S2.PRTNR_SV_PERF_ATC_CD /* 파트너서비스실적항목코드 */
                         AND SUBSTR(S2.PRTNR_SV_PERF_ATC_CD, 1, 4) = 'SV08'
                         AND S2.PRTNR_PERF_DTLP_ATC_CDV3 = '02' /* 파트너실적세부항목코드값3 = 03 : 정액 */
                         AND S2.PRTNR_PERF_DTLP_ATC_CDV2 != '99' /* 파트너실적세부항목코드값2 */
                         AND S2.DTA_DL_YN = 'N'
                       WHERE 1=1
                         AND S1.BASE_YM = #{perfYm} /* 기준년월 */
                         AND S1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
                         AND S1.CL_DV_CD = '02' /* 마감구분코드 */
                         AND S1.OG_TP_CD = 'W02' /* 조직유형코드 */
                         AND S1.DTA_DL_YN = 'N'
                    )
                GROUP BY CD_NM, BASE_YM, SV_CD, SV_CD2
             )
         GROUP BY CD_NM, SV_CD, SV_CD2
         ORDER BY SV_CD2
    </select>

    <select id='selectMngerFees'
            resultType="com.kyowon.sms.wells.web.fee.confirm.dto.WfeeIndividualFeeDto$SearchMngerFeeRes">
        WITH WITH_FEE_CD AS
           (
             SELECT FEE_CD /* 수수료코드 */
                  , DTA_CRT_FEE_CD /* 데이터생성수수료코드 */
                  , SRN_MARK_FEE_NM /* 화면표시수수료명 */
               FROM
                  (
                    SELECT FEE_CD /* 수수료코드 */
                         , DTA_CRT_FEE_CD /* 데이터생성수수료코드 */
                         , SRN_MARK_ODR_SN /* 화면표시순서일련번호 */
                         , SRN_MARK_FEE_NM /* 화면표시수수료명 */
                         , ROW_NUMBER() OVER (PARTITION BY DTA_CRT_FEE_CD ORDER BY FEE_CD) AS RN
                      FROM
                         (
                           SELECT T1.FEE_CD /* 수수료코드 */
                                , T1.DTA_CRT_FEE_CD /* 데이터생성수수료코드 */
                                , T2.APY_TN AS APY_TN /* 적용회차 */
                                , T2.FEE_OJ_EXR_CNDT_CN /* 수수료대상추출조건내용 */
                                , NVL(T1.SRN_MARK_ODR_SN, 0) AS SRN_MARK_ODR_SN /* 화면표시순서일련번호 */
                                , NVL(T2.SRN_MARK_FEE_NM, T1.BAS_SRN_MARK_FEE_NM) AS SRN_MARK_FEE_NM /* 화면표시수수료명, 기본화면표시수수료명 */
                             FROM TB_FEAM_FEE_CD T1 /* 수수료코드 */
                             LEFT OUTER JOIN TB_FEAM_FEE_BASE_DTL T2 /* 수수료기준상세 */
                               ON T1.FEE_CD = T2.FEE_CD /* 수수료코드 */
                              AND #{dto.perfYm} BETWEEN T2.APY_STRT_YM AND T2.APY_END_YM /* 적용시작년월, 적용종료년월 */
                              AND T2.FEE_BASE_STAT_CD = '02' /* 수수료기준상태코드 */
                              AND T2.DTA_DL_YN = 'N'
                             LEFT OUTER JOIN TB_FEAM_FEE_CD_DTL T3 /* 수수료코드상세 */
                               ON T1.FEE_CD = T3.FEE_CD /* 수수료코드 */
                              AND T3.DTA_DL_YN = 'N'
                            WHERE 1=1
                              AND T1.OG_TP_CD = 'W02' /* 조직유형코드 */
                              AND #{dto.perfYm} BETWEEN T1.APY_STRT_YM AND T1.APY_END_YM /* 적용시작년월, 적용종료년월 */
                              AND T1.DTA_DL_YN = 'N'
                              AND T1.FEE_CALC_UNIT_TP_CD IN /* 수수료계산단위유형코드 */
                                (
                                  SELECT CASE WHEN RSB_DV_CD = 'W0205' THEN '201'
                                              WHEN RSB_DV_CD = 'W0204' THEN '202'
                                         END AS RSB_DV_CD /* 직책구분코드 */
                                    FROM TB_OGBS_MM_PRTNR_IZ /* 월파트너내역 */
                                   WHERE 1=1
                                     AND BASE_YM = #{dto.perfYm} /* 기준년월 */
                                     AND OG_TP_CD = 'W02' /* 조직유형코드 */
                                     AND PRTNR_NO = #{dto.prtnrNo} /* 파트너번호 */
                                )
                              AND T3.FEE_ATC_TP_CD = #{feeAtcTpCd} /* 수수료항목유형코드 */
                         )
                  )
              WHERE RN = 1
              ORDER BY SRN_MARK_ODR_SN
           )
      SELECT T1.SRN_MARK_FEE_NM AS SRN_MARK_FEE_NM /* 화면표시수수료명 */
           , NVL(T2.FEE_ATC_VAL, 0) AS FEE_ATC_VAL /* 수수료항목값 */
        FROM WITH_FEE_CD T1
        LEFT OUTER JOIN
           (
             SELECT T2.FEE_CD /* 수수료코드 */
                  , T1.PRTNR_NO /* 파트너번호 */
                  , T2.FEE_ATC_VAL /* 수수료항목값 */
               FROM TB_FEAM_FEE_DSB_IZ T1                 /* 수수료지급내역 */
              INNER JOIN TB_FEAM_FEE_DSB_DTL_IZ T2           /* 수수료지급상세내역 */
                 ON T1.DSB_YM = T2.DSB_YM                   /* 지급년월 */
                AND T1.CO_CD = T2.CO_CD                    /* 회사코드 */
                AND T1.OG_TP_CD = T2.OG_TP_CD              /* 조직유형코드 */
                AND T1.PRTNR_NO = T2.PRTNR_NO              /* 파트너번호 */
                AND T1.FEE_TCNT_DV_CD = T2.FEE_TCNT_DV_CD  /* 수수료차수구분코드 */
                AND T1.SPMT_DSB_DV_CD = T2.SPMT_DSB_DV_CD  /* 추가지급구분코드 */
                AND T2.DTA_DL_YN = 'N'
              WHERE 1=1
                AND T1.DSB_YM          = #{dto.perfYm}       /* 지급년월 */
                AND T1.FEE_TCNT_DV_CD  = '02'           /* 수수료차수구분코드 */
                AND T1.OG_TP_CD        = 'W02'         /* 조직유형코드 */
                AND T1.CO_CD           = '2000'         /* 회사코드 */
                AND T1.PRTNR_NO        = #{dto.prtnrNo}      /* 파트너번호 */
                AND T2.FEE_ATC_DV_CD   = '01'           /* 수수료항목구분코드 = 01 : 수수료 */
                AND T2.FEE_ATC_VAL      > 0             /* 수수료항목값 */
           ) T2
          ON T1.FEE_CD = T2.FEE_CD
       WHERE 1=1
    </select>

    <select id='selectMngerDeduction'
            resultType="com.kyowon.sms.wells.web.fee.confirm.dto.WfeeIndividualFeeDto$SearchMngerDeductionRes">
        SELECT F_CMZ_CD_NM('TNT_WELLS', 'FEE_DDTN_TP_CD', T2.FEE_DDTN_TP_CD) AS FEE_ATC_ITEM /* 공제코드 명 */
             , T2.FEE_ATC_VAL /* 수수료항목값 */
          FROM TB_FEAM_FEE_DSB_IZ T1                 /* 수수료지급내역 */
         INNER JOIN TB_FEAM_FEE_DSB_DTL_IZ T2           /* 수수료지급상세내역 */
            ON T1.DSB_YM = T2.DSB_YM                   /* 지급년월 */
           AND T1.CO_CD = T2.CO_CD                    /* 회사코드 */
           AND T1.OG_TP_CD = T2.OG_TP_CD              /* 조직유형코드 */
           AND T1.PRTNR_NO = T2.PRTNR_NO              /* 파트너번호 */
           AND T1.FEE_TCNT_DV_CD = T2.FEE_TCNT_DV_CD  /* 수수료차수구분코드 */
           AND T1.SPMT_DSB_DV_CD = T2.SPMT_DSB_DV_CD  /* 추가지급구분코드 */
           AND T2.DTA_DL_YN = 'N'
         WHERE 1=1
           AND T1.DTA_DL_YN       = 'N'
           AND T1.DSB_YM          = #{perfYm}      /* 지급년월 */
           AND T1.FEE_TCNT_DV_CD  = '02'           /* 수수료차수구분코드 */
           AND T1.OG_TP_CD        = 'W02'         /* 조직유형코드 */
           AND T1.CO_CD           = '2000'         /* 회사코드 */
           AND T1.PRTNR_NO        = #{prtnrNo}      /* 파트너번호 */
           AND T2.FEE_ATC_DV_CD   = '02'           /* 수수료항목구분코드 = 02 : 공제 */
           AND T2.FEE_ATC_VAL     <![CDATA[>]]> 0  /* 수수료항목값 */
         ORDER BY T2.FEE_DDTN_TP_CD
    </select>

    <select id='selectMngerPnpyams'
            resultType="com.kyowon.sms.wells.web.fee.confirm.dto.WfeeIndividualFeeDto$SearchMngerPnpyamRes">
        SELECT PNPYAM_ATC_CD_NM  /* 가지급금 항목명 */
             , BFMN_BLNC  /* 전월잔액 */
             , THMN_OCCR  /* 당월발생 */
             , THMN_SUM  /* 당월합계 */
             , THMN_DCTN  /* 당월공제 */
             , THMN_BLNC  /* 당월잔액 */
          FROM
             (
               SELECT S1.PRTNR_NO
                    , F_CMZ_CD_NM('TNT_EDU', 'PNPYAM_ATC_CD', S1.PNPYAM_ATC_CD) AS PNPYAM_ATC_CD_NM /* 가지급금 항목명 */
                    , NVL(S4.OC_PNPYAM_OC_AMT, 0) - NVL(S5.OC_PNPYAM_DDCTAM, 0) AS BFMN_BLNC  /* 전월잔액 */
                    , NVL(S3.MM_PNPYAM_OC_AMT, 0)                               AS THMN_OCCR  /* 당월발생 */
                    , (NVL(S4.OC_PNPYAM_OC_AMT, 0) - NVL(S5.OC_PNPYAM_DDCTAM, 0)) + NVL(S3.MM_PNPYAM_OC_AMT, 0) AS THMN_SUM  /* 당월합계 */
                    , NVL(S2.MM_PNPYAM_DDCTAM, 0)                               AS THMN_DCTN  /* 당월공제 */
                    , ((NVL(S4.OC_PNPYAM_OC_AMT, 0) - NVL(S5.OC_PNPYAM_DDCTAM, 0)) + NVL(S3.MM_PNPYAM_OC_AMT, 0)) - NVL(S2.MM_PNPYAM_DDCTAM, 0) AS THMN_BLNC  /* 당월잔액 */
                    , S1.DDTN_APY_ODR
                 FROM
                    (
                      SELECT T1.PRTNR_NO /* 파트너번호 */
                           , T1.OG_TP_CD /* 조직유형코드 */
                           , T2.PNPYAM_ATC_CD /* 가지급금항목코드 */
                           , T2.DDTN_APY_ODR /* 공제적용순서 */
                        FROM TB_OGBS_MM_PRTNR_IZ T1 /* 월파트너내역 */
                       INNER JOIN TB_FEDD_PNPYAM_CD T2 /* 가지급금코드 */
                          ON T1.OG_TP_CD = T2.OG_TP_CD /* 조직유형코드 */
                         AND T2.DTA_DL_YN = 'N'
                       WHERE 1=1
                         AND T1.BASE_YM = #{perfYm} /* 기준년월 */
                         AND T1.OG_TP_CD = 'W02'/* 조직유형코드 */
                         AND T1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
                    ) S1
                 LEFT OUTER JOIN
                    (
                      SELECT PRTNR_NO                                /* 파트너번호 */
                           , OG_TP_CD                                /* 조직유형코드 */
                           , PNPYAM_ATC_CD                           /* 가지급금항목코드 */
                           , SUM(PNPYAM_DDCTAM) AS MM_PNPYAM_DDCTAM  /* 가지급금공제금액 */
                        FROM TB_FEDD_PNPY_DDTN_IZ  /* 가지급공제내역 */
                       WHERE 1=1
                         AND PRTNR_NO = #{prtnrNo}  /* 파트너번호 */
                         AND OG_TP_CD = 'W02' /* 조직유형코드 */
                         AND PNPYAM_DDCTAM <![CDATA[>]]> 0  /* 가지급금공제금액 */
                         AND DDTN_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{perfYm}, 'YYYYMM'), 1), 'YYYYMM')  /* 공제년월 */
                         AND PNPY_DDTN_TP_CD = '1' /* 가지급공제유형코드 */
                       GROUP BY PRTNR_NO, OG_TP_CD, PNPYAM_ATC_CD
                       ORDER BY TO_NUMBER(PNPYAM_ATC_CD) ASC
                    ) S2  /* 당월 가지급금 공제 */
                   ON S1.PRTNR_NO = S2.PRTNR_NO
                  AND S1.OG_TP_CD = S2.OG_TP_CD
                  AND S1.PNPYAM_ATC_CD = S2.PNPYAM_ATC_CD
                 LEFT OUTER JOIN
                    (
                      SELECT PRTNR_NO                                /* 파트너번호 */
                           , OG_TP_CD                                /* 조직유형코드 */
                           , PNPYAM_ATC_CD                           /* 가지급금항목코드 */
                           , SUM(PNPYAM_OC_AMT) AS MM_PNPYAM_OC_AMT  /* 가지급금발생금액 */
                        FROM TB_FEDD_PNPY_OC_BAS  /* 가지급발생기본 */
                       WHERE 1=1
                         AND PRTNR_NO = #{prtnrNo}  /* 파트너번호 */
                         AND OG_TP_CD = 'W02' /* 조직유형코드 */
                         AND PNPYAM_OC_AMT <![CDATA[>]]> 0  /* 가지급금발생금액 */
                         AND PNPYAM_OC_YM = #{perfYm}  /* 가지급금발생년월 */
                         AND PNPY_OC_TP_CD = '1' /* 가지급발생유형코드 */
                       GROUP BY PRTNR_NO, OG_TP_CD, PNPYAM_ATC_CD
                       ORDER BY TO_NUMBER(PNPYAM_ATC_CD) ASC
                    ) S3  /* 당월 가지급금 발생 */
                   ON S1.PRTNR_NO = S3.PRTNR_NO
                  AND S1.OG_TP_CD = S3.OG_TP_CD
                  AND S1.PNPYAM_ATC_CD = S3.PNPYAM_ATC_CD
                 LEFT OUTER JOIN
                    (
                      SELECT PRTNR_NO                                /* 파트너번호 */
                           , OG_TP_CD                                 /* 조직유형코드 */
                           , PNPYAM_ATC_CD                            /* 가지급금항목코드 */
                           , SUM(PNPYAM_OC_AMT)  AS OC_PNPYAM_OC_AMT  /* 가지급금발생금액 */
                        FROM TB_FEDD_PNPY_OC_BAS  /* 가지급발생기본 */
                       WHERE 1=1
                         AND PRTNR_NO = #{prtnrNo}  /* 파트너번호 */
                         AND OG_TP_CD = 'W02'  /* 조직유형코드 */
                         AND PNPYAM_OC_AMT <![CDATA[>]]> 0  /* 가지급금발생금액 */
                         AND PNPYAM_OC_YM <![CDATA[<]]> #{perfYm}  /* 가지급금발생년월 */
                       GROUP BY PNPYAM_ATC_CD, OG_TP_CD, PRTNR_NO
                       ORDER BY TO_NUMBER(PNPYAM_ATC_CD) ASC
                    ) S4  /* 전월 가지급금 발생내역합계 */
                   ON S1.PRTNR_NO = S4.PRTNR_NO
                  AND S1.OG_TP_CD = S4.OG_TP_CD
                  AND S1.PNPYAM_ATC_CD = S4.PNPYAM_ATC_CD
                 LEFT OUTER JOIN
                    (
                      SELECT PRTNR_NO                               /* 파트너번호 */
                           , OG_TP_CD                                /* 조직유형코드 */
                           , PNPYAM_ATC_CD                           /* 가지급금항목코드 */
                           , SUM(PNPYAM_DDCTAM) AS OC_PNPYAM_DDCTAM  /* 가지급금공제금액 */
                        FROM TB_FEDD_PNPY_DDTN_IZ  /* 가지급공제내역 */
                       WHERE 1=1
                         AND PRTNR_NO = #{prtnrNo}  /* 파트너번호 */
                         AND OG_TP_CD = 'W02' /* 조직유형코드 */
                         AND PNPYAM_DDCTAM <![CDATA[>]]> 0  /* 가지급금공제금액 */
                         AND DDTN_YM <![CDATA[<]]> TO_CHAR(ADD_MONTHS(TO_DATE(#{perfYm}, 'YYYYMM'), 1), 'YYYYMM') /* 공제년월 */
                       GROUP BY PNPYAM_ATC_CD, OG_TP_CD, PRTNR_NO
                       ORDER BY TO_NUMBER(PNPYAM_ATC_CD) ASC
                    ) S5  /* 전월 가지급금 공제내역합계 */
                   ON S1.PRTNR_NO = S5.PRTNR_NO
                  AND S1.OG_TP_CD = S5.OG_TP_CD
                  AND S1.PNPYAM_ATC_CD = S5.PNPYAM_ATC_CD
             ) M
         WHERE 1=1
           AND M.THMN_DCTN <![CDATA[>]]> 0
         ORDER BY M.DDTN_APY_ODR
    </select>

    <select id='selectFees'
            resultType="com.kyowon.sms.wells.web.fee.confirm.dto.WfeeIndividualFeeDto$SearchFeeRes">
        SELECT T1.BASE_YM /* 기준년월 */
             , T1.DGR1_LEVL_OG_ID /* 1차레벨조직ID */
             , T1.DGR1_LEVL_OG_CD /* 1차레벨조직코드 */
             , T1.DGR1_LEVL_OG_NM /* 1차레벨조직명 */
             , T1.DGR1_LEVL_DG_PRTNR_NO /* 1차레벨대표파트너번호 */
             , T1.DGR1_LEVL_DG_PRTNR_NM /* 1차레벨대표파트너명 */
             , T1.DGR2_LEVL_OG_ID /* 2차레벨조직ID */
             , T1.DGR2_LEVL_OG_CD /* 2차레벨조직코드 */
             , T1.DGR2_LEVL_OG_NM /* 2차레벨조직명 */
             , T1.DGR2_LEVL_DG_PRTNR_NO /* 2차레벨대표파트너번호 */
             , T1.DGR2_LEVL_DG_PRTNR_NM /* 2차레벨대표파트너명 */
             , T1.DGR3_LEVL_OG_ID /* 3차레벨조직ID */
             , T1.DGR3_LEVL_OG_CD /* 3차레벨조직코드 */
             , T1.DGR3_LEVL_OG_NM /* 3차레벨조직명 */
             , T1.DGR3_LEVL_DG_PRTNR_NO /* 3차레벨대표파트너번호 */
             , T1.DGR3_LEVL_DG_PRTNR_NM /* 3차레벨대표파트너명 */
             , T1.DGR4_LEVL_OG_ID /* 4차레벨조직ID */
             , T1.DGR4_LEVL_OG_CD /* 4차레벨조직코드 */
             , T1.DGR4_LEVL_OG_NM /* 4차레벨조직명 */
             , T1.DGR4_LEVL_DG_PRTNR_NO /* 4차레벨대표파트너번호 */
             , T1.DGR4_LEVL_DG_PRTNR_NM /* 4차레벨대표파트너명 */
             , T1.DGR5_LEVL_OG_ID /* 5차레벨조직ID */
             , T1.DGR5_LEVL_OG_CD /* 5차레벨조직코드 */
             , T1.DGR5_LEVL_OG_NM /* 5차레벨조직명 */
             , T1.DGR5_LEVL_DG_PRTNR_NO /* 5차레벨대표파트너번호 */
             , T1.DGR5_LEVL_DG_PRTNR_NM /* 5차레벨대표파트너명 */
             , T1.OG_CD /* 조직코드 */
             , T2.PRTNR_NO /* 파트너번호 */
             , T2.PRTNR_KNM /* 파트너명 */
             , T2.RSB_DV_CD /* 직책구분코드 */
             , T2.QLF_DV_CD /* 자격구분코드 */
             , T3.CO_CD /* 회사코드 */
             , T4.PYMDT /* 지급일자 */
             , NVL(T3.INTBS_AMT, 0) AS INTBS_AMT /* 소득과표금액 */
             , NVL(T3.DDCTAM, 0) AS DDCTAM /* 공제금액 */
             , NVL(T3.DSB_OJ_AMT, 0) AS DSB_OJ_AMT /* 지급대상금액 */
             , NVL(T5.AWD_INTBS_AMT, 0) AS AWD_INTBS_AMT /* 시상소득과표금액 */
             , NVL(T5.AWD_ERN_WHTX, 0) AS AWD_ERN_WHTX /* 시상소득원천세 */
             , NVL(T5.AWD_DSB_OJ_AMT, 0) AS AWD_DSB_OJ_AMT /* 시상실지급액 */
             , T6.BNK_NM /* 은행명 */
             , T6.ACNO_ENCR /* 계좌번호암호화 */
          FROM TB_OGBS_MM_OG_IZ T1 /* 월조직내역 */
         INNER JOIN TB_OGBS_MM_PRTNR_IZ T2 /* 월파트너내역 */
            ON T1.BASE_YM = T2.BASE_YM /* 기준년월 */
           AND T1.OG_TP_CD = T2.OG_TP_CD /* 조직유형코드 */
           AND T1.OG_ID = T2.OG_ID /* 조직ID */
           AND T2.DTA_DL_YN = 'N'
         INNER JOIN TB_FEAM_FEE_DSB_IZ T3 /* 수수료지급내역 */
            ON T2.BASE_YM = T3.DSB_YM /* 지급년월 */
           AND T2.OG_TP_CD = T3.OG_TP_CD /* 조직유형코드 */
           AND T2.PRTNR_NO = T3.PRTNR_NO /* 파트너번호 */
           AND T3.DTA_DL_YN = 'N'
           AND T3.FEE_TCNT_DV_CD = '02' /* 수수료차수구분코드 = 02 : 2차 */
           AND T3.INTBS_AMT > 0 /* 소득과표금액 */
           AND T3.SPMT_DSB_DV_CD = '01' /* 추가지급구분코드 = 01 : 정상지급 */
          LEFT OUTER JOIN TB_FEAM_FEE_FNT_IZ T4 /* 수수료이체내역 */
            ON T3.DSB_YM = T4.DSB_YM /* 지급년월 */
           AND T3.CO_CD = T4.CO_CD /* 회사코드 */
           AND T3.OG_TP_CD = T4.OG_TP_CD /* 조직유형코드 */
           AND T3.PRTNR_NO = T4.PRTNR_NO /* 파트너번호 */
           AND T4.DTA_DL_YN = 'N'
          LEFT OUTER JOIN
             (
               SELECT PRTNR_NO /* 파트너번호 */
                    , OG_TP_CD /* 조직유형코드 */
                    , NVL(SUM(AWD_INTBS_AMT), 0) AS AWD_INTBS_AMT /* 시상소득과표금액 */
                    , NVL(SUM(AWD_ERN_WHTX), 0) AS AWD_ERN_WHTX /* 시상소득원천세 */
                    , NVL(SUM(AWD_INTBS_AMT), 0) - NVL(SUM(AWD_ERN_WHTX), 0) AS AWD_DSB_OJ_AMT /* 시상실지급액 */
                 FROM TB_PSEV_AWD_ERN_WHTX_IZ /* 시상소득원천세내역 */
                WHERE 1=1
                  AND PERF_YM = #{perfYm} /* 조직유형코드 */
                  AND OG_TP_CD = #{ogTpCd} /* 조직유형코드 */

                  <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                      AND PRTNR_NO = #{prtnrNo} /* 파트너번호 */
                  </if>
                GROUP BY PRTNR_NO, OG_TP_CD
             ) T5
            ON T3.PRTNR_NO = T5.PRTNR_NO /* 파트너번호 */
           AND T3.OG_TP_CD = T5.OG_TP_CD /* 조직유형코드 */

          LEFT OUTER JOIN (
               SELECT T1.OG_TP_CD /* 조직유형코드 */
                    , T1.PRTNR_NO /* 파트너번호 */
                    , T1.ACNO_ENCR /* 계좌번호암호화 */
                    , T2.BNK_NM /* 은행명 */
                 FROM TB_OGBS_PRTNR_AC_BAS T1 /* 파트너계좌기본 */
                INNER JOIN TB_RVDW_FNIT_CD_USE_DV_IZ T2 /* 금융기관코드사용구분내역 */
                   ON T2.DTA_DL_YN = 'N'
                  AND T1.FNIT_CD = T2.FNIT_CD /* 금융기관코드 */
                  AND T2.VNCO_DV_CD ='001' /* VAN사구분코드 */
                  AND T2.BNK_BIZ_DV_CD = '03' /*수수료계좌*/
                  AND #{perfYm} || '01' BETWEEN T2.VL_STRTDT AND T2.VL_ENDDT /* 유효시작일시, 유효종료일시 */
                WHERE 1=1
                  AND T1.DTA_DL_YN = 'N'
                  AND T1.OG_TP_CD = #{ogTpCd} /* 조직유형코드 */
                  AND T1.PRTNR_AC_USWY_CD = '1' /* 파트너계좌기본 */
                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T1.VL_STRT_DTM AND T1.VL_END_DTM /* 유효시작일시, 유효종료일시 */

                  <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                      AND T1.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
                  </if>
             ) T6
            ON T3.PRTNR_NO = T6.PRTNR_NO /* 파트너번호 */
           AND T3.OG_TP_CD = T6.OG_TP_CD /* 조직유형코드 */
         WHERE 1=1
           AND T1.DTA_DL_YN = 'N'
           AND T1.BASE_YM = #{perfYm} /* 기준년월 */
           AND T1.OG_TP_CD = #{ogTpCd} /* 조직유형코드 */
           AND T2.RSB_DV_CD = #{rsbDvCd} /* 직책유형코드 */
           AND T3.CO_CD = '2000' /* 회사코드 */

           <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
               AND T3.PRTNR_NO = #{prtnrNo} /* 파트너번호 */
           </if>

           <if test='@MybatisUtils@isNotEmpty(ogLevl1)'>
               AND T1.DGR1_LEVL_OG_ID = #{ogLevl1}
           </if>

           <if test='@MybatisUtils@isNotEmpty(ogLevl2)'>
               AND T1.DGR2_LEVL_OG_ID = #{ogLevl2}
           </if>

           <if test='@MybatisUtils@isNotEmpty(ogLevl3)'>
               AND T1.DGR3_LEVL_OG_ID = #{ogLevl3}
           </if>

           <if test='@MybatisUtils@isNotEmpty(ogLevl4)'>
               AND T1.DGR4_LEVL_OG_ID = #{ogLevl4}
           </if>

           <if test='@MybatisUtils@isNotEmpty(ogLevl5)'>
               AND T1.DGR5_LEVL_OG_ID = #{ogLevl5}
           </if>

           <if test='@MybatisUtils@equals(feeDsbYn, "Y")'>
               AND
                 ( T3.INTBS_AMT <![CDATA[>]]> 0 OR
                   T3.DDCTAM <![CDATA[>]]> 0 OR
                   T3.DSB_OJ_AMT <![CDATA[>]]> 0 OR
                   T5.AWD_INTBS_AMT <![CDATA[>]]> 0 OR
                   T5.AWD_ERN_WHTX <![CDATA[>]]> 0 OR
                   T5.AWD_DSB_OJ_AMT <![CDATA[>]]> 0
                 )
           </if>

           <if test='@MybatisUtils@equals(feeDsbYn, "N")'>
               AND
                 ( T3.DSB_OJ_AMT <![CDATA[<=]]> 0 OR
                   T5.AWD_DSB_OJ_AMT <![CDATA[<=]]> 0
                 )
           </if>

         ORDER BY T1.OG_CD, T2.PRTNR_NO
    </select>

<!--    <select id='selectUserInfo'-->
<!--            resultType="com.kyowon.sms.wells.web.fee.confirm.dto.WfeeIndividualFeeDto$SearchUserInfoRes">-->
<!--        SELECT A.HIR_FOM_CD-->
<!--             , CASE WHEN NVL(B.RSBP_CD,'0') != '0' THEN B.RSBP_CD-->
<!--                    WHEN NVL(B.RSBM_CD,'0') != '0' THEN B.RSBM_CD-->
<!--                    WHEN NVL(B.BMP_CD,'0') != '0' THEN B.BMP_CD-->
<!--                    WHEN NVL(B.BMM_CD,'0') != '0' THEN B.BMM_CD-->
<!--                    ELSE ''-->
<!--               END AS BZNS_SPPT_RSB_DV_CD-->
<!--             , A.RSB_DV_CD-->
<!--             , A.PSTN_DV_CD-->
<!--          FROM TB_OGBS_MM_PRTNR_IZ A-->
<!--          LEFT OUTER JOIN ( SELECT PRTNR_NO-->
<!--                                 , MAX(RSBP_CD) AS RSBP_CD-->
<!--                                 , MAX(RSBM_CD) AS RSBM_CD-->
<!--                                 , MAX(BMP_CD) AS BMP_CD-->
<!--                                 , MAX(BMM_CD) AS BMM_CD-->
<!--                              FROM ( SELECT PRTNR_NO-->
<!--                                          , CASE WHEN BZNS_SPPT_RSB_DV_CD = 'W0106' THEN BZNS_SPPT_RSB_DV_CD-->
<!--                                            END RSBP_CD-->
<!--                                          , CASE WHEN BZNS_SPPT_RSB_DV_CD = 'W0206' THEN BZNS_SPPT_RSB_DV_CD-->
<!--                                            END RSBM_CD-->
<!--                                          , CASE WHEN BZNS_SPPT_RSB_DV_CD = 'W0107' THEN BZNS_SPPT_RSB_DV_CD-->
<!--                                            END BMP_CD-->
<!--                                          , CASE WHEN BZNS_SPPT_RSB_DV_CD = 'W0207' THEN BZNS_SPPT_RSB_DV_CD-->
<!--                                            END BMM_CD-->
<!--                                       FROM TB_OGBS_SPPT_OG_IZ-->
<!--                                      WHERE PRTNR_NO = #{session.employeeIDNumber}-->
<!--                                        AND BZNS_SPPT_RSB_DV_CD IN ('W0107','W0207','W0106','W0206')-->
<!--                                        AND TO_CHAR(SYSDATE,'YYYYMMDD') BETWEEN MNGT_STRT_DT AND MNGT_END_DT-->
<!--                                   )-->
<!--                             GROUP BY PRTNR_NO-->
<!--               ) B-->
<!--            ON A.PRTNR_NO = B.PRTNR_NO-->
<!--         WHERE A.PRTNR_NO = #{session.employeeIDNumber}-->
<!--           AND A.OG_TP_CD = #{ogTpCd}-->
<!--           AND A.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')-->
<!--    </select>-->
</mapper>
