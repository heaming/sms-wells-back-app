<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.simulation.mapper.WfefSellFeeEtPerfMapper">
    <select id="selectSellFeeEtPerfs" resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefSellFeeEtPerfDto$SearchRes">
        SELECT OG_CD
             , PRTNR_NM
             , PRTNR_NO
             , MAX((SELECT PSTN_DV_CD FROM TB_OGBS_MM_PRTNR_IZ WHERE BASE_YM = SUBSTR(#{inqrStrtDt},1,6) AND PRTNR_NO = T.PRTNR_NO)) AS PSTN_DV_CD
             , COUNT(DISTINCT BRCH_NO) AS BRCH_CT
             , NVL(SUM(RENTAL_ELHM_PERF_CT), 0) AS RENTAL_ELHM_CT
             , NVL(SUM(SPAY_ELHM_PERF_CT), 0) AS SPAY_ELHM_CT
             , NVL(SUM(RENTAL_ELHM_BASE_AMT), 0) AS RENTAL_ELHM_BASE_AMT
             , NVL(SUM(SPAY_ELHM_BASE_AMT), 0) AS SPAY_ELHM_BASE_AMT
             , NVL(SUM(NOT_ELHM_AMT), 0) AS NOT_ELHM_AMT
             , NVL(SUM(SPAY_NINC_NW_CT), 0) AS SPAY_NINC_NW_CT
             , NVL(SUM(RENTAL_NINC_NW_CT), 0) AS RENTAL_NINC_NW_CT
             , NVL(SUM(RENTAL_CAN_CT), 0) AS RENTAL_CAN_CT
             , NVL(SUM(RENTAL_EXN_CT), 0) AS RENTAL_EXN_CT
             , NVL(SUM(MSH_SPR_CT), 0) AS MSH_SPR_CT
             , NVL(SUM(SPAY_RSG_CT), 0) AS SPAY_RSG_CT
             , SUM(VST_ASN_CT) AS VST_ASN_CT
             , SUM(VST_FSH_CT) AS VST_FSH_CT
             , SUM(VST_FSH_CT) / DECODE(SUM(VST_ASN_CT), 0, 1, SUM(VST_ASN_CT)) * 100 AS VST_PROCS_RT
          FROM (
                SELECT DECODE(PR.PSTN_DV_CD, '7', PR.PRTNR_NO) AS BRCH_NO
                     , DECODE(#{pstnDvCd}, '01', OG.DGR1_LEVL_OG_CD, '02', OG.DGR2_LEVL_OG_CD, '03', OG.DGR3_LEVL_OG_CD, PR.OG_CD) AS OG_CD
                     , DECODE(#{pstnDvCd}, '01', OG.DGR1_LEVL_DG_PRTNR_NM, '02', OG.DGR2_LEVL_DG_PRTNR_NM, '03', OG.DGR3_LEVL_DG_PRTNR_NM, PR.PRTNR_KNM) AS PRTNR_NM
                     , DECODE(#{pstnDvCd}, '01', OG.DGR1_LEVL_DG_PRTNR_NO, '02', OG.DGR2_LEVL_DG_PRTNR_NO, '03', OG.DGR3_LEVL_DG_PRTNR_NO, PR.PRTNR_NO) AS PRTNR_NO
                     , T1.RENTAL_ELHM_PERF_CT
                     , T1.SPAY_ELHM_PERF_CT
                     , T1.RENTAL_ELHM_BASE_AMT
                     , T1.SPAY_ELHM_BASE_AMT
                     , T1.NOT_ELHM_AMT
                     , T1.SPAY_NINC_NW_CT
                     , T1.RENTAL_NINC_NW_CT
                     , T1.RENTAL_CAN_CT
                     , T1.RENTAL_EXN_CT
                     , T1.MSH_SPR_CT
                     , T1.SPAY_RSG_CT
                     , NVL(T2.LCCNT1, 0) - NVL(T2.LCCCNT, 0) AS VST_ASN_CT
                     , NVL(T2.LCCNT2, 0) + NVL(T2.LCCNT3, 0) AS VST_FSH_CT
                   FROM TB_OGBS_MM_PRTNR_IZ PR
                   JOIN TB_OGBS_MM_OG_IZ OG
                     ON OG.BASE_YM = PR.BASE_YM
                    AND OG.OG_ID = PR.OG_ID
                   LEFT JOIN (
                        SELECT PRTNR_NO
                             , SUM(RENTAL_ELHM_PERF_CT) AS RENTAL_ELHM_PERF_CT
                             , SUM(SPAY_ELHM_PERF_CT) AS SPAY_ELHM_PERF_CT
                             , SUM(RENTAL_ELHM_BASE_AMT) AS RENTAL_ELHM_BASE_AMT
                             , SUM(SPAY_ELHM_BASE_AMT) AS SPAY_ELHM_BASE_AMT
                             , SUM(NOT_ELHM_AMT) AS NOT_ELHM_AMT
                             , SUM(SPAY_NINC_NW_CT) AS SPAY_NINC_NW_CT
                             , SUM(RENTAL_NINC_NW_CT) AS RENTAL_NINC_NW_CT
                             , SUM(RENTAL_CAN_CT) AS RENTAL_CAN_CT
                             , SUM(RENTAL_EXN_CT) AS RENTAL_EXN_CT
                             , SUM(MSH_SPR_CT) AS MSH_SPR_CT
                             , SUM(SPAY_RSG_CT) AS SPAY_RSG_CT
                          FROM (
                                SELECT SELL_PRTNR_NO AS PRTNR_NO
                                     , CNTR_NO
                                     , RENTAL_ELHM_PERF_CT
                                     , SPAY_ELHM_PERF_CT
                                     , RENTAL_ELHM_BASE_AMT
                                     , SPAY_ELHM_BASE_AMT
                                     , NOT_ELHM_AMT
                                     , 0 AS SPAY_NINC_NW_CT
                                     , 0 AS RENTAL_NINC_NW_CT
                                     , 0 AS RENTAL_CAN_CT
                                     , 0 AS RENTAL_EXN_CT
                                     , 0 AS MSH_SPR_CT
                                     , 0 AS SPAY_RSG_CT
                                  FROM (
                                    <include refid="selectSellFeeEtPerfDetails-from"></include>
                                       )
                                 UNION ALL
                                SELECT SELL_PRTNR_NO AS PRTNR_NO
                                     , CNTR_NO
                                     , 0 AS RENTAL_ELHM_PERF_CT
                                     , 0 AS SPAY_ELHM_PERF_CT
                                     , 0 AS RENTAL_ELHM_BASE_AMT
                                     , 0 AS SPAY_ELHM_BASE_AMT
                                     , 0 AS NOT_ELHM_AMT
                                     , SPAY_NINC_NW_CT
                                     , RENTAL_NINC_NW_CT
                                     , 0 AS RENTAL_CAN_CT
                                     , 0 AS RENTAL_EXN_CT
                                     , 0 AS MSH_SPR_CT
                                     , 0 AS SPAY_RSG_CT
                                  FROM (
                                    <include refid="selectSellFeeEtPerfNincs-from"></include>
                                       )
                                 UNION ALL
                                SELECT PRTNR_NO
                                     , CNTR_NO
                                     , 0 AS RENTAL_ELHM_PERF_CT
                                     , 0 AS SPAY_ELHM_PERF_CT
                                     , 0 AS RENTAL_ELHM_BASE_AMT
                                     , 0 AS SPAY_ELHM_BASE_AMT
                                     , 0 AS NOT_ELHM_AMT
                                     , 0 AS SPAY_NINC_NW_CT
                                     , 0 AS RENTAL_NINC_NW_CT
                                     , RENTAL_CAN_CT
                                     , RENTAL_EXN_CT
                                     , MSH_SPR_CT
                                     , SPAY_RSG_CT
                                  FROM (
                                    <include refid="selectSellFeeEtPerfCans-from"></include>
                                       )
                               )
                         GROUP BY PRTNR_NO
                       ) T1
                    ON T1.PRTNR_NO = PR.PRTNR_NO
                  LEFT JOIN (
                        SELECT *
                          FROM (
                                SELECT PRTNR_NO, PRTNR_SV_PERF_ATC_CD, PERF_VAL
                                  FROM TB_FEAM_WPTN_SV_PERF_AGRG PA
                                 WHERE PA.BASE_YM = SUBSTR(#{inqrStrtDt}, 1, 6)
                                   AND PA.CL_DV_CD = '02'
                                   AND PA.OG_TP_CD != 'HR1'
                                   AND PA.PRTNR_SV_PERF_ATC_CD IN ('SV01999901', 'SV01999902', 'SV01999903', 'SV01999909', 'SV01909001')
                               )
                         PIVOT (SUM(PERF_VAL) FOR PRTNR_SV_PERF_ATC_CD IN (
                                    'SV01999901' AS LCCNT1,
                                    'SV01999902' AS LCCNT2,
                                    'SV01999903' AS LCCNT3,
                                    'SV01999909' AS LCRAT1,
                                    'SV01909001' AS LCCCNT)
                               )
                       ) T2
                    ON T2.PRTNR_NO = PR.PRTNR_NO
                 WHERE 1=1
                   AND PR.BASE_YM = SUBSTR(#{inqrStrtDt}, 1, 6)
                   AND PR.OG_TP_CD IN ('W02', 'ALC')
                   AND PR.DTA_DL_YN = 'N'
                <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
                   AND PR.PRTNR_NO = #{prtnrNo}
                </if>
                <if test="@MybatisUtils@isNotEmpty(dgr1LevlOgCd)">
                   AND OG.DGR1_LEVL_OG_CD = #{dgr1LevlOgCd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(dgr2LevlOgCd)">
                   AND OG.DGR2_LEVL_OG_CD = #{dgr2LevlOgCd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(dgr3LevlOgCd)">
                   AND OG.DGR3_LEVL_OG_CD = #{dgr3LevlOgCd}
                </if>
                   AND OG.OG_CD BETWEEN 'A000000' AND 'P999999'
               ) T
       GROUP BY OG_CD, PRTNR_NM, PRTNR_NO
       ORDER BY OG_CD, PRTNR_NM, PRTNR_NO
    </select>

    <sql id="selectSellFeeEtPerfDetails-from">
        SELECT CB.CNTR_NO
             , CB.CNTR_CST_NM
             , CB.SELL_PRTNR_NO
             , CD.SELL_TP_CD
             , SUBSTR(CB.CNTR_CNFM_DTM, 1, 8) AS CNTR_CNFM_DT
             , CD.CNTR_PD_STRTDT
             , CD.PD_MCLSF_ID
             , MAX(CD.BASE_PD_CD) AS PD_CD
             , MAX(CH.MCHN_CH_TP_CD) AS MCHN_CH_TP_CD
             , SUM(CASE
                    WHEN CD.SELL_TP_CD = '1' THEN
                        CASE
                            WHEN CD.SELL_DSC_DV_CD = '9' AND CD.SELL_DSCR_CD = '99' THEN 0
                            WHEN CD.SELL_DSC_DV_CD = '5' AND CD.SELL_DSCR_CD IN ('11','12','13','14') AND ACKMT_PERF_AMT > 0 THEN 0
                            WHEN CD.SELL_TP_DTL_CD != '12'
                             AND CD.BASE_PD_CD != 'WP05110351'
                             AND PDTL.ENVR_SFT_YN = 'Y'
                             AND CD.FEE_ACKMT_CT > 0
                             AND WS.ROW_SCNT > 0
                             AND CD.ACKMT_PERF_AMT > 0 THEN CD.FEE_ACKMT_CT
                        ELSE 0 END
                   ELSE 0 END
               ) AS SPAY_ELHM_PERF_CT /* 가전인정건수_일시불 */
             , SUM(CASE
                     WHEN CD.SELL_TP_CD = '2' THEN
                        CASE
                            WHEN CD.SELL_DSC_DV_CD = '5' AND CD.SELL_DSCR_CD IN ('5', '6', '9') AND CD.ACKMT_PERF_AMT > 2 THEN 0
                            WHEN PDTL.ENVR_SFT_YN = 'N' THEN 0
                            WHEN CH.ACKMT_PERF_EXCD_YN = 'Y' THEN 0
                            WHEN CD.FEE_ACKMT_CT = 0 THEN 0
                            WHEN WS.ROW_SCNT = 0 THEN 0
                            WHEN CD.SELL_DSC_DV_CD != '5' AND CH.MCHN_CH_TP_CD IS NULL AND CD.ACKMT_PERF_AMT > 0 THEN CD.FEE_ACKMT_CT
                            WHEN CD.SELL_DSC_DV_CD != '5' AND CH.MCHN_CH_TP_CD IN ('15', '16', '19') THEN CD.FEE_ACKMT_CT
                            WHEN CD.SELL_DSC_DV_CD = '5' AND CD.ACKMT_PERF_AMT > 0 AND
                                    (CH.MCHN_CH_TP_CD IS NULL OR CH.MCHN_CH_TP_CD IN ('15', '16', '19')) THEN CD.FEE_ACKMT_CT
                            ELSE 0 END
                    WHEN CD.SELL_TP_CD = '6' THEN
                        CASE
                            WHEN CD.SELL_TP_DTL_CD = '62' THEN CD.FEE_ACKMT_CT
                            ELSE 0 END
                    ELSE 0 END
               ) AS RENTAL_ELHM_PERF_CT /* 가전인정건수_렌탈 */
             , SUM(CASE
                     WHEN CD.SELL_TP_CD = '1' THEN
                        CASE
                            WHEN CD.SELL_DSC_DV_CD = '9' AND CD.SELL_DSCR_CD = '99' THEN 0
                            WHEN CD.SELL_DSC_DV_CD = '5' AND CD.SELL_DSCR_CD IN ('11','12','13','14') AND ACKMT_PERF_AMT > 0 THEN 0
                            WHEN CD.SELL_TP_DTL_CD != '12'
                             AND CD.BASE_PD_CD != 'WP05110351'
                             AND (PDTL.ENVR_SFT_YN = 'Y' OR CD.FEE_ACKMT_CT > 0)
                             AND WS.ROW_SCNT > 0
                             AND CD.ACKMT_PERF_AMT > 0 THEN CD.FEE_ACKMT_BASE_AMT
                        ELSE 0 END
                     ELSE 0 END
               ) AS SPAY_ELHM_BASE_AMT
             , SUM(CASE
                     WHEN CD.SELL_TP_CD = '2' THEN
                        CASE
                            WHEN NVL(CH.ACKMT_PERF_EXCD_YN, 'N') = 'Y' THEN 0
                            WHEN NVL(CH.MCHN_CH_TP_CD, '0') = '18' THEN 0
                            WHEN CD.ACKMT_PERF_AMT <![CDATA[<= 2]]> THEN 0
                            WHEN WS.ROW_SCNT = 0 THEN 0
                            ELSE CD.FEE_ACKMT_BASE_AMT END
                     WHEN CD.SELL_TP_CD = '6' THEN
                        CASE
                            WHEN CD.SELL_TP_DTL_CD = '62' /* 모종 */
                             AND CD.ACKMT_PERF_AMT > 2 THEN CD.FEE_ACKMT_BASE_AMT
                            ELSE 0 END
                     ELSE 0 END
               ) AS RENTAL_ELHM_BASE_AMT
             , SUM(CASE
                WHEN CD.SELL_TP_CD = '1' THEN
                    CASE
                        WHEN CD.SELL_TP_DTL_CD != '12'
                         AND NVL(CD.FEE_FXAM_YN, 'N') != 'Y'
                         AND CD.FEE_ACKMT_CT > 0
                         AND NVL(WS.ROW_SCNT, 0) = 0 THEN CD.ACKMT_PERF_AMT
                        ELSE 0 END
                WHEN CD.SELL_TP_CD = '2' THEN
                    CASE
                        WHEN CD.FEE_ACKMT_CT > 0
                         AND NVL(WS.ROW_SCNT, 0) = 0 THEN CD.ACKMT_PERF_AMT
                        ELSE 0 END
                WHEN CD.SELL_TP_CD = '6' THEN
                    CASE
                        WHEN CD.SELL_TP_DTL_CD NOT IN ('62', '63')
                         AND CD.FEE_ACKMT_CT > 0 THEN CD.ACKMT_PERF_AMT
                        ELSE 0 END
                ELSE 0 END
               ) AS NOT_ELHM_AMT  /* 가전외 인정금액 */
          FROM TB_SSCT_CNTR_BAS CB  /* 계약기본 */
          JOIN TB_SSCT_CNTR_DTL CD  /* 계약상세 */
            ON CD.CNTR_NO = CB.CNTR_NO
          LEFT JOIN LATERAL (
                    SELECT MCHN_CH_TP_CD
                         , CASE WHEN MCHN_CPS_APYR = 0 AND CD.ACKMT_PERF_AMT = 0 THEN 'Y' ELSE 'N' END AS ACKMT_PERF_EXCD_YN
                      FROM TB_SSCT_MCHN_CH_IZ  /* 기기변경내역 */
                     WHERE BASE_CNTR_NO = CD.CNTR_NO
                       AND BASE_CNTR_SN = CD.CNTR_SN
                     ORDER BY MCHN_CH_SN DESC
                     FETCH FIRST 1 ROW ONLY
               ) CH ON 1=1
          LEFT JOIN LATERAL (
                  SELECT NVL(MAX(PD_PRP_VAL11), 'N') AS ENVR_SFT_YN
                    FROM TB_PDBS_PD_ECOM_PRP_DTL /* 상품각사속성상세 */
                   WHERE PD_CD = CD.BASE_PD_CD
                     AND PD_EXTS_PRP_GRP_CD =  'IND' /* IND:개별 */
                     AND DTA_DL_YN = 'N'
                   ) PDTL ON 1=1
          LEFT JOIN LATERAL (
                SELECT COUNT(1) AS ROW_SCNT
                  FROM DUAL
                 WHERE EXISTS (
                        SELECT 1
                          FROM TB_FEAM_WELS_SV_FEE_BAS T1
                         WHERE T1.BASE_PD_CD = CD.BASE_PD_CD
                           AND T1.VST_MCN = 0
                           AND SUBSTR(CB.CNTR_CNFM_DTM,1,6) BETWEEN T1.APY_STRT_YM AND T1.APY_END_YM
                       )
                    OR EXISTS (
                        SELECT 1
                          FROM TB_FEAM_WELS_SV_FEE_BAS T1
                          JOIN TB_PDBS_PD_REL T2
                            ON T1.BASE_PD_CD = T2.BASE_PD_CD
                           AND T2.PD_REL_TP_CD = '05'
                           AND CB.CNTR_CNFM_DTM BETWEEN T2.VL_STRT_DTM AND T2.VL_END_DTM
                         WHERE VST_MCN = 0
                           AND SUBSTR(CB.CNTR_CNFM_DTM,1,6) BETWEEN APY_STRT_YM AND APY_END_YM
                           AND T2.OJ_PD_CD IN (
                                  SELECT OJ_PD_CD
                                    FROM TB_PDBS_PD_REL T1
                                   WHERE T1.BASE_PD_CD = CD.BASE_PD_CD
                                     AND T1.PD_REL_TP_CD = '05'
                                     AND CB.CNTR_CNFM_DTM BETWEEN VL_STRT_DTM AND VL_END_DTM
                               )
                           AND ROWNUM = 1
                       )
                 ) WS ON 1=1
         WHERE CB.SELL_OG_TP_CD != 'HR1'
            <choose>
                <when test="@MybatisUtils@equals(perfBaseDv, '1')">
           AND CB.CNTR_CNFM_DTM BETWEEN #{inqrStrtDt} || '000000' AND #{inqrEndDt} || '235959'
                </when>
                <when test="@MybatisUtils@equals(perfBaseDv, '2')">
           AND (
                (
                        CD.SELL_TP_CD IN ('1', '2') /* 일시불, 렌탈 */
                    AND (
                            (CD.CNTR_PD_STRTDT BETWEEN #{inqrStrtDt} AND #{inqrEndDt} AND CD.BOO_SELL_TP_CD IS NULL) /* 설치, 예약아님 */
                         OR (CB.CNTR_CNFM_DTM BETWEEN #{inqrStrtDt} || '000000' AND #{inqrEndDt} || '235959' AND CD.BOO_SELL_TP_CD = '2') /* 접수, 예약 */
                        )
                    AND (
                            CD.CNTR_DTL_STAT_CD NOT IN ('301', '303')
                         OR SUBSTR(CB.CNTR_CNFM_DTM,1,6) != SUBSTR(NVL(CD.CNTR_PD_ENDDT, '99991231'),1,6) /* 당월취소가 아닌 건 */
                        )
                    AND NOT EXISTS (
                        SELECT 1
                          FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS  /* 수수료실적제외대상기본 */
                         WHERE FEE_PERF_EXCD_DV_CD = '01'
                           AND CNTR_NO = CD.CNTR_NO
                           AND CNTR_SN = CD.CNTR_SN
                        )
                )
                OR
                (
                        CD.SELL_TP_CD = '6' /* 정기배송 */
                    AND CD.CNTR_PD_STRTDT BETWEEN #{inqrStrtDt} AND #{inqrEndDt} /* 설치일자 */
                )
               )
                </when>
                <otherwise>
           AND 1=2
                </otherwise>
            </choose>
           AND CB.DTA_DL_YN = 'N'
           AND CD.CNTR_DTL_STAT_CD NOT IN ('301', '303')  /* 취소계약 제외 */
           AND (
               CD.SELL_TP_CD = '1' OR
               CD.SELL_TP_CD = '2' OR
               (CD.SELL_TP_CD = '3' AND CD.CNTRW_TP_CD = '5') OR /* 홈케어서비스만 */
               (CD.SELL_TP_CD = '6' AND CD.STPL_PTRM >= 6) /* 정기배송의 경우 6 이상 */
               )
           AND CD.DTA_DL_YN = 'N'
         GROUP BY CB.CNTR_NO
             , CB.CNTR_CST_NM
             , CB.SELL_PRTNR_NO
             , CD.SELL_TP_CD
             , CB.CNTR_CNFM_DTM
             , CD.CNTR_PD_STRTDT
             , CD.PD_MCLSF_ID
         UNION ALL
        /* 재약정내역 */
        SELECT CB.CNTR_NO
             , CB.CNTR_CST_NM
             , CB.SELL_PRTNR_NO
             , CD.SELL_TP_CD
             , '' AS CNTR_CNFM_DT
             , '' AS CNTR_PD_STRTDT
             , CD.PD_MCLSF_ID
             , MAX(CD.BASE_PD_CD) AS PD_CD
             , '' AS MCHN_CH_TP_CD
             , 0 AS SPAY_ELHM_PERF_CT
             , SUM(RR.FEE_ACKMT_CT) AS RENTAL_ELHM_PERF_CT
             , 0 AS SPAY_ELHM_BASE_AMT
             , 0 AS RENTAL_ELHM_BASE_AMT
             , 0 AS NOT_ELHM_AMT
          FROM TB_SSCT_RENTAL_RSTL_IZ RR /* 렌탈재약정내역 */
          JOIN TB_SSCT_CNTR_DTL CD  /* 계약상세 */
            ON CD.CNTR_NO = RR.CNTR_NO
           AND CD.CNTR_SN = RR.CNTR_SN
          JOIN TB_SSCT_CNTR_BAS CB  /* 계약기본 */
            ON CB.CNTR_NO = RR.CNTR_NO
          LEFT JOIN LATERAL (
                    SELECT *
                      FROM TB_FEAM_WELS_FEE_PDCT_TP_BAS
                     WHERE BASE_PD_CD = CD.BASE_PD_CD
                       AND SUBSTR(RR.STPL_CNFM_DTM,1,6) BETWEEN APY_STRT_YM AND APY_END_YM
                       AND DTA_DL_YN = 'N'
               ) PT ON 1=1
         WHERE 1=1
            <choose>
                <when test="@MybatisUtils@equals(perfBaseDv, '1')">
           AND RR.STPL_RCP_DTM BETWEEN #{inqrStrtDt} || '0000000' AND #{inqrEndDt} || '235959'
                </when>
                <when test="@MybatisUtils@equals(perfBaseDv, '2')">
           AND RR.STPL_CNFM_DTM BETWEEN #{inqrStrtDt} || '0000000' AND #{inqrEndDt} || '235959'
                </when>
                <otherwise>
           AND 1=2
                </otherwise>
            </choose>
           AND CB.SELL_OG_TP_CD != 'HR1'
           AND CB.DTA_DL_YN = 'N'
           AND CD.CNTR_DTL_STAT_CD NOT IN ('301', '303')  /* 취소계약 제외 */
           AND CD.SELL_TP_CD = '2' /* 렌탈 */
           AND CD.DTA_DL_YN = 'N'
           AND CD.FEE_ACKMT_CT > 0
           AND PT.FEE_PDCT_TP_CD1 = 'B' /* B:웰스팜 */
         GROUP BY CB.CNTR_NO
             , CB.CNTR_CST_NM
             , CB.SELL_PRTNR_NO
             , CD.SELL_TP_CD
             , CD.PD_MCLSF_ID
    </sql>

    <select id="selectSellFeeEtPerfDetails" resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefSellFeeEtPerfDto$SearchDetailRes">
        SELECT OG.OG_CD
             , PR.PRTNR_KNM AS PRTNR_NM
             , PR.PRTNR_NO
             , PR.PSTN_DV_CD
             , T1.CNTR_NO
             , T1.CNTR_CST_NM
             , T1.SELL_TP_CD
             , T1.CNTR_CNFM_DT
             , T1.CNTR_PD_STRTDT
             , '' CNTR_CAN_DT
             , PC.PD_CLSF_NM
             , T1.PD_CD
             , PD.PD_NM
             , T1.MCHN_CH_TP_CD
             , T1.SPAY_ELHM_PERF_CT + T1.RENTAL_ELHM_PERF_CT AS ELHM_PERF_CT
             , T1.SPAY_ELHM_BASE_AMT + T1.RENTAL_ELHM_BASE_AMT AS ELHM_BASE_AMT
             , T1.NOT_ELHM_AMT
        FROM TB_OGBS_MM_PRTNR_IZ PR  /* 월파트너 */
        JOIN TB_OGBS_MM_OG_IZ OG  /* 월조직 */
          ON OG.BASE_YM = PR.BASE_YM
         AND OG.OG_ID = PR.OG_ID
        JOIN (
            <include refid="selectSellFeeEtPerfDetails-from" />
        ) T1
          ON T1.SELL_PRTNR_NO = PR.PRTNR_NO
        LEFT JOIN TB_PDBS_PD_CLSF_BAS PC  /* 상품분류기본 */
          ON PC.PD_CLSF_ID = T1.PD_MCLSF_ID
        LEFT JOIN TB_PDBS_PD_BAS PD /* 상품기본 */
          ON PD.PD_CD = T1.PD_CD
       WHERE 1=1
         AND PR.BASE_YM = SUBSTR(#{inqrStrtDt}, 1, 6)
         AND PR.OG_TP_CD IN ('W02', 'ALC')
        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
         AND PR.PRTNR_NO = #{prtnrNo}
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr1LevlOgCd)">
         AND OG.DGR1_LEVL_OG_CD = #{dgr1LevlOgCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr2LevlOgCd)">
         AND OG.DGR2_LEVL_OG_CD = #{dgr2LevlOgCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr3LevlOgCd)">
         AND OG.DGR3_LEVL_OG_CD = #{dgr3LevlOgCd}
        </if>
         AND OG.OG_CD BETWEEN 'A000000' AND 'P999999'
       ORDER BY OG.OG_CD, PR.PRTNR_KNM, T1.CNTR_NO
    </select>

    <sql id="selectSellFeeEtPerfNincs-from">
        SELECT CB.CNTR_NO
             , CB.CNTR_CST_NM
             , CB.SELL_PRTNR_NO
             , CD.SELL_TP_CD
             , SUBSTR(CB.CNTR_CNFM_DTM, 1, 8) AS CNTR_CNFM_DT
             , CASE WHEN CD.CNTR_DTL_STAT_CD IN ('301', '303') THEN CD.CNTR_PD_ENDDT END AS CNTR_CAN_DT
             , CD.CNTR_PD_STRTDT
             , CD.PD_MCLSF_ID
             , MAX(CD.BASE_PD_CD) AS PD_CD
             , MAX(CASE
                    WHEN CD.SELL_TP_CD = '1' THEN
                        CASE
                            WHEN CD.SELL_TP_DTL_CD != '12'
                             AND CD.BASE_PD_CD != 'WP05110351'
                             AND PDTL.ENVR_SFT_YN = 'Y'
                             AND CD.FEE_ACKMT_CT > 0
                             AND WS.ROW_SCNT > 0
                             AND CD.ACKMT_PERF_AMT > 0 THEN 1
                        ELSE 0 END
                    ELSE 0 END
               ) AS SPAY_NINC_NW_CT  /* 계정순증건수 - 일시불 */
             , MAX(CASE
                    WHEN CD.SELL_TP_CD = '2' THEN
                        CASE
                            WHEN CH.MCHN_CH_TP_CD IS NOT NULL THEN 0
                            WHEN NVL(CH.ACKMT_PERF_EXCD_YN, 'N') = 'Y' THEN 0
                            WHEN CD.FEE_ACKMT_CT = 0 THEN 0
                            WHEN WS.ROW_SCNT = 0 THEN 0
                            WHEN CD.ACKMT_PERF_AMT > 0 THEN 1
                            ELSE 0 END
                    WHEN CD.SELL_TP_CD = '6' THEN
                        CASE
                            WHEN CD.SELL_TP_DTL_CD = '62' AND CD.ACKMT_PERF_AMT > 2 THEN 1
                            ELSE 0 END
                    ELSE 0 END
               ) AS RENTAL_NINC_NW_CT /* 계정순증건수 - 렌탈 */
          FROM TB_SSCT_CNTR_BAS CB  /* 계약기본 */
          JOIN TB_SSCT_CNTR_DTL CD  /* 계약상세 */
            ON CD.CNTR_NO = CB.CNTR_NO
          LEFT JOIN LATERAL (
                    SELECT MCHN_CH_TP_CD
                         , CASE WHEN MCHN_CPS_APYR = 0 AND CD.ACKMT_PERF_AMT = 0 THEN 'Y' ELSE 'N' END AS ACKMT_PERF_EXCD_YN
                      FROM TB_SSCT_MCHN_CH_IZ  /* 기기변경내역 */
                     WHERE BASE_CNTR_NO = CD.CNTR_NO
                       AND BASE_CNTR_SN = CD.CNTR_SN
                     ORDER BY MCHN_CH_SN DESC
                     FETCH FIRST 1 ROW ONLY
               ) CH ON 1=1
          LEFT JOIN LATERAL (
                  SELECT NVL(MAX(PD_PRP_VAL11), 'N') AS ENVR_SFT_YN
                    FROM TB_PDBS_PD_ECOM_PRP_DTL /* 상품각사속성상세 */
                   WHERE PD_CD = CD.BASE_PD_CD
                     AND PD_EXTS_PRP_GRP_CD =  'IND' /* IND:개별 */
                     AND DTA_DL_YN = 'N'
                   ) PDTL ON 1=1
          LEFT JOIN LATERAL (
                SELECT COUNT(1) AS ROW_SCNT
                  FROM DUAL
                 WHERE EXISTS (
                        SELECT 1
                          FROM TB_FEAM_WELS_SV_FEE_BAS T1
                         WHERE T1.BASE_PD_CD = CD.BASE_PD_CD
                           AND T1.VST_MCN = 0
                           AND SUBSTR(CB.CNTR_CNFM_DTM,1,6) BETWEEN T1.APY_STRT_YM AND T1.APY_END_YM
                       )
                    OR EXISTS (
                        SELECT 1
                          FROM TB_FEAM_WELS_SV_FEE_BAS T1
                          JOIN TB_PDBS_PD_REL T2
                            ON T1.BASE_PD_CD = T2.BASE_PD_CD
                           AND T2.PD_REL_TP_CD = '05'
                           AND CB.CNTR_CNFM_DTM BETWEEN T2.VL_STRT_DTM AND T2.VL_END_DTM
                         WHERE VST_MCN = 0
                           AND SUBSTR(CB.CNTR_CNFM_DTM,1,6) BETWEEN APY_STRT_YM AND APY_END_YM
                           AND T2.OJ_PD_CD IN (
                                  SELECT OJ_PD_CD
                                    FROM TB_PDBS_PD_REL T1
                                   WHERE T1.BASE_PD_CD = CD.BASE_PD_CD
                                     AND T1.PD_REL_TP_CD = '05'
                                     AND CB.CNTR_CNFM_DTM BETWEEN VL_STRT_DTM AND VL_END_DTM
                               )
                           AND ROWNUM = 1
                       )
                 ) WS ON 1=1
         WHERE CB.SELL_OG_TP_CD != 'HR1'
        <choose>
            <when test="@MybatisUtils@equals(perfBaseDv, '1')">
           AND CB.CNTR_CNFM_DTM BETWEEN #{inqrStrtDt} || '000000' AND #{inqrEndDt} || '235959'
            </when>
            <when test="@MybatisUtils@equals(perfBaseDv, '2')">
           AND (
                (
                        CD.SELL_TP_CD IN ('1', '2') /* 일시불, 렌탈 */
                    AND (
                            (CD.CNTR_PD_STRTDT BETWEEN #{inqrStrtDt} AND #{inqrEndDt} AND CD.BOO_SELL_TP_CD IS NULL) /* 설치, 예약아님 */
                         OR (CB.CNTR_CNFM_DTM BETWEEN #{inqrStrtDt} || '000000' AND #{inqrEndDt} || '235959' AND CD.BOO_SELL_TP_CD = '2') /* 접수, 예약 */
                        )
                    AND (
                            CD.CNTR_DTL_STAT_CD NOT IN ('301', '303')
                         OR SUBSTR(CB.CNTR_CNFM_DTM,1,6) != SUBSTR(NVL(CD.CNTR_PD_ENDDT, '99991231'),1,6) /* 당월취소가 아닌 건 */
                        )
                    AND NOT EXISTS (
                        SELECT 1
                          FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS  /* 수수료실적제외대상기본 */
                         WHERE FEE_PERF_EXCD_DV_CD = '01'
                           AND CNTR_NO = CD.CNTR_NO
                           AND CNTR_SN = CD.CNTR_SN
                        )
                )
                OR
                (
                        CD.SELL_TP_CD = '6' /* 정기배송 */
                    AND CD.CNTR_PD_STRTDT BETWEEN #{inqrStrtDt} AND #{inqrEndDt} /* 설치일자 */
                )
               )
            </when>
            <otherwise>
       AND 1=2
            </otherwise>
        </choose>
           AND CB.DTA_DL_YN = 'N'
           AND (
               CD.SELL_TP_CD = '1' OR
               CD.SELL_TP_CD = '2' OR
               (CD.SELL_TP_CD = '6' AND CD.STPL_PTRM >= 6) /* 정기배송의 경우 6 이상 */
               )
           AND CD.DTA_DL_YN = 'N'
         GROUP BY CB.CNTR_NO
             , CB.CNTR_CST_NM
             , CB.SELL_PRTNR_NO
             , CD.SELL_TP_CD
             , CB.CNTR_CNFM_DTM
             , CD.CNTR_PD_STRTDT
             , CD.CNTR_DTL_STAT_CD
             , CD.CNTR_PD_ENDDT
             , CD.PD_MCLSF_ID
    </sql>

    <select id="selectSellFeeEtPerfNincs" resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefSellFeeEtPerfDto$SearchCanNincRes">
        SELECT OG.OG_CD
             , PR.PRTNR_KNM AS PRTNR_NM
             , PR.PRTNR_NO
             , PR.PSTN_DV_CD
             , '신규' AS CAN_TP_NM
             , T1.CNTR_NO
             , T1.CNTR_CST_NM
             , T1.SELL_TP_CD
             , T1.CNTR_CNFM_DT
             , T1.CNTR_PD_STRTDT
             , T1.CNTR_CAN_DT
             , '' AS CNTR_STAT_CH_RSON_CD
             , PC.PD_CLSF_NM
             , T1.PD_CD
             , PD.PD_NM
             , OG.OG_CD AS ORIG_OG_CD  /* 판매자조직코드 */
             , PR.PRTNR_KNM AS ORIG_PRTNR_NM  /* 판매자명 */
             , PR.PRTNR_NO AS ORIG_SELL_PRTNR_NO  /* 판매자파트너번호 */
        FROM TB_OGBS_MM_PRTNR_IZ PR  /* 월파트너내역 */
        JOIN TB_OGBS_MM_OG_IZ OG  /* 월조직내역 */
          ON OG.BASE_YM = PR.BASE_YM
         AND OG.OG_ID = PR.OG_ID
        JOIN (
                <include refid="selectSellFeeEtPerfNincs-from" />
             ) T1
          ON T1.SELL_PRTNR_NO = PR.PRTNR_NO
        LEFT JOIN TB_PDBS_PD_CLSF_BAS PC  /* 상품분류기본 */
          ON PC.PD_CLSF_ID = T1.PD_MCLSF_ID
        LEFT JOIN TB_PDBS_PD_BAS PD /* 상품기본 */
          ON PD.PD_CD = T1.PD_CD
        WHERE 1=1
          AND PR.BASE_YM = SUBSTR(#{inqrStrtDt}, 1, 6)
          AND PR.OG_TP_CD IN ('W02', 'ALC')
        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
          AND PR.PRTNR_NO = #{prtnrNo}
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr1LevlOgCd)">
          AND OG.DGR1_LEVL_OG_CD = #{dgr1LevlOgCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr2LevlOgCd)">
          AND OG.DGR2_LEVL_OG_CD = #{dgr2LevlOgCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr3LevlOgCd)">
          AND OG.DGR3_LEVL_OG_CD = #{dgr3LevlOgCd}
        </if>
          AND OG.OG_CD BETWEEN 'A000000' AND 'P999999'
          AND T1.SPAY_NINC_NW_CT + T1.RENTAL_NINC_NW_CT > 0
        ORDER BY T1.CNTR_NO
    </select>

    <sql id="selectSellFeeEtPerfCans-from">
        SELECT M.OG_TP_CD
               -- WM 해약시에는 지국장 파트너번호를 넣고 아닌 경우는 WM 파트너번호 설정
             , NVL(O2.DGR3_LEVL_DG_PRTNR_NO, M.PRTNR_NO) AS PRTNR_NO
             , M.CAN_TP_NM
             , M.CNTR_NO
             , M.CNTR_SN
             , M.CNTR_CST_NM
             , M.BASE_PD_CD
             , M.ORIG_OG_TP_CD
             , M.ORIG_PRTNR_NO
             , M.CNTR_CNFM_DTM
             , M.CNTR_PD_STRTDT
             , M.CNTR_PD_ENDDT
             , M.CNTR_STAT_CH_RSON_CD
             , CASE WHEN M.PERF_DV_CD = '3' THEN
                    CASE WHEN WS.ROW_SCNT = 0 THEN 0
                         WHEN M.BASE_PD_CD IN ('WP05120457', 'WP05120458', 'WP05120459') THEN 0
                         ELSE 1
                         END
                    ELSE 0
                    END AS RENTAL_CAN_CT -- LCCN02(렌탈해지수)
             , CASE WHEN M.PERF_DV_CD = '4' THEN
                    CASE WHEN WS.ROW_SCNT = 0 THEN 0
                         WHEN M.BASE_PD_CD IN ('WP05120457', 'WP05120458', 'WP05120459') THEN 0
                         ELSE 1
                         END
                    ELSE 0
                    END AS RENTAL_EXN_CT -- LCCN03(렌탈만료수)
             , CASE WHEN M.PERF_DV_CD = '5' THEN
                    CASE WHEN WS.ROW_SCNT = 0 THEN 0 ELSE 1 END
                    ELSE 0
                    END AS MSH_SPR_CT -- LCCN06(멤버십탈퇴수)
             , CASE WHEN M.PERF_DV_CD = '2' THEN
                    CASE WHEN WS.ROW_SCNT = 0 THEN 0
                         WHEN NVL(P1.PD_PRP_VAL11, 'N') = 'Y' AND M.SELL_TP_DTL_CD != '12' AND M.FEE_FXAM_YN = 'N' AND M.BOO_SELL_TP_CD IS NULL THEN 1
                         ELSE 0
                         END
                    ELSE 0
                    END AS SPAY_RSG_CT -- LCCN08(일시불해지수)
          FROM (
                    /*전월 순수해지_일시불취소 OK */
                    SELECT '순수해지' AS CAN_TP_NM
                         , C1.CNTR_NO
                         , C1.CNTR_SN
                         , C2.CNTR_CST_NM
                         , C1.CNTR_DTL_STAT_CD
                         , C1.CNTR_PD_STRTDT
                         , C1.CNTR_PD_ENDDT
                         , C1.BASE_PD_CD
                         , C1.SELL_TP_CD
                         , C1.SELL_TP_DTL_CD
                         , C1.BOO_SELL_TP_CD
                         , NVL(C1.FEE_FXAM_YN, 'N') AS FEE_FXAM_YN
                         , C2.SELL_OG_TP_CD  AS OG_TP_CD
                         , C2.SELL_PRTNR_NO  AS PRTNR_NO
                         , C2.CNTR_CNFM_DTM
                         , C2.SELL_OG_TP_CD  AS ORIG_OG_TP_CD
                         , C2.SELL_PRTNR_NO  AS ORIG_PRTNR_NO
                         , '' AS CNTR_STAT_CH_RSON_CD
                         , '2' AS PERF_DV_CD
                      FROM TB_SSCT_CNTR_DTL C1
                INNER JOIN TB_SSCT_CNTR_BAS C2
                        ON C1.CNTR_NO = C2.CNTR_NO
                     WHERE 1 = 1
                       AND C1.SELL_TP_CD = '1'
                       AND C1.CNTR_DTL_STAT_CD LIKE '3%'
                       AND C1.CNTR_PD_ENDDT LIKE TO_CHAR(ADD_MONTHS(#{inqrStrtDt}, -1), 'YYYYMM') || '%'
                       AND C1.DTA_DL_YN = 'N'
                       AND C2.DTA_DL_YN = 'N'
                       /* 웰스팜제외 */
                       AND NOT EXISTS (
                                      SELECT 1
                                        FROM TB_FEAM_WELS_FEE_PDCT_TP_BAS X1 /*제품유형*/
                                       WHERE C1.BASE_PD_CD = X1.BASE_PD_CD
                                         AND SUBSTR(C1.CNTR_PD_ENDDT, 1, 8) BETWEEN X1.APY_STRT_YM AND X1.APY_END_YM
                                         AND X1.DTA_DL_YN = 'N'
                                         AND X1.FEE_PDCT_TP_CD1 = 'B'
                                      )
                      /*수수료실적제외대상 제외*/
                      AND NOT EXISTS (SELECT 1 FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS X WHERE C1.CNTR_NO = X.CNTR_NO AND C1.CNTR_SN = X.CNTR_SN AND X.FEE_PERF_EXCD_DV_CD = '01')
                    UNION ALL
                    /*전월 순수해지_렌탈취소 OK */
                    SELECT '순수해지' AS CAN_TP_NM
                         , C1.CNTR_NO
                         , C1.CNTR_SN
                         , C2.CNTR_CST_NM
                         , C1.CNTR_DTL_STAT_CD
                         , C1.CNTR_PD_STRTDT
                         , C1.CNTR_PD_ENDDT
                         , C1.BASE_PD_CD
                         , C1.SELL_TP_CD
                         , C1.SELL_TP_DTL_CD
                         , C1.BOO_SELL_TP_CD
                         , NVL(C1.FEE_FXAM_YN, 'N') AS FEE_FXAM_YN
                         , NVL(S2.CNFM_PSIC_PRTNR_OG_TP_CD, NVL(S1.FXN_PRTNR_OG_TP_CD, S1.MNGT_PRTNR_OG_TP_CD)) AS OG_TP_CD
                         , NVL(S2.CNFM_PSIC_PRTNR_NO, NVL(S1.FXN_PRTNR_NO, S1.MNGT_PRTNR_NO)) AS PRTNR_NO
                         , C2.CNTR_CNFM_DTM
                         , C2.SELL_OG_TP_CD  AS ORIG_OG_TP_CD
                         , C2.SELL_PRTNR_NO  AS ORIG_PRTNR_NO
                         , C3.CNTR_STAT_CH_RSON_CD
                         , '3'  AS PERF_DV_CD
                      FROM TB_SSCT_CNTR_DTL C1
                INNER JOIN TB_SSCT_CNTR_BAS C2
                        ON C1.CNTR_NO = C2.CNTR_NO
                INNER JOIN TB_SSCT_CNTR_RSG_PROCS_IZ C3
                        ON C1.CNTR_NO = C3.CNTR_NO
                       AND C1.CNTR_SN = C3.CNTR_SN
                 LEFT JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ S1
                        ON SUBSTR(C1.CNTR_PD_ENDDT, 1, 6) = S1.MNGT_YM
                       AND C1.CNTR_NO = S1.CNTR_NO
                       AND C1.CNTR_SN = S1.CNTR_SN
                 LEFT JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ S2
                        ON S1.MNGT_YM = S2.ASN_OJ_YM
                       AND S1.CNTR_NO = S2.CNTR_NO
                       AND S1.CNTR_SN = S2.CNTR_SN
                INNER JOIN TB_CUBS_CST_BAS B1
                        ON C2.CNTR_CST_NO = B1.CST_NO
                     WHERE 1 = 1
                       AND C1.SELL_TP_CD = '2'
                       AND C1.CNTR_DTL_STAT_CD LIKE '3%'
                       AND C1.CNTR_PD_ENDDT LIKE TO_CHAR(ADD_MONTHS(#{inqrStrtDt}, -1), 'YYYYMM') || '%'
                       AND C1.DTA_DL_YN = 'N'
                       AND C2.DTA_DL_YN = 'N'
                       AND C3.CNTR_STAT_CH_RSON_CD NOT IN ('11','19','22','42','08','09','36','77')
                       AND C3.PD_GD_CD != 'E'  /* 14일 이내 취소 제외 */
                       /* 수수료실적제외대상 제외*/
                       AND NOT EXISTS (SELECT 1 FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS X WHERE C1.CNTR_NO = X.CNTR_NO AND C1.CNTR_SN = X.CNTR_SN AND X.FEE_PERF_EXCD_DV_CD = '03')
                       /* 웰스팜제외 */
                       AND NOT EXISTS (
                                      SELECT 1
                                        FROM TB_FEAM_WELS_FEE_PDCT_TP_BAS X1 /*제품유형*/
                                       WHERE C1.BASE_PD_CD = X1.BASE_PD_CD
                                         AND SUBSTR(C1.CNTR_PD_ENDDT, 1, 8) BETWEEN X1.APY_STRT_YM AND X1.APY_END_YM
                                         AND X1.DTA_DL_YN = 'N'
                                         AND X1.FEE_PDCT_TP_CD1 = 'B'
                                      )
                       /* 판매제한사업자등록번호 제외 */
                       AND NOT EXISTS (SELECT 1
                                         FROM TB_SSCT_SELL_LM_OJ_IZ X1 /* 판매제한대상내역 */
                                        WHERE X1.DTA_DL_YN = 'N'
                                          AND X1.SELL_LM_BZRNO = B1.BZRNO
                                          AND X1.SELL_LM_PROCS_TP_CD IS NOT NULL )
                    UNION ALL
                    /*전월 순수해지_렌탈만료*/
                    SELECT /*+ ORDERED */
                           '만료' AS CAN_TP_NM
                         , C1.CNTR_NO
                         , C1.CNTR_SN
                         , C2.CNTR_CST_NM
                         , C1.CNTR_DTL_STAT_CD
                         , C1.CNTR_PD_STRTDT
                         , C1.CNTR_PD_ENDDT
                         , C1.BASE_PD_CD
                         , C1.SELL_TP_CD
                         , C1.SELL_TP_DTL_CD
                         , C1.BOO_SELL_TP_CD
                         , NVL(C1.FEE_FXAM_YN, 'N') AS FEE_FXAM_YN
                         , NVL(S2.CNFM_PSIC_PRTNR_OG_TP_CD, NVL(S1.FXN_PRTNR_OG_TP_CD, S1.MNGT_PRTNR_OG_TP_CD)) AS OG_TP_CD
                         , NVL(S2.CNFM_PSIC_PRTNR_NO, NVL(S1.FXN_PRTNR_NO, S1.MNGT_PRTNR_NO)) AS PRTNR_NO
                         , C2.CNTR_CNFM_DTM
                         , C2.SELL_OG_TP_CD  AS ORIG_OG_TP_CD
                         , C2.SELL_PRTNR_NO  AS ORIG_PRTNR_NO
                         , '' AS CNTR_STAT_CH_RSON_CD
                         , '4'  AS PERF_DV_CD
                      FROM TB_SSCT_CNTR_DTL C1
                INNER JOIN TB_SSCT_CNTR_BAS C2
                        ON C1.CNTR_NO = C2.CNTR_NO
                INNER JOIN TB_SSCT_CNTR_WELLS_DTL  C3
                        ON C1.CNTR_NO = C3.CNTR_NO
                       AND C1.CNTR_SN = C3.CNTR_SN
                 LEFT JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ S1
                        ON SUBSTR(C1.CNTR_PD_ENDDT, 1, 6) = S1.MNGT_YM
                       AND C1.CNTR_NO = S1.CNTR_NO
                       AND C1.CNTR_SN = S1.CNTR_SN
                 LEFT JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ S2
                        ON S1.MNGT_YM = S2.ASN_OJ_YM
                       AND S1.CNTR_NO = S2.CNTR_NO
                       AND S1.CNTR_SN = S2.CNTR_SN
                 /* 만료 후 익월 재렌탈시 순수해지 건수에서 제외 */
                 LEFT JOIN TB_SSCT_MCHN_CH_IZ X1
                        ON X1.OJ_CNTR_NO = C1.CNTR_NO
                       AND X1.OJ_CNTR_SN = C1.CNTR_SN
                       AND X1.MCHN_CH_TP_CD IN ('15', '16', '19') /* 15(자가관리), 16(멤버십진행), 19(57개월~60) */
                 LEFT JOIN TB_SSCT_CNTR_DTL X2
                        ON X2.CNTR_NO = X1.BASE_CNTR_NO
                       AND X2.CNTR_SN = X1.BASE_CNTR_SN
                 LEFT JOIN TB_SSCT_CNTR_BAS X3
                        ON X3.CNTR_NO = X2.CNTR_NO
                       AND X3.CNTR_CNFM_DTM LIKE SUBSTR(#{inqrStrtDt}, 1, 6) || '%'
                     WHERE 1 = 1
                       AND C1.SELL_TP_CD = '2'
                       AND C1.CNTR_DTL_STAT_CD IN ('401', '402')
                       AND TO_CHAR(ADD_MONTHS(TO_DATE(C1.CNTR_PD_STRTDT,'YYYYMMDD'), C1.CNTR_PTRM), 'YYYYMM') = TO_CHAR(ADD_MONTHS(#{inqrStrtDt}, -1), 'YYYYMM')
                       AND C3.REQD_DT IS NULL
                       AND C1.DTA_DL_YN = 'N'
                       AND C2.DTA_DL_YN = 'N'
                       /* 계정순증대상 제외*/
                       AND NOT EXISTS (SELECT 1 FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS X WHERE C1.CNTR_NO = X.CNTR_NO AND C1.CNTR_SN = X.CNTR_SN AND X.FEE_PERF_EXCD_DV_CD = '03')
                       /* 웰스팜제외 */
                       AND NOT EXISTS (
                                      SELECT 1
                                        FROM TB_FEAM_WELS_FEE_PDCT_TP_BAS X1 /*제품유형*/
                                       WHERE C1.BASE_PD_CD = X1.BASE_PD_CD
                                         AND SUBSTR(C1.CNTR_PD_ENDDT, 1, 8) BETWEEN X1.APY_STRT_YM AND X1.APY_END_YM
                                         AND X1.DTA_DL_YN = 'N'
                                         AND X1.FEE_PDCT_TP_CD1 = 'B'
                                      )
                       /* 만료 후 익월 재렌탈시 순수해지 건수에서 제외 --> 쿼리가 느려서 LEFT JOIN으로 변경 */
                       /*
                       AND NOT EXISTS (SELECT '1'
                                         FROM TB_SSCT_MCHN_CH_IZ X1
                                   INNER JOIN TB_SSCT_CNTR_DTL X2
                                           ON X1.BASE_CNTR_NO = X2.CNTR_NO
                                          AND X1.BASE_CNTR_SN = X2.CNTR_SN
                                   INNER JOIN TB_SSCT_CNTR_BAS X3
                                           ON X2.CNTR_NO = X3.CNTR_NO
                                        WHERE 1 = 1
                                          AND C1.CNTR_NO = X1.OJ_CNTR_NO
                                          AND C1.CNTR_SN = X1.OJ_CNTR_SN
                                          AND X2.CNTR_DTL_STAT_CD = '101'
                                          AND X1.MCHN_CH_TP_CD IN ('15', '16', '19') -- 15(자가관리), 16(멤버십진행), 19(57개월~60)
                                          AND X3.CNTR_CNFM_DTM LIKE SUBSTR({inqrStrtDt}, 1, 6) || '%')

                        */
                       AND X3.CNTR_NO IS NULL
                    /* 멤버십 가입건 예외처리 조건  */
                       AND NOT EXISTS (SELECT 1
                                         FROM TB_SSCT_CNTR_REL D2
                                   INNER JOIN TB_SSCT_CNTR_DTL T1
                                           ON D2.BASE_DTL_CNTR_NO = T1.CNTR_NO
                                          AND D2.BASE_DTL_CNTR_SN = T1.CNTR_SN
                                   INNER JOIN TB_SSCT_CNTR_BAS T2
                                           ON T1.CNTR_NO = T2.CNTR_NO
                                        WHERE 1 = 1
                                          AND C1.CNTR_NO = D2.OJ_DTL_CNTR_NO
                                          AND C1.CNTR_SN = D2.OJ_DTL_CNTR_SN
                                          AND D2.CNTR_REL_DTL_CD = '212'
                                          AND T1.CNTR_PD_STRTDT IS NOT NULL
                                          AND T2.SELL_INFLW_CHNL_DTL_CD NOT IN ('1030','1040')
                                      )
                    UNION ALL
                    /*전월 순수해지_멤버십탈퇴*/
                    SELECT /*+ ORDERED */
                           '멤버십탈퇴' AS CAN_TP_NM
                         , C1.CNTR_NO
                         , C1.CNTR_SN
                         , C2.CNTR_CST_NM
                         , C1.CNTR_DTL_STAT_CD
                         , C1.CNTR_PD_STRTDT
                         , C1.CNTR_PD_ENDDT
                         , C1.BASE_PD_CD
                         , C1.SELL_TP_CD
                         , C1.SELL_TP_DTL_CD
                         , C1.BOO_SELL_TP_CD
                         , NVL(C1.FEE_FXAM_YN, 'N') AS FEE_FXAM_YN
                         , NVL(S2.CNFM_PSIC_PRTNR_OG_TP_CD, NVL(S1.FXN_PRTNR_OG_TP_CD, S1.MNGT_PRTNR_OG_TP_CD)) AS OG_TP_CD
                         , NVL(S2.CNFM_PSIC_PRTNR_NO, NVL(S1.FXN_PRTNR_NO, S1.MNGT_PRTNR_NO)) AS PRTNR_NO
                         , C2.CNTR_CNFM_DTM
                         , C2.SELL_OG_TP_CD  AS ORIG_OG_TP_CD
                         , C2.SELL_PRTNR_NO  AS ORIG_PRTNR_NO
                         , '' AS CNTR_STAT_CH_RSON_CD
                         , '5'  AS PERF_DV_CD
                      FROM TB_SSCT_CNTR_DTL C1
                INNER JOIN TB_SSCT_CNTR_BAS C2
                        ON C1.CNTR_NO = C2.CNTR_NO
                INNER JOIN TB_SSCT_CNTR_RSG_PROCS_IZ C3
                        ON C1.CNTR_NO = C3.CNTR_NO
                       AND C1.CNTR_SN = C3.CNTR_SN
                 LEFT JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ S1
                        ON SUBSTR(C1.CNTR_PD_ENDDT, 1, 6) = S1.MNGT_YM
                       AND C1.CNTR_NO = S1.CNTR_NO
                       AND C1.CNTR_SN = S1.CNTR_SN
                 LEFT JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ S2
                        ON S1.MNGT_YM = S2.ASN_OJ_YM
                       AND S1.CNTR_NO = S2.CNTR_NO
                       AND S1.CNTR_SN = S2.CNTR_SN
                INNER JOIN TB_CUBS_CST_BAS B1
                        ON C2.CNTR_CST_NO = B1.CST_NO
                     WHERE 1 = 1
                       AND C1.SELL_TP_CD = '3'
                       -- 렌탈 및 일시불 멤버십
                       AND C1.SELL_TP_DTL_CD IN ('31', '32')
                       AND C1.CNTR_DTL_STAT_CD LIKE '3%'
                       AND C1.CNTR_PD_ENDDT LIKE TO_CHAR(ADD_MONTHS(#{inqrStrtDt}, -1), 'YYYYMM') || '%'
                       AND C1.DTA_DL_YN = 'N'
                       AND C2.DTA_DL_YN = 'N'
                       AND C3.CNTR_STAT_CH_RSON_CD NOT IN ('11','19','22','42','08','09','36','77')
                       /* 계정순증대상 제외 */
                       AND NOT EXISTS (SELECT 1 FROM TB_FEDD_FEE_PERF_EXCD_OJ_BAS X WHERE C1.CNTR_NO = X.CNTR_NO AND C1.CNTR_SN = X.CNTR_SN AND X.FEE_PERF_EXCD_DV_CD = '03')
                       /* 웰스팜제외 */
                       AND NOT EXISTS (
                                      SELECT 1
                                        FROM TB_FEAM_WELS_FEE_PDCT_TP_BAS X1 /*제품유형*/
                                       WHERE C1.BASE_PD_CD = X1.BASE_PD_CD
                                         AND SUBSTR(C1.CNTR_PD_ENDDT, 1, 8) BETWEEN X1.APY_STRT_YM AND X1.APY_END_YM
                                         AND X1.DTA_DL_YN = 'N'
                                         AND X1.FEE_PDCT_TP_CD1 = 'B'
                                      )
                       /* 판매제한사업자등록번호 제외 */
                       AND NOT EXISTS (SELECT 1
                                         FROM TB_SSCT_SELL_LM_OJ_IZ X1 /* 판매제한대상내역 */
                                        WHERE X1.DTA_DL_YN = 'N'
                                          AND X1.SELL_LM_PROCS_TP_CD IS NOT NULL
                                          AND X1.SELL_LM_BZRNO = B1.BZRNO )
                ) M
          LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL P1
            ON M.BASE_PD_CD = P1.PD_CD
           AND P1.PD_EXTS_PRP_GRP_CD = 'IND'
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ O1  /* 관리매니저 월파트너 */
            ON SUBSTR(M.CNTR_PD_ENDDT, 1, 6) = O1.BASE_YM
           AND M.OG_TP_CD = O1.OG_TP_CD
           AND M.PRTNR_NO = O1.PRTNR_NO
           AND O1.CLTN_DT LIKE SUBSTR(M.CNTR_PD_ENDDT, 1, 6) || '%'
          LEFT OUTER JOIN TB_OGBS_MM_OG_IZ O2  /* 관리매니저 월조직 */
            ON O1.BASE_YM = O2.BASE_YM
           AND O1.OG_ID = O2.OG_ID
          LEFT OUTER JOIN LATERAL (
                /* BS여부? */
                SELECT COUNT(1) AS ROW_SCNT
                  FROM DUAL
                 WHERE EXISTS (
                        SELECT 1
                          FROM TB_FEAM_WELS_SV_FEE_BAS T1
                         WHERE T1.BASE_PD_CD = M.BASE_PD_CD
                           AND T1.VST_MCN = 0
                           AND SUBSTR(M.CNTR_PD_ENDDT,1,6) BETWEEN T1.APY_STRT_YM AND T1.APY_END_YM
                           AND T1.DTA_DL_YN = 'N'
                       )
                    OR EXISTS (
                        SELECT 1
                          FROM TB_FEAM_WELS_SV_FEE_BAS T1
                          JOIN TB_PDBS_PD_REL T2
                            ON T1.BASE_PD_CD = T2.BASE_PD_CD
                           AND T2.PD_REL_TP_CD = '05'
                           AND M.CNTR_PD_ENDDT BETWEEN T2.VL_STRT_DTM AND T2.VL_END_DTM
                         WHERE VST_MCN = 0
                           AND SUBSTR(M.CNTR_PD_ENDDT,1,6) BETWEEN APY_STRT_YM AND APY_END_YM
                           AND T2.OJ_PD_CD IN (
                                  SELECT OJ_PD_CD
                                    FROM TB_PDBS_PD_REL T1
                                   WHERE T1.BASE_PD_CD = M.BASE_PD_CD
                                     AND T1.PD_REL_TP_CD = '05'
                                     AND M.CNTR_PD_ENDDT BETWEEN VL_STRT_DTM AND VL_END_DTM
                               )
                           AND T1.DTA_DL_YN = 'N'
                           AND ROWNUM = 1
                       )
                 ) WS ON 1=1
       WHERE 1 = 1
         AND NVL(O2.DGR3_LEVL_DG_PRTNR_NO, M.PRTNR_NO) IS NOT NULL /* NULL 오류로 인해서 파트너 not NULL 임시조치 */
    </sql>

    <select id="selectSellFeeEtPerfCans" resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefSellFeeEtPerfDto$SearchCanNincRes">
        SELECT OG.OG_CD
             , PR.PRTNR_KNM AS PRTNR_NM
             , T1.PRTNR_NO
             , PR.PSTN_DV_CD
             , T1.CNTR_NO
             , T1.CAN_TP_NM
             , T1.CNTR_CST_NM
             , '' AS CNTR_CNFM_DT
             , T1.CNTR_PD_STRTDT
             , T1.CNTR_PD_ENDDT AS CNTR_CAN_DT
             , T1.CNTR_STAT_CH_RSON_CD
             , P2.PD_CLSF_NM
             , P1.PD_CD
             , P1.PD_NM
             , PR2.OG_CD AS ORIG_OG_CD
             , PR2.PRTNR_KNM AS ORIG_PRTNR_NM
             , T1.ORIG_PRTNR_NO AS ORIG_SELL_PRTNR_NO
        FROM TB_OGBS_MM_PRTNR_IZ PR  /* 월파트너내역(매니저) */
        JOIN TB_OGBS_MM_OG_IZ OG  /* 월조직내역(매니저) */
          ON OG.BASE_YM = PR.BASE_YM
         AND OG.OG_ID = PR.OG_ID
        JOIN (
            <include refid="selectSellFeeEtPerfCans-from" />
             ) T1
          ON T1.OG_TP_CD = PR.OG_TP_CD
         AND T1.PRTNR_NO = PR.PRTNR_NO
        LEFT JOIN TB_OGBS_MM_PRTNR_IZ PR2   /* 판매자 */
          ON PR2.BASE_YM = SUBSTR(T1.CNTR_CNFM_DTM, 1, 6)
         AND PR2.OG_TP_CD = T1.ORIG_OG_TP_CD
         AND PR2.PRTNR_NO = T1.ORIG_PRTNR_NO
        JOIN TB_PDBS_PD_BAS P1
          ON P1.PD_CD = T1.BASE_PD_CD
        JOIN TB_PDBS_PD_CLSF_BAS P2
          ON P2.PD_CLSF_ID = P1.PD_MCLSF_ID
       WHERE 1=1
         AND PR.BASE_YM = SUBSTR(#{inqrStrtDt}, 1, 6)
         AND PR.OG_TP_CD != 'HR1'
        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
         AND PR.PRTNR_NO = #{prtnrNo}
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr1LevlOgCd)">
         AND OG.DGR1_LEVL_OG_CD = #{dgr1LevlOgCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr2LevlOgCd)">
         AND OG.DGR2_LEVL_OG_CD = #{dgr2LevlOgCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr3LevlOgCd)">
         AND OG.DGR3_LEVL_OG_CD = #{dgr3LevlOgCd}
        </if>
         AND OG.OG_CD BETWEEN 'A000000' AND 'P999999'
         AND T1.RENTAL_CAN_CT + T1.SPAY_RSG_CT + T1.MSH_SPR_CT + T1.RENTAL_EXN_CT > 0
       ORDER BY T1.RENTAL_CAN_CT + T1.SPAY_RSG_CT DESC
           , T1.MSH_SPR_CT DESC
           , T1.RENTAL_EXN_CT DESC
           , T1.CNTR_NO
    </select>
</mapper>
