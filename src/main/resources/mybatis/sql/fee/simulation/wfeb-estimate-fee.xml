<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.fee.simulation.mapper.WfefEstimateFeeMgtMapper">

    <select id="selectUserDvCd" resultType="String">
        SELECT CASE WHEN PSTN_DV_CD = '15' THEN 'INDV'
                    ELSE 'OG' END USER_DV_CD
          FROM TB_OGBS_MM_PRTNR_IZ /* 월파트너 */
         WHERE BASE_YM = #{perfYm}
           AND OG_TP_CD = #{ogTpCd}
           AND PRTNR_NO = #{sellPrtnrNo}
    </select>

    <select id='selectBaseP' resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$BaseP">
         SELECT  T1.PRTNR_KNM     /* 성명       */
              , T1.OG_CD        /* 조직코드    */
              , T1.RSB_DV_CD    /* 직책구분코드 */
              , CEIL(MONTHS_BETWEEN(TO_DATE(T1.BASE_YM||'01', 'YYYYMMDD'), TO_DATE(T1.CNTR_DT, 'YYYYMMDD'))) START_YM    --개시차월(CNTR_DT  : 계약일자)
              , CEIL(MONTHS_BETWEEN(TO_DATE(T1.BASE_YM||'01', 'YYYYMMDD'), TO_DATE(T1.PRFMT_DT, 'YYYYMMDD'))) PRFMT_YM   --승진차월(PRFMT_DT : 승진일자)
              , NVL(T4.PERF_VAL, 0) AS METG_DC /* 미팅일수 */
              , 0 AS AMT_EST_SAL_FEE /* 예상판매수수료 - 개인 */
              , 0 AS AMT_MUT_AID_FEE /* 예상상조수수료 - 개인 */
              , 0 AS AMT_EST_OG_FEE /* 예상조직수수료 - 조직*/
              , 0 AS AMT_FEE_SUM
          FROM TB_OGBS_MM_PRTNR_IZ    T1   /* 파트너기본           */
          LEFT OUTER JOIN TB_FEAM_PRTNR_PERF_MM_ACU_CL T4 /* 파트너실적월누적마감 */
            ON T4.MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
           AND T4.BASE_YM = T1.BASE_YM
           AND T4.OG_TP_CD = T1.OG_TP_CD
           AND T4.PRTNR_NO = T1.PRTNR_NO
           AND T4.PERF_ATC_CD = 'W01P00012'
         WHERE T1.BASE_YM = #{req.perfYm}
           AND T1.OG_TP_CD  = 'W01' /* 조직유형코드:P추진단 */
           AND T1.PRTNR_NO  = #{req.sellPrtnrNo}
           AND T1.DTA_DL_YN = 'N'
        GROUP BY T1.PRTNR_KNM, T1.OG_CD, T1.RSB_DV_CD, T1.BASE_YM, T1.PRFMT_DT, T1.CNTR_DT, T4.PERF_VAL
    </select>

    <select id='selectMeetingP' resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$MeetingP">
        SELECT 'A' AS TYPE
             , (SELECT SUBSTR(MAX(EDUC_CPC_ACKMT_DT), 1, 6)
                  FROM TB_PSCA_MCPTN_EDUC_IZ
                 WHERE PRTNR_NO          =  #{req.sellPrtnrNo}
                   AND EDUC_CPC_ACKMT_DT >= (SELECT NVL(RCNTR_DT, CNTR_DT)
                                               FROM TB_OGBS_MM_PRTNR_IZ
                                              WHERE BASE_YM = #{req.perfYm}
                                                AND OG_TP_CD = 'W01'
                                                AND PRTNR_NO = #{req.sellPrtnrNo})
                   AND EDUC_CPC_ACKMT_YN = 'Y'
                   AND DTA_DL_YN         = 'N'
                   AND EDUC_CRSE_NO = '14') AS PLAR_SRTUP
             , (SELECT SUBSTR(MAX(EDUC_CPC_ACKMT_DT), 1, 4) || '-' || SUBSTR(MAX(EDUC_CPC_ACKMT_DT), 5, 2)
                  FROM TB_PSCA_MCPTN_EDUC_IZ
                 WHERE PRTNR_NO          =  #{req.sellPrtnrNo}
                   AND EDUC_CPC_ACKMT_DT >= (SELECT NVL(RCNTR_DT, CNTR_DT)
                                               FROM TB_OGBS_MM_PRTNR_IZ
                                              WHERE BASE_YM = #{req.perfYm}
                                                AND OG_TP_CD = 'W01'
                                                AND PRTNR_NO = #{req.sellPrtnrNo})
                   AND EDUC_CPC_ACKMT_YN = 'Y'
                   AND DTA_DL_YN         = 'N'
                   AND EDUC_CRSE_NO = '19') AS PLANNER_PRCTC
             , ( SELECT NVL(SUM(PERF_VAL), 0)
                   FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL  /* 월누적파트너계약실적마감 */
                  WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                    AND BASE_YM                    = #{req.perfYm}
                    AND OG_TP_CD                   = 'W01'
                    AND PRTNR_NO                   = #{req.sellPrtnrNo}
                    AND PERF_ATC_CD                = 'W01P00012' /* 미팅참석일 */
                    AND DTA_DL_YN                  = 'N'  ) AS METG_PRSC_D
             , ( SELECT NVL(SUM(PERF_VAL), 0)
                   FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL  /* 월누적파트너계약실적마감 */
                  WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                    AND BASE_YM                    = #{req.perfYm}
                    AND OG_TP_CD                   = 'W01'
                    AND PRTNR_NO                   = #{req.sellPrtnrNo}
                    AND PERF_ATC_CD                = 'W01P00020' /* 실활동인원수 */
                    AND DTA_DL_YN                  = 'N'  ) AS ACL_ACTI_PSNO
        FROM DUAL
        UNION ALL
        SELECT 'B' AS TYPE
             , '' AS PLAR_SRTUP
             , ( SELECT NVL(FEE_PERF_ATC_VAL, 'N')
                   FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL  /* 월누적파트너계약실적마감 */
                  WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                    AND BASE_YM                    = #{req.perfYm}
                    AND OG_TP_CD                   = 'W01'
                    AND PRTNR_NO                   = #{req.sellPrtnrNo}
                    AND PERF_ATC_CD                = 'W01P00047' /* 플래너실적교육이수여부 */
                    AND DTA_DL_YN                  = 'N'  ) AS PLANNER_PRCTC
             , ( SELECT NVL(SUM(PERF_VAL), 0)
                   FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL  /* 월누적파트너계약실적마감 */
                  WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                    AND BASE_YM                    = #{req.perfYm}
                    AND OG_TP_CD                   = 'W01'
                    AND PRTNR_NO                   = #{req.sellPrtnrNo}
                    AND PERF_ATC_CD                = 'W01P00012' /* 미팅참석일 */
                    AND DTA_DL_YN                  = 'N'  ) AS METG_PRSC_D
             , ( SELECT NVL(SUM(PERF_VAL), 0)
                   FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL  /* 월누적파트너계약실적마감 */
                  WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                    AND BASE_YM                    = #{req.perfYm}
                    AND OG_TP_CD                   = 'W01'
                    AND PRTNR_NO                   = #{req.sellPrtnrNo}
                    AND PERF_ATC_CD                = 'W01P00020' /* 실활동인원수 */
                    AND DTA_DL_YN                  = 'N'  ) AS ACL_ACTI_PSNO
        FROM DUAL
    </select>

    <select id='selectPerformanceP' resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$PerformanceP">
        WITH INDV_PERF AS (SELECT (SELECT PERF_VAL
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W01'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W01P00003' /* 가전 실적 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1)  AS AMT_ELHM
                                 , (SELECT PERF_VAL
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W01'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W01P00004' /* 가전 실적 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1)  AS AMT_EXCEPT_ELHM
                                 , (SELECT PERF_VAL
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W01'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W01P00018' /* BS판매건수 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1)  AS AMT_BS_SALE
                                 , (SELECT COUNT(1)
                                      FROM TB_IFIN_LIF_ALNC_FEE_CNTR_IZ /* 라이프제휴수수료계약내역 */
                                     WHERE BASE_YM =#{req.perfYm}
                                       AND OG_TP_CD = 'W01'
                                       AND LIF_CNTR_STAT_CD = '0'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND LIF_PD_CD = '2178') AS AMT_MUTU_429
                                 , (SELECT COUNT(1)
                                      FROM TB_IFIN_LIF_ALNC_FEE_CNTR_IZ /* 라이프제휴수수료계약내역 */
                                     WHERE BASE_YM =#{req.perfYm}
                                       AND OG_TP_CD = 'W01'
                                       AND LIF_CNTR_STAT_CD = '0'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND LIF_PD_CD = '2179') AS AMT_MUTU_599
                            FROM DUAL)
        , OG_PERF AS (SELECT  (SELECT PERF_VAL
                                  FROM TB_FEAM_MACUP_PERF_CL
                                 WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                   AND BASE_YM = #{req.perfYm}
                                   AND OG_TP_CD = 'W01'
                                   AND PRTNR_NO = #{req.sellPrtnrNo}
                                   AND PERF_ATC_CD = 'W01P00003' /* 가전 실적 */
                                   AND PERF_DV_CD = '2'
                                   AND ROWNUM = 1)  AS AMT_ELHM
                             , (SELECT PERF_VAL
                                  FROM TB_FEAM_MACUP_PERF_CL
                                 WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                   AND BASE_YM = #{req.perfYm}
                                   AND OG_TP_CD = 'W01'
                                   AND PRTNR_NO = #{req.sellPrtnrNo}
                                   AND PERF_ATC_CD = 'W01P00004' /* 가전 실적 */
                                   AND PERF_DV_CD = '2'
                                   AND ROWNUM = 1)  AS AMT_EXCEPT_ELHM
                             , (SELECT PERF_VAL
                                  FROM TB_FEAM_MACUP_PERF_CL
                                 WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                   AND BASE_YM = #{req.perfYm}
                                   AND OG_TP_CD = 'W01'
                                   AND PRTNR_NO = #{req.sellPrtnrNo}
                                   AND PERF_ATC_CD = 'W01P00018' /* BS판매건수 */
                                   AND PERF_DV_CD = '2'
                                   AND ROWNUM = 1)  AS AMT_BS_SALE
                             , (SELECT COUNT(1)
                                  FROM TB_IFIN_LIF_ALNC_FEE_CNTR_IZ T1 /* 라이프제휴수수료계약내역 */
                                  INNER JOIN TB_FEAM_MM_PRTNR_HOO_IZ T2
                                  ON (T1.BASE_YM = T2.BASE_YM AND T1.OG_TP_CD = T2.OG_TP_CD AND T1.PRTNR_NO = T2.PRTNR_NO)
                                 WHERE T1.BASE_YM =#{req.perfYm}
                                   AND T1.OG_TP_CD = 'W01'
                                   AND T1.LIF_CNTR_STAT_CD = '0'
                                   AND T2.HOO_PRTNR_NO = #{req.sellPrtnrNo}
                                   AND T2.PRTNR_NO != T2.HOO_PRTNR_NO /* 판매자와 조직장이 동인인 데이터는 조직실적에서 제외 */
                                   AND T1.LIF_PD_CD = '2178') AS AMT_MUTU_429
                             , (SELECT COUNT(1)
                                  FROM TB_IFIN_LIF_ALNC_FEE_CNTR_IZ T1 /* 라이프제휴수수료계약내역 */
                                  INNER JOIN TB_FEAM_MM_PRTNR_HOO_IZ T2
                                  ON (T1.BASE_YM = T2.BASE_YM AND T1.OG_TP_CD = T2.OG_TP_CD AND T1.PRTNR_NO = T2.PRTNR_NO)
                                 WHERE T1.BASE_YM =#{req.perfYm}
                                   AND T1.OG_TP_CD = 'W01'
                                   AND T1.LIF_CNTR_STAT_CD = '0'
                                   AND T2.HOO_PRTNR_NO = #{req.sellPrtnrNo}
                                   AND T2.PRTNR_NO != T2.HOO_PRTNR_NO /* 판매자와 조직장이 동인인 데이터는 조직실적에서 제외 */
                                   AND T1.LIF_PD_CD = '2179') AS AMT_MUTU_599
                        FROM DUAL)
        SELECT 'A' AS TYPE
             , AMT_ELHM
             , AMT_EXCEPT_ELHM
             , AMT_NET_ORDER
             , AMT_BS_SALE
             , AMT_MUTU_429
             , AMT_MUTU_599
          FROM INDV_PERF
        UNION ALL
        SELECT 'B' AS TYPE
             , AMT_ELHM
             , AMT_EXCEPT_ELHM
             , AMT_NET_ORDER
             , AMT_BS_SALE
             , AMT_MUTU_429
             , AMT_MUTU_599
          FROM INDV_PERF
        <if test='@MybatisUtils@equals(userDvCd, "OG")'>
        UNION ALL
        SELECT 'C' AS TYPE
             , AMT_ELHM
             , AMT_EXCEPT_ELHM
             , AMT_NET_ORDER
             , AMT_BS_SALE
             , AMT_MUTU_429
             , AMT_MUTU_599
          FROM OG_PERF
        UNION ALL
        SELECT 'D' AS TYPE
             , AMT_ELHM
             , AMT_EXCEPT_ELHM
             , AMT_NET_ORDER
             , AMT_BS_SALE
             , AMT_MUTU_429
             , AMT_MUTU_599
          FROM OG_PERF
        </if>
    </select>

    <select id='selectEstimatePM' resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$EstimatePM">
        SELECT T2.DTA_CRT_FEE_CD AS FEE_CD
             , T2.FEE_NM
             , SUM(NVL(T3.FEE_CALC_AMT, 0)) AS ESTI_VAL_SUM
             , T2.FEE_ATC_TP_CD
             , T2.SRN_MARK_ODR_SN
          FROM TB_OGBS_MM_PRTNR_IZ T1
          LEFT OUTER JOIN (SELECT CD.FEE_CD
                                             , CD.DTA_CRT_FEE_CD
                                             , DTL.SRN_MARK_FEE_NM AS FEE_NM
                                             , CD.SRN_MARK_ODR_SN
                                             , CD_DTL.FEE_ATC_TP_CD
                                          FROM TB_FEAM_FEE_CD CD /* 수수료코드           */
                                               INNER JOIN TB_FEAM_FEE_BASE_DTL DTL
                                                          ON (CD.FEE_CD = DTL.FEE_CD)
                                               LEFT OUTER JOIN TB_FEAM_FEE_CD_DTL CD_DTL
                                                               ON (CD.FEE_CD = CD_DTL.FEE_CD)
                                         WHERE 1=1
                                           AND (DTL.FEE_CD, DTL.APY_TN) IN
                                                     <foreach collection="feeCds" item="item" open="(" close=")" separator=",">
                                                        (#{item.feeCd}, #{item.apyTn})
                                                      </foreach>
                                        ) T2
                                       ON (1 = 1)
                       LEFT OUTER JOIN TB_FEAM_FEE_SML_BAS T3 /* 수수료시뮬레이션기본 */
                                       ON T1.OG_TP_CD = T3.OG_TP_CD
                                           AND T1.PRTNR_NO = T3.PRTNR_NO
                                           AND T1.BASE_YM = T3.OJ_DSB_YM
                                           AND T2.FEE_CD = T3.FEE_CD
                                           AND T2.DTA_CRT_FEE_CD = T3.DTA_CRT_FEE_CD
                                           AND T3.DTA_DL_YN = 'N'
                                           AND T3.SML_CRT_TP_CD = DECODE(#{req.perType}, '00', '01', '02')
                 WHERE T1.BASE_YM = #{req.perfYm}
                   AND T1.OG_TP_CD = #{ogTpCd}
                   AND T1.PRTNR_NO = #{req.sellPrtnrNo}
                   AND T1.DTA_DL_YN = 'N'
                 GROUP BY T2.DTA_CRT_FEE_CD, T2.FEE_NM, T2.FEE_ATC_TP_CD, T2.SRN_MARK_ODR_SN
        ORDER BY T2.SRN_MARK_ODR_SN
    </select>

    <select id='selectSaleP' resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$SaleP">
        SELECT
               T2.PRTNR_KNM        /* 성명                               */
             , T1.PRTNR_NO         /* 번호                               */
             , T3.CNTR_RCP_FSH_DTM /* 접수일자 - 계약접수완료일시        */
             , T3.CNTR_CNFM_DTM    /* 매출일자 - 계약확정일시            */
             , T3.CNTR_CAN_DTM
             , T1.CNTR_NO          /* 계약번호                           */
             , T5.PD_NM            /* 상품내역                           */
             , T6.CST_KNM          /* 고객명                             */
             , T7.MCHN_CH_TP_CD      /* 기변유형 - 기기변경유형코드        */
             , NVL(SUM(NVL(CASE WHEN T1.PERF_ATC_CD = 'W01P00001' THEN T1.PERF_VAL ELSE 0 END, 0)), 0) AMT_SUM_ELHM /* 가전   - 실적금액 */
             , NVL(SUM(NVL(CASE WHEN T1.PERF_ATC_CD = 'W00P00028' THEN T1.PERF_VAL ELSE 0 END, 0)), 0) AMT_SUM_CHNG /* 기변   - 실적금액 */
             , NVL(SUM(NVL(CASE WHEN T1.PERF_ATC_CD = 'W01P00004' THEN T1.PERF_VAL ELSE 0 END, 0)), 0) AMT_SUM_EXCEPT_ELHM /* 가전외 - 실적금액 */
         FROM TB_FEAM_MACUP_CNTR_PERF_CL  T1 /* 월누적파트너계약실적마감 */
         <if test='@MybatisUtils@equals(userDvCd, "OG")'>
        INNER JOIN TB_FEAM_MM_PRTNR_HOO_IZ T8
           ON T1.BASE_YM = T8.BASE_YM
          AND T1.OG_TP_CD = T8.OG_TP_CD
          AND T1.PRTNR_NO = T8.PRTNR_NO
         </if>
         LEFT OUTER JOIN TB_OGBS_PRTNR_BAS           T2 /* 파트너기본               */
           ON T2.OG_TP_CD    = T1.OG_TP_CD
          AND T2.PRTNR_NO    = T1.PRTNR_NO
         LEFT OUTER JOIN TB_SSCT_CNTR_BAS            T3 /* 계약기본                 */
           ON T3.CNTR_NO     = T1.CNTR_NO
         LEFT OUTER JOIN TB_SSCT_CNTR_DTL            T4 /* 계약상세                 */
           ON T4.CNTR_NO     = T1.CNTR_NO
          AND T4.CNTR_SN     = T1.CNTR_SN
         LEFT OUTER JOIN TB_PDBS_PD_BAS              T5 /* 상품기본                 */
           ON T5.PD_CD       = T4.BASE_PD_CD
         LEFT OUTER JOIN TB_CUBS_CST_BAS             T6 /* 고객기본                 */
           ON T6.CST_NO      = T3.CNTR_CST_NO
         LEFT OUTER JOIN TB_FEAM_WELS_MM_ACU_CNTR_CL T7 /* 웰스월누적계약마감       */
           ON  T7.MM_ACU_PERF_AGRG_CRT_DV_CD = T1.MM_ACU_PERF_AGRG_CRT_DV_CD
          AND  T7.BASE_YM     = T1.BASE_YM
          AND  T7.CNTR_NO     = T1.CNTR_NO
          AND  T7.CNTR_SN     = T1.CNTR_SN
          AND  T7.OG_TP_CD    = T1.OG_TP_CD
          AND  T7.PRTNR_NO    = T1.PRTNR_NO
          AND  T7.CAN_DT     IS NULL
          AND  T7.MCHN_CH_YN  = 'Y'
        WHERE T1.MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}   --접수-00:총주문월누적, 매출-01:순주문월누적
          AND T1.BASE_YM                    = #{req.perfYm}
          AND T1.OG_TP_CD                   = 'W01'
          AND T1.PERF_ATC_CD                IN ('W01P00001', 'W00P00028', 'W01P00004')
         <if test='@MybatisUtils@equals(userDvCd, "INDV")'>
          AND T1.PRTNR_NO                   = #{req.sellPrtnrNo}
         </if>
         <if test='@MybatisUtils@equals(userDvCd, "OG")'>
          AND T8.HOO_PRTNR_NO               = #{req.sellPrtnrNo}
         </if>
          AND T1.DTA_DL_YN                  = 'N'
        GROUP BY T2.PRTNR_KNM
               , T1.PRTNR_NO
               , T3.CNTR_RCP_FSH_DTM
               , T3.CNTR_CNFM_DTM
               , T3.CNTR_CAN_DTM
               , T1.CNTR_NO
               , T5.PD_NM
               , T6.CST_KNM
               , T7.MCHN_CH_TP_CD
    </select>

    <select id='selectBaseM' resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$BaseM">
        SELECT T1.PRTNR_KNM                             /* 성명                        */
             , T1.OG_CD                                 /* 조직코드                    */
             , T2.RSB_DV_CD                             /* 직책구분코드 - T2.RSB_DV_CD */
             , T2.QLF_DV_CD                             /* 자격구분코드 */
             , CEIL(MONTHS_BETWEEN(TO_DATE(T1.BASE_YM||'01', 'YYYYMMDD'), TO_DATE(T2.CNTR_DT, 'YYYYMMDD'))) START_YM    --개시차월(CNTR_DT  : 계약일자)
             , CEIL(MONTHS_BETWEEN(TO_DATE(T1.BASE_YM||'01', 'YYYYMMDD'), TO_DATE(T1.PRFMT_DT, 'YYYYMMDD'))) PRFMT_YM   --승진차월(PRFMT_DT : 승진일자)
             , NVL(SUM(CASE WHEN T3.FEE_CD IN ('W020017'   --조직판매장려(매니저지점장)
                                             , 'W020012'   --판매장려(매니저)
                                             , 'W020011'   --판매장려(매니저지점장)
                                             , 'W020009'   --판매장려(수석플래너)
                                             , 'W020008' ) --판매장려(플래너)
                            THEN T3.FEE_CALC_AMT
                            ELSE 0 END), 0) AS AMT_EST_SAL_FEE /* 예상판매수수료              */
            <choose>
            <when test='@MybatisUtils@equals(userDvCd, "OG")'>
            , 9 AS AMT_EST_OG_FEE /* todo 조직계산식 */
            </when>
            <otherwise>
            , 0 AS AMT_EST_OG_FEE
            </otherwise>
            </choose>
             , NVL(SUM(CASE WHEN T3.FEE_CD IN ('W020087'   --BS관리(지점장)
                                              ,'W020084' ) --BS관리(판매자)
                            THEN T3.FEE_CALC_AMT
                            ELSE 0 END), 0) AS AMT_EST_BS_FEE  /* 예상BS수수료                */
             , 0 AS AMT_FEE_SUM
         FROM TB_OGBS_MM_PRTNR_IZ T1 /* 월파트너내역         */
        INNER JOIN TB_OGBS_PRTNR_DTL T2 /* 파트너상세           */
           ON T2.OG_TP_CD    = T1.OG_TP_CD
          AND T2.PRTNR_NO    = T1.PRTNR_NO
         LEFT OUTER JOIN  TB_FEAM_FEE_SML_BAS  T3 /* 수수료시뮬레이션기본 */
           ON T3.OG_TP_CD    = T1.OG_TP_CD
          AND T3.PRTNR_NO    = T1.PRTNR_NO
          AND T3.BASE_YM     = T1.BASE_YM
          AND T3.DTA_DL_YN   = 'N'
         LEFT OUTER JOIN TB_FEAM_FEE_BASE_DTL T4 /* 수수료기준상세       */
           ON T4.FEE_CD       = T3.FEE_CD
          AND T4.APY_STRT_YM <![CDATA[<=]]> #{req.perfYm}
          AND T4.APY_END_YM  >= #{req.perfYm}
          AND T4.FNL_FEE_YN   = 'Y'
          AND T4.DTA_DL_YN    = 'N'
        WHERE T1.BASE_YM   = #{req.perfYm}
          AND T1.OG_TP_CD  = 'W02' /* 조직유형코드:M추진단 */
          AND T1.PRTNR_NO  = #{req.sellPrtnrNo}
          AND T1.DTA_DL_YN = 'N'
        GROUP BY T1.PRTNR_KNM, T1.OG_CD, T2.RSB_DV_CD, T2.QLF_DV_CD, T1.BASE_YM, T1.PRFMT_DT, T2.CNTR_DT
    </select>

    <select id='selectMeetingM' resultType="java.util.Map">
        SELECT *
          FROM (
              <foreach collection="meetingPerfAtcCds" item="item" separator="UNION ALL">
                  <choose>
                    <when test='@MybatisUtils@equals(item.type,"EDUC")'>
                  SELECT 'A' AS TYPE
                       , (SELECT TO_CHAR(MAX(SUBSTR(EDUC_CPC_ACKMT_DT, 1,4)||'-'||SUBSTR(EDUC_CPC_ACKMT_DT, 5,2)))
                          FROM TB_PSCA_MCPTN_EDUC_IZ
                         WHERE PRTNR_NO          =  #{req.sellPrtnrNo}
                           AND EDUC_CPC_ACKMT_DT >= (SELECT NVL(RCNTR_DT, CNTR_DT)
                                                       FROM TB_OGBS_MM_PRTNR_IZ
                                                      WHERE BASE_YM = #{req.perfYm} --교육수료인정일자
                                                        AND OG_TP_CD = 'W02'
                                                        AND PRTNR_NO = #{req.sellPrtnrNo})
                           AND EDUC_CPC_ACKMT_YN = 'Y'               --교육수료인정여부
                           AND DTA_DL_YN         = 'N'
                           AND EDUC_CRSE_NO = ${item.eduCd}) AS EDU_DT
                        , #{item.perfAtcCd} AS PERF_ATC_CD
                   FROM DUAL
                    </when>
                    <when test='@MybatisUtils@equals(item.type,"METG")'>
                    SELECT 'A' AS TYPE
                         , (SELECT TO_CHAR(PERF_VAL)
                              FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL
                             WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                               AND BASE_YM = #{req.perfYm}
                               AND PERF_ATC_CD = 'W02P00093'
                               AND CO_CD = '2000'
                               AND OG_TP_CD = 'W02'
                               AND PRTNR_NO = #{req.sellPrtnrNo}) AS EDU_DT
                        , 'W02P00093' AS PERF_ATC_CD
                      FROM DUAL
                    </when>
                    <when test='@MybatisUtils@equals(item.type,"PERF")'>
                    SELECT 'A' AS TYPE
                         , (SELECT TO_CHAR(${item.perfColNm})
                              FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL
                             WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                               AND BASE_YM = #{req.perfYm}
                               AND PERF_ATC_CD = #{item.perfAtcCd}
                               AND CO_CD = '2000'
                               AND OG_TP_CD = 'W02'
                               AND PRTNR_NO = #{req.sellPrtnrNo}) AS EDU_DT
                        , #{item.perfAtcCd} AS PERF_ATC_CD
                      FROM DUAL
                    </when>
                  </choose>
              </foreach>
          ) PIVOT (MAX(EDU_DT) FOR PERF_ATC_CD IN (${pivotColumn}))
        UNION ALL
        SELECT *
          FROM (
              <foreach collection="meetingPerfAtcCds" item="item" separator="UNION ALL">
                SELECT 'B' AS TYPE
                     , (SELECT TO_CHAR(${item.perfColNm})
                            FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL
                           WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                             AND BASE_YM = #{req.perfYm}
                             AND PERF_ATC_CD = #{item.perfAtcCd}
                             AND CO_CD = '2000'
                             AND OG_TP_CD = 'W02'
                             AND PRTNR_NO = #{req.sellPrtnrNo}) AS PERF_VAL
                       , #{item.perfAtcCd} AS PERF_ATC_CD
                    FROM DUAL
              </foreach>
          ) PIVOT (MAX(PERF_VAL) FOR PERF_ATC_CD IN (${pivotColumn}))
    </select>

    <select id='selectPerformanceM' resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$PerformanceM">
        WITH INDV_PERF AS (SELECT (SELECT NVL(PERF_VAL, 0)
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W02'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W02P00002' /* 가전인정건수 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1)  AS ELHM_ACKMT_CT
                                 , (SELECT NVL(PERF_VAL, 0)
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W02'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W00P00003' /* 기준렌탈료 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1)  AS RENTAL_BASE_PRC
                                 , (SELECT NVL(PERF_VAL, 0)
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W02'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W00P00004' /* 일시불/할부 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1)  AS SNGL_PMNT_BASE_PRC
                                 , (SELECT NVL(PERF_VAL, 0)
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W02'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W02P00112' /* 가전외인정실적금액 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1)  AS ELHM_EXCP_ACKMT_PERF
                                 , (SELECT NVL(PERF_VAL, 0)
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W02'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W02P00113' /* 계정순증건수 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1)  AS NINC
                            FROM DUAL)
        , OG_PERF AS (SELECT  (SELECT NVL(PERF_VAL, 0)
                                  FROM TB_FEAM_MACUP_PERF_CL
                                 WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                   AND BASE_YM = #{req.perfYm}
                                   AND OG_TP_CD = 'W02'
                                   AND PRTNR_NO = #{req.sellPrtnrNo}
                                   AND PERF_ATC_CD = 'W02P00103' /* 가전인정건수 */
                                   AND PERF_DV_CD = '2'
                                   AND ROWNUM = 1)  AS ELHM_ACKMT_CT
                             , (SELECT NVL(PERF_VAL, 0)
                                  FROM TB_FEAM_MACUP_PERF_CL
                                 WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                   AND BASE_YM = #{req.perfYm}
                                   AND OG_TP_CD = 'W02'
                                   AND PRTNR_NO = #{req.sellPrtnrNo}
                                   AND PERF_ATC_CD = 'W00P00033' /* 기준렌탈료 */
                                   AND PERF_DV_CD = '2'
                                   AND ROWNUM = 1)  AS RENTAL_BASE_PRC
                             , (SELECT NVL(PERF_VAL,0)
                                  FROM TB_FEAM_MACUP_PERF_CL
                                 WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                   AND BASE_YM = #{req.perfYm}
                                   AND OG_TP_CD = 'W02'
                                   AND PRTNR_NO = #{req.sellPrtnrNo}
                                   AND PERF_ATC_CD = 'W00P00006' /* 일시불/할부 */
                                   AND PERF_DV_CD = '2'
                                   AND ROWNUM = 1)  AS SNGL_PMNT_BASE_PRC
                             , (SELECT NVL(PERF_VAL, 0)
                                  FROM TB_FEAM_MACUP_PERF_CL
                                 WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                   AND BASE_YM = #{req.perfYm}
                                   AND OG_TP_CD = 'W02'
                                   AND PRTNR_NO = #{req.sellPrtnrNo}
                                   AND PERF_ATC_CD = 'W02P00112' /* 가전외인정실적금액 */
                                   AND PERF_DV_CD = '2'
                                   AND ROWNUM = 1)  AS ELHM_EXCP_ACKMT_PERF
                             , (SELECT NVL(PERF_VAL, 0)
                                  FROM TB_FEAM_MACUP_PERF_CL
                                 WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                   AND BASE_YM = #{req.perfYm}
                                   AND OG_TP_CD = 'W02'
                                   AND PRTNR_NO = #{req.sellPrtnrNo}
                                   AND PERF_ATC_CD = 'W02P00113' /* 계정순증건수 */
                                   AND PERF_DV_CD = '2'
                                   AND ROWNUM = 1)  AS NINC
                        FROM DUAL)
        SELECT 'A' AS TYPE
             , ELHM_ACKMT_CT /* 가전인정건수 */
             , RENTAL_BASE_PRC  /* 기준렌탈료  */
             , SNGL_PMNT_BASE_PRC   /* 일시불/할부   */
             , ELHM_EXCP_ACKMT_PERF   /* 가전외인정실적금액 */
             , NINC  /* 계정순증건수 */
          FROM INDV_PERF
        UNION ALL
        SELECT 'B' AS TYPE
             , ELHM_ACKMT_CT /* 가전인정건수 */
             , RENTAL_BASE_PRC  /* 기준렌탈료  */
             , SNGL_PMNT_BASE_PRC   /* 일시불/할부   */
             , ELHM_EXCP_ACKMT_PERF   /* 가전외인정실적금액 */
             , NINC  /* 계정순증건수 */
          FROM INDV_PERF
        <if test='@MybatisUtils@equals(userDvCd, "OG")'>
        UNION ALL
        SELECT 'C' AS TYPE
             , ELHM_ACKMT_CT /* 가전인정건수 */
             , RENTAL_BASE_PRC  /* 기준렌탈료  */
             , SNGL_PMNT_BASE_PRC   /* 일시불/할부   */
             , ELHM_EXCP_ACKMT_PERF   /* 가전외인정실적금액 */
             , NINC  /* 계정순증건수 */
          FROM OG_PERF
        UNION ALL
        SELECT 'D' AS TYPE
             , ELHM_ACKMT_CT /* 가전인정건수 */
             , RENTAL_BASE_PRC  /* 기준렌탈료  */
             , SNGL_PMNT_BASE_PRC   /* 일시불/할부   */
             , ELHM_EXCP_ACKMT_PERF   /* 가전외인정실적금액 */
             , NINC  /* 계정순증건수 */
          FROM OG_PERF
        </if>
    </select>

    <select id='selectBsM' resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$BsM">
        WITH T0 AS ( SELECT SUM(CASE WHEN T1.SV_FEE_PD_DV_CD = '01' THEN 1 ELSE 0 END) AS WRFR_01    /* 정수기1             */
                          , SUM(CASE WHEN T1.SV_FEE_PD_DV_CD = '02' THEN 1 ELSE 0 END) AS WRFR_02    /* 정수기2             */
                          , SUM(CASE WHEN T1.SV_FEE_PD_DV_CD = '03' THEN 1 ELSE 0 END) AS WRFR_03    /* 정수기3             */
                          , SUM(CASE WHEN T1.SV_FEE_PD_DV_CD = '04' THEN 1 ELSE 0 END) AS WRFR_04    /* 정수기4             */
                          , SUM(CASE WHEN T1.SV_FEE_PD_DV_CD = '05' THEN 1 ELSE 0 END) AS UN_WRFR    /* 비정수기            */
                          , SUM(CASE WHEN T1.SV_FEE_PD_DV_CD = '06' THEN 1 ELSE 0 END) AS PUF_01     /* 청정기1             */
                          , SUM(CASE WHEN T1.SV_FEE_PD_DV_CD = '07' THEN 1 ELSE 0 END) AS PUF_02     /* 청정기2             */
                          , SUM(CASE WHEN T1.SV_FEE_PD_DV_CD = '08' THEN 1 ELSE 0 END) AS OTSC_ETC   /* 아웃소싱,커피,삼성  */
                          , SUM(CASE WHEN T1.SV_FEE_PD_DV_CD = '09' THEN 1 ELSE 0 END) AS BDT_ETC    /* 비데,연수기         */
                          , SUM(CASE WHEN T1.SV_FEE_PD_DV_CD IN ('01', '02', '03', '04', '05', '06', '07', '08', '09') THEN 1 ELSE 0 END) AS PRD_SUM  /* 합계 */
                          , SUM(CASE WHEN T1.VST_RGLVL_GD_CD IN ('3', '03')  THEN 1 ELSE 0 END) AS W1         /* 급지구분    - 1:1급지, 2:2급지, 3:3급지 */
                          , SUM(CASE WHEN T1.VST_RGLVL_GD_CD IN ('4', '04')  THEN 1 ELSE 0 END) AS W2         /* 급지구분    - 1:1급지, 2:2급지, 3:3급지 */
                          , NVL(T1.VST_DUEDT, 'X')  AS VST_DUEDT  /* 방문예정일자        */
                          , NVL(T1.WK_EXCN_DT, 'X') AS WK_EXCN_DT /* 작업수행일자        */
                      FROM TB_FEAM_WELS_SV_PED_IZ T1 /* 웰스서비스실적일내역     */
                     WHERE T1.BASE_YM      = #{req.perfYm}
                       AND T1.FEE_SV_TP_CD = '1'   --수수료서비스유형코드 - 1:B/S, 2:A/S
                       AND T1.OG_TP_CD     = 'W02' --조직유형코드 - W02:M추진단
                       AND T1.PRTNR_NO     = #{req.sellPrtnrNo}
                       AND T1.DTA_DL_YN    = 'N'
                     GROUP BY T1.VST_DUEDT, T1.WK_EXCN_DT )
        SELECT 'A' AS TYPE /* 배정건수 */
             , NVL(SUM(WRFR_01), 0) AS WRFR_01
             , NVL(SUM(WRFR_02), 0) AS WRFR_02
             , NVL(SUM(WRFR_03), 0) AS WRFR_03
             , NVL(SUM(WRFR_04), 0) AS WRFR_04
             , NVL(SUM(UN_WRFR), 0) AS UN_WRFR
             , NVL(SUM(PUF_01), 0) AS PUF_01
             , NVL(SUM(PUF_02), 0) AS PUF_02
             , NVL(SUM(OTSC_ETC), 0) AS OTSC_ETC
             , NVL(SUM(BDT_ETC), 0) AS BDT_ETC
             , NVL(SUM(W1), 0)     AS W1
             , NVL(SUM(W2), 0)     AS W2
             , NVL(SUM(PRD_SUM), 0) AS PRD_SUM
             , 0 AS NMN_ASN
         FROM T0
        WHERE T0.VST_DUEDT != 'X'  --방문예정일자
        UNION ALL
        SELECT 'B' AS TYPE /* 완료건수 */
             , NVL(SUM(WRFR_01), 0)  AS WRFR_01
             , NVL(SUM(WRFR_02), 0)  AS WRFR_02
             , NVL(SUM(WRFR_03), 0)  AS WRFR_03
             , NVL(SUM(WRFR_04), 0)  AS WRFR_04
             , NVL(SUM(UN_WRFR), 0)  AS UN_WRFR
             , NVL(SUM(PUF_01), 0)   AS PUF_01
             , NVL(SUM(PUF_02), 0)   AS PUF_02
             , NVL(SUM(OTSC_ETC), 0) AS OTSC_ETC
             , NVL(SUM(BDT_ETC), 0)  AS BDT_ETC
             , NVL(SUM(W1), 0)       AS W1
             , NVL(SUM(W2), 0)       AS W2
             , NVL(SUM(PRD_SUM), 0) AS PRD_SUM
             , 0 AS NMN_ASN
        FROM T0
       WHERE T0.WK_EXCN_DT != 'X'  --작업수행일자
       UNION ALL
      SELECT 'C' AS TYPE /* 완료건수 */
           , NVL(SUM(WRFR_01), 0)  AS WRFR_01
           , NVL(SUM(WRFR_02), 0)  AS WRFR_02
           , NVL(SUM(WRFR_03), 0)  AS WRFR_03
           , NVL(SUM(WRFR_04), 0)  AS WRFR_04
           , NVL(SUM(UN_WRFR), 0)  AS UN_WRFR
           , NVL(SUM(PUF_01), 0)   AS PUF_01
           , NVL(SUM(PUF_02), 0)   AS PUF_02
           , NVL(SUM(OTSC_ETC), 0) AS OTSC_ETC
           , NVL(SUM(BDT_ETC), 0)  AS BDT_ETC
           , NVL(SUM(W1), 0)       AS W1
           , NVL(SUM(W2), 0)       AS W2
           , NVL(SUM(PRD_SUM), 0) AS PRD_SUM
           , 0 AS NMN_ASN
      FROM T0
     WHERE T0.WK_EXCN_DT != 'X'  --작업수행일자
    </select>

    <select id='selectOgBsM' resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$OgBsM">
        SELECT 'A' AS TYPE
             , SUM(DECODE(T1.VST_DUEDT, NULL, 0, 1)) ASGN_CT  /* 배정건수 */
             , SUM(DECODE(T1.WK_EXCN_DT, NULL, 0, 1)) FHS_CT /* 완료건수 */
             , (SUM(DECODE(T1.WK_EXCN_DT, NULL, 0, 1)) / SUM(DECODE(T1.VST_DUEDT, NULL, 0, 1))  * 100 ) AS PROCS_RT
             , SUM(DECODE(T1.WK_EXCN_DT, NULL, 0, 1)) ET_FHS_CT /* 예상완료건수 */
             , (SUM(DECODE(T1.WK_EXCN_DT, NULL, 0, 1)) / SUM(DECODE(T1.VST_DUEDT, NULL, 0, 1))  * 100 ) AS ET_PROCS_RT
          FROM TB_OGBS_MM_PRTNR_IZ       T0 /* 월파트너내역           */
          LEFT OUTER JOIN  TB_FEAM_WELS_SV_PED_IZ T1 /* 웰스서비스실적일내역     */
            ON T1.BASE_YM      = T0.BASE_YM
           AND T1.OG_TP_CD     = T0.OG_TP_CD
           AND T1.PRTNR_NO     = T0.PRTNR_NO
           AND T1.FEE_SV_TP_CD = '1'
           AND T1.DTA_DL_YN    = 'N'
         WHERE T0.BASE_YM      = #{req.perfYm}
           AND T0.OG_TP_CD     = 'W02'
           AND T0.OG_CD        = ( SELECT OG_CD
                                  FROM TB_OGBS_MM_PRTNR_IZ
                                  WHERE BASE_YM      = #{req.perfYm}
                                    AND OG_TP_CD     = 'W02'
                                    AND PRTNR_NO     = #{req.sellPrtnrNo} )
           AND T0.DTA_DL_YN    = 'N'
        GROUP BY T0.BASE_YM
    </select>

    <select id='selectSaleM' resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$SaleM">
        SELECT T2.PRTNR_KNM          /* 성명                               */
             , T1.PRTNR_NO           /* 번호                               */
             , T3.CNTR_RCP_FSH_DTM   /* 접수일자 - 계약접수완료일시        */
             , T3.CNTR_CNFM_DTM      /* 매출일자 - 계약확정일시            */
             , T3.CNTR_CAN_DTM       /* 취소일자 - 계약취소일시            */
             , T1.CNTR_NO            /* 계약번호                           */
             , T5.PD_NM              /* 상품내역 - 상품명                  */
             , T6.CST_KNM            /* 고객명   - 계약자                  */
             , T7.MCHN_CH_TP_CD      /* 기변유형 - 기기변경유형코드        */
             , MAX(T4.FEE_ACKMT_BASE_AMT) AMT_ELHM_BASE_PRC /* 가전기준가 - 수수료인정기준금액 */
             , NVL(SUM(NVL(CASE WHEN T1.PERF_ATC_CD = 'W02P00103' THEN T1.PERF_VAL ELSE 0 END, 0)), 0) ELHM_ACKMT_CT /* 기전인정건수              */
             , NVL(SUM(NVL(CASE WHEN T1.PERF_ATC_CD = 'W02P00112' THEN T1.PERF_VAL ELSE 0 END, 0)), 0) ELHM_EXCP_ACKMT_CT /* 가전외인정실적            */
          FROM TB_FEAM_MACUP_CNTR_PERF_CL  T1 /* 월누적파트너계약실적마감 */
         INNER JOIN       TB_OGBS_PRTNR_BAS           T2 /* 파트너기본               */
            ON  T2.OG_TP_CD    = T1.OG_TP_CD
           AND  T2.PRTNR_NO    = T1.PRTNR_NO
          LEFT OUTER JOIN  TB_SSCT_CNTR_BAS            T3 /* 계약기본                 */
            ON  T3.CNTR_NO     = T1.CNTR_NO
          LEFT OUTER JOIN  TB_SSCT_CNTR_DTL            T4 /* 계약상세                 */
            ON  T4.CNTR_NO     = T1.CNTR_NO
           AND  T4.CNTR_SN     = T1.CNTR_SN
          LEFT OUTER JOIN  TB_PDBS_PD_BAS              T5 /* 상품기본                 */
            ON  T5.PD_CD       = T4.BASE_PD_CD
          LEFT OUTER JOIN  TB_CUBS_CST_BAS             T6 /* 고객기본                 */
            ON  T6.CST_NO      = T3.CNTR_CST_NO
          LEFT OUTER JOIN  TB_FEAM_WELS_MM_ACU_CNTR_CL T7 /* 웰스월누적계약마감       */
            ON  T7.MM_ACU_PERF_AGRG_CRT_DV_CD = T1.MM_ACU_PERF_AGRG_CRT_DV_CD
           AND  T7.BASE_YM     = T1.BASE_YM
           AND  T7.CNTR_NO     = T1.CNTR_NO
           AND  T7.CNTR_SN     = T1.CNTR_SN
           AND  T7.OG_TP_CD    = T1.OG_TP_CD
           AND  T7.PRTNR_NO    = T1.PRTNR_NO
           AND  T7.CAN_DT     IS NULL
           AND  T7.MCHN_CH_YN  = 'Y'
         WHERE T1.MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
           AND T1.BASE_YM                    =  #{req.perfYm}
           AND T1.PERF_AGRG_CRT_DV_CD        = '201'
           AND T1.OG_TP_CD                   = 'W02'
         <if test='@MybatisUtils@equals(userDvCd, "INDV")'>
           AND T1.PRTNR_NO                   = #{req.sellPrtnrNo}
         </if>
           AND T1.PERF_DV_CD                 = '0'
           AND T1.DTA_DL_YN                  = 'N'
         GROUP BY T2.PRTNR_KNM, T1.PRTNR_NO, T3.CNTR_RCP_FSH_DTM, T3.CNTR_CNFM_DTM, T3.CNTR_CAN_DTM, T1.CNTR_NO, T5.PD_NM, T6.CST_KNM, T7.MCHN_CH_TP_CD
    </select>

    <select id="selectBaseHome" resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$BaseHome">
        SELECT T1.PRTNR_KNM     /* 성명       */
             , T1.OG_CD         /* 소속코드    */
             , T2.RSB_DV_CD     /* 직책구분코드 */
         FROM TB_OGBS_MM_PRTNR_IZ T1 /* 월파트너내역 */
        INNER JOIN TB_OGBS_PRTNR_DTL T2 /* 파트너상세 */
           ON  T2.OG_TP_CD    = T1.OG_TP_CD
          AND  T2.PRTNR_NO    = T1.PRTNR_NO
         LEFT OUTER JOIN TB_FEAM_FEE_SML_BAS T3 /* 수수료시뮬레이션기본 */
           ON T3.OG_TP_CD    = T1.OG_TP_CD
          AND T3.PRTNR_NO    = T1.PRTNR_NO
          AND T3.BASE_YM     = T1.BASE_YM
          AND T3.DTA_DL_YN   = 'N'
         LEFT OUTER JOIN TB_FEAM_FEE_BASE_DTL T4 /* 수수료기준상세       */
           ON T4.FEE_CD       = T3.FEE_CD
          AND T4.APY_STRT_YM <![CDATA[<=]]> #{perfYm}
          AND T4.APY_END_YM  >= #{perfYm}
          AND T4.FNL_FEE_YN   = 'Y'
          AND T4.DTA_DL_YN    = 'N'
        WHERE T1.BASE_YM   = #{perfYm}
          AND T1.OG_TP_CD  = 'W03' /* 조직유형코드:홈마스터 */
          AND T1.PRTNR_NO  = #{sellPrtnrNo}
          AND T1.DTA_DL_YN = 'N'
        GROUP BY T1.PRTNR_KNM, T1.OG_CD, T2.RSB_DV_CD
    </select>

    <select id="selectPerformanceHome" resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$PerformanceHome">
        WITH INDV_PERF AS (SELECT NVL((SELECT PERF_VAL
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W03'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W03P00002' /* 가전인정건수 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1), 0)  AS ELHM_ACKMT_CT
                                 , NVL((SELECT PERF_VAL
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W03'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W00P00080' /* 일시불 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1), 0)  AS AMT_SPAY_HCR
                                 , NVL((SELECT PERF_VAL
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W03'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W03P00085' /* 전체처리건 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1), 0)  AS ALL_PROC_CT
                                 , NVL((SELECT PERF_VAL
                                      FROM TB_FEAM_MACUP_PERF_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W03'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W03P00117' /* 가전처리건 */
                                       AND PERF_DV_CD = '0'
                                       AND ROWNUM = 1), 0)  AS ELHM_PROC_CT
                                 , NVL((SELECT FEE_PERF_ATC_VAL
                                      FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W03'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W03P00111' /* 신입교육 수료 */
                                       AND ROWNUM = 1), 'N')  AS NWCMR_EDUC_YN
                                 , NVL((SELECT FEE_PERF_ATC_VAL
                                      FROM TB_FEAM_PRTNR_PERF_MM_ACU_CL
                                     WHERE MM_ACU_PERF_AGRG_CRT_DV_CD = #{req.perType}
                                       AND BASE_YM = #{req.perfYm}
                                       AND OG_TP_CD = 'W03'
                                       AND PRTNR_NO = #{req.sellPrtnrNo}
                                       AND PERF_ATC_CD = 'W03P00112' /* 동행교육 수료 */
                                       AND ROWNUM = 1), 'N')  AS ACPN_EDUC_YN
                            FROM DUAL)
        SELECT 'A' AS TYPE
             , ELHM_ACKMT_CT /* 가전인정건수 */
             , AMT_SPAY_HCR /* 일시불       */
             , ALL_PROC_CT /* 전체처리건   */
             , ELHM_PROC_CT /* 가전처리건   */
             , NWCMR_EDUC_YN /* 신입교육 수료  */
             , ACPN_EDUC_YN /* 동행교육 수료  */
          FROM INDV_PERF
        UNION ALL
        SELECT 'B' AS TYPE
             , ELHM_ACKMT_CT /* 가전인정건수 */
             , AMT_SPAY_HCR /* 일시불       */
             , ALL_PROC_CT /* 전체처리건   */
             , ELHM_PROC_CT /* 가전처리건   */
             , NWCMR_EDUC_YN /* 신입교육 수료  */
             , ACPN_EDUC_YN /* 동행교육 수료  */
          FROM INDV_PERF
    </select>

    <select id="selectEstimateHome" resultType="java.util.Map">
        SELECT *
          FROM (SELECT T2.DTA_CRT_FEE_CD            AS FEE_CD
                     , SUM(NVL(T3.FEE_CALC_AMT, 0)) AS ESTI_VAL_SUM
                  FROM TB_OGBS_MM_PRTNR_IZ T1
                       LEFT OUTER JOIN (SELECT CD.FEE_CD
                                             , CD.DTA_CRT_FEE_CD
                                             , DTL.SRN_MARK_FEE_NM AS FEE_NM
                                             , CD.SRN_MARK_ODR_SN
                                             , CD_DTL.FEE_ATC_TP_CD
                                          FROM TB_FEAM_FEE_CD CD /* 수수료코드           */
                                               INNER JOIN TB_FEAM_FEE_BASE_DTL DTL
                                                          ON (CD.FEE_CD = DTL.FEE_CD)
                                               LEFT OUTER JOIN TB_FEAM_FEE_CD_DTL CD_DTL
                                                               ON (CD.FEE_CD = CD_DTL.FEE_CD)
                                         WHERE 1 = 1
                                           AND (DTL.FEE_CD, DTL.APY_TN) IN
                                                     <foreach collection="feeCds" item="item" open="(" close=")" separator=",">
                                                        (#{item.feeCd}, #{item.apyTn})
                                                      </foreach>
                  ) T2
                                       ON (1 = 1)
                       LEFT OUTER JOIN TB_FEAM_FEE_SML_BAS T3 /* 수수료시뮬레이션기본 */
                                       ON T1.OG_TP_CD = T3.OG_TP_CD
                                           AND T1.PRTNR_NO = T3.PRTNR_NO
                                           AND T1.BASE_YM = T3.OJ_DSB_YM
                                           AND T2.FEE_CD = T3.FEE_CD
                                           AND T2.DTA_CRT_FEE_CD = T3.DTA_CRT_FEE_CD
                                           AND T3.DTA_DL_YN = 'N'
                                           AND T3.SML_CRT_TP_CD = DECODE(#{req.perType}, '00', '01', '02')
                 WHERE T1.BASE_YM = #{req.perfYm}
                   AND T1.OG_TP_CD = 'W03'
                   AND T1.PRTNR_NO = #{req.sellPrtnrNo}
                   AND T1.DTA_DL_YN = 'N'
                 GROUP BY T2.DTA_CRT_FEE_CD)
        PIVOT (SUM(ESTI_VAL_SUM) FOR FEE_CD IN (${pivotColums}))
    </select>

    <select id="selectSaleHome" resultType="com.kyowon.sms.wells.web.fee.simulation.dto.WfefEstimateFeeMgtDto$SaleHome">
        SELECT T3.CNTR_RCP_FSH_DTM /* 접수일자 - 계약접수완료일시        */
             , T3.CNTR_CNFM_DTM    /* 매출일자 - 계약확정일시            */
             , T1.CNTR_NO          /* 계약번호                           */
             , T6.CST_KNM          /* 계약자                             */
             , T5.PD_NM            /* 상품명                             */
             , T5.PD_CD            /* 상품코드                           */
             , T4.CNTRW_TP_CD          /* 상품구분 - 계약서유형코드:BH, 렌탈 T4.CNTRW_TP_CD*/
             , T3.CNTR_TP_CD          /* 계약유형                           */
             , NVL(SUM(NVL(CASE WHEN T1.PERF_ATC_CD = 'W03P00002' THEN T1.PERF_VAL ELSE 0 END, 0)), 0) SUM_ACKMT_CT /* 인정건수 - W03P00002:판매인정건수 */
             , NVL(SUM(NVL(CASE WHEN T1.PERF_ATC_CD = 'W00P00033' THEN T1.PERF_VAL ELSE 0 END, 0)), 0) SUM_RENTAL_AMT /* 렌탈 - W00P00033:(인정)렌탈금액   */
             , NVL(SUM(NVL(CASE WHEN T1.PERF_ATC_CD = 'W00P00080' THEN T1.PERF_VAL ELSE 0 END, 0)), 0) SUM_HOME_CARE /* 일시불 - W00P00080:홈케어일시불   */
             , 0 AS SUM_ETC /* 기타 ??? */
         FROM TB_FEAM_MACUP_CNTR_PERF_CL  T1 /* 월누적파트너계약실적마감  */
         LEFT OUTER JOIN TB_SSCT_CNTR_BAS            T3 /* 계약기본                  */
           ON T3.CNTR_NO     = T1.CNTR_NO
         LEFT OUTER JOIN TB_SSCT_CNTR_DTL            T4 /* 계약상세                  */
           ON T4.CNTR_NO     = T1.CNTR_NO
          AND T4.CNTR_SN     = T1.CNTR_SN
         LEFT OUTER JOIN TB_PDBS_PD_BAS              T5 /* 상품기본                  */
           ON T5.PD_CD       = T4.BASE_PD_CD
         LEFT OUTER JOIN TB_CUBS_CST_BAS             T6 /* 고객기본                  */
           ON T6.CST_NO      = T3.CNTR_CST_NO
        WHERE T1.MM_ACU_PERF_AGRG_CRT_DV_CD = #{perType}
          AND T1.BASE_YM                    = #{perfYm}
          AND T1.OG_TP_CD                   = 'W03'       --조직유형코드:홈마스터
          AND T1.PRTNR_NO                   = #{sellPrtnrNo}
          AND T1.DTA_DL_YN                  = 'N'
        GROUP BY T3.CNTR_RCP_FSH_DTM, T3.CNTR_CNFM_DTM, T1.CNTR_NO, T6.CST_KNM, T5.PD_NM, T5.PD_CD, T4.CNTRW_TP_CD, T3.CNTR_TP_CD
    </select>

</mapper>
