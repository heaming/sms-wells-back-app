<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.organization.hmnrsc.mapper.WogcActivityMapper">
    <select
        id="searchMonthlyActivitiesP"
        resultType="com.kyowon.sms.wells.web.organization.hmnrsc.dto.WogcActivityDto$SearchMonthlyActivityRes">
        WITH TEMP_NTORP AS (   -- 순주문
            SELECT /*+ MATERIALIZE */
                   BASE_YM
                 , OG_TP_CD
                 , PRTNR_NO
                 , SUM(W01P00001) AS W01P00001  -- 개인 가전실적
                 , SUM(W01P00004) AS W01P00004 -- 개인 가전외 실적
                 , SUM(W01P00002) AS W01P00002 -- 기변
                 , SUM(W01P00010) AS W01P00010 -- 개인 상조실적
                 , SUM(W01P00018) AS W01P00018 -- 관리상품건수
              FROM (
                   SELECT BASE_YM
                        , OG_TP_CD
                        , PRTNR_NO
                        , SL_DT
                        , CAN_DT
                        , W01P00001 -- 개인 가전실적
                        , W01P00004 -- 개인 가전외 실적
                        , W01P00002 -- 기변
                        , W01P00010 -- 개인 상조실적
                        , W01P00018 -- 관리상품건수
                     FROM (
                           SELECT /*+ USE_HASH(A B) */
                                  A.BASE_YM
                                , A.OG_TP_CD
                                , A.PRTNR_NO
                                , B.SL_DT
                                , B.CAN_DT
                                , A.PERF_ATC_CD
                                , A.PERF_VAL
                             FROM TB_FEAM_NTORP_CNTR_MM_CL A
                            INNER JOIN TB_FEAM_WELS_NRCTR_MM_CL B
                               ON A.BASE_YM = B.BASE_YM
                              AND A.PERF_YM = B.PERF_YM
                              AND A.CNTR_NO = B.CNTR_NO
                              AND A.CNTR_SN = B.CNTR_SN
                              AND A.CNTR_PERF_CRT_DV_CD = B.CNTR_PERF_CRT_DV_CD
                            WHERE 1 = 1
                              AND A.BASE_YM = #{baseYm}
                              AND A.PERF_YM = #{baseYm}
                              AND A.FEE_TCNT_DV_CD = '02'       -- 2차
                              AND A.CNTR_PERF_CRT_DV_CD = '01'  -- 순주문
                              AND A.OG_TP_CD = #{ogTpCd}
--                              AND A.PRTNR_NO = '1744950'
                              AND A.PERF_ATC_CD  IN ('W01P00001','W01P00004','W01P00002','W01P00010','W01P00018') /*W01P00001 -- 개인 가전실적, W01P00004 -- 개인 가전외 실적,W01P00002 -- 기변,W01P00010 -- 개인 상조실적,W01P00018 -- 관리상품건수*/
                            )
                            PIVOT ( SUM(PERF_VAL) FOR PERF_ATC_CD IN ('W01P00001' AS W01P00001,'W01P00004' AS W01P00004,'W01P00002' AS W01P00002,'W01P00010' AS W01P00010,
                                                                      'W01P00018' AS W01P00018))
                   ) A
               GROUP BY A.BASE_YM
                   , A.OG_TP_CD
                   , A.PRTNR_NO
                )
        ,   TEMP_TOT AS (  -- 총주문
                    SELECT /*+ MATERIALIZE */
                           BASE_YM
                         , OG_TP_CD
                         , PRTNR_NO
                         , SUM(W01P00001) AS W01P00001  -- 개인 가전실적
                         , SUM(W01P00004) AS W01P00004 -- 개인 가전외 실적
                         , SUM(W01P00002) AS W01P00002 -- 기변
                         , SUM(W01P00010) AS W01P00010 -- 개인 상조실적
                         , SUM(W01P00018) AS W01P00018 -- 관리상품건수
                      FROM (
                           SELECT BASE_YM
                                , OG_TP_CD
                                , PRTNR_NO
                                , SL_DT
                                , CAN_DT
                                , W01P00001 -- 개인 가전실적
                                , W01P00004 -- 개인 가전외 실적
                                , W01P00002 -- 기변
                                , W01P00010 -- 개인 상조실적
                                , W01P00018 -- 관리상품건수
                             FROM (
                                   SELECT /*+ USE_HASH(A B) */
                                          A.BASE_YM
                                        , A.OG_TP_CD
                                        , A.PRTNR_NO
                                        , B.SL_DT
                                        , B.CAN_DT
                                        , A.PERF_ATC_CD
                                        , A.PERF_VAL
                                     FROM TB_FEAM_MACUP_CNTR_PERF_CL A
                                    INNER JOIN TB_FEAM_WELS_MM_ACU_CNTR_CL B
                                       ON A.MM_ACU_PERF_AGRG_CRT_DV_CD = B.MM_ACU_PERF_AGRG_CRT_DV_CD
                                      AND A.BASE_YM = B.BASE_YM
                                      AND A.CNTR_NO = B.CNTR_NO
                                      AND A.CNTR_SN = B.CNTR_SN
                                    WHERE 1 = 1
                                      AND A.BASE_YM = #{baseYm}
                                      AND A.MM_ACU_PERF_AGRG_CRT_DV_CD = '00' -- 총주문
                                      AND A.OG_TP_CD = #{ogTpCd}
        --			                  AND A.PRTNR_NO = '1744950'
                                      AND A.PERF_ATC_CD   IN ('W01P00001','W01P00004','W01P00002','W01P00010','W01P00018') /*W01P00001 -- 개인 가전실적, W01P00004 -- 개인 가전외 실적,W01P00002 -- 기변,W01P00010 -- 개인 상조실적,W01P00018 -- 관리상품건수*/
                    )
                    PIVOT ( SUM(PERF_VAL) FOR PERF_ATC_CD IN ('W01P00001' AS W01P00001,'W01P00004' AS W01P00004,'W01P00002' AS W01P00002,'W01P00010' AS W01P00010,
                                                              'W01P00018' AS W01P00018))
                           ) A
                       GROUP BY A.BASE_YM
                           , A.OG_TP_CD
                           , A.PRTNR_NO
                           )
        SELECT /*+ no_merge(SV) no_merge(NT) no_merge(TT) use_hash(QL) use_hash(SV) */
               PM.BASE_YM AS BASE_YM -- "관리년월"
             , PM.OG_CD   AS OG_CD -- "소속코드"
             , PM.PRTNR_KNM AS PRTNR_KNM -- "성명"
             , PM.PRTNR_NO  AS PRTNR_NO -- "번호"
             , PM.PSTN_DV_CD  AS PSTN_DV_CD -- "직급"
             , F_CMZ_CD_NM('TNT_WELLS', 'SEX_DV_CD', PB.SEX_DV_CD) AS SEX_DV_CD -- "성별"
             , OM.BLD_CD AS BLD_CD --"빌딩코드"
             , OM.BLD_NM AS BLD_NM -- "빌딩명"
             , PD.CNTR_DT AS CNTR_DT -- "등록기준일"
             , QL.UPGR_YM  AS PRFMT_DT -- "승급월"
             , SUBSTR(PD.FNL_CLTN_DT,1,6) AS FNL_CLTN_DT -- "최종해약월"
             , OM.HOO_PRTNR_NO AS HOO_PRTNR_NO --"지점장번호"
             , CASE WHEN PM.PSTN_DV_CD >= '10' THEN F_CMZ_CD_NM('TNT_WELLS', 'PQLF_DV_CD', PM.QLF_DV_CD)
                    WHEN PM.PSTN_DV_CD = '7'  THEN '플래너지점장'
               END AS QLF_DV_CD -- "자격"
             , NVL(NT.W01P00001, 0) AS AKCDQ0_SUNJU -- "개인 가전실적"
             , NVL(NT.W01P00004, 0) AS AKCDQ0 -- "개인 가전외 실적"
             , NVL(NT.W01P00002, 0) AS AKCDQ0_SULCHI -- "기변"
             , NVL(NT.W01P00010, 0) AS AKCDQ0_SUB -- "개인 상조실적"
             , '' AS AKCDQ1_SUNJU -- M추진 전용 변수로 null 처리
             , '' AS AKCDQ1 -- M추진 전용 변수로 null 처리
             , '' AS AKCDQ1_SULCHI -- M추진 전용 변수로 null 처리
             , '' AS LCCNT0 -- M추진 전용 변수로 null 처리
             , '' AS LCCNT1 -- M추진 전용 변수로 null 처리
             , '' AS LCCN47 -- M추진 전용 변수로 null 처리
             , '' AS METG_PRSC_DC -- M추진 전용 변수로 null 처리
             , '' AS METG_PRSC_DC_YN -- M추진 전용 변수로 null 처리
             , '' AS EDU11_YN -- M추진 전용 변수로 null 처리
             , '' AS EDU17_YN -- M추진 전용 변수로 null 처리
             , NVL(NT.W01P00018, 0) AS LCVCNT -- "관리상품건수"
             , (CASE WHEN PD.CNTR_DT <![CDATA[<>]]> PD.FST_CNTR_DT AND MONTHS_BETWEEN(TO_DATE(PD.CNTR_DT,'YYYYMMDD'),TO_DATE(PD.FNL_CLTN_DT,'YYYYMMDD')) <![CDATA[<]]> 3
                     THEN 'Y'
                     ELSE ''
               END) AS FNL_CLTN_DT_YN -- "3개월이내재등록"--THREE_MONTHS_YN
          FROM TB_OGBS_MM_PRTNR_IZ PM
         INNER JOIN TB_OGBS_PRTNR_BAS PB
            ON PB.OG_TP_CD = PM.OG_TP_CD
           AND PB.PRTNR_NO = PM.PRTNR_NO
         INNER JOIN TB_OGBS_PRTNR_DTL PD
            ON PD.OG_TP_CD = PM.OG_TP_CD
           AND PD.PRTNR_NO = PM.PRTNR_NO
         INNER JOIN TB_OGBS_MM_OG_IZ OM
            ON OM.BASE_YM  = PM.BASE_YM
           AND OM.OG_TP_CD = PM.OG_TP_CD
           AND OM.OG_ID    = PM.OG_ID
          LEFT OUTER JOIN TB_OGPS_TOPMR_PLAR_APLC_IZ QL
            ON QL.OG_TP_CD = PM.OG_TP_CD
           AND QL.PRTNR_NO = PM.PRTNR_NO
           AND QL.MNGT_YM  = #{baseYm}
          LEFT OUTER JOIN TB_PSCA_MCPTN_METG_AGRG MT
            ON MT.AGRG_YM  = PM.BASE_YM
           AND MT.OG_TP_CD = PM.OG_TP_CD
           AND MT.PRTNR_NO = PM.PRTNR_NO
          LEFT OUTER JOIN
               (SELECT SV.ASN_OJ_YM
                     , CNFM_PSIC_PRTNR_OG_TP_CD
                     , CNFM_PSIC_PRTNR_NO
                     , COUNT(*) AS BSCNT
                  FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ SV  /*고객서비스BS배정내역 261TB*/
                 WHERE SV.ASN_OJ_YM = #{baseYm}
                   AND SV.CNFM_PSIC_PRTNR_OG_TP_CD = #{ogTpCd}
                   AND SV.VST_PRGS_STAT_CD = '20'
                 GROUP BY SV.ASN_OJ_YM
                     , CNFM_PSIC_PRTNR_OG_TP_CD
                     , CNFM_PSIC_PRTNR_NO
               ) SV
            ON SV.ASN_OJ_YM = PM.BASE_YM
           AND SV.CNFM_PSIC_PRTNR_OG_TP_CD = PM.OG_TP_CD
           AND SV.CNFM_PSIC_PRTNR_NO = PM.PRTNR_NO
        <if test="@MybatisUtils@isNotEmpty(feamFlag) and @MybatisUtils@equals(feamFlag,'Y')">
            LEFT OUTER JOIN TEMP_NTORP NT  -- 순주문
        </if>
        <if test="@MybatisUtils@isNotEmpty(feamFlag) and @MybatisUtils@equals(feamFlag,'N')">
            LEFT OUTER JOIN TEMP_TOT NT  -- 총주문
        </if>
        <if test="@MybatisUtils@isEmpty(feamFlag)">
            LEFT OUTER JOIN TEMP_NTORP NT  -- 순주문
        </if>
            ON NT.BASE_YM  = PM.BASE_YM
           AND NT.OG_TP_CD = PM.OG_TP_CD
           AND NT.PRTNR_NO = PM.PRTNR_NO
          LEFT OUTER JOIN
               (SELECT MNGT_YM
                     , BASE_OG_TP_CD
                     , BASE_PRTNR_NO
                     , COUNT(*) AS EJT_CT
                  FROM TB_OGPS_PRTNR_EJT_REL EJ
                 WHERE EJ.MNGT_YM = #{baseYm}
                   AND EJ.OG_EJT_DV_CD = '10'
                   AND EJ.ACKMT_YN = 'Y'
                   AND EJ.DTA_DL_YN = 'N'
                 GROUP BY  MNGT_YM
                     , BASE_OG_TP_CD
                     , BASE_PRTNR_NO
               ) EJ
            ON EJ.MNGT_YM = PM.BASE_YM
           AND EJ.BASE_OG_TP_CD = PM.OG_TP_CD
           AND EJ.BASE_PRTNR_NO = PM.PRTNR_NO
         WHERE PM.BASE_YM = #{baseYm}
           AND PM.OG_TP_CD = #{ogTpCd}  -- 검색ㅈ건 M W02, P W01
           AND PM.PSTN_DV_CD = DECODE(#{rsbDvCd},'S','15','E','10','A','7','')   -- 검색조건 판매자 15, 지구장 10, 지점장 7 으로 파라미터 넘기면 됩니다.
           AND PM.DTA_DL_YN = 'N'
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd3)'>
           AND PM.OG_ID IN (SELECT T.OG_ID
                              FROM (SELECT OG_ID, HGR_OG_ID
                                      FROM TB_OGBS_MM_OG_IZ
                                     WHERE BASE_YM = #{baseYm}
                                       AND OG_TP_CD = #{ogTpCd}) T
                             START WITH T.OG_ID = #{ogLevlDvCd3}
                           CONNECT BY PRIOR T.OG_ID = T.HGR_OG_ID )
           </if>
           <if test='@MybatisUtils@isEmpty(ogLevlDvCd3) and @MybatisUtils@isNotEmpty(ogLevlDvCd2)'>
           AND PM.OG_ID IN (SELECT T.OG_ID
                              FROM (SELECT OG_ID, HGR_OG_ID
                                      FROM TB_OGBS_MM_OG_IZ
                                     WHERE BASE_YM = #{baseYm}
                                       AND OG_TP_CD = #{ogTpCd}) T
                             START WITH T.OG_ID = #{ogLevlDvCd2}
                           CONNECT BY PRIOR T.OG_ID = T.HGR_OG_ID )
           </if>
           <if test='@MybatisUtils@isEmpty(ogLevlDvCd3) and @MybatisUtils@isEmpty(ogLevlDvCd2) and @MybatisUtils@isNotEmpty(ogLevlDvCd1)'>
           AND PM.OG_ID IN (SELECT T.OG_ID
                              FROM (SELECT OG_ID, HGR_OG_ID
                                      FROM TB_OGBS_MM_OG_IZ
                                     WHERE BASE_YM = #{baseYm}
                                       AND OG_TP_CD = #{ogTpCd}) T
                             START WITH T.OG_ID = #{ogLevlDvCd1}
                           CONNECT BY PRIOR T.OG_ID = T.HGR_OG_ID )
           </if>
         ORDER BY PM.OG_CD, PM.PRTNR_NO
    </select>

    <select
        id="searchMonthlyActivitiesM"
        resultType="com.kyowon.sms.wells.web.organization.hmnrsc.dto.WogcActivityDto$SearchMonthlyActivityRes">
        WITH TEMP_NTORP AS (   -- 순주문
            SELECT /*+ MATERIALIZE */
                   BASE_YM
                 , OG_TP_CD
                 , PRTNR_NO
                 , SUM(W02P00002) AS ACKMT_CT  -- 인정건수(순주문)
                 , SUM(W00P00057) AS RSTL_CT -- 웰스팜 재약정 건수
                 , SUM(CASE WHEN SL_DT IS NOT NULL AND CAN_DT IS NULL THEN (W00P00012 + W00P00013 + W00P00016 + W00P00017) ELSE 0 END) AS RCP_ISP_CT
                 , SUM(W00P00037 + W00P00043) AS WO_CT -- 전체 건수
                 , SUM(CASE WHEN SL_DT IS NOT NULL AND CAN_DT IS NULL THEN (W00P00037 + W00P00043) ELSE 0 END) AS RCP_WO_CT -- 접수 설치 건수(전체 기준)
                 , SUM(CASE WHEN SUBSTR(SL_DT,1,6) = #{baseYm} THEN (W00P00012 + W00P00013 + W00P00016 + W00P00017) ELSE 0 END) AS THM_ACKMT_CT --당월 인정 건수
                 , SUM(CASE WHEN SUBSTR(SL_DT,1,6) = #{baseYm} THEN (W00P00037 + W00P00043) ELSE 0 END) AS THM_WO_CT  --당월 전체 건수
                 , SUM(W02P00002) AS W02P00002 --판매인정건수
                 , SUM(W00P00037) AS W00P00037 --LCCN01
                 , SUM(W00P00043) AS W00P00043 --LCCN11
                 , SUM(W00P00012) AS W00P00012 --LCCN31
                 , SUM(W00P00014) AS W00P00014 --LCCN32
                 , SUM(W00P00015) AS W00P00015 --LCCN33
                 , SUM(W00P00013) AS W00P00013 --LCCN34
                 , SUM(W00P00016) AS W00P00016 --LCCN35
                 , SUM(W00P00018) AS W00P00018 --LCCN42
                 , SUM(W00P00019) AS W00P00019 --LCCN43
                 , SUM(W00P00017) AS W00P00017 --LCCN44
                 , SUM(W00P00057) AS W00P00057 --LCCN47
                 , SUM(W00P00036) AS W00P00036 --LCCN49
              FROM (
                   SELECT BASE_YM
                        , OG_TP_CD
                        , PRTNR_NO
                        , SL_DT
                        , CAN_DT
                        , W02P00002 --판매인정건수
                        , W00P00037 --LCCN01
                        , W00P00043 --LCCN11
                        , W00P00012 --LCCN31
                        , W00P00014 --LCCN32
                        , W00P00015 --LCCN33
                        , W00P00013 --LCCN34
                        , W00P00016 --LCCN35
                        , W00P00018 --LCCN42
                        , W00P00019 --LCCN43
                        , W00P00017 --LCCN44
                        , W00P00057 --LCCN47
                        , W00P00036 --LCCN49
                     FROM (
                           SELECT /*+ USE_HASH(A B) */
                                  A.BASE_YM
                                , A.OG_TP_CD
                                , A.PRTNR_NO
                                , B.SL_DT
                                , B.CAN_DT
                                , A.PERF_ATC_CD
                                , A.PERF_VAL
                             FROM TB_FEAM_NTORP_CNTR_MM_CL A
                            INNER JOIN TB_FEAM_WELS_NRCTR_MM_CL B
                               ON A.BASE_YM = B.BASE_YM
                              AND A.PERF_YM = B.PERF_YM
                              AND A.CNTR_NO = B.CNTR_NO
                              AND A.CNTR_SN = B.CNTR_SN
                              AND A.CNTR_PERF_CRT_DV_CD = B.CNTR_PERF_CRT_DV_CD
                            WHERE 1 = 1
                              AND A.BASE_YM = #{baseYm}
                              AND A.PERF_YM = #{baseYm}
                              AND A.FEE_TCNT_DV_CD = '02'       -- 2차
                              AND A.CNTR_PERF_CRT_DV_CD = '01'  -- 순주문
                              AND A.OG_TP_CD = #{ogTpCd}
                              AND A.PERF_ATC_CD  IN ('W02P00002','W00P00037','W00P00043','W00P00012','W00P00014','W00P00015','W00P00013','W00P00016','W00P00018','W00P00019','W00P00017','W00P00057','W00P00036')
                            )
                            PIVOT ( SUM(PERF_VAL) FOR PERF_ATC_CD IN ('W02P00002' AS W02P00002,'W00P00037' AS W00P00037,'W00P00043' AS W00P00043,'W00P00012' AS W00P00012,
                                                                      'W00P00014' AS W00P00014,'W00P00015' AS W00P00015,'W00P00013' AS W00P00013,
                                                                      'W00P00016' AS W00P00016,'W00P00018' AS W00P00018,'W00P00019' AS W00P00019,
                                                                      'W00P00017' AS W00P00017,'W00P00057' AS W00P00057,'W00P00036' AS W00P00036))
                   ) A
               GROUP BY A.BASE_YM
                   , A.OG_TP_CD
                   , A.PRTNR_NO
        )
,   TEMP_TOT AS (  -- 총주문
            SELECT /*+ MATERIALIZE */
                   BASE_YM
                 , OG_TP_CD
                 , PRTNR_NO
                 , SUM(W02P00002) AS ACKMT_CT  -- 인정건수(순주문)
                 , SUM(W00P00057) AS RSTL_CT -- 웰스팜 재약정 건수
                 , SUM(CASE WHEN SL_DT IS NOT NULL AND CAN_DT IS NULL THEN (W00P00012 + W00P00013 + W00P00016 + W00P00017) ELSE 0 END) AS RCP_ISP_CT
                 , SUM(W00P00037 + W00P00043) AS WO_CT -- 전체 건수
                 , SUM(CASE WHEN SL_DT IS NOT NULL AND CAN_DT IS NULL THEN (W00P00037 + W00P00043) ELSE 0 END) AS RCP_WO_CT -- 접수 설치 건수(전체 기준)
                 , SUM(CASE WHEN SUBSTR(SL_DT,1,6) = #{baseYm} THEN (W00P00012 + W00P00013 + W00P00016 + W00P00017) ELSE 0 END) AS THM_ACKMT_CT --당월 인정 건수
                 , SUM(CASE WHEN SUBSTR(SL_DT,1,6) = #{baseYm} THEN (W00P00037 + W00P00043) ELSE 0 END) AS THM_WO_CT  --당월 전체 건수
                 , SUM(W02P00002) AS W02P00002 --판매인정건수
                 , SUM(W00P00037) AS W00P00037 --LCCN01
                 , SUM(W00P00043) AS W00P00043 --LCCN11
                 , SUM(W00P00012) AS W00P00012 --LCCN31
                 , SUM(W00P00014) AS W00P00014 --LCCN32
                 , SUM(W00P00015) AS W00P00015 --LCCN33
                 , SUM(W00P00013) AS W00P00013 --LCCN34
                 , SUM(W00P00016) AS W00P00016 --LCCN35
                 , SUM(W00P00018) AS W00P00018 --LCCN42
                 , SUM(W00P00019) AS W00P00019 --LCCN43
                 , SUM(W00P00017) AS W00P00017 --LCCN44
                 , SUM(W00P00057) AS W00P00057 --LCCN47
                 , SUM(W00P00036) AS W00P00036 --LCCN49
              FROM (
                   SELECT BASE_YM
                        , OG_TP_CD
                        , PRTNR_NO
                        , SL_DT
                        , CAN_DT
                        , W02P00002 --판매인정건수
                        , W00P00037 --LCCN01
                        , W00P00043 --LCCN11
                        , W00P00012 --LCCN31
                        , W00P00014 --LCCN32
                        , W00P00015 --LCCN33
                        , W00P00013 --LCCN34
                        , W00P00016 --LCCN35
                        , W00P00018 --LCCN42
                        , W00P00019 --LCCN43
                        , W00P00017 --LCCN44
                        , W00P00057 --LCCN47
                        , W00P00036 --LCCN49
                     FROM (
                           SELECT /*+ USE_HASH(A B) */
                       A.BASE_YM
                     , A.OG_TP_CD
                     , A.PRTNR_NO
                     , B.SL_DT
                     , B.CAN_DT
                     , A.PERF_ATC_CD
                     , A.PERF_VAL
                  FROM TB_FEAM_MACUP_CNTR_PERF_CL A
                 INNER JOIN TB_FEAM_WELS_MM_ACU_CNTR_CL B
                    ON A.MM_ACU_PERF_AGRG_CRT_DV_CD = B.MM_ACU_PERF_AGRG_CRT_DV_CD
                   AND A.BASE_YM = B.BASE_YM
                   AND A.CNTR_NO = B.CNTR_NO
                   AND A.CNTR_SN = B.CNTR_SN
                 WHERE 1 = 1
                   AND A.BASE_YM = #{baseYm}
                   AND A.MM_ACU_PERF_AGRG_CRT_DV_CD = '00' -- 총주문
                   AND A.OG_TP_CD = #{ogTpCd}
                   AND A.PERF_ATC_CD IN ('W02P00002','W00P00037','W00P00043','W00P00012','W00P00014','W00P00015','W00P00013','W00P00016','W00P00018','W00P00019','W00P00017','W00P00057','W00P00036')
            )
            PIVOT ( SUM(PERF_VAL) FOR PERF_ATC_CD IN ('W02P00002' AS W02P00002,'W00P00037' AS W00P00037,'W00P00043' AS W00P00043,'W00P00012' AS W00P00012,
                                                                      'W00P00014' AS W00P00014,'W00P00015' AS W00P00015,'W00P00013' AS W00P00013,
                                                                      'W00P00016' AS W00P00016,'W00P00018' AS W00P00018,'W00P00019' AS W00P00019,
                                                                      'W00P00017' AS W00P00017,'W00P00057' AS W00P00057,'W00P00036' AS W00P00036))
                   ) A
               GROUP BY A.BASE_YM
                   , A.OG_TP_CD
                   , A.PRTNR_NO
            )
        SELECT /*+ no_merge(SV) no_merge(NT) use_hash(QL) use_hash(SV) */
               PM.BASE_YM AS BASE_YM
             , PM.OG_CD   AS OG_CD
             , PM.PRTNR_KNM AS PRTNR_KNM
             , PM.PRTNR_NO  AS PRTNR_NO
             , PM.PSTN_DV_CD  AS PSTN_DV_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'SEX_DV_CD', PB.SEX_DV_CD) AS SEX_DV_CD
             , OM.BLD_CD AS BLD_CD
             , OM.BLD_NM AS BLD_NM
             , PD.CNTR_DT AS CNTR_DT
             , QL.STRTDT  AS PRFMT_DT
             , SUBSTR(PD.FNL_CLTN_DT,1,6) AS FNL_CLTN_DT
             , OM.HOO_PRTNR_NO AS HOO_PRTNR_NO
             , CASE WHEN PM.PSTN_DV_CD >= '10' THEN F_CMZ_CD_NM('TNT_WELLS', 'QLF_DV_CD', PM.QLF_DV_CD)
                    WHEN PM.PSTN_DV_CD = '7' AND PM.BRMGR_DV_CD = '1' THEN '플래너지점장'
                    WHEN PM.PSTN_DV_CD = '7' AND PM.BRMGR_DV_CD <![CDATA[<>]]> '1' THEN '매니저지점장'
               END AS QLF_DV_CD
             , NVL(NT.ACKMT_CT,0)  AS AKCDQ0_SUNJU-- 인정건수(순주문)
             , NVL(NT.WO_CT,0) AS AKCDQ0-- 웰스팜 재약정 건수
             , NVL(NT.RCP_ISP_CT,0) AS AKCDQ0_SULCHI-- 접수 설치 건수
             , '' AS AKCDQ0_SUB /* P추진 변수여서 null 처리 */
             , NVL(NT.WO_CT,0) AS AKCDQ1_SUNJU--  전체 건수
             , NVL(NT.RCP_WO_CT,0)  AS AKCDQ1 -- 접수 설치 건수(전체 기준)
             , NVL(NT.RCP_ISP_CT,0) AS AKCDQ1_SULCHI -- 접수 설치 건수
             , NVL(NT.THM_ACKMT_CT,0) AS LCCNT0 --당월 인정 건수
             , NVL(NT.THM_WO_CT,0)  AS LCCNT1 --당월 전체 건수
             , NVL(NT.RSTL_CT,0) AS LCCN47 -- 웰스팜 재약정 건수
             , NVL(MT.METG_PRSC_DC,0) AS METG_PRSC_DC
             , CASE WHEN NVL(MT.METG_PRSC_DC,0) >= 15 OR LDSTC_METG_PRSC_YN = 'Y' THEN 'Y' ELSE 'N' END AS METG_PRSC_DC_YN
             , NVL(ED.EDU_11,'N') AS EDU11_YN --EDU11_YN   --플래너스타트업
             , NVL(ED.EDU_17,'N') AS EDU17_YN --EDU17_YN   --수석플래너실전
             , NVL(SV.BSCNT,0) AS LCVCNT
             , (CASE WHEN PD.CNTR_DT <![CDATA[<>]]> PD.FST_CNTR_DT AND MONTHS_BETWEEN(TO_DATE(PD.CNTR_DT,'YYYYMMDD'),TO_DATE(PD.FNL_CLTN_DT,'YYYYMMDD')) <![CDATA[<]]> 3
                     THEN 'Y'
                     ELSE ''
               END) AS FNL_CLTN_DT_YN --3개월이내 재등록
          FROM TB_OGBS_MM_PRTNR_IZ PM
         INNER JOIN TB_OGBS_PRTNR_BAS PB
            ON PB.OG_TP_CD = PM.OG_TP_CD
           AND PB.PRTNR_NO = PM.PRTNR_NO
         INNER JOIN TB_OGBS_PRTNR_DTL PD
            ON PD.OG_TP_CD = PM.OG_TP_CD
           AND PD.PRTNR_NO = PM.PRTNR_NO
         INNER JOIN TB_OGBS_MM_OG_IZ OM
            ON OM.BASE_YM  = PM.BASE_YM
           AND OM.OG_TP_CD = PM.OG_TP_CD
           AND OM.OG_ID    = PM.OG_ID
          LEFT OUTER JOIN TB_OGPS_PLAR_QLF_CH_IZ QL
            ON QL.OG_TP_CD = PM.OG_TP_CD
           AND QL.PRTNR_NO = PM.PRTNR_NO
           AND #{baseYm} ||'01' BETWEEN QL.STRTDT AND QL.ENDDT
          LEFT OUTER JOIN
               (SELECT EDUC_CRSE_CRT_BASE_YM
                     , OG_TP_CD
                     , PRTNR_NO
                     , MAX(DECODE(EDUC_CRSE_NO,'11','Y','N'))  AS EDU_11  --플래너스타트업
                     , MAX(DECODE(EDUC_CRSE_NO,'17','Y','N'))  AS EDU_17  --수석플래너실전
                     , MAX(DECODE(EDUC_CRSE_NO,'143','Y','N')) AS EDU_143 --Pre스타트업
                  FROM TB_PSCA_MCPTN_EDUC_IZ ED
                 WHERE ED.EDUC_CRSE_CRT_BASE_YM = #{baseYm}
                   AND ED.OG_TP_CD = #{ogTpCd}
                   AND ED.EDUC_CRSE_NO IN ('11','17','143')
                   AND ED.EDUC_CPC_ACKMT_YN = 'Y'
                 GROUP BY EDUC_CRSE_CRT_BASE_YM
                     , OG_TP_CD
                     , PRTNR_NO
               ) ED
            ON ED.EDUC_CRSE_CRT_BASE_YM = PM.BASE_YM
           AND ED.OG_TP_CD = PM.OG_TP_CD
           AND ED.PRTNR_NO = PM.PRTNR_NO
          LEFT OUTER JOIN TB_PSCA_MCPTN_METG_AGRG MT
            ON MT.AGRG_YM  = PM.BASE_YM
           AND MT.OG_TP_CD = PM.OG_TP_CD
           AND MT.PRTNR_NO = PM.PRTNR_NO
          LEFT OUTER JOIN
               (SELECT SV.ASN_OJ_YM
                     , CNFM_PSIC_PRTNR_OG_TP_CD
                     , CNFM_PSIC_PRTNR_NO
                     , COUNT(*) AS BSCNT
                  FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ SV  /*고객서비스BS배정내역 261TB*/
                 WHERE SV.ASN_OJ_YM = #{baseYm}
                   AND SV.CNFM_PSIC_PRTNR_OG_TP_CD = #{ogTpCd}
                   AND SV.VST_PRGS_STAT_CD = '20'
                 GROUP BY SV.ASN_OJ_YM
                     , CNFM_PSIC_PRTNR_OG_TP_CD
                     , CNFM_PSIC_PRTNR_NO
               ) SV
            ON SV.ASN_OJ_YM = PM.BASE_YM
           AND SV.CNFM_PSIC_PRTNR_OG_TP_CD = PM.OG_TP_CD
           AND SV.CNFM_PSIC_PRTNR_NO = PM.PRTNR_NO
        <if test="@MybatisUtils@isNotEmpty(feamFlag) and @MybatisUtils@equals(feamFlag,'Y')">
            LEFT OUTER JOIN TEMP_NTORP NT  -- 순주문
        </if>
        <if test="@MybatisUtils@isNotEmpty(feamFlag) and @MybatisUtils@equals(feamFlag,'N')">
            LEFT OUTER JOIN TEMP_TOT NT  -- 총주문
        </if>
        <if test="@MybatisUtils@isEmpty(feamFlag)">
            LEFT OUTER JOIN TEMP_NTORP NT  -- 순주문
        </if>
            ON NT.BASE_YM  = PM.BASE_YM
           AND NT.OG_TP_CD = PM.OG_TP_CD
           AND NT.PRTNR_NO = PM.PRTNR_NO
          LEFT OUTER JOIN
               (SELECT MNGT_YM
                     , BASE_OG_TP_CD
                     , BASE_PRTNR_NO
                     , COUNT(*) AS EJT_CT
                  FROM TB_OGPS_PRTNR_EJT_REL EJ
                 WHERE EJ.MNGT_YM = #{baseYm}
                   AND EJ.OG_EJT_DV_CD = '10'
                   AND EJ.ACKMT_YN = 'Y'
                   AND EJ.DTA_DL_YN = 'N'
                 GROUP BY  MNGT_YM
                     , BASE_OG_TP_CD
                     , BASE_PRTNR_NO
               ) EJ
            ON EJ.MNGT_YM = PM.BASE_YM
           AND EJ.BASE_OG_TP_CD = PM.OG_TP_CD
           AND EJ.BASE_PRTNR_NO = PM.PRTNR_NO
         WHERE PM.BASE_YM = #{baseYm}
           AND PM.OG_TP_CD = #{ogTpCd}
           AND PM.PSTN_DV_CD = DECODE(#{rsbDvCd},'S','15','E','10','A','7','')   -- 검색조건 판매자 15, 지구장 10, 지점장 7 으로 파라미터 넘기면 됩니다.
           AND PM.DTA_DL_YN = 'N'
           <if test='@MybatisUtils@isNotEmpty(qlfDvCd)'>
           AND ( CASE WHEN PM.PSTN_DV_CD >= '10' THEN PM.QLF_DV_CD
                 WHEN PM.PSTN_DV_CD = '7' AND PM.BRMGR_DV_CD = '1' THEN '4'
                 WHEN PM.PSTN_DV_CD = '7' AND PM.BRMGR_DV_CD <![CDATA[<>]]> '1' THEN '5'
                  END ) = #{qlfDvCd}
           </if>
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd3)'>
           AND PM.OG_ID IN (SELECT T.OG_ID
                              FROM (SELECT OG_ID, HGR_OG_ID
                                      FROM TB_OGBS_MM_OG_IZ
                                     WHERE BASE_YM = #{baseYm}
                                       AND OG_TP_CD = #{ogTpCd}) T
                             START WITH T.OG_ID = #{ogLevlDvCd3}
                           CONNECT BY PRIOR T.OG_ID = T.HGR_OG_ID )
           </if>
           <if test='@MybatisUtils@isEmpty(ogLevlDvCd3) and @MybatisUtils@isNotEmpty(ogLevlDvCd2)'>
           AND PM.OG_ID IN (SELECT T.OG_ID
                              FROM (SELECT OG_ID, HGR_OG_ID
                                      FROM TB_OGBS_MM_OG_IZ
                                     WHERE BASE_YM = #{baseYm}
                                       AND OG_TP_CD = #{ogTpCd}) T
                             START WITH T.OG_ID = #{ogLevlDvCd2}
                           CONNECT BY PRIOR T.OG_ID = T.HGR_OG_ID )
           </if>
           <if test='@MybatisUtils@isEmpty(ogLevlDvCd3) and @MybatisUtils@isEmpty(ogLevlDvCd2) and @MybatisUtils@isNotEmpty(ogLevlDvCd1)'>
           AND PM.OG_ID IN (SELECT T.OG_ID
                              FROM (SELECT OG_ID, HGR_OG_ID
                                      FROM TB_OGBS_MM_OG_IZ
                                     WHERE BASE_YM = #{baseYm}
                                       AND OG_TP_CD = #{ogTpCd}) T
                             START WITH T.OG_ID = #{ogLevlDvCd1}
                           CONNECT BY PRIOR T.OG_ID = T.HGR_OG_ID )
           </if>
         ORDER BY PM.OG_CD, PM.PRTNR_NO
    </select>

    <select id="selectCountFeamCntr" resultType="string">
        SELECT COUNT(*)
          FROM TB_FEAM_NTORP_CNTR_MM_CL A
         INNER JOIN TB_FEAM_WELS_NRCTR_MM_CL B
            ON A.BASE_YM = B.BASE_YM
           AND A.PERF_YM = B.PERF_YM
           AND A.CNTR_NO = B.CNTR_NO
           AND A.CNTR_SN = B.CNTR_SN
           AND A.CNTR_PERF_CRT_DV_CD = B.CNTR_PERF_CRT_DV_CD
         WHERE 1 = 1
           AND A.BASE_YM = #{baseYm}
           AND A.PERF_YM = #{baseYm}
           AND A.FEE_TCNT_DV_CD = '02'       -- 2차
           AND A.CNTR_PERF_CRT_DV_CD = '01'  -- 순주문
           AND A.OG_TP_CD = #{ogTpCd}
    </select>

    <select id="searchAccureActivities" resultType="com.kyowon.sms.wells.web.organization.hmnrsc.dto.WogcActivityDto$SearchAccureActivityRes">
        WITH ZZ AS
        ( /*********************************************************************************************/
           SELECT /*+ FULL(X1) */ X1.OG_TP_CD
                  , X1.PRTNR_NO
                  , X1.BASE_YM
                  , X2.CNTR_DT
                  , X2.RCNTR_DT
                  , X1.PERF_ATC_CD
                  , X1.PERF_VAL
           FROM TB_FEAM_NTORP_CNTR_MM_CL        X1 /* 순주문파트너계약월마감 */
                INNER JOIN TB_OGBS_MM_PRTNR_IZ  X2 /* 월파트너내역        */
                   ON X2.BASE_YM     = #{baseYm}       /* 관리년월 - 파라미터 #############################  */
                  AND X2.OG_TP_CD    = X1.OG_TP_CD
                  AND X2.PRTNR_NO    = X1.PRTNR_NO
		          AND X2.OG_TP_CD    = #{ogTpCd}   /* 조직유형 - 파라미터 #############################  */ --P조직:W01. M조직:W02
           <if test='@MybatisUtils@isNotEmpty(qlfDvCd)'>
                  AND X2.QLF_DV_CD   = #{qlfDvCd}     /* 자격구분 - 파라미터 #############################  */ --P조직 - 1:수석플래너, 2:웰스플래너,  M조직 - 2:프리매니저, 6:BS프리매니저, 3:웰스매니저
           </if>
           <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                  AND X2.PRTNR_NO    = #{prtnrNo}      /* 파트너번호 - 파라미터 #############################  */
           </if>
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd1)'>
                LEFT OUTER JOIN TB_OGBS_MM_OG_IZ T1 /* 월조직내역          */
                  ON T1.BASE_YM      = X2.BASE_YM
                 AND T1.OG_ID        = X2.OG_ID
                 AND T1.BASE_YM         = #{baseYm} /* 관리년월 - 파라미터 #############################  */
                 AND T1.OG_TP_CD        = #{ogTpCd}    /* 조직유형 - 파라미터 #############################  */ --P조직:W01. M조직:W02
                 AND T1.DGR1_LEVL_OG_ID = #{ogLevlDvCd1}
           </if>
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd2)'>
                 /* 조직레벨 2 (DGR2_LEVL_OG_ID) 가 있으면 DGR1_LEVL_OG_ID도 있을 것이므로 BASE_YM, OG_TP_CD 조건은 넣지 않음. */
                 AND T1.DGR2_LEVL_OG_ID = #{ogLevlDvCd2}
           </if>
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd3)'>
                 /* 조직레벨 3 (DGR3_LEVL_OG_ID) 가 있으면 DGR1_LEVL_OG_ID도 있을 것이므로 BASE_YM, OG_TP_CD 조건은 넣지 않음. */
                 AND T1.DGR3_LEVL_OG_ID = #{ogLevlDvCd3}
           </if>
             --/********** 설치기준 조건이 선택된 경우만 활성화 **********/
             -- perfCd    I : 설치기준, A : 수당건수
            <if test='@MybatisUtils@isNotEmpty(perfCd) and @MybatisUtils@equals(perfCd, "I")'>
                INNER JOIN TB_FEAM_WELS_NRCTR_MM_CL X3
                   ON X3.BASE_YM              = X1.BASE_YM
                  AND X3.PERF_YM              = X1.PERF_YM
                  AND X3.FEE_TCNT_DV_CD       = X1.FEE_TCNT_DV_CD
                  AND X3.CNTR_NO              = X1.CNTR_NO
                  AND X3.CNTR_SN              = X1.CNTR_SN
                  AND X3.CNTR_PERF_CRT_DV_CD  = X1.CNTR_PERF_CRT_DV_CD
                  AND NVL(X3.ACC_NINC_YN,'N') = 'N'
                  AND X3.PRTNR_NO             = X1.PRTNR_NO
                  AND X3.OG_TP_CD             = X1.OG_TP_CD
                  AND X3.CO_CD                = X1.CO_CD
                  AND X3.SL_DT               >= '20170301' /* 상수값 */
                  AND X3.CAN_DT              IS NULL
            </if>
                --/***********************************************/
           WHERE X1.BASE_YM            <![CDATA[<=]]> #{baseYm} /* 관리년월 - 파라미터 #############################  */
             AND X1.BASE_YM            >= SUBSTR(X2.CNTR_DT, 1, 6)
             AND X1.OG_TP_CD            = #{ogTpCd}    /* 조직유형 - 파라미터 #############################  */ --P조직:W01. M조직:W02
             AND X1.FEE_TCNT_DV_CD      = '02'     /* 수수료차수구분코드 - 02:2차 */
            <choose>
                <when test='@MybatisUtils@isNotEmpty(ogTpCd) and @MybatisUtils@equals(ogTpCd, "W01")'>
               AND X1.PERF_AGRG_CRT_DV_CD = '101'    /* 생성구분 - 파라미터 #############################  */ --실적집계생성구분코드 - 101:P추진단순주문실적생성, 201:M추진단순주문실적생성
                </when>
                <otherwise>
               AND X1.PERF_AGRG_CRT_DV_CD = '201'    /* 생성구분 - 파라미터 #############################  */ --실적집계생성구분코드 - 101:P추진단순주문실적생성, 201:M추진단순주문실적생성
                </otherwise>
            </choose>
             /********** 검색조건에 따라 선택 적용 **********/
            <choose>
                <when test='@MybatisUtils@isNotEmpty(ogTpCd) and @MybatisUtils@equals(ogTpCd, "W01")'>
               AND X1.PERF_ATC_CD        IN ('W01P00030', 'W01P00031', 'W01P00050') --실적항목코드 - P조직
                </when>
                <otherwise>
               AND X1.PERF_ATC_CD        IN ('W00P00012', 'W00P00013', 'W00P00016', 'W00P00017', 'W00P00018', 'W00P00019', 'W00P00014', 'W00P00015', 'W00P00036') --실적항목코드 - M조직
                </otherwise>
            </choose>
             /***********************************************/
             AND X1.PERF_DV_CD          = '0'      /* 실적구분코드 - 0:개인판매 */
             AND X1.DTA_DL_YN           = 'N'
        /*********************************************************************************************/  )
        --누적활동현황 - P조직 (전체, 수당건수)
        SELECT T1.DGR1_LEVL_OG_NM                                                          /* 총괄단                          */
             , T1.DGR2_LEVL_OG_NM                                                          /* 지역단                          */
             , T1.OG_CD                                                                    /* 소속                            */
             , T1.BLD_NM                                                                   /* 빌딩명                          */
             , T0.PRTNR_KNM                                                                /* 성명                            */
             , T0.PRTNR_NO                                                                 /* 번호                            */
             , NVL(C1.CD_CNTN, '-')                                          QLF_DV_NM     /* 자격                            */
             , T0.FST_CNTR_DT                                                              /* 업무등록현황 - 최초등록         */
             , T0.FNL_CLTN_DT                                                              /* 업무등록현황 - 최종해약         */
             , T0.RCNTR_DT                                                                 /* 업무등록현황 - 재등록           */
             , TM.MIN_STRTDT                                                 MIN_STRTDT_M  /* 웰스매니저 현황 - 최초개시      */
             , TM.MAX_ENDDT                                                  MAX_ENDDT_M   /* 웰스매니저 현황 - 최종해약      */
             , TM.MAX_STRTDT                                                 MAX_STRTDT_M  /* 웰스매니저 현황 - 재개시        */
             , T2.MIN_UPGR_YM                                                MIN_UPGR_YM_P /* 수석플래너 현황 - 최초개시      */
             , CASE WHEN T0.OG_TP_CD = 'W01' THEN T0.FNL_CLTN_DT ELSE '' END FNL_CLTN_DT_P /* 수석플래너 현황 - 최종해약      */
             , T2.MAX_DMTN_YM                                                MAX_DMTN_YM_P /* 수석플래너 현황 - 강등          */
             , CASE WHEN T0.OG_TP_CD = 'W01' THEN T0.CLTN_DT     ELSE '' END CLTN_DT_P     /* 수석플래너 현황 - 해약          */
             , '' RGR_PRTNR_NO                                                             /* 수석플래너 신청자 - 번호      */
             , '' RGR_PRTNR_NM                                                             /* 수석플래너 신청자 - 성명      */
             , T3.TOT_SUM                                                                  /* 환경가전 실적 - 누적건수        */
             , ROUND(T3.M03_SUM / 3, 0) M03_AVG                                            /* 환경가전 실적 - 직전3개월(평균) */
             , T3.M03_SUM                                                                  /* 환경가전 실적 - 직전3개월       */
             , T3.CUR_SUM                                                                  /* 환경가전 실적 - 당월            */
             , T3.ABL_SUM                                                                  /* 환경가전 실적 - 승급건수        */
             , T6.EDU96                                                                    /* 교육현황 - 스타트업(M)          */
             , T6.EDU14                                                                    /* 교육현황 - 플래너스타트업(P)    */
             , NVL(T5.RCMDR_CNT, 0) RCMDR_CNT                                              /* 채용현황 - 인원                 */
             , NVL(T4.PRE_CNT, 0) PRE_CNT                                                  /* 채용현황 - 전월실동             */
             , NVL(T5.CUR_CNT, 0) CUR_CNT                                                  /* 채용현황 - 당월실동             */
          FROM /*************/ TB_OGBS_MM_PRTNR_IZ T0  /* 월파트너내역 */
          LEFT OUTER JOIN TB_OGBS_MM_OG_IZ    T1  /* 월조직내역   */
            ON T1.BASE_YM      = T0.BASE_YM
           AND T1.OG_ID        = T0.OG_ID
          LEFT OUTER JOIN (
                            SELECT OG_TP_CD
                                 , PRTNR_NO
                                 , MIN(UPGR_YM) MIN_UPGR_YM --승급년월
                                 , MIN(DMTN_YM) MAX_DMTN_YM --강등년월
                               --, RGR_PRTNR_NO --등록자파트너번호
                               --, RGST_DT      --등록일자
                              FROM TB_OGPS_TOPMR_PLAR_APLC_IZ
                             WHERE MNGT_YM <![CDATA[<=]]> #{baseYm} /* 관리년월 - 파라미터 #############################  */
                               AND QLF_DV_CD = '1' --상수값:수석플래너
                               AND DTA_DL_YN = 'N'
                             GROUP BY OG_TP_CD, PRTNR_NO
                           ) T2  /* P조직-수석플래너 이력 */
            ON T2.OG_TP_CD     = T0.OG_TP_CD
           AND T2.PRTNR_NO     = T0.PRTNR_NO
          LEFT OUTER JOIN (
                            SELECT T1.PRTNR_NO
                                 , MIN(T1.STRTDT) MIN_STRTDT
                                 , MAX(CASE WHEN T1.ENDDT <![CDATA[<>]]> '99991231' THEN T1.ENDDT ELSE '' END) MAX_ENDDT
                                 , MAX(T1.STRTDT) MAX_STRTDT
                              FROM TB_OGPS_PLAR_QLF_CH_IZ T1 /* 플래너자격변경내역 */
                             WHERE 1 = 1
                               AND T1.OG_TP_CD    = 'W02' --상수값(조직유형코드) - W02:M조직
                               AND T1.QLF_DV_CD   = '3'   --상수값(자격구분코드) - 2:프리매니저, 6:BS프리매니저, 3:웰스매니저
                               AND T1.STRTDT     <![CDATA[<=]]> #{baseYm} ||'01' /* 관리년월 - 파라미터 #############################  */
                               AND T1.DTA_DL_YN   = 'N'
                             GROUP BY T1.PRTNR_NO
                           ) TM  /* M조직-웰스매니저 이력 */
            ON TM.PRTNR_NO     = T0.PRTNR_NO
          LEFT OUTER JOIN (
                            SELECT X1.OG_TP_CD
                                 , X1.PRTNR_NO
                                 , SUM(CASE WHEN X1.BASE_YM >= (CASE WHEN SUBSTR(X1.RCNTR_DT, 1, 6) >= '201703' THEN SUBSTR(X1.RCNTR_DT, 1, 6) ELSE '201703' END)
                                             AND X1.BASE_YM <![CDATA[<=]]> TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -1), 'YYYYMM') THEN X1.PERF_VAL ELSE 0 END) TOT_SUM /* 관리년월 - 파라미터 #############################  */
                                 , SUM(CASE WHEN X1.BASE_YM  = #{baseYm} THEN X1.PERF_VAL ELSE 0 END) CUR_SUM /* 관리년월 - 파라미터 #############################  */
                                 , SUM(CASE WHEN X1.BASE_YM <![CDATA[<=]]> #{baseYm}
                                             AND X1.BASE_YM >= TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -2), 'YYYYMM') THEN X1.PERF_VAL ELSE 0 END) M03_SUM /* 관리년월 - 파라미터 #############################  */
                                 , SUM(CASE WHEN X1.BASE_YM  = #{baseYm}
                                            THEN (
                                                    CASE WHEN #{ogTpCd} = 'W01' /* P조직:W01 - 파라미터 #############################  */
                                                         THEN (CASE WHEN X1.PERF_ATC_CD = 'W01P00030' THEN X1.PERF_VAL ELSE 0 END)
                                                         ELSE (CASE WHEN X1.PERF_ATC_CD IN ('W00P00012', 'W00P00013', 'W00P00016', 'W00P00017') THEN X1.PERF_VAL ELSE 0 END)
                                                     END
                                                  )
                                            ELSE 0 END) ABL_SUM /* 관리년월 - 파라미터 #############################  */
                             FROM ZZ        X1 /* 순주문파트너계약월마감 */
                            WHERE 1 = 1
                              /********** 검색조건에 따라 선택 적용 **********/
                            <choose>
                                <when test='@MybatisUtils@isNotEmpty(ogTpCd) and @MybatisUtils@equals(ogTpCd, "W01") and @MybatisUtils@isNotEmpty(perfCd)'>
                              AND X1.PERF_ATC_CD        IN ('W01P00030')              --실적항목코드 - P조직(수당건수 / 설치기준)
                                </when>
                                <when test='@MybatisUtils@isNotEmpty(ogTpCd) and @MybatisUtils@equals(ogTpCd, "W01") and @MybatisUtils@isEmpty(perfCd)'>
                              AND X1.PERF_ATC_CD        IN ('W01P00030', 'W01P00031') --실적항목코드 - P조직(전체)
                                </when>
                                <when test='@MybatisUtils@isNotEmpty(ogTpCd) and @MybatisUtils@equals(ogTpCd, "W02") and @MybatisUtils@isNotEmpty(perfCd)'>
                              AND X1.PERF_ATC_CD        IN ('W00P00012', 'W00P00013', 'W00P00016', 'W00P00017') --실적항목코드 - M조직(수당건수 / 설치기준)
                                </when>
                                <when test='@MybatisUtils@isNotEmpty(ogTpCd) and @MybatisUtils@equals(ogTpCd, "W02") and @MybatisUtils@isEmpty(perfCd)'>
                              AND X1.PERF_ATC_CD        IN ('W00P00012', 'W00P00013', 'W00P00016', 'W00P00017', 'W00P00018', 'W00P00019', 'W00P00014', 'W00P00015') --실적항목코드 - M조직(전체)
                                </when>
                            </choose>
                              /***********************************************/
                            GROUP BY X1.OG_TP_CD, X1.PRTNR_NO ) T3  /* 순주문          */
            ON T3.OG_TP_CD     = T0.OG_TP_CD
           AND T3.PRTNR_NO     = T0.PRTNR_NO
             /* 채용(전월) 건수 */
          LEFT OUTER JOIN (
                            SELECT A.RCMDR_PRTNR_NO, COUNT(B.PRTNR_NO) PRE_CNT
                              FROM (
                                       SELECT T1.PRTNR_NO, T1.RCMDR_PRTNR_NO
                                         FROM TB_OGBS_MM_PRTNR_IZ  T1 /* 월파트너내역 */
                                        WHERE 1 = 1
                                          AND T1.BASE_YM        = TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -1), 'YYYYMM') /* 관리년월 - 파라미터 #############################  */
                                          AND T1.RCMDR_OG_TP_CD = #{ogTpCd}    /* 조직유형 - 파라미터 #############################  */ --P조직:W01. M조직:W02
                                          AND T1.DTA_DL_YN      = 'N'
                                          AND T1.RCMDR_PRTNR_NO IS NOT NULL /* 추천인 */
                                    ) A /* 월파트너내역 */
                              LEFT OUTER JOIN (
                                                SELECT X1.PRTNR_NO, SUM(X1.PERF_VAL) PERF_VAL_SUM
                                                  FROM ZZ X1 /* 순주문파트너계약월마감 */
                                                 WHERE 1 = 1
                                                   AND X1.BASE_YM             = TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), -1), 'YYYYMM')     /* 관리년월 - 파라미터 #############################  */
                                                  /********** 검색조건에 따라 선택 적용 **********/
                                                <choose>
                                                    <when test='@MybatisUtils@isNotEmpty(ogTpCd) and @MybatisUtils@equals(ogTpCd, "W01")'>
                                                        AND X1.PERF_ATC_CD         = 'W01P00050'  --실적항목코드 - P조직
                                                    </when>
                                                    <otherwise>
                                                        AND X1.PERF_ATC_CD         = 'W00P00036'  --실적항목코드 - M조직
                                                    </otherwise>
                                                </choose>
                                                  /***********************************************/
                                                 GROUP BY X1.PRTNR_NO
                                               ) B  /* 환경가전 순주문건수 */
                                ON B.PRTNR_NO      = A.PRTNR_NO
                               AND B.PERF_VAL_SUM >= 2
                             WHERE 1 =1
                             GROUP BY RCMDR_PRTNR_NO  ) T4  /* 채용(전월) 건수 */
            ON T4.RCMDR_PRTNR_NO = T0.PRTNR_NO
             /* 채용(전체, 당월) 건수 */
          LEFT OUTER JOIN (
                            SELECT T1.RCMDR_PRTNR_NO
                                 , COUNT(1) RCMDR_CNT
                                 , COUNT(T2.PRTNR_NO) CUR_CNT
                              FROM (
                                      SELECT T1.PRTNR_NO
                                           , T1.RCMDR_PRTNR_NO
                                        FROM TB_OGBS_MM_PRTNR_IZ  T1 /* 월파트너내역 */
                                       WHERE 1 = 1
                                         AND T1.BASE_YM        = #{baseYm}  /* 관리년월 - 파라미터 #############################  */
                                         AND T1.RCMDR_OG_TP_CD = #{ogTpCd}     /* 조직유형 - 파라미터 #############################  */ --P조직:W01. M조직:W02
                                         AND T1.DTA_DL_YN      = 'N'
                                         AND T1.RCMDR_PRTNR_NO IS NOT NULL /* 추천인 */
                                    ) T1 /* 월파트너내역 */
                              LEFT OUTER JOIN (
                                                SELECT X1.PRTNR_NO
                                                     , SUM(X1.PERF_VAL) PERF_VAL_SUM
                                                  FROM ZZ X1 /* 순주문파트너계약월마감 */
                                                 WHERE 1 = 1
                                                   AND X1.BASE_YM             = #{baseYm}     /* 관리년월 - 파라미터 #############################  */
                                                   /********** 검색조건에 따라 선택 적용 **********/
                                                <choose>
                                                    <when test='@MybatisUtils@isNotEmpty(ogTpCd) and @MybatisUtils@equals(ogTpCd, "W01")'>
                                                   AND X1.PERF_ATC_CD        IN ('W01P00030', 'W01P00031') --실적항목코드 - P조직
                                                    </when>
                                                    <otherwise>
                                                   AND X1.PERF_ATC_CD        IN ('W00P00012', 'W00P00013', 'W00P00016', 'W00P00017', 'W00P00018', 'W00P00019', 'W00P00014', 'W00P00015') --실적항목코드 - M조직
                                                    </otherwise>
                                                </choose>
                                                   /***********************************************/
                                                 GROUP BY X1.OG_TP_CD, X1.PRTNR_NO  ) T2  /* 환경가전 순주문건수 */
                                ON T2.PRTNR_NO     = T1.PRTNR_NO
                               AND T2.PERF_VAL_SUM >= 2
                             WHERE 1 =1
                             GROUP BY RCMDR_PRTNR_NO) T5  /* 채용(전체, 당월) 건수 */
            ON T5.RCMDR_PRTNR_NO = T0.PRTNR_NO
             /* 월별파트너교육내역 */
          LEFT OUTER JOIN (
                            SELECT X1.OG_TP_CD
                                 , X1.PRTNR_NO
                                 , MAX(CASE WHEN X1.OG_TP_CD = 'W02' AND X1.EDUC_CRSE_NO = '96' THEN X1.EDUC_CPC_ACKMT_DT ELSE '' END) AS EDU96  /* 스타트업(M) */
                                 , MAX(CASE WHEN X1.OG_TP_CD = 'W01' AND X1.EDUC_CRSE_NO = '14' THEN X1.EDUC_CPC_ACKMT_DT ELSE '' END) AS EDU14  /* 플래너스타트업(P) */
                              FROM TB_PSCA_MCPTN_EDUC_IZ          X1 /* 월별파트너교육내역 */
                             INNER JOIN TB_OGBS_MM_PRTNR_IZ X2 /* 월파트너내역     */
                                ON X2.BASE_YM    = #{baseYm}      /* 관리년월 - 파라미터 #############################  */
                               AND X2.OG_TP_CD   = X1.OG_TP_CD
                               AND X2.PRTNR_NO   = X1.PRTNR_NO
                               AND X2.PSTN_DV_CD = '15'          /* 15직급 */
                             WHERE X1.EDUC_CRSE_CRT_BASE_YM <![CDATA[<=]]> #{baseYm} /* 파라미터 #############################  */
                               AND X1.EDUC_CRSE_CRT_BASE_YM >= SUBSTR(X2.CNTR_DT, 1, 6)
                               AND X1.OG_TP_CD              IN ('W01', 'W02') --상수값
                               AND X1.EDUC_CRSE_NO          IN ('96', '14')   --교육코드 - 96:스타트업(M), 14:플래너스타트업(P)
                               AND X1.EDUC_CPC_ACKMT_YN      = 'Y'            --교육수료인정여부
                               AND X1.DTA_DL_YN              = 'N'
                             GROUP BY X1.OG_TP_CD, X1.PRTNR_NO      ) T6  /* 월별파트너교육내역  */
            ON T6.OG_TP_CD     = T0.OG_TP_CD
           AND T6.PRTNR_NO     = T0.PRTNR_NO
          LEFT OUTER JOIN AFMDBS.T_CMZ_CD_D C1  /* 공통코드 - 자격구분 */
            ON C1.TENANT_ID    = #{session.tenantId}   --테넌트ID - 에듀
           AND C1.CD_ID        = CASE WHEN T0.OG_TP_CD = 'W01' THEN 'PQLF_DV_CD' ELSE 'QLF_DV_CD' END
           AND C1.CD_VLD_VAL   = T0.QLF_DV_CD
         WHERE T0.BASE_YM         = #{baseYm} /* 관리년월 - 파라미터 #############################  */
           AND T0.OG_TP_CD        = #{ogTpCd}    /* 조직유형 - 파라미터 #############################  */ --P조직:W01. M조직:W02
           <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
           AND T0.PRTNR_NO        = #{prtnrNo}
           </if>
           AND T0.PSTN_DV_CD      = '15'     /* 15직급 */
           <if test='@MybatisUtils@isNotEmpty(qlfDvCd)'>
           AND T0.QLF_DV_CD       = #{qlfDvCd}      /* 자격구분 - 파라미터 #############################  */
           </if>
           AND T0.PRR_BIZ_RGST_YN = 'N'   --사전업무등록여부 - N:기존영업부 Y:사전업무등록자
          /* 필요시 조직조건 추가 */
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd1)'>
           AND T1.BASE_YM         = #{baseYm} /* 관리년월 - 파라미터 #############################  */
           AND T1.OG_TP_CD        = #{ogTpCd}    /* 조직유형 - 파라미터 #############################  */ --P조직:W01. M조직:W02
           AND T1.DGR1_LEVL_OG_ID = #{ogLevlDvCd1}
           </if>
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd2)'>
           /* 조직레벨 2 (DGR2_LEVL_OG_ID) 가 있으면 DGR1_LEVL_OG_ID도 있을 것이므로 BASE_YM, OG_TP_CD 조건은 넣지 않음. */
           AND T1.DGR2_LEVL_OG_ID = #{ogLevlDvCd2}
           </if>
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd3)'>
           /* 조직레벨 3 (DGR3_LEVL_OG_ID) 가 있으면 DGR1_LEVL_OG_ID도 있을 것이므로 BASE_YM, OG_TP_CD 조건은 넣지 않음. */
           AND T1.DGR3_LEVL_OG_ID = #{ogLevlDvCd3}
           </if>
           AND T0.DTA_DL_YN       = 'N'
    </select>
</mapper>
