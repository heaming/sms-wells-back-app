<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.organization.hmnrsc.mapper.WogcPartnerSellerMapper">

    <select id="selectInformationConfirm" resultType="com.kyowon.sms.wells.web.organization.hmnrsc.dto.WogcPartnerSellerDto$SearchInformationConfirmRes">
        SELECT
               T.OG_TP_CD
             , T.PRTNR_NO 		-- 파트너번호
             , T.PRTNR_KNM
             , T.SEX_DV_CD 		-- 성별
             , T.PSTN_DV_CD 	-- 파트너 직급
             , T.BASE_YM
             , T.FST_CNTR_DT	-- 최초계약일자 (월)
             , T.FNL_CLTN_DT 	-- 최종햬약일자 (월)
             , T.RCNTR_DT 		-- 재계약일자 (월)
             , T.CLTN_DT		-- 해약일자 (월)
             <!-- 재계약일자가 없고, 해약일자 없고, 최종햬약일자 없고, 접수일자 >= 최초계약일자 -->
             , CASE WHEN T.RCNTR_DT IS NULL AND T.CLTN_DT IS NULL AND T.FNL_CLTN_DT IS NULL AND #{ymd} <![CDATA[>=]]> T.FST_CNTR_DT THEN 'Y'		-- 20230518은 접수일자 파라미터 값. 테스트용 샘플임.
             <!-- 재계약일자가 없고, 해약일자 없고, 최종햬약일자 있고, 접수일자 >= 최초계약일자 -->
                    WHEN T.RCNTR_DT IS NULL AND T.CLTN_DT IS NULL AND T.FNL_CLTN_DT IS NOT NULL AND #{ymd} <![CDATA[>=]]> T.FST_CNTR_DT THEN 'Y'	-- 20230518은 접수일자 파라미터 값. 테스트용 샘플임.
             <!-- 재계약일자가 있고, 해약일자 있고, 최종햬약일자 없고, 접수일자 >= 최초계약일자, 접수일자 <= 해약일자, 접수일자 >= 재계약일자-->
                    WHEN T.RCNTR_DT IS NOT NULL AND T.CLTN_DT IS NOT NULL AND T.FNL_CLTN_DT IS NULL
                     AND #{ymd} <![CDATA[>=]]> T.FST_CNTR_DT 		-- 20230518은 접수일자 파라미터 값. 테스트용 샘플임.
                     AND #{ymd} <![CDATA[<=]]> T.CLTN_DT 			-- 20230518은 접수일자 파라미터 값. 테스트용 샘플임
                     AND #{ymd} <![CDATA[>=]]> T.FNL_CLTN_DT 		-- 20230518은 접수일자 파라미터 값. 테스트용 샘플임
                    THEN 'Y'
             <!--재계약일자가 있고, 해약일자 있고, 최종햬약일자 있고, 접수일자 >= 최초계약일자, 접수일자 <= 해약일자, 접수일자 >= 재계약일자, 접수일자 <= 최종해약일자 -->
                    WHEN T.RCNTR_DT IS NOT NULL AND T.CLTN_DT IS NOT NULL AND T.FNL_CLTN_DT IS NOT NULL
                     AND #{ymd} <![CDATA[>=]]> T.FST_CNTR_DT 		-- 20230518은 접수일자 파라미터 값. 테스트용 샘플임
                     AND #{ymd} <![CDATA[<=]]> T.CLTN_DT 			-- 20230518은 접수일자 파라미터 값. 테스트용 샘플임
                     AND #{ymd} <![CDATA[>=]]> T.FNL_CLTN_DT 		-- 20230518은 접수일자 파라미터 값. 테스트용 샘플임
                    THEN 'Y'
                    ELSE 'N'
               END AS CHK				-- 날짜체크 조건
         FROM (
                SELECT
                       A.OG_TP_CD
                     , A.PRTNR_NO 		-- 파트너번호
                     , A.PRTNR_KNM
                     , A.SEX_DV_CD 		-- 성별
                     , A.BRYY_MMDD	-- 생년월일
                     , C.PSTN_DV_CD 	-- 파트너 직급
                     , B.BASE_YM
                     , B.FST_CNTR_DT	-- 최초계약일자 (월)
                     , B.FNL_CLTN_DT 	-- 최종햬약일자 (월)
                     , B.RCNTR_DT 		-- 재계약일자 (월)
                     , B.CLTN_DT		-- 해약일자 (월)
                     , RANK() OVER(PARTITION BY A.OG_TP_CD, A.PRTNR_NO ORDER BY B.BASE_YM DESC) AS RNO
                  FROM TB_OGBS_PRTNR_BAS A			-- [파트너기본]
                 INNER JOIN TB_OGBS_MM_PRTNR_IZ B		-- [월 파트너]
                    ON A.OG_TP_CD = B.OG_TP_CD
                   AND A.PRTNR_NO = B.PRTNR_NO 		-- BASE_YM의 이력을 다 들고오기 위해 조인조건에서 제외한다.
                 INNER JOIN TB_OGBS_PRTNR_DTL C
                    ON A.OG_TP_CD = C.OG_TP_CD
                   AND A.PRTNR_NO = C.PRTNR_NO
                 WHERE 1=1
                   <if test='@MybatisUtils@isNotEmpty(ogTpCd)'>
                   AND A.OG_TP_CD = #{ogTpCd}				<!-- [파라미터 IN : 조직유형코드] -->
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(prtnrKnm)'>
                   AND A.PRTNR_KNM = #{prtnrKnm}				<!-- [파라미터 IN : 성명]-->
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(bryyMmdd)'>
                   AND A.BRYY_MMDD = #{bryyMmdd}				<!-- [파라미터 IN : 생년월일]-->
                   </if>
                   <if test='@MybatisUtils@isNotEmpty(sexDvCd)'>
                   AND A.SEX_DV_CD = #{sexDvCd}				<!-- [파라미터 IN : 성별]-->
                   </if>
         ) T
     WHERE T.RNO = 1		<!-- 파트너에 존재하는 월파트너내역의 가장 최신 정보 조회.-->
    </select>
</mapper>
