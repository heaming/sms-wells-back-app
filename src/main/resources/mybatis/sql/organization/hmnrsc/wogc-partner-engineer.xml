<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.organization.hmnrsc.mapper.WogcPartnerEngineerMapper">
    <!--엔지니어 출근관리 조회-->
    <select id="selectEngineerAttends" resultType="com.kyowon.sms.wells.web.organization.hmnrsc.dto.WogcPartnerEngineerDto$SearchEngineerRes">
            SELECT B.OG_CD                      /* 조직코드 */
                 , B.OG_NM                      /* 조직명 */
                 , A.PRTNR_NO                   /* 파트너번호 */
                 , A.PRTNR_KNM                  /* 파트너명 */
                 , CASE WHEN PSTN_DV_CD IN ('86', '87', '88') THEN F_CMZ_CD_NM('TNT_WELLS', 'SAP_PSTN_DV_CD', A.PSTN_DV_CD)
                                                              ELSE F_CMZ_CD_NM('TNT_WELLS', 'HIR_FOM_CD', A.HIR_FOM_CD)
                   END AS PSTN_DV_NM              /* 직무명 */
                 , F.MLNG_CNTN AS RSB_DV_NM     /* 직책구분코드명 */
                 , A.WK_GRP_CD                  /* 작업그룹코드 */
                 , A.WK_GRP_NM
                 , CASE WHEN BIZ_AGNT_PRTNR_NO IS NULL THEN 'N'
                                                       ELSE 'Y'
                   END AS BIZ_AGNT_YN           /* 업무대행여부 */
                 , C.WRK_DT AS WRK_DT           /* 근무일자 */
                 , CASE WHEN E.PHLD_YN='Y' THEN TO_CHAR(TO_DATE(E.BASE_Y||E.BASE_MM||E.BASE_D, 'YYYY-MM-DD'), 'DY','NLS_DATE_LANGUAGE=KOREAN')  ||'(공휴일)'
                                           ELSE TO_CHAR(TO_DATE(E.BASE_Y||E.BASE_MM||E.BASE_D, 'YYYY-MM-DD'), 'DY','NLS_DATE_LANGUAGE=KOREAN')
                   END AS DOW_DV                /* 근무요일 */
                 , CASE WHEN C.EGER_WRK_STAT_CD IS NULL THEN '000'
                                                        ELSE C.EGER_WRK_STAT_CD
                   END AS EGER_WRK_STAT_CD      /* 엔지니어근무상태코드 */
                 , CASE WHEN C.EGER_WRK_STAT_CD <![CDATA[<>]]> '000' THEN F_CMZ_CD_NM('TNT_WELLS', 'EGER_WRK_STAT_CD', C.EGER_WRK_STAT_CD)
                                                         ELSE F_CMZ_CD_NM('TNT_WELLS', 'EGER_WRK_STAT_CD', '000')
                   END EGER_WRK_STAT_NM         /* 엔지니어근무상태코드명 */
                 , C.RMK_CN                     /* 비고내용 */
                 , D.VCN_STRT_DT                /* 휴가시작일자 */
                 , D.VCN_END_DT                 /* 휴가종료일자 */
                 , D.BIZ_AGNT_PRTNR_NO          /* 업무대행파트너번호 */
                 , D.PRTNR_KNM AS BIZ_AGNT_NM   /* 파트너명 */
                 , C.PCP_PRTNR_NO               /* 처리자파트너번호 */
                 , H.PRTNR_KNM AS PCP_PRTNR_NM  /* 파트너명 */
                 , C.PROCS_DTM                  /* 처리일시 */
              FROM TB_OGBS_MM_PRTNR_IZ A                  /* --> 월파트너내역 */
              LEFT OUTER JOIN TB_OGBS_MM_OG_IZ B          /* --> 월조직내역 */
                ON B.OG_TP_CD = A.OG_TP_CD
               AND B.BASE_YM = A.BASE_YM
               AND B.OG_ID = A.OG_ID
             INNER JOIN TB_OGPS_EGER_ATDC_IZ C           /* -->엔지니어출근내역 */
                ON C.OG_TP_CD = A.OG_TP_CD
               AND C.PRTNR_NO = A.PRTNR_NO
               AND C.WRK_DT = #{baseDt}
              LEFT OUTER JOIN (
                                SELECT D1.*,  G.PRTNR_KNM
                                  FROM TB_OGPS_EGER_VCN_IZ D1             /* --> 엔지니어휴가내역 */
                                 INNER JOIN TB_OGBS_PRTNR_BAS G          /* --> 파트너기본(업무대행파트너) */
                                    ON G.OG_TP_CD = D1.OG_TP_CD
                                   AND G.PRTNR_NO = D1.BIZ_AGNT_PRTNR_NO
                                 WHERE #{baseDt} BETWEEN D1.VCN_STRT_DT AND D1.VCN_END_DT
              ) D
                ON D.OG_TP_CD = A.OG_TP_CD
               AND D.PRTNR_NO = A.PRTNR_NO
              LEFT OUTER JOIN TB_SVPD_SV_CLND_BAS E       /* --> 서비스달력기본*/
                ON #{baseDt} = E.BASE_Y || E.BASE_MM  || E.BASE_D
              LEFT OUTER JOIN (
                                SELECT T1.CD_VLD_VAL, T1.ARYL_ORD, T2.MLNG_CNTN --, T2.*
                                  FROM T_CMZ_CD_D T1
                                  LEFT OUTER JOIN T_CMZ_MLNG_D T2
                                    ON T1.TENANT_ID = T2.TENANT_ID
                                   AND T1.CD_DTL_MLNG_ID = T2.MLNG_ID
                                   AND T2.LNG_ID = 'ko'
                                 WHERE 1 = 1
                                   AND (T1.TENANT_ID = 'TNT_BASE' OR T1.TENANT_ID = 'TNT_WELLS')
                                   AND T1.CD_ID = 'RSB_DV_CD'
              ) F
                ON F.CD_VLD_VAL = A.RSB_DV_CD                      /* 직책명 및 직잭별 소트용*/
              LEFT OUTER JOIN (
                                SELECT H1.OG_TP_CD
                                     , H1.PRTNR_NO
                                     , H1.PRTNR_KNM
                                     , RANK() OVER (PARTITION BY H1.PRTNR_NO ORDER BY PRTNR_NO, OG_TP_CD DESC) RANK_P
                                  FROM TB_OGBS_PRTNR_BAS H1
                                 WHERE H1.OG_TP_CD IN ('W06', 'HR1')
              ) H
               ON H.PRTNR_NO = C.PCP_PRTNR_NO
              AND H.RANK_P = 1    /* 처리자명 */
            WHERE A.OG_TP_CD = 'W06'
              AND A.BZ_STAT_CD = 1
              AND A.BASE_YM = SUBSTR(#{baseDt}, 1, 6)
              AND B.OG_ID IN (
                <include refid="com.kyowon.sms.common.web.organization.common.mapper.ZogzOrganizationSearchMapper.sqlSessionOrganization" />
              )
              <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd1)'>
              AND B.DGR1_LEVL_OG_ID = #{ogLevlDvCd1}
              </if>
            ORDER BY A.OG_CD, F.ARYL_ORD DESC , A.PRTNR_NO
    </select>

     <!--엔지니어 출근 관리 목록 저장 -->
    <update id="updateEngineer">
        UPDATE TB_OGPS_EGER_ATDC_IZ  /* 엔지니어출근내역 */
           SET EGER_WRK_STAT_CD = #{egerWrkStatCd}              /*엔지니어근무상태코드*/
             , RMK_CN = #{rmkCn}                  			    /*비고내용*/
             , PCP_OG_TP_CD = #{session.ogTpCd}                 /*처리자조직유형코드*/
             , PCP_PRTNR_NO = #{session.employeeIDNumber}       /*처리자사번*/
             , PROCS_DTM = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') /*처리일시*/
             <include refid="COMMON.updateSystemField" />
        WHERE 1=1
          AND OG_TP_CD = 'W06'
          AND PRTNR_NO = #{prtnrNo}
          <if test="@MybatisUtils@equals(detail, 'N')">
          AND WRK_DT = #{wrkDt}
          </if>
          <if test="@MybatisUtils@equals(detail, 'Y')">
          AND WRK_DT BETWEEN #{vcnStrtDt} AND #{vcnEndDt}
          </if>
    </update>

    <!--엔지니어 휴가정보 상세 조회 -->
    <select id="selectVacations" resultType="com.kyowon.sms.wells.web.organization.hmnrsc.dto.WogcPartnerEngineerDto$SearchVacationRes">
         SELECT EVI.EGER_WRK_STAT_CD /* 엔지니어근무상태코드 */
              , F_CMZ_CD_NM('TNT_WELLS', 'EGER_WRK_STAT_CD', EVI.EGER_WRK_STAT_CD) AS EGER_WRK_STAT_NM /* 엔지니어근무상태코드명 */
              , EVI.PRTNR_NO /* 파트너번호 */
              , EVI.VCN_STRT_DT /* 휴가시작일자 */
              , EVI.VCN_END_DT /* 휴가종료일자 */
              , EVI.RMK_CN /* 비고내용 */
              , MPI.PRTNR_KNM /* 파트너명 */
              , EVI.BIZ_AGNT_PRTNR_NO /* 업무대행파트너번호 */
           FROM TB_OGPS_EGER_VCN_IZ EVI             /* 엔지니어휴가내역 */
           LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ MPI  /* 월파트너내역 */
             ON MPI.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
            AND MPI.PRTNR_NO = EVI.BIZ_AGNT_PRTNR_NO
            AND MPI.OG_TP_CD = EVI.OG_TP_CD
            AND MPI.DTA_DL_YN = 'N'
          WHERE 1=1
            AND EVI.DTA_DL_YN = 'N'
            AND EVI.OG_TP_CD = 'W06'
            AND EVI.PRTNR_NO = #{prtnrNo}
          ORDER BY EVI.VCN_STRT_DT DESC
    </select>

    <!--엔지니어 휴가정보 상세 조회 카운트(temp) -->
    <select id="selectVacationsCnt" resultType="int">
         SELECT COUNT(1) AS CNT
           FROM TB_OGPS_EGER_VCN_IZ EVI  /* 엔지니어휴가내역 */
           LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ MPI /* 월파트너내역 */
             ON MPI.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
            AND MPI.PRTNR_NO = EVI.BIZ_AGNT_PRTNR_NO
            AND MPI.OG_TP_CD = EVI.OG_TP_CD
            AND MPI.DTA_DL_YN = 'N'
          WHERE 1=1
            AND EVI.DTA_DL_YN = 'N'
            AND EVI.OG_TP_CD = 'W06'
            AND EVI.PRTNR_NO = #{prtnrNo}
            AND (#{vcnStrtDt} BETWEEN EVI.VCN_STRT_DT AND EVI.VCN_END_DT -- 휴가시작일자 비교
             OR #{vcnEndDt} BETWEEN EVI.VCN_STRT_DT AND EVI.VCN_END_DT -- 휴가종료일자 비교
             OR EVI.VCN_STRT_DT BETWEEN #{vcnStrtDt} AND #{vcnEndDt}
             OR EVI.VCN_END_DT BETWEEN #{vcnStrtDt} AND #{vcnEndDt})
    </select>

    <!--엔지니어 휴가정보 관리등록 -->
   <insert id="insertVacation">
       INSERT INTO TB_OGPS_EGER_VCN_IZ ( /* 엔지니어휴가내역 */
              OG_TP_CD /* 조직유형코드 */
            , PRTNR_NO /* 파트너번호 */
            , VCN_STRT_DT /* 휴가시작일자 */
            , EGER_WRK_STAT_CD /* 엔지니어근무상태코드 */
            , VCN_END_DT /* 휴가종료일자 */
            , BIZ_AGNT_PRTNR_NO /* 업무대행파트너번호 */
            , RMK_CN /* 비고내용 */
            , PCP_OG_TP_CD /* 처리자조직유형코드 */
            , PCP_PRTNR_NO /* 처리자파트너번호 */
            , PROCS_DTM /* 처리일시 */
            , DTA_DL_YN /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField"/>
         ) VALUES (
               'W06'
             , #{prtnrNo}
             , #{vcnStrtDt}
             , #{egerWrkStatCd}
             , #{vcnEndDt}
             , #{bizAgntPrtnrNo}
             , #{rmkCn}
             , #{session.ogTpCd}
             , #{session.employeeIDNumber}
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
             , 'N'
             <include refid="COMMON.insertSystemFieldValue" />
         )
   </insert>

   <!--엔지니어 휴가정보 관리수정 -->
   <update id="updateVacation">
      UPDATE TB_OGPS_EGER_VCN_IZ /* 엔지니어휴가내역 */
         SET VCN_STRT_DT = #{vcnStrtDt}
           , VCN_END_DT = #{vcnEndDt}
           , EGER_WRK_STAT_CD = #{egerWrkStatCd}
           , BIZ_AGNT_PRTNR_NO = #{bizAgntPrtnrNo}
           , RMK_CN = #{rmkCn}
           , PCP_OG_TP_CD = #{session.ogTpCd}
           , PCP_PRTNR_NO = #{session.employeeIDNumber}
           , PROCS_DTM = TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
           <include refid="COMMON.updateSystemField" />
       WHERE 1=1
         AND OG_TP_CD = 'W06'
         AND VCN_STRT_DT = #{oriVcnStrtDt}
         AND PRTNR_NO = #{prtnrNo}
   </update>

    <!--엔지니어 휴가정보 관리삭제-->
   <delete id="deleteVacation">
       DELETE TB_OGPS_EGER_VCN_IZ /* 엔지니어휴가내역 */
        WHERE 1=1
          AND OG_TP_CD = 'W06'
          AND VCN_STRT_DT = #{oriVcnStrtDt}
          AND PRTNR_NO = #{prtnrNo}
   </delete>

    <!-- 서비스센터 조 관리 -->
    <select id="selectJoeManagements" resultType="com.kyowon.sms.wells.web.organization.hmnrsc.dvo.WogcPartnerEngineerDvo">
        WITH WK_GRP_BLG_DTL AS (
             SELECT
                    T.OG_TP_CD 	        /* 조직유형코드 PK - TEST 자료 에러라서 고정값 부여함. */
                  , T.PRTNR_NO          /* 파트너번호 */
                  , T.APY_SEQN 		    /* 일련번호 PK */
                  , T.VL_STRTDT 		/* 적용일자 */
                  , T.VL_ENDDT 		    /* 종료일자 */
                  , T.WK_GRP_CD 	    /* 작업그룹 */
                  , T.WK_GRP_CD_NM      /* 작업그룹명 */
                  , T.EGER_RSB_CD       /* 직책 */
                  , T.EGER_RSB_CD_NM    /* 직책명 */
                  , T.WKCR_CD 		    /* 조 A.WKCR_CD 로 변경예정임. */
                  , T.WKCR_CD_NM        /* 조명 */
                  , T.RMK_CN            /* 비고내용 */
                  , T.CRAL_LOCARA_TNO 	/* 업무용전화번호1 */
                  , T.MEXNO_ENCR 	    /* 업무용전화번호2 */
                  , T.CRAL_IDV_TNO 	    /* 업무용전화번호3 */
                  , T.RNO               /* 순번 */
                  , T.DTA_DL_YN         /* 데이터삭제여부 */
               FROM (
                      SELECT
                             'W06' AS OG_TP_CD 	-- 조직유형코드 PK - TEST 자료 에러라서 고정값 부여함.
                            , A.PRTNR_NO 		-- 사번 PK
                            , A.APY_SEQN 		-- 일련번호 PK
                            , A.VL_STRTDT
                            , A.VL_ENDDT
                            , A.WK_GRP_CD 	-- 작업그룹
                            , F_CMZ_CD_NM(#{session.tenantId}, 'WK_GRP_CD', A.WK_GRP_CD) AS WK_GRP_CD_NM
                            , A.EGER_RSB_CD     -- 직책
                            , F_CMZ_CD_NM(#{session.tenantId}, 'EGER_RSB_CD', A.EGER_RSB_CD) AS EGER_RSB_CD_NM
                            , A.WKCR_CD 		-- 조
                            , F_CMZ_CD_NM(#{session.tenantId}, 'WKCR_CD', A.WKCR_CD) AS WKCR_CD_NM
                            , A.RMK_CN
                            , A.CRAL_LOCARA_TNO  -- 업무용전화번호1
                            , A.MEXNO_ENCR 	-- 업무용전화번호2
                            , A.CRAL_IDV_TNO 	-- 업무용전화번호3
                            , A.DTA_DL_YN
                            , RANK() OVER (PARTITION BY A.OG_TP_CD, A.PRTNR_NO ORDER BY A.APY_SEQN DESC) AS RNO
                        FROM TB_OGBS_WK_GRP_BLG_DTL A		-- [작업그룹소속상세 테이블]
                       WHERE 1=1
                         AND A.OG_TP_CD = 'W06'						-- 웰스-엔지니어 고정
                         <if test='@MybatisUtils@isNotEmpty(vlDt)'>
                         AND #{vlDt} BETWEEN A.VL_STRTDT AND A.VL_ENDDT 				-- 적용일기준조회 (여기서 처리)
                         </if>
                         AND A.DTA_DL_YN = 'N'
               ) T
              WHERE T.RNO = 1
        )
        SELECT
               TT1.OG_TP_CD 		/* 조직유형코드 PK */
             , TT1.DGR1_LEVL_OG_NM  /* 1단계명 */
             , TT1.DGR2_LEVL_OG_NM  /* 2단계명 */
             , TT1.DGR3_LEVL_OG_NM  /* 3단계명 */
             , TT1.DGR4_LEVL_OG_NM  /* 4단계명 */
             , TT1.DGR5_LEVL_OG_NM  /* 5단계명 */
             , TT1.DGR1_LEVL_OG_ID  /* 1단계ID */
             , TT1.DGR2_LEVL_OG_ID  /* 2단계ID */
             , TT1.PRTNR_NO 		/* 사번 PK */
             , TT1.PRTNR_KNM 		/* 성명 */
             , TT1.RSB_DV_CD        /* 직책구분코드 */
             , TT1.RSB_DV_CD_NM     /* 직급명 */
             , TT1.WK_GRP_CD 	    /* 작업그룹코드 */
             , TT1.WK_GRP_CD_NM     /* 작업그룹코드명 */
             , TT1.EGER_RSB_CD	    /* 직책 */
             , TT1.EGER_RSB_CD_NM  /* 직책명 */
             , TT1.PSTN_DV_CD      /* 직급구분코드 */
             , TT1.HIR_FOM_CD      /* 고용형태코드 */
             , TT1.PSTN_DV_NM      /* 직급구분코드명 */
             , TT1.WKCR_CD          /* 작업조코드 */
             , TT1.WKCR_CD_NM       /* 작업조코드명 */
             , TT1.CNTR_DT	 	  /* 입사일자 */
             , TT1.VL_STRTDT 		  /* 적용일자 */
             , TT1.VL_ENDDT 		  /* 종료일자 */
             , TT1.CRAL_LOCARA_TNO   AS CRAL_LOCARA_TNO /* 업무용전화번호1 */
             , TT1.MEXNO_ENCR  AS MEXNO_ENCR    /* 업무용전화번호2 */
             , TT1.CRAL_IDV_TNO AS CRAL_IDV_TNO /* 업무용전화번호3 */
             , TT1.CRAL_LOCARA_TNO||TT1.MEXNO_ENCR||TT1.CRAL_IDV_TNO AS TEL_NUMBER  /* 업무용전화번호 */
             , TT1.DTA_DL_YN  /* 삭제여부 */
             , TT1.APY_SEQN   /* 일련번호 */
             , TT1.OG_CD      /* 조직코드 */
             , TT1.OG_ID      /* 조직ID */
             , TT1.USR_ID     /* 사용자ID */
        FROM (
                SELECT
                       A.OG_TP_CD 		/* 조직유형코드 PK */
                    , (SELECT T.OG_ABBR_NM FROM TB_OGBS_MM_OG_IZ T WHERE T.BASE_YM = D.BASE_YM AND T.OG_ID = D.DGR1_LEVL_OG_ID) AS DGR1_LEVL_OG_NM  /* 1단계명 */
                    , (SELECT T.OG_ABBR_NM FROM TB_OGBS_MM_OG_IZ T WHERE T.BASE_YM = D.BASE_YM AND T.OG_ID = D.DGR2_LEVL_OG_ID) AS DGR2_LEVL_OG_NM  /* 2단계명 */
                    , (SELECT T.OG_ABBR_NM FROM TB_OGBS_MM_OG_IZ T WHERE T.BASE_YM = D.BASE_YM AND T.OG_ID = D.DGR3_LEVL_OG_ID) AS DGR3_LEVL_OG_NM  /* 3단계명 */
                    , (SELECT T.OG_ABBR_NM FROM TB_OGBS_MM_OG_IZ T WHERE T.BASE_YM = D.BASE_YM AND T.OG_ID = D.DGR4_LEVL_OG_ID) AS DGR4_LEVL_OG_NM  /* 4단계명 */
                    , (SELECT T.OG_ABBR_NM FROM TB_OGBS_MM_OG_IZ T WHERE T.BASE_YM = D.BASE_YM AND T.OG_ID = D.DGR5_LEVL_OG_ID) AS DGR5_LEVL_OG_NM  /* 5단계명 */
                    , D.DGR1_LEVL_OG_ID
                    , D.DGR2_LEVL_OG_ID
                    , A.PRTNR_NO 		/* 사번 PK */
                    , A.PRTNR_KNM 		/* 성명 */
                    , B.RSB_DV_CD        /* 직급코드 */
                    , F_CMZ_CD_NM(#{session.tenantId}, 'RSB_DV_CD', B.RSB_DV_CD) AS RSB_DV_CD_NM /* 직급명 */
                    , C.WK_GRP_CD 	    /* 작업그룹 */
                    , C.WK_GRP_CD_NM     /* 작업그룹명 */
                    , C.EGER_RSB_CD		/* 직책 */
                    , C.EGER_RSB_CD_NM   /* 직책명 */
                    , E.PSTN_DV_CD
                    , E.HIR_FOM_CD
                    , CASE WHEN E.PSTN_DV_CD IN ('86', '87', '88') THEN F_CMZ_CD_NM('TNT_WELLS', 'SAP_PSTN_DV_CD', E.PSTN_DV_CD)
                           ELSE F_CMZ_CD_NM('TNT_WELLS', 'HIR_FOM_CD', E.HIR_FOM_CD)
                      END AS PSTN_DV_NM /* 직급구분코드명 */
                    , C.WKCR_CD           /* 작업조코드 */
                    , C.WKCR_CD_NM        /* 작업조코드명 */
                    , B.CNTR_DT		     /* 입사일자 */
                    , C.VL_STRTDT 		 /* 적용일자 */
                    , C.VL_ENDDT 		 /* 종료일자 */
                    , C.CRAL_LOCARA_TNO   AS CRAL_LOCARA_TNO /* 업무용전화번호1 */
                    , C.MEXNO_ENCR  AS MEXNO_ENCR            /* 업무용전화번호2 */
                    , C.CRAL_IDV_TNO AS CRAL_IDV_TNO         /* 업무용전화번호3 */
                    , C.CRAL_LOCARA_TNO||C.MEXNO_ENCR||C.CRAL_IDV_TNO AS TEL_NUMBER /* 전화번호 */
                    , A.DTA_DL_YN           /* 삭제여부 */
                    , C.APY_SEQN            /* 일련번호 */
                    , D.OG_CD               /* 조직코드 */
                    , D.OG_ID               /* 조직ID */
                    , USR.USR_ID            /* 사용자ID */
                FROM TB_OGBS_PRTNR_BAS A /* 파트너기본 */
                LEFT OUTER JOIN TB_OGBS_PRTNR_DTL B /* 파트너상세 */
                  ON A.OG_TP_CD = B.OG_TP_CD
                 AND A.PRTNR_NO = B.PRTNR_NO
                LEFT OUTER JOIN WK_GRP_BLG_DTL C /* 작업그룹소속상세 */
                  ON A.OG_TP_CD = C.OG_TP_CD
                 AND A.PRTNR_NO = C.PRTNR_NO
               INNER JOIN TB_OGBS_MM_OG_IZ D /* 월조직내역 */
                  ON A.OG_ID = D.OG_ID
                 AND D.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
               INNER JOIN TB_OGBS_MM_PRTNR_IZ E /* 월파트너내역 */
                  ON A.OG_TP_CD = E.OG_TP_CD
                 AND A.PRTNR_NO = E.PRTNR_NO
                 AND E.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                LEFT OUTER JOIN (SELECT A.TENANT_ID
                                      , A.USR_ID
                                      , A.OG_TP_CD
                                      , B.EPNO
                                   FROM T_CMY_USR_M A
                                  INNER JOIN T_CMP_USR_ACO_M B
                                     ON A.USR_ID = B.USR_ID
                                    AND A.HR_EPNO = B.EPNO
                                    AND A.DEL_YN = 'N'
                                    AND B.DEL_YN = 'N'
                                   ) USR
                  ON USR.OG_TP_CD = A.OG_TP_CD
                 AND USR.EPNO = A.PRTNR_NO
                 AND USR.TENANT_ID = #{session.tenantId}
               WHERE 1=1
                 AND A.OG_TP_CD = 'W06'					-- 엔지니어
                 AND A.DTA_DL_YN = 'N'
                 AND B.CLTN_DT IS NULL
                 AND E.PRTNR_NO NOT LIKE '99%'
        ) TT1
         WHERE 1=1
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd1)'>
           AND TT1.DGR1_LEVL_OG_ID = #{ogLevlDvCd1} 						-- 조직레벨 (여기서 추가 처리 필요함)
           </if>
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd2)'>
           AND TT1.DGR2_LEVL_OG_ID = #{ogLevlDvCd2} 						-- 조직레벨 (여기서 추가 처리 필요함)
           </if>
           <if test='@MybatisUtils@isNotEmpty(wkGrpCd)'>
           AND TT1.WK_GRP_CD = #{wkGrpCd}						-- 작업그룹(여기서 처리)
           </if>
           <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
           AND TT1.PRTNR_NO  = #{prtnrNo} 						-- 검색조건 : 번호 (여기서 처리)
           </if>
           <if test='@MybatisUtils@isNotEmpty(rsbDvCd)'>
           AND TT1.RSB_DV_CD = #{rsbDvCd} 					-- 직책 (여기서 추가처리 필요함)
           </if>
           AND TT1.OG_ID IN (
               <include refid="com.kyowon.sms.common.web.organization.common.mapper.ZogzOrganizationSearchMapper.sqlSessionOrganization" />
           )
        ORDER BY TT1.PRTNR_NO DESC
    </select>

    <select id="selectJoeManagementForExcelDownload" resultType="com.kyowon.sms.wells.web.organization.hmnrsc.dvo.WogcPartnerEngineerDvo">
        WITH WK_GRP_BLG_DTL AS (
        SELECT
              T.OG_TP_CD 	    /* 조직유형코드 PK */
            , T.PRTNR_NO        /* 파트너번호 */
            , T.APY_SEQN 		/* 일련번호 PK */
            , T.VL_STRTDT 		/* 적용일자 */
            , T.VL_ENDDT 		/* 종료일자 */
            , T.WK_GRP_CD 	    /* 작업그룹 */
            , T.WK_GRP_CD_NM    /* 작업그룹명 */
            , T.EGER_RSB_CD     /* 직책 */
            , T.EGER_RSB_CD_NM  /* 직책명 */
            , T.WKCR_CD 		/* 조 A.WKCR_CD 로 변경예정임. */
            , T.WKCR_CD_NM      /* 조명 */
            , T.RMK_CN          /* 비고내용 */
            , T.CRAL_LOCARA_TNO   /* 업무용전화번호1 */
            , T.MEXNO_ENCR 	      /* 업무용전화번호2 */
            , T.CRAL_IDV_TNO 	  /* 업무용전화번호3 */
            , T.RNO
            , T.DTA_DL_YN
         FROM (
                SELECT
                       'W06' AS OG_TP_CD 	-- 조직유형코드 PK - TEST 자료 에러라서 고정값 부여함.
                     , A.PRTNR_NO 		-- 사번 PK
                     , A.APY_SEQN 		-- 일련번호 PK
                     , A.VL_STRTDT
                     , A.VL_ENDDT
                     , A.WK_GRP_CD 	-- 작업그룹
                     , F_CMZ_CD_NM(#{session.tenantId}, 'WK_GRP_CD', A.WK_GRP_CD) AS WK_GRP_CD_NM
                     , A.EGER_RSB_CD     -- 직책
                     , F_CMZ_CD_NM(#{session.tenantId}, 'EGER_RSB_CD', A.EGER_RSB_CD) AS EGER_RSB_CD_NM
                     , A.WKCR_CD 		-- 조
                     , F_CMZ_CD_NM(#{session.tenantId}, 'WKCR_CD', A.WKCR_CD) AS WKCR_CD_NM
                     , A.RMK_CN
                     , A.CRAL_LOCARA_TNO  -- 업무용전화번호1
                     , A.MEXNO_ENCR 	-- 업무용전화번호2
                     , A.CRAL_IDV_TNO 	-- 업무용전화번호3
                     , A.DTA_DL_YN
                     , RANK() OVER (PARTITION BY A.OG_TP_CD, A.PRTNR_NO ORDER BY A.APY_SEQN DESC) AS RNO
                  FROM TB_OGBS_WK_GRP_BLG_DTL A		-- [작업그룹소속상세 테이블]
                 WHERE 1=1
                   AND A.OG_TP_CD = 'W06'						-- 웰스-엔지니어 고정
                   <if test='@MybatisUtils@isNotEmpty(vlDt)'>
                   AND #{vlDt} BETWEEN A.VL_STRTDT AND A.VL_ENDDT 				-- 적용일기준조회 (여기서 처리)
                   </if>
                   AND A.DTA_DL_YN = 'N'
         ) T
        WHERE T.RNO = 1
        )
        SELECT
               TT1.OG_TP_CD 		/* 조직유형코드 PK */
             , TT1.DGR1_LEVL_OG_NM  /* 1단계명 */
             , TT1.DGR2_LEVL_OG_NM  /* 2단계명 */
             , TT1.DGR3_LEVL_OG_NM  /* 3단계명 */
             , TT1.DGR4_LEVL_OG_NM  /* 4단계명 */
             , TT1.DGR5_LEVL_OG_NM  /* 5단계명 */
             , TT1.DGR1_LEVL_OG_ID  /* 1단계ID */
             , TT1.DGR2_LEVL_OG_ID  /* 2단계ID */
             , TT1.PRTNR_NO 		/* 사번 PK */
             , TT1.PRTNR_KNM 		/* 성명 */
             , TT1.RSB_DV_CD        /* 직책구분코드 */
             , TT1.RSB_DV_CD_NM     /* 직급명 */
             , TT1.WK_GRP_CD 	    /* 작업그룹코드 */
             , TT1.WK_GRP_CD_NM     /* 작업그룹코드명 */
             , TT1.EGER_RSB_CD	    /* 직책 */
             , TT1.EGER_RSB_CD_NM   /* 직책명 */
             , TT1.PSTN_DV_CD       /* 직급구분코드 */
             , TT1.HIR_FOM_CD      /* 고용형태코드 */
             , TT1.PSTN_DV_NM      /* 직급구분코드명 */
             , TT1.WKCR_CD          /* 작업조코드 */
             , TT1.WKCR_CD_NM       /* 작업조코드명 */
             , TT1.CNTR_DT	 	  /* 입사일자 */
             , TT1.VL_STRTDT 		  /* 적용일자 */
             , TT1.VL_ENDDT 		  /* 종료일자 */
             , TT1.CRAL_LOCARA_TNO   AS CRAL_LOCARA_TNO /* 업무용전화번호1 */
             , TT1.MEXNO_ENCR  AS MEXNO_ENCR    /* 업무용전화번호2 */
             , TT1.CRAL_IDV_TNO AS CRAL_IDV_TNO /* 업무용전화번호3 */
             , TT1.CRAL_LOCARA_TNO||TT1.MEXNO_ENCR||TT1.CRAL_IDV_TNO AS TEL_NUMBER  /* 업무용전화번호 */
             , TT1.DTA_DL_YN  /* 삭제여부 */
             , TT1.APY_SEQN   /* 일련번호 */
             , TT1.OG_CD      /* 조직코드 */
             , TT1.OG_ID      /* 조직ID */
             , TT1.USR_ID     /* 사용자ID */
        FROM (
                SELECT
                       A.OG_TP_CD 		/* 조직유형코드 PK */
                     , (SELECT T.OG_ABBR_NM FROM TB_OGBS_MM_OG_IZ T WHERE T.BASE_YM = D.BASE_YM AND T.OG_ID = D.DGR1_LEVL_OG_ID) AS DGR1_LEVL_OG_NM  /* 1단계명 */
                     , (SELECT T.OG_ABBR_NM FROM TB_OGBS_MM_OG_IZ T WHERE T.BASE_YM = D.BASE_YM AND T.OG_ID = D.DGR2_LEVL_OG_ID) AS DGR2_LEVL_OG_NM  /* 2단계명 */
                     , (SELECT T.OG_ABBR_NM FROM TB_OGBS_MM_OG_IZ T WHERE T.BASE_YM = D.BASE_YM AND T.OG_ID = D.DGR3_LEVL_OG_ID) AS DGR3_LEVL_OG_NM  /* 3단계명 */
                     , (SELECT T.OG_ABBR_NM FROM TB_OGBS_MM_OG_IZ T WHERE T.BASE_YM = D.BASE_YM AND T.OG_ID = D.DGR4_LEVL_OG_ID) AS DGR4_LEVL_OG_NM  /* 4단계명 */
                     , (SELECT T.OG_ABBR_NM FROM TB_OGBS_MM_OG_IZ T WHERE T.BASE_YM = D.BASE_YM AND T.OG_ID = D.DGR5_LEVL_OG_ID) AS DGR5_LEVL_OG_NM  /* 5단계명 */
                     , D.DGR1_LEVL_OG_ID
                     , D.DGR2_LEVL_OG_ID
                     , A.PRTNR_NO 		/* 사번 PK */
                     , A.PRTNR_KNM 		/* 성명 */
                     , B.RSB_DV_CD      /* 직책구분코드 */
                     , F_CMZ_CD_NM(#{session.tenantId}, 'RSB_DV_CD', B.RSB_DV_CD) AS RSB_DV_CD_NM /* 직급명 */
                     , C.WK_GRP_CD 	    /* 작업그룹코드 */
                     , C.WK_GRP_CD_NM   /* 작업그룹코드명 */
                     , C.EGER_RSB_CD	/* 직책 */
                     , C.EGER_RSB_CD_NM  /* 직책명 */
                     , E.PSTN_DV_CD
                     , E.HIR_FOM_CD
                     , CASE WHEN E.PSTN_DV_CD IN ('86', '87', '88') THEN F_CMZ_CD_NM(#{session.tenantId}, 'SAP_PSTN_DV_CD', E.PSTN_DV_CD)
                            ELSE F_CMZ_CD_NM(#{session.tenantId}, 'HIR_FOM_CD', E.HIR_FOM_CD)
                       END AS PSTN_DV_NM  /* 직급구분코드명 */
                     , C.WKCR_CD          /* 작업조코드 */
                     , C.WKCR_CD_NM       /* 작업조코드명 */
                     , B.CNTR_DT	 	  /* 입사일자 */
                     , C.VL_STRTDT 		  /* 적용일자 */
                     , C.VL_ENDDT 		  /* 종료일자 */
                     , C.CRAL_LOCARA_TNO   AS CRAL_LOCARA_TNO /* 업무용전화번호1 */
                     , C.MEXNO_ENCR  AS MEXNO_ENCR    /* 업무용전화번호2 */
                     , C.CRAL_IDV_TNO AS CRAL_IDV_TNO /* 업무용전화번호3 */
                     , C.CRAL_LOCARA_TNO||C.MEXNO_ENCR||C.CRAL_IDV_TNO AS TEL_NUMBER  /* 업무용전화번호 */
                     , A.DTA_DL_YN  /* 삭제여부 */
                     , C.APY_SEQN   /* 일련번호 */
                     , D.OG_CD      /* 조직코드 */
                     , D.OG_ID      /* 조직ID */
                     , USR.USR_ID   /* 사용자ID */
                 FROM TB_OGBS_PRTNR_BAS A /* 파트너기본 */
                 LEFT OUTER JOIN TB_OGBS_PRTNR_DTL B /* 파트너상세 */
                   ON A.OG_TP_CD = B.OG_TP_CD
                  AND A.PRTNR_NO = B.PRTNR_NO
                 LEFT OUTER JOIN WK_GRP_BLG_DTL C /* 작업그룹상세내역 */
                   ON B.OG_TP_CD = C.OG_TP_CD
                  AND B.PRTNR_NO = C.PRTNR_NO
                 LEFT OUTER JOIN TB_OGBS_MM_OG_IZ D /* 월조직내역 */
                   ON A.OG_ID = D.OG_ID
                  AND D.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                INNER JOIN TB_OGBS_MM_PRTNR_IZ E /* 월파트너내역 */
                   ON A.OG_TP_CD = E.OG_TP_CD
                  AND A.PRTNR_NO = E.PRTNR_NO
                  AND E.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                 LEFT OUTER JOIN (SELECT A.TENANT_ID
                                       , A.USR_ID
                                       , A.OG_TP_CD
                                       , B.EPNO
                                    FROM T_CMY_USR_M A
                                   INNER JOIN T_CMP_USR_ACO_M B
                                      ON A.USR_ID = B.USR_ID
                                     AND A.DEL_YN = 'N'
                                     AND B.DEL_YN = 'N'
                                  ) USR
                   ON USR.OG_TP_CD = A.OG_TP_CD
                  AND USR.EPNO = A.PRTNR_NO
                  AND USR.TENANT_ID = #{session.tenantId}
                WHERE 1=1
                  AND A.OG_TP_CD = 'W06'					-- 엔지니어
                  AND A.DTA_DL_YN = 'N'
                  AND B.CLTN_DT IS NULL
                  AND E.PRTNR_NO NOT LIKE '99%'
        ) TT1
         WHERE 1=1
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd1)'>
           AND TT1.DGR1_LEVL_OG_ID = #{ogLevlDvCd1} 						-- 조직레벨 (여기서 추가 처리 필요함)
           </if>
           <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd2)'>
           AND TT1.DGR2_LEVL_OG_ID = #{ogLevlDvCd2} 						-- 조직레벨 (여기서 추가 처리 필요함)
           </if>
           <if test='@MybatisUtils@isNotEmpty(wkGrpCd)'>
           AND TT1.WK_GRP_CD = #{wkGrpCd}						-- 작업그룹(여기서 처리)
           </if>
           <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
           AND TT1.PRTNR_NO  = #{prtnrNo} 						-- 검색조건 : 번호 (여기서 처리)
           </if>
           <if test='@MybatisUtils@isNotEmpty(rsbDvCd)'>
           AND TT1.RSB_DV_CD = #{rsbDvCd} 					-- 직책 (여기서 추가처리 필요함)
           </if>
           AND TT1.OG_ID IN (
             <include refid="com.kyowon.sms.common.web.organization.common.mapper.ZogzOrganizationSearchMapper.sqlSessionOrganization" />
           )
         ORDER BY TT1.PRTNR_NO DESC
    </select>

    <insert id="insertWkGrpBlgDtl">
        INSERT INTO TB_OGBS_WK_GRP_BLG_DTL (  /* 작업그룹소속상세 */
               OG_TP_CD                       /* 조직유형코드 */
             , PRTNR_NO                       /* 파트너번호 */
             , APY_SEQN                       /* 적용순번 */
             , VL_STRTDT                      /* 유효시작일자 */
             , VL_ENDDT                       /* 유효종료일자 */
             , WK_GRP_CD                      /* 작업그룹코드 */
             , EGER_RSB_CD                    /* 엔지니어직책코드 */
             , WKCR_CD                        /* 작업조코드 */
             , RMK_CN                         /* 비고내용 */
             , CRAL_LOCARA_TNO                /* 휴대지역전화번호 */
             , MEXNO_ENCR                     /* 휴대전화국번호암호화 */
             , CRAL_IDV_TNO                   /* 휴대개별전화번호 */
             , AV_CPBLT_DV_CD                 /* 평균역량구분코드 */
             , THEO_EVL_TP_CD                 /* 이론평가유형코드 */
             , DTA_DL_YN                      /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />)
      VALUES (
              #{ogTpCd}
            , #{prtnrNo}
            , (SELECT NVL(MAX(APY_SEQN), 0) +1
                 FROM TB_OGBS_WK_GRP_BLG_DTL
                WHERE OG_TP_CD = #{ogTpCd}
                  AND PRTNR_NO = #{prtnrNo}
              )
            , #{vlStrtdt}
            , #{vlEnddt}
            , #{wkGrpCd}
            , #{egerRsbCd}
            , #{wkcrCd}
            , #{rmkCn}
            , #{cralLocaraTno}
            , #{mexnoEncr}
            , #{cralIdvTno}
            , #{avCpbltDvCd}
            , #{theoEvlTpCd}
            , #{dtaDlYn}
            <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <!-- 월파트너 작업조업데이트 -->
    <update id="updatePrtnrGrpCd">
        UPDATE TB_OGBS_MM_PRTNR_IZ /* 작업그룹소속상세 */
           SET WK_GRP_CD = #{wkGrpCd}
             , WK_GRP_NM = #{wkGrpCdNm}
             , WKCR_CD = #{wkcrCd}
         <include refid="COMMON.updateSystemField" />
         WHERE 1=1
           AND OG_TP_CD = #{ogTpCd}
           AND PRTNR_NO = #{prtnrNo}
           AND BASE_YM = SUBSTR(#{vlStrtdt},0,6)
    </update>

    <!-- 업무용전화번호 업데이트 -->
    <update id="updatePrtnrBusiness">
        UPDATE TB_OGBS_PRTNR_BAS  /* 파트너기본 */
           SET BIZ_USE_IDV_TNO = #{cralLocaraTno}
             , BIZ_USE_EXNO_ENCR = #{mexnoEncr}
             , BIZ_USE_LOCARA_TNO = #{cralIdvTno}
             <include refid="COMMON.updateSystemField" />
        WHERE 1=1
          AND OG_TP_CD = #{ogTpCd}
          AND PRTNR_NO = #{prtnrNo}
    </update>

    <!--엔지니어 등급관리 -->
    <select id="selectEngineerGrades" resultType="com.kyowon.sms.wells.web.organization.hmnrsc.dto.WogcPartnerEngineerDto$FindEngineerGradeRes">
        -- 등급정보
        WITH EGER_GD_RGST_IZ AS (
             SELECT
                    T.OG_TP_CD      /* 조직유형코드 */
                  , T.PRTNR_NO      /* 파트너번호 */
                  , T.APY_SEQN      /* 적용순번 */
                  , T.PRTNR_GD_CD   /* 등급 */
                  , T.APY_STRTDT    /* 적용시작일자 */
                  , T.APY_ENDDT     /* 적용종료일자  */
                  , T.RMK_CN        /* 비고내용 */
                  , T.DTA_DL_YN     /* 데이터삭제여부 */
                  , T.RNO           /* 순번 */
              FROM (
                    SELECT
                           A.OG_TP_CD 		-- 조직유형코드 PK
                         , A.PRTNR_NO		-- 파트너번호 PK
                         , A.APY_SEQN		-- 적용순번 PK
                         , A.PRTNR_GD_CD	-- 등급
                         , A.APY_STRTDT		-- 적용시작일자
                         , A.APY_ENDDT 		-- 적용종료일자
                         , A.RMK_CN		-- 비고
                         , A.DTA_DL_YN
                         , RANK() OVER (PARTITION BY A.OG_TP_CD, A.PRTNR_NO ORDER BY A.APY_SEQN DESC) AS RNO
                      FROM TB_OGPS_EGER_GD_RGST_IZ A /* 엔지니어등급등록내역 */
                     WHERE 1=1
                       AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN A.APY_STRTDT AND A.APY_ENDDT		-- 현재시점
                       AND A.DTA_DL_YN = 'N'
                   ) T
             WHERE T.RNO = 1
      )
      SELECT
             TT1.OG_TP_CD 		  /* 조직유형코드 PK */
           , TT1.DGR1_LEVL_OG_NM  /* 1단계명 */
           , TT1.DGR2_LEVL_OG_NM  /* 2단계명 */
           , TT1.DGR3_LEVL_OG_NM  /* 3단계명 */
           , TT1.DGR4_LEVL_OG_NM  /* 4단계명 */
           , TT1.DGR5_LEVL_OG_NM  /* 5단계명 */
           , TT1.PRTNR_NO 		  /* 사번 PK */
           , TT1.PRTNR_KNM 		  /* 성명 */
           , TT1.RSB_DV_CD        /* 직책구분코드 */
           , TT1.RSB_DV_CD_NM     /* 직책명 */
           , TT1.ROL_DV_CD        /* 직무구분코드 */
           , TT1.ROL_DV_CD_NM     /* 직무구분코드명 */
           , TT1.PSTN_DV_NM       /* 직급구분코드명 */
           , TT1.PRTNR_GD_CD	  /* 등급 */
           , TT1.PRTNR_GD_CD_NM   /* 등급명 */
           , TT1.APY_STRTDT		  /* 적용시작일자 */
           , TT1.APY_ENDDT 		  /* 적용종료일자 */
           , TT1.RMK_CN		      /* 비고 */
           , TT1.CNTR_DT          /* 계약일자 */
           , TT1.CLTN_DT          /* 해약일자 */
           , TT1.APY_SEQN         /* 적용순번 */
           , TT1.DTA_DL_YN        /* 데이터삭제여부 */
           , TT1.OG_CD            /* 조직코드 */
           , TT1.OG_ID            /* 조직ID */
        FROM (
              SELECT
                     B.OG_TP_CD 		/* 조직유형코드 PK */
                   , A.DGR1_LEVL_OG_NM  /* 1단계명 */
                   , A.DGR2_LEVL_OG_NM  /* 2단계명 */
                   , A.DGR3_LEVL_OG_NM  /* 3단계명 */
                   , A.DGR4_LEVL_OG_NM  /* 4단계명 */
                   , A.DGR5_LEVL_OG_NM  /* 5단계명 */
                   , A.DGR1_LEVL_OG_ID  /* 1차레벨조직ID */
                   , A.DGR2_LEVL_OG_ID /* 1차레벨조직ID */
                   , B.PRTNR_NO 		/* 사번 PK */
                   , B.PRTNR_KNM 		/* 성명 */
                   , D.RSB_DV_CD        /* 직책구분코드 */
                   , F_CMZ_CD_NM(#{session.tenantId}, 'RSB_DV_CD', D.RSB_DV_CD ) AS RSB_DV_CD_NM  /* 직책명 */
                   , B.ROL_DV_CD        /* 직무구분코드 */
                   , B.PSTN_DV_CD       /* 직급구분코드 */
                   , B.HIR_FOM_CD       /* 고용형태코드 */
                   , F_CMZ_CD_NM(#{session.tenantId}, 'EGER_ROL_CD', B.ROL_DV_CD) AS ROL_DV_CD_NM /* 직무구분코드명 */
                   , CASE WHEN B.PSTN_DV_CD IN ('86', '87', '88') THEN F_CMZ_CD_NM(#{session.tenantId}, 'SAP_PSTN_DV_CD', B.PSTN_DV_CD)
                          ELSE F_CMZ_CD_NM(#{session.tenantId}, 'HIR_FOM_CD', B.HIR_FOM_CD)
                     END AS PSTN_DV_NM /* 직급구분코드명 */
                   , C.PRTNR_GD_CD	   /* 등급 */
                   , F_CMZ_CD_NM(#{session.tenantId}, 'PRTNR_GD_CD', C.PRTNR_GD_CD) AS PRTNR_GD_CD_NM /* 등급명 */
                   , C.APY_STRTDT		/* 적용시작일자 */
                   , C.APY_ENDDT 		/* 적용종료일자 */
                   , C.RMK_CN		    /* 비고 */
                   , B.CNTR_DT          /* 계약일자 */
                   , B.CLTN_DT          /* 해약일자 */
                   , C.APY_SEQN         /* 적용순번 */
                   , C.DTA_DL_YN        /* 데이터삭제여부 */
                   , A.OG_CD            /* 조직코드 */
                   , A.OG_ID            /* 조직ID */
               FROM TB_OGBS_MM_OG_IZ A    			/* 월조직내역 */
              INNER JOIN TB_OGBS_MM_PRTNR_IZ B		/* 월파트너내역 */
                 ON A.BASE_YM = B.BASE_YM
                AND A.OG_TP_CD = B.OG_TP_CD
                AND A.OG_ID = B.OG_ID
               LEFT OUTER JOIN EGER_GD_RGST_IZ C    /* 엔지니어등급등록내역 */
                 ON B.OG_TP_CD = C.OG_TP_CD
                AND B.PRTNR_NO = C.PRTNR_NO
               LEFT OUTER JOIN TB_OGBS_PRTNR_DTL D  /* 파트너상세 */
                 ON B.OG_TP_CD = D.OG_TP_CD
                AND B.PRTNR_NO = D.PRTNR_NO
              WHERE 1=1
                AND A.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                AND A.OG_TP_CD = 'W06'
                AND B.CLTN_DT IS NULL		-- 해약일자 있는 엔지니어 제외. 퇴사했으니...일단 제외
                AND A.DTA_DL_YN = 'N'
                AND B.DTA_DL_YN = 'N'
                AND D.CLTN_DT IS NULL
                AND B.PRTNR_NO NOT LIKE '99%'
      ) TT1
       WHERE 1=1
         <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd1)'>
         AND TT1.DGR1_LEVL_OG_ID = #{ogLevlDvCd1} 						-- 조직레벨 (여기서 추가 처리 필요함)
         </if>
         <if test='@MybatisUtils@isNotEmpty(ogLevlDvCd2)'>
         AND TT1.DGR2_LEVL_OG_ID = #{ogLevlDvCd2} 						-- 조직레벨 (여기서 추가 처리 필요함)
         </if>
         <if test='@MybatisUtils@isNotEmpty(rsbDvCd)'>
         AND TT1.RSB_DV_CD = #{rsbDvCd}
         </if>
         <if test="@MybatisUtils@equals(chk, 'Y')">
         AND TT1.PRTNR_GD_CD IS NULL
         </if>
         AND TT1.OG_ID IN (
            <include refid="com.kyowon.sms.common.web.organization.common.mapper.ZogzOrganizationSearchMapper.sqlSessionOrganization" />
            )
      ORDER BY TT1.PRTNR_NO DESC
    </select>

    <insert id="insertEgerGdRgst">
        INSERT INTO TB_OGPS_EGER_GD_RGST_IZ( /* 엔지니어등급등록내역 */
              OG_TP_CD                       /* 조직유형코드 */
            , PRTNR_NO                       /* 파트너번호 */
            , APY_SEQN                       /* 적용순번 */
            , PRTNR_GD_CD                    /* 파트너등급코드 */
            , APY_STRTDT                     /* 적용시작일자 */
            , APY_ENDDT                      /* 적용종료일자 */
            , RMK_CN                         /* 비고내용 */
            , DTA_DL_YN                      /* 데이터삭제여부 */
            <include refid="COMMON.insertSystemField" />)
      VALUES (
              #{ogTpCd}
            , #{prtnrNo}
            , (SELECT NVL(MAX(APY_SEQN), 0) +1
                 FROM TB_OGPS_EGER_GD_RGST_IZ
                WHERE OG_TP_CD = #{ogTpCd}
                  AND PRTNR_NO = #{prtnrNo}
              )
            , #{prtnrGdCd}
            , #{apyStrtDt}
            , #{apyEnddt}
            , #{rmkCn}
            , #{dtaDlYn}
            <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <select id="selectEngineerPartner" resultType="String">
        SELECT PRTNR_KNM
          FROM TB_OGBS_PRTNR_BAS  /* 파트너기본 */
         WHERE OG_TP_CD = 'W06'
           AND PRTNR_NO = #{prtnrNo}
           AND NVL(DTA_DL_YN, 'N') = 'N'
    </select>

    <insert id="insertEgerGdRgsts">
        MERGE INTO TB_OGPS_EGER_GD_RGST_IZ A  /* 엔지니어등급등록내역 */
        USING (
        <foreach collection="list" item="item" open="" close="" index="index" separator="UNION ALL">
            SELECT   #{item.ogTpCd}     AS OG_TP_CD
            , #{item.prtnrNo}    AS PRTNR_NO
            , NULL               AS APY_SEQN
            , #{item.prtnrGdCd}  AS PRTNR_GD_CD
            , #{item.apyStrtDt}  AS APY_STRTDT
            , #{item.apyEnddt}  AS APY_ENDDT
            , NULL  AS RMK_CN
            , 'N'   AS DTA_DL_YN
            FROM DUAL
        </foreach>
        )T1
           ON (A.PRTNR_NO = T1.PRTNR_NO AND A.OG_TP_CD = T1.OG_TP_CD AND A.APY_STRTDT = #{apyStrtDt})
         WHEN MATCHED THEN
       UPDATE SET APY_ENDDT = #{apyEnddt}
                , PRTNR_GD_CD = #{prtnrGdCd}
                , RMK_CN = #{rmkCn}
                , DTA_DL_YN = #{dtaDlYn}
                <include refid="COMMON.updateSystemField" />
         WHEN NOT MATCHED THEN
       INSERT (
               OG_TP_CD /* 조직유형코드 */
             , PRTNR_NO /* 파트너번호 */
             , APY_SEQN /* 적용순번 */
             , PRTNR_GD_CD /* 파트너등급코드 */
             , APY_STRTDT /* 적용시작일자 */
             , APY_ENDDT /* 적용종료일자 */
             , RMK_CN /* 비고내용 */
             , DTA_DL_YN /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />)
       VALUES (
                T1.OG_TP_CD
              , T1.PRTNR_NO
              , (SELECT NVL(MAX(APY_SEQN), 0) +1
                   FROM TB_OGPS_EGER_GD_RGST_IZ
                  WHERE OG_TP_CD = #{ogTpCd}
                    AND PRTNR_NO = #{prtnrNo}
                )
              , T1.PRTNR_GD_CD
              , T1.APY_STRTDT
              , T1.APY_ENDDT
              , T1.RMK_CN
              , T1.DTA_DL_YN
              <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <!-- 월파트너 직무업데이트 -->
    <update id="updateMonthPrtnrRolDvCd">
        UPDATE TB_OGBS_MM_PRTNR_IZ    /* 월파트너내역 */
         <set>
           <if test='@MybatisUtils@isNotEmpty(rolDvCd)'>
             , ROL_DV_CD = #{rolDvCd}
           </if>
           <if test='@MybatisUtils@isNotEmpty(prtnrGdCd)'>
             , PRTNR_GD_CD = #{prtnrGdCd}
           </if>
         </set>
             <include refid="COMMON.updateSystemField" />
         WHERE 1=1
           AND OG_TP_CD = #{ogTpCd}
           AND PRTNR_NO = #{prtnrNo}
           AND BASE_YM = SUBSTR(#{apyStrtDt},0,6)
    </update>

    <!-- 파트너상세 직무업데이트 -->
    <update id="updatePrtnrRolDvCd">
        UPDATE TB_OGBS_PRTNR_DTL   /* 파트너상세 */
         <set>
           <if test='@MybatisUtils@isNotEmpty(rolDvCd)'>
             , ROL_DV_CD = #{rolDvCd}
           </if>
           <if test='@MybatisUtils@isNotEmpty(prtnrGdCd)'>
             , PRTNR_GD_CD = #{prtnrGdCd}
           </if>
         </set>
             <include refid="COMMON.updateSystemField" />
         WHERE 1=1
           AND OG_TP_CD = #{ogTpCd}
           AND PRTNR_NO = #{prtnrNo}
    </update>

    <insert id="insertPrtnrHist">
        INSERT INTO TB_OGBS_PRTNR_DCH_HIST (  /* 파트너상세변경이력 */
               OG_TP_CD           /* 조직유형코드 */
             , PRTNR_NO           /* 파트너번호 */
             , HIST_STRT_DTM      /* 이력시작일시 */
             , HIST_END_DTM       /* 이력종료일시 */
             , CNTR_DT            /* 계약일자 */
             , CLTN_DT            /* 해약일자 */
             , RSB_DV_CD          /* 직책구분코드 */
             , PSTN_DV_CD         /* 직급구분코드 */
             , ROL_DV_CD          /* 직무구분코드 */
             , PRTNR_GD_CD        /* 파트너등급코드 */
             , QLF_DV_CD          /* 자격구분코드 */
             , HIR_FOM_CD         /* 고용형태코드 */
             , BZ_STAT_CD         /* 사업상태코드 */
             , CRWK_OCCC_DV_CD    /* 계약직직종구분코드 */
             , PRTNR_ACTI_STAT_CD /* 파트너활동상태코드 */
             , RETR_LM_YN         /* 재등록제한여부 */
             , RDS_DSB_EXCD_OJ_YN /* RDS지급제외대상여부 */
             , CCPS_YN            /* 겸직여부 */
             , RVE_CD             /* 수납코드 */
             , DTA_DL_YN          /* 데이터삭제여부 */
            <include refid="COMMON.insertSystemField" />)
        VALUES (
                 #{ogTpCd}
               , #{prtnrNo}
               , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
               , '99991231235959'
               , #{cntrDt}
               , #{cltnDt}
               , ''
               , ''
               , #{rolDvCd}
               , ''
               , ''
               , ''
               , ''
               , ''
               , ''
               , ''
               , ''
               , ''
               , ''
               , #{dtaDlYn}
            <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

</mapper>

