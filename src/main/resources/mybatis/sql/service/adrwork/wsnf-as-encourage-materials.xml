<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.adrwork.mapper.WsnfAsEnrgMatMngtMapper">

    <select id="selectAsEncourageMaterials" resultType="com.kyowon.sms.wells.web.service.adrwork.dvo.WsnfAsEnrgMatMngtDvo">
    SELECT DISTINCT SVPD1.ICHR_PRTNR_NO /*담당파트너번호(엔지니어ID)*/
                  , SVPD1.CNTR_CST_NO /*계약고객번호(고객번호)*/
                  , SVPD1.CNTR_NO /*계약번호*/
                  , SVPD2.ISTLL_KNM /*설치자한글명(고객명)*/
                  , SVPD1.CST_SV_ASN_NO /*고객서비스배정번호*/
                  , SSCT2.CRAL_LOCARA_TNO /*연락처*/
                  , SSCT2.MEXNO_ENCR/*연락처*/
                  , SSCT2.CRAL_IDV_TNO/*연락처*/
                  , SVPD2.PD_CD /*품목코드*/
                  , PDBS1.PD_NM /*상품명*/
                  , NVL(SSCT2.ADR_DV_CD,'1') AS ADR_DV_CD /*주소구분코드*/
                  , SVPD2.ADR_ID /*주소ID*/
                  , CASE WHEN NVL(SSCT2.ADR_DV_CD,'1') = '1' THEN GBCO1.NEW_ADR_ZIP WHEN SSCT2.ADR_DV_CD = '2' THEN GBCO1.OLD_ADR_ZIP END AS ZIP /*우편번호*/
                  , CASE WHEN NVL(SSCT2.ADR_DV_CD,'1') = '1' THEN GBCO1.RNADR || ' ' || GBCO1.RDADR WHEN SSCT2.ADR_DV_CD = '2' THEN GBCO1.LTN_ADR || ' ' || GBCO1.LTN_DTL_ADR END AS ADR /*주소*/
                  , SVPD2.CNSL_MO_CN /*상담메모내용(접수증상)*/
                  , SVPD2.CNSL_TP_HCLSF_CD /*상담유형대분류코드  CSEL_B_CD */
                  , (SELECT CNSL_TP_HCSF_CD_NM FROM CCSDBS.TB_CLASS_A T WHERE T.JOB_CD = 'L001' AND T.CNSL_TP_HCSF_CD = SVPD2.CNSL_TP_HCLSF_CD) AS CNSL_TP_MCLSF_NM
                  , SVPD1.SV_CNR_OG_ID /*상담유형대분류코드*/
                  , SVPD1.ICHR_OG_TP_CD /*담당조직유형코드*/
                  , SVPD2.RCPDT /*접수일자*/
                  , SVPD1.VST_DUEDT /*방문예정일자*/
                  , SVPD1.ARV_DT /*도착일자*/
                  , SVPD1.VST_CNFMDT /*방문확정일자*/
                  , SVPD4.ITM_RCMD_RNK
                  , SVPD4.ITM_PD_CD
                  , PDBS2.PD_ABBR_NM

                  , SVPD1.SV_BIZ_HCLSF_CD
                  , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_HCLSF_CD', SVPD1.SV_BIZ_HCLSF_CD, 'ko') AS SV_BIZ_HCLSF_NM
                  , OGBS1.OG_NM
                  , (SELECT PRTNR_KNM
                       FROM TB_OGBS_MM_PRTNR_IZ Z
                      WHERE Z.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
                        AND Z.OG_TP_CD = OGBS1.OG_TP_CD
                        AND Z.PRTNR_NO = SVPD1.ICHR_PRTNR_NO) AS PRTNR_NM

      FROM TB_SVPD_CST_SVAS_IST_ASN_IZ           SVPD1 /*고객서비스AS설치배정내역*/
      LEFT OUTER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ SVPD2 /*고객서비스AS설치대상내역*/
        ON SVPD1.CNTR_NO = SVPD2.CNTR_NO
       AND SVPD1.CNTR_SN = SVPD2.CNTR_SN
       AND SVPD1.CST_SV_ASN_NO = SVPD2.CST_SV_ASN_NO
     INNER JOIN TB_PDBS_PD_BAS                   PDBS1 /*상품기본*/
        ON SVPD2.PD_CD = PDBS1.PD_CD
      LEFT OUTER JOIN TB_SSCT_CNTR_ADR_REL       SSCT1 /*계약주소관계*/
        ON SVPD1.CNTR_NO = SSCT1.DTL_CNTR_NO
       AND SVPD1.CNTR_SN = SSCT1.DTL_CNTR_SN
       AND SSCT1.ADRPC_TP_CD IN ('2', '3') /* 2 배달주소, 3 설치주소 */
       AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN SSCT1.VL_STRT_DTM AND SSCT1.VL_END_DTM
      LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS     SSCT2 /*계약주소지기본*/
        ON SSCT1.CNTR_ADRPC_ID = SSCT2.CNTR_ADRPC_ID
       AND SVPD1.CNTR_CST_NO = SSCT2.CNTR_CST_NO
     INNER JOIN TB_GBCO_ADR_BAS                  GBCO1 /*주소기본*/
        ON GBCO1.ADR_ID = SSCT2.ADR_ID
       AND GBCO1.DTA_DL_YN = 'N'
     ------------------------------------------------------------------------------------------------------------
     /*권장자재*/
      LEFT OUTER JOIN TB_SVPD_CST_SV_RCMD_ITM_IZ SVPD4 /*고객서비스추천품목내역*/
        ON SVPD4.PDCT_PD_CD = SVPD2.PD_CD
       AND SVPD4.CNSL_TP_HCLSF_CD = SVPD2.CNSL_TP_HCLSF_CD
       AND SVPD4.CNSL_TP_MCLSF_CD = SVPD2.CNSL_TP_MCLSF_CD
       AND SVPD4.CNSL_TP_LCLSF_CD = SVPD2.CNSL_TP_LCLSF_CD
      LEFT OUTER JOIN TB_PDBS_PD_BAS PDBS2 /*상품기본*/
        ON PDBS2.PD_CD = SVPD4.ITM_PD_CD
     ------------------------------------------------------------------------------------------------------------
      LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ OGBS1
        ON OGBS1.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
       AND OGBS1.PRTNR_NO = SVPD1.ICHR_PRTNR_NO
       AND OGBS1.BZ_STAT_CD = '1'
       AND OGBS1.DTA_DL_YN = 'N'
     WHERE SVPD1.DTA_DL_YN = 'N'
       <choose>
       <when test='@MybatisUtils@equals(dateType, "vstCnfmdt")'>
       AND SVPD1.VST_CNFMDT BETWEEN #{dateValueFromDt} AND #{dateValueToDt} /*방문확정일*/
       </when>
       <when test='@MybatisUtils@equals(dateType, "rcpdt")'>
       AND SVPD2.RCPDT BETWEEN #{dateValueFromDt} AND #{dateValueToDt} /*접수일자*/
       </when>
       <when test='@MybatisUtils@equals(dateType, "vstDuedt")'>
       AND SVPD1.VST_DUEDT BETWEEN #{dateValueFromDt} AND #{dateValueToDt} /*예정일자*/
       </when>
       <when test='@MybatisUtils@equals(dateType, "wkExcnDt")'>
       AND SVPD1.WK_EXCN_DT BETWEEN #{dateValueFromDt} AND #{dateValueToDt} /*처리일자*/
       </when>
       </choose>
       <if test="@MybatisUtils@isNotEmpty(pdCd)">
       AND SVPD2.PD_CD = #{pdCd}
       </if>
       <if test="@MybatisUtils@isNotEmpty(svTpCd)">
       AND SVPD1.SV_BIZ_HCLSF_CD = #{svTpCd}
       </if>
       <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
       AND SVPD1.ICHR_PRTNR_NO = #{prtnrNo}
       </if>
       <if test="@MybatisUtils@isNotEmpty(ogId)">
       AND OGBS1.OG_ID = #{ogId}
       </if>
     ORDER BY SVPD1.VST_CNFMDT DESC
    </select>

</mapper>
