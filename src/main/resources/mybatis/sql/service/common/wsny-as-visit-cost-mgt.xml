<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.common.mapper.WsnyAsVisitCostMgtMapper">

    <select id="selectAsVisitCostPages" resultType="com.kyowon.sms.wells.web.service.common.dvo.WsnyAsVisitCostMgtDvo">
        SELECT TO_CHAR(TO_NUMBER(D2.SAP_MAT_CD)) AS SAP_MAT_CD   /* SAP코드 */
             , D1.PD_CD                                          /* 품목코드 */
             , D2.PD_ABBR_NM                     AS PD_NM        /* 품목명 */
             , D1.APY_STRTDT                                     /* 적용시작일자 */
             , D1.APY_ENDDT                                      /* 적용종료일자 */
             , D1.BSTR_CS_AMT                                    /* 출장비용금액S */
             , D1.IZ_SN                                          /* 내역순번 */
             , D1.RMK_CN                                         /* 비고 */
             , CASE WHEN D1.IZ_SN = D4.MAX_IZ_SN THEN 'Y'   /* 현재적용자재를 체크할 경우 미래일자의 데이터가 나오지 않기 때문 */
                    ELSE 'N'
               END                               AS IS_LAST      /* 마지막데이터여부 */
          FROM TB_SVPD_RCAS_BSTR_COST_BASE_IZ D1   /* 유상AS출장비기준내역 */
         INNER JOIN TB_PDBS_PD_BAS D2              /* 상품기본 */
            ON D2.PD_CD = D1.PD_CD
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D3     /* 상품각사속성상세 */
            ON D3.PD_CD = D2.PD_CD
         INNER JOIN
             (
               SELECT PD_CD
                    , MAX(IZ_SN) AS MAX_IZ_SN
                 FROM TB_SVPD_RCAS_BSTR_COST_BASE_IZ
                WHERE DTA_DL_YN = 'N'
                GROUP BY PD_CD
             ) D4
            ON D4.PD_CD = D1.PD_CD
         WHERE D1.DTA_DL_YN          = 'N'
           AND D2.DTA_DL_YN          = 'N'
           AND D2.PD_TP_CD           = 'M'
           AND D3.DTA_DL_YN          = 'N'
           AND D3.PD_EXTS_PRP_GRP_CD = 'PART'
           AND D3.PD_PRP_VAL19       = '4'
        <if test='@MybatisUtils@isNotEmpty(pdGrpCd)'>
           AND D3.PD_PRP_VAL20       = #{pdGrpCd}
        </if>
        <if test='@MybatisUtils@isNotEmpty(pdCd)'>
           AND D1.PD_CD              = #{pdCd}
        </if>
        <if test='@MybatisUtils@equals(apyMtrChk,"Y")'>
           AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN D1.APY_STRTDT AND D1.APY_ENDDT
        </if>
         ORDER BY D1.PD_CD, D1.IZ_SN
    </select>

    <update id="updateAsVisitCostForRemove">
        UPDATE TB_SVPD_RCAS_BSTR_COST_BASE_IZ
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE PD_CD = #{pdCd}
           AND IZ_SN = #{izSn}
    </update>

    <update id="updateAsVisitCostEnddt">
        UPDATE TB_SVPD_RCAS_BSTR_COST_BASE_IZ
           SET APY_ENDDT = CASE WHEN #{apyStrtdt} IS NOT NULL THEN TO_CHAR(TO_DATE(#{apyStrtdt}, 'YYYYMMDD') - 1, 'YYYYMMDD')
                                ELSE '99991231'
                           END
        <include refid="COMMON.updateSystemField"/>
         WHERE PD_CD = #{pdCd}
           AND IZ_SN = ( SELECT MAX(D1.IZ_SN)
                           FROM TB_SVPD_RCAS_BSTR_COST_BASE_IZ D1
                          WHERE DTA_DL_YN = 'N'
                            AND PD_CD     = #{pdCd} )
    </update>

    <select id="selectMaxIzSn" resultType="java.lang.Integer">
        SELECT NVL(MAX(IZ_SN), 0) + 1
          FROM TB_SVPD_RCAS_BSTR_COST_BASE_IZ
         WHERE PD_CD = #{pdCd}
    </select>

    <insert id="insertRecapAsBstrCost">
        INSERT INTO TB_SVPD_RCAS_BSTR_COST_BASE_IZ
             (
               PD_CD
             , IZ_SN
             , BSTR_CS_AMT
             , APY_STRTDT
             , APY_ENDDT
             , RMK_CN
             , DTA_DL_YN
         <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             (
               #{pdCd}
             , #{izSn}
             , #{bstrCsAmt}
             , #{apyStrtdt}
             , #{apyEnddt}
             , #{rmkCn}
             , 'N'
        <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <update id="updateRecapAsBstrCost">
        UPDATE TB_SVPD_RCAS_BSTR_COST_BASE_IZ
           SET BSTR_CS_AMT = #{bstrCsAmt}
             , RMK_CN      = #{rmkCn}
        <include refid="COMMON.updateSystemField"/>
         WHERE PD_CD = #{pdCd}
           AND IZ_SN = #{izSn}
    </update>

</mapper>
