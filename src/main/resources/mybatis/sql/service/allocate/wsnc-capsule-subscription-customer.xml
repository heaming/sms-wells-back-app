<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncCapsuleSubscriptionCustomerMapper">

    <!--홈카페 캡슐 정기배송 고객 조회-->
    <select id="selectCapsuleRglrPrchsCsts" resultType="com.kyowon.sms.wells.web.service.allocate.dvo.WsncCapsuleSubscriptionCustomerDvo">
    /*SELECT T1.CNTR_NO
         , '00'                                                                                     AS AC201_CSMR_SEQ   *//** [ 2]LCSEQN 순번 **//*
         , DTL_CNTR_NO                                                                              AS AC201_CSMR_SER   *//** [ 3]LCSERI 일련번호 **//*
         , TO_CHAR(SYSDATE, 'YYYYMMDD')                                                             AS AC201_RECD_DT
         , '10'                                                                                     AS AC201_CO_CD      *//** [ 4]LCCOMP 회사코드 **//*
         , SELL_INFLW_CHNL_DTL_CD                                                                   AS AC201_SALE_GB    *//** [ 5]LCSALE 판매구분 - F_CMZ_CD_NM > SELL_CHNL_DTL_CD **//*
         , T2.SELL_TP_CD                                                                            AS AC201_MGT_GB     *//** [ 6]LCTYPE 판매유형 F_CMZ_CD_NM > SELL_TP_CD **//*
         , T3.PRTNR_NO                                                                              AS AC201_EMP_ID_PTNR*//** [ 7]LCDCDE 파트너 **//*
         , T3.CRAL_LOCARA_TNO                                                                       AS AC201_TEL_CO_PTNR*//** [ 8]LCDTL1 전화１**//*
         , T3.MEXNO_ENCR                                                                            AS AC201_HP_NO1_PTNR*//** [ 9]LCDTL2 전화２ **//*
         , T3.CRAL_IDV_TNO                                                                          AS AC201_HP_NO2_PTNR*//** [10]LCDTL3 전화３ **//*
         , T3.PRTNR_NO                                                                              AS AC201_EMP_ID_CH  *//** [11]LCDBON 지점장 **//*
         , T3.CRAL_LOCARA_TNO                                                                       AS AC201_TEL_CO_CH  *//** [12]LCBTL1 전화１ **//*
         , T3.MEXNO_ENCR                                                                            AS AC201_HP_NO1_CH  *//** [13]LCBTL2 전화２ **//*
         , T3.CRAL_IDV_TNO                                                                          AS AC201_HP_NO2_CH  *//** [14]LCBTL3 전화３ **//*
         , T8.COPN_DV_CD                                                                            AS AC201_INST_GB    *//** [15]LCWGUB 구분 **//*
         , T8.RCGVP_KNM                                                                             AS AC201_CUST_NM    *//** [16]LCWNAM 고객명 **//*
         , '0'                                                                                      AS AC201_ID_NO      *//** [17]LCWINO 주민／사업 NO **//*
         , T8.CRAL_LOCARA_TNO                                                                       AS AC201_TEL_CO     *//** [18]LCWNO1 휴대폰１ **//*
         , T8.MEXNO_ENCR                                                                            AS AC201_HP_NO1     *//** [19]LCWNO2 휴대폰２  2015.05.31 김경희 DB암호화 **//*
         , T8.CRAL_IDV_TNO                                                                          AS AC201_HP_NO2     *//** [20]LCWNO3 휴대폰３ **//*
         , T8.LOCARA_TNO                                                                            AS AC201_TEL_AR     *//** [21]LCWDDD 전화지역 **//*
         , T8.EXNO_ENCR                                                                             AS AC201_TEL_NO1    *//** [22]LCWTL1 전화국    2015.05.31 김경희 DB암호화 **//*
         , T8.IDV_TNO                                                                               AS AC201_TEL_NO2    *//** [23]LCWTL2 전화번호 **//*
         , CASE WHEN T9.NEW_ADR_ZIP IS NOT NULL THEN T9.NEW_ADR_ZIP ELSE T9.OLD_ADR_ZIP END         AS AC201_ZIP_NO     *//** [24]LCWZP1 우편１ **//*
         , CASE WHEN T9.NEW_ADR_ZIP IS NOT NULL THEN T9.RNADR ELSE T9.LTN_ADR END                   AS AC201_ADD        *//** [26]LCWAD1 주소１ **//*
         , CASE WHEN T9.NEW_ADR_ZIP IS NOT NULL THEN T9.RDADR ELSE T9.LTN_DTL_ADR END               AS AC201_ADD        *//** [26]LCWAD1 주소１ **//*
         , BASE_PD_CD                                                                               AS AC201_GDS_CD     *//** [28]LCICDE 상품코드 2016.10.28 이충관 수정 - 기존 LCICDE를 LCNCDE로 변경(단종상품관련) **//*
         , '1'                                                                                      AS AC201_GDS_QTY    *//** [29]LCIQTY 상품수량 **//*
         , 'A'                                                                                      AS AC201_DEG        *//** [30]LCIGRD 상품등급 (일단제외) **//*
         , PD_PRP_VAL01                                                                             AS AC201_USGE       *//** [31]LCIUSE 상품용도 **//*
         , '2'                                                                                      AS AC201_SALE_TYP   *//** [32]LCVGU1 관리구분   1 할부  2 렌탈  3 멤버  4 회사  9 **//*
         , SV_PRD                                                                                   AS AC201_CYCL_TYP   *//** [32]LCVGU2 방문주기 **//*
         , '1M1'                                                                                    AS AC201_CYCL_TYP   *//** [32]LCVGU2 방문주기 **//*
         , TO_CHAR(RECAP_DUTY_PTRM_N)                                                               AS AC201_DUTY_MTHS  *//** [34]LCVGU3 의무사용 (무상기간) **//*
         , STPL_PTRM                                                                                AS AC201_AS_MTHS    *//** [35]LCVGU4 무상 A/S **//*
         , STPL_PTRM                                                                                AS AC201_BS_MTHS    *//** [36]LCVGU5 무상 B/S **//*
         , LPAD(TO_CHAR(CNTR_RCP_FSH_DTM), 4, '0') || LPAD(TO_CHAR(CNTR_RCP_FSH_DTM), 2, '0')
         || LPAD(TO_CHAR(CNTR_RCP_FSH_DTM), 2, '0') AS AC201_CONT_DT    *//** [37]LCCRTT 계약일자 **//*
         , (CASE WHEN IST_DT = 0 THEN TO_CHAR(SYSDATE, 'YYYYMMDD') ELSE IST_DT END)                 AS AC201_INST_DT    *//** [38]LCSETT 설치일자 **//*
         , ''                                                                                       AS AC201_CHNG_DT    *//** [39]LCCHGT 교체일자 **//*
         , CASE WHEN REQD_DT != 0 THEN REQD_DT ELSE '' END                                          AS AC201_REMV_DT    *//** [40]LCREMT 철거일자 **//*
         , CASE WHEN REQD_DT != 0 THEN REQD_DT ELSE '' END                                          AS AC201_CANC_DT    *//** [41]LCCANT 취소일자 **//*
         , ''                                                                                       AS AC201_COMP_DT    *//** [42]LCCOMT 보상일자 **//*
         , ''                                                                                       AS AC201_STOP_DT
         , ''                                                                                       AS AC201_COMP_YN    *//** [43]LCBGU1 보상유무 **//*
         , ''                                                                                       AS AC201_RET_YN     *//** [44]LCBGU2 회수유무 **//*
         , ''                                                                                       AS AC201_MKD_CO     *//** [45]LCBCMP 제조회사 **//*
         , null                                                                                     AS AC201_CSMR_YR_B  *//** [46]LCBTYP **//*
         , null                                                                                     AS AC201_CSMR_CD_B  *//** [46]LCBYER 년도 **//*
         , null                                                                                     AS AC201_CSMR_SEQ_B *//** [47]LCBCDE 고객코드 **//*
         , ADR_DV_CD                                                                                AS AC201_ADD_GB     *//** [64]LCWAGB 주소구분(1:도로명,2:지번) - 2015.01.02 정찬영 추가 - 도로명주소 **//*
         , CASE WHEN T9.NEW_ADR_ZIP IS NOT NULL THEN T9.RDADR ELSE T9.LTN_DTL_ADR END               AS AC201_ADD_REFER  *//** [65]LCWAD3 주소3 **//*
         , BASE_PD_CD                                                                               AS AC201_GDS_CD_OLD
         , '00'                                                                                     AS AC201_BS_GB1
         , '2'                                                                                      AS AC201_BS_GB2
         , ''                                                                                       AS AC201_ETC_1
         , ''                                                                                       AS AC201_ETC_3
         , ''                                                                                       AS AC201_ETC_9
         , TO_CHAR(SYSDATE + 2, 'YYYYMMDD')                                                         AS REQ_VST_DT
         , null                                                                                     AS P_AC201_CSMR_SER
      FROM TB_SSCT_CNTR_BAS *//*계약기본*//*      T1
     INNER JOIN TB_SSCT_CNTR_DTL              T2  ON T1.CNTR_NO       = T2.CNTR_NO      *//*계약상세*//*
      LEFT OUTER JOIN TB_OGBS_PRTNR_BAS       T3  ON T1.SELL_PRTNR_NO = T3.PRTNR_NO     *//*파트너기본*//*
      LEFT OUTER JOIN TB_OGBS_OG_BAS          T4  ON T3.OG_CD         = T4.OG_CD        *//*조직기본*//*
      LEFT OUTER JOIN TB_OGBS_PRTNR_BAS       T5  ON T4.HOO_PRTNR_NO  = T3.PRTNR_NO     *//*파트너기본*//*
      LEFT OUTER JOIN TB_SSCT_CNTR_CST_REL    T6  ON T6.CNTR_NO       = T1.CNTR_NO      *//*계약고객관계*//*
      LEFT OUTER JOIN TB_CUBS_CST_BAS         T7  ON T6.CST_NO        = T7.CST_NO       *//*고객기본*//*
      LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS  T8  ON T1.CNTR_NO       = T8.CNTR_NO      *//*계약주소지기본*//*
      LEFT OUTER JOIN TB_GBCO_ADR_BAS         T9  ON T9.ADR_ID        = T8.ADR_ID       *//*주소기본*//*
      LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL  T10 ON T1.CNTR_NO       = T10.CNTR_NO     *//*계약WELLS상세*//*
      LEFT OUTER JOIN TB_PDBS_PD_BAS          T11 ON T2.BASE_PD_CD    = T11.PD_CD       *//*상품기본*//*
      LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL T12 ON T2.BASE_PD_CD    = T12.PD_CD       *//*상품각사속성상세*//*
      LEFT OUTER JOIN TB_PDBS_PD_CLSF_BAS     T13 ON T13.PD_CLSF_ID   = T11.PD_MCLSF_ID *//*상품분류기본*//*
     WHERE T1.DTA_DL_YN = 'N'
       AND IST_DT IS NULL *//*설치일자*//*
       AND CNTR_CNFM_DTM IS NOT NULL
       AND T11.PD_CLSF_ID = 'PDC000000000128' *//*상품분류 - 커피머신*//*
       AND T2.SELL_TP_CD = '6' *//*정기배송*//*
       AND T1.CNTR_NO NOT IN ('W20214673911') *//*--전아영 매니저 테스트 건*/

    SELECT C2.CNTR_NO
         , C2.CNTR_SN
         , A1.NEW_ADR_ZIP -- 우편번호
         , C2.BASE_PD_CD -- 기준상품코드
         , P2.PD_NM AS BASE_PD_NM -- 기준상품코드
         , P1.OJ_PD_CD AS PDCT_PD_CD-- 제품상품코드
         , P3.PD_NM AS PDCT_PD_NM  -- 제품상품코드
         , P4.PD_PRP_VAL20 AS PD_GRP_CD
         , F_CMZ_CD_NM('TNT_WELLS', 'PD_GRP_CD', P4.PD_PRP_VAL20) AS PD_GRP_NM
         , C2.CNTR_PD_STRTDT AS CNTR_DT
         , C1.COPN_DV_CD -- 법인격구분코드 (1개인, 2법인)
         , CASE WHEN C5.OJ_DTL_CNTR_NO IS NULL THEN '03'
                ELSE (CASE WHEN #{baseYmd} > TO_CHAR(SYSDATE + 40, 'YYYYMM')  THEN '02' ELSE '01' END ) END AS SDING_COMBIN --LCST09
         , C6.CST_SV_ASN_NO
         , CASE WHEN REQD_DT != 0 THEN REQD_DT ELSE '' END CANC_DT
         , C6.ASN_OJ_YM
         , C6.SV_BIZ_MCLSF_CD
         , C6.SV_BIZ_DCLSF_CD
         , C6.WK_SN
      FROM TB_SSCT_CNTR_BAS C1
     INNER JOIN TB_SSCT_CNTR_DTL C2
        ON C1.CNTR_NO = C2.CNTR_NO
      INNER JOIN TB_SSCT_CNTR_ADR_REL C3
        ON C2.CNTR_NO = C3.DTL_CNTR_NO
       AND C2.CNTR_SN = C3.DTL_CNTR_SN
       AND C3.ADRPC_TP_CD IN ('2', '3') -- 계약지유형(1:계약주소, 2:배달주소, 3:설치주소)
       AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN C3.VL_STRT_DTM AND C3.VL_END_DTM
     INNER JOIN TB_SSCT_CNTR_ADRPC_BAS C4
        ON C3.CNTR_ADRPC_ID = C4.CNTR_ADRPC_ID
     INNER JOIN TB_GBCO_ADR_BAS A1
        ON C4.ADR_ID = A1.ADR_ID
     INNER JOIN TB_SSCT_CNTR_PD_REL P1
        ON TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN P1.VL_STRT_DTM AND P1.VL_END_DTM
       AND P1.PD_REL_TP_CD IN ('05', '18') -- 상품관계유형(05: 기준-제품, 18:정기BS제품)
       AND P1.CNTR_NO = C2.CNTR_NO
       AND P1.CNTR_SN = C2.CNTR_SN
     INNER JOIN TB_PDBS_PD_BAS P2
        ON P1.BASE_PD_CD = P2.PD_CD
     INNER JOIN TB_PDBS_PD_BAS P3
        ON P1.OJ_PD_CD = P3.PD_CD
     INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL P4
        ON P1.OJ_PD_CD = P4.PD_CD
       AND P4.PD_EXTS_PRP_GRP_CD = 'PART'
      LEFT OUTER JOIN TB_SSCT_CNTR_REL C5
        ON C5.BASE_DTL_CNTR_NO = C2.CNTR_NO
       AND C5.BASE_DTL_CNTR_SN = C2.CNTR_sn
       AND C5.CNTR_REL_DTL_CD = '216' /*모종결합*/
       AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN C5.VL_STRT_DTM AND C5.VL_END_DTM
       AND C5.DTA_DL_YN = 'N'
      LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL T10
        ON C1.CNTR_NO = T10.CNTR_NO
       AND C2.CNTR_SN= T10.CNTR_SN
       AND T10.DTA_DL_YN = 'N'
      LEFT OUTER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ C6
        ON C6.CNTR_NO = C2.CNTR_NO
       AND C6.CNTR_SN = C2.CNTR_SN
       AND C6.ASN_OJ_YM = SUBSTR(#{baseYmd}, 0, 6)
    </select>

    <delete id="deleteBfsvcPrd">
    /*무결성 제약 조건 오류 방지*/
    DELETE FROM TB_SVPD_CST_SV_RGBSPR_IZ
     WHERE CNTR_NO = #{cntrNo}
       AND CNTR_SN = #{cntrSn}
       AND WK_DT IS NULL
    </delete>

    <update id="updateIstDt">
    /*BS 사전생성을 위해서 강제 입력한 설치일자 삭제*/
    UPDATE TB_SVPD_CST_SV_EXCN_DL_IZ
       SET IST_DT = ''
     WHERE CNTR_NO = #{cntrNo}
       AND CNTR_SN = #{cntrSn}
       AND SL_DT IS NULL
    </update>

    <update id="updateCancelDate">
    /*취소일자 업데이트*/
    UPDATE TB_SVPD_CST_SV_EXCN_DL_IZ
       SET CAN_DT = #{canDt}
     WHERE CNTR_NO = #{cntrNo}
       AND CNTR_SN = #{cntrSn}
    </update>


    <delete id="deleteSchd">
    /*스케쥴을 삭제 한다*/
    DELETE FROM TB_SVPD_CST_SV_RGBSPR_IZ
     WHERE CNTR_NO = #{cntrNo}
       AND CNTR_SN = '00'
       AND VST_DUEDT >= TO_CHAR(SYSDATE, 'YYYYMM') || '01'
       AND WK_DT IS NULL
    </delete>

</mapper>
