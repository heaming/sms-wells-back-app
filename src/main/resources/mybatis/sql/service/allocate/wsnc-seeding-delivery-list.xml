<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncSeedingDeliveryListMapper">
    <select id="selectSeedingDeliveryList"
            resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncSeedingDeliveryListDto$SearchRes">
        SELECT MAX(MAIN.CNTR_NO) AS CNTR_NO
             , MAX(MAIN.CNTR_SN) AS CNTR_SN
             , MAX(MAIN.SDING_INFO) AS SDING_INFO /* 상품명 */
             , MAX(ADR) AS ADR /* 배송주소 */
             , VST_DT /* 배송예정일 */
             , (CASE WHEN MAX(MAIN.VST_DT) &gt; TO_CHAR(SYSDATE, 'YYYYMMDD') THEN '배송준비중'
                      WHEN MAX(MAIN.WK_DT) IS NOT NULL THEN '배송완료'
                      WHEN MAX(MAIN.SPP_CNFMDT) IS NOT NULL THEN '배송중'
                      ELSE ''
             END ) AS DLVY_STATUS /* 배송상태 */
             , MAX(SELL_AMT) AS SELL_AMT /* 금액(월) */
         FROM (SELECT MAX(F1.CNTR_NO) CNTR_NO
                    , MAX(F1.CNTR_SN) CNTR_SN
                    , MAX(F1.WK_DT) WK_DT
                    , NVL(F1.WK_DT, F1.VST_DUEDT) VST_DT
                    , MAX(F3.SPP_CNFMDT) SPP_CNFMDT
                    , MAX(ADR) AS ADR
                    , MAX(F3.SDING_PKG_PD_CD) SDING_PKG_PD_CD
                    , MAX(CASE WHEN F2.SDING_SN = 1 AND P1.PD_CLSF_ID NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN P1.PD_NM||' '||F2.SDING_QTY ELSE '' END)
                    || MAX(CASE WHEN F2.SDING_SN = 2 AND P1.PD_CLSF_ID NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN ' / '||P1.PD_NM||' '||F2.SDING_QTY ELSE '' END)
                    || MAX(CASE WHEN F2.SDING_SN = 3 AND P1.PD_CLSF_ID NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN ' / '||P1.PD_NM||' '||F2.SDING_QTY ELSE '' END)
                    || MAX(CASE WHEN F2.SDING_SN = 4 AND P1.PD_CLSF_ID NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN ' / '||P1.PD_NM||' '||F2.SDING_QTY ELSE '' END)
                    || MAX(CASE WHEN F2.SDING_SN = 5 AND P1.PD_CLSF_ID NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN ' / '||P1.PD_NM||' '||F2.SDING_QTY ELSE '' END) AS SDING_INFO
                    , (NVL(PR1.SELL_AMT, 0)
                     + NVL(PR2.SELL_AMT,0)
                     + NVL(PR3.SELL_AMT,0)
                     + NVL(PR4.SELL_AMT,0)
                     + NVL(PR5.SELL_AMT,0)) AS SELL_AMT
                FROM ( SELECT T1.*
                            , A1.SPP_MTHD_TP_CD
                            , A3.RNADR ||' '|| A3.RDADR AS ADR
                         FROM TB_SVPD_SDING_SPP_PLAN_IZ T1
                   INNER JOIN WSMDBS.TB_SSCT_CNTR_ADR_REL A1 /* 계약주소관계 */
                           ON T1.CNTR_NO = A1.DTL_CNTR_NO
                          AND T1.CNTR_SN = A1.DTL_CNTR_SN
                          AND A1.ADRPC_TP_CD IN ('2') /*1 계약주소, 2 배달주소, 3 설치주소 */
                          AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN A1.VL_STRT_DTM AND A1.VL_END_DTM
                          AND A1.DTA_DL_YN = 'N'
                   INNER JOIN WSMDBS.TB_SSCT_CNTR_ADRPC_BAS A2 /* 계약주소지기본 */
                           ON A1.CNTR_ADRPC_ID = A2.CNTR_ADRPC_ID /* 계약주소지ID */
                          AND A2.DTA_DL_YN = 'N'
              LEFT OUTER JOIN GBSDBS.TB_GBCO_ADR_BAS A3
                           ON A2.ADR_ID = A3.ADR_ID   /*이해욱이사님,이진성프로님과 협의 설치, AS는 배정시에 주소를 사용 해야 하기 때문에 TB_SVPD_CST_SVAS_IST_OJ_IZ 에 ADR_ID 를 추가 하기로 함. 테이블이 변경 되면, T4.ADR_ID 를 T1.ADR_ID 으로 수정 해야 함*/
                          AND A3.DTA_DL_YN = 'N'
                        WHERE T1.CNTR_NO = #{cntrNo}
                          AND T1.CNTR_SN = #{cntrSn}
                ) F1
          INNER JOIN TB_SVPD_SDING_SPP_EXP_IZ F2 /* 모종배송예정내역 FA102 */
                  ON F1.CNTR_NO = F2.CNTR_NO
                 AND F1.CNTR_SN = F2.CNTR_SN
                 AND F1.SV_BIZ_HCLSF_CD = F2.SV_BIZ_HCLSF_CD
                 AND F1.SV_BIZ_DCLSF_CD = F2.SV_BIZ_DCLSF_CD
                 AND F1.SDING_SPP_NO = F2.SDING_SPP_NO
                 AND F1.SDING_SPP_SN = F2.SDING_SPP_SN
          INNER JOIN TB_PDBS_PD_BAS P1
                  ON F2.SDING_PD_CD = P1.PD_CD
--        INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ S1 /* 고객서비스AS설치대상내역 AC211 */
--                  ON F1.CNTR_NO = S1.CNTR_NO
--                 AND F1.CNTR_SN = S1.CNTR_SN
--                 AND F1.SV_BIZ_HCLSF_CD = S1.SV_BIZ_HCLSF_CD
--                 AND F1.SV_BIZ_DCLSF_CD = S1.SV_BIZ_DCLSF_CD
--                 AND S1.AS_IST_OJ_NO LIKE '%'||S1.SV_BIZ_HCLSF_CD|| SUBSTR(F1.SDING_SPP_NO,1,9)||LPAD(SUBSTR(F1.SDING_SPP_NO, 10),8,'0')
     LEFT OUTER JOIN TB_PDBS_SDING_PRC_BAS PR1
                  ON F2.SDING_PD_CD = PR1.PDCT_PD_CD
                 AND NVL(F1.WK_DT, F1.VST_DUEDT) BETWEEN PR1.APY_STRTDT AND PR1.APY_ENDDT
                 AND F1.SPP_MTHD_TP_CD = PR1.RGLR_SPP_MCHN_TP_CD
                 AND F2.SDING_SN = 1
     LEFT OUTER JOIN TB_PDBS_SDING_PRC_BAS PR2
                  ON F2.SDING_PD_CD = PR1.PDCT_PD_CD
                 AND NVL(F1.WK_DT, F1.VST_DUEDT) BETWEEN PR1.APY_STRTDT AND PR1.APY_ENDDT
                 AND F1.SPP_MTHD_TP_CD = PR1.RGLR_SPP_MCHN_TP_CD
                 AND F2.SDING_SN = 2
     LEFT OUTER JOIN TB_PDBS_SDING_PRC_BAS PR3
                  ON F2.SDING_PD_CD = PR1.PDCT_PD_CD
                 AND NVL(F1.WK_DT, F1.VST_DUEDT) BETWEEN PR1.APY_STRTDT AND PR1.APY_ENDDT
                 AND F1.SPP_MTHD_TP_CD = PR1.RGLR_SPP_MCHN_TP_CD
                 AND F2.SDING_SN = 3
     LEFT OUTER JOIN TB_PDBS_SDING_PRC_BAS PR4
                  ON F2.SDING_PD_CD = PR1.PDCT_PD_CD
                 AND NVL(F1.WK_DT, F1.VST_DUEDT) BETWEEN PR1.APY_STRTDT AND PR1.APY_ENDDT
                 AND F1.SPP_MTHD_TP_CD = PR1.RGLR_SPP_MCHN_TP_CD
                 AND F2.SDING_SN = 4
     LEFT OUTER JOIN TB_PDBS_SDING_PRC_BAS PR5
                  ON F2.SDING_PD_CD = PR1.PDCT_PD_CD
                 AND NVL(F1.WK_DT, F1.VST_DUEDT) BETWEEN PR1.APY_STRTDT AND PR1.APY_ENDDT
                 AND F1.SPP_MTHD_TP_CD = PR1.RGLR_SPP_MCHN_TP_CD
                 AND F2.SDING_SN = 5
     LEFT OUTER JOIN TB_SVPD_SDING_SPP_CNFM_IZ F3 /* 모종배송확정내역 FA103 */
                  ON F1.CNTR_NO = F3.CNTR_NO
                 AND F1.CNTR_SN = F3.CNTR_SN
                 AND F1.SV_BIZ_HCLSF_CD = F3.SV_BIZ_HCLSF_CD
                 AND F1.SV_BIZ_DCLSF_CD = F3.SV_BIZ_DCLSF_CD
                 AND F1.SDING_SPP_NO = F3.SDING_SPP_NO
                 AND F1.SDING_SPP_SN = F3.SDING_SPP_SN
               WHERE F1.SDING_SPP_SN = (SELECT MAX(SDING_SPP_SN)
                                         FROM TB_SVPD_SDING_SPP_PLAN_IZ TEMP
                                        WHERE F1.CNTR_NO = TEMP.CNTR_NO
                                          AND F1.CNTR_SN = TEMP.CNTR_SN
                                          AND F1.SV_BIZ_HCLSF_CD = TEMP.SV_BIZ_HCLSF_CD
                                          AND F1.SV_BIZ_DCLSF_CD = TEMP.SV_BIZ_DCLSF_CD
                                          AND F1.SDING_SPP_NO = TEMP.SDING_SPP_NO
                                          AND F1.SDING_SPP_SN = TEMP.SDING_SPP_SN)
                 AND F1.SV_BIZ_HCLSF_CD = '1'
                 AND F1.SV_BIZ_DCLSF_CD LIKE '11%'
            GROUP BY NVL(F1.WK_DT, F1.VST_DUEDT)
                    , PR1.SELL_AMT
                    , PR2.SELL_AMT
                    , PR3.SELL_AMT
                    , PR4.SELL_AMT
                    , PR5.SELL_AMT

        UNION ALL

              SELECT MAX(CNTR_NO) CNTR_NO
                    , MAX(CNTR_SN) CNTR_SN
                    , MAX(WK_DT) WK_DT
                    , VST_DT
                    , MAX(SPP_CNFMDT)
                    , MAX(ADR) ADR
                    , MAX(SDING_PKG_PD_CD) SDING_PKG_PD_CD
                    , MAX( CASE WHEN SDING_PD_CLSF_ID1 NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN SDING_PD_NM1||' '||SDING_QTY1 ELSE ''  END)
                    || MAX(CASE WHEN SDING_PD_CLSF_ID2  NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN ' / '||SDING_PD_NM2||' '||SDING_QTY2 ELSE '' END)
                    || MAX(CASE WHEN SDING_PD_CLSF_ID3  NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN ' / '||SDING_PD_NM3||' '||SDING_QTY3 ELSE '' END)
                    || MAX(CASE WHEN SDING_PD_CLSF_ID4  NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN ' / '||SDING_PD_NM4||' '||SDING_QTY4 ELSE '' END)
                    || MAX(CASE WHEN SDING_PD_CLSF_ID5  NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN SDING_PD_NM5||' '||SDING_QTY5 ELSE '' END) AS SDING_INFO
                    , (MAX(CASE WHEN SDING_PD_CLSF_ID1 NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN SDING_QTY1 * SELL_AMT1 ELSE 0 END)
                    + MAX(CASE WHEN SDING_PD_CLSF_ID2 NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN SDING_QTY2 * SELL_AMT2 ELSE 0 END)
                    + MAX(CASE WHEN SDING_PD_CLSF_ID3 NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN SDING_QTY3 * SELL_AMT3 ELSE 0 END)
                    + MAX(CASE WHEN SDING_PD_CLSF_ID4 NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN SDING_QTY4 * SELL_AMT4 ELSE 0 END)
                    + MAX(CASE WHEN SDING_PD_CLSF_ID5 NOT IN ('PDC000000001839', 'PDC000000002020', 'PDC000000000120') THEN SDING_QTY5 * SELL_AMT5 ELSE 0 END)) AS SELL_AMT
                FROM (
                    SELECT S2.CNTR_NO
                           , S2.CNTR_SN
                           , F4.SDING_PD_CD1
                           , F4.SDING_QTY1
                           , (SELECT PD_CLSF_ID FROM TB_PDBS_PD_BAS WHERE F4.SDING_PD_CD1 = TB_PDBS_PD_BAS.PD_CD AND S2.PART_PD_CD = F4.SDING_PD_CD1) SDING_PD_CLSF_ID1
                           , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE F4.SDING_PD_CD1 = TB_PDBS_PD_BAS.PD_CD  AND S2.PART_PD_CD = F4.SDING_PD_CD1) SDING_PD_NM1
                           , (SELECT SELL_AMT FROM TB_PDBS_SDING_PRC_BAS P2 WHERE F4.SDING_PD_CD1 = P2.PDCT_PD_CD AND NVL(S2.WK_DT, S2.VST_DUEDT) BETWEEN P2.APY_STRTDT AND P2.APY_ENDDT AND F4.SPP_MTHD_TP_CD = P2.RGLR_SPP_MCHN_TP_CD) SELL_AMT1
                           , F4.SDING_PD_CD2
                           , F4.SDING_QTY2
                           , (SELECT PD_CLSF_ID FROM TB_PDBS_PD_BAS WHERE F4.SDING_PD_CD2 = TB_PDBS_PD_BAS.PD_CD AND S2.PART_PD_CD = F4.SDING_PD_CD2) SDING_PD_CLSF_ID2
                           , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE F4.SDING_PD_CD2 = TB_PDBS_PD_BAS.PD_CD AND S2.PART_PD_CD = F4.SDING_PD_CD2) SDING_PD_NM2
                           , (SELECT SELL_AMT FROM TB_PDBS_SDING_PRC_BAS P2 WHERE F4.SDING_PD_CD2 = P2.PDCT_PD_CD AND NVL(S2.WK_DT, S2.VST_DUEDT) BETWEEN P2.APY_STRTDT AND P2.APY_ENDDT AND F4.SPP_MTHD_TP_CD = P2.RGLR_SPP_MCHN_TP_CD) SELL_AMT2
                           , F4.SDING_PD_CD3
                           , F4.SDING_QTY3
                           , (SELECT PD_CLSF_ID FROM TB_PDBS_PD_BAS WHERE F4.SDING_PD_CD3 = TB_PDBS_PD_BAS.PD_CD AND S2.PART_PD_CD = F4.SDING_PD_CD3) SDING_PD_CLSF_ID3
                           , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE F4.SDING_PD_CD3 = TB_PDBS_PD_BAS.PD_CD  AND S2.PART_PD_CD = F4.SDING_PD_CD3) SDING_PD_NM3
                           , (SELECT SELL_AMT FROM TB_PDBS_SDING_PRC_BAS P2 WHERE F4.SDING_PD_CD3 = P2.PDCT_PD_CD AND NVL(S2.WK_DT, S2.VST_DUEDT) BETWEEN P2.APY_STRTDT AND P2.APY_ENDDT AND F4.SPP_MTHD_TP_CD = P2.RGLR_SPP_MCHN_TP_CD) SELL_AMT3
                           , F4.SDING_PD_CD4
                           , F4.SDING_QTY4
                           , (SELECT PD_CLSF_ID FROM TB_PDBS_PD_BAS WHERE F4.SDING_PD_CD4 = TB_PDBS_PD_BAS.PD_CD  AND S2.PART_PD_CD = F4.SDING_PD_CD4) SDING_PD_CLSF_ID4
                           , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE F4.SDING_PD_CD4 = TB_PDBS_PD_BAS.PD_CD  AND S2.PART_PD_CD = F4.SDING_PD_CD4) SDING_PD_NM4
                           , (SELECT SELL_AMT FROM TB_PDBS_SDING_PRC_BAS P2 WHERE F4.SDING_PD_CD4 = P2.PDCT_PD_CD AND NVL(S2.WK_DT, S2.VST_DUEDT) BETWEEN P2.APY_STRTDT AND P2.APY_ENDDT AND F4.SPP_MTHD_TP_CD = P2.RGLR_SPP_MCHN_TP_CD) SELL_AMT4
                           , F4.SDING_PD_CD5
                           , F4.SDING_QTY5
                           , (SELECT PD_CLSF_ID FROM TB_PDBS_PD_BAS WHERE F4.SDING_PD_CD5 = TB_PDBS_PD_BAS.PD_CD AND S2.PART_PD_CD = F4.SDING_PD_CD5) SDING_PD_CLSF_ID5
                           , (SELECT PD_NM FROM TB_PDBS_PD_BAS WHERE F4.SDING_PD_CD5 = TB_PDBS_PD_BAS.PD_CD  AND S2.PART_PD_CD = F4.SDING_PD_CD5) SDING_PD_NM5
                           , (SELECT SELL_AMT FROM TB_PDBS_SDING_PRC_BAS P2 WHERE F4.SDING_PD_CD5 = P2.PDCT_PD_CD AND NVL(S2.WK_DT, S2.VST_DUEDT) BETWEEN P2.APY_STRTDT AND P2.APY_ENDDT AND F4.SPP_MTHD_TP_CD = P2.RGLR_SPP_MCHN_TP_CD) SELL_AMT5
                           , F4.ADR
                           , NVL(S2.WK_DT, S2.VST_DUEDT) VST_DT
                           , F4.SPP_CNFMDT
                           , S2.WK_DT
                           , SDING_PKG_PD_CD
                        FROM TB_SVPD_CST_SV_RGBSPR_IZ S2 /* 고객서비스정기BS주기내역 VS107 */
                  INNER JOIN ( SELECT T1.*
                                    , A1.SPP_MTHD_TP_CD
                                    , A3.RNADR ||' '|| A3.RDADR AS ADR
                                 FROM TB_SVPD_SDING_SPP_CNFM_IZ T1
                           INNER JOIN WSMDBS.TB_SSCT_CNTR_ADR_REL A1 /* 계약주소관계 */
                                   ON T1.CNTR_NO = A1.DTL_CNTR_NO
                                  AND T1.CNTR_SN = A1.DTL_CNTR_SN
                                  AND A1.ADRPC_TP_CD IN ('2') /*1 계약주소, 2 배달주소, 3 설치주소 */
                                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN A1.VL_STRT_DTM AND A1.VL_END_DTM
                                  AND A1.DTA_DL_YN = 'N'
                           INNER JOIN WSMDBS.TB_SSCT_CNTR_ADRPC_BAS A2 /* 계약주소지기본 */
                                   ON A1.CNTR_ADRPC_ID = A2.CNTR_ADRPC_ID /* 계약주소지ID */
                                  AND A2.DTA_DL_YN = 'N'
                      LEFT OUTER JOIN GBSDBS.TB_GBCO_ADR_BAS A3
                                  ON A2.ADR_ID = A3.ADR_ID   /*이해욱이사님,이진성프로님과 협의 설치, AS는 배정시에 주소를 사용 해야 하기 때문에 TB_SVPD_CST_SVAS_IST_OJ_IZ 에 ADR_ID 를 추가 하기로 함. 테이블이 변경 되면, T4.ADR_ID 를 T1.ADR_ID 으로 수정 해야 함*/
                                 AND A3.DTA_DL_YN = 'N'
                               WHERE T1.CNTR_NO = #{cntrNo}
                               AND T1.CNTR_SN = #{cntrSn}
                           ) F4
                        ON S2.CNTR_NO = F4.CNTR_NO
                       AND S2.CNTR_SN = F4.CNTR_SN
                       AND S2.SV_BIZ_DCLSF_CD = F4.SV_BIZ_DCLSF_CD
                       AND F4.SDING_SPP_NO LIKE '2'||SUBSTR(S2.VST_DUEDT,1,6)||'%'
                       AND (S2.PART_PD_CD = F4.SDING_PD_CD1 OR
                            S2.PART_PD_CD = F4.SDING_PD_CD2 OR
                            S2.PART_PD_CD = F4.SDING_PD_CD3 OR
                            S2.PART_PD_CD = F4.SDING_PD_CD4 OR
                            S2.PART_PD_CD = F4.SDING_PD_CD5)
                        WHERE S2.VST_DUEDT &lt;=  TO_CHAR(ADD_MONTHS(SYSDATE, 3),'YYYYMMDD')
                  ) MAIN2
          GROUP BY VST_DT--, SPP_CNFMDT
         ) MAIN
  LEFT OUTER JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ S3 /* inner join 해야함 */
               ON MAIN.CNTR_NO = S3.CNTR_NO
              AND MAIN.CNTR_SN = S3.CNTR_SN
              AND SUBSTR(MAIN.VST_DT,1,6) = S3.MNGT_YM
         GROUP BY VST_DT
         ORDER BY VST_DT DESC
    </select>
</mapper>

