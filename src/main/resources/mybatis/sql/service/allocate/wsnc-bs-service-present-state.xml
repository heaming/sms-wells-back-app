<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncBsServicePresentStateMapper">
    <select id="selectBsServicePresentStates" resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncBsServicePresentStateDto$SearchResList">
         SELECT OG_ID
             , PRTNR_NO
             , PRTNR_KNM
             , MNG_CNT AS MNGT_ACC
             , VST_CNT AS VST_ACC
             , WRK_CNT AS FSH_ACC
             , OG_CD
              , OG_NM
              , BLD_CD
              , BLD_NM
              , PSTN_DV_CD_NM
             , (CASE WHEN VST_CNT > 0  THEN ROUND((WRK_CNT / VST_CNT) * 100, 1) ELSE 0 END) AS SVC_PROC
             , #{mgtYnm} AS ASN_OJ_YM /* TODO 관리년월 내용 확인 */
             , '' AS MNGT_SCHD /* TODO 관리년월 내용 확인 */
          FROM (
                SELECT OG_CD
                     , OG_NM
                     , BLD_CD
                     , BLD_NM
                     , OG_ID
                     , PRTNR_NO
                     , PRTNR_KNM
                     , PSTN_DV_CD_NM
                     , (SELECT COUNT(1)
                          FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ AC261
                    INNER JOIN TB_OGBS_PRTNR_BAS PBAS
                            ON PBAS.OG_TP_CD = 'W02'
                           AND PBAS.PRTNR_NO = AC261.CNFM_PSIC_PRTNR_NO
                    INNER JOIN TB_OGBS_MM_OG_IZ PORG
                            ON PORG.BASE_YM = #{mgtYnm}
                           AND PORG.OG_ID = PBAS.OG_ID
                           AND PORG.OG_TP_CD  = 'W02'
                           AND PORG.CLO_DT IS NULL
                           AND PORG.DTA_DL_YN = 'N'
                         WHERE ASN_OJ_YM = #{mgtYnm}
                           AND AC261.CNFM_PSIC_PRTNR_NO =  M1.PRTNR_NO
                           AND AC261.DTA_DL_YN = 'N'
                        ) LST_CNT
                     , (SELECT COUNT(1)
                          FROM TB_SVPD_MCBY_CST_SV_OJ_IZ AC201
                    INNER JOIN TB_OGBS_PRTNR_BAS PBAS
                            ON PBAS.OG_TP_CD = 'W02'
                           AND PBAS.PRTNR_NO = AC201.MNGT_PRTNR_NO
                    INNER JOIN TB_OGBS_MM_OG_IZ PORG
                            ON PORG.BASE_YM =  #{mgtYnm}
                           AND PORG.OG_ID = PBAS.OG_ID
                           AND PORG.OG_TP_CD  = 'W02'
                           AND PORG.CLO_DT IS NULL
                           AND PORG.DTA_DL_YN = 'N'
                         WHERE MNGT_YM = #{mgtYnm}
                           AND AC201.MNGT_PRTNR_NO = M1.PRTNR_NO
                           AND AC201.DTA_DL_YN = 'N'
                        ) MNG_CNT
                     , (SELECT COUNT(1)
                         FROM
                       (
                        SELECT VST_CNFMDT
                             , AC261.CNTR_NO
                          FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ AC261
                    INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ AC251
                            ON AC251.CST_SV_ASN_NO = AC261.CST_SV_ASN_NO
                    INNER JOIN TB_OGBS_PRTNR_BAS PBAS
                            ON PBAS.OG_TP_CD = 'W02'
                           AND PBAS.PRTNR_NO = AC261.CNFM_PSIC_PRTNR_NO
                    INNER JOIN TB_OGBS_MM_OG_IZ PORG
                            ON PORG.BASE_YM =  #{mgtYnm}
                           AND PORG.OG_ID = PBAS.OG_ID
                           AND PORG.OG_TP_CD  = 'W02'
                           AND PORG.CLO_DT IS NULL
                           AND PORG.DTA_DL_YN = 'N'
                    INNER JOIN TB_PDBS_PD_BAS P1
                           ON AC251.PDCT_PD_CD = P1.PD_CD
              LEFT OUTER JOIN TB_SVPD_RGBS_PU_ITM_IZ F1
                           ON AC261.CNTR_NO  = F1.CNTR_NO
                          AND F1.ASN_OJ_YM =  #{mgtYnm}
         LEFT OUTER JOIN TB_PDBS_PD_BAS F2
                   ON PU_PART_PD_CD = F2.PD_CD
                         WHERE AC261.ASN_OJ_YM = #{mgtYnm}
                           AND AC261.DTA_DL_YN = 'N'
                           AND AC261.CNFM_PSIC_PRTNR_NO =  M1.PRTNR_NO

                           AND VST_CNFMDT LIKE #{mgtYnm}||'%'
                           AND P1.DTA_DL_YN = 'N'
                           AND F2.DTA_DL_YN = 'N'
                      GROUP BY VST_CNFMDT
                            , AC261.CNTR_NO
                           )

                        ) VST_CNT
                    , (SELECT COUNT(1)
                          FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ AC261
                    INNER JOIN TB_OGBS_PRTNR_BAS PBAS
                            ON PBAS.OG_TP_CD = 'W02'
                           AND PBAS.PRTNR_NO = AC261.CNFM_PSIC_PRTNR_NO
                    INNER JOIN TB_OGBS_MM_OG_IZ PORG
                            ON PORG.BASE_YM =  #{mgtYnm}
                           AND PORG.OG_ID = PBAS.OG_ID
                           AND PORG.OG_TP_CD  = 'W02'
                           AND PORG.CLO_DT IS NULL
                           AND PORG.DTA_DL_YN = 'N'
                         WHERE ASN_OJ_YM = #{mgtYnm}
                           AND AC261.DTA_DL_YN = 'N'
                           AND VST_PRGS_STAT_CD = '20'
                           AND AC261.CNFM_PSIC_PRTNR_NO =  M1.PRTNR_NO
                           AND WK_EXCN_DT IS NOT NULL
                           AND WK_EXCN_DT LIKE #{mgtYnm}||'%'
                        ) WRK_CNT
                 FROM (
                         SELECT PBAS.OG_CD
                                , PBAS.OG_NM
                                , BLD_CD
                                , BLD_NM
                                , PBAS.OG_ID
                                , PBAS.PRTNR_NO
                                , PBAS.PRTNR_KNM
                                , (CASE WHEN PSTN_DV_CD = '15' THEN '매니저'
                                       WHEN PSTN_DV_CD = '10' THEN '지구장'
                                        WHEN PSTN_DV_CD = '7' THEN '지점장'
                                        WHEN PSTN_DV_CD = '4' THEN '사업단장'
                                        WHEN PSTN_DV_CD IN ('2','3') THEN '총괄단장'
                                        WHEN PSTN_DV_CD = '1' THEN '추진단장'
                                   ELSE ''
                                  END) AS PSTN_DV_CD_NM
                          FROM TB_OGBS_MM_OG_IZ PORG
                          INNER JOIN TB_OGBS_MM_PRTNR_IZ T1
                                  ON T1.BASE_YM = #{mgtYnm}
                                 AND T1.OG_TP_CD = 'W02'
                                 AND T1.BZ_STAT_CD = '1'
                                 AND T1.DTA_DL_YN = 'N'
                                 AND T1.OG_ID = PORG.OG_ID
                                 AND T1.BZ_STAT_CD = '1'
                           INNER JOIN TB_OGBS_PRTNR_BAS PBAS
                                  ON PBAS.OG_TP_CD = 'W02'
                                 AND PBAS.OG_ID = PORG.OG_ID
                               WHERE PORG.BASE_YM =  #{mgtYnm}
                                 AND PORG.OG_TP_CD  = 'W02'
                                 AND PORG.CLO_DT IS NULL
                                 AND PORG.DTA_DL_YN = 'N'
                           <if test='@MybatisUtils@isNotEmpty(mgtYnm)'>
                           AND PORG.DGR1_LEVL_OG_ID =  #{mgtYnm}
                           </if>
                           <if test='@MybatisUtils@isNotEmpty(rgnlGrp)'>
                           AND PORG.DGR2_LEVL_OG_ID=  #{rgnlGrp}
                           </if>
                           <if test='@MybatisUtils@isNotEmpty(branch)'>
                           AND PORG.DGR3_LEVL_OG_ID=  #{branch}
                           </if>
                           <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                           AND PBAS.PRTNR_NO=  #{prtnrNo}
                           </if>
                       ) M1
         )
    </select>

    <select id="selectBsServicePresentStateInfo" resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncBsServicePresentStateDto$SearchResInfo">
        SELECT MNG_CNT AS MNGT_ACC
             , VST_CNT AS VST_ACC
             , WRK_CNT AS FSH_ACC
             , (CASE WHEN VST_CNT > 0  THEN ROUND((WRK_CNT / VST_CNT) * 100, 1) ELSE 0 END) AS SVC_PROC
          FROM (
                SELECT (
                        SELECT COUNT(1)
                          FROM TB_SVPD_MCBY_CST_SV_OJ_IZ AC201
                         INNER JOIN TB_OGBS_PRTNR_BAS PBAS
                            ON PBAS.OG_TP_CD = 'W02'
                           AND PBAS.PRTNR_NO = AC201.MNGT_PRTNR_NO
                         INNER JOIN TB_OGBS_MM_PRTNR_IZ T1
                            ON T1.BASE_YM = SUBSTR(#{baseDateFrom},1, 6)
                           AND T1.OG_TP_CD = 'W02'
                           AND T1.BZ_STAT_CD = '1'
                           AND T1.DTA_DL_YN = 'N'
                           AND T1.PRTNR_NO = AC201.MNGT_PRTNR_NO
                           AND T1.BZ_STAT_CD = '1'
                         INNER JOIN TB_OGBS_MM_OG_IZ PORG
                            ON PORG.BASE_YM =  SUBSTR(#{baseDateFrom},1, 6)
                           AND PORG.OG_ID = PBAS.OG_ID
                           AND PORG.OG_TP_CD  = 'W02'
                           AND PORG.CLO_DT IS NULL
                           AND PORG.DTA_DL_YN = 'N'
                         WHERE MNGT_YM = SUBSTR(#{baseDateFrom},1, 6)
        <if test='@MybatisUtils@isNotEmpty(mgtDept)'>
                           AND PORG.DGR1_LEVL_OG_ID =  #{mgtDept}
        </if>
        <if test='@MybatisUtils@isNotEmpty(rgnlGrp)'>
                           AND PORG.DGR2_LEVL_OG_ID=  #{rgnlGrp}
        </if>
        <if test='@MybatisUtils@isNotEmpty(branch)'>
                           AND PORG.DGR3_LEVL_OG_ID=  #{branch}
        </if>
        <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                           AND AC201.MNGT_PRTNR_NO =  #{prtnrNo}
        </if>
                           AND AC201.DTA_DL_YN = 'N'
                       ) MNG_CNT
                     , (
                        SELECT COUNT(1)
                          FROM (
                                SELECT VST_CNFMDT
                                     , AC261.CNTR_NO
                                  FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ AC261
                                 INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ AC251
                                    ON AC251.CST_SV_ASN_NO = AC261.CST_SV_ASN_NO
                                 INNER JOIN TB_OGBS_PRTNR_BAS PBAS
                                    ON PBAS.OG_TP_CD = 'W02'
                                   AND PBAS.PRTNR_NO = AC261.CNFM_PSIC_PRTNR_NO
                                 INNER JOIN TB_OGBS_MM_PRTNR_IZ T1
                                    ON T1.BASE_YM = SUBSTR(#{baseDateFrom},1, 6)
                                   AND T1.OG_TP_CD = 'W02'
                                   AND T1.BZ_STAT_CD = '1'
                                   AND T1.DTA_DL_YN = 'N'
                                   AND T1.PRTNR_NO = AC261.CNFM_PSIC_PRTNR_NO
                                   AND T1.BZ_STAT_CD = '1'
                                 INNER JOIN TB_OGBS_MM_OG_IZ PORG
                                    ON PORG.BASE_YM =  SUBSTR(#{baseDateFrom},1, 6)
                                   AND PORG.OG_ID = PBAS.OG_ID
                                   AND PORG.OG_TP_CD  = 'W02'
                                   AND PORG.CLO_DT IS NULL
                                   AND PORG.DTA_DL_YN = 'N'
                                 INNER JOIN TB_PDBS_PD_BAS P1
                                    ON AC251.PDCT_PD_CD = P1.PD_CD
                            LEFT OUTER JOIN TB_SVPD_RGBS_PU_ITM_IZ F1
                                    ON AC261.CNTR_NO  = F1.CNTR_NO
                                   AND F1.ASN_OJ_YM =  SUBSTR(#{baseDateFrom},1, 6)
                            LEFT OUTER JOIN TB_PDBS_PD_BAS F2
                                    ON PU_PART_PD_CD = F2.PD_CD
                                 WHERE AC261.ASN_OJ_YM = SUBSTR(#{baseDateFrom},1, 6)
                                   AND AC261.DTA_DL_YN = 'N'
        <if test='@MybatisUtils@isNotEmpty(mgtDept)'>
                                   AND PORG.DGR1_LEVL_OG_ID =  #{mgtDept}
        </if>
	    <if test='@MybatisUtils@isNotEmpty(rgnlGrp)'>
                                   AND PORG.DGR2_LEVL_OG_ID=  #{rgnlGrp}
	    </if>
	    <if test='@MybatisUtils@isNotEmpty(branch)'>
                                   AND PORG.DGR3_LEVL_OG_ID=  #{branch}
	    </if>
	    <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                                   AND AC261.CNFM_PSIC_PRTNR_NO =  #{prtnrNo}
	    </if>
                                   AND VST_CNFMDT BETWEEN #{baseDateFrom} AND #{baseDateTo}
                                   AND P1.DTA_DL_YN = 'N'
                                   AND F2.DTA_DL_YN = 'N'
                                 GROUP BY VST_CNFMDT
                                     , AC261.CNTR_NO
                            )
                       ) VST_CNT
                     , (
                        SELECT COUNT(1)
                          FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ AC261
                         INNER JOIN TB_OGBS_PRTNR_BAS PBAS
                            ON PBAS.OG_TP_CD = 'W02'
                           AND PBAS.PRTNR_NO = AC261.CNFM_PSIC_PRTNR_NO
                         INNER JOIN TB_OGBS_MM_PRTNR_IZ T1
                            ON T1.BASE_YM = SUBSTR(#{baseDateFrom},1, 6)
                           AND T1.OG_TP_CD = 'W02'
                           AND T1.BZ_STAT_CD = '1'
                           AND T1.DTA_DL_YN = 'N'
                           AND T1.PRTNR_NO = AC261.CNFM_PSIC_PRTNR_NO
                           AND T1.BZ_STAT_CD = '1'
                         INNER JOIN TB_OGBS_MM_OG_IZ PORG
                            ON PORG.BASE_YM =  #{baseDateFrom}
                           AND PORG.OG_ID = PBAS.OG_ID
                           AND PORG.OG_TP_CD  = 'W02'
                           AND PORG.CLO_DT IS NULL
                           AND PORG.DTA_DL_YN = 'N'
                         WHERE ASN_OJ_YM = SUBSTR(#{baseDateFrom},1, 6)
                           AND AC261.DTA_DL_YN = 'N'
                           AND VST_PRGS_STAT_CD = '20'
        <if test='@MybatisUtils@isNotEmpty(mgtDept)'>
                           AND PORG.DGR1_LEVL_OG_ID =  #{mgtDept}
        </if>
	    <if test='@MybatisUtils@isNotEmpty(rgnlGrp)'>
                           AND PORG.DGR2_LEVL_OG_ID=  #{rgnlGrp}
        </if>
        <if test='@MybatisUtils@isNotEmpty(branch)'>
                           AND PORG.DGR3_LEVL_OG_ID=  #{branch}
        </if>
        <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
                           AND AC261.CNFM_PSIC_PRTNR_NO =  #{prtnrNo}
        </if>
                           AND WK_EXCN_DT IS NOT NULL
                           AND WK_EXCN_DT BETWEEN #{baseDateFrom} AND #{baseDateTo}
                       ) WRK_CNT
                  FROM DUAL
       )
    </select>
</mapper>
