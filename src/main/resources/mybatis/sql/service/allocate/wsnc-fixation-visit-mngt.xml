<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncFixationVisitMapper">
    <select id="selectFixationVisits"
            resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncFixationVisitDto$SearchFixationVisitRes">
        SELECT TB.*
          FROM (
            SELECT TB_1.CNTR_NO                     AS CNTR_NO              /* 계약번호 */
                 , TB_1.CNTR_SN                     AS CNTR_SN              /* 계약일련번호 */
                 , TB_1.CH_SN                       AS CH_SN                /* 변경일련번호 */
                 , TB_3.RCGVP_KNM                   AS RCGVP_KNM            /* 수령자한글명 */
                 , TB_4.NEW_ADR_ZIP                 AS NEW_ADR_ZIP          /* 신주소우편번호 */
                 , TB_4.RNADR                       AS RNADR                /* 도로명주소 */
                 , TB_4.RDADR                       AS RDADR                /* 도로명상세주소 */
                 , TB_3.CRAL_LOCARA_TNO             AS CRAL_LOCARA_TNO      /* 휴대지역전화번호 */
                 , TB_3.CRAL_IDV_TNO                AS CRAL_IDV_TNO         /* 휴대개별전화번호 */
                 , TB_3.LOCARA_TNO                  AS LOCARA_TNO           /* 지역전화번호 */
                 , TB_3.IDV_TNO                     AS IDV_TNO              /* 개별전화번호 */
                 , TB_2.SELL_TP_CD                  AS SELL_TP_CD           /* 판매유형코드 */
                 , TB_1.FXN_PRTNR_DV_CD             AS FXN_PRTNR_DV_CD      /* 고정파트너구분코드 */
                 , TB_1.FXN_PRTNR_NO                AS FXN_PRTNR_NO         /* 고정파트너번호 */
                 , TB_1.APY_STRT_YM                 AS APY_STRT_YM          /* 적용시작년월 */
                 , TB_1.CH_RSON_CN                  AS CH_RSON_CN           /* 변경사유내용 */
                 , TB_1.FNL_MDFC_DTM                AS FNL_MDFC_DTM         /* 최종수정일시 */
                 , TB_1.FNL_MDFC_USR_ID             AS FNL_MDFC_USR_ID      /* 최종수정사용자ID */
                 , RANK() OVER(PARTITION BY TB_1.CNTR_NO, TB_1.CNTR_SN ORDER BY TB_1.CH_SN DESC NULLS LAST) AS RNK
              FROM TB_SVPD_CNTR_FXN_PRTNR_IZ TB_1
                 , TB_SSCT_CNTR_DTL TB_2
                 , TB_SSCT_CNTR_ADRPC_BAS TB_3
                 , TB_GBCO_ADR_BAS TB_4
             WHERE 1=1
               AND TB_1.CNTR_NO = TB_2.CNTR_NO
               AND TB_1.CNTR_SN = TB_2.CNTR_SN
               AND TB_1.CNTR_NO = TB_3.CNTR_NO
               AND TB_3.ADR_ID = TB_4.ADR_ID
            <if test='@MybatisUtils@isNotEmpty(fxnPrtnrDvCd)'>
                AND TB_1.FXN_PRTNR_DV_CD = #{fxnPrtnrDvCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(sellTpCd)'>
                AND TB_2.SELL_TP_CD = #{sellTpCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(fxnPrtnrNo)'>
                AND TB_1.FXN_PRTNR_NO = #{fxnPrtnrNo}
            </if>
             ) TB
         WHERE 1=1
           AND RNK = 1
    </select>

    <select id="selectFixationVisit"
            resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncFixationVisitDto$SearchFixationVisitRes">
        WITH REL_KEY AS (
            SELECT TEMP.CNTR_ADR_REL_ID
              FROM TB_SSCT_CNTR_ADR_REL TEMP
             WHERE 1=1
               AND TEMP.DTL_CNTR_NO = #{cntrNo}
               AND TEMP.DTL_CNTR_SN = #{cntrSn}
               AND ROWNUM = 1
        )
        SELECT TB.CNTR_NO AS CNTR_NO                  /* 계약번호 */
             , TB.CNTR_SN AS CNTR_SN                  /* 계약일련번호 */
             , TB.CH_SN AS CH_SN                      /* 변경일련번호 */
             , TB.CST_KNM                             /* 계약정보-고객명 */
             , TB.CRAL_LOCARA_TNO                     /* 계약정보-휴대지역전화번호 */
             , TB.MEXNO_ENCR /* 복호화 */               /* 계약정보-휴대전화국번호암호화 */
             , TB.CRAL_IDV_TNO                        /* 계약정보-휴대개별전화번호 */
             , TB.RNADR                               /* 계약정보-도로명주소 */
             , TB.RDADR                               /* 계약정보-도로명상세주소 */
             , TB.RCGVP_KNM                           /* 설치정보-고객명 */
             , TB.CRAL_LOCARA_TNO_INSTALL             /* 설치정보-휴대지역전화번호 */
             , TB.MEXNO_ENCR_INSTALL /* 복호화 */       /* 설치정보-휴대전화국번호암호화 */
             , TB.CRAL_IDV_TNO_INSTALL                /* 설치정보-휴대개별전화번호 */
             , TB.RNADR_INSTALL AS RNADR_INSTALL      /* 설치정보-도로명주소 */
             , TB.RDADR_INSTALL AS RDADR_INSTALL      /* 설치정보-도로명상세주소 */
             , TB.PD_NM                               /* 상품정보-상품 */
             , TB.PD_PRP_VAL01                        /* 상품정보-용도 */
             , TB.APY_STRT_YM                         /* 적용기간 */
             , TB.CH_RQR_DV_CD                        /* 변경구분 */
             , TB.FNL_MDFC_DTM                        /* 변경등록일자 */
             , TB.FXN_PRTNR_DV_CD                     /* 지정대상 */
             , TB.FXN_PRTNR_NO                        /* 방문담당 */
             , TB.CH_RSON_CN                          /* 변경사유 */
             , TB.DTA_DL_YN                           /* 삭제여부 */
             , (
                SELECT TEMP.PRTNR_KNM
                  FROM TB_OGBS_PRTNR_BAS TEMP
                 WHERE 1=1
                   AND TEMP.PRTNR_NO = (
                                        SELECT SUB_TEMP.FXN_PRTNR_NO
                                          FROM TB_SVPD_CNTR_FXN_PRTNR_IZ SUB_TEMP
                                         WHERE 1=1
                                           AND SUB_TEMP.CNTR_NO = TB.CNTR_NO
                                           AND SUB_TEMP.CNTR_SN = TB.CNTR_SN
                                           AND SUB_TEMP.CH_SN = (TB.CH_SN - 1)
                                        )
               ) AS PRTNR_KNM                         /* 기존담당-담당자 */
             , (
                SELECT TEMP.RSGN_DT
                  FROM TB_OGBS_PRTNR_DTL TEMP
                 WHERE 1=1
                   AND TEMP.PRTNR_NO = (
                                        SELECT SUB_TEMP.FXN_PRTNR_NO
                                          FROM TB_SVPD_CNTR_FXN_PRTNR_IZ SUB_TEMP
                                         WHERE 1=1
                                           AND SUB_TEMP.CNTR_NO = TB.CNTR_NO
                                           AND SUB_TEMP.CNTR_SN = TB.CNTR_SN
                                           AND SUB_TEMP.CH_SN = (TB.CH_SN - 1)
                                        )
               ) AS RSGN_DT                           /* 기존담당-활동중지일 */
          FROM (
                SELECT TB_1.CNTR_NO AS CNTR_NO
                     , TB_1.CNTR_SN AS CNTR_SN
                     , TB_9.CH_SN AS CH_SN
                     , TB_3.CST_KNM
                     , TB_3.CRAL_LOCARA_TNO
                     , TB_3.MEXNO_ENCR /* 복호화 */
                     , TB_3.CRAL_IDV_TNO
                     , TB_4.RNADR
                     , TB_4.RDADR
                     , TB_5.RCGVP_KNM
                     , TB_5.CRAL_LOCARA_TNO AS CRAL_LOCARA_TNO_INSTALL
                     , TB_5.MEXNO_ENCR AS MEXNO_ENCR_INSTALL /* 복호화 */
                     , TB_5.CRAL_IDV_TNO AS CRAL_IDV_TNO_INSTALL
                     , TB_10.RNADR AS RNADR_INSTALL
                     , TB_10.RDADR AS RDADR_INSTALL
                     , TB_7.PD_NM
                     , TB_8.PD_PRP_VAL01
                     , (
                        SELECT TEMP_2.CD_CNTN
                          FROM T_CMZ_CD_M TEMP_1
                             , T_CMZ_CD_D TEMP_2
                         WHERE 1=1
                           AND TEMP_1.TENANT_ID = TEMP_2.TENANT_ID
                           AND TEMP_1.CD_ID = TEMP_2.CD_ID
                           AND TEMP_1.TENANT_ID = 'TNT_WELLS'
                           AND TEMP_1.CD_ID = 'PD_USWY_CD'
                           AND TEMP_2.CD_VLD_VAL = TB_8.PD_PRP_VAL01
                       ) AS PD_PRP_VAL01_NM
                     , TB_9.APY_STRT_YM
                     , TB_9.CH_RQR_DV_CD
                     , TB_9.FNL_MDFC_DTM
                     , TB_9.FXN_PRTNR_DV_CD
                     , TB_9.FXN_PRTNR_NO
                     , TB_9.CH_RSON_CN
                     , TB_9.DTA_DL_YN
                     , RANK() OVER(PARTITION BY TB_9.CNTR_NO, TB_9.CNTR_SN ORDER BY TB_9.CH_SN DESC NULLS LAST) AS RNK
                  FROM TB_SSCT_CNTR_DTL TB_1
                     , TB_SSCT_CNTR_BAS TB_2
                     , TB_CUBS_CST_BAS TB_3
                     , TB_GBCO_ADR_BAS TB_4 /* 계약자주소 */
                     , TB_SSCT_CNTR_ADRPC_BAS TB_5
                     , TB_SSCT_CNTR_ADR_REL TB_6
                     , TB_PDBS_PD_BAS TB_7
                     , TB_PDBS_PD_ECOM_PRP_DTL TB_8
                     , TB_SVPD_CNTR_FXN_PRTNR_IZ TB_9
                     , TB_GBCO_ADR_BAS TB_10 /* 설치자주소 */
                     , REL_KEY REL_KEY
                 WHERE 1=1
                   AND TB_2.CNTR_CST_NO = TB_3.CST_NO
                   AND TB_3.ADR_ID = TB_4.ADR_ID
                   AND TB_1.CNTR_NO = #{cntrNo}
                   AND TB_1.CNTR_SN = #{cntrSn}
                   AND TB_1.CNTR_NO = TB_2.CNTR_NO
                   AND TB_2.CNTR_CST_NO = TB_3.CST_NO
                   AND TB_5.CNTR_ADRPC_ID = TB_6.CNTR_ADRPC_ID
                   AND TB_6.CNTR_ADR_REL_ID = REL_KEY.CNTR_ADR_REL_ID
                   AND TB_6.ADRPC_TP_CD = '3' /* 2:배송지 3:설치지 */
                   AND TB_1.BASE_PD_CD = TB_7.PD_CD
                   AND TB_8.PD_CD = TB_1.BASE_PD_CD
                   AND TB_8.PD_EXTS_PRP_GRP_CD = 'PDCT' /* SCHD(일정관리), CMN(공통), PDCT(상품) */
                   AND TB_9.CNTR_NO(+) = #{cntrNo}
                   AND TB_9.CNTR_SN(+) = #{cntrSn}
                   AND TB_9.DTA_DL_YN(+) = 'N'
                   AND TB_5.ADR_ID = TB_10.ADR_ID
             ) TB
         WHERE 1=1
           AND RNK = 1
    </select>

    <update id="updateFixationVisit">
        UPDATE TB_SVPD_CNTR_FXN_PRTNR_IZ
           SET DTA_DL_YN               = 'Y'
               <include refid="COMMON.updateSystemField"/>
         WHERE 1=1
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </update>

    <insert id="insertFixationVisit">
        INSERT INTO TB_SVPD_CNTR_FXN_PRTNR_IZ (
              CNTR_NO
            , CNTR_SN
            , CH_SN
            , FXN_PRTNR_DV_CD
            , FXN_PRTNR_NO
            , CH_RQR_DV_CD
            , CH_RSON_CN
            , APY_STRT_YM
            , DTA_DL_YN
              <include refid="COMMON.insertSystemField"/>
        ) VALUES (
              #{cntrNo}
            , #{cntrSn}
            , (
               SELECT NVL(MAX(TEMP.CH_SN) + 1, 1) AS CH_SN
                 FROM TB_SVPD_CNTR_FXN_PRTNR_IZ TEMP
                WHERE 1=1
                  AND TEMP.CNTR_NO = #{cntrNo}
                  AND TEMP.CNTR_SN = #{cntrSn}
              )
            , #{fxnPrtnrDvCd}
            , #{fxnPrtnrNo}
            , #{chRqrDvCd}
            , #{chRsonCn}
            , #{apyStrtYm}
            , 'N'
              <include refid="COMMON.insertSystemFieldValue"/>
        )
    </insert>
</mapper>
