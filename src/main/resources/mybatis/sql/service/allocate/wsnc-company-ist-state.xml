<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncCompanyIstStateMapper">
    <select id="selectCompanyIstStateAll"
            resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncCompanyIstStateDto$SearchAllRes">
        WITH PROD AS (SELECT P3.BASE_PD_CD    -- 상품코드
                           , (SELECT PD_NM FROM TB_PDBS_PD_BAS A WHERE A.PD_CD = P3.BASE_PD_CD) AS BASE_PD_NM
                           , P1.PD_CD         -- 부품코드
                           , P1.PD_NM         -- 부품명
                           , P1.SAP_MAT_CD    --SAP 자재코드
                           , P1.PDCT_UPRC     -- 제품단가
                           , P3.CSMR_UPRC_AMT -- 소비자단가
                      FROM TB_PDBS_PD_BAS P1 /* 상품기본 */
                               INNER JOIN TB_SVPD_RCAS_ITM_PRC_IZ P3 /* 유상AS품목가격내역 */
                                          ON P1.PD_CD = P3.USE_MAT_PD_CD)
           , SVC AS (SELECT T2.CST_SV_ASN_NO     -- 고객서비스배정번호
                          , T2.ASN_OJ_YM         -- 배정대상년월
                          , T2.CNTR_NO           -- 계약번호
                          , T2.CNTR_SN           -- 계약일련번호
                          , T2.SV_BIZ_MCLSF_CD   --서비스업무중분류
                          , T2.SV_BIZ_DCLSF_CD   --서비스업무세분류
                          , T1.USE_QTY           -- 사용수량
                          , T2.PRTNR_CLSF_CD     --파트너유형
                          , T2.PRTNR_NO          -- 파트너번호
                          , T2.PRTNR_KNM         -- 파트너한글명
                          , T2.OG_NM             -- 조직명
                          , T1.ITM_PD_CD         -- 품목상품코드
                          , T2.ADR               -- 고객상세주소
                          , T1.BFSVC_REFRI_DV_CD -- 유무상
                          , T2.COPN_DV_CD        -- 법인격구분코드
                          , T2.CUST_NM           --고객명
                     FROM TB_SVST_SV_WK_OSTR_IZ T1
                              INNER JOIN (SELECT E1.CST_SV_ASN_NO
                                               , E1.ASN_OJ_YM       -- 배정대상년월
                                               , E1.CNTR_NO         -- 계약번호
                                               , E1.CNTR_SN         -- 계약일련번호
                                               , E1.SV_BIZ_MCLSF_CD --서비스업무중분류
                                               , E1.SV_BIZ_DCLSF_CD --서비스업무세분류
                                               , M1.PRTNR_CLSF_CD   --파트너유형
                                               , M1.PRTNR_NO        -- 파트너번호
                                               , M1.PRTNR_KNM       -- 파트너한글명
                                               , M1.OG_CD           -- 조직코드
                                               , M1.OG_NM           -- 조직명
                                               , E2.ADR             -- 고객주소상세
                                               , B1.COPN_DV_CD      -- 법인격구분코드
                                               , E2.CUST_NM         -- 고객명
--                                           , (SELECT CSCN_CD
--                                              FROM TB_OGBS_DEPT_BAS M2
--                                              WHERE M2.DEPT_CD = M1.
--                                                       INNER JOIN M1
                                               --                                              ON M2.DEPT_CD = M1.OG_CD) CSCN_CD -- 코스트코드
                                          FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ E1 /* 고객서비스BS배정내역 */
                                                   INNER JOIN (SELECT A1.DTL_CNTR_NO
                                                                    , A1.DTL_CNTR_SN
                                                                    , TRIM(A2.RCGVP_KNM)          AS CUST_NM
                                                                    , A2.ADR_ID
                                                                    , A2.LOCARA_TNO
                                                                    , A2.EXNO_ENCR
                                                                    , A2.IDV_TNO
                                                                    , A2.CRAL_LOCARA_TNO
                                                                    , A2.MEXNO_ENCR
                                                                    , A2.CRAL_IDV_TNO
                                                                    , B2.RNADR || ' ' || B2.RDADR AS ADR
                                                               FROM TB_SSCT_CNTR_ADR_REL A1
                                                                        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS A2
                                                                                   ON A2.CNTR_ADRPC_ID =
                                                                                      A1.CNTR_ADRPC_ID
                                                                                       AND A2.DTA_DL_YN = 'N'
                                                                        INNER JOIN TB_GBCO_ADR_BAS B2
                                                                                   ON A2.ADR_ID = B2.ADR_ID
                                                                                       AND A2.DTA_DL_YN = 'N'
                                                               WHERE 1 = 1
                                                                 AND A1.DTA_DL_YN = 'N'
                                                                 AND A1.ADRPC_TP_CD = '3' /* 설치처 */
                                                                 AND A1.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                                                                 AND A1.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')) E2
                                                              ON E1.CNTR_NO = E2.DTL_CNTR_NO
                                                                  AND E1.CNTR_SN = E2.DTL_CNTR_SN
                                                   INNER JOIN TB_SSCT_CNTR_BAS B1
                                                              ON B1.CNTR_NO = E1.CNTR_NO
                                                   LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ M1 /* 월파트너내역 */
                                                                   ON M1.BASE_YM = E1.ASN_OJ_YM
                                                                       AND M1.OG_TP_CD = E1.CNFM_PSIC_PRTNR_OG_TP_CD
                                                                       AND M1.PRTNR_NO = E1.CNFM_PSIC_PRTNR_NO
                                          WHERE E1.ASN_OJ_YM = #{mgtYnm}) T2 ON T1.CNTR_NO = T2.CNTR_NO
                         AND T1.CNTR_SN = T2.CNTR_SN
                         AND T1.ICHR_PRTNR_NO = T2.PRTNR_NO
                         AND T1.CST_SV_ASN_NO = T2.CST_SV_ASN_NO)
        SELECT SVC.CNTR_NO || '-' || SVC.CNTR_SN AS CNTR_NO
             , ''                                AS DEPT_CD
             , ''                                AS DEPT_NM1
             , ''                                AS CSNR_CD
             , ''                                AS OG_NM
             , SVC.CUST_NM
             , SVC.COPN_DV_CD                    AS COPN_DV_CD
             , PROD.BASE_PD_CD                   AS PD_CD
             , PROD.BASE_PD_NM                   AS PD_NM
             , SVC.SV_BIZ_MCLSF_CD
             , SVC.SV_BIZ_DCLSF_CD
             , PROD.SAP_MAT_CD
             , PROD.PD_CD                        AS PART_PD_CD
             , PROD.PD_NM                        AS PART_PD_NM
             , SVC.USE_QTY
             , PROD.PDCT_UPRC
             , PROD.PDCT_UPRC * SVC.USE_QTY      AS PDCT_UPRC_SUM     -- 원가합계
             , PROD.CSMR_UPRC_AMT
             , PROD.CSMR_UPRC_AMT * SVC.USE_QTY  AS CSMR_UPRC_AMT_SUM --소비자합계
             , SVC.BFSVC_REFRI_DV_CD             AS REFRI_DV_CD
             , SVC.PRTNR_CLSF_CD                 AS WRK_PRTNR_CLSF_CD
             , SVC.PRTNR_NO                      AS WRK_PRTNR_NO
             , SVC.PRTNR_KNM                     AS WRK_PRTNR_KNM
             , SVC.OG_NM                         AS WRK_OG_NM
             , SVC.ADR                           AS CST_ADR
        FROM PROD
                 INNER JOIN SVC
                            ON PROD.PD_CD = SVC.ITM_PD_CD
    </select>
    <select id="selectCompanyIstStatePs"
            resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncCompanyIstStateDto$SearchPsRes">
        WITH INQRY_LIST AS ( SELECT (CASE WHEN V1.SVC_TP_CD ='3' AND V1.BASE_DTL_CNTR_NO IS NOT NULL THEN V1.BASE_DTL_CNTR_NO
                                          ELSE V1.CNTR_NO
                                     END) AS CNTR_NO
                                  , (CASE WHEN V1.SVC_TP_CD ='3' AND V1.BASE_DTL_CNTR_SN IS NOT NULL THEN V1.BASE_DTL_CNTR_SN
                                          ELSE V1.CNTR_SN
                                     END) AS CNTR_SN
                                  , V1.SVC_TP_CD
                                  , V1.IST_DT
                              FROM ( SELECT T1.CNTR_NO
                                          , T1.CNTR_SN
                                          , T1.SELL_TP_CD
                                          , T1.CNTR_DTL_STAT_CD
                                          /* SELL_TP_CD 판매유형코드 : 1 일시불, 2 렌탈/리스, 3 멤버십, 4 회사설치, 5 유지관리, 6 정기배송, 9 필터 */
                                          /* CNTR_DTL_STAT_CD 계약상세상태코드 : 101 정상, 201 고객요청정지, 202 연체정지, 203 해약접수정지, 301 고객요청해약, 302 연체해약, 303 계약취소, 401 최종종료, 402 계약기간종료 */
                                          , (CASE WHEN T1.SELL_TP_CD IN ('1', '2', '4') AND T1.CNTR_DTL_STAT_CD = '401' AND T3.BASE_DTL_CNTR_NO IS NULL THEN '9'
                                                  WHEN T3.BASE_DTL_CNTR_NO IS NOT NULL THEN '3'
                                                  ELSE T1.SELL_TP_CD
                                             END) AS SVC_TP_CD /* 서비스상태코드(AS-IS AC201_SALE_TP) - 현업이랑 협의하여 기준점을 잡아야 함 */
                                          , T3.BASE_DTL_CNTR_NO /* 멤버십계약번호 */
                                          , T3.BASE_DTL_CNTR_SN /* 멤버십계약일련번호 */
                                          , NVL(T2.IST_DT, T1.CNTR_PD_STRTDT) AS IST_DT
                                      FROM WSMDBS.TB_SSCT_CNTR_DTL T1 /* 계약상세 */
                           LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_WELLS_DTL T2 /* 계약WELLS상세 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서 */
                                        ON T1.CNTR_NO = T2.CNTR_NO
                                       AND T1.CNTR_SN = T2.CNTR_SN
                                       AND T2.DTA_DL_YN = 'N'
                           LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_REL T3 /* 계약관계 */
                                        ON T3.OJ_DTL_CNTR_NO = T1.CNTR_NO /* 멤버십이외원코드 */
                                       AND T3.OJ_DTL_CNTR_SN = T1.CNTR_SN
                                       AND T3.CNTR_REL_DTL_CD = '212' /* 계약관계상세코드 : 108 무료체험교체, 211 필터 - 정수기, 212 멤버십 - 원주문, 213 정수기 - 부가서비스, 214 정기배송 - 원주문, 215 1+1연계, 216 모종결합, 217 소개추천, 218 에어컨결합, 219 홈케어, 221 홈케어멤버십, 22L 플래너상조제휴, 22M 다건, 22P 패키지(대수할인), 22W 패키지상품 */
                                       AND T3.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') /* 유효시작일시 */
                                       AND T3.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') /* 유효종료일시 */
                                       AND T3.DTA_DL_YN = 'N'
                           LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_RSG_PROCS_IZ T4  /*계약해지처리내역*/
                                        ON T1.CNTR_NO = T4.CNTR_NO
                                       AND T1.CNTR_SN  = T4.CNTR_SN
                                       AND T4.DTA_DL_YN = 'N'
                                     WHERE 1=1
                                       /* AND T1.SELL_TP_CD = '2' */
                                       AND T1.DTA_DL_YN = 'N'
                                       AND T4.RSG_FSH_DT IS NULL
                                       /* 설치일자 조회 조건이 있을 경우 */
                                       <if test="@MybatisUtils@isNotEmpty(istDtFrom)">
                                       AND NVL(T2.IST_DT, T1.CNTR_PD_STRTDT) BETWEEN #{istDtFrom} AND #{istDtTo}
                                       </if>
                              ) V1
                              <if test="@MybatisUtils@isNotEmpty(mgtTyps)">
                              WHERE V1.SVC_TP_CD IN (<foreach collection="mgtTyps" item="mgtTyp" separator=", ">#{mgtTyp}</foreach>)
                              </if>
        )
        , CNTR_INF AS ( SELECT T1.CNTR_NO
                             , T1.CNTR_SN
                             , T1.BASE_PD_CD       /*기준상품코드*/
                             , T7.OJ_PD_CD AS PDCT_PD_CD   /*제품상품코드*/
                             , T8.OJ_PD_CD AS SV_PD_CD     /*서비스 상품코드*/
                             , T9.IST_DT
                             , T1.SELL_TP_CD       /*판매유형코드 : 1 일시불, 2 렌탈/리스, 3 멤버십, 4 회사설치, 5 유지관리, 6 정기배송, 9 필터*/
                             , T1.SELL_TP_DTL_CD   /*판매유형상세코드 : 11 일반, 12 홈케어, 13 환경가전, 21 일반렌탈, 22 리스, 23 공유렌탈, 24 환경리스, 25 장기할부, 26 환경할부, 31 일시불 멤버십, 32 렌탈 멤버십, 33 홈케어 멤버십, 34 회사설치, 61 일반, 62 모종, 63 캡슐*/
                             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T1.SELL_TP_CD, 'ko') AS SELL_TP_NM
                             , T1.CNTR_DTL_STAT_CD /*계약상세상태코드 : 101 정상, 201 고객요청정지, 202 연체정지, 203 해약접수정지, 301 고객요청해약, 302 연체해약, 303 계약취소, 401 최종종료, 402 계약기간종료*/
                             , F_CMZ_CD_NM('TNT_WELLS', 'CNTR_DTL_STAT_CD', T1.CNTR_DTL_STAT_CD, 'ko') AS CNTR_DTL_STAT_NM
                             , T2.CNTR_RCP_FSH_DTM /*계약접수완료일시*/
                             , T1.CNTR_PD_STRTDT   /*계약상품시작일자 - AS_IS 매출일자*/
                             , T4.RCGVP_KNM        /*수령자한글명*/
                             , T5.NEW_ADR_ZIP      /*신주소우편번호*/
                             , T5.RNADR            /*도로명주소*/
                             , T5.RDADR            /*도로명상세주소*/
                             , T4.ADR_DV_CD        /*주소구분코드 : 1 도로명, 2 지번*/
                             , T4.ADR_ID           /*주소ID*/
                             , T4.CRAL_LOCARA_TNO  /*휴대지역전화번호*/
                             , T4.MEXNO_ENCR       /*휴대전화국번호암호화*/
                             , T4.CRAL_IDV_TNO     /*휴대개별전화번호*/
                             , T4.LOCARA_TNO       /*지역전화번호*/
                             , T4.EXNO_ENCR        /*전화국번호암호화*/
                             , T4.IDV_TNO          /*개별전화번호*/
                             , T6.RSG_APLC_DT      /*해지신청일자*/
                             , T6.RSG_FSH_DT       /*해지완료일자*/
                             , T9.FRISU_BFSVC_PTRM_N   /*무상BS기간수*/
                             , T9.FRISU_AS_PTRM_N      /*무상AS기간수*/
                             , T10.OG_TP_CD        /*조직유형코드*/
                             , T10.PRTNR_NO        /*파트너번호 CNTR_PRTNR_REL_ID = '010' 판매자*/
                             , T10.OG_ID           /*조직ID*/
                             , T3.ADRPC_TP_CD      /*계약주소지ID : 1 계약주소, 2 배달주소, 3 설치주소*/
                             , DENSE_RANK() OVER(PARTITION BY T3.DTL_CNTR_NO, T3.DTL_CNTR_SN ORDER BY T3.ADRPC_TP_CD DESC) AS ADRPC_TP_CD_RN
                          FROM WSMDBS.TB_SSCT_CNTR_DTL T1  /*계약상세*/
                    INNER JOIN WSMDBS.TB_SSCT_CNTR_BAS T2  /*계약기본*/
                            ON T1.CNTR_NO = T2.CNTR_NO
                           AND T2.DTA_DL_YN = 'N'
                    INNER JOIN WSMDBS.TB_SSCT_CNTR_ADR_REL T3 /*계약주소관계*/
                            ON T1.CNTR_NO = T3.DTL_CNTR_NO
                           AND T1.CNTR_SN = T3.DTL_CNTR_SN
                           /* AND T3.ADRPC_TP_CD = '3' */ /*1 계약주소, 2 배달주소, 3 설치주소*/
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T3.VL_STRT_DTM AND T3.VL_END_DTM
                           AND T3.DTA_DL_YN = 'N'
                    INNER JOIN WSMDBS.TB_SSCT_CNTR_ADRPC_BAS T4 /*계약주소지기본*/
                            ON T3.CNTR_ADRPC_ID = T4.CNTR_ADRPC_ID  /*계약주소지ID*/
                           AND T4.DTA_DL_YN = 'N'
               LEFT OUTER JOIN GBSDBS.TB_GBCO_ADR_BAS T5
                            ON T4.ADR_ID = T5.ADR_ID   /*이해욱이사님,이진성프로님과 협의 설치, AS는 배정시에 주소를 사용 해야 하기 때문에 TB_SVPD_CST_SVAS_IST_OJ_IZ 에 ADR_ID 를 추가 하기로 함. 테이블이 변경 되면, T4.ADR_ID 를 T1.ADR_ID 으로 수정 해야 함*/
                           AND T5.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_RSG_PROCS_IZ T6  /*계약해지처리내역*/
                            ON T1.CNTR_NO = T6.CNTR_NO
                           AND T1.CNTR_SN = T6.CNTR_SN
                           AND T6.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_PD_REL T7      /*계약상품관계 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서*/
                            ON T1.CNTR_NO = T7.CNTR_NO
                           AND T1.CNTR_SN = T7.CNTR_SN
                           AND T1.BASE_PD_CD = T7.BASE_PD_CD
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T7.VL_STRT_DTM AND T7.VL_END_DTM
                           AND T7.PD_REL_TP_CD IN ('05')   /*05 기준-제품*/
                           AND T7.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_PD_REL T8      /*계약상품관계 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서*/
                            ON T1.CNTR_NO = T8.CNTR_NO
                           AND T1.CNTR_SN = T8.CNTR_SN
                           AND T1.BASE_PD_CD = T8.BASE_PD_CD
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T8.VL_STRT_DTM AND T8.VL_END_DTM
                           AND T8.PD_REL_TP_CD IN ('03')   /*03 기준-서비스*/
                           AND T8.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_WELLS_DTL T9    /*계약WELLS상세 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서*/
                            ON T1.CNTR_NO = T9.CNTR_NO
                           AND T1.CNTR_SN = T9.CNTR_SN
                           AND T9.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_PRTNR_REL T10    /*계약파트너관계*/
                            ON T1.CNTR_NO = T10.CNTR_NO
                           AND T10.CNTR_PRTNR_TP_CD = '010'  /*계약파트너유형코드 010 판매자, 020 소개자, 030 홍보교사, 040 대리계약판매자, 050 관리자, 060 TM판매자*/
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T10.VL_STRT_DTM AND T10.VL_END_DTM
                           AND T10.DTA_DL_YN = 'N'
                         WHERE 1=1
                           AND (T1.CNTR_NO, T1.CNTR_SN) IN (SELECT CNTR_NO, CNTR_SN FROM INQRY_LIST)
        )
        , PD_INF AS ( SELECT T1.PD_CD
                           , T1.PD_TP_CD /* 상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품 */
                           , T1.SAP_MAT_CD
                           , T1.PD_NM
                           , T2.PD_EXTS_PRP_GRP_CD /* 상품확장속성그룹코드 */
                           , T2.PD_PRP_VAL01
                           , F_CMZ_CD_NM('TNT_WELLS', 'SV_IST_PCSV_DV_CD', T2.PD_PRP_VAL01, 'ko') AS SV_IST_PCSV_DV_CD_NM
                           /* , F_CMZ_CD_NM('TNT_WELLS', (SELECT SOURC_INF_CN AS COMMON_CODE  -- 공통코드 (T_CMZ_CD_D 테이블에서 확인 OR 팝업)
                                                       FROM TB_PDBS_PD_PRP_META_BAS TT1  -- 상품속성메타기본
                                                      WHERE USE_YN = 'Y'
                                                        AND PD_TP_CD = 'P'   -- C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품
                                                        AND PD_PRP_GRP_DTL_DV_CD = 'SPP'
                                                        AND COL_ID = 'PD_PRP_VAL01'
                                                     ) , T2.PD_PRP_VAL01, 'ko') AS PD_PRP_VAL01_NM */
                           , T2.PD_PRP_VAL02
                           , F_CMZ_CD_NM('TNT_WELLS', 'IST_BZS_CD', T2.PD_PRP_VAL02, 'ko') AS IST_BZS_CD_NM
                           /* , F_CMZ_CD_NM('TNT_WELLS', (SELECT SOURC_INF_CN AS COMMON_CODE  -- 공통코드 (T_CMZ_CD_D 테이블에서 확인 OR 팝업)
                                               FROM TB_PDBS_PD_PRP_META_BAS TT1 -- 상품속성메타기본
                                              WHERE USE_YN = 'Y'
                                                AND PD_TP_CD = 'P' -- C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품
                                                AND PD_PRP_GRP_DTL_DV_CD = 'SPP'
                                                AND COL_ID = 'PD_PRP_VAL02'
                                             ), T2.PD_PRP_VAL02, 'ko') AS IST_BZS_CD_NM */
                           , T1.SELL_TP_CD
                           , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T1.SELL_TP_CD, 'ko') AS SELL_TP_CD_NM
                           , T1.SV_PD_TP_CD /* 서비스상품유형코드(AS-IS 용도구분) : 1 방문, 2 택배, 3 홈케어, 4 혼합(방문+홈케어), 5 혼합(택배+홈케어)*//*SV_TP_CD 0 공통, 1 일반, 2 업소, 3 특별１, 4 특별２, 5 홈케어, 6 특별(조리수), 7 택배1, 8 택배2, 9 예외 */
                        FROM WSMDBS.TB_PDBS_PD_BAS T1 /*상품기본*/
             LEFT OUTER JOIN WSMDBS.TB_PDBS_PD_ECOM_PRP_DTL T2  /*상품각사속성상세*/
                          ON T1.PD_CD = T2.PD_CD
                          /* AND T2.PD_EXTS_PRP_GRP_CD IN ('SPP', 'SCHD', 'PDCT') */ /*상품확장속성그룹코드 CMN 공통, AFS AS, PRC 가격, STLM 결제, CNTR 계약, EXCH 교환/반품, ETC 기타, SL 매출, GO 발주, SPP 배송, ANA 분석, FEE 영업수수료, HIST 이력, SCHD 일정관리, COCN 전집, LRNN 학습/외국어, LV 학습단계, PART AS부품, FINC 재무, PDCT 판매제품*/
                       WHERE 1=1
                         AND (T1.PD_CD IN (SELECT PDCT_PD_CD FROM CNTR_INF) OR T1.PD_CD IN (SELECT SV_PD_CD FROM CNTR_INF) OR T1.PD_CD IN (SELECT BASE_PD_CD FROM CNTR_INF))
        )
        , OG_INF AS ( SELECT T1.BASE_YM
                           , T1.PRTNR_NO
                           , T1.OG_TP_CD
                           , T1.PRTNR_KNM
                           , T1.OG_ID
                           , T1.OG_CD
                           , T1.OG_NM
                           , T1.HMNRSC_DEPT_CD /* 인사부서코드*/
                           , T3.HGR_OG_ID
                        FROM WSMDBS.TB_OGBS_MM_PRTNR_IZ T1 /*월파트너내역*/
                  INNER JOIN WSMDBS.TB_OGBS_PRTNR_BAS T2 /*파트너기본*/
                          ON T1.PRTNR_NO = T2.PRTNR_NO
                         AND T1.OG_TP_CD = T2.OG_TP_CD
                         AND T2.DTA_DL_YN = 'N'
                  INNER JOIN WSMDBS.TB_OGBS_OG_BAS T3   /*조직기본*/
                          ON T1.OG_ID = T3.OG_ID
                         AND T3.DTA_DL_YN = 'N'
                       WHERE 1=1
                         AND T1.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
                      /* AND (T1.PRTNR_NO IN (SELECT ICHR_PRTNR_NO FROM TEMP1) OR T1.PRTNR_NO IN (SELECT PRTNR_NO FROM TEMP1) OR T1.PRTNR_NO IN (SELECT FST_RGST_USR_ID FROM TEMP1)) */
                         AND T1.OG_TP_CD IN ('HR1', 'W03','W06') /*조직유형코드 W01 P추진, W02 M추진, W03 홈마스터, W04 B2B, W05 온라인총판, W06 엔지니어, ALC 제휴채널, HR1 임직원, BND 채권, L01 라이프, X01 KLC, X02 LC전문강사*/
                     /* AND T1.BZ_STAT_CD IN ('1','2','3') */ /*1 사업, 2 해약, 3 휴업*/
                         AND T1.DTA_DL_YN = 'N'
        )
        SELECT T1.CNTR_NO
             , T1.CNTR_SN
             , T1.SVC_TP_CD /*서비스유형코드*/
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T1.SVC_TP_CD, 'ko') AS SVC_TP_NM
             , T2.RCGVP_KNM /*수령자한글명*/
             , T2.BASE_PD_CD /*기준상품코드*/
             , T3.PD_NM AS BASE_PD_NM
             , T2.PDCT_PD_CD /*제품상품코드*/
             , T3.SAP_MAT_CD
             , T4.PD_NM AS PDCT_PD_NM
             , T2.SV_PD_CD /*서비스 상품코드*/
             , T5.PD_NM AS SV_PD_NM
             , T5.SV_PD_TP_CD /*서비스상품유형코드(AS-IS 용도구분) : 1 방문, 2 택배, 3 홈케어, 4 혼합(방문+홈케어), 5 혼합(택배+홈케어)*//*SV_TP_CD 0 공통, 1 일반, 2 업소, 3 특별１, 4 특별２, 5 홈케어, 6 특별(조리수), 7 택배1, 8 택배2, 9 예외*/
             , T2.ADRPC_TP_CD
             , T2.ADRPC_TP_CD_RN
             , T1.IST_DT
             , (CASE WHEN T1.IST_DT IS NOT NULL THEN CEIL(MONTHS_BETWEEN(SYSDATE, T1.IST_DT))
                     ELSE 0
                END) AS USE_MCN /*사용개월수*/
             , T2.FRISU_BFSVC_PTRM_N /*무상BS개월*/
             , T2.NEW_ADR_ZIP       /*신주소우편번호*/
             , T2.RNADR             /*도로명주소*/
             , T2.RDADR             /*도로명상세주소*/
             , T2.ADR_DV_CD         /*주소구분코드 : 1 도로명, 2 지번*/
             , T2.ADR_ID            /*주소ID*/
             , T2.CRAL_LOCARA_TNO   /*휴대지역전화번호*/
             , T2.MEXNO_ENCR        /*휴대전화국번호암호화*/
             , T2.CRAL_IDV_TNO      /*휴대개별전화번호*/
             , T2.LOCARA_TNO        /*지역전화번호*/
             , T2.EXNO_ENCR         /*전화국번호암호화*/
             , T2.IDV_TNO           /*개별전화번호*/
             , T2.OG_TP_CD          /*조직유형코드*/
             , T2.PRTNR_NO          /*파트너번호 CNTR_PRTNR_REL_ID = '010' 판매자*/
             , T2.OG_ID             /*조직ID*/
             , T6.OG_NM             /*조직명*/
             , T6.HMNRSC_DEPT_CD    /*인사조직코드*/
             , T6.HGR_OG_ID         /*상위조직ID*/
             , T7.OG_NM AS HGR_OG_NM    /*상위조직명*/
         FROM INQRY_LIST T1
   INNER JOIN CNTR_INF T2
           ON T1.CNTR_NO = T2.CNTR_NO
          AND T1.CNTR_SN = T2.CNTR_SN
          AND T2.ADRPC_TP_CD_RN = '1'  /*ADRPC_TP_CD 값을 rank 함*/
LEFT OUTER JOIN PD_INF T3   /*상품정보 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안돼서*/
           ON T2.BASE_PD_CD = T3.PD_CD
          AND T3.PD_TP_CD = 'P'    /*상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품*/
          AND T3.PD_EXTS_PRP_GRP_CD = 'SPP'
LEFT OUTER JOIN PD_INF T4   /*상품정보 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안돼서*/
           ON T2.PDCT_PD_CD = T4.PD_CD
          AND T4.PD_TP_CD = 'M'    /*상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품*/
          AND T4.PD_EXTS_PRP_GRP_CD = 'PDCT'
LEFT OUTER JOIN PD_INF T5   /*상품정보 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안돼서*/
           ON T2.SV_PD_CD = T5.PD_CD
          AND T5.PD_TP_CD = 'S'    /*상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품*/
          AND T5.PD_EXTS_PRP_GRP_CD = 'SCHD'
LEFT OUTER JOIN OG_INF T6    /*조직정보*/
           ON T2.OG_ID = T6.OG_ID
LEFT OUTER JOIN OG_INF T7    /*조직정보*/
           ON T6.HGR_OG_ID = T7.OG_ID
    </select>
    <select id="selectCompanyIstStateFltr"
        resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncCompanyIstStateDto$SearchFltrSubMatRes">
        WITH INQRY_LIST AS ( SELECT (CASE WHEN V1.SVC_TP_CD ='3' AND V1.BASE_DTL_CNTR_NO IS NOT NULL THEN V1.BASE_DTL_CNTR_NO
                                          ELSE V1.CNTR_NO
                                     END) AS CNTR_NO
                                  , (CASE WHEN V1.SVC_TP_CD ='3' AND V1.BASE_DTL_CNTR_SN IS NOT NULL THEN V1.BASE_DTL_CNTR_SN
                                          ELSE V1.CNTR_SN
                                     END) AS CNTR_SN
                                  , V1.SVC_TP_CD
                                  , V1.IST_DT
                              FROM ( SELECT T1.CNTR_NO
                                          , T1.CNTR_SN
                                          , T1.SELL_TP_CD
                                          , T1.CNTR_DTL_STAT_CD
                                          /* SELL_TP_CD 판매유형코드 : 1 일시불, 2 렌탈/리스, 3 멤버십, 4 회사설치, 5 유지관리, 6 정기배송, 9 필터 */
                                          /* CNTR_DTL_STAT_CD 계약상세상태코드 : 101 정상, 201 고객요청정지, 202 연체정지, 203 해약접수정지, 301 고객요청해약, 302 연체해약, 303 계약취소, 401 최종종료, 402 계약기간종료 */
                                          , (CASE WHEN T1.SELL_TP_CD IN ('1', '2', '4') AND T1.CNTR_DTL_STAT_CD = '401' AND T3.BASE_DTL_CNTR_NO IS NULL THEN '9'
                                                  WHEN T3.BASE_DTL_CNTR_NO IS NOT NULL THEN '3'
                                                  ELSE T1.SELL_TP_CD
                                             END) AS SVC_TP_CD /* 서비스상태코드(AS-IS AC201_SALE_TP) - 현업이랑 협의하여 기준점을 잡아야 함 */
                                          , T3.BASE_DTL_CNTR_NO /* 멤버십계약번호 */
                                          , T3.BASE_DTL_CNTR_SN /* 멤버십계약일련번호 */
                                          , NVL(T2.IST_DT, T1.CNTR_PD_STRTDT) AS IST_DT
                                      FROM WSMDBS.TB_SSCT_CNTR_DTL T1 /* 계약상세 */
                           LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_WELLS_DTL T2 /* 계약WELLS상세 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서 */
                                        ON T1.CNTR_NO = T2.CNTR_NO
                                       AND T1.CNTR_SN = T2.CNTR_SN
                                       AND T2.DTA_DL_YN = 'N'
                           LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_REL T3 /* 계약관계 */
                                        ON T3.OJ_DTL_CNTR_NO = T1.CNTR_NO /* 멤버십이외원코드 */
                                       AND T3.OJ_DTL_CNTR_SN = T1.CNTR_SN
                                       AND T3.CNTR_REL_DTL_CD = '212' /* 계약관계상세코드 : 108 무료체험교체, 211 필터 - 정수기, 212 멤버십 - 원주문, 213 정수기 - 부가서비스, 214 정기배송 - 원주문, 215 1+1연계, 216 모종결합, 217 소개추천, 218 에어컨결합, 219 홈케어, 221 홈케어멤버십, 22L 플래너상조제휴, 22M 다건, 22P 패키지(대수할인), 22W 패키지상품 */
                                       AND T3.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') /* 유효시작일시 */
                                       AND T3.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') /* 유효종료일시 */
                                       AND T3.DTA_DL_YN = 'N'
                           LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_RSG_PROCS_IZ T4  /*계약해지처리내역*/
                                        ON T1.CNTR_NO = T4.CNTR_NO
                                       AND T1.CNTR_SN  = T4.CNTR_SN
                                       AND T4.DTA_DL_YN = 'N'
                                     WHERE 1=1
                                       /* AND T1.SELL_TP_CD = '2' */
                                       AND T1.DTA_DL_YN = 'N'
                                       AND T4.RSG_FSH_DT IS NULL
                                       /* 설치일자 조회 조건이 있을 경우 */
                                       <if test="@MybatisUtils@isNotEmpty(istDtFrom)">
                                       AND NVL(T2.IST_DT, T1.CNTR_PD_STRTDT) BETWEEN #{istDtFrom} AND #{istDtTo}
                                       </if>
                              ) V1
                              <if test="@MybatisUtils@isNotEmpty(mgtTyps)">
                              WHERE V1.SVC_TP_CD IN (<foreach collection="mgtTyps" item="mgtTyp" separator=", ">#{mgtTyp}</foreach>)
                              </if>
        )
        , CNTR_INF AS ( SELECT T1.CNTR_NO
                             , T1.CNTR_SN
                             , T1.BASE_PD_CD       /*기준상품코드*/
                             , T7.OJ_PD_CD AS PDCT_PD_CD   /*제품상품코드*/
                             , T8.OJ_PD_CD AS SV_PD_CD     /*서비스 상품코드*/
                             , T9.IST_DT
                             , T1.SELL_TP_CD       /*판매유형코드 : 1 일시불, 2 렌탈/리스, 3 멤버십, 4 회사설치, 5 유지관리, 6 정기배송, 9 필터*/
                             , T1.SELL_TP_DTL_CD   /*판매유형상세코드 : 11 일반, 12 홈케어, 13 환경가전, 21 일반렌탈, 22 리스, 23 공유렌탈, 24 환경리스, 25 장기할부, 26 환경할부, 31 일시불 멤버십, 32 렌탈 멤버십, 33 홈케어 멤버십, 34 회사설치, 61 일반, 62 모종, 63 캡슐*/
                             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T1.SELL_TP_CD, 'ko') AS SELL_TP_NM
                             , T1.CNTR_DTL_STAT_CD /*계약상세상태코드 : 101 정상, 201 고객요청정지, 202 연체정지, 203 해약접수정지, 301 고객요청해약, 302 연체해약, 303 계약취소, 401 최종종료, 402 계약기간종료*/
                             , F_CMZ_CD_NM('TNT_WELLS', 'CNTR_DTL_STAT_CD', T1.CNTR_DTL_STAT_CD, 'ko') AS CNTR_DTL_STAT_NM
                             , T2.CNTR_RCP_FSH_DTM /*계약접수완료일시*/
                             , T1.CNTR_PD_STRTDT   /*계약상품시작일자 - AS_IS 매출일자*/
                             , T4.RCGVP_KNM        /*수령자한글명*/
                             , T5.NEW_ADR_ZIP      /*신주소우편번호*/
                             , T5.RNADR            /*도로명주소*/
                             , T5.RDADR            /*도로명상세주소*/
                             , T4.ADR_DV_CD        /*주소구분코드 : 1 도로명, 2 지번*/
                             , T4.ADR_ID           /*주소ID*/
                             , T4.CRAL_LOCARA_TNO  /*휴대지역전화번호*/
                             , T4.MEXNO_ENCR       /*휴대전화국번호암호화*/
                             , T4.CRAL_IDV_TNO     /*휴대개별전화번호*/
                             , T4.LOCARA_TNO       /*지역전화번호*/
                             , T4.EXNO_ENCR        /*전화국번호암호화*/
                             , T4.IDV_TNO          /*개별전화번호*/
                             , T6.RSG_APLC_DT      /*해지신청일자*/
                             , T6.RSG_FSH_DT       /*해지완료일자*/
                             , T9.FRISU_BFSVC_PTRM_N   /*무상BS기간수*/
                             , T9.FRISU_AS_PTRM_N      /*무상AS기간수*/
                             , T10.OG_TP_CD        /*조직유형코드*/
                             , T10.PRTNR_NO        /*파트너번호 CNTR_PRTNR_REL_ID = '010' 판매자*/
                             , T10.OG_ID           /*조직ID*/
                             , T3.ADRPC_TP_CD      /*계약주소지ID : 1 계약주소, 2 배달주소, 3 설치주소*/
                             , DENSE_RANK() OVER(PARTITION BY T3.DTL_CNTR_NO, T3.DTL_CNTR_SN ORDER BY T3.ADRPC_TP_CD DESC) AS ADRPC_TP_CD_RN
                          FROM WSMDBS.TB_SSCT_CNTR_DTL T1  /*계약상세*/
                    INNER JOIN WSMDBS.TB_SSCT_CNTR_BAS T2  /*계약기본*/
                            ON T1.CNTR_NO = T2.CNTR_NO
                           AND T2.DTA_DL_YN = 'N'
                    INNER JOIN WSMDBS.TB_SSCT_CNTR_ADR_REL T3 /*계약주소관계*/
                            ON T1.CNTR_NO = T3.DTL_CNTR_NO
                           AND T1.CNTR_SN = T3.DTL_CNTR_SN
                           /* AND T3.ADRPC_TP_CD = '3' */ /*1 계약주소, 2 배달주소, 3 설치주소*/
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T3.VL_STRT_DTM AND T3.VL_END_DTM
                           AND T3.DTA_DL_YN = 'N'
                    INNER JOIN WSMDBS.TB_SSCT_CNTR_ADRPC_BAS T4 /*계약주소지기본*/
                            ON T3.CNTR_ADRPC_ID = T4.CNTR_ADRPC_ID  /*계약주소지ID*/
                           AND T4.DTA_DL_YN = 'N'
               LEFT OUTER JOIN GBSDBS.TB_GBCO_ADR_BAS T5
                            ON T4.ADR_ID = T5.ADR_ID   /*이해욱이사님,이진성프로님과 협의 설치, AS는 배정시에 주소를 사용 해야 하기 때문에 TB_SVPD_CST_SVAS_IST_OJ_IZ 에 ADR_ID 를 추가 하기로 함. 테이블이 변경 되면, T4.ADR_ID 를 T1.ADR_ID 으로 수정 해야 함*/
                           AND T5.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_RSG_PROCS_IZ T6  /*계약해지처리내역*/
                            ON T1.CNTR_NO = T6.CNTR_NO
                           AND T1.CNTR_SN = T6.CNTR_SN
                           AND T6.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_PD_REL T7      /*계약상품관계 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서*/
                            ON T1.CNTR_NO = T7.CNTR_NO
                           AND T1.CNTR_SN = T7.CNTR_SN
                           AND T1.BASE_PD_CD = T7.BASE_PD_CD
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T7.VL_STRT_DTM AND T7.VL_END_DTM
                           AND T7.PD_REL_TP_CD IN ('05')   /*05 기준-제품*/
                           AND T7.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_PD_REL T8      /*계약상품관계 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서*/
                            ON T1.CNTR_NO = T8.CNTR_NO
                           AND T1.CNTR_SN = T8.CNTR_SN
                           AND T1.BASE_PD_CD = T8.BASE_PD_CD
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T8.VL_STRT_DTM AND T8.VL_END_DTM
                           AND T8.PD_REL_TP_CD IN ('03')   /*03 기준-서비스*/
                           AND T8.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_WELLS_DTL T9    /*계약WELLS상세 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서*/
                            ON T1.CNTR_NO = T9.CNTR_NO
                           AND T1.CNTR_SN = T9.CNTR_SN
                           AND T9.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_PRTNR_REL T10    /*계약파트너관계*/
                            ON T1.CNTR_NO = T10.CNTR_NO
                           AND T10.CNTR_PRTNR_TP_CD = '010'  /*계약파트너유형코드 010 판매자, 020 소개자, 030 홍보교사, 040 대리계약판매자, 050 관리자, 060 TM판매자*/
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T10.VL_STRT_DTM AND T10.VL_END_DTM
                           AND T10.DTA_DL_YN = 'N'
                         WHERE 1=1
                           AND (T1.CNTR_NO, T1.CNTR_SN) IN (SELECT CNTR_NO, CNTR_SN FROM INQRY_LIST)
        )
        , PD_INF AS ( SELECT T1.PD_CD
                           , T1.PD_TP_CD /* 상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품 */
                           , T1.SAP_MAT_CD
                           , T1.PD_NM
                           , T2.PD_EXTS_PRP_GRP_CD /* 상품확장속성그룹코드 */
                           , T2.PD_PRP_VAL01
                           , F_CMZ_CD_NM('TNT_WELLS', 'SV_IST_PCSV_DV_CD', T2.PD_PRP_VAL01, 'ko') AS SV_IST_PCSV_DV_CD_NM
                           /* , F_CMZ_CD_NM('TNT_WELLS', (SELECT SOURC_INF_CN AS COMMON_CODE  -- 공통코드 (T_CMZ_CD_D 테이블에서 확인 OR 팝업)
                                                       FROM TB_PDBS_PD_PRP_META_BAS TT1  -- 상품속성메타기본
                                                      WHERE USE_YN = 'Y'
                                                        AND PD_TP_CD = 'P'   -- C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품
                                                        AND PD_PRP_GRP_DTL_DV_CD = 'SPP'
                                                        AND COL_ID = 'PD_PRP_VAL01'
                                                     ) , T2.PD_PRP_VAL01, 'ko') AS PD_PRP_VAL01_NM */
                           , T2.PD_PRP_VAL02
                           , F_CMZ_CD_NM('TNT_WELLS', 'IST_BZS_CD', T2.PD_PRP_VAL02, 'ko') AS IST_BZS_CD_NM
                           /* , F_CMZ_CD_NM('TNT_WELLS', (SELECT SOURC_INF_CN AS COMMON_CODE  -- 공통코드 (T_CMZ_CD_D 테이블에서 확인 OR 팝업)
                                               FROM TB_PDBS_PD_PRP_META_BAS TT1 -- 상품속성메타기본
                                              WHERE USE_YN = 'Y'
                                                AND PD_TP_CD = 'P' -- C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품
                                                AND PD_PRP_GRP_DTL_DV_CD = 'SPP'
                                                AND COL_ID = 'PD_PRP_VAL02'
                                             ), T2.PD_PRP_VAL02, 'ko') AS IST_BZS_CD_NM */
                           , T1.SELL_TP_CD
                           , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T1.SELL_TP_CD, 'ko') AS SELL_TP_CD_NM
                           , T1.SV_PD_TP_CD /* 서비스상품유형코드(AS-IS 용도구분) : 1 방문, 2 택배, 3 홈케어, 4 혼합(방문+홈케어), 5 혼합(택배+홈케어)*//*SV_TP_CD 0 공통, 1 일반, 2 업소, 3 특별１, 4 특별２, 5 홈케어, 6 특별(조리수), 7 택배1, 8 택배2, 9 예외 */
                        FROM WSMDBS.TB_PDBS_PD_BAS T1 /*상품기본*/
             LEFT OUTER JOIN WSMDBS.TB_PDBS_PD_ECOM_PRP_DTL T2  /*상품각사속성상세*/
                          ON T1.PD_CD = T2.PD_CD
                          /* AND T2.PD_EXTS_PRP_GRP_CD IN ('SPP', 'SCHD', 'PDCT') */ /*상품확장속성그룹코드 CMN 공통, AFS AS, PRC 가격, STLM 결제, CNTR 계약, EXCH 교환/반품, ETC 기타, SL 매출, GO 발주, SPP 배송, ANA 분석, FEE 영업수수료, HIST 이력, SCHD 일정관리, COCN 전집, LRNN 학습/외국어, LV 학습단계, PART AS부품, FINC 재무, PDCT 판매제품*/
                       WHERE 1=1
                         AND (T1.PD_CD IN (SELECT PDCT_PD_CD FROM CNTR_INF) OR T1.PD_CD IN (SELECT SV_PD_CD FROM CNTR_INF) OR T1.PD_CD IN (SELECT BASE_PD_CD FROM CNTR_INF))
        )
        , OG_INF AS ( SELECT T1.BASE_YM
                           , T1.PRTNR_NO
                           , T1.OG_TP_CD
                           , T1.PRTNR_KNM
                           , T1.OG_ID
                           , T1.OG_CD
                           , T1.OG_NM
                           , T1.HMNRSC_DEPT_CD /* 인사부서코드*/
                           , T3.HGR_OG_ID
                        FROM WSMDBS.TB_OGBS_MM_PRTNR_IZ T1 /*월파트너내역*/
                  INNER JOIN WSMDBS.TB_OGBS_PRTNR_BAS T2 /*파트너기본*/
                          ON T1.PRTNR_NO = T2.PRTNR_NO
                         AND T1.OG_TP_CD = T2.OG_TP_CD
                         AND T2.DTA_DL_YN = 'N'
                  INNER JOIN WSMDBS.TB_OGBS_OG_BAS T3   /*조직기본*/
                          ON T1.OG_ID = T3.OG_ID
                         AND T3.DTA_DL_YN = 'N'
                       WHERE 1=1
                         AND T1.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
                      /* AND (T1.PRTNR_NO IN (SELECT ICHR_PRTNR_NO FROM TEMP1) OR T1.PRTNR_NO IN (SELECT PRTNR_NO FROM TEMP1) OR T1.PRTNR_NO IN (SELECT FST_RGST_USR_ID FROM TEMP1)) */
                         AND T1.OG_TP_CD IN ('HR1', 'W03','W06') /*조직유형코드 W01 P추진, W02 M추진, W03 홈마스터, W04 B2B, W05 온라인총판, W06 엔지니어, ALC 제휴채널, HR1 임직원, BND 채권, L01 라이프, X01 KLC, X02 LC전문강사*/
                     /* AND T1.BZ_STAT_CD IN ('1','2','3') */ /*1 사업, 2 해약, 3 휴업*/
                         AND T1.DTA_DL_YN = 'N'
        )
        SELECT T1.CNTR_NO
             , T1.CNTR_SN
             , T1.SVC_TP_CD /*서비스유형코드*/
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T1.SVC_TP_CD, 'ko') AS SVC_TP_NM
             , T2.RCGVP_KNM /*수령자한글명*/
             , T2.BASE_PD_CD /*기준상품코드*/
             , T3.PD_NM AS BASE_PD_NM
             , T2.PDCT_PD_CD /*제품상품코드*/
             , T3.SAP_MAT_CD
             , T4.PD_NM AS PDCT_PD_NM
             , T2.SV_PD_CD /*서비스 상품코드*/
             , T5.PD_NM AS SV_PD_NM
             , T5.SV_PD_TP_CD /*서비스상품유형코드(AS-IS 용도구분) : 1 방문, 2 택배, 3 홈케어, 4 혼합(방문+홈케어), 5 혼합(택배+홈케어)*//*SV_TP_CD 0 공통, 1 일반, 2 업소, 3 특별１, 4 특별２, 5 홈케어, 6 특별(조리수), 7 택배1, 8 택배2, 9 예외*/
             , T2.ADRPC_TP_CD
             , T2.ADRPC_TP_CD_RN
             , T1.IST_DT
             , (CASE WHEN T1.IST_DT IS NOT NULL THEN CEIL(MONTHS_BETWEEN(SYSDATE, T1.IST_DT))
                     ELSE 0
                END) AS USE_MCN /*사용개월수*/
             , T2.FRISU_BFSVC_PTRM_N /*무상BS개월*/
             , T2.NEW_ADR_ZIP       /*신주소우편번호*/
             , T2.RNADR             /*도로명주소*/
             , T2.RDADR             /*도로명상세주소*/
             , T2.ADR_DV_CD         /*주소구분코드 : 1 도로명, 2 지번*/
             , T2.ADR_ID            /*주소ID*/
             , T2.CRAL_LOCARA_TNO   /*휴대지역전화번호*/
             , T2.MEXNO_ENCR        /*휴대전화국번호암호화*/
             , T2.CRAL_IDV_TNO      /*휴대개별전화번호*/
             , T2.LOCARA_TNO        /*지역전화번호*/
             , T2.EXNO_ENCR         /*전화국번호암호화*/
             , T2.IDV_TNO           /*개별전화번호*/
             , T2.OG_TP_CD          /*조직유형코드*/
             , T2.PRTNR_NO          /*파트너번호 CNTR_PRTNR_REL_ID = '010' 판매자*/
             , T2.OG_ID             /*조직ID*/
             , T6.OG_NM             /*조직명*/
             , T6.HMNRSC_DEPT_CD    /*인사조직코드*/
             , T6.HGR_OG_ID         /*상위조직ID*/
             , T7.OG_NM AS HGR_OG_NM    /*상위조직명*/
         FROM INQRY_LIST T1
   INNER JOIN CNTR_INF T2
           ON T1.CNTR_NO = T2.CNTR_NO
          AND T1.CNTR_SN = T2.CNTR_SN
          AND T2.ADRPC_TP_CD_RN = '1'  /*ADRPC_TP_CD 값을 rank 함*/
LEFT OUTER JOIN PD_INF T3   /*상품정보 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안돼서*/
           ON T2.BASE_PD_CD = T3.PD_CD
          AND T3.PD_TP_CD = 'P'    /*상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품*/
          AND T3.PD_EXTS_PRP_GRP_CD = 'SPP'
LEFT OUTER JOIN PD_INF T4   /*상품정보 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안돼서*/
           ON T2.PDCT_PD_CD = T4.PD_CD
          AND T4.PD_TP_CD = 'M'    /*상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품*/
          AND T4.PD_EXTS_PRP_GRP_CD = 'PDCT'
LEFT OUTER JOIN PD_INF T5   /*상품정보 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안돼서*/
           ON T2.SV_PD_CD = T5.PD_CD
          AND T5.PD_TP_CD = 'S'    /*상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품*/
          AND T5.PD_EXTS_PRP_GRP_CD = 'SCHD'
LEFT OUTER JOIN OG_INF T6    /*조직정보*/
           ON T2.OG_ID = T6.OG_ID
LEFT OUTER JOIN OG_INF T7    /*조직정보*/
           ON T6.HGR_OG_ID = T7.OG_ID
    </select>
    <select id="selectCompanyIstStateSubMat"
        resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncCompanyIstStateDto$SearchFltrSubMatRes">
        WITH INQRY_LIST AS ( SELECT (CASE WHEN V1.SVC_TP_CD ='3' AND V1.BASE_DTL_CNTR_NO IS NOT NULL THEN V1.BASE_DTL_CNTR_NO
                                          ELSE V1.CNTR_NO
                                     END) AS CNTR_NO
                                  , (CASE WHEN V1.SVC_TP_CD ='3' AND V1.BASE_DTL_CNTR_SN IS NOT NULL THEN V1.BASE_DTL_CNTR_SN
                                          ELSE V1.CNTR_SN
                                     END) AS CNTR_SN
                                  , V1.SVC_TP_CD
                                  , V1.IST_DT
                              FROM ( SELECT T1.CNTR_NO
                                          , T1.CNTR_SN
                                          , T1.SELL_TP_CD
                                          , T1.CNTR_DTL_STAT_CD
                                          /* SELL_TP_CD 판매유형코드 : 1 일시불, 2 렌탈/리스, 3 멤버십, 4 회사설치, 5 유지관리, 6 정기배송, 9 필터 */
                                          /* CNTR_DTL_STAT_CD 계약상세상태코드 : 101 정상, 201 고객요청정지, 202 연체정지, 203 해약접수정지, 301 고객요청해약, 302 연체해약, 303 계약취소, 401 최종종료, 402 계약기간종료 */
                                          , (CASE WHEN T1.SELL_TP_CD IN ('1', '2', '4') AND T1.CNTR_DTL_STAT_CD = '401' AND T3.BASE_DTL_CNTR_NO IS NULL THEN '9'
                                                  WHEN T3.BASE_DTL_CNTR_NO IS NOT NULL THEN '3'
                                                  ELSE T1.SELL_TP_CD
                                             END) AS SVC_TP_CD /* 서비스상태코드(AS-IS AC201_SALE_TP) - 현업이랑 협의하여 기준점을 잡아야 함 */
                                          , T3.BASE_DTL_CNTR_NO /* 멤버십계약번호 */
                                          , T3.BASE_DTL_CNTR_SN /* 멤버십계약일련번호 */
                                          , NVL(T2.IST_DT, T1.CNTR_PD_STRTDT) AS IST_DT
                                      FROM WSMDBS.TB_SSCT_CNTR_DTL T1 /* 계약상세 */
                           LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_WELLS_DTL T2 /* 계약WELLS상세 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서 */
                                        ON T1.CNTR_NO = T2.CNTR_NO
                                       AND T1.CNTR_SN = T2.CNTR_SN
                                       AND T2.DTA_DL_YN = 'N'
                           LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_REL T3 /* 계약관계 */
                                        ON T3.OJ_DTL_CNTR_NO = T1.CNTR_NO /* 멤버십이외원코드 */
                                       AND T3.OJ_DTL_CNTR_SN = T1.CNTR_SN
                                       AND T3.CNTR_REL_DTL_CD = '212' /* 계약관계상세코드 : 108 무료체험교체, 211 필터 - 정수기, 212 멤버십 - 원주문, 213 정수기 - 부가서비스, 214 정기배송 - 원주문, 215 1+1연계, 216 모종결합, 217 소개추천, 218 에어컨결합, 219 홈케어, 221 홈케어멤버십, 22L 플래너상조제휴, 22M 다건, 22P 패키지(대수할인), 22W 패키지상품 */
                                       AND T3.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') /* 유효시작일시 */
                                       AND T3.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') /* 유효종료일시 */
                                       AND T3.DTA_DL_YN = 'N'
                           LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_RSG_PROCS_IZ T4  /*계약해지처리내역*/
                                        ON T1.CNTR_NO = T4.CNTR_NO
                                       AND T1.CNTR_SN  = T4.CNTR_SN
                                       AND T4.DTA_DL_YN = 'N'
                                     WHERE 1=1
                                       /* AND T1.SELL_TP_CD = '2' */
                                       AND T1.DTA_DL_YN = 'N'
                                       AND T4.RSG_FSH_DT IS NULL
                                       /* 설치일자 조회 조건이 있을 경우 */
                                       <if test="@MybatisUtils@isNotEmpty(istDtFrom)">
                                       AND NVL(T2.IST_DT, T1.CNTR_PD_STRTDT) BETWEEN #{istDtFrom} AND #{istDtTo}
                                       </if>
                              ) V1
                              <if test="@MybatisUtils@isNotEmpty(mgtTyps)">
                              WHERE V1.SVC_TP_CD IN (<foreach collection="mgtTyps" item="mgtTyp" separator=", ">#{mgtTyp}</foreach>)
                              </if>
        )
        , CNTR_INF AS ( SELECT T1.CNTR_NO
                             , T1.CNTR_SN
                             , T1.BASE_PD_CD       /*기준상품코드*/
                             , T7.OJ_PD_CD AS PDCT_PD_CD   /*제품상품코드*/
                             , T8.OJ_PD_CD AS SV_PD_CD     /*서비스 상품코드*/
                             , T9.IST_DT
                             , T1.SELL_TP_CD       /*판매유형코드 : 1 일시불, 2 렌탈/리스, 3 멤버십, 4 회사설치, 5 유지관리, 6 정기배송, 9 필터*/
                             , T1.SELL_TP_DTL_CD   /*판매유형상세코드 : 11 일반, 12 홈케어, 13 환경가전, 21 일반렌탈, 22 리스, 23 공유렌탈, 24 환경리스, 25 장기할부, 26 환경할부, 31 일시불 멤버십, 32 렌탈 멤버십, 33 홈케어 멤버십, 34 회사설치, 61 일반, 62 모종, 63 캡슐*/
                             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T1.SELL_TP_CD, 'ko') AS SELL_TP_NM
                             , T1.CNTR_DTL_STAT_CD /*계약상세상태코드 : 101 정상, 201 고객요청정지, 202 연체정지, 203 해약접수정지, 301 고객요청해약, 302 연체해약, 303 계약취소, 401 최종종료, 402 계약기간종료*/
                             , F_CMZ_CD_NM('TNT_WELLS', 'CNTR_DTL_STAT_CD', T1.CNTR_DTL_STAT_CD, 'ko') AS CNTR_DTL_STAT_NM
                             , T2.CNTR_RCP_FSH_DTM /*계약접수완료일시*/
                             , T1.CNTR_PD_STRTDT   /*계약상품시작일자 - AS_IS 매출일자*/
                             , T4.RCGVP_KNM        /*수령자한글명*/
                             , T5.NEW_ADR_ZIP      /*신주소우편번호*/
                             , T5.RNADR            /*도로명주소*/
                             , T5.RDADR            /*도로명상세주소*/
                             , T4.ADR_DV_CD        /*주소구분코드 : 1 도로명, 2 지번*/
                             , T4.ADR_ID           /*주소ID*/
                             , T4.CRAL_LOCARA_TNO  /*휴대지역전화번호*/
                             , T4.MEXNO_ENCR       /*휴대전화국번호암호화*/
                             , T4.CRAL_IDV_TNO     /*휴대개별전화번호*/
                             , T4.LOCARA_TNO       /*지역전화번호*/
                             , T4.EXNO_ENCR        /*전화국번호암호화*/
                             , T4.IDV_TNO          /*개별전화번호*/
                             , T6.RSG_APLC_DT      /*해지신청일자*/
                             , T6.RSG_FSH_DT       /*해지완료일자*/
                             , T9.FRISU_BFSVC_PTRM_N   /*무상BS기간수*/
                             , T9.FRISU_AS_PTRM_N      /*무상AS기간수*/
                             , T10.OG_TP_CD        /*조직유형코드*/
                             , T10.PRTNR_NO        /*파트너번호 CNTR_PRTNR_REL_ID = '010' 판매자*/
                             , T10.OG_ID           /*조직ID*/
                             , T3.ADRPC_TP_CD      /*계약주소지ID : 1 계약주소, 2 배달주소, 3 설치주소*/
                             , DENSE_RANK() OVER(PARTITION BY T3.DTL_CNTR_NO, T3.DTL_CNTR_SN ORDER BY T3.ADRPC_TP_CD DESC) AS ADRPC_TP_CD_RN
                          FROM WSMDBS.TB_SSCT_CNTR_DTL T1  /*계약상세*/
                    INNER JOIN WSMDBS.TB_SSCT_CNTR_BAS T2  /*계약기본*/
                            ON T1.CNTR_NO = T2.CNTR_NO
                           AND T2.DTA_DL_YN = 'N'
                    INNER JOIN WSMDBS.TB_SSCT_CNTR_ADR_REL T3 /*계약주소관계*/
                            ON T1.CNTR_NO = T3.DTL_CNTR_NO
                           AND T1.CNTR_SN = T3.DTL_CNTR_SN
                           /* AND T3.ADRPC_TP_CD = '3' */ /*1 계약주소, 2 배달주소, 3 설치주소*/
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T3.VL_STRT_DTM AND T3.VL_END_DTM
                           AND T3.DTA_DL_YN = 'N'
                    INNER JOIN WSMDBS.TB_SSCT_CNTR_ADRPC_BAS T4 /*계약주소지기본*/
                            ON T3.CNTR_ADRPC_ID = T4.CNTR_ADRPC_ID  /*계약주소지ID*/
                           AND T4.DTA_DL_YN = 'N'
               LEFT OUTER JOIN GBSDBS.TB_GBCO_ADR_BAS T5
                            ON T4.ADR_ID = T5.ADR_ID   /*이해욱이사님,이진성프로님과 협의 설치, AS는 배정시에 주소를 사용 해야 하기 때문에 TB_SVPD_CST_SVAS_IST_OJ_IZ 에 ADR_ID 를 추가 하기로 함. 테이블이 변경 되면, T4.ADR_ID 를 T1.ADR_ID 으로 수정 해야 함*/
                           AND T5.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_RSG_PROCS_IZ T6  /*계약해지처리내역*/
                            ON T1.CNTR_NO = T6.CNTR_NO
                           AND T1.CNTR_SN = T6.CNTR_SN
                           AND T6.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_PD_REL T7      /*계약상품관계 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서*/
                            ON T1.CNTR_NO = T7.CNTR_NO
                           AND T1.CNTR_SN = T7.CNTR_SN
                           AND T1.BASE_PD_CD = T7.BASE_PD_CD
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T7.VL_STRT_DTM AND T7.VL_END_DTM
                           AND T7.PD_REL_TP_CD IN ('05')   /*05 기준-제품*/
                           AND T7.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_PD_REL T8      /*계약상품관계 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서*/
                            ON T1.CNTR_NO = T8.CNTR_NO
                           AND T1.CNTR_SN = T8.CNTR_SN
                           AND T1.BASE_PD_CD = T8.BASE_PD_CD
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T8.VL_STRT_DTM AND T8.VL_END_DTM
                           AND T8.PD_REL_TP_CD IN ('03')   /*03 기준-서비스*/
                           AND T8.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_WELLS_DTL T9    /*계약WELLS상세 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안되서*/
                            ON T1.CNTR_NO = T9.CNTR_NO
                           AND T1.CNTR_SN = T9.CNTR_SN
                           AND T9.DTA_DL_YN = 'N'
               LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_PRTNR_REL T10    /*계약파트너관계*/
                            ON T1.CNTR_NO = T10.CNTR_NO
                           AND T10.CNTR_PRTNR_TP_CD = '010'  /*계약파트너유형코드 010 판매자, 020 소개자, 030 홍보교사, 040 대리계약판매자, 050 관리자, 060 TM판매자*/
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T10.VL_STRT_DTM AND T10.VL_END_DTM
                           AND T10.DTA_DL_YN = 'N'
                         WHERE 1=1
                           AND (T1.CNTR_NO, T1.CNTR_SN) IN (SELECT CNTR_NO, CNTR_SN FROM INQRY_LIST)
        )
        , PD_INF AS ( SELECT T1.PD_CD
                           , T1.PD_TP_CD /* 상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품 */
                           , T1.SAP_MAT_CD
                           , T1.PD_NM
                           , T2.PD_EXTS_PRP_GRP_CD /* 상품확장속성그룹코드 */
                           , T2.PD_PRP_VAL01
                           , F_CMZ_CD_NM('TNT_WELLS', 'SV_IST_PCSV_DV_CD', T2.PD_PRP_VAL01, 'ko') AS SV_IST_PCSV_DV_CD_NM
                           /* , F_CMZ_CD_NM('TNT_WELLS', (SELECT SOURC_INF_CN AS COMMON_CODE  -- 공통코드 (T_CMZ_CD_D 테이블에서 확인 OR 팝업)
                                                       FROM TB_PDBS_PD_PRP_META_BAS TT1  -- 상품속성메타기본
                                                      WHERE USE_YN = 'Y'
                                                        AND PD_TP_CD = 'P'   -- C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품
                                                        AND PD_PRP_GRP_DTL_DV_CD = 'SPP'
                                                        AND COL_ID = 'PD_PRP_VAL01'
                                                     ) , T2.PD_PRP_VAL01, 'ko') AS PD_PRP_VAL01_NM */
                           , T2.PD_PRP_VAL02
                           , F_CMZ_CD_NM('TNT_WELLS', 'IST_BZS_CD', T2.PD_PRP_VAL02, 'ko') AS IST_BZS_CD_NM
                           /* , F_CMZ_CD_NM('TNT_WELLS', (SELECT SOURC_INF_CN AS COMMON_CODE  -- 공통코드 (T_CMZ_CD_D 테이블에서 확인 OR 팝업)
                                               FROM TB_PDBS_PD_PRP_META_BAS TT1 -- 상품속성메타기본
                                              WHERE USE_YN = 'Y'
                                                AND PD_TP_CD = 'P' -- C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품
                                                AND PD_PRP_GRP_DTL_DV_CD = 'SPP'
                                                AND COL_ID = 'PD_PRP_VAL02'
                                             ), T2.PD_PRP_VAL02, 'ko') AS IST_BZS_CD_NM */
                           , T1.SELL_TP_CD
                           , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T1.SELL_TP_CD, 'ko') AS SELL_TP_CD_NM
                           , T1.SV_PD_TP_CD /* 서비스상품유형코드(AS-IS 용도구분) : 1 방문, 2 택배, 3 홈케어, 4 혼합(방문+홈케어), 5 혼합(택배+홈케어)*//*SV_TP_CD 0 공통, 1 일반, 2 업소, 3 특별１, 4 특별２, 5 홈케어, 6 특별(조리수), 7 택배1, 8 택배2, 9 예외 */
                        FROM WSMDBS.TB_PDBS_PD_BAS T1 /*상품기본*/
             LEFT OUTER JOIN WSMDBS.TB_PDBS_PD_ECOM_PRP_DTL T2  /*상품각사속성상세*/
                          ON T1.PD_CD = T2.PD_CD
                          /* AND T2.PD_EXTS_PRP_GRP_CD IN ('SPP', 'SCHD', 'PDCT') */ /*상품확장속성그룹코드 CMN 공통, AFS AS, PRC 가격, STLM 결제, CNTR 계약, EXCH 교환/반품, ETC 기타, SL 매출, GO 발주, SPP 배송, ANA 분석, FEE 영업수수료, HIST 이력, SCHD 일정관리, COCN 전집, LRNN 학습/외국어, LV 학습단계, PART AS부품, FINC 재무, PDCT 판매제품*/
                       WHERE 1=1
                         AND (T1.PD_CD IN (SELECT PDCT_PD_CD FROM CNTR_INF) OR T1.PD_CD IN (SELECT SV_PD_CD FROM CNTR_INF) OR T1.PD_CD IN (SELECT BASE_PD_CD FROM CNTR_INF))
        )
        , OG_INF AS ( SELECT T1.BASE_YM
                           , T1.PRTNR_NO
                           , T1.OG_TP_CD
                           , T1.PRTNR_KNM
                           , T1.OG_ID
                           , T1.OG_CD
                           , T1.OG_NM
                           , T1.HMNRSC_DEPT_CD /* 인사부서코드*/
                           , T3.HGR_OG_ID
                        FROM WSMDBS.TB_OGBS_MM_PRTNR_IZ T1 /*월파트너내역*/
                  INNER JOIN WSMDBS.TB_OGBS_PRTNR_BAS T2 /*파트너기본*/
                          ON T1.PRTNR_NO = T2.PRTNR_NO
                         AND T1.OG_TP_CD = T2.OG_TP_CD
                         AND T2.DTA_DL_YN = 'N'
                  INNER JOIN WSMDBS.TB_OGBS_OG_BAS T3   /*조직기본*/
                          ON T1.OG_ID = T3.OG_ID
                         AND T3.DTA_DL_YN = 'N'
                       WHERE 1=1
                         AND T1.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
                      /* AND (T1.PRTNR_NO IN (SELECT ICHR_PRTNR_NO FROM TEMP1) OR T1.PRTNR_NO IN (SELECT PRTNR_NO FROM TEMP1) OR T1.PRTNR_NO IN (SELECT FST_RGST_USR_ID FROM TEMP1)) */
                         AND T1.OG_TP_CD IN ('HR1', 'W03','W06') /*조직유형코드 W01 P추진, W02 M추진, W03 홈마스터, W04 B2B, W05 온라인총판, W06 엔지니어, ALC 제휴채널, HR1 임직원, BND 채권, L01 라이프, X01 KLC, X02 LC전문강사*/
                     /* AND T1.BZ_STAT_CD IN ('1','2','3') */ /*1 사업, 2 해약, 3 휴업*/
                         AND T1.DTA_DL_YN = 'N'
        )
        SELECT T1.CNTR_NO
             , T1.CNTR_SN
             , T1.SVC_TP_CD /*서비스유형코드*/
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T1.SVC_TP_CD, 'ko') AS SVC_TP_NM
             , T2.RCGVP_KNM /*수령자한글명*/
             , T2.BASE_PD_CD /*기준상품코드*/
             , T3.PD_NM AS BASE_PD_NM
             , T2.PDCT_PD_CD /*제품상품코드*/
             , T3.SAP_MAT_CD
             , T4.PD_NM AS PDCT_PD_NM
             , T2.SV_PD_CD /*서비스 상품코드*/
             , T5.PD_NM AS SV_PD_NM
             , T5.SV_PD_TP_CD /*서비스상품유형코드(AS-IS 용도구분) : 1 방문, 2 택배, 3 홈케어, 4 혼합(방문+홈케어), 5 혼합(택배+홈케어)*//*SV_TP_CD 0 공통, 1 일반, 2 업소, 3 특별１, 4 특별２, 5 홈케어, 6 특별(조리수), 7 택배1, 8 택배2, 9 예외*/
             , T2.ADRPC_TP_CD
             , T2.ADRPC_TP_CD_RN
             , T1.IST_DT
             , (CASE WHEN T1.IST_DT IS NOT NULL THEN CEIL(MONTHS_BETWEEN(SYSDATE, T1.IST_DT))
                     ELSE 0
                END) AS USE_MCN /*사용개월수*/
             , T2.FRISU_BFSVC_PTRM_N /*무상BS개월*/
             , T2.NEW_ADR_ZIP       /*신주소우편번호*/
             , T2.RNADR             /*도로명주소*/
             , T2.RDADR             /*도로명상세주소*/
             , T2.ADR_DV_CD         /*주소구분코드 : 1 도로명, 2 지번*/
             , T2.ADR_ID            /*주소ID*/
             , T2.CRAL_LOCARA_TNO   /*휴대지역전화번호*/
             , T2.MEXNO_ENCR        /*휴대전화국번호암호화*/
             , T2.CRAL_IDV_TNO      /*휴대개별전화번호*/
             , T2.LOCARA_TNO        /*지역전화번호*/
             , T2.EXNO_ENCR         /*전화국번호암호화*/
             , T2.IDV_TNO           /*개별전화번호*/
             , T2.OG_TP_CD          /*조직유형코드*/
             , T2.PRTNR_NO          /*파트너번호 CNTR_PRTNR_REL_ID = '010' 판매자*/
             , T2.OG_ID             /*조직ID*/
             , T6.OG_NM             /*조직명*/
             , T6.HMNRSC_DEPT_CD    /*인사조직코드*/
             , T6.HGR_OG_ID         /*상위조직ID*/
             , T7.OG_NM AS HGR_OG_NM    /*상위조직명*/
         FROM INQRY_LIST T1
   INNER JOIN CNTR_INF T2
           ON T1.CNTR_NO = T2.CNTR_NO
          AND T1.CNTR_SN = T2.CNTR_SN
          AND T2.ADRPC_TP_CD_RN = '1'  /*ADRPC_TP_CD 값을 rank 함*/
LEFT OUTER JOIN PD_INF T3   /*상품정보 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안돼서*/
           ON T2.BASE_PD_CD = T3.PD_CD
          AND T3.PD_TP_CD = 'P'    /*상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품*/
          AND T3.PD_EXTS_PRP_GRP_CD = 'SPP'
LEFT OUTER JOIN PD_INF T4   /*상품정보 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안돼서*/
           ON T2.PDCT_PD_CD = T4.PD_CD
          AND T4.PD_TP_CD = 'M'    /*상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품*/
          AND T4.PD_EXTS_PRP_GRP_CD = 'PDCT'
LEFT OUTER JOIN PD_INF T5   /*상품정보 - 원래는 inner join 으로 해야 하는데 데이타 이행이 제대로 안돼서*/
           ON T2.SV_PD_CD = T5.PD_CD
          AND T5.PD_TP_CD = 'S'    /*상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품*/
          AND T5.PD_EXTS_PRP_GRP_CD = 'SCHD'
LEFT OUTER JOIN OG_INF T6    /*조직정보*/
           ON T2.OG_ID = T6.OG_ID
LEFT OUTER JOIN OG_INF T7    /*조직정보*/
           ON T6.HGR_OG_ID = T7.OG_ID
    </select>
</mapper>
