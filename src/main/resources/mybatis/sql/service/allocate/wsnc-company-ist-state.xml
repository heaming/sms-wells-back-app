<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncCompanyIstStateMapper">
    <select id="selectCompanyIstStateAll"
            resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncCompanyIstStateDto$SearchAllRes">
        WITH PROD AS (SELECT P3.BASE_PD_CD    -- 상품코드
                           , (SELECT PD_NM FROM TB_PDBS_PD_BAS A WHERE A.PD_CD = P3.BASE_PD_CD) AS BASE_PD_NM
                           , P1.PD_CD         -- 부품코드
                           , P1.PD_NM         -- 부품명
                           , P1.SAP_MAT_CD    --SAP 자재코드
                           , P1.PDCT_UPRC     -- 제품단가
                           , P3.CSMR_UPRC_AMT -- 소비자단가
                           , P2.PD_CLSF_NM /* 상품분류명 */
                      FROM TB_PDBS_PD_BAS P1 /* 상품기본 */
                               INNER JOIN TB_PDBS_PD_CLSF_BAS P2 /* 상품분류기본*/
                                ON P1.PD_CSLF_ID = P2.PD_CLSF_ID
                                <if test="@MybatisUtils@isNotEmpty(PD_CSLF_ID)">
                                    AND #{ostrWareDvCd} = (SELECT OSTR_WARE_DV_CD FROM TB_SVST_ITM_OSTR_IZ S2 WHERE S1.ITM_OSTR_NO =
                                    S2.ITM_OSTR_NO AND S1.OSTR_SN = S2.OSTR_SN)
                                </if>
                               INNER JOIN TB_SVPD_RCAS_ITM_PRC_IZ P3 /* 유상AS품목가격내역 */
                                          ON P1.PD_CD = P3.USE_MAT_PD_CD)
           , SVC AS (SELECT T2.CST_SV_ASN_NO     -- 고객서비스배정번호
                          , T2.ASN_OJ_YM         -- 배정대상년월
                          , T2.CNTR_NO           -- 계약번호
                          , T2.CNTR_SN           -- 계약일련번호
                          , T2.SV_BIZ_MCLSF_CD   --서비스업무중분류
                          , T2.SV_BIZ_DCLSF_CD   --서비스업무세분류
                          , T1.USE_QTY           -- 사용수량
                          , T2.PRTNR_CLSF_CD     --파트너유형
                          , T2.PRTNR_NO          -- 파트너번호
                          , T2.PRTNR_KNM         -- 파트너한글명
                          , T2.OG_NM             -- 조직명
                          , T1.ITM_PD_CD         -- 품목상품코드
                          , T2.ADR               -- 고객상세주소
                          , T1.BFSVC_REFRI_DV_CD -- 유무상
                          , T2.COPN_DV_CD        -- 법인격구분코드
                          , T2.CUST_NM           --고객명
                     FROM TB_SVST_SV_WK_OSTR_IZ T1
                              INNER JOIN (SELECT E1.CST_SV_ASN_NO
                                               , E1.ASN_OJ_YM       -- 배정대상년월
                                               , E1.CNTR_NO         -- 계약번호
                                               , E1.CNTR_SN         -- 계약일련번호
                                               , E1.SV_BIZ_MCLSF_CD --서비스업무중분류
                                               , E1.SV_BIZ_DCLSF_CD --서비스업무세분류
                                               , M1.PRTNR_CLSF_CD   --파트너유형
                                               , M1.PRTNR_NO        -- 파트너번호
                                               , M1.PRTNR_KNM       -- 파트너한글명
                                               , M1.OG_CD           -- 조직코드
                                               , M1.OG_NM           -- 조직명
                                               , E2.ADR             -- 고객주소상세
                                               , B1.COPN_DV_CD      -- 법인격구분코드
                                               , E2.CUST_NM         -- 고객명
--                                           , (SELECT CSCN_CD
--                                              FROM TB_OGBS_DEPT_BAS M2
--                                              WHERE M2.DEPT_CD = M1.
--                                                       INNER JOIN M1
                                               --                                              ON M2.DEPT_CD = M1.OG_CD) CSCN_CD -- 코스트코드
                                          FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ E1 /* 고객서비스BS배정내역 */
                                                   INNER JOIN (SELECT A1.DTL_CNTR_NO
                                                                    , A1.DTL_CNTR_SN
                                                                    , TRIM(A2.RCGVP_KNM)          AS CUST_NM
                                                                    , A2.ADR_ID
                                                                    , A2.LOCARA_TNO
                                                                    , A2.EXNO_ENCR
                                                                    , A2.IDV_TNO
                                                                    , A2.CRAL_LOCARA_TNO
                                                                    , A2.MEXNO_ENCR
                                                                    , A2.CRAL_IDV_TNO
                                                                    , B2.RNADR || ' ' || B2.RDADR AS ADR
                                                               FROM TB_SSCT_CNTR_ADR_REL A1
                                                                        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS A2
                                                                                   ON A2.CNTR_ADRPC_ID =
                                                                                      A1.CNTR_ADRPC_ID
                                                                                       AND A2.DTA_DL_YN = 'N'
                                                                        INNER JOIN TB_GBCO_ADR_BAS B2
                                                                                   ON A2.ADR_ID = B2.ADR_ID
                                                                                       AND A2.DTA_DL_YN = 'N'
                                                               WHERE 1 = 1
                                                                 AND A1.DTA_DL_YN = 'N'
                                                                 AND A1.ADRPC_TP_CD = '3' /* 설치처 */
                                                                 AND A1.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                                                                 AND A1.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')) E2
                                                              ON E1.CNTR_NO = E2.DTL_CNTR_NO
                                                                  AND E1.CNTR_SN = E2.DTL_CNTR_SN
                                                   INNER JOIN TB_SSCT_CNTR_BAS B1
                                                              ON B1.CNTR_NO = E1.CNTR_NO
                                                                  AND B1.COPN_DV_CD = '2'
                                                   LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ M1 /* 월파트너내역 */
                                                                   ON M1.BASE_YM = E1.ASN_OJ_YM
                                                                       AND M1.OG_TP_CD = E1.CNFM_PSIC_PRTNR_OG_TP_CD
                                                                       AND M1.PRTNR_NO = E1.CNFM_PSIC_PRTNR_NO
                                          WHERE E1.ASN_OJ_YM = #{mgtYnm}) T2 ON T1.CNTR_NO = T2.CNTR_NO
                         AND T1.CNTR_SN = T2.CNTR_SN
                         AND T1.ICHR_PRTNR_NO = T2.PRTNR_NO
                         AND T1.CST_SV_ASN_NO = T2.CST_SV_ASN_NO)
        SELECT SVC.CNTR_NO || '-' || SVC.CNTR_SN AS CNTR_NO
             , ''                                AS DEPT_CD
             , ''                                AS DEPT_NM1
             , ''                                AS CSNR_CD
             , ''                                AS OG_NM
             , SVC.CUST_NM
             , SVC.COPN_DV_CD                    AS COPN_DV_CD
             , PROD.BASE_PD_CD                   AS PD_CD
             , PROD.BASE_PD_NM                   AS PD_NM
             , SVC.SV_BIZ_MCLSF_CD
             , SVC.SV_BIZ_DCLSF_CD
             , PROD.SAP_MAT_CD
             , PROD.PD_CD                        AS PART_PD_CD
             , PROD.PD_NM                        AS PART_PD_NM
             , SVC.USE_QTY
             , PROD.PDCT_UPRC
             , PROD.PDCT_UPRC * SVC.USE_QTY      AS PDCT_UPRC_SUM     -- 원가합계
             , PROD.CSMR_UPRC_AMT
             , PROD.CSMR_UPRC_AMT * SVC.USE_QTY  AS CSMR_UPRC_AMT_SUM --소비자합계
             , SVC.BFSVC_REFRI_DV_CD             AS REFRI_DV_CD
             , SVC.PRTNR_CLSF_CD                 AS WRK_PRTNR_CLSF_CD
             , SVC.PRTNR_NO                      AS WRK_PRTNR_NO
             , SVC.PRTNR_KNM                     AS WRK_PRTNR_KNM
             , SVC.OG_NM                         AS WRK_OG_NM
             , SVC.ADR                           AS CST_ADR
        FROM PROD
                 INNER JOIN SVC
                            ON PROD.PD_CD = SVC.ITM_PD_CD
    </select>

    <select id="selectCompanyIstStateFltr"
            resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncCompanyIstStateDto$SearchAllRes">
        WITH PROD AS (SELECT P3.BASE_PD_CD    -- 상품코드
                           , (SELECT PD_NM FROM TB_PDBS_PD_BAS A WHERE A.PD_CD = P3.BASE_PD_CD) AS BASE_PD_NM
                           , P1.PD_CD         -- 부품코드
                           , P1.PD_NM         -- 부품명
                           , P1.SAP_MAT_CD    --SAP 자재코드
                           , P1.PDCT_UPRC     -- 제품단가
                           , P3.CSMR_UPRC_AMT -- 소비자단가
                           , P2.PD_CLSF_NM /* 상품분류명 */
                      FROM TB_PDBS_PD_BAS P1 /* 상품기본 */
                               INNER JOIN TB_PDBS_PD_CLSF_BAS P2 /* 상품분류기본*/
                                ON P1.PD_CSLF_ID = P2.PD_CLSF_ID
                               INNER JOIN TB_SVPD_RCAS_ITM_PRC_IZ P3 /* 유상AS품목가격내역 */
                                          ON P1.PD_CD = P3.USE_MAT_PD_CD)
           , SVC AS (SELECT T2.CST_SV_ASN_NO     -- 고객서비스배정번호
                          , T2.ASN_OJ_YM         -- 배정대상년월
                          , T2.CNTR_NO           -- 계약번호
                          , T2.CNTR_SN           -- 계약일련번호
                          , T2.SV_BIZ_MCLSF_CD   --서비스업무중분류
                          , T2.SV_BIZ_DCLSF_CD   --서비스업무세분류
                          , T1.USE_QTY           -- 사용수량
                          , T2.PRTNR_CLSF_CD     --파트너유형
                          , T2.PRTNR_NO          -- 파트너번호
                          , T2.PRTNR_KNM         -- 파트너한글명
                          , T2.OG_NM             -- 조직명
                          , T1.ITM_PD_CD         -- 품목상품코드
                          , T2.ADR               -- 고객상세주소
                          , T1.BFSVC_REFRI_DV_CD -- 유무상
                          , T2.COPN_DV_CD        -- 법인격구분코드
                          , T2.CUST_NM           --고객명
                     FROM TB_SVST_SV_WK_OSTR_IZ T1
                              INNER JOIN (SELECT E1.CST_SV_ASN_NO
                                               , E1.ASN_OJ_YM       -- 배정대상년월
                                               , E1.CNTR_NO         -- 계약번호
                                               , E1.CNTR_SN         -- 계약일련번호
                                               , E1.SV_BIZ_MCLSF_CD --서비스업무중분류
                                               , E1.SV_BIZ_DCLSF_CD --서비스업무세분류
                                               , M1.PRTNR_CLSF_CD   --파트너유형
                                               , M1.PRTNR_NO        -- 파트너번호
                                               , M1.PRTNR_KNM       -- 파트너한글명
                                               , M1.OG_CD           -- 조직코드
                                               , M1.OG_NM           -- 조직명
                                               , E2.ADR             -- 고객주소상세
                                               , B1.COPN_DV_CD      -- 법인격구분코드
                                               , E2.CUST_NM         -- 고객명
--                                           , (SELECT CSCN_CD
--                                              FROM TB_OGBS_DEPT_BAS M2
--                                              WHERE M2.DEPT_CD = M1.
--                                                       INNER JOIN M1
                                               --                                              ON M2.DEPT_CD = M1.OG_CD) CSCN_CD -- 코스트코드
                                          FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ E1 /* 고객서비스BS배정내역 */
                                                   INNER JOIN (SELECT A1.DTL_CNTR_NO
                                                                    , A1.DTL_CNTR_SN
                                                                    , TRIM(A2.RCGVP_KNM)          AS CUST_NM
                                                                    , A2.ADR_ID
                                                                    , A2.LOCARA_TNO
                                                                    , A2.EXNO_ENCR
                                                                    , A2.IDV_TNO
                                                                    , A2.CRAL_LOCARA_TNO
                                                                    , A2.MEXNO_ENCR
                                                                    , A2.CRAL_IDV_TNO
                                                                    , B2.RNADR || ' ' || B2.RDADR AS ADR
                                                               FROM TB_SSCT_CNTR_ADR_REL A1
                                                                        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS A2
                                                                                   ON A2.CNTR_ADRPC_ID =
                                                                                      A1.CNTR_ADRPC_ID
                                                                                       AND A2.DTA_DL_YN = 'N'
                                                                        INNER JOIN TB_GBCO_ADR_BAS B2
                                                                                   ON A2.ADR_ID = B2.ADR_ID
                                                                                       AND A2.DTA_DL_YN = 'N'
                                                               WHERE 1 = 1
                                                                 AND A1.DTA_DL_YN = 'N'
                                                                 AND A1.ADRPC_TP_CD = '3' /* 설치처 */
                                                                 AND A1.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                                                                 AND A1.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')) E2
                                                              ON E1.CNTR_NO = E2.DTL_CNTR_NO
                                                                  AND E1.CNTR_SN = E2.DTL_CNTR_SN
                                                   INNER JOIN TB_SSCT_CNTR_BAS B1
                                                              ON B1.CNTR_NO = E1.CNTR_NO
                                                   LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ M1 /* 월파트너내역 */
                                                                   ON M1.BASE_YM = E1.ASN_OJ_YM
                                                                       AND M1.OG_TP_CD = E1.CNFM_PSIC_PRTNR_OG_TP_CD
                                                                       AND M1.PRTNR_NO = E1.CNFM_PSIC_PRTNR_NO
                                          WHERE E1.ASN_OJ_YM = #{mgtYnm}) T2 ON T1.CNTR_NO = T2.CNTR_NO
                         AND T1.CNTR_SN = T2.CNTR_SN
                         AND T1.ICHR_PRTNR_NO = T2.PRTNR_NO
                         AND T1.CST_SV_ASN_NO = T2.CST_SV_ASN_NO)
        SELECT SVC.CNTR_NO || '-' || SVC.CNTR_SN AS CNTR_NO
             , ''                                AS DEPT_CD
             , ''                                AS DEPT_NM1
             , ''                                AS CSNR_CD
             , ''                                AS OG_NM
             , SVC.CUST_NM
             , SVC.COPN_DV_CD                    AS COPN_DV_CD
             , PROD.BASE_PD_CD                   AS PD_CD
             , PROD.BASE_PD_NM                   AS PD_NM
             , SVC.SV_BIZ_MCLSF_CD
             , SVC.SV_BIZ_DCLSF_CD
             , PROD.SAP_MAT_CD
             , PROD.PD_CD                        AS PART_PD_CD
             , PROD.PD_NM                        AS PART_PD_NM
             , SVC.USE_QTY
             , PROD.PDCT_UPRC
             , PROD.PDCT_UPRC * SVC.USE_QTY      AS PDCT_UPRC_SUM     -- 원가합계
             , PROD.CSMR_UPRC_AMT
             , PROD.CSMR_UPRC_AMT * SVC.USE_QTY  AS CSMR_UPRC_AMT_SUM --소비자합계
             , SVC.BFSVC_REFRI_DV_CD             AS REFRI_DV_CD
             , SVC.PRTNR_CLSF_CD                 AS WRK_PRTNR_CLSF_CD
             , SVC.PRTNR_NO                      AS WRK_PRTNR_NO
             , SVC.PRTNR_KNM                     AS WRK_PRTNR_KNM
             , SVC.OG_NM                         AS WRK_OG_NM
             , SVC.ADR                           AS CST_ADR
        FROM PROD
                 INNER JOIN SVC
                            ON PROD.PD_CD = SVC.ITM_PD_CD
    </select>

    <select id="selectCompanyIstStateSubMat"
            resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncCompanyIstStateDto$SearchAllRes">
        WITH PROD AS (SELECT P3.BASE_PD_CD    -- 상품코드
                           , (SELECT PD_NM FROM TB_PDBS_PD_BAS A WHERE A.PD_CD = P3.BASE_PD_CD) AS BASE_PD_NM
                           , P1.PD_CD         -- 부품코드
                           , P1.PD_NM         -- 부품명
                           , P1.SAP_MAT_CD    --SAP 자재코드
                           , P1.PDCT_UPRC     -- 제품단가
                           , P3.CSMR_UPRC_AMT -- 소비자단가
                      FROM TB_PDBS_PD_BAS P1 /* 상품기본 */
                               INNER JOIN TB_SVPD_RCAS_ITM_PRC_IZ P3 /* 유상AS품목가격내역 */
                                          ON P1.PD_CD = P3.USE_MAT_PD_CD)
           , SVC AS (SELECT T2.CST_SV_ASN_NO     -- 고객서비스배정번호
                          , T2.ASN_OJ_YM         -- 배정대상년월
                          , T2.CNTR_NO           -- 계약번호
                          , T2.CNTR_SN           -- 계약일련번호
                          , T2.SV_BIZ_MCLSF_CD   --서비스업무중분류
                          , T2.SV_BIZ_DCLSF_CD   --서비스업무세분류
                          , T1.USE_QTY           -- 사용수량
                          , T2.PRTNR_CLSF_CD     --파트너유형
                          , T2.PRTNR_NO          -- 파트너번호
                          , T2.PRTNR_KNM         -- 파트너한글명
                          , T2.OG_NM             -- 조직명
                          , T1.ITM_PD_CD         -- 품목상품코드
                          , T2.ADR               -- 고객상세주소
                          , T1.BFSVC_REFRI_DV_CD -- 유무상
                          , T2.COPN_DV_CD        -- 법인격구분코드
                          , T2.CUST_NM           --고객명
                     FROM TB_SVST_SV_WK_OSTR_IZ T1
                              INNER JOIN (SELECT E1.CST_SV_ASN_NO
                                               , E1.ASN_OJ_YM       -- 배정대상년월
                                               , E1.CNTR_NO         -- 계약번호
                                               , E1.CNTR_SN         -- 계약일련번호
                                               , E1.SV_BIZ_MCLSF_CD --서비스업무중분류
                                               , E1.SV_BIZ_DCLSF_CD --서비스업무세분류
                                               , M1.PRTNR_CLSF_CD   --파트너유형
                                               , M1.PRTNR_NO        -- 파트너번호
                                               , M1.PRTNR_KNM       -- 파트너한글명
                                               , M1.OG_CD           -- 조직코드
                                               , M1.OG_NM           -- 조직명
                                               , E2.ADR             -- 고객주소상세
                                               , B1.COPN_DV_CD      -- 법인격구분코드
                                               , E2.CUST_NM         -- 고객명
--                                           , (SELECT CSCN_CD
--                                              FROM TB_OGBS_DEPT_BAS M2
--                                              WHERE M2.DEPT_CD = M1.
--                                                       INNER JOIN M1
                                               --                                              ON M2.DEPT_CD = M1.OG_CD) CSCN_CD -- 코스트코드
                                          FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ E1 /* 고객서비스BS배정내역 */
                                                   INNER JOIN (SELECT A1.DTL_CNTR_NO
                                                                    , A1.DTL_CNTR_SN
                                                                    , TRIM(A2.RCGVP_KNM)          AS CUST_NM
                                                                    , A2.ADR_ID
                                                                    , A2.LOCARA_TNO
                                                                    , A2.EXNO_ENCR
                                                                    , A2.IDV_TNO
                                                                    , A2.CRAL_LOCARA_TNO
                                                                    , A2.MEXNO_ENCR
                                                                    , A2.CRAL_IDV_TNO
                                                                    , B2.RNADR || ' ' || B2.RDADR AS ADR
                                                               FROM TB_SSCT_CNTR_ADR_REL A1
                                                                        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS A2
                                                                                   ON A2.CNTR_ADRPC_ID =
                                                                                      A1.CNTR_ADRPC_ID
                                                                                       AND A2.DTA_DL_YN = 'N'
                                                                        INNER JOIN TB_GBCO_ADR_BAS B2
                                                                                   ON A2.ADR_ID = B2.ADR_ID
                                                                                       AND A2.DTA_DL_YN = 'N'
                                                               WHERE 1 = 1
                                                                 AND A1.DTA_DL_YN = 'N'
                                                                 AND A1.ADRPC_TP_CD = '3' /* 설치처 */
                                                                 AND A1.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                                                                 AND A1.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')) E2
                                                              ON E1.CNTR_NO = E2.DTL_CNTR_NO
                                                                  AND E1.CNTR_SN = E2.DTL_CNTR_SN
                                                   INNER JOIN TB_SSCT_CNTR_BAS B1
                                                              ON B1.CNTR_NO = E1.CNTR_NO
                                                   LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ M1 /* 월파트너내역 */
                                                                   ON M1.BASE_YM = E1.ASN_OJ_YM
                                                                       AND M1.OG_TP_CD = E1.CNFM_PSIC_PRTNR_OG_TP_CD
                                                                       AND M1.PRTNR_NO = E1.CNFM_PSIC_PRTNR_NO
                                          WHERE E1.ASN_OJ_YM = #{mgtYnm}) T2 ON T1.CNTR_NO = T2.CNTR_NO
                         AND T1.CNTR_SN = T2.CNTR_SN
                         AND T1.ICHR_PRTNR_NO = T2.PRTNR_NO
                         AND T1.CST_SV_ASN_NO = T2.CST_SV_ASN_NO)
        SELECT SVC.CNTR_NO || '-' || SVC.CNTR_SN AS CNTR_NO
             , ''                                AS DEPT_CD
             , ''                                AS DEPT_NM1
             , ''                                AS CSNR_CD
             , ''                                AS OG_NM
             , SVC.CUST_NM
             , SVC.COPN_DV_CD                    AS COPN_DV_CD
             , PROD.BASE_PD_CD                   AS PD_CD
             , PROD.BASE_PD_NM                   AS PD_NM
             , SVC.SV_BIZ_MCLSF_CD
             , SVC.SV_BIZ_DCLSF_CD
             , PROD.SAP_MAT_CD
             , PROD.PD_CD                        AS PART_PD_CD
             , PROD.PD_NM                        AS PART_PD_NM
             , SVC.USE_QTY
             , PROD.PDCT_UPRC
             , PROD.PDCT_UPRC * SVC.USE_QTY      AS PDCT_UPRC_SUM     -- 원가합계
             , PROD.CSMR_UPRC_AMT
             , PROD.CSMR_UPRC_AMT * SVC.USE_QTY  AS CSMR_UPRC_AMT_SUM --소비자합계
             , SVC.BFSVC_REFRI_DV_CD             AS REFRI_DV_CD
             , SVC.PRTNR_CLSF_CD                 AS WRK_PRTNR_CLSF_CD
             , SVC.PRTNR_NO                      AS WRK_PRTNR_NO
             , SVC.PRTNR_KNM                     AS WRK_PRTNR_KNM
             , SVC.OG_NM                         AS WRK_OG_NM
             , SVC.ADR                           AS CST_ADR
        FROM PROD
                 INNER JOIN SVC
                            ON PROD.PD_CD = SVC.ITM_PD_CD
    </select>

    <select id="selectCompanyIstStatePs"
            resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncCompanyIstStateDto$SearchAllRes">
        WITH PROD AS (SELECT P3.BASE_PD_CD    -- 상품코드
                           , (SELECT PD_NM FROM TB_PDBS_PD_BAS A WHERE A.PD_CD = P3.BASE_PD_CD) AS BASE_PD_NM
                           , P1.PD_CD         -- 부품코드
                           , P1.PD_NM         -- 부품명
                           , P1.SAP_MAT_CD    --SAP 자재코드
                           , P1.PDCT_UPRC     -- 제품단가
                           , P3.CSMR_UPRC_AMT -- 소비자단가
                      FROM TB_PDBS_PD_BAS P1 /* 상품기본 */
                               INNER JOIN TB_SVPD_RCAS_ITM_PRC_IZ P3 /* 유상AS품목가격내역 */
                                          ON P1.PD_CD = P3.USE_MAT_PD_CD)
           , SVC AS (SELECT T2.CST_SV_ASN_NO     -- 고객서비스배정번호
                          , T2.ASN_OJ_YM         -- 배정대상년월
                          , T2.CNTR_NO           -- 계약번호
                          , T2.CNTR_SN           -- 계약일련번호
                          , T2.SV_BIZ_MCLSF_CD   --서비스업무중분류
                          , T2.SV_BIZ_DCLSF_CD   --서비스업무세분류
                          , T1.USE_QTY           -- 사용수량
                          , T2.PRTNR_CLSF_CD     --파트너유형
                          , T2.PRTNR_NO          -- 파트너번호
                          , T2.PRTNR_KNM         -- 파트너한글명
                          , T2.OG_NM             -- 조직명
                          , T1.ITM_PD_CD         -- 품목상품코드
                          , T2.ADR               -- 고객상세주소
                          , T1.BFSVC_REFRI_DV_CD -- 유무상
                          , T2.COPN_DV_CD        -- 법인격구분코드
                          , T2.CUST_NM           --고객명
                     FROM TB_SVST_SV_WK_OSTR_IZ T1
                              INNER JOIN (SELECT E1.CST_SV_ASN_NO
                                               , E1.ASN_OJ_YM       -- 배정대상년월
                                               , E1.CNTR_NO         -- 계약번호
                                               , E1.CNTR_SN         -- 계약일련번호
                                               , E1.SV_BIZ_MCLSF_CD --서비스업무중분류
                                               , E1.SV_BIZ_DCLSF_CD --서비스업무세분류
                                               , M1.PRTNR_CLSF_CD   --파트너유형
                                               , M1.PRTNR_NO        -- 파트너번호
                                               , M1.PRTNR_KNM       -- 파트너한글명
                                               , M1.OG_CD           -- 조직코드
                                               , M1.OG_NM           -- 조직명
                                               , E2.ADR             -- 고객주소상세
                                               , B1.COPN_DV_CD      -- 법인격구분코드
                                               , E2.CUST_NM         -- 고객명
--                                           , (SELECT CSCN_CD
--                                              FROM TB_OGBS_DEPT_BAS M2
--                                              WHERE M2.DEPT_CD = M1.
--                                                       INNER JOIN M1
                                               --                                              ON M2.DEPT_CD = M1.OG_CD) CSCN_CD -- 코스트코드
                                          FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ E1 /* 고객서비스BS배정내역 */
                                                   INNER JOIN (SELECT A1.DTL_CNTR_NO
                                                                    , A1.DTL_CNTR_SN
                                                                    , TRIM(A2.RCGVP_KNM)          AS CUST_NM
                                                                    , A2.ADR_ID
                                                                    , A2.LOCARA_TNO
                                                                    , A2.EXNO_ENCR
                                                                    , A2.IDV_TNO
                                                                    , A2.CRAL_LOCARA_TNO
                                                                    , A2.MEXNO_ENCR
                                                                    , A2.CRAL_IDV_TNO
                                                                    , B2.RNADR || ' ' || B2.RDADR AS ADR
                                                               FROM TB_SSCT_CNTR_ADR_REL A1
                                                                        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS A2
                                                                                   ON A2.CNTR_ADRPC_ID =
                                                                                      A1.CNTR_ADRPC_ID
                                                                                       AND A2.DTA_DL_YN = 'N'
                                                                        INNER JOIN TB_GBCO_ADR_BAS B2
                                                                                   ON A2.ADR_ID = B2.ADR_ID
                                                                                       AND A2.DTA_DL_YN = 'N'
                                                               WHERE 1 = 1
                                                                 AND A1.DTA_DL_YN = 'N'
                                                                 AND A1.ADRPC_TP_CD = '3' /* 설치처 */
                                                                 AND A1.VL_STRT_DTM <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                                                                 AND A1.VL_END_DTM <![CDATA[>=]]> TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')) E2
                                                              ON E1.CNTR_NO = E2.DTL_CNTR_NO
                                                                  AND E1.CNTR_SN = E2.DTL_CNTR_SN
                                                   INNER JOIN TB_SSCT_CNTR_BAS B1
                                                              ON B1.CNTR_NO = E1.CNTR_NO
                                                   LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ M1 /* 월파트너내역 */
                                                                   ON M1.BASE_YM = E1.ASN_OJ_YM
                                                                       AND M1.OG_TP_CD = E1.CNFM_PSIC_PRTNR_OG_TP_CD
                                                                       AND M1.PRTNR_NO = E1.CNFM_PSIC_PRTNR_NO
                                          WHERE E1.ASN_OJ_YM = #{mgtYnm}) T2 ON T1.CNTR_NO = T2.CNTR_NO
                         AND T1.CNTR_SN = T2.CNTR_SN
                         AND T1.ICHR_PRTNR_NO = T2.PRTNR_NO
                         AND T1.CST_SV_ASN_NO = T2.CST_SV_ASN_NO)
        SELECT SVC.CNTR_NO || '-' || SVC.CNTR_SN AS CNTR_NO
             , ''                                AS DEPT_CD
             , ''                                AS DEPT_NM1
             , ''                                AS CSNR_CD
             , ''                                AS OG_NM
             , SVC.CUST_NM
             , SVC.COPN_DV_CD                    AS COPN_DV_CD
             , PROD.BASE_PD_CD                   AS PD_CD
             , PROD.BASE_PD_NM                   AS PD_NM
             , SVC.SV_BIZ_MCLSF_CD
             , SVC.SV_BIZ_DCLSF_CD
             , PROD.SAP_MAT_CD
             , PROD.PD_CD                        AS PART_PD_CD
             , PROD.PD_NM                        AS PART_PD_NM
             , SVC.USE_QTY
             , PROD.PDCT_UPRC
             , PROD.PDCT_UPRC * SVC.USE_QTY      AS PDCT_UPRC_SUM     -- 원가합계
             , PROD.CSMR_UPRC_AMT
             , PROD.CSMR_UPRC_AMT * SVC.USE_QTY  AS CSMR_UPRC_AMT_SUM --소비자합계
             , SVC.BFSVC_REFRI_DV_CD             AS REFRI_DV_CD
             , SVC.PRTNR_CLSF_CD                 AS WRK_PRTNR_CLSF_CD
             , SVC.PRTNR_NO                      AS WRK_PRTNR_NO
             , SVC.PRTNR_KNM                     AS WRK_PRTNR_KNM
             , SVC.OG_NM                         AS WRK_OG_NM
             , SVC.ADR                           AS CST_ADR
        FROM PROD
                 INNER JOIN SVC
                            ON PROD.PD_CD = SVC.ITM_PD_CD
    </select>
</mapper>
