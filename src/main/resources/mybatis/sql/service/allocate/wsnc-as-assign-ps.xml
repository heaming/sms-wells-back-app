<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncAsAssignPsMapper">

    <select id="selectTotalCustomers" resultType="com.kyowon.sms.wells.web.service.allocate.dvo.WsncAsAssTotalCustomerDvo">
    SELECT YYYY||'년' AS YYYY    -- 년
         , TYP                -- 구분
         , (SELECT CD_CNTN FROM T_CMZ_CD_D WHERE TENANT_ID ='TNT_WELLS' AND CD_ID='SELL_TP_CD' AND CD_VLD_VAL = TYP) AS TYP_NM
         , SUM(DECODE(MM, '01', 1)) AS ACOL1     -- 1
         , SUM(DECODE(MM, '02', 1)) AS ACOL2     -- 2
         , SUM(DECODE(MM, '03', 1)) AS ACOL3     -- 3
         , SUM(DECODE(MM, '04', 1)) AS ACOL4     -- 4
         , SUM(DECODE(MM, '05', 1)) AS ACOL5     -- 5
         , SUM(DECODE(MM, '06', 1)) AS ACOL6     -- 6
         , SUM(DECODE(MM, '07', 1)) AS ACOL7     -- 7
         , SUM(DECODE(MM, '08', 1)) AS ACOL8     -- 8
         , SUM(DECODE(MM, '09', 1)) AS ACOL9     -- 9
         , SUM(DECODE(MM, '10', 1)) AS ACOL10    -- 10
         , SUM(DECODE(MM, '11', 1)) AS ACOL11    -- 11
         , SUM(DECODE(MM, '12', 1)) AS ACOL12    -- 12
         , COUNT(*) AS TCNT
      FROM (
            SELECT S1.SELL_TP_CD AS TYP
                 , SUBSTR(S1.MNGT_YM, 0, 4) AS YYYY
                 , SUBSTR(S1.MNGT_YM, 5,2) MM
                 , S1.BASE_PD_CD
                 , SUBSTR(S1.BASE_PD_CD, 0, 5) AS PD_CD_5
                 , SUBSTR(S1.BASE_PD_CD, 6) AS PD_CD_6
                 , S1.MNGT_YM
              FROM TB_SVPD_MCBY_CST_SV_OJ_IZ S1
                 , (SELECT X.PD_CD
                         , Y.PD_PRP_VAL20 AS PD_GRP_CD
                      FROM TB_PDBS_PD_BAS X
                         , TB_PDBS_PD_ECOM_PRP_DTL Y
                     WHERE X.PD_CD = Y.PD_CD
                       AND Y.PD_EXTS_PRP_GRP_CD = 'PART'
                   ) P1
             WHERE 1=1
               AND S1.PDCT_PD_CD = P1.PD_CD
             <if test="@MybatisUtils@isNotEmpty(year)">
               AND S1.MNGT_YM LIKE #{year} || '%'
             </if>
             <if test="@MybatisUtils@isNotEmpty(pdGrpCd)">
               AND P1.PD_GRP_CD = #{pdGrpCd}
             </if>
             <if test="@MybatisUtils@isNotEmpty(pdCd)">
               AND S1.PDCT_PD_CD = #{pdCd}
             </if>
      )
    GROUP BY YYYY, TYP
    ORDER BY TYP
    </select>

    <select id='selectProductServices' resultType="com.kyowon.sms.wells.web.service.allocate.dvo.WsncAsAssProductServicesDvo">
        SELECT SUBSTR(T1.YYYYMM, 1, 4) AS WK_EXCN_DT
             , T1.SV_BIZ_HCLSF_CD
             , CASE WHEN T1.SV_BIZ_HCLSF_CD = '1B' THEN '필터' ELSE F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_HCLSF_CD', T1.SV_BIZ_HCLSF_CD) END SV_BIZ_HCLSF_NM
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '01' THEN CNT ELSE 0 END) ACOL1
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '02' THEN CNT ELSE 0 END) ACOL2
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '03' THEN CNT ELSE 0 END) ACOL3
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '04' THEN CNT ELSE 0 END) ACOL4
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '05' THEN CNT ELSE 0 END) ACOL5
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '06' THEN CNT ELSE 0 END) ACOL6
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '07' THEN CNT ELSE 0 END) ACOL7
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '08' THEN CNT ELSE 0 END) ACOL8
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '09' THEN CNT ELSE 0 END) ACOL9
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '10' THEN CNT ELSE 0 END) ACOL10
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '11' THEN CNT ELSE 0 END) ACOL11
             , SUM(CASE WHEN SUBSTR(T1.YYYYMM,5,2) = '12' THEN CNT ELSE 0 END) ACOL12
             , SUM(CNT) TOTAL_COUNT
          FROM (
                SELECT /*+ index(S2 IX_SVPD_CST_SVAS_IST_OJ_IZ_01) use_nl(S1 S2) */
                       CASE WHEN S2.SV_BIZ_HCLSF_CD = '1' AND S2.SV_BIZ_DCLSF_CD LIKE '11%' THEN '1'
                            WHEN S2.SV_BIZ_HCLSF_CD = '1' AND S2.SV_BIZ_DCLSF_CD LIKE '13%' THEN '1B'
                            WHEN S2.SV_BIZ_HCLSF_CD = '3' THEN '3'
                        END SV_BIZ_HCLSF_CD
                     , SUBSTR(S1.WK_EXCN_DT,1,6) as YYYYMM
                     , COUNT(1) CNT
                  FROM TB_SVPD_CST_SVAS_IST_ASN_IZ S1 /* 고객서비스AS설치배정내역 */
                 INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ S2 /* 고객서비스AS설치대상내역 */
                    ON S1.CST_SV_ASN_NO = S2.CST_SV_ASN_NO
                   AND S1.CNTR_NO = S2.CNTR_NO
                   AND S1.CNTR_SN = S2.CNTR_SN
                 WHERE S1.DTA_DL_YN = 'N'
                   AND S2.DTA_DL_YN = 'N'
                   AND S1.WK_PRGS_STAT_CD = '20'
                   AND S1.WK_EXCN_DT LIKE #{wkExcnDt} || '%'
                   AND (S2.SV_BIZ_HCLSF_CD = '1' OR ( S2.SV_BIZ_HCLSF_CD = '3' AND SUBSTR(S2.SV_BIZ_DCLSF_CD, 1, 2) IN ('31', '32', '33', '34') ))
                   AND S2.PD_CD IN (SELECT X1.PD_CD
                                      FROM TB_PDBS_PD_ECOM_PRP_DTL X1 /* 상품각사속성상세 */
                                     WHERE X1.DTA_DL_YN = 'N'
                                       AND X1.PD_EXTS_PRP_GRP_CD = 'PART'
                                       <if test="@MybatisUtils@isNotEmpty(pdGrpCd)">
                                       AND X1.PD_PRP_VAL20 = #{pdGrpCd}
                                       </if>
                                       <if test="@MybatisUtils@isNotEmpty(pdCd)">
                                       AND X1.PD_CD = #{pdCd}
                                       </if>
                                   )
                 GROUP BY CASE WHEN S2.SV_BIZ_HCLSF_CD = '1' AND S2.SV_BIZ_DCLSF_CD LIKE '11%' THEN '1'
                               WHEN S2.SV_BIZ_HCLSF_CD = '1' AND S2.SV_BIZ_DCLSF_CD LIKE '13%' THEN '1B'
                               WHEN S2.SV_BIZ_HCLSF_CD = '3' THEN '3'
                           END
                        , SUBSTR(S1.WK_EXCN_DT,1,6)
                 UNION ALl
                SELECT /*+ index(S2 IX_SVPD_CST_SV_BFSVC_OJ_IZ_01) use_nl(S1 S2) */
                       '2' SV_BIZ_HCLSF_CD
                     , SUBSTR(S1.WK_EXCN_DT, 1,6) AS YYYYMM
                     , COUNT(1) CNT
                  FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ S1 /* 고객서비스BS배정내역 */
                 INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ S2 /* 고객서비스BS대상내역 */
                    ON S1.CST_SV_ASN_NO = S2.CST_SV_ASN_NO
                 WHERE S1.DTA_DL_YN = 'N'
                   AND S2.DTA_DL_YN = 'N'
                   AND S1.VST_PRGS_STAT_CD = '20'
                   AND S2.PDCT_PD_CD != 'WM05100245' /* 드라이온+ KW-F01W1 */
                   AND S1.WK_EXCN_DT LIKE #{wkExcnDt} || '%'
                   <if test="@MybatisUtils@isNotEmpty(mngrDvCd)">
                   AND S1.CNFM_PSIC_DV_CD = #{mngrDvCd}
                   </if>
                   AND S2.PDCT_PD_CD IN (SELECT X1.PD_CD
                                           FROM TB_PDBS_PD_ECOM_PRP_DTL X1 /* 상품각사속성상세 */
                                          WHERE X1.DTA_DL_YN = 'N'
                                            AND X1.PD_EXTS_PRP_GRP_CD = 'PART'
                                            <if test="@MybatisUtils@isNotEmpty(pdGrpCd)">
                                            AND X1.PD_PRP_VAL20 = #{pdGrpCd}
                                            </if>
                                            <if test="@MybatisUtils@isNotEmpty(pdCd)">
                                            AND X1.PD_CD = #{pdCd}
                                            </if>
                                        )
                 GROUP BY SUBSTR(S1.WK_EXCN_DT, 1, 6)
             ) T1
         GROUP BY SUBSTR(T1.YYYYMM, 1, 4), T1.SV_BIZ_HCLSF_CD
         ORDER BY T1.SV_BIZ_HCLSF_CD
    </select>

</mapper>
