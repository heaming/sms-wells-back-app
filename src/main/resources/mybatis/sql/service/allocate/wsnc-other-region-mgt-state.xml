<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncOtherRegionMgtStateMapper">
    <select id="selectOtherRegionMgtState"
            resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncOtherRegionMgtStateDto$SearchRes">
        WITH ADR_INF AS ( SELECT TB_GBCO_ADR_BAS.ADR_ID
                               , TB_GBCO_ADR_BAS.NEW_ADR_ZIP
                               , TB_GBCO_ADR_BAS.RNADR
                               , TB_GBCO_ADR_BAS.RDADR
                               , TB_GBCO_ADR_BAS.LTN_ADR
                            FROM TB_GBCO_ADR_BAS
                      INNER JOIN TB_GBCO_ZIP_BAS
                              ON TB_GBCO_ADR_BAS.NEW_ADR_ZIP = TB_GBCO_ZIP_BAS.NEW_ADR_ZIP
        )
        SELECT MAIN.*
          FROM ( SELECT O3.OG_NM AS MNGT_RGNL_GRP_NM /* 관리지역단 */
                      , O3.OG_CD AS MNGT_RGNL_GRP_CD
                      , T2.BRCH_OG_ID /* 관리지역단 ID */
                      , T1.CNTR_NO||'-'||T1.CNTR_SN AS CNTR_NO
                      , C1.RCGVP_KNM AS CST_KNM
                      , A2.NEW_ADR_ZIP
                      , A2.RNADR || ' ' || A2.RDADR AS CST_ADR
                      , A2.LTN_ADR /* 읍면동 */
                      , C1.CRAL_LOCARA_TNO
                      , C1.MEXNO_ENCR
                      , C1.CRAL_IDV_TNO
                      , O2.HGR_OG_ID AS VST_GNLR_GRP_OG_ID /* 방문 총괄단 OG_ID */
                      , O2.OG_ID AS VST_RGNL_GRP_OG_ID /* 방문 지역단 OG_ID */
                      , O2.OG_NM AS VST_RGNL_GRP_OG_NM -- 방문 지역단 OG_NM */
                      , M1.OG_ID /* 매니저 지점 ID */
                      , M1.OG_CD /* 매니저 지점 CD */
                      , M1.OG_NM /* 매니저 지점 */
                      , T1.MNGT_PRTNR_NO /* 사번 */
                      , M1.PRTNR_KNM /* 매니저명 */
                      , B1.BLD_NM /* 빌딩명 */
                      , T1.FXN_PRTNR_YN /* 구분 */
                      , F_CMZ_CD_NM('TNT_WELLS', 'MNGER_RGLVL_DV_CD', T1.MNGER_RGLVL_DV_CD, 'ko') AS MNGER_RGLVL_DV_CD /* 급지 */
                  FROM TB_SVPD_MCBY_CST_SV_OJ_IZ T1 /* 월별고객서비스대상내역 AC202 */
            INNER JOIN TB_SSCT_CNTR_DTL C3
                    ON T1.CNTR_NO = C3.CNTR_NO
                   AND T1.CNTR_SN = C3.CNTR_SN
                   AND T1.MNGT_YM = #{mgtYnm}
            INNER JOIN ADR_INF A2 /* 주소 기본 */
                    ON T1.ADR_ID = A2.ADR_ID
            INNER JOIN ( SELECT NEW_ADR_ZIP
                              , MNGER_RGLVL_DV_CD
                              , MNGR_DV_CD
                              , BRCH_OG_ID
                              , MAX(CH_SN)
                           FROM TB_SVPD_LOCARA_BFSVC_OGMGR_IZ
                          WHERE 1=1
                            AND USE_YN = 'Y'
                            AND MNGR_DV_CD IS NOT NULL
                       GROUP BY NEW_ADR_ZIP
                              , MNGER_RGLVL_DV_CD
                              , MNGR_DV_CD
                              , BRCH_OG_ID
                    ) T2 /* 지역BS조직매니저내역 */
                    ON T2.NEW_ADR_ZIP = A2.NEW_ADR_ZIP
                   AND T2.MNGR_DV_CD IS NOT NULL
            INNER JOIN TB_SSCT_CNTR_ADR_REL C2
                    ON T1.CNTR_NO = C2.DTL_CNTR_NO
                   AND T1.CNTR_SN  = C2.DTL_CNTR_SN
                   AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN C2.VL_STRT_DTM AND C2.VL_END_DTM
                   AND C2.DTA_DL_YN = 'N'
                   AND C2.ADRPC_TP_CD IN ('2','3') /*1 계약주소, 2 배달주소, 3 설치주소*/
            INNER JOIN TB_SSCT_CNTR_ADRPC_BAS C1
                    ON T1.CNTR_CST_NO = C1.CNTR_CST_NO
                   AND T1.CNTR_NO = C1.CNTR_NO
                   AND T1.ADR_ID = C1.ADR_ID
                   AND C1.CNTR_ADRPC_ID = C2.CNTR_ADRPC_ID
                   AND C1.DTA_DL_YN = 'N'
            INNER JOIN TB_OGBS_MM_PRTNR_IZ M1
                    ON T1.MNGT_YM = M1.BASE_YM
                   AND T1.MNGT_PRTNR_OG_TP_CD = M1.OG_TP_CD
                   AND T1.MNGT_PRTNR_NO = M1.PRTNR_NO
           INNER  JOIN TB_OGBS_OG_BAS O1 /* 방문 매니저 조직 */
                    ON O1.OG_ID = M1.OG_ID
                   AND O1.OG_TP_CD = M1.OG_TP_CD
           INNER  JOIN TB_OGBS_BLD_BAS B1 /* 방문 매니저 빌딩 */
                    ON B1.OG_TP_CD = O1.OG_TP_CD
                   AND B1.BLD_CD = O1.BLD_CD
           INNER  JOIN TB_OGBS_OG_BAS O2 /* 방문 매니저 지역단 */
                    ON O1.HGR_OG_ID = O2.OG_ID
                   AND O1.OG_TP_CD = O2.OG_TP_CD
            INNER JOIN TB_OGBS_OG_BAS O3 /* 관리 지역단 */
                    ON T2.BRCH_OG_ID = O3.OG_ID
                   AND O3.OG_TP_CD = T1.MNGT_PRTNR_OG_TP_CD
                 WHERE 1 = 1
                   AND T1.MNGT_YM = #{mgtYnm}
                   AND M1.BASE_YM = #{mgtYnm}
                   AND C3.SELL_TP_CD != '9'
                   AND T1.CAN_DT IS NULL
                   AND T1.REQD_DT IS NULL
                   AND T1.SV_STP_DT IS NULL
                   AND T1.MSH_WDWAL_DT IS NULL
                   AND T1.MNGT_PRTNR_NO IS NOT NULL
                   AND T1.CNTR_DTL_STAT_CD = '101'
                   AND T2.BRCH_OG_ID != O1.HGR_OG_ID
        ) MAIN
        WHERE 1=1
        <if test="@MybatisUtils@isNotEmpty(mgtDept)"> /* 방문총괄단 */
          AND MAIN.VST_GNLR_GRP_OG_ID = #{mgtDept}
        </if>
        <if test="@MybatisUtils@isNotEmpty(rgnlGrp)"> /* 방문지역단 */
          AND MAIN.VST_RGNL_GRP_OG_ID = #{rgnlGrp}
        </if>
        <if test="@MybatisUtils@isNotEmpty(branch)"> /* 지점 */
          AND MAIN.OG_ID = #{branch}
        </if>
        <if test="@MybatisUtils@isNotEmpty(zipFrom) or @MybatisUtils@isNotEmpty(zipTo)">
          AND MAIN.NEW_ADR_ZIP BETWEEN LPAD(SUBSTR(NVL(#{zipFrom}, '00000'), 1, 5), 5, '0') AND LPAD(SUBSTR(NVL(#{zipTo}, '99999'), 1, 5), 5, '0')
        </if>
     ORDER BY MNGT_RGNL_GRP_CD
    </select>

</mapper>
