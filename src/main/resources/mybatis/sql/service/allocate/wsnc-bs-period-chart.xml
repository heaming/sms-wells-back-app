<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncBsPeriodChartMapper">
    <select id="selectPeriodChartBaseInfo"
            resultType="com.kyowon.sms.wells.web.service.allocate.dvo.WsncBsPeriodChartResDvo">
        /* -> V_AC201_BS_GB1 */
        /* BFSVC_SPP_STP_RSON_CD != '00'일 경우 Process End! */
        SELECT TB_1.CNTR_NO
             , TB_1.CNTR_SN
             , TB_2.BFSVC_SPP_STP_RSON_CD
             , TB_2.STVLV_CHNG_DT
             , TB_3.SELL_TP_CD
             , TB_2.SV_PD_CD
             , TB_2.PDCT_PD_CD
             , TB_4.IST_DT
             , CEIL(MONTHS_BETWEEN(SUBSTR(TB_3.CNTR_PD_STRTDT,1,6)||'01',SUBSTR(TB_4.IST_DT,1,6)||'01')) AS CHEK_INST_MTHS
             , CEIL(MONTHS_BETWEEN(SUBSTR(TO_CHAR(SYSDATE, 'YYYYMMDD'),1,6)||'01',SUBSTR(TB_4.IST_DT,1,6)||'01')) AS CHEK_INST_MTHS_BS04
             , (
                 CASE WHEN TB_3.SELL_TP_CD = 3 THEN TB_3.CNTR_PD_STRTDT
                      ELSE ''
                      END
               ) AS CNTR_PD_STRTDT
          FROM TB_SVPD_CNTR_PDCT_IST_LCT_DTL TB_1
         INNER JOIN TB_SVPD_CST_SV_EXCN_IZ TB_2
         ON (
                TB_1.CNTR_NO = TB_2.CNTR_NO
            AND TB_1.CNTR_SN = TB_2.CNTR_SN
         )
         INNER JOIN TB_SSCT_CNTR_DTL TB_3
         ON (
                TB_1.CNTR_NO = TB_3.CNTR_NO
            AND TB_1.CNTR_SN = TB_3.CNTR_SN
         )
         INNER JOIN TB_SSCT_CNTR_WELLS_DTL TB_4
         ON (
                TB_1.CNTR_NO = TB_4.CNTR_NO
            AND TB_1.CNTR_SN = TB_4.CNTR_SN
         )
         WHERE 1=1
           AND TB_1.CNTR_NO = #{cntrNo}
           AND TB_1.CNTR_SN = #{cntrSn}
    </select>

    <select id="selectBsPeriodChartBs03_02" resultType="java.lang.String">
        /* 로직 미확정 */
        /* -> CHEK_COCK_YN */
        SELECT NVL(
                   (SELECT 'Y'
                      FROM LC_ALLOCATE_AC201TB
                     WHERE 1=1
                       AND AC201_CSMR_YR = P_CSMR_YR
                       AND AC201_CSMR_CD = P_CSMR_CD
                       AND AC201_CSMR_SEQ = P_CSMR_SEQ
                       AND AC201_GDS_CD IN ('42240000000', '42251000000' , '42261000000')
                       AND AC201_BARCODE NOT LIKE '8%'  --8로 시작하는 바코드 체계를 분석할 방법이 없음
                       AND (CASE /*교원재발행 바코드 --47246건*/
                                 WHEN SUBSTR(AC201_BARCODE,5,2) = 'ZZ' THEN SUBSTR(AC201_BARCODE,7,6) || LPAD(SUBSTR(AC201_BARCODE,13,4),5, '0')
                                 /*교원재발행 바코드가 아니고 16자리인 바코드 --56401건*/
                                 WHEN SUBSTR(AC201_BARCODE,5,2) != 'ZZ' AND LENGTH(AC201_BARCODE) = 16 THEN SUBSTR(AC201_INST_DT,3,6) || LPAD(SUBSTR(AC201_BARCODE,13,4),5,'0')
                                 /*18자리 바코드 인데 10번째 자리(년도)가 영문이 아닌 건 --13건 */
                                 WHEN LENGTH(AC201_BARCODE) = 18 AND SUBSTR(AC201_BARCODE,10,1) NOT IN ('A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z') THEN SUBSTR(AC201_INST_DT,3,6) || LPAD(SUBSTR(AC201_BARCODE,15,4),5,'0')
                                 /*18자리 정상 바코드인건*/
                                 WHEN LENGTH(AC201_BARCODE) = 18 THEN (CASE SUBSTR(AC201_BARCODE,LENGTH(AC201_BARCODE)-8,1) WHEN 'A' THEN '09'
                                                                                                                            WHEN 'B' THEN '10'
                                                                                                                            WHEN 'C' THEN '11'
                                                                                                                            WHEN 'D' THEN '12'
                                                                                                                            WHEN 'E' THEN '13'
                                                                                                                            WHEN 'F' THEN '14'
                                                                                                                            WHEN 'G' THEN '15'
                                                                                                                            WHEN 'H' THEN '16'
                                                                                                                            WHEN 'J' THEN '17'
                                                                                                                            WHEN 'K' THEN '18'
                                                                                                                            WHEN 'L' THEN '19'
                                                                                                                            WHEN 'M' THEN '20'
                                                                                                                            WHEN 'N' THEN '21'
                                                                                                                            ELSE SUBSTR(AC201_BARCODE,LENGTH(AC201_BARCODE)-8,1)
                                                                       END) ||
                                                                               (CASE SUBSTR(AC201_BARCODE,LENGTH(AC201_BARCODE)-7,1) WHEN 'A' THEN '10'
                                                                                                                                     WHEN 'B' THEN '11'
                                                                                                                                     WHEN 'C' THEN '12'
                                                                                                                                     ELSE LPAD(SUBSTR(AC201_BARCODE,LENGTH(AC201_BARCODE)-7,1),2,'0')
                                                                                END) || SUBSTR(AC201_BARCODE,LENGTH(AC201_BARCODE)-6,7)
                                 ELSE SUBSTR(AC201_INST_DT,3,6) || '00001'
                            END) <![CDATA[ < ]]> (CASE WHEN AC201_GDS_CD = '42240000000' THEN '17092500068'
                                         WHEN AC201_GDS_CD = '42251000000' THEN '18022300001'
                                         WHEN AC201_GDS_CD = '42261000000' THEN '17101800001'
                                    END))
               , 'N')
          INTO CHEK_COCK_YN
          FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs03_03" resultType="java.lang.String">
        /* 로직 미확정 */
        /*19.02.25 신안보건소 건이라면 강제 택배 세팅*/
        /* -> CHEK_VST_GB_20 */
        SELECT (CASE WHEN DB2_ICDE IN ('4401', '4403', '4036', '4046', '4016') THEN 'Y'
                      WHEN DB2_ICDE = '4013' AND (SELECT AC201_CYCL_TYP
                                                    FROM LC_ALLOCATE_AC201TB
                                                   WHERE 1=1
                                                     AND AC201_CSMR_YR = P_CSMR_YR
                                                     AND AC201_CSMR_CD = P_CSMR_CD
                                                     AND AC201_CSMR_SEQ = P_CSMR_SEQ) = '6M1' THEN 'Y'
                      WHEN V_AC201_BS_GB1 = '02' THEN 'Y'
                      WHEN (SELECT COUNT(1)
                              FROM LC_ALLOCATE_AC201TB
                             WHERE 1=1
                               AND AC201_CSMR_YR = P_CSMR_YR
                               AND AC201_CSMR_CD = P_CSMR_CD
                               AND AC201_CSMR_SEQ = P_CSMR_SEQ
                               AND AC201_GDS_CD IN ('43072000000')
                               AND AC201_ZIP_NO1 = '588'
                               AND AC201_MGT_GB = '1'
                               ) > 0 THEN 'Y'
                      ELSE CHEK_VST_GB_20
                 END) AS CHEK_VST_GB_20
           FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs03_04" resultType="java.lang.Integer">
        /* 방문기준 차월수 */
        /* -> CHEK_CYCL_MTHS */
        SELECT MIN(VST_NMN_N)
          FROM TB_PDBS_RGBS_WK_BASE_DTL
         WHERE 1=1
           AND PDCT_PD_CD = #{pdctPdCd} /* selectBsPeriodChartBs03_01의 결과 */
           AND SV_PD_CD = #{svPdCd} /* selectBsPeriodChartBs03_01의 결과 */
         GROUP BY SV_PD_CD, PDCT_PD_CD
    </select>

    <select id="selectBsPeriodChartBs03_05" resultType="java.lang.String">
        /* 주기표상 마지막 방문일자 */
        /* 기존 주기표가 만들어진 계약건이라면 주기표상 마지막 일자를 가져옴 */
        /* -> V_VS107_WRK_DT */
        SELECT NVL((
                    SELECT MAX(WK_DT) AS MAX_VS107_WRK_DT
                      FROM TB_SVPD_CST_SV_RGBSPR_IZ
                     WHERE 1=1
                       AND CNTR_NO = #{cntrNo}
                       AND CNTR_SN = #{cntrSn}), '') AS V_VS107_WRK_DT
          FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs03_06"
            resultType="com.kyowon.sms.wells.web.service.allocate.dvo.WsncBsPeriodChartResDvo">
        /* 해당 결과가 WORK_X 로 Loop를 수행한다. */
        /* SV_PD_CD, PDCT_PD_CD는 selectBsPeriodChartBs03_01 의 결과로 수행한다. */
        SELECT VST_NMN_N
             , TOT_STPL_MCN
          FROM TB_PDBS_RGBS_WK_BASE_DTL
         WHERE 1=1
           AND SV_PD_CD = #{svPdCd}
           AND PDCT_PD_CD = #{pdctPdCd}
         ORDER BY SV_PD_CD, PDCT_PD_CD, VST_NMN_N, DTL_SN
    </select>

    <select id="selectBsPeriodChartBs03_07"
            resultType="com.kyowon.sms.wells.web.service.allocate.dvo.WsncBsPeriodChartResDvo">
        SELECT DISTINCT *
          FROM (
                SELECT VST_NMN_N     AS VST_MTHS
                     , (CASE WHEN SV_BIZ_DCLSF_CD = '2167'    /*BA04 2167 업무유형(세분류) 피팅+코크팁*/
                              AND #{chekCockYn} = 'Y'
                             THEN '2131'                        /*BA04  2131     업무유형(세분류)  피팅부작업*/
                             WHEN SV_BIZ_DCLSF_CD = '2166'
                              AND #{chekCockYn} = 'Y'
                             THEN '9999'
                             ELSE SV_BIZ_DCLSF_CD
                        END)  AS WRK_TYP_DTL
                     , FILT_CHNG_LV_CD     AS CHNG_STG
                     , 'ITM_KND_CD'     AS ITEM_KND /* part master - SVPD_ITEM_KND */
                     , (CASE WHEN PART_PD_CD = '43080111031' AND 'DB2_ICDE:cherro:기간계 상품코드' IN ('4401', '4403','4036','4046') THEN '43080111051'
                             WHEN PART_PD_CD = '43080111020' AND 'DB2_ICDE:cherro:기간계 상품코드' IN ('4401', '4403','4036','4046') THEN '43080111060'
                             ELSE PART_PD_CD
                        END) AS PART_CD
                     , PART_USE_QTY          AS QTY
                     , VST_DV_CD       AS VST_GB
                  FROM TB_PDBS_RGBS_WK_BASE_DTL
                 WHERE 1=1
                  /* AND 'PRD_RFLT_YN'   = 'Y' */ /* cherro ::: 주기반영여부 컬럼 없음. */
                   AND PDCT_PD_CD = #{pdctPdCd}
                   AND SV_PD_CD = #{svPdCd}
               )
         WHERE 1=1
           AND WRK_TYP_DTL != '9999'
         ORDER
            BY VST_MTHS
             , WRK_TYP_DTL DESC
             , CHNG_STG
    </select>

    <select id="selectBsPeriodChartBs03_08" resultType="java.lang.Integer">
        SELECT NVL((SELECT COUNT(1)
                      FROM TB_SVPD_CST_SV_RGBSPR_IZ
                     WHERE CNTR_NO = #{cntrNo}
                       AND CNTR_SN = #{cntrSn}
                       AND SV_BIZ_DCLSF_CD IN ('2120', '2138')), 0) AS WRK_TYP_DTL_CNT
          FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs03_09" resultType="java.lang.Integer">
        SELECT NVL((
                    SELECT COUNT(1)
                      FROM TB_SVPD_CST_SV_RGBSPR_IZ
                     WHERE CNTR_NO = #{cntrNo}
                       AND CNTR_SN = #{cntrSn}
                       AND SV_BIZ_DCLSF_CD = '2120'
                   ),0) AS WRK_TYP_DTL_CNT
           FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs03_10" resultType="java.lang.String">
        WITH TB_CAL AS (
            SELECT TO_CHAR(TO_DATE(#{chekVstDt}, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS TARGET_DT
                 , SUBSTR(TO_CHAR(TO_DATE(#{chekVstDt}, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD'), 1, 4) AS BASE_Y
                 , SUBSTR(TO_CHAR(TO_DATE(#{chekVstDt}, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD'), 5, 2) AS BASE_MM
                 , SUBSTR(TO_CHAR(TO_DATE(#{chekVstDt}, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD'), 7, 2) AS BASE_D
              FROM DUAL
             WHERE 1=1
             CONNECT BY LEVEL <![CDATA[ < ]]> 10
        )
        SELECT MIN(TB_1.TARGET_DT) AS TARGET_DT
          FROM TB_CAL TB_1
        LEFT OUTER JOIN TB_SVPD_SV_CLND_BAS TB_2
        ON (
               TB_1.BASE_Y = TB_2.BASE_Y
           AND TB_1.BASE_MM = TB_2.BASE_MM
           AND TB_1.BASE_D = TB_2.BASE_D
        )
         WHERE 1=1
           AND (TB_2.DF_YN != 'Y' OR TB_2.DF_YN IS NULL)
    </select>

    <select id="selectBsPeriodChartBs03_11" resultType="java.lang.String">
        /*20.02.27 이영진 - 고객이 약속한 방문 예정일자가 있는지 확인*/
        SELECT NVL(
                   (
                    SELECT VST_PROM_DT
                      FROM (
                            SELECT CNTR_NO, CNTR_SN, VST_PROM_DT, SAVE_SN
                                 , RANK() OVER (PARTITION BY CNTR_NO, CNTR_SN ORDER BY SAVE_SN DESC) AS RN
                              FROM (
                                    SELECT CNTR_NO, CNTR_SN, VST_PROM_DT, SAVE_SN
                                      FROM TB_SVPD_BFSVC_NX_VST_PROM_IZ
                                     WHERE 1=1
                                       AND CNTR_NO = #{cntrNo}
                                       AND CNTR_SN = #{cntrSn}
                                       AND SUBSTR(VST_PROM_DT,1,6) = SUBSTR(#{chekVstDt},1,6)
                                   )
                           )
                     WHERE 1=1
                       AND RN =1
                   ), '') AS V_VS104_CFRM_DT
          FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs03_12" resultType="java.lang.Integer">
        SELECT COUNT(1) AS WRK_TYP_DTL_CNT
          FROM TB_SVPD_CST_SV_RGBSPR_IZ
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND SV_BIZ_DCLSF_CD = #{newWrkTypDtl}
    </select>

    <select id="selectBsPeriodChartBs03_13" resultType="java.lang.Integer">
        SELECT COUNT(1) AS WRK_TYP_DTL_CNT
          FROM TB_SVPD_CST_SV_RGBSPR_IZ TB_1
         INNER JOIN TB_SVPD_CNTR_PDCT_IST_LCT_DTL TB_2
         ON (
                TB_1.CNTR_NO = TB_2.CNTR_NO
            AND TB_1.CNTR_SN = TB_2.CNTR_SN
         )
         WHERE 1=1
           AND TB_1.CNTR_NO = #{cntrNo}
           AND TB_1.CNTR_SN = #{cntrSn}
           AND TB_1.SV_BIZ_DCLSF_CD = #{newWrkTypDtl}
           /* AND NOT (AC201_GDS_CD = '49240000000' AND AC201_CYCL_TYP = '6M3') */
           AND NOT (TB_1.PART_PD_CD = '49240000000')
    </select>

    <select id="selectBsPeriodChartBs03_14" resultType="java.lang.Integer">
        SELECT COUNT(1) AS WRK_TYP_DTL_CNT
               FROM TB_SVPD_CST_SV_RGBSPR_IZ
              WHERE CNTR_NO = #{cntrNo}
                AND CNTR_SN = #{cntrSn}
                AND SV_BIZ_DCLSF_CD = #{newWrkTypDtl}
    </select>

    <select id="selectBsPeriodChartBs03_15" resultType="java.lang.Integer">
        SELECT COUNT(1) AS V_CHK_2178
          FROM TB_SVST_SV_WK_OSTR_IZ
         WHERE 1=1
           AND ITM_PD_CD = '49280251080'   /*49280251080 CERAMIC GLASS ASSY RK1B1*/
           AND REFRI_DV_CD = '1'
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </select>

    <select id="selectBsPeriodChartBs03_16" resultType="java.lang.Integer">
        SELECT COUNT(1) AS WRK_TYP_DTL_CNT
          FROM TB_SVPD_CST_SV_RGBSPR_IZ
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND SV_BIZ_DCLSF_CD = #{newWrkTypDtl}
           AND #{pdctPdCd} IN ('49431000000', '49432000000', '49433000000', '49434000000', '49435000000', '49436000000')
    </select>

    <select id="selectBsPeriodChartBs03_17" resultType="java.lang.Integer">
        SELECT COUNT(1) AS V_CHK_2178
          FROM TB_SVST_SV_WK_OSTR_IZ
         WHERE 1=1
           AND ITM_PD_CD IN ('49431812020', '49432812020', '49433812020', '49434812020', '49435812020', '49436812020')
           AND REFRI_DV_CD = '1'
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </select>

    <select id="selectBsPeriodChartBs03_18" resultType="java.lang.Integer">
        SELECT COUNT(1) AS WRK_TYP_DTL_CNT
          FROM TB_SVPD_CST_SV_RGBSPR_IZ
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND SV_BIZ_DCLSF_CD = #{newWrkTypDtl}
           AND #{pdctPdCd} IN ( '49401000000'      /*일반탑퍼 퀸 스프링침대*/
                           , '49402000000'        /*일반탑퍼 슈퍼싱글 스프링침대*/
                           , '49403000000'        /*일반탑퍼 슈퍼싱글 스프링 아동용침대*/
                           , '49404000000'        /*에어탑퍼 퀸 스프링*/
                           , '49406000000'        /*에어탑퍼(아동겸용) 슈퍼싱글 스프링*/
                           , '49429000000'        /*에어탑퍼(단품판매) 퀸 스프링*/
                           , '49430000000'        /*에어탑퍼(단품판매) 슈퍼싱글*/
                           )
    </select>

    <select id="selectBsPeriodChartBs03_19" resultType="java.lang.Integer">
        SELECT COUNT(1) AS V_CHK_2178
          FROM TB_SVST_SV_WK_OSTR_IZ
         WHERE 1=1
           AND ITM_PD_CD IN (
                                 '49401812010'  /*일반탑퍼 퀸 교체용  BS*/
                               , '49401812011'   /*일반탑퍼 퀸 교체용 탑퍼+커버  BS*/
                               , '49402812010'   /*일반탑퍼 슈퍼싱글 교체용  BS*/
                               , '49402812011'   /*일반탑퍼 슈퍼싱글 교체용 탑퍼+커버  BS*/
                               , '49403812010'   /*일반탑퍼 슈퍼싱글 아동용 교체용  BS*/
                               , '49403812011'   /*일반탑퍼 슈퍼싱글 아동용 교체용 탑퍼+커버  BS*/
                                )
           AND REFRI_DV_CD = '1'
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </select>

    <select id="selectBsPeriodChartBs03_20" resultType="java.lang.String">
        SELECT (CASE WHEN (SELECT COUNT(1)
                             FROM TB_PDBS_LVLH_CSTMW_FILT_BASE
                            WHERE PDCT_PD_CD = #{pdctPdCd}
                              AND SV_PD_CD = #{svPdCd}
                              AND VST_DV_CD = #{vstGb}
                              AND PART_PD_CD = #{partCd}
                          ) > 0  THEN (SELECT PART_PD_CD
                                         FROM TB_PDBS_LVLH_CSTMW_FILT_BASE
                                        WHERE PDCT_PD_CD = #{pdctPdCd}
                                          AND SV_PD_CD = #{svPdCd}
                                          AND PRD_MM_VAL = SUBSTR(#{chekVstDt},5,2)
                                          AND VST_DV_CD= #{vstGb}
                                        )
                     ELSE ''
                END) AS NEW_PART_CD
          FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs03_21" resultType="java.lang.String">
        SELECT NVL(
                   (
                    SELECT (
                            SELECT MAX(PART_PD_CD)
                              FROM TB_PDBS_LVLH_CSTMW_FILT_BASE
                             WHERE 1=1
                               AND PDCT_PD_CD = #{pdctPdCd}
                               AND VST_DV_CD = #{newVstGb}
                               AND SV_PD_CD = #{svPdCd}
                               AND FILT_CMU_CDV =
                                              (SELECT MAX(FILT_CMU_CDV)
                                                 FROM TB_PDBS_LVLH_CSTMW_FILT_BASE
                                                WHERE 1=1
                                                  AND PART_PD_CD = CSTMW_FILT_PD_CD))
                      FROM (
                            SELECT CSTMW_FILT_PD_CD
                                 , RANK() OVER (PARTITION BY CNTR_NO, CNTR_SN ORDER BY SAVE_SN DESC) AS RN
                              FROM (
                                    SELECT CNTR_NO, CNTR_SN, VST_PROM_DT, CSTMW_FILT_PD_CD, SAVE_SN
                                      FROM TB_SVPD_BFSVC_NX_VST_PROM_IZ
                                     WHERE 1=1
                                       AND CNTR_NO = #{cntrNo}
                                       AND CNTR_SN = #{cntrSn}
                                       AND CSTMW_FILT_PD_CD IS NOT NULL
                                       AND #{chekVstDt} >= TO_CHAR(ADD_MONTHS(FST_RGST_DTM,1), 'YYYYMM') || '01'  /*주기가 변경 되는 경우가 있어서*/
                                       AND #{newPartCd} IN (SELECT PART_PD_CD
                                                             FROM TB_PDBS_LVLH_CSTMW_FILT_BASE
                                                            WHERE 1=1
                                                          )
                                   )
                           )
                     WHERE 1=1
                       AND RN =1
                   ), '') AS V_VS104_CSTM_FLTR
          FROM DUAL
    </select>

    <insert id="insertBsPeriodChart">
        INSERT INTO TB_SVPD_CST_SV_RGBSPR_IZ (
              CNTR_NO
            , CNTR_SN
            , SV_BIZ_MCLSF_CD
            , SV_BIZ_DCLSF_CD
            , WK_SN
            , VST_DUEDT
            , SV_BIZ_DCLSF_CD
            , FILT_CHNG_LV_CD
            , IST_NMN_N
            , VST_NMN_N
            , ITM_KND_CD
            , PART_PD_CD
            , PART_USE_QTY
            , VST_DV_CD
            , FST_RGST_DTM
            , FST_RGST_USR_ID
            , FST_RGST_PRG_ID
            , FST_RGST_DEPT_ID
            , FNL_MDFC_DTM
            , FNL_MDFC_USR_ID
            , FNL_MDFC_PRG_ID
            , FNL_MDFC_DEPT_ID
        ) VALUES (
              #{cntrNo}
            , #{cntrSn}
            , SUBSTR(#{newWrkTypDtl}, 1, 2)
            , #{newWrkTypDtl}
            , (
                SELECT NVL(MAX(TEMP.WK_SN) + 1, 1) AS WK_SN
                  FROM TB_SVPD_CST_SV_RGBSPR_IZ TEMP
                 WHERE 1=1
                   AND TEMP.CNTR_NO = #{cntrNo}
                   AND TEMP.CNTR_SN = #{cntrSn}
                   AND TEMP.SV_BIZ_MCLSF_CD = SUBSTR(#{newWrkTypDtl}, 1, 2)
                   AND TEMP.SV_BIZ_DCLSF_CD = #{newWrkTypDtl}
              )
            , #{chekVstDt}
            , #{newWrkTypDtl}
            , #{chngStg}
            , #{chekInstMths}
            , #{chekCyclMths}          /* CHEK_VST_MTHS -> vstNmnN */
            , #{itemKnd}
            , #{newPartCd}
            , #{qty}
            , #{newVstGb}
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , #{session.userId}
            , #{pgrmId}
            , #{session.departmentId}
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , #{session.userId}
            , #{pgrmId}
            , #{session.departmentId}
        )
    </insert>

    <insert id="insertBsPeriodChartError">
        INSERT INTO TB_SVPD_RGBSPR_CHT_CRT_ERR_IZ(
              CNTR_NO
            , CNTR_SN
			, CRT_ERR_CN
            , FST_RGST_DTM
            , FST_RGST_USR_ID
            , FST_RGST_PRG_ID
            , FST_RGST_DEPT_ID
            , FNL_MDFC_DTM
            , FNL_MDFC_USR_ID
            , FNL_MDFC_PRG_ID
            , FNL_MDFC_DEPT_ID
        ) VALUES(
              #{cntrNo}
            , #{cntrSn}
            , #{crtErrCn}
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , #{session.userId}
            , #{pgrmId}
            , #{session.departmentId}
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , #{session.userId}
            , #{pgrmId}
            , #{session.departmentId}
        )
    </insert>

    <select id="selectPriorityVstDt" resultType="java.lang.String">
        WITH TB_BASE_INFO AS (
            SELECT CNTR_NO
                 , CNTR_SN
                 , SV_HSHD_NO -- 서비스가구번호 (동일한 주소인지 찾아본다.)
                 , SV_PD_CD
                 , PDCT_PD_CD
              FROM TB_SVPD_CST_SV_EXCN_IZ
             WHERE 1=1
               AND CNTR_NO = #{cntrNo}
               AND CNTR_SN = #{cntrSn}
        )
        , TB_VST_NMN_N AS (
            SELECT MIN(VST_NMN_N) AS VST_NMN_N
                 , #{cntrNo} AS CNTR_NO
                 , #{cntrSn} AS CNTR_SN
              FROM TB_PDBS_RGBS_WK_BASE_DTL TB_VST_NMN_N
                 , TB_BASE_INFO TB_BASE_INFO
             WHERE 1=1
               AND TB_VST_NMN_N.SV_PD_CD = TB_BASE_INFO.SV_PD_CD
               AND TB_VST_NMN_N.PDCT_PD_CD = TB_BASE_INFO.PDCT_PD_CD
        )
        , TB_VST_DT AS (
            SELECT TB_VST_NMN_N.CNTR_NO
                 , TB_VST_NMN_N.CNTR_SN
                 , TO_CHAR(ADD_MONTHS(SYSDATE, TB_VST_NMN_N.VST_NMN_N), 'YYYYMM') AS DT
                 , (
                     CASE WHEN TO_CHAR(ADD_MONTHS(SYSDATE, TB_VST_NMN_N.VST_NMN_N - 3), 'YYYYMM') <![CDATA[ <= ]]> TO_CHAR(SYSDATE, 'YYYYMM')
                          THEN TO_CHAR(ADD_MONTHS(SYSDATE, 1), 'YYYYMM')
                          ELSE TO_CHAR(ADD_MONTHS(SYSDATE, TB_VST_NMN_N.VST_NMN_N - 3), 'YYYYMM')
                          END
                   ) AS ST_DT /* 현재월 이후(현재월은 미포함.) */
                 , TO_CHAR(ADD_MONTHS(SYSDATE, TB_VST_NMN_N.VST_NMN_N + 3), 'YYYYMM') AS ED_DT
              FROM TB_VST_NMN_N TB_VST_NMN_N
        )
        SELECT MIN(TB_2.VST_DUEDT) AS VST_DUEDT
          FROM TB_SVPD_CST_SV_EXCN_IZ TB_1
         INNER JOIN TB_SVPD_CST_SV_RGBSPR_IZ TB_2
         ON (
                TB_1.CNTR_NO = TB_2.CNTR_NO
            AND TB_1.CNTR_SN = TB_2.CNTR_SN
         )
         INNER JOIN TB_BASE_INFO TB_3
         ON (
                TB_1.CNTR_NO = TB_3.CNTR_NO
            AND TB_1.CNTR_SN = TB_3.CNTR_SN
            AND TB_1.SV_HSHD_NO = TB_3.SV_HSHD_NO
         )
         INNER JOIN TB_VST_DT TB_4
         ON (
                TB_1.CNTR_NO = TB_4.CNTR_NO
            AND TB_1.CNTR_SN = TB_4.CNTR_SN
         )
         WHERE 1=1
           AND TB_2.VST_DUEDT BETWEEN (TB_4.ST_DT || '01') AND (TB_4.ED_DT || '32')
    </select>

    <select id="selectPriorityVstDiff" resultType="java.lang.Integer">
        SELECT TRUNC(MONTHS_BETWEEN(SUBSTR(TO_CHAR(ADD_MONTHS(SYSDATE, #{chekCyclMths}), 'YYYYMMDD'), 1, 6) || '01', SUBSTR(#{priorityVstDt}, 1, 6) || '01')) AS PRIORITY_VST_DIFF
          FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs04_07"
            resultType="com.kyowon.sms.wells.web.service.allocate.dvo.WsncBsPeriodChartResDvo">
        SELECT DISTINCT *
          FROM (
                /*최소 공배수 만큼 풀어 놓은 방문 주기표 */
                /*필터택배발송*/
                SELECT VST_NMN_N AS VST_MTHS
                     , SV_BIZ_DCLSF_CD  AS WRK_TYP_DTL
                     , FILT_CHNG_LV_CD     AS CHNG_STG
                     , 'ITM_KND_CD'     AS ITEM_KND /* part master - SVPD_ITEM_KND */
                     , PART_PD_CD      AS PART_CD
                     , PART_USE_QTY          AS QTY
                     , VST_DV_CD       AS VST_GB
                  FROM TB_PDBS_RGBS_WK_BASE_DTL
                 WHERE 1=1
                   /* AND 'PRD_RFLT_YN'   = 'Y' */ /* cherro ::: 주기반영여부 컬럼 없음. */
                   AND PDCT_PD_CD = 'P_GDS_CD'
                   AND SV_BIZ_DCLSF_CD = '2120'   /*필터교체*/
                   AND VST_DV_CD = '20'          /*택배발송*/
                   AND TO_CHAR(ADD_MONTHS('P_INST_DT', 2), 'YYYYMM') = SUBSTR('CHEK_VST_DT',1,6)
                   AND 'CHEK_VST_DT' > 'P_INST_DT'

                 UNION ALL

                /*정기BS*/
                SELECT VST_NMN_N AS VST_MTHS
                     , SV_BIZ_DCLSF_CD  AS WRK_TYP_DTL
                     , FILT_CHNG_LV_CD     AS CHNG_STG
                     , 'ITM_KND_CD'     AS ITEM_KND /* part master - SVPD_ITEM_KND */
                     , PART_PD_CD      AS PART_CD
                     , (CASE WHEN TO_CHAR(ADD_MONTHS('P_INST_DT', 48), 'YYYYMMDD') <![CDATA[ < ]]> 'CHEK_VST_DT'
                             THEN (CASE WHEN PDCT_PD_CD = '49367000000' THEN 6 ELSE 3 END)    /*백현아 파트장님 요청 마지막 방문시 수량 강제 세팅 벽결이 8개에서 6개로 스탠드는 4개에서 3개로*/
                             ELSE PART_USE_QTY
                        END)              AS QTY
                     , VST_DV_CD       AS VST_GB
                  FROM TB_PDBS_RGBS_WK_BASE_DTL
                 WHERE 1=1
                   /* AND 'PRD_RFLT_YN'   = 'Y' */ /* cherro ::: 주기반영여부 컬럼 없음. */
                   AND PDCT_PD_CD = 'P_GDS_CD'
                   AND SV_BIZ_DCLSF_CD = '2120'   /*필터교체*/
                   AND VST_DV_CD = '13'          /*방문*/
                   AND (CASE WHEN SUBSTR('P_INST_DT',5,2) IN ('01', '02', '12') THEN '06'
                             WHEN SUBSTR('P_INST_DT',5,2) IN ('03', '04', '05') THEN '09'
                             WHEN SUBSTR('P_INST_DT',5,2) IN ('06', '07', '08') THEN '12'
                             WHEN SUBSTR('P_INST_DT',5,2) IN ('09', '10', '11') THEN '03'
                        END) = SUBSTR('CHEK_VST_DT',5,2)
                   AND 'CHEK_VST_DT' > 'P_INST_DT'

                 UNION ALL

                /*홈케어*/
                SELECT VST_NMN_N AS VST_MTHS
                     , SV_BIZ_DCLSF_CD  AS WRK_TYP_DTL
                     , FILT_CHNG_LV_CD     AS CHNG_STG
                     , 'ITM_KND_CD'     AS ITEM_KND /* part master - SVPD_ITEM_KND */
                     , PART_PD_CD      AS PART_CD
                     , PART_USE_QTY          AS QTY
                     , VST_DV_CD       AS VST_GB
                  FROM TB_PDBS_RGBS_WK_BASE_DTL
                 WHERE 1=1
                   /* AND 'PRD_RFLT_YN'   = 'Y' */ /* cherro ::: 주기반영여부 컬럼 없음. */
                   AND PDCT_PD_CD = 'P_GDS_CD'
                   AND SV_BIZ_DCLSF_CD = '2170'   /*홈케어*/
                   AND VST_DV_CD = '13'          /*홈마스터방문*/
                   AND (CASE WHEN 'P_GDS_CD' IN ('49342000000', '49343000000', '49344000000', '49345000000', '49346000000', '49347000000', '49348000000', '49397000000', '49398000000', '49399000000', '49349000000', '49351000000', '49352000000', '49353000000', '49354000000', '49608000000', '49609000000', '49610000000', '49611000000', '49619000000') AND SUBSTR('P_INST_DT',5,2) IN ('01', '02', '03') THEN '02'
                             WHEN 'P_GDS_CD' IN ('49342000000', '49343000000', '49344000000', '49345000000', '49346000000', '49347000000', '49348000000', '49397000000', '49398000000', '49399000000', '49349000000', '49351000000', '49352000000', '49353000000', '49354000000', '49608000000', '49609000000', '49610000000', '49611000000', '49619000000') AND SUBSTR('P_INST_DT',5,2) IN ('04', '05', '06') THEN '04'
                             WHEN 'P_GDS_CD' IN ('49342000000', '49343000000', '49344000000', '49345000000', '49346000000', '49347000000', '49348000000', '49397000000', '49398000000', '49399000000', '49349000000', '49351000000', '49352000000', '49353000000', '49354000000', '49608000000', '49609000000', '49610000000', '49611000000', '49619000000') AND SUBSTR('P_INST_DT',5,2) IN ('07', '08', '09') THEN '10'
                             WHEN 'P_GDS_CD' IN ('49342000000', '49343000000', '49344000000', '49345000000', '49346000000', '49347000000', '49348000000', '49397000000', '49398000000', '49399000000', '49349000000', '49351000000', '49352000000', '49353000000', '49354000000', '49608000000', '49609000000', '49610000000', '49611000000', '49619000000') AND SUBSTR('P_INST_DT',5,2) IN ('10', '11', '12') THEN '12'
                             WHEN SUBSTR('P_INST_DT',5,2) IN ('01', '02', '12') THEN '03'
                             WHEN SUBSTR('P_INST_DT',5,2) IN ('03', '04', '05') THEN '05'
                             WHEN SUBSTR('P_INST_DT',5,2) IN ('06', '07', '08') THEN '03'
                             WHEN SUBSTR('P_INST_DT',5,2) IN ('09', '10', '11') THEN '05'
                        END) = SUBSTR('CHEK_VST_DT',5,2)
                   AND SUBSTR('CHEK_VST_DT',1,6) >= (CASE WHEN 'P_GDS_CD' IN ('49342000000', '49343000000', '49344000000', '49345000000', '49346000000', '49347000000', '49348000000')
                                                         AND 'DB2_ICDE' NOT IN ('7735', '7736', '7770', '7771', '7737')
                                                        THEN TO_NUMBER(SUBSTR('P_INST_DT',1,4))+1 || '0101'
                                                        WHEN 'P_GDS_CD' IN ('49342000000', '49343000000', '49344000000', '49345000000', '49346000000', '49347000000', '49348000000')
                                                         AND 'DB2_ICDE' IN ('7735', '7736', '7770', '7771', '7737')
                                                        THEN TO_NUMBER(SUBSTR('P_INST_DT',1,4))+2 || '0101'
                                                        WHEN 'P_GDS_CD' IN ('49397000000', '49398000000', '49399000000', '49349000000', '49351000000', '49352000000', '49353000000', '49354000000', '49608000000', '49609000000', '49610000000', '49611000000', '49619000000')
                                                         AND 'DB2_ICDE' IN ('4112', '4113', '4114', '4101', '4102', '4103', '4152', '4153', '4853', '4854', '4855', '4856', '4134')
                                                        THEN TO_NUMBER(SUBSTR('P_INST_DT',1,4))+2 || '0101'
                                                        ELSE TO_CHAR(ADD_MONTHS((SUBSTR('P_INST_DT',1,6)||'01'), 12), 'YYYYMM')   /*설치월보다 12개월이 큰 경우만*/
                                                   END)
                   AND (SELECT COUNT(1)
                          FROM TB_SVPD_CST_SV_RGBSPR_IZ
                         WHERE 1=1
                           AND SV_BIZ_DCLSF_CD = '2170'
                           AND CNTR_NO = 'P_CSMR_YR'
                           AND CNTR_SN = 'P_CSMR_SEQ') <![CDATA[ < ]]> (CASE WHEN 'DB2_ICDE' IN ('7735', '7736', '7770', '7771', '4112', '4113', '4114', '4101', '4102', '4103', '4152', '4153', '4853', '4854', '4855', '4856', '7737', '4134') THEN 1 ELSE 4 END) /*백현아 파트장님 요청 홈케어서비스는 총 4회까지만*/
                           /*
                            7735
                            7736
                            7770
                            7771

                            4112
                            4113
                            4114
                            4101
                            4102
                            4103


                            4152    300007248   49353-000000    비스포크 무풍클래식17평 스탠드   21.08 출시
                            4153    300007249   49354-000000    비스포크 무풍클래식19평 스탠드   21.08 출시

                            B/S 요소 : 홈케어 1회 방문(4152, 4153)
                            ▶ 설치 월에 따라 홈케어서비스 방문시기 상이
                            - 1/2/3 월 구매 고객은 2 년 후 2 월 에어컨 분해 세척 홈케어 서비스(총 1 회)
                            - 4/5/6 월 구매 고객은 2 년 후 4 월 에어컨 분해 세척 홈케어 서비스(총 1 회)
                            - 7/8/9 월 구매 고객은 2 년 후 10 월 에어컨 분해 세척 홈케어 서비스(총 1 회)
                            - 10/11/12 월 구매 고객은 2 년 후 12 월 에어컨 분해 세척 홈케어 서비스(총 1 회)
                           */
                   AND 'CHEK_VST_DT' > 'P_INST_DT'

               )
         WHERE 1=1
           AND WRK_TYP_DTL != '9999'
         ORDER
            BY VST_MTHS
             , WRK_TYP_DTL DESC
             , CHNG_STG
    </select>

    <select id="selectBsPeriodChartBs01_22" resultType="java.lang.String">
        /* 로직 미확정 */
        /* 패키지 변경 요청을 적용한 패키지 */
        SELECT NVL(
                   (SELECT '65' || CS104_REQ_SALE_CD || '000000'
                      FROM LC_CAPSULE_CS104TB T1
                     WHERE 1=1
                       AND CS104_CSMR_YR = P_CSMR_YR
                       AND CS104_CSMR_CD = P_CSMR_CD
                       AND CS104_CSMR_SEQ = P_CSMR_SEQ
                       AND CS104_CSMR_SER = (SELECT AC201_CSMR_SER
                                               FROM LC_ALLOCATE_AC201TB
                                              WHERE 1=1
                                                AND AC201_CSMR_YR = P_CSMR_YR
                                                AND AC201_CSMR_CD = P_CSMR_CD
                                                AND AC201_CSMR_SEQ = P_CSMR_SEQ)
                       AND SUBSTR(CS104_REQ_DT,1,6) <![CDATA[ <= ]]> SUBSTR(CHEK_VST_DT,1,6)
                       AND CS104_SEQ = (SELECT MAX(CS104_SEQ)
                                          FROM LC_CAPSULE_CS104TB
                                         WHERE 1=1
                                           AND CS104_CSMR_YR = T1.CS104_CSMR_YR
                                           AND CS104_CSMR_CD = T1.CS104_CSMR_CD
                                           AND CS104_CSMR_SEQ = T1.CS104_CSMR_SEQ)
                       AND CS104_FIX_DT IS NULL
                       AND CS104_REQ_GB = '1'
                       AND CS104_DATA_STUS != '3'), NVL((SELECT '65'||DECODE(TO_CHAR((CASE WHEN LCST07 != 'Y' THEN '0' ELSE TO_CHAR(LCST12) END)),'0', '100',TO_CHAR(LCST12))||'000000'
                                                           FROM KWMART.LD3000P
                                                          WHERE 1=1
                                                            AND LCYEAR = TO_NUMBER(P_CSMR_YR)
                                                            AND LCCODE = TO_NUMBER(P_CSMR_CD)
                                                            AND LPAD(LCDEMY,4,'0')||LPAD(LCDEMM,2,'0') = SUBSTR(CHEK_VST_DT,1,6)
                                                            AND ROWNUM =1   /*19.07.03 당월에 모종 2개 이상 구매한건 발생 해서 이렇게 처리 - 김진섭매니저에게 월 2회 구매 불가능하다고 공지 해달라고 하고 해당 건 삭제 요청 2018 6955353 */
                                                        ),P_GDS_CD))
          INTO NEW_GDS_CD
          FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs01_23" resultType="java.lang.String">
        /*배송중지요청체크*/
        SELECT NVL(
                   (SELECT AK_CHDT
                      FROM TB_SVPD_HCF_AS_AK_IZ
                     WHERE 1=1
                       AND CNTR_NO = 'P_CSMR_YR'
                       AND CNTR_SN = 'P_CSMR_SEQ'
                       AND SUBSTR(AK_CHDT,1,6) = SUBSTR('CHEK_VST_DT',1,6)
                       AND CNFMDT IS NULL
                       AND AS_AK_DV_CD = '4'
                       AND MTR_PROCS_STAT_CD != '3'), '') AS V_VS107_CNCL_DT
          FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs01_07"
            resultType="com.kyowon.sms.wells.web.service.allocate.dvo.WsncBsPeriodChartResDvo">
        /* 주기표생성 작업 */
        /* 로직 추가로 협의해서 넣어야 함. */
        SELECT DISTINCT
                  VST_MTHS
                , WRK_TYP_DTL
                , LPAD(RANK() OVER(ORDER BY ITEM_KND, PART_CD ASC),2,'0') AS CHNG_STG
                , ITEM_KND
                , PART_CD
                , QTY
                , VST_GB
             FROM (
                   /*최소 공배수 만큼 풀어 놓은 방문 주기표 */
                   SELECT A.VST_NMN_N        AS VST_MTHS
                        , A.SV_BIZ_DCLSF_CD     AS WRK_TYP_DTL
                        , ''                    AS CHNG_STG
                        , '5'                   AS ITEM_KND
--                        , C.ST101_ITEM_CD|| C.ST101_PART_CD AS PART_CD
                        , A.PART_PD_CD AS PART_CD
--                        , B.LCIQTY              AS QTY
                        , A.PART_USE_QTY AS QTY
                        , A.VST_DV_CD          AS VST_GB
                     FROM TB_PDBS_RGBS_WK_BASE_DTL A
--                        , KWMART.LD3050P B
--                        , LC_STOCK_ST101TB C /* Part Master, 우선 생략 */
                    WHERE 1=1
--                      AND B.LCICDE = C.ST101_SALE_CD
                      AND A.PDCT_PD_CD = 'NEW_GDS_CD'
--                      AND LCYEAR = P_CSMR_YR
--                      AND LCCODE = P_CSMR_CD
--                      AND LCSEQN = (SELECT MAX(AC201_CSMR_SER)
--                                      FROM LC_ALLOCATE_AC201TB
--                                     WHERE 1=1
--                                       AND AC201_CSMR_YR = P_CSMR_YR
--                                       AND AC201_CSMR_CD = P_CSMR_CD)
--                      AND SUBSTR(CHEK_VST_DT,1,6) BETWEEN B.LCSTYM AND B.LCEDYM
                      AND (CASE WHEN 'NEW_GDS_CD' IN ('65605000000', '65606000000', '65607000000') THEN '1' ELSE '2' END) = '1'  /*고객선택 패기지를 선택한 경우만 처리하기 위해*/

                    UNION ALL

                   SELECT VST_NMN_N        AS VST_MTHS
                        , SV_BIZ_DCLSF_CD     AS WRK_TYP_DTL
                        , ''                    AS CHNG_STG
                        , '5'                   AS ITEM_KND
--                        , C.ST101_ITEM_CD|| C.ST101_PART_CD AS PART_CD
                        , PART_PD_CD AS PART_CD

                        /*22.02.21 상품기획팀 김지혜 매니저 요청, 사은품 지급 대상이면(구독상품 일시불 구매 후 구독 연계 주문시에 본품 1박스 지급) 수량을 더해준다.*/
--                        , B.LCIQTY + (CASE WHEN CHEK_INST_MTHS = 0 THEN (/*4.첫배송만*/
--                                     (SELECT NVL((/*3.해당사은품이 있는 행에서 수량을 가지고 온다*/
--                                                  SELECT SUBSTR(TXT,INSTR(TXT, ',')+1) AS QTY
--                                                    FROM (/*2.스트링으로 만든 정보를 다시 행으로 만든다.*/
--                                                          SELECT TRIM(REGEXP_SUBSTR(TXT, '[^|]+', 1, LEVEL)) AS TXT
--                                                            FROM (/*1.KWMART.CW3100P 사은품 테이블에서 열로 구성된 사은품 정보를 스트링으로 만든다*/
--                                                                  SELECT CWGC01||','||CWGQ01||'|'||CWGC02||','||CWGQ02||'|'||CWGC03||','||CWGQ03||'|'||CWGC04||','||CWGQ04||'|'||CWGC05||','||CWGQ05||'|'||CWGC06||','||CWGQ06||'|'||CWGC07||','||CWGQ07||'|'||CWGC08||','||CWGQ08||'|'||CWGC09||','||CWGQ09||'|'||CWGC10||','||CWGQ10||'|' AS TXT
--                                                                    FROM KWMART.CW3100P
--                                                                   WHERE 1=1
--                                                                     AND CWYEAR = P_CSMR_YR
--                                                                     AND CWCODE = P_CSMR_CD
--                                                                 )
--                                                          CONNECT
--                                                               BY INSTR(TXT, '|', 1, LEVEL - 1) > 0
--                                                         )
--                                                   WHERE 1=1
--                                                     AND TXT LIKE '%'||B.LCICDE||'%'
--                                                 ),0) AS QTY
--                                        FROM DUAL))
--                                           ELSE '0'
--                                      END)
--
--                                                AS QTY
                        , PART_USE_QTY AS QTY
                        , VST_DV_CD          AS VST_GB
                     FROM TB_PDBS_RGBS_WK_BASE_DTL
--                        , KWMART.LD1010P A
--                        , KWMART.LD1020P B
--                        , LC_STOCK_ST101TB C
                    WHERE 1=1
--                      AND B.LCICDE = C.ST101_SALE_CD
--                      AND B.LCPKAG = A.LCPKAG
--                      AND B.LCPSEQ = A.LCPSEQ
--                      AND CHEK_VST_DT BETWEEN A.LCSDAY AND A.LCEDAY
--                      AND CHEK_VST_DT BETWEEN B.LCSDAY AND B.LCEDAY /** 20220310 한상문C 요청 웰빙티캡슐 보리구성품 22.03.31 종료 적용 **/
--                      AND A.LCPKAG = SUBSTR(CO322_GDS_CD,3,3)
                      AND PDCT_PD_CD = 'NEW_GDS_CD'
                      AND SV_PD_CD = 'P_CYCL_TYP'

                      /*추가된 컬럼이
                        * LD1010P - LCPGB1(상품구성유형 - 1:고정(캡슐), 2:기간별변동(모종), 3: 회차별변동(화장품)
                        * LD1020P - LCSCNT(배송회자)
                        이렇게 추가 되었습니다.

                        보통 LD1020P에는 해당 패키지 가격 차수(LCPSEQ)에 따라서 1회분의 배송 상품이 셋팅되는 반면에 상품구성유형이
                        3:회차별변동일 경우에는 해당 패키지 가격 차수에 계약기간 전체에 걸쳐서 배송되어야 할 상품이 전체가 등록되어집니다.*/

--                      AND (CASE WHEN A.LCPGB1 = '3' THEN VST_NMN_N / SUBSTR(SV_PD_CD,1, INSTR(SV_PD_CD, 'M')-1) + 1
--                                ELSE 0
--                           END)  = (CASE WHEN A.LCPGB1 = '3' THEN B.LCSCNT
--                                         ELSE 0
--                                    END)
                  )
            ORDER BY VST_MTHS
    </select>

    <insert id="insertBsPeriodChartBs01">
        INSERT INTO TB_SVPD_CST_SV_RGBSPR_IZ (
              CNTR_NO
            , CNTR_SN
            , SV_BIZ_MCLSF_CD
            , SV_BIZ_DCLSF_CD
            , WK_SN
            , VST_DUEDT
            , SV_BIZ_DCLSF_CD
            , FILT_CHNG_LV_CD
            , IST_NMN_N
            , VST_NMN_N
            , ITM_KND_CD
            , PART_PD_CD
            , PART_USE_QTY
            , MTR_CAN_DT
            , MTR_CAN_RSON_CD
            , VST_DV_CD
            , FST_RGST_DTM
            , FST_RGST_USR_ID
            , FST_RGST_PRG_ID
            , FST_RGST_DEPT_ID
            , FNL_MDFC_DTM
            , FNL_MDFC_USR_ID
            , FNL_MDFC_PRG_ID
            , FNL_MDFC_DEPT_ID
        ) VALUES (
              #{cntrNo}
            , #{cntrSn}
            , SUBSTR(#{newWrkTypDtl}, 1, 2)
            , #{newWrkTypDtl}
            , (
                SELECT NVL(MAX(TEMP.WK_SN) + 1, 1) AS WK_SN
                  FROM TB_SVPD_CST_SV_RGBSPR_IZ TEMP
                 WHERE 1=1
                   AND TEMP.CNTR_NO = #{cntrNo}
                   AND TEMP.CNTR_SN = #{cntrSn}
                   AND TEMP.SV_BIZ_MCLSF_CD = SUBSTR(#{newWrkTypDtl}, 1, 2)
                   AND TEMP.SV_BIZ_DCLSF_CD = #{newWrkTypDtl}
              )
            , #{chekVstDt}
            , #{newWrkTypDtl}
            , #{chngStg}
            , #{chekInstMths}
            , #{chekCyclMths}          /* CHEK_VST_MTHS -> vstNmnN */
            , #{itemKnd}
            , #{newPartCd}
            , #{qty}
            , #{vVs107CnclDt}
            , (CASE WHEN #{vVs107CnclDt} IS NOT NULL THEN '10' ELSE '' END)
            , #{newVstGb}
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , #{session.userId}
            , #{pgrmId}
            , #{session.departmentId}
            , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
            , #{session.userId}
            , #{pgrmId}
            , #{session.departmentId}
        )
    </insert>

    <select id="selectBsPeriodChartBs05_22" resultType="java.lang.String">
        /* NEW_GDS_CD */
        /*패키지 변경 요청을 적용한 패키지*/
        SELECT NVL(
                   (SELECT '60' || AFCH_PD_CD || '000000'
                      FROM TB_SVPD_SDING_AS_AK_IZ T1
                     WHERE 1=1
                       AND CNTR_NO = #{cntrNo}
                       AND CNTR_SN = #{cntrSn}
        /* CST_SN 고객일련번호는 삭제된 컬럼 */
--                       AND FA104_CSMR_SER = (SELECT CST_SN
--                                               FROM TB_SVPD_CST_SV_EXCN_IZ
--                                              WHERE 1=1
--                                                AND CNTR_NO = P_CSMR_YR
--                                                AND CNTR_SN = P_CSMR_SEQ)
--                       AND (SUBSTR('CHEK_VST_DT',1,6) = SUBSTR(AK_CHDT,1,6) OR SUBSTR('CHEK_VST_DT',1,6) >= TO_CHAR(ADD_MONTHS(RGST_DT,1), 'YYYYMM') || '01')
                       AND (SUBSTR(#{chekVstDt},1,6) = SUBSTR(AK_CHDT,1,6) OR SUBSTR(#{chekVstDt},1,6) >= TO_CHAR(ADD_MONTHS(TO_DATE(FST_RGST_DTM, 'YYYYMMDD'),1), 'YYYYMM') || '01')
                       AND AK_SN = (SELECT MAX(AK_SN)
                                          FROM TB_SVPD_SDING_AS_AK_IZ
                                         WHERE 1=1
                                           AND CNTR_NO = T1.CNTR_NO
                                           AND CNTR_SN = T1.CNTR_SN)
                       AND CNFMDT IS NULL
                       AND AS_AK_DV_CD = '1'
                       AND MTR_PROCS_STAT_CD != '3')
--                       , NVL((SELECT '60'||DECODE(TO_CHAR((CASE WHEN LCST07 != 'Y' THEN '0' ELSE TO_CHAR(LCST12) END)),'0', '100',TO_CHAR(LCST12))||'000000'
--                                                           FROM KWMART.LD3000P
--                                                          WHERE 1=1
--                                                            AND LCYEAR = TO_NUMBER(P_CSMR_YR)
--                                                            AND LCCODE = TO_NUMBER(P_CSMR_CD)
--                                                            AND LPAD(LCDEMY,4,'0')||LPAD(LCDEMM,2,'0') = SUBSTR(CHEK_VST_DT,1,6)
--                                                            AND ROWNUM =1   /*19.07.03 당월에 모종 2개 이상 구매한건 발생 해서 이렇게 처리 - 김진섭매니저에게 월 2회 구매 불가능하다고 공지 해달라고 하고 해당 건 삭제 요청 2018 6955353 */
--                                                        ),'P_GDS_CD'))
                       , #{pdctPdCd})
          FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs05_23" resultType="java.lang.String">
        /* V_VS107_CNCL_DT */
        /*배송중지요청체크*/
        SELECT NVL(
                   (SELECT AK_CHDT
                      FROM TB_SVPD_SDING_AS_AK_IZ
                     WHERE 1=1
                       AND CNTR_NO = 'P_CSMR_YR'
                       AND CNTR_SN = 0 -- P_CSMR_SEQ
                       /* CST_SN 고객일련번호는 삭제된 컬럼 */
--                       AND CST_SN = (SELECT CST_SN
--                                               FROM TB_SVPD_CST_SV_EXCN_IZ
--                                              WHERE 1=1
--                                                AND CNTR_NO = 'P_CSMR_YR'
--                                                AND CNTR_SN = 0 --P_CSMR_SEQ
--                                                )
                       AND SUBSTR(AK_CHDT,1,6) = SUBSTR('CHEK_VST_DT',1,6)
                       AND CNFMDT IS NULL
                       AND AS_AK_DV_CD = '4'
                       AND MTR_PROCS_STAT_CD != '3'), '')
          FROM DUAL
    </select>

    <select id="selectBsPeriodChartBs05_07"
            resultType="com.kyowon.sms.wells.web.service.allocate.dvo.WsncBsPeriodChartResDvo">
        /* 주기표생성 작업 */
        SELECT DISTINCT
                  VST_MTHS
                , WRK_TYP_DTL
                , LPAD(ROW_NUMBER() OVER(ORDER BY ITEM_KND, PART_CD ASC),2,'0') AS CHNG_STG
                , ITEM_KND
                , PART_CD
                , QTY
                , VST_GB
             FROM (
                   /*최소 공배수 만큼 풀어 놓은 방문 주기표 */
                   SELECT DISTINCT
                          VST_NMN_N        AS VST_MTHS
                        , SV_BIZ_DCLSF_CD     AS WRK_TYP_DTL
                        , ''                    AS CHNG_STG
                        , '5'                   AS ITEM_KND
--                        , C.ST101_ITEM_CD|| C.ST101_PART_CD AS PART_CD
                        , A.PART_PD_CD AS PART_CD
--                        , B.LCIQTY              AS QTY
                        , A.PART_USE_QTY AS QTY
                        , A.VST_DV_CD AS VST_GB
                     FROM TB_PDBS_RGBS_WK_BASE_DTL A
--                        , KWMART.LD3050P B
--                        , LC_STOCK_ST101TB C /* Part Master, 우선 생략 */
                    WHERE 1=1
--                      AND B.LCICDE = C.ST101_SALE_CD
                      AND A.PDCT_PD_CD = 'NEW_GDS_CD'
--                      AND LCYEAR = 'P_CSMR_YR'
--                      AND LCCODE = P_CSMR_CD
--                      AND LCSEQN = (SELECT MAX(AC201_CSMR_SER)
--                                      FROM LC_ALLOCATE_AC201TB
--                                     WHERE 1=1
--                                       AND AC201_CSMR_YR = P_CSMR_YR
--                                       AND AC201_CSMR_CD = P_CSMR_CD)
--                      AND SUBSTR(CHEK_VST_DT,1,6) BETWEEN B.LCSTYM AND B.LCEDYM
                      /*22.08.18 */
                      AND (CASE WHEN 'NEW_GDS_CD' = '60100000000' THEN '1'
                                WHEN 'NEW_GDS_CD' = '60501000000' THEN '1'
                                WHEN 'NEW_GDS_CD' = '60502000000' THEN '1'
                                WHEN 'NEW_GDS_CD' = '60503000000' THEN '1'
                                WHEN 'NEW_GDS_CD' = '60504000000' THEN '1'
                                ELSE '2'
                           END) = '1'  /*고객선택 패기지를 선택한 경우만 처리하기 위해*/
                     AND (CASE WHEN LENGTH('NEW_PART_LIST') > 0 THEN '2' ELSE '1' END) = '1'   /*자유패키지를 선택하여 변경 한 경우는 KSS 자료가 없는 상태라 파라미터로 받은 값을 처리하기 위해*/

                    UNION ALL

                   /*자유선택 패키지 일 경우 입력 받은 파라미터로 처리*/
                   SELECT DISTINCT
                          A.VST_NMN_N        AS VST_MTHS
                        , A.SV_BIZ_DCLSF_CD     AS WRK_TYP_DTL
                        , ''                    AS CHNG_STG
                        , '5'                   AS ITEM_KND
--                        , C.ST101_ITEM_CD|| C.ST101_PART_CD AS PART_CD
                        , A.PART_PD_CD AS PART_CD
                        , TO_NUMBER(B.PART_QTY) AS QTY
                        , A.VST_DV_CD AS VST_GB
                     FROM TB_PDBS_RGBS_WK_BASE_DTL A
--                        , LC_STOCK_ST101TB C /* Part Master, 우선 생략 */
                        , (SELECT /*행을 구분자에 따라 열로 변경*/
                                  SUBSTR(PART_LIST, 1, INSTR(PART_LIST, ',',1,1)-1) AS PART_CD
                                , SUBSTR(PART_LIST, INSTR(PART_LIST, ',',1,1)+1, (CASE WHEN INSTR(PART_LIST, ',',1,2) > 0 THEN INSTR(PART_LIST, ',',1,2) - INSTR(PART_LIST, ',',1,1)-1
                                                                                       ELSE LENGTH(PART_LIST)
                                                                                  END)) AS PART_QTY
                             FROM (/*스트링을 행으로*/
                                   SELECT TRIM(REGEXP_SUBSTR(TXT, '[^|]+', 1, LEVEL)) AS PART_LIST
                                     FROM (SELECT 'NEW_PART_LIST' AS TXT FROM DUAL) T1
                                  CONNECT
                                       BY INSTR(TXT, '|', 1, LEVEL - 1) > 0)) B
                    WHERE 1=1
                      AND A.PDCT_PD_CD = 'NEW_GDS_CD'
--                      AND B.PART_CD = C.ST101_SALE_CD
                      AND (CASE WHEN LENGTH('NEW_PART_LIST') > 0 THEN '1' ELSE '2' END) = '1'   /*자유패키지를 선택하여 변경 한 경우는 KSS 자료가 없는 상태라 파라미터로 받은 값을 처리하기 위해*/

                    UNION ALL

                   SELECT DISTINCT
                          D.VST_NMN_N        AS VST_MTHS
                        , D.SV_BIZ_DCLSF_CD     AS WRK_TYP_DTL
                        , ''                    AS CHNG_STG
                        , '5'                   AS ITEM_KND
--                        , C.ST101_ITEM_CD|| C.ST101_PART_CD AS PART_CD
                        , D.PART_PD_CD AS PART_CD
--                        , B.LCIQTY              AS QTY
                        , D.PART_USE_QTY AS QTY
                        , D.VST_DV_CD AS VST_GB
                     FROM TB_PDBS_RGBS_WK_BASE_DTL D
--                        , KWMART.LD1010P A
--                        , KWMART.LD1020P B
--                        , LC_STOCK_ST101TB C /* Part Master, 우선 생략 */
                    WHERE 1=1
--                      AND B.LCICDE = C.ST101_SALE_CD
--                      AND B.LCPKAG = A.LCPKAG
--                      AND B.LCPSEQ = A.LCPSEQ
--                      AND CHEK_VST_DT BETWEEN A.LCSDAY AND A.LCEDAY
--                      AND CHEK_VST_DT BETWEEN B.LCSDAY AND B.LCEDAY /** 20220310 한상문C 요청 웰빙티캡슐 보리구성품 22.03.31 종료 적용 **/
--                      AND A.LCPKAG = SUBSTR(CO322_GDS_CD,3,3)
                      AND D.PDCT_PD_CD = 'NEW_GDS_CD'
                      AND SV_PD_CD = 'P_CYCL_TYP'

                    UNION ALL

                    /*배양액 20.05.01 부터*/
                    SELECT DISTINCT
                           A.VST_NMN_N       AS VST_MTHS
                         , A.SV_BIZ_DCLSF_CD    AS WRK_TYP_DTL
                         , ''                   AS CHNG_STG
                         , '6'                  AS ITEM_KND
--                         , ST101_ITEM_CD|| ST101_PART_CD AS PART_CD
                         , A.PART_PD_CD AS PART_CD
--                         , (CASE WHEN GET_ST101_SIZE('NEW_GDS_CD') = '배양액12'  THEN 12 /*22.04.28 이영진, ST101_SIZE 값을 활용해서 배양액12개 구분처리*/
--                                 ELSE 9
--                            END)                AS QTY
                         , 9 AS QTY -- cherro ::: GET_ST101_SIZE가 뭔지 알아야 처리할 수 있음.
                         , A.VST_DV_CD AS VST_GB
                      FROM TB_PDBS_RGBS_WK_BASE_DTL A
--                        , LC_STOCK_ST101TB C /* Part Master, 우선 생략 */
                     WHERE 1=1
                       AND A.PDCT_PD_CD = 'NEW_GDS_CD'
                       AND A.SV_PD_CD = 'P_CYCL_TYP'
--                       AND ST101_ITEM_CD || ST101_PART_CD IN ('49210300015', '49210300016', '49220300025', '49220300026')
                       AND A.PART_PD_CD IN ('49210300015', '49210300016', '49220300025', '49220300026')
--                       AND (CASE WHEN (SELECT MAX(LCPRD2)
--                                         FROM KWMART.LD3000P
--                                        WHERE 1=1
--                                          AND LCYEAR = TO_NUMBER(LPAD(TO_CHAR(P_CSMR_YR), 4, '0')) --모종 고객년도
--                                          AND LCCODE = TO_NUMBER(LPAD(TO_CHAR(P_CSMR_CD), 7, '0'))  --모종 고객번호
--                                      ) = '1' THEN '01'    /*와이드*/
--                                 WHEN (SELECT MAX(LCPRD2)
--                                         FROM KWMART.LD3000P
--                                        WHERE 1=1
--                                          AND LCYEAR = TO_NUMBER(LPAD(TO_CHAR(P_CSMR_YR), 4, '0')) --모종 고객년도
--                                          AND LCCODE = TO_NUMBER(LPAD(TO_CHAR(P_CSMR_CD), 7, '0'))  --모종 고객번호
--                                      ) = '2' THEN '02'    /*슬림*/
--                                 ELSE '00'
--                            END) = (CASE WHEN ST101_ITEM_CD || ST101_PART_CD IN ('49210300015', '49210300016') THEN '01'
--                                         WHEN ST101_ITEM_CD || ST101_PART_CD IN ('49220300025', '49220300026') THEN '02'
--                                         ELSE '00'
--                                    END)
--                       AND GET_ST101_SIZE(NEW_GDS_CD) != 'FarmMini'      /*22.04.28 이영진, ST101_SIZE 값을 활용해서 팜미니 구분처리*/ -- cherro ::: GET_ST101_SIZE가 뭔지 알아야 처리할 수 있음.
                       AND TO_CHAR(SYSDATE, 'YYYYMMDD') >= '20200501'

                     UNION ALL

                    /*배양액 미니 패키지(471~479) 배양액 A 3ml &lt; GP106/회당 투입량 12개, 배양액 B 3ml &lt; GP106/회당 투입량 12개 2022.4.6 이수진P */
                    SELECT DISTINCT
                           A.VST_NMN_N       AS VST_MTHS
                         , A.SV_BIZ_DCLSF_CD    AS WRK_TYP_DTL
                         , ''                   AS CHNG_STG
                         , '6'                  AS ITEM_KND
--                         , ST101_ITEM_CD|| ST101_PART_CD AS PART_CD
                         , A.PART_PD_CD AS PART_CD
                         , 12                   AS QTY
                         , A.VST_DV_CD         AS VST_GB
                      FROM TB_PDBS_RGBS_WK_BASE_DTL A
--                        , LC_STOCK_ST101TB C /* Part Master, 우선 생략 */
                     WHERE 1=1
                       AND A.PDCT_PD_CD = 'NEW_GDS_CD'
                       AND A.SV_PD_CD = 'P_CYCL_TYP'
--                       AND ST101_ITEM_CD || ST101_PART_CD IN ('49225300010', '49225300020')
                       AND A.PART_PD_CD IN ('49225300010', '49225300020')
--                       AND (CASE WHEN (SELECT MAX(LCPRD2)
--                                         FROM KWMART.LD3000P
--                                        WHERE 1=1
--                                          AND LCYEAR = TO_NUMBER(LPAD(TO_CHAR(P_CSMR_YR), 4, '0')) --모종 고객년도
--                                          AND LCCODE = TO_NUMBER(LPAD(TO_CHAR(P_CSMR_CD), 7, '0'))  --모종 고객번호
--                                      ) = '1' THEN '01'    /*와이드*/
--                                 WHEN (SELECT MAX(LCPRD2)
--                                         FROM KWMART.LD3000P
--                                        WHERE 1=1
--                                          AND LCYEAR = TO_NUMBER(LPAD(TO_CHAR(P_CSMR_YR), 4, '0')) --모종 고객년도
--                                          AND LCCODE = TO_NUMBER(LPAD(TO_CHAR(P_CSMR_CD), 7, '0'))  --모종 고객번호
--                                      ) = '2' THEN '02'    /*슬림*/
--                                 ELSE '00'
--                            END) = (CASE WHEN ST101_ITEM_CD || ST101_PART_CD IN ('49225300010', '49225300020')  THEN '02'
--                                         ELSE '00'
--                                    END)
--                       AND GET_ST101_SIZE(NEW_GDS_CD) = 'FarmMini'     /*22.04.28 이영진, ST101_SIZE 값을 활용해서 팜미니 구분처리*/  -- cherro ::: GET_ST101_SIZE가 뭔지 알아야 처리할 수 있음.
                       AND TO_CHAR(SYSDATE, 'YYYYMMDD') >= '20220401'

                     UNION ALL

                    /*300004129 49210-300020	POT TAG BS &lt; G01,G02*/
                    SELECT DISTINCT
                           T2.VST_NMN_N       AS VST_MTHS
                         , T2.SV_BIZ_DCLSF_CD    AS WRK_TYP_DTL
                         , ''                   AS CHNG_STG
                         , '6'                  AS ITEM_KND
--                         , T1.ST101_ITEM_CD|| T1.ST101_PART_CD AS PART_CD
                         , T2.PART_PD_CD AS PART_CD
--                         , (CASE WHEN (SELECT LPAD(MAX(LCPRD2),2,'0')
--                                         FROM KWMART.LD3000P
--                                        WHERE 1=1
--                                          AND LCYEAR = TO_NUMBER(LPAD(TO_CHAR(P_CSMR_YR), 4, '0')) --모종 고객년도
--                                          AND LCCODE = TO_NUMBER(LPAD(TO_CHAR(P_CSMR_CD), 7, '0'))  --모종 고객번호
--                                      ) = '01'  THEN 2
--                                 ELSE 1
--                            END)                AS QTY
                         , 1 AS QTY -- cherro ::: KWMART는 안쓰기로 했으니 우선 임시 값으로 대체함
                         , T2.VST_DV_CD AS VST_GB
                      FROM TB_PDBS_RGBS_WK_BASE_DTL T2
--                         , LC_STOCK_ST101TB T1 /* Part Master, 우선 생략 */
--                         , LC_STOCK_ST101TB T3 /* Part Master, 우선 생략 */
                     WHERE 1=1
                       AND T2.PDCT_PD_CD = 'NEW_GDS_CD'
                       AND T2.SV_PD_CD = 'P_CYCL_TYP'
--                       AND T1.ST101_ITEM_CD || T1.ST101_PART_CD IN ('49210300020')
                       AND T2.PART_PD_CD IN ('49210300020')
--                       AND T2.PDCT_PD_CD = T3.ST101_ITEM_CD || T3.ST101_PART_CD
--                       AND NOT (T3.ST101_ITEM_CD LIKE '6%' AND T3.ST101_NM_KOR LIKE '새싹%') /*새싹씨앗패키지가 아니고*/ -- cherro ::: 이거 처리 어떻게 하지...
                       AND TO_CHAR(SYSDATE, 'YYYYMMDD') >= '20200901'
                  )
    </select>

    <select id="selectBsPeriodChartBs05_24" resultType="java.lang.String">
        /*
            17.11.16 이영진 추가
        공기청정기 AK316ESA, AK320FSA 계절별 맞춤형 필터 적용
        3M1
        12 1 2 / 3 4 5 / 6 7 8 / 9 10 11 -> 43101-111080 / 43101-111060 / 43101-111070 / 43101-111090
         1,2M1
        12 1 / 2 3 4 5 / 6 7 / 8 9 10 11 -> 43101-111080 / 43101-111060 / 43101-111070 / 43101-111090
        */
        SELECT (CASE WHEN #{partCd} = '43101111080' AND 'P_CYCL_TYP' = '3M1' AND SUBSTR(#{chekVstDt},5,2) IN ('12', '01', '02') THEN '43101111080'
                     WHEN #{partCd} = '43101111080' AND 'P_CYCL_TYP' = '3M1' AND SUBSTR(#{chekVstDt},5,2) IN ('03', '04', '05') THEN '43101111060'
                     WHEN #{partCd} = '43101111080' AND 'P_CYCL_TYP' = '3M1' AND SUBSTR(#{chekVstDt},5,2) IN ('06', '07', '08') THEN '43101111070'
                     WHEN #{partCd} = '43101111080' AND 'P_CYCL_TYP' = '3M1' AND SUBSTR(#{chekVstDt},5,2) IN ('09', '10', '11') THEN '43101111090'

                     WHEN #{partCd} = '43101111080' AND 'P_CYCL_TYP' IN ('1M1', '2M1') AND SUBSTR(#{chekVstDt},5,2) IN ('12', '01') THEN '43101111080'
                     WHEN #{partCd} = '43101111080' AND 'P_CYCL_TYP' IN ('1M1', '2M1') AND SUBSTR(#{chekVstDt},5,2) IN ('02', '03', '04', '05') THEN '43101111060'
                     WHEN #{partCd} = '43101111080' AND 'P_CYCL_TYP' IN ('1M1', '2M1') AND SUBSTR(#{chekVstDt},5,2) IN ('06', '07') THEN '43101111070'
                     WHEN #{partCd} = '43101111080' AND 'P_CYCL_TYP' IN ('1M1', '2M1') AND SUBSTR(#{chekVstDt},5,2) IN ('08', '09', '10', '11') THEN '43101111090'

                     ELSE #{partCd}
                END) AS NEW_PART_CD
          FROM DUAL
    </select>
</mapper>
