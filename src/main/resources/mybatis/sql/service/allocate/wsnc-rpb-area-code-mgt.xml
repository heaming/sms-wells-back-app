<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncRpbAreaCodeMgtMapper">


    <select id="selectAreaCodes" resultType="com.kyowon.sms.wells.web.service.allocate.dvo.WsncRpbAreaCodeDvo">
	      SELECT /*+ leading(D3 D2) usae_nl(D3 D2) */
                 DISTINCT '' AS CHK
	           , D1.FR2P_LGLD_CD /* 앞2자리법정동코드 */
	           , D1.CTPV_NM /* 시도명 */
	           , D1.CTCTY_NM /* 시군구명 */
	           , D1.LAWC_EMD_NM /* 법정읍면동명 */
	           , D1.AMTD_NM /* 행정동명 */
	           , D2.LOCARA_SN /* 순번 */
	           , (SELECT LISTAGG(AD1.NEW_ADR_ZIP, ', ') WITHIN GROUP (ORDER BY AD1.NEW_ADR_ZIP)
	                FROM TB_SVPD_EGER_ASN_ADR_IZ AD1
	               WHERE 1=1
	                 AND AD1.FR2P_LGLD_CD = D2.FR2P_LGLD_CD
	                 AND AD1.CTPV_NM      = D2.CTPV_NM
	                 AND AD1.CTCTY_NM     = D2.CTCTY_NM
	                 AND AD1.LAWC_EMD_NM  = D2.LAWC_EMD_NM
	                 AND AD1.AMTD_NM      = D2.AMTD_NM
	                 AND AD1.EMD_SN       = (SELECT MAX(EMD_SN)
	                                          FROM TB_SVPD_EGER_ASN_ADR_IZ
	                                         WHERE NEW_ADR_ZIP = AD1.NEW_ADR_ZIP
	                                       )
	             ) AS ZIP_LIST /* 우편번호 List */
	           , D2.APY_STRTDT /* 적용시작일자 */
               , D2.APY_STRTDT AS APY_STRTDT_ORIGIN /* 적용시작일자 origin */
	           , D2.APY_ENDDT /* 적용종료일자 */
	           , D2.RPB_LOCARA_CD /* 책임지역코드 */
	           , D3.RPB_LOCARA_GRP_CD /* 책임지역그룹코드 */
	           , D3.VST_DOW_VAL /* 방문요일코드 */
	           , F_CMZ_CD_NM(#{session.tenantId}, 'LOCARA_VST_PRD_CD', D3.VST_DOW_VAL, #{session.langId}) AS VST_DOW_NM /* 방문요일명 */
	           , D3.MMT_AV_LDTM /* 이동평균소요시간 */
	           , D4.OG_NM /* 조직명 */
	           , D3.ICHR_PRTNR_NO /* 담당파트너번호 */
	           , D4.PRTNR_KNM /* 파트너한글명 */
	           , D3.LOCARA_CEN_STRU_ADR /* 지역중심건물주소 */
               , C1.CD_VLD_VAL AS ORDER_NO /* 정렬기준 */
	        FROM TB_SVPD_EGER_ASN_ADR_IZ D1 /* 엔지니어배정주소내역 */
	       INNER JOIN TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ D2 /* 책임지역관리주소내역 */
	          ON D1.FR2P_LGLD_CD = D2.FR2P_LGLD_CD
	         AND D1.CTPV_NM      = D2.CTPV_NM
	         AND D1.CTCTY_NM     = D2.CTCTY_NM
	         AND D1.LAWC_EMD_NM  = D2.LAWC_EMD_NM
	         AND D1.AMTD_NM      = D2.AMTD_NM
	         AND D2.ADR_ODR_NO     = (SELECT MAX(L1.ADR_ODR_NO)
	                                   FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ L1
	                                  WHERE 1=1
	                                    AND L1.FR2P_LGLD_CD = D2.FR2P_LGLD_CD
	                                    AND L1.CTPV_NM      = D2.CTPV_NM
	                                    AND L1.CTCTY_NM     = D2.CTCTY_NM
	                                    AND L1.LAWC_EMD_NM  = D2.LAWC_EMD_NM
	                                    AND L1.AMTD_NM      = D2.AMTD_NM)
	         AND D2.DTA_DL_YN    = 'N'
	       INNER JOIN TB_SVPD_RPB_LOCARA_PSIC_IZ D3 /* 책임지역담당자내역 */
	          ON D2.RPB_LOCARA_CD = D3.RPB_LOCARA_CD
	         AND D3.IZ_SN         = (SELECT MAX(L2.IZ_SN)
	                                   FROM TB_SVPD_RPB_LOCARA_PSIC_IZ L2
	                                  WHERE 1=1
	                                    AND L2.RPB_LOCARA_CD = D3.RPB_LOCARA_CD
	                                    AND L2.WK_GRP_CD = D3.WK_GRP_CD
	                                    AND #{applyDate} BETWEEN L2.APY_STRTDT AND L2.APY_ENDDT)
	         AND D3.DTA_DL_YN     = 'N'
	        LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ D4 /* 월파트너내역 */
		      ON D4.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
		     AND D4.PRTNR_NO = D3.ICHR_PRTNR_NO
		     AND D4.OG_TP_CD = D3.ICHR_PRTNR_OG_TP_CD
		     AND D4.DTA_DL_YN = 'N'
           INNER JOIN T_CMZ_CD_D C1 /* 코드상세 */
		      ON D1.FR2P_LGLD_CD = C1.USER_DFN_02
		     AND C1.CD_ID = 'LOCARA_CD'
		   WHERE 1=1
		     AND D1.DTA_DL_YN = 'N'
		     AND D1.EMD_SN    = (SELECT /*+ UNNEST */
                                        MAX(EMD_SN)
                                   FROM TB_SVPD_EGER_ASN_ADR_IZ
                                  WHERE NEW_ADR_ZIP = D1.NEW_ADR_ZIP)
		     AND #{applyDate} BETWEEN D2.APY_STRTDT AND D2.APY_ENDDT
		     AND #{applyDate} BETWEEN D3.APY_STRTDT AND D3.APY_ENDDT
		     AND D3.WK_GRP_CD = #{wkGrpCd}
		     <if test="@MybatisUtils@isNotEmpty(ogId)">
               AND D4.OG_ID = #{ogId}
           </if>
           <if test="@MybatisUtils@isNotEmpty(locaraCdFrom)">
               AND D2.RPB_LOCARA_CD <![CDATA[ >= ]]> #{locaraCdFrom}
           </if>
           <if test="@MybatisUtils@isNotEmpty(locaraCdTo)">
               AND D2.RPB_LOCARA_CD <![CDATA[ <= ]]> #{locaraCdTo}
           </if>
         <if test="@MybatisUtils@isNotEmpty(zipFrom)">
               AND D1.NEW_ADR_ZIP <![CDATA[ >= ]]> #{zipFrom}
           </if>
           <if test="@MybatisUtils@isNotEmpty(zipTo)">
               AND D1.NEW_ADR_ZIP <![CDATA[ <= ]]> #{zipTo}
           </if>
           <if test="@MybatisUtils@isNotEmpty(fr2pLgldCd)">
               AND D1.FR2P_LGLD_CD = #{fr2pLgldCd}
           </if>
           <if test="@MybatisUtils@isNotEmpty(ctctyNm)">
               AND D1.CTCTY_NM = #{ctctyNm}
           </if>
        ORDER BY C1.CD_VLD_VAL, D2.RPB_LOCARA_CD ,D1.FR2P_LGLD_CD, D1.CTPV_NM, D1.CTCTY_NM, D1.LAWC_EMD_NM, D1.AMTD_NM
    </select>

    <select id='selectLgldCtpvLocaras' resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncRpbAreaCodeMgtDto$LocaraCd">
        SELECT *
         FROM (
        SELECT DISTINCT CTPV_NM /* 시도명 */
             , RPB_LOCARA_CD /* 책임지역코드 */
          FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ T2 /* 책임지역관리주소내역 */
         WHERE DTA_DL_YN = 'N'
           AND ADR_ODR_NO =
               (
               SELECT MAX(ADR_ODR_NO)
                 FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ TT1
                WHERE TT1.FR2P_LGLD_CD = T2.FR2P_LGLD_CD
                  AND TT1.CTPV_NM = T2.CTPV_NM
                  AND TT1.CTCTY_NM = T2.CTCTY_NM
                  AND TT1.LAWC_EMD_NM = T2.LAWC_EMD_NM
                  AND TT1.AMTD_NM = T2.AMTD_NM
                  AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN TT1.APY_STRTDT AND TT1.APY_ENDDT
               )
        UNION ALL
        SELECT CTPV_NM /* 시도명 */
             , LPAD(MAX(RPB_LOCARA_CD), 3, '0') AS RPB_LOCARA_CD /* 책임지역코드 */
          FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ T2 /* 책임지역관리주소내역 */
         WHERE DTA_DL_YN = 'N'
           AND ADR_ODR_NO =
               (
               SELECT MAX(ADR_ODR_NO)
                 FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ TT1
                WHERE TT1.FR2P_LGLD_CD = T2.FR2P_LGLD_CD
                  AND TT1.CTPV_NM = T2.CTPV_NM
                  AND TT1.CTCTY_NM = T2.CTCTY_NM
                  AND TT1.LAWC_EMD_NM = T2.LAWC_EMD_NM
                  AND TT1.AMTD_NM = T2.AMTD_NM
                  AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN TT1.APY_STRTDT AND TT1.APY_ENDDT
               )
         GROUP BY CTPV_NM
        )
        ORDER BY RPB_LOCARA_CD
    </select>

    <select id="selectCountAreaCodePsic" resultType="int">
        SELECT COUNT(1)
          FROM TB_SVPD_RPB_LOCARA_PSIC_IZ /* 책임지역담당자내역 */
         WHERE RPB_LOCARA_CD = #{chLocaraCd}
    </select>

    <insert id="insertAreaCode">
        INSERT INTO TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ /* 책임지역관리주소내역 */
             ( RPB_LOCARA_CD
             , LOCARA_SN
             , APY_STRTDT
             , APY_ENDDT
             , FR2P_LGLD_CD
             , CTPV_NM
             , CTCTY_NM
             , LAWC_EMD_NM
             , AMTD_NM
             , ADR_ODR_NO
             , DTA_DL_YN
              <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             ( #{chLocaraCd}
             , (SELECT MAX(LOCARA_SN) + 1
                 FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ
               )
             , #{apyStrtdt}
             , #{apyEnddt}
             , #{fr2pLgldCd}
             , #{ctpvNm}
             , #{ctctyNm}
             , #{lawcEmdNm}
             , #{amtdNm}
             , NVL((SELECT LPAD(MAX(ADR_ODR_NO)+1, 3, '0')
                      FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ
                     WHERE FR2P_LGLD_CD = #{fr2pLgldCd}
                       AND CTPV_NM      = #{ctpvNm}
                       AND CTCTY_NM     = #{ctctyNm}
                       AND LAWC_EMD_NM  = #{lawcEmdNm}
                       AND AMTD_NM      = #{amtdNm}), '001')
             , 'N'
              <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <insert id="insertAreaCodePsic">
        INSERT INTO TB_SVPD_RPB_LOCARA_PSIC_IZ /* 책임지역담당자내역 */
             ( WK_GRP_CD
             , RPB_LOCARA_CD
             , IZ_SN
             , ICHR_PRTNR_OG_TP_CD
             , ICHR_PRTNR_NO
             , PPRN_ICHR_PRTNR_OG_TP_CD
             , PPRN_ICHR_PRTNR_NO1
             , PPRN_ICHR_PRTNR_NO2
             , PPRN_ICHR_PRTNR_NO3
             , PPRN_ICHR_PRTNR_NO4
             , PPRN_ICHR_PRTNR_NO5
             , VST_DOW_VAL
             , MMT_AV_LDTM
             , RSTR_CNDT_USE_YN
             , UDSN_USE_YN
             , LOCARA_CEN_STRU_ADR
             , SAT_WRK_YN
             , RPB_LOCARA_GRP_CD
             , APY_STRTDT
             , APY_ENDDT
             , DTA_DL_YN
              <include refid="COMMON.insertSystemField"/>
             )
        SELECT WK_GRP_CD
             , #{chLocaraCd}
             , '001' AS IZ_SN
             , ICHR_PRTNR_OG_TP_CD
             , ICHR_PRTNR_NO
             , PPRN_ICHR_PRTNR_OG_TP_CD
             , PPRN_ICHR_PRTNR_NO1
             , PPRN_ICHR_PRTNR_NO2
             , PPRN_ICHR_PRTNR_NO3
             , PPRN_ICHR_PRTNR_NO4
             , PPRN_ICHR_PRTNR_NO5
             , VST_DOW_VAL
             , MMT_AV_LDTM
             , RSTR_CNDT_USE_YN
             , UDSN_USE_YN
             , LOCARA_CEN_STRU_ADR
             , SAT_WRK_YN
             , RPB_LOCARA_GRP_CD
             , TO_CHAR(SYSDATE, 'YYYYMMDD')
             , '99991231'
             , 'N'
             <include refid="COMMON.insertSystemFieldValue"/>
         FROM TB_SVPD_RPB_LOCARA_PSIC_IZ I1 /* 책임지역담당자내역 */
        WHERE 1=1
          AND RPB_LOCARA_CD = #{prbLocaraCd}
          AND IZ_SN         = (SELECT MAX(IZ_SN)
                                 FROM TB_SVPD_RPB_LOCARA_PSIC_IZ I2
                                WHERE RPB_LOCARA_CD = I1.RPB_LOCARA_CD
                                  AND WK_GRP_CD     = I1.WK_GRP_CD
                                  AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN I2.APY_STRTDT AND I2.APY_ENDDT
                              )
         ORDER BY RPB_LOCARA_CD, WK_GRP_CD
    </insert>

</mapper>
