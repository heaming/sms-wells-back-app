<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncRpbAreaCodeMgtMapper">

    <select id="selectAreaCodePages" resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncRpbAreaCodeMgtDto$SearchRes">
        WITH
        TEMP01 AS (
            SELECT DISTINCT A1.PD_CD /* 선택한 작업그룹에 해당하는 상품 리스트 */
              FROM TB_SVPD_BPD_BIZ_TP_WK_GRP_IZ A1 /* 상품별업무유형별작업그룹내역 */
             WHERE 1 = 1
               AND A1.DTA_DL_YN = 'N'
               AND A1.WK_GRP_CD = #{wkGrpCd}
               AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN A1.APY_STRTDT AND A1.APY_ENDDT
               AND A1.IZ_SN = (SELECT MAX(IZ_SN)
                              FROM TB_SVPD_BPD_BIZ_TP_WK_GRP_IZ
                             WHERE 1 = 1
                               AND PD_CD = A1.PD_CD
                               AND WK_GRP_CD = A1.WK_GRP_CD
                               AND SV_BIZ_DCLSF_CD = A1.SV_BIZ_DCLSF_CD
                               AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN APY_STRTDT AND APY_ENDDT
                               AND DTA_DL_YN = 'N')
        ),
        TEMP1 AS (
          SELECT B3.FR2P_LGLD_CD
               , B3.CTPV_NM
               , B3.CTCTY_NM
               , B3.LAWC_EMD_NM
               , B3.AMTD_NM
               , SUM(MGT_CNT) AS MGT_CNT
            FROM (SELECT NEW_ADR_ZIP
                       , SUM(MGT_CNT) AS MGT_CNT
                    FROM (SELECT NEW_ADR_ZIP
                               , MGT_CNT
                            FROM (SELECT A1.NEW_ADR_ZIP
                                       , M1.PDCT_PD_CD
                                       , COUNT(1) AS MGT_CNT
                                    FROM (SELECT CNTR_NO, CNTR_SN, PDCT_PD_CD, ADR_ID
                                            FROM TB_SVPD_MCBY_CST_SV_OJ_IZ
                                           WHERE DTA_DL_YN = 'N'
                                             AND MNGT_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                                         ) M1 /* 월별고객서비스대상내역 */
                                   INNER JOIN TB_SVPD_CST_SV_EXCN_IZ M2				 /* 고객서비스수행내역 */ -- 수행 내역 테이블로 변경
                                      ON M2.CNTR_NO = M1.CNTR_NO
                                     AND M2.CNTR_SN = M1.CNTR_SN
                                     AND M2.DTA_DL_YN = 'N'
                                   INNER JOIN TB_GBCO_ADR_BAS A1 /* 주소지기본 */
                                      ON A1.ADR_ID = M1.ADR_ID
                                     AND A1.DTA_DL_YN = 'N'
                                   WHERE 1 = 1
                                     AND (M2.REQD_DT IS NULL OR M2.CHNG_DT IS NULL OR M2.CPS_DT IS NULL)
                                  GROUP BY A1.NEW_ADR_ZIP, M1.PDCT_PD_CD
                                 ) V1
                           INNER JOIN TEMP01 P1
                              ON P1.PD_CD = V1.PDCT_PD_CD
                      )
                      GROUP BY NEW_ADR_ZIP
                  ) V4
            INNER JOIN TB_SVPD_EGER_ASN_ADR_IZ B3
               ON B3.NEW_ADR_ZIP = V4.NEW_ADR_ZIP
              AND B3.EMD_SN      = (SELECT MAX(EMD_SN)
                                      FROM TB_SVPD_EGER_ASN_ADR_IZ
                                     WHERE NEW_ADR_ZIP = B3.NEW_ADR_ZIP
                                   )
              AND B3.DTA_DL_YN = 'N'
            GROUP BY B3.FR2P_LGLD_CD, B3.CTPV_NM, B3.CTCTY_NM, B3.LAWC_EMD_NM, B3.AMTD_NM
        ),
	    TEMP2 AS (
	      SELECT E2.FR2P_LGLD_CD
	           , E2.CTPV_NM
	           , E2.CTCTY_NM
	           , E2.LAWC_EMD_NM
	           , E2.AMTD_NM
	           , ROUND(SUM(V2.WRK_CNT)/3,2) AS WRK_CNT
	        FROM (SELECT NEW_ADR_ZIP
                     , SUM(WRK_CNT) AS WRK_CNT
        		  FROM (SELECT V3.NEW_ADR_ZIP
                             , COUNT(1) AS WRK_CNT
                          FROM TB_SVPD_CST_SVAS_IST_ASN_IZ T1 /* 고객서비스AS설치배정내역 */
                         INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ T2 /* 고객서비스AS설치대상내역 */
                            ON T2.CST_SV_ASN_NO = T1.CST_SV_ASN_NO
                           AND T2.DTA_DL_YN = 'N'
                         INNER JOIN (SELECT /*+ INDEX(V1 IX_SSCT_CNTR_ADR_REL_01) */
                                    V1.DTL_CNTR_NO, V1.DTL_CNTR_SN, V2.ADR_ID
                             FROM TB_SSCT_CNTR_ADR_REL V1 /* 계약주소관계 */
                            INNER JOIN TB_SSCT_CNTR_ADRPC_BAS V2 /* 계약주소지기본 */
                               ON V2.CNTR_ADRPC_ID = V1.CNTR_ADRPC_ID
                              AND V2.DTA_DL_YN = 'N'
                            WHERE V1.DTA_DL_YN = 'N'
                              AND V1.ADRPC_TP_CD = '3' /* 설치처 */
                              AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN V1.VL_STRT_DTM AND V1.VL_END_DTM
                             ) T3
                            ON T3.DTL_CNTR_NO = T1.CNTR_NO
                           AND T3.DTL_CNTR_SN = T1.CNTR_SN
                         INNER JOIN TB_GBCO_ADR_BAS V3 /* 주소지기본 */
                            ON V3.ADR_ID = T3.ADR_ID
                           AND V3.DTA_DL_YN = 'N'
                         WHERE T1.DTA_DL_YN = 'N'
                           AND T1.WK_PRGS_STAT_CD = '20' /* 작업진행상태 = '작업완료' */
                           AND T1.WK_EXCN_DT BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE, -3), 'YYYYMM') || '01' AND TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM') || '31'
                           AND T1.WK_GRP_CD = #{wkGrpCd}
                         GROUP BY V3.NEW_ADR_ZIP
        				 UNION ALL
        				SELECT T3.NEW_ADR_ZIP
        				     , COUNT(1) AS WRK_CNT
        				  FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ T1 /* 고객서비스BS배정내역 */
        				 INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ T2 /* 고객서비스BS대상내역 */
        				    ON T2.CST_SV_ASN_NO = T1.CST_SV_ASN_NO
        				   AND T2.DTA_DL_YN = 'N'
        				 INNER JOIN TB_GBCO_ADR_BAS T3 /* 주소지기본 */
        				    ON T3.ADR_ID = T2.ADR_ID
        				   AND T3.DTA_DL_YN = 'N'
        				 WHERE T1.DTA_DL_YN = 'N'
        				   AND T1.VST_PRGS_STAT_CD = '20' /* 작업진행상태 = '작업완료' */
        				   AND T1.CNFM_PSIC_DV_CD = '2'
                           -- 조회 속도를 높이기 위해 Key부분에 Index 조건 추가 --
        				   AND T1.ASN_OJ_YM BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE, -4), 'YYYYMM') AND TO_CHAR(ADD_MONTHS(SYSDATE, 0), 'YYYYMM')
        				   AND T1.WK_EXCN_DT BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE, -3), 'YYYYMM') || '01' AND TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM') || '31'
        				   AND T1.WK_GRP_CD = #{wkGrpCd}
        				 GROUP BY T3.NEW_ADR_ZIP
        		 		)
        		 GROUP BY NEW_ADR_ZIP
	             ) V2
	       INNER JOIN TB_SVPD_EGER_ASN_ADR_IZ E2
	          ON V2.NEW_ADR_ZIP = E2.NEW_ADR_ZIP
	         AND E2.EMD_SN      = (SELECT MAX(EMD_SN)
	                                 FROM TB_SVPD_EGER_ASN_ADR_IZ
	                                WHERE 1=1
	                                  AND NEW_ADR_ZIP = E2.NEW_ADR_ZIP)
	         AND E2.DTA_DL_YN   = 'N'
	       GROUP BY E2.FR2P_LGLD_CD, E2.CTPV_NM, E2.CTCTY_NM, E2.LAWC_EMD_NM, E2.AMTD_NM
	    ),
	    TEMP3 AS (
	      SELECT DISTINCT '' AS CHK
	           , D1.FR2P_LGLD_CD
	           , D1.CTPV_NM
	           , D1.CTCTY_NM
	           , D1.LAWC_EMD_NM
	           , D1.AMTD_NM
	           , D2.LOCARA_SN
	           , (SELECT LISTAGG(AD1.NEW_ADR_ZIP, ', ') WITHIN GROUP (ORDER BY AD1.NEW_ADR_ZIP)
	                FROM TB_SVPD_EGER_ASN_ADR_IZ AD1
	               WHERE 1=1
	                 AND AD1.FR2P_LGLD_CD = D2.FR2P_LGLD_CD
	                 AND AD1.CTPV_NM      = D2.CTPV_NM
	                 AND AD1.CTCTY_NM     = D2.CTCTY_NM
	                 AND AD1.LAWC_EMD_NM  = D2.LAWC_EMD_NM
	                 AND AD1.AMTD_NM      = D2.AMTD_NM
	                 AND AD1.EMD_SN       = (SELECT MAX(EMD_SN)
	                                          FROM TB_SVPD_EGER_ASN_ADR_IZ
	                                         WHERE NEW_ADR_ZIP = AD1.NEW_ADR_ZIP
	                                       )
	             ) AS ZIP_LIST
	           , D2.APY_STRTDT
	           , D2.APY_ENDDT
	           , D2.RPB_LOCARA_CD
	           , D3.RPB_LOCARA_GRP_CD
	           , D3.VST_DOW_VAL
	           , F_CMZ_CD_NM(#{session.tenantId}, 'LOCARA_VST_PRD_CD', D3.VST_DOW_VAL, #{session.langId}) AS VST_DOW_NM
	           , D3.MMT_AV_LDTM --확인필요
	           , D4.OG_NM
	           , D3.ICHR_PRTNR_NO
	           , D4.PRTNR_KNM
	           , D3.LOCARA_CEN_STRU_ADR --확인필요
	        FROM TB_SVPD_EGER_ASN_ADR_IZ D1
	       INNER JOIN TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ D2
	          ON D1.FR2P_LGLD_CD = D2.FR2P_LGLD_CD
	         AND D1.CTPV_NM      = D2.CTPV_NM
	         AND D1.CTCTY_NM     = D2.CTCTY_NM
	         AND D1.LAWC_EMD_NM  = D2.LAWC_EMD_NM
	         AND D1.AMTD_NM      = D2.AMTD_NM
	         AND D2.ADR_ODR_NO     = (SELECT MAX(L1.ADR_ODR_NO)
	                                   FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ L1
	                                  WHERE 1=1
	                                    AND L1.FR2P_LGLD_CD = D2.FR2P_LGLD_CD
	                                    AND L1.CTPV_NM      = D2.CTPV_NM
	                                    AND L1.CTCTY_NM     = D2.CTCTY_NM
	                                    AND L1.LAWC_EMD_NM  = D2.LAWC_EMD_NM
	                                    AND L1.AMTD_NM      = D2.AMTD_NM
	                                    AND #{applyDate} BETWEEN L1.APY_STRTDT AND L1.APY_ENDDT)
	         AND D2.DTA_DL_YN    = 'N'
	       INNER JOIN TB_SVPD_RPB_LOCARA_PSIC_IZ D3
	          ON D2.RPB_LOCARA_CD = D3.RPB_LOCARA_CD
	         AND D3.IZ_SN         = (SELECT MAX(L2.IZ_SN)
	                                   FROM TB_SVPD_RPB_LOCARA_PSIC_IZ L2
	                                  WHERE 1=1
	                                    AND L2.RPB_LOCARA_CD = D3.RPB_LOCARA_CD
	                                    AND L2.WK_GRP_CD = D3.WK_GRP_CD
	                                    AND #{applyDate} BETWEEN L2.APY_STRTDT AND L2.APY_ENDDT)
	         AND D3.DTA_DL_YN     = 'N'
	        LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ D4 /* 월파트너내역 */
		      ON D4.BASE_YM = SUBSTR(D3.APY_STRTDT, 1, 6)
		     AND D4.PRTNR_NO = D3.ICHR_PRTNR_NO
		     AND D4.OG_TP_CD = D3.ICHR_PRTNR_OG_TP_CD
		     AND D4.DTA_DL_YN = 'N'
		   WHERE 1=1
		     AND D1.DTA_DL_YN = 'N'
		     AND D1.EMD_SN    = (SELECT /*+ UNNEST */
                                        MAX(EMD_SN)
                                   FROM TB_SVPD_EGER_ASN_ADR_IZ
                                  WHERE NEW_ADR_ZIP = D1.NEW_ADR_ZIP)
		     AND #{applyDate} BETWEEN D2.APY_STRTDT AND D2.APY_ENDDT
		     AND #{applyDate} BETWEEN D3.APY_STRTDT AND D3.APY_ENDDT
		     AND D3.WK_GRP_CD = #{wkGrpCd}
		     <if test="@MybatisUtils@isNotEmpty(ogId)">
               AND D4.OG_ID = #{ogId}
           </if>
           <if test="@MybatisUtils@isNotEmpty(locaraCdFrom)">
               AND D2.RPB_LOCARA_CD <![CDATA[ >= ]]> #{locaraCdFrom}
           </if>
           <if test="@MybatisUtils@isNotEmpty(locaraCdTo)">
               AND D2.RPB_LOCARA_CD <![CDATA[ <= ]]> #{locaraCdTo}
           </if>
         <if test="@MybatisUtils@isNotEmpty(zipFrom)">
               AND D1.NEW_ADR_ZIP <![CDATA[ >= ]]> #{zipFrom}
           </if>
           <if test="@MybatisUtils@isNotEmpty(zipTo)">
               AND D1.NEW_ADR_ZIP <![CDATA[ <= ]]> #{zipTo}
           </if>
           <if test="@MybatisUtils@isNotEmpty(fr2pLgldCd)">
               AND D1.FR2P_LGLD_CD = #{fr2pLgldCd}
           </if>
           <if test="@MybatisUtils@isNotEmpty(ctctyNm)">
               AND D1.CTCTY_NM = #{ctctyNm}
           </if>
	    )
	    SELECT /*+ USE_HASH(TM1 TM2 TM3) */
               TM3.CHK
             , TM3.FR2P_LGLD_CD
	         , TM3.CTPV_NM
	         , TM3.CTCTY_NM
	         , TM3.LAWC_EMD_NM
	         , TM3.AMTD_NM
	         , TM3.LOCARA_SN
	         , TM3.ZIP_LIST
	         , TM3.APY_STRTDT
	         , TM3.APY_ENDDT
	         , TM1.MGT_CNT
	         , TM2.WRK_CNT
	         , TM3.RPB_LOCARA_CD
	         , TM3.RPB_LOCARA_GRP_CD
	         , TM3.VST_DOW_VAL
	         , TM3.VST_DOW_NM
	         , TM3.MMT_AV_LDTM --확인필요
	         , TM3.OG_NM
	         , TM3.ICHR_PRTNR_NO
	         , TM3.PRTNR_KNM
	         , TM3.LOCARA_CEN_STRU_ADR --확인필요
	      FROM TEMP3 TM3
	      LEFT OUTER JOIN TEMP1 TM1
	        ON TM3.FR2P_LGLD_CD = TM1.FR2P_LGLD_CD
	       AND TM3.CTPV_NM      = TM1.CTPV_NM
	       AND TM3.CTCTY_NM     = TM1.CTCTY_NM
	       AND TM3.LAWC_EMD_NM  = TM1.LAWC_EMD_NM
	       AND TM3.AMTD_NM      = TM1.AMTD_NM
	      LEFT OUTER JOIN TEMP2 TM2
	        ON TM3.FR2P_LGLD_CD = TM2.FR2P_LGLD_CD
	       AND TM3.CTPV_NM      = TM2.CTPV_NM
	       AND TM3.CTCTY_NM     = TM2.CTCTY_NM
	       AND TM3.LAWC_EMD_NM  = TM2.LAWC_EMD_NM
	       AND TM3.AMTD_NM      = TM2.AMTD_NM
	     WHERE 1=1
	     ORDER BY TM3.RPB_LOCARA_CD ,TM3.FR2P_LGLD_CD, TM3.CTPV_NM, TM3.CTCTY_NM, TM3.LAWC_EMD_NM, TM3.AMTD_NM
    </select>

    <select id="selectCountAreaCodePsic" resultType="int">
        SELECT COUNT(1)
          FROM TB_SVPD_RPB_LOCARA_PSIC_IZ
         WHERE RPB_LOCARA_CD = #{chLocaraCd}
    </select>

    <insert id="insertAreaCode">
        INSERT INTO TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ
             ( RPB_LOCARA_CD
             , LOCARA_SN
             , APY_STRTDT
             , APY_ENDDT
             , FR2P_LGLD_CD
             , CTPV_NM
             , CTCTY_NM
             , LAWC_EMD_NM
             , AMTD_NM
             , ADR_ODR_NO
             , DTA_DL_YN
              <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             ( #{chLocaraCd}
             , (SELECT MAX(LOCARA_SN) + 1
                 FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ
               )
             , #{apyStrtdt}
             , #{apyEnddt}
             , #{fr2pLgldCd}
             , #{ctpvNm}
             , #{ctctyNm}
             , #{lawcEmdNm}
             , #{amtdNm}
             , NVL((SELECT LPAD(MAX(ADR_ODR_NO)+1, 3, '0')
                      FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ
                     WHERE FR2P_LGLD_CD = #{fr2pLgldCd}
                       AND CTPV_NM      = #{ctpvNm}
                       AND CTCTY_NM     = #{ctctyNm}
                       AND LAWC_EMD_NM  = #{lawcEmdNm}
                       AND AMTD_NM      = #{amtdNm}), '001')
             , 'N'
              <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <insert id="insertAreaCodePsic">
        INSERT INTO TB_SVPD_RPB_LOCARA_PSIC_IZ
             ( WK_GRP_CD
             , RPB_LOCARA_CD
             , IZ_SN
             , ICHR_PRTNR_OG_TP_CD
             , ICHR_PRTNR_NO
             , PPRN_ICHR_PRTNR_OG_TP_CD
             , PPRN_ICHR_PRTNR_NO1
             , PPRN_ICHR_PRTNR_NO2
             , PPRN_ICHR_PRTNR_NO3
             , PPRN_ICHR_PRTNR_NO4
             , PPRN_ICHR_PRTNR_NO5
             , VST_DOW_VAL
             , MMT_AV_LDTM
             , RSTR_CNDT_USE_YN
             , UDSN_USE_YN
             , LOCARA_CEN_STRU_ADR
             , SAT_WRK_YN
             , RPB_LOCARA_GRP_CD
             , APY_STRTDT
             , APY_ENDDT
             , DTA_DL_YN
              <include refid="COMMON.insertSystemField"/>
             )
        SELECT WK_GRP_CD
             , #{chLocaraCd}
             , '001' AS IZ_SN
             , ICHR_PRTNR_OG_TP_CD
             , ICHR_PRTNR_NO
             , PPRN_ICHR_PRTNR_OG_TP_CD
             , PPRN_ICHR_PRTNR_NO1
             , PPRN_ICHR_PRTNR_NO2
             , PPRN_ICHR_PRTNR_NO3
             , PPRN_ICHR_PRTNR_NO4
             , PPRN_ICHR_PRTNR_NO5
             , VST_DOW_VAL
             , MMT_AV_LDTM
             , RSTR_CNDT_USE_YN
             , UDSN_USE_YN
             , LOCARA_CEN_STRU_ADR
             , SAT_WRK_YN
             , RPB_LOCARA_GRP_CD
             , TO_CHAR(SYSDATE, 'YYYYMMDD')
             , '99991231'
             , 'N'
             , ''
             , '145AUTO'
             , ''
             , ''
             , ''
             , '145AUTO'
             , ''
             , ''
         FROM TB_SVPD_RPB_LOCARA_PSIC_IZ I1
        WHERE 1=1
          AND RPB_LOCARA_CD = #{prbLocaraCd}
          AND IZ_SN         = (SELECT MAX(IZ_SN)
                                 FROM TB_SVPD_RPB_LOCARA_PSIC_IZ I2
                                WHERE RPB_LOCARA_CD = I1.RPB_LOCARA_CD
                                  AND WK_GRP_CD     = I1.WK_GRP_CD
                                  AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN I2.APY_STRTDT AND I2.APY_ENDDT
                              )
         ORDER BY RPB_LOCARA_CD, WK_GRP_CD
    </insert>

</mapper>
