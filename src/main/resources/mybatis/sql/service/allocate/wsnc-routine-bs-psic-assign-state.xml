<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncRoutineBsPsicAssignStateMapper">
    <resultMap id="cstSignCn" type="hashMap">
        <result column="CST_SIGN_CN" jdbcType="BLOB" javaType="byte[]"></result>
    </resultMap>
    <select id="selectRoutineBsPsicAssignState" resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncRoutineBsPsicAssignStateDto$SearchRes">
        SELECT /*+INDEX (B2 IX_SVPD_PD_BC_RPBL_APLC_IZ_01) */
               '' AS CHK
             , (CASE WHEN B1.CNTR_NO IS NOT NULL OR B2.CNTR_NO IS NOT NULL
                     THEN 'Y'
                ELSE '' END) AS SN_RPBL_YN  /*제품시리얼 재발행 여부*/
             , C2.CNTR_CST_NO               /*고객번호*/
             , CS1.CST_GD_CD                /*고객등급*/
             , F_CMZ_CD_NM('TNT_WELLS', 'CST_GD_CD',CS1.CST_GD_CD, 'ko') AS CST_GD_NM  /*고객등급, 1 일반, 2 VIP, 3 엘로우*//*고객등급명*/
             , (CASE WHEN CN1.CST_SV_ASN_NO IS NOT NULL THEN 'Y' ELSE '' END) AS CST_CNTT_YN    /*컨택완료*/
             , CN1.CST_SV_ASN_NO
             , SV2.VST_PRGS_STAT_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'WK_PRGS_STAT_CD',SV2.VST_PRGS_STAT_CD, 'ko') AS VST_PRGS_STAT_NM
             , (CASE /*철거일자 유무에 따라 표시*/
                     WHEN C6.RSG_FSH_DT IS NOT NULL THEN '취소'
                     /*만료 유무 표시*/
                     WHEN C1.CNTR_PD_STRTDT IS NOT NULL AND ((ROUND(MONTHS_BETWEEN(TO_CHAR(SYSDATE,'YYYYMM')||'01' , SUBSTR(C1.CNTR_PD_STRTDT,1,6)||'01'),0) BETWEEN '57' AND '60') AND C1.SELL_TP_CD = '2') THEN '만료'
                     /*컨택 코드 값에 따라 표시*/
                     WHEN CN1.ABSNC_RSON_CD = '11' THEN '판매'
                     WHEN CN1.ABSNC_RSON_CD = '12' THEN '안내'
                     WHEN CN1.ABSNC_RSON_CD = '13' THEN '문자'
                     WHEN CN1.ABSNC_RSON_CD = '21' THEN '취예'
                     WHEN CN1.ABSNC_RSON_CD = '22' THEN '이사'
                     WHEN CN1.ABSNC_RSON_CD = '23' THEN '연체'
                     WHEN CN1.ABSNC_RSON_CD = '24' THEN '거부'
                     WHEN CN1.ABSNC_RSON_CD = '25' THEN '두절'
                     WHEN CN1.ABSNC_RSON_CD = '26' THEN '여행'
                     WHEN CN1.ABSNC_RSON_CD = '27' THEN '익월'
                     WHEN CN1.ABSNC_RSON_CD = '31' THEN '이관'
                     WHEN CN1.ABSNC_RSON_CD = '32' THEN 'A/S'
                     /*방문예정일자 값에 따라 표시 (연수기가 아니면 '월초', '월중', '월말' 로 표시, 연수기 일반 이라면 '일상', '일하'로 표시, 연수기 특별이라면 '특상', '특하'로 표시)*/
                     WHEN ((CASE WHEN P1.PD_PRP_VAL20 IS NULL THEN SUBSTR(P1.PD_PRP_VAL01,2,1) ELSE P1.PD_PRP_VAL20 END) != '4'
                        AND SUBSTR(SV1.VST_DUEDT,7,8) >= 00 AND SUBSTR(SV1.VST_DUEDT,7,8) <![CDATA[ <= ]]> 10) THEN '월초'
                     WHEN ((CASE WHEN P1.PD_PRP_VAL20 IS NULL THEN SUBSTR(P1.PD_PRP_VAL01,2,1) ELSE P1.PD_PRP_VAL20 END) != '4'
                        AND SUBSTR(SV1.VST_DUEDT,7,8) >= 11 AND SUBSTR(SV1.VST_DUEDT,7,8) <![CDATA[ <= ]]> 20) THEN '월중'
                     WHEN ((CASE WHEN P1.PD_PRP_VAL20 IS NULL THEN SUBSTR(P1.PD_PRP_VAL01,2,1) ELSE P1.PD_PRP_VAL20 END) != '4'
                        AND SUBSTR(SV1.VST_DUEDT,7,8) >= 21) THEN '월말'
                     /*2017년 이후 AC201_USGE = '2' 인 상품이 없고, 차세대에서는 SV_PD_TP_CD 값으로 전환되었는데 의미가 다름*/
                     WHEN ((CASE WHEN P1.PD_PRP_VAL20 IS NULL THEN SUBSTR(P1.PD_PRP_VAL01,2,1) ELSE P1.PD_PRP_VAL20 END) = '4'
                        AND SUBSTR(SV1.VST_DUEDT,7,8) >= 01 AND SUBSTR(SV1.VST_DUEDT,7,8) <![CDATA[ <= ]]> 14) THEN '일상'
                     WHEN ((CASE WHEN P1.PD_PRP_VAL20 IS NULL THEN SUBSTR(P1.PD_PRP_VAL01,2,1) ELSE P1.PD_PRP_VAL20 END) = '4'
                        AND SUBSTR(SV1.VST_DUEDT,7,8) >= 15) THEN '일하'
                     ELSE ''
                END) AS STAT_DTL
             , SV2.CNTR_NO || '-' ||SV2.CNTR_SN AS CNTR_DTL_NO   /*계약번호+계약일련번호*/
             , SV2.CNTR_NO                  /*계약번호*/
             , SV2.CNTR_SN                  /*계약일련번호*/
             , C4.RCGVP_KNM                 /**설치자명*/
             , C4.CRAL_LOCARA_TNO           /*휴대지역전화번호*/
             , C4.MEXNO_ENCR                /*휴대전화국번호암호화*/
             , C4.CRAL_IDV_TNO              /*휴대개별전화번호*/
             , C4.LOCARA_TNO                /*지역전화번호*/
             , C4.EXNO_ENCR                 /*전화국번호암호화*/
             , C4.IDV_TNO                   /*개별전화번호*/
             , P1.PD_CD                     /*상품코드*/
             , P2.PD_NM                     /*상품명*/
             , C1.SELL_TP_CD                /*판매유형*/
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', C1.SELL_TP_CD , 'ko') AS SELL_TP_NM  /*판매유형코드 : 1 일시불, 2 렌탈/리스, 3 멤버십, 4 회사설치, 5 유지관리, 6 정기배송, 9 필터*/
             , C1.SELL_TP_DTL_CD            /*판매유형상세*/
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_DTL_CD', C1.SELL_TP_DTL_CD , 'ko') AS SELL_TP_DTL_NM  /*판매유형상세코드명*/
             , SV2.MNGER_RGLVL_DV_CD        /*매니저급지구분코드*/
             , F_CMZ_CD_NM('TNT_WELLS', 'MNGER_RGLVL_DV_CD', SV2.MNGER_RGLVL_DV_CD , 'ko') AS MNGER_RGLVL_DV_NM  /*매니저급지구분코드, 1 정상, 3 1급지, 4 2급지*/
             /*배정자료 생성 시 주소*/
             , C5.NEW_ADR_ZIP
             , C5.RNADR || ' ' || C5.RDADR AS RNDADR
             , SV1.RLTD_SV_BIZ_DCLSF_CD
             , SV1.CLSF_CD_SRN_PRNT_CN
             , SV1.BF_VST_DUEDT             /*이정방문예정일자*/
             , SV1.VST_DUEDT                /*최초방문예정일자-이월전최초배정시예정일자*/
             , SV2.VST_CNFMDT               /*최종방문약속일자*/
             , SV2.VST_CNFM_HH              /*최종방문약속시간*/
             , SV3.VST_FSH_DT               /*작업완료일자*/
             , SV3.VST_FSH_HH               /*작업완료시간*/
             , CN2.CST_UNUITM_CN            /*고객특이사항*/
             , CN2.FST_RGST_DTM             /*고객특이사항등록일시*/
             , (CASE WHEN O1.OG_TP_CD IN ('W02', 'W03') THEN DGR1_LEVL_OG_CD WHEN O1.OG_TP_CD IN ('W06') THEN '71314' ELSE O1.OG_CD END) AS L1_HGR_OG_CD
             , (CASE WHEN O1.OG_TP_CD IN ('W02', 'W03') THEN DGR2_LEVL_OG_CD ELSE O1.OG_CD END) AS L2_HGR_OG_CD
             , (CASE WHEN O1.OG_TP_CD IN ('W02', 'W03') THEN DGR3_LEVL_OG_CD ELSE O1.OG_CD END) AS L3_HGR_OG_CD
             , (CASE WHEN O1.OG_TP_CD IN ('W02', 'W03') THEN DGR1_LEVL_OG_NM WHEN O1.OG_TP_CD IN ('W06') THEN 'Wells CS운영팀' ELSE O1.OG_NM END) AS L1_HGR_OG_NM
             , (CASE WHEN O1.OG_TP_CD IN ('W02', 'W03') THEN DGR2_LEVL_OG_NM ELSE O1.OG_NM END) AS L2_HGR_OG_NM
             , (CASE WHEN O1.OG_TP_CD IN ('W02', 'W03') THEN DGR3_LEVL_OG_NM ELSE O1.OG_NM END) AS L3_HGR_OG_NM
             , SV2.CNFM_PSIC_DV_CD          /*확정담당자구분코드*/
             , SV2.CNFM_PSIC_PRTNR_OG_TP_CD /*확정담당자파트너조직유형코드*/
             , SV2.CNFM_PSIC_PRTNR_NO       /*확정담당자파트너번호*/
             , O1.PRTNR_KNM                 /*파트너한글명*/
             , O1.PSTN_DV_CD                /*직급구분*/
             , TO_SINGLE_BYTE(F_CMZ_CD_NM('TNT_WELLS', 'SAP_PSTN_DV_CD', O1.PSTN_DV_CD , 'ko')) AS PSTN_DV_NM  /*직급명*/
             , SV2.SITE_AW_ATC_CD           /*현장수당항목코드*/
             , F_CMZ_CD_NM('TNT_WELLS', 'SITE_AW_ATC_CD', SV2.SITE_AW_ATC_CD , 'ko') AS SITE_AW_ATC_NM  /*현장수당항목명*/
             , O3.ENG_PRTNR_GD_CD           /*엔지니어수당등급*/
             , (
                 SELECT (CASE WHEN O3.ENG_PRTNR_GD_CD = '11' THEN F1.FULEY_AW_AMT
                              WHEN O3.ENG_PRTNR_GD_CD = '21' THEN F1.ROL_LYR1_TOPMR_AW_AMT
                              WHEN O3.ENG_PRTNR_GD_CD = '22' THEN F1.ROL_LYR1_UPLR_AW_AMT
                              WHEN O3.ENG_PRTNR_GD_CD = '23' THEN F1.ROL_LYR1_MDLYR_AW_AMT
                              WHEN O3.ENG_PRTNR_GD_CD = '24' THEN F1.ROL_LYR1_LOLYR_AW_AMT
                              WHEN O3.ENG_PRTNR_GD_CD = '31' THEN F1.ROL_L2_UPLR_AW_AMT
                              WHEN O3.ENG_PRTNR_GD_CD = '32' THEN F1.ROL_L2_MDLYR_AW_AMT
                              WHEN O3.ENG_PRTNR_GD_CD = '33' THEN F1.ROL_L2_LOLYR_AW_AMT
                              WHEN O3.ENG_PRTNR_GD_CD = '41' THEN F1.ROL_L3_AW_AMT
                              WHEN O3.ENG_PRTNR_GD_CD = '51' THEN F1.CRWK_AW_AMT
                              WHEN O1.HIR_FOM_CD = '3' THEN FULEY_AW_AMT
                              WHEN O1.HIR_FOM_CD = '3' AND O1.PSTN_DV_CD = '86' THEN F1.ROL_LYR1_MDLYR_AW_AMT
                              WHEN O1.HIR_FOM_CD = '3' AND O1.PSTN_DV_CD = '87' THEN F1.ROL_L2_MDLYR_AW_AMT
                              WHEN O1.HIR_FOM_CD = '3' AND O1.PSTN_DV_CD = '88' THEN F1.ROL_L3_AW_AMT
                              WHEN O1.HIR_FOM_CD = '2' THEN F1.CRWK_AW_AMT
                              WHEN O1.HIR_FOM_CD = '1' THEN F1.INDV_ENTRP_AW_AMT
                              ELSE 0
                        END)
                   FROM WSMDBS.TB_FEAM_SITE_AW_DSB_BASE_BAS F1 /*현장수당지급기준기본*/
                  WHERE 1=1
                    AND F1.PD_GRP_CD = (CASE WHEN P1.PD_PRP_VAL20 IS NULL THEN SUBSTR(P1.PD_PRP_VAL01,2,1) ELSE P1.PD_PRP_VAL20 END)
                    AND F1.SV_TP_CD = SUBSTR(SV1.SV_BIZ_MCLSF_CD,1,1)
                    AND F1.SITE_AW_ATC_CD = SV2.SITE_AW_ATC_CD
                    AND F1.RGLVL_DV_CD = '1'   /*엔지니어 급지는 1급지로 정리됨*/
                    AND SV3.VST_FSH_DT BETWEEN F1.APY_STRTDT AND F1.APY_ENDDT
                    AND F1.DTA_DL_YN = 'N'
             ) AS AW_AMT  /*현장수당*/
             , SV3.SV_PROCS_CN              /*서비스처리내용*/
             , SV3.CST_SIGN_CN              /*고객서명*/
             /*BD26	방문취소사유, 매니저 작업 취소를 위해 만들었으나, BS는 취소가 안 되어 미사용, BS를 취소 할 수 있는 기능이 필요한지 사업본부에 확인 필요, 10 고객사유,20 고객이사,30 고객탈퇴,40 매출취소,50 방문중지,90 기타사유*/
             , (CASE WHEN C6.RSG_FSH_DT IS NOT NULL THEN '고객탈퇴' /*해지고객*/
                     WHEN C1.CNTR_DTL_STAT_CD = '202' THEN '방문중지'   /*연체중지*/
                     ELSE '' END
             ) AS BG_COLO                /*변동사항*/
             , C1.CNTR_DTL_STAT_CD          /*계약상세상태코드*/
             , F_CMZ_CD_NM('TNT_WELLS', 'CNTR_DTL_STAT_CD', C1.CNTR_DTL_STAT_CD, 'ko') AS CNTR_DTL_STAT_NM
          FROM WSMDBS.TB_SVPD_CST_SV_BFSVC_OJ_IZ SV1                        /*고객서비스BS대상내역, AC251TB*/
         INNER JOIN WSMDBS.TB_SVPD_CST_SV_BFSVC_ASN_IZ SV2            /*고객서비스BS배정내역, AC261TB*/
            ON SV1.CST_SV_ASN_NO = SV2.CST_SV_ASN_NO
           AND SV1.ASN_OJ_YM = SV2.ASN_OJ_YM
           AND SV2.DTA_DL_YN = 'N'
    LEFT OUTER JOIN WSMDBS.TB_SVPD_CST_SV_WK_RS_IZ SV3           /*고객서비스작업결과내역, VS106TB*/
            ON SV1.CST_SV_ASN_NO = SV3.CST_SV_ASN_NO
           AND SV3.DTA_DL_YN = 'N'
    LEFT OUTER JOIN WSMDBS.TB_OGBS_MM_PRTNR_IZ O1                /*월파트너내역*/
            ON SV2.ASN_OJ_YM = O1.BASE_YM
           AND SV2.CNFM_PSIC_PRTNR_OG_TP_CD = O1.OG_TP_CD
           AND SV2.CNFM_PSIC_PRTNR_NO = O1.PRTNR_NO
           AND O1.DTA_DL_YN = 'N'
    LEFT OUTER JOIN WSMDBS.TB_OGBS_MM_OG_IZ O2                        /*월조직내역*/
            ON O1.BASE_YM = O2.BASE_YM
           AND O1.OG_TP_CD = O2.OG_TP_CD
           AND O1.OG_ID = O2.OG_ID
           AND O2.DTA_DL_YN = 'N'
    LEFT OUTER JOIN LATERAL ( /*엔지니어등급*/
                              SELECT OO3.OG_TP_CD
                                   , OO3.PRTNR_NO
                                   , OO3.PRTNR_GD_CD AS ENG_PRTNR_GD_CD
                                FROM WSMDBS.TB_OGPS_EGER_GD_RGST_IZ OO3 /*엔지니어등급등록내역*/
                               WHERE 1=1
                                 AND OO3.DTA_DL_YN = 'N'
                                 AND SV2.CNFM_PSIC_PRTNR_OG_TP_CD = OO3.OG_TP_CD
                                 AND SV2.CNFM_PSIC_PRTNR_NO = OO3.PRTNR_NO
                                 AND SV2.ASN_OJ_YM BETWEEN OO3.APY_STRTDT AND OO3.APY_ENDDT
                                 AND OO3.APY_SEQN = (
                                                      SELECT MAX(APY_SEQN)
                                                        FROM WSMDBS.TB_OGPS_EGER_GD_RGST_IZ OO4
                                                       WHERE 1=1
                                                         AND OO4.DTA_DL_YN = 'N'
                                                         AND SV2.CNFM_PSIC_PRTNR_OG_TP_CD = OO4.OG_TP_CD
                                                         AND SV2.CNFM_PSIC_PRTNR_NO = OO4.PRTNR_NO
                                                         AND SV2.ASN_OJ_YM BETWEEN OO4.APY_STRTDT AND OO4.APY_ENDDT
                                                    )
                            ) O3
            ON 1=1
         INNER JOIN WSMDBS.TB_PDBS_PD_ECOM_PRP_DTL P1                 /*상품각사속성상세*/
            ON SV1.PDCT_PD_CD = P1.PD_CD
           AND P1.PD_EXTS_PRP_GRP_CD = 'PART'
           AND P1.DTA_DL_YN = 'N'
         INNER JOIN WSMDBS.TB_PDBS_PD_BAS P2
            ON P1.PD_CD = P2.PD_CD
         --AND P2.PD_TP_CD = 'M'    /*상품유형코드 : C 복합상품, P 기준상품, S 서비스, M 교재제품, Y 융합상품*/
           AND P2.DTA_DL_YN = 'N'
    LEFT OUTER JOIN WSMDBS.TB_SVPD_BC_RPBL_AK_CST_IZ B1          /*차세대 오픈전 바코드재발행요청고객내역*/
            ON SV1.CNTR_NO = B1.CNTR_NO
           AND SV1.CNTR_SN = B1.CNTR_SN
           AND (CASE WHEN B1.FNL_PBL_DT IS NOT NULL THEN SUBSTR(B1.FNL_PBL_DT,1,6)
                     ELSE SUBSTR(B1.FST_PBL_DT,1,6)
                END) = SV1.ASN_OJ_YM
           AND B1.DTA_DL_YN = 'N'
    LEFT OUTER JOIN WSMDBS.TB_SVPD_PD_BC_RPBL_APLC_IZ B2         /*상품바코드재발행신청내역, KWAS.ATEMP_LYJ_BARCODE*/
            ON SV1.CNTR_NO = B1.CNTR_NO
           AND SV1.CNTR_SN = B1.CNTR_SN
           AND SUBSTR(SV1.CST_SV_ASN_NO,2,6) <![CDATA[ < ]]> SV1.ASN_OJ_YM
           AND (B2.RPBL_DT IS NULL OR SUBSTR(B2.RPBL_DT,1,6) >= SV1.ASN_OJ_YM)
           AND B2.DTA_DL_YN = 'N'
         INNER JOIN WSMDBS.TB_SSCT_CNTR_DTL C1                        /*계약상세*/
            ON SV1.CNTR_NO = C1.CNTR_NO
           AND SV1.CNTR_SN = C1.CNTR_SN
           AND C1.DTA_DL_YN = 'N'
         INNER JOIN WSMDBS.TB_SSCT_CNTR_BAS C2                        /*계약기본*/
            ON SV1.CNTR_NO = C2.CNTR_NO
           AND C2.DTA_DL_YN = 'N'
         INNER JOIN WSMDBS.TB_SSCT_CNTR_ADR_REL C3                    /*계약주소관계*/
            ON C1.CNTR_NO = C3.DTL_CNTR_NO
           AND C1.CNTR_SN = C3.DTL_CNTR_SN
           AND C3.ADRPC_TP_CD IN ('2', '3')    /*1 계약주소, 2 배달주소, 3 설치주소 -- 2, 3번 중에 하나만 존재*/
           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN C3.VL_STRT_DTM AND C3.VL_END_DTM
           AND C3.DTA_DL_YN = 'N'
         INNER JOIN WSMDBS.TB_SSCT_CNTR_ADRPC_BAS C4                  /*계약주소지기본*/
            ON C3.CNTR_ADRPC_ID = C4.CNTR_ADRPC_ID
           AND C4.DTA_DL_YN = 'N'
    LEFT OUTER JOIN GBSDBS.TB_GBCO_ADR_BAS C5                    /*주소기본 -- 배정시 주소를 사용 해야 함. 현재 주소가 아닌 */
            ON SV1.ADR_ID = C5.ADR_ID
           AND C5.DTA_DL_YN = 'N'
    LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_RSG_PROCS_IZ C6          /*계약해지처리내역*/
            ON SV1.CNTR_NO = C6.CNTR_NO
           AND SV1.CNTR_SN = C6.CNTR_SN
           AND C6.DTA_DL_YN = 'N'
    LEFT OUTER JOIN WSMDBS.TB_CUBS_CST_DTL CS1                   /*고객상세*/
            ON C2.CNTR_CST_NO = CS1.CST_NO
           AND CS1.DTA_DL_YN = 'N'
    LEFT OUTER JOIN LATERAL ( /*고객컨택*/
                              SELECT *
                                FROM WSMDBS.TB_SVPD_CST_SV_CNTC_IZ S1
                               WHERE 1=1
                                 AND S1.CST_SV_ASN_NO = SV1.CST_SV_ASN_NO
                                 AND S1.DTA_DL_YN = 'N'
                                 AND (CNTC_DT||CNTC_HH) IN (
                                                             SELECT MAX(CNTC_DT||CNTC_HH)
                                                               FROM WSMDBS.TB_SVPD_CST_SV_CNTC_IZ S2
                                                              WHERE 1=1
                                                                AND S2.CST_SV_ASN_NO = SV1.CST_SV_ASN_NO
                                                                AND S2.DTA_DL_YN = 'N'
                                                           )
                            ) CN1
            ON 1=1
    LEFT OUTER JOIN LATERAL ( /*고객특이사항*/
                              SELECT *
                                FROM WSMDBS.TB_SVPD_CNTR_CST_UNUITM_DTL S1  /*계약고객특이사항상세, KWAS.ATEMP_LYJ_ABNORMALITY*/
                               WHERE 1=1
                                 AND S1.DTA_DL_YN = 'N'
                                 AND SV1.CNTR_NO = S1.CNTR_NO
                                 AND SV1.CNTR_SN = S1.CNTR_SN
                                 AND S1.DTL_SN = (
                                                   SELECT MAX(S2.DTL_SN)
                                                     FROM WSMDBS.TB_SVPD_CNTR_CST_UNUITM_DTL S2
                                                    WHERE 1=1
                                                      AND SV1.CNTR_NO = S2.CNTR_NO
                                                      AND SV1.CNTR_SN = S2.CNTR_SN
                                                      AND S2.DTA_DL_YN = 'N'
                                                 )
                            ) CN2
            ON 1=1
         WHERE 1=1
           AND SV1.ASN_OJ_YM = #{baseYm}
           AND SV1.DTA_DL_YN = 'N'
        <if test='@MybatisUtils@isNotEmpty(rgsnExcdYn) and @MybatisUtils@equals(rgsnExcdYn, "Y")'>
           /*퇴사자제외 조건 선택 시*/
           AND O1.CLTN_DT IS NULL     /* 퇴사자 제외 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(mngrDvCd)">
          AND SV2.CNFM_PSIC_DV_CD = #{mngrDvCd}
            <if test='@MybatisUtils@equals(mngrDvCd, "2")'>
           /*엔지니어조회시*/
           AND SV1.VST_DV_CD NOT LIKE '2%'
            </if>
            <if test='@MybatisUtils@equals(mngrDvCd, "1")'>
            /*매니저조회시*/
           AND SV1.VST_DV_CD IN ('10', '11')
            </if>
        </if>
        <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
           /*담당자조회시*/
           AND SV2.CNFM_PSIC_PRTNR_NO = #{prtnrNo}    /* 엔지니어/매니저 파트너번호 */
        </if>
        <if test='@MybatisUtils@isNotEmpty(pdGrpCd)'>
           /*상품그룹조회시*/
           AND (CASE WHEN P1.PD_PRP_VAL20 IS NULL THEN SUBSTR(P1.PD_PRP_VAL01,2,1) ELSE P1.PD_PRP_VAL20 END)  = #{pdGrpCd} /*AS_MAT_ITM_GRP_CD 값이 없을 경우 기존 KIWI 코드의 2번째자리 사용*/
        </if>
        <if test='@MybatisUtils@isNotEmpty(pdCd)'>
           /*상품조회시*/
           AND P1.PD_CD = #{pdCd}
        </if>
        <if test='@MybatisUtils@isNotEmpty(svTpCd)'>
           /*서비스유형조회시*/
           AND SV2.SV_BIZ_MCLSF_CD = #{svTpCd}   /*21 정기, 22 비정기*/
        </if>
        <if test='@MybatisUtils@isNotEmpty(prgsStatCd)'>
           /*진행구분조회시*/
           AND SV2.VST_PRGS_STAT_CD = #{prgsStatCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(startDt) and @MybatisUtils@isNotEmpty(endDt)">
           /*약속일자 선택 값 존재 시*/
           AND SV2.VST_CNFMDT  BETWEEN #{startDt} AND #{endDt}
        </if>
        <if test='@MybatisUtils@isNotEmpty(vacManaYn) and @MybatisUtils@equals(vacManaYn, "Y")'>
           /*가상매니저조회시*/
           AND O1.PSTN_DV_CD = '4' /*직급구분코드, 가상매니저 현재 유지되고 있는지 박광진파트장에게 확인 필요*/
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr1LevlOgId)">
           AND O2.DGR1_LEVL_OG_ID = #{dgr1LevlOgId}   /* 총괄단조건(1차레벨조직코드) */
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr2LevlOgId)">
           AND O2.DGR2_LEVL_OG_ID = #{dgr2LevlOgId}   /* 지역단조건(2차레벨조직코드)*/
        </if>
        <if test="@MybatisUtils@isNotEmpty(dgr3LevlOgId)">
           AND O2.DGR3_LEVL_OG_ID = #{dgr3LevlOgId}   /* 지점조건(3차레벨조직코드)*/
        </if>
        <if test="@MybatisUtils@isNotEmpty(ogId)">
           AND O2.OG_ID = #{ogId}                     /* 서비스센터 */
        </if>
    </select>

    <select id="selectWellsManager" resultType="camelMap">
        SELECT *
              FROM (SELECT T1.PRTNR_NO
                         , T1.PRTNR_KNM || ' (' || T1.PRTNR_NO || ')' AS PRTNR_NO_NM
                      FROM TB_OGBS_MM_PRTNR_IZ T1
                     INNER JOIN TB_OGBS_MM_OG_IZ T2
                        ON T2.BASE_YM = T1.BASE_YM
                       AND T2.OG_ID = T1.OG_ID
                       AND T1.DTA_DL_YN = 'N'
                       AND T2.DTA_DL_YN = 'N'
                     WHERE T1.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                       AND T1.OG_TP_CD = 'W02'
                     <if test="@MybatisUtils@isNotEmpty(dgr2LevlOgId)">
                       AND T2.DGR2_LEVL_OG_ID = #{dgr2LevlOgId}   /* 지역단조건(2차레벨조직코드)*/
                     </if>
                       AND T1.BZ_STAT_CD = '1'
                       AND T1.QLF_DV_CD = '3'   /* 웰스매니저 */
                     UNION
                    SELECT T1.PRTNR_NO
                         , T1.PRTNR_KNM || ' (' || T1.PRTNR_NO || ')' AS PRTNR_NO_NM
                      FROM TB_OGBS_MM_PRTNR_IZ T1
                     INNER JOIN TB_OGBS_MM_OG_IZ T2
                        ON T2.BASE_YM = T1.BASE_YM
                       AND T2.OG_ID = T1.OG_ID
                       AND T1.DTA_DL_YN = 'N'
                       AND T2.DTA_DL_YN = 'N'
                     WHERE T1.BASE_YM = TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM')
                       AND T1.OG_TP_CD = 'W02'
                     <if test="@MybatisUtils@isNotEmpty(dgr2LevlOgId)">
                       AND T2.DGR2_LEVL_OG_ID = #{dgr2LevlOgId}   /* 지역단조건(2차레벨조직코드)*/
                     </if>
                       AND T1.CLTN_DT LIKE TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM')||'%'
                       AND T1.QLF_DV_CD = '3'   /* 웰스매니저 */
                  )
             ORDER BY PRTNR_NO_NM, PRTNR_NO
    </select>
    <select id="selectManagerInfo" resultType="com.kyowon.sms.wells.web.service.allocate.dvo.WsncRoutineBsPsicAssignStateMngrInfoDvo">
          SELECT T1.OG_TP_CD
               , T2.OG_ID                 /* 서비스센터 */
               , T2.DGR2_LEVL_OG_ID       /* 지역단 */
            FROM TB_OGBS_MM_PRTNR_IZ T1
           INNER JOIN TB_OGBS_MM_OG_IZ T2
              ON T2.BASE_YM = T1.BASE_YM
             AND T2.OG_ID = T1.OG_ID
             AND T1.DTA_DL_YN = 'N'
             AND T2.DTA_DL_YN = 'N'
           WHERE 1=1
             AND T1.BASE_YM = #{baseYm}
             AND T1.PRTNR_NO = (
                                SELECT EPNO
                                  FROM T_CMP_USR_ACO_M
                                 WHERE LOGIN_ID = #{session.loginId}
                                )
	         AND ROWNUM = 1
    </select>
</mapper>
