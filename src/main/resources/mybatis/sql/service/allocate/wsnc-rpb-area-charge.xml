<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.allocate.mapper.WsncRpbAreaChargeMgtMapper">

    <!-- TODO: 테이블 변경 후 쿼리 수정 필요 -->
    <select id="selectPersonInCharges" resultType="com.kyowon.sms.wells.web.service.allocate.dto.WsncRpbAreaChargeMgtDto$SearchRes">
        SELECT T1.ZIP_LIST /* 우편번호 리스트 */
             , T1.HEMD_LIST /* 행정동 리스트 */
             , T1.MGT_CNT /* 서비스계정수 */
             , T1.WRK_CNT /* 월별수임건수 */
             , T1.RPB_LOCARA_CD /* 책임지역코드 */
             , T1.WK_GRP_CD /* 작업그룹코드 */
             , T1.IZ_SN /* 내역일련번호 */
             , T1.APY_STRTDT /* 유효시작일시 */
             , T1.APY_ENDDT /* 유효종료일시 */
             , T1.ICHR_PRTNR_NO /* 담당파트너번호 */
             , T1.PRTNR_KNM /* 파트너한글명 */
             , T1.PPRN_ICHR_PRTNR_NO1 /* 예비담당파트너번호1 */
             , T1.PPRN_ICHR_PRTNR_KNM1  /* 예비담당파트너번호1 한글명 */
             , T1.PPRN_ICHR_PRTNR_NO2 /* 예비담당파트너번호2 */
             , T1.PPRN_ICHR_PRTNR_KNM2  /* 예비담당파트너번호2 한글명 */
             , T1.PPRN_ICHR_PRTNR_NO3 /* 예비담당파트너번호3 */
             , T1.PPRN_ICHR_PRTNR_KNM3  /* 예비담당파트너번호3 한글명 */
             , T1.PPRN_ICHR_PRTNR_NO4 /* 예비담당파트너번호4 */
             , T1.PPRN_ICHR_PRTNR_KNM4  /* 예비담당파트너번호4 한글명 */
             , T1.PPRN_ICHR_PRTNR_NO5 /* 예비담당파트너번호5 */
             , T1.PPRN_ICHR_PRTNR_KNM5  /* 예비담당파트너번호5 한글명 */
             , T1.RSTR_CNDT_USE_YN /* 제약조건사용여부 */
             , T1.UDSN_USE_YN /* 미지정사용여부 */
             , T1.RPB_LOCARA_GRP_CD /* 책임지역그룹코드 */
             , T1.VST_DOW_VAL /* 방문요일값 */
             , T1.MMT_AV_LDTM /* 이동평균시간 */
             , T1.LOCARA_CEN_STRU_ADR /* 지역중심건물주소 */
             , T1.W1_W3_SAT_WRK_YN /* 1주3주토요일근무여부 */
             , T1.OG_NM
          FROM (SELECT '11서울특별시노원구공릉1동' AS HEMD_LIST, '01803, 01838, 01839, 01840, 01841, 01842, 01843, 01844, 01845, 01846, 01847, 01848, 01849, 01850, 01851, 01852, 01853, 01854, 01855, 01856, 01857, 01858, 01859, 01860, 01861' AS ZIP_LIST,  '2' AS MGT_CNT, '3' AS WRK_CNT, 'A001' AS RPB_LOCARA_CD, '10' AS WK_GRP_CD, '1' AS IZ_SN, '20210401' AS APY_STRTDT, '99991231' AS APY_ENDDT, '36604' AS ICHR_PRTNR_NO, '박준관' AS PRTNR_KNM, '' AS PPRN_ICHR_PRTNR_NO1, '' AS PPRN_ICHR_PRTNR_KNM1, '' AS PPRN_ICHR_PRTNR_NO2, '' AS PPRN_ICHR_PRTNR_KNM2, '' AS PPRN_ICHR_PRTNR_NO3, '' AS PPRN_ICHR_PRTNR_KNM3, '' AS PPRN_ICHR_PRTNR_NO4, '' AS PPRN_ICHR_PRTNR_KNM4, '' AS PPRN_ICHR_PRTNR_NO5, '' AS PPRN_ICHR_PRTNR_KNM5, 'Y' AS RSTR_CNDT_USE_YN, 'Y' AS UDSN_USE_YN, '10009' AS RPB_LOCARA_GRP_CD, '234567' AS VST_DOW_VAL, '19' AS MMT_AV_LDTM, '' AS LOCARA_CEN_STRU_ADR, 'Y' AS W1_W3_SAT_WRK_YN, '의정부지점' AS OG_NM FROM DUAL UNION ALL
                SELECT '11서울특별시노원구공릉2동','01793, 01794, 01795, 01796, 01797, 01798, 01799, 01800, 01801, 01802, 01804, 01805, 01811, 01812, 01813, 01814, 01815, 01816, 01817, 01818, 01819, 01820, 01821, 01822, 01823, 01824, 01825, 01826, 01827, 01828, 01832, 01833, 01834, 01835, 01836, 01837', '4', '6', 'A001', '10', '1', '20210401', '99991231', '36604', '박준관','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10009', '234567', '11', '', 'Y', '의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시노원구상계5동','01651, 01652, 01653, 01654, 01655, 01656, 01657, 01658, 01659, 01660, 01661, 01663, 01664, 01665, 01666, 01667, 01668, 01679, 01680, 01681, 01682, 01683','3','5','A004','10','1','20210401','99991231','36744','이재봉','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10057','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시노원구중계1동','01706, 01707, 01708, 01709, 01710, 01713, 01714, 01741, 01742, 01743, 01744, 01745, 01746','3','5','A005','10', '1','20210401','99991231','36744','이재봉','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10057','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시노원구중계4동','01662, 01699, 01700, 01701, 01711, 01712, 01715, 01716, 01717, 01718, 01719','3','5','A005','10','1','20210401','99991231','36744','이재봉','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10057','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시노원구중계본동','01720, 01721, 01722, 01723, 01724, 01725, 01726, 01727, 01728, 01729, 01730, 01731, 01732, 01733, 01734, 01735, 01736, 01737, 01738, 01739, 01740','3','5','A005','10','1','20210401','99991231','36744','이재봉','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10057','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시노원구하계1동','01747, 01748, 01749, 01750, 01784, 01788, 01790, 01791, 01792, 01806, 01807, 01808, 01809, 01810, 01829, 01830, 01831','3','5','A005','10','1','20211001','99991231','36744','이재봉','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10057','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시노원구하계2동','01775, 01776, 01780, 01862, 01863','3','5','A006','10', '1','20210401','99991231','36687','곽재원','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10057','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시노원구상계10동','01676, 01677, 01686, 01687, 01688, 01690, 01694','3','5','A007','10', '1','20210401','99991231','36744','이재봉','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10057','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시노원구상계8동','01617, 01618, 01619, 01620, 01675','3','5','A007','10', '1','20210401','99991231','36744','이재봉','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10057','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시도봉구방학제1동','01331, 01332, 01333, 01334, 01335, 01336, 01337, 01338, 01339, 01340, 01341, 01342, 01343, 01344, 01345, 01346, 01350, 01351, 01352, 01389, 01390, 01396, 01406, 01407','3','5','A009','10','1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시도봉구방학제2동','01311, 01314, 01315, 01347, 01348, 01353, 01354, 01355, 01356, 01357, 01358','3','5','A009','10','1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시도봉구방학제3동','01316, 01317, 01359, 01360, 01361, 01362, 01363, 01364, 01373, 01374, 01382, 01383, 01384','3','5','A009','10', '1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시도봉구쌍문제1동','01365, 01366, 01367, 01368, 01369, 01370, 01371, 01372, 01376, 01377, 01378, 01379, 01380, 01381','3','5','A010','10', '1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시도봉구쌍문제2동','01385, 01391, 01392, 01393, 01394, 01395, 01431, 01432, 01436, 01437, 01440','3','5','A010','10', '1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시도봉구쌍문제3동','01441, 01442, 01443, 01444, 01445, 01446, 01447, 01448, 01449, 01450, 01451, 01452','3','5','A010','10', '1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시도봉구창제3동','01473, 01474, 01475, 01476, 01477, 01478, 01479, 01480, 01481, 01482, 01487','3','5','A011','10', '1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시도봉구창제4동','01408, 01409, 01410, 01411, 01412, 01413, 01414, 01415, 01416, 01417, 01418, 01419, 01420, 01489','3','5','A011','10', '1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시도봉구창제5동','01397, 01398, 01399, 01400, 01401, 01402, 01403, 01404, 01405, 01426, 01427, 01428','3','5','A011','10', '1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구수유2동','01037, 01038, 01039, 01040, 01041, 01042, 01043, 01044, 01045, 01046, 01047, 01048, 01049, 01050','3','5','A012','10', '1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구수유3동','01051, 01052, 01053, 01054, 01055, 01070, 01071, 01072, 01073, 01074, 01075, 01076, 01077, 01078, 01079, 01080','3','5','A012','10', '1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구우이동','01009, 01011, 01012, 01013, 01014, 01026, 01027, 01028, 01029','3','5','A012','10', '1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구우이동','01000, 01001, 01002, 01003, 01004, 01005, 01006, 01007, 01008, 01010','3','5','A012','10', '1','20210401','99991231','36615','원준일','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10058','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구미아동','01118, 01119, 01124, 01125, 01126, 01128, 01129, 01131, 01132, 01133, 01141, 01142, 01157, 01169, 01170','3','5','A013','10', '1','20210401','99991231','36687','곽재원','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10071','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구삼각산동','01192, 01193, 01194, 01195, 01196, 01197, 01198, 01199, 01200','3','5','A013','10', '1','20210401','99991231','36687','곽재원','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10071','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구송중동','01152, 01153, 01154, 01155, 01156, 01158, 01159, 01160, 01161, 01162, 01163, 01164, 01165, 01166, 01215, 01216, 01217, 01218, 01219, 01220, 01221, 01222, 01232, 01233, 01234, 01235, 01236, 01237','3','5','A013','10', '1','20210401','99991231','36687','곽재원','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10071','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구송천동','01167, 01168, 01171, 01172, 01173, 01174, 01175, 01176, 01177, 01178, 01179, 01201, 01202, 01203, 01204, 01205, 01206, 01207, 01208, 01209, 01210, 01211, 01212, 01213, 01214','3','5','A013','10', '1','20210401','99991231','36687','곽재원','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10071','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구번1동','01056, 01057, 01058, 01059, 01060, 01061, 01062, 01063, 01064, 01065, 01066, 01067, 01068, 01069, 01136','3','5','A013','10', '1','20210401','99991231','36687','곽재원','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10071','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구번2동','01130, 01134, 01135, 01137, 01138, 01139, 01143, 01144, 01145, 01146, 01147, 01148, 01149, 01150, 01151','3','5','A013','10', '1','20210401','99991231','36687','곽재원','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10071','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구번3동','01223, 01224, 01225, 01226, 01227, 01228, 01229, 01230, 01231','3','5','A013','10', '1','20210401','99991231','36687','곽재원','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10071','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구수유1동','01095, 01096, 01097, 01098, 01099, 01100, 01101, 01102, 01103, 01105, 01106, 01111, 01112, 01113, 01114, 01115, 01116, 01117','3','5','A013','10', '1','20211002','99991231','36687','곽재원','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10071','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시강북구인수동','01015, 01016, 01017, 01018, 01019, 01020, 01021, 01022, 01023, 01024, 01025, 01030, 01031, 01032, 01033, 01034, 01035, 01036, 01081, 01082, 01083, 01084, 01085, 01086, 01087, 01088, 01089, 01090, 01091, 01092, 01093, 01094','3','5','A013','10', '1','20210401','99991231','36687','곽재원','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','10071','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시성북구월곡제2동','02752, 02753, 02773','3','5','A014','10', '1','20210401','99991231','37318','황경창','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시성북구종암동','02795, 02796, 02797, 02798, 02799, 02800, 02802, 02803, 02804, 02805, 02809, 02810, 02811','3','5','A014','10', '1','20210401','99991231','37318','황경창','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시성북구길음제2동','02733, 02734','3','5','A014','10', '1','20210401','99991231','37318','황경창','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시성북구월곡제1동','02736, 02737, 02738, 02739, 02740, 02741, 02749, 02750','3','5','A014','10', '1','20210401','99991231','37318','황경창','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시성북구돈암제1동','02801, 02806, 02807, 02808, 02817, 02828','3','5','A015','10', '1','20210401','99991231','37318','황경창','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시성북구돈암제2동','02825, 02827, 02831','3','5','A015','10', '1','20210401','99991231','37318','황경창','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시성북구동선동','02845','3','5','A015','10', '1','20210401','99991231','37318','황경창','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시성북구동선동','02844, 02849','3','5','A015','10', '1','20210401','99991231','37318','황경창','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시성북구동선동','02840','3','5','A015','10', '1','20210401','99991231','37318','황경창','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','','234567','11','','Y','의정부지점' FROM DUAL UNION ALL
                SELECT '11서울특별시성북구동선동','02829','3','5','A015','10', '1','20210401','99991231','37318','황경창','', '', '', '', '', '', '', '', '', '', 'Y', 'Y','','234567','11','','Y','의정부지점' FROM DUAL
               ) T1
    <!--
        WITH
            TEMP01 AS ( /* 선택한 작업그룹에 해당하는 상품 리스트 */
                SELECT DISTINCT T1.PD_CD
                  FROM TB_SVPD_BPD_BIZ_TP_WK_GRP_IZ T1
                 WHERE 1 = 1
                   AND T1.WK_GRP_CD = #{wkGrpCd}
                   AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN APY_STRTDT AND APY_ENDDT
                   AND T1.IZ_SN = (SELECT MAX(IZ_SN)
                                     FROM TB_SVPD_BPD_BIZ_TP_WK_GRP_IZ
                                    WHERE PD_CD = T1.PD_CD
                                      AND WK_GRP_CD = T1.WK_GRP_CD
                                      AND SV_BIZ_DCLSF_CD = T1.SV_BIZ_DCLSF_CD
                                      AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN APY_STRTDT AND APY_ENDDT)
            ), TEMP1 AS ( /* 지역별 계정 수 */
                SELECT RPB_LOCARA_CD
                     , SUM(MGT_CNT) AS MGT_CNT
                  FROM (
                        SELECT A2.NEW_ADR_ZIP
                             , COUNT(1) AS MGT_CNT
                          FROM (
                                SELECT (CASE WHEN O1.CNTR_ADRPC_ID IS NULL THEN D1.CNTR_ADRPC_ID ELSE O1.CNTR_ADRPC_ID END) AS CNTR_ADRPC_ID
                                  FROM TB_SVPD_MCBY_CST_SV_OJ_IZ O1 /* 월별고객서비스대상내역 */
                                  LEFT OUTER JOIN TB_SVPD_CST_SV_EXCN_DL_IZ D1 /* 고객서비스수행삭제내역 */
                                    ON D1.CNTR_NO = O1.CNTR_NO
                                   AND D1.CNTR_SN = O1.CNTR_SN
                                 INNER JOIN TEMP01 P1
                                    ON P1.PD_CD = O1.PD_CD
                                 WHERE O1.MNGT_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                                   AND (O1.REQD_DT IS NULL OR O1.CAN_DT IS NULL OR O1.CPS_DT IS NULL)
                               ) T1
                          LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS A1 /* 계약주소지기본 */
                            ON T1.CNTR_ADRPC_ID = A1.CNTR_ADRPC_ID
                          LEFT OUTER JOIN TB_GBCO_ADR_BAS A2 /* 주소지기본 */
                            ON A2.ADR_ID = A1.ADR_ID
                         GROUP BY A2.NEW_ADR_ZIP
                         ORDER BY A2.NEW_ADR_ZIP
                       ) V1
                 INNER JOIN TB_SVPD_EGER_ASN_ADR_IZ T1 /* 엔지니어배정용주소내역 */
                    ON T1.NEW_ADR_ZIP = V1.NEW_ADR_ZIP
                   AND T1.EMD_SN = (SELECT MAX(EMD_SN)
                                      FROM TB_SVPD_EGER_ASN_ADR_IZ
                                     WHERE 1 = 1
                                       AND NEW_ADR_ZIP = T1.NEW_ADR_ZIP)
                 INNER JOIN TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ T2 /* 책임지역별관리주소내역 */
                    ON T2.FR2P_LGLD_CD = T1.FR2P_LGLD_CD
                   AND T2.CTPV_NM = T1.CTPV_NM
                   AND T2.CTCTY_NM = T1.CTCTY_NM
                   AND T2.LAWC_EMD_NM = T1.LAWC_EMD_NM
                   AND T2.AMTD_NM = T1.AMTD_NM
                   AND T2.LOCARA_SN = (SELECT MAX(LOCARA_SN)
                                         FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ
                                        WHERE RPB_LOCARA_CD = T2.RPB_LOCARA_CD
                                          AND #{applyDate} BETWEEN APY_STRTDT AND T2.APY_ENDDT)
                 WHERE #{applyDate} BETWEEN T2.APY_STRTDT AND T2.APY_ENDDT
                 GROUP BY RPB_LOCARA_CD
            ), TEMP2 AS ( /* 월별 수임 건수 (조회 월 이전 3개월 평균) */
                SELECT RPB_LOCARA_CD
                     , ROUND(SUM(WRK_CNT) / 3, 2) AS WRK_CNT
                  FROM (
                        SELECT Z2.NEW_ADR_ZIP
                             , SUM(WRK_CNT) AS WRK_CNT
                          FROM (
                                SELECT O1.CNTR_ADRPC_ID
                                     , COUNT(1) AS WRK_CNT
                                  FROM TB_SVPD_CST_SV_EXCN_ASN_IZ A1 /* 고객서비스수행배정내역 */
                                 INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ O1 /* 고객서비스AS설치대상내역 */
                                    ON O1.CST_SV_ASN_NO = A1.CST_SV_ASN_NO /* 고객서비스배정번호 */
                                 WHERE 1 = 1
                                   AND A1.WK_PRGS_STAT_CD = '20' /* 작업진행상태코드 */
                                   AND A1.WK_EXCN_DT BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE, -3), 'YYYYMM') || '01' AND TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM') || '31'
                                   AND A1.WK_GRP_CD = #{wkGrpCd}
                                 GROUP BY O1.CNTR_ADRPC_ID
                                 UNION ALL
                                SELECT A1.CNTR_ADRPC_ID, COUNT(1) AS WRK_CNT
                                  FROM TB_SVPD_CST_SV_EXCN_ASN_IZ A1 /* 고객서비스수행배정내역 */
                                 INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ O2 /* 고객서비스BS대상내역 */
                                    ON O2.CST_SV_ASN_NO = A1.CST_SV_ASN_NO /* 고객서비스배정번호 */
                                 WHERE 1 = 1
                                   AND A1.WK_PRGS_STAT_CD = '20' /* 작업진행상태코드 */
                                   AND A1.MNGR_DV_CD = '2' /* 관리자구분코드 */
                                   AND A1.WK_EXCN_DT BETWEEN TO_CHAR(ADD_MONTHS(SYSDATE, -3), 'YYYYMM') || '01' AND TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM') || '31'
                                   AND A1.WK_GRP_CD = #{wkGrpCd}
                                 GROUP BY A1.CNTR_ADRPC_ID
                             ) M1
                         INNER JOIN TB_SSCT_CNTR_ADRPC_BAS Z1 /* 계약주소지기본 */
                            ON Z1.CNTR_ADRPC_ID = M1.CNTR_ADRPC_ID
                         INNER JOIN TB_GBCO_ADR_BAS Z2 /* 주소기본 */
                            ON Z2.ADR_ID = Z1.ADR_ID
                         GROUP BY Z2.NEW_ADR_ZIP
                       ) V1
                 INNER JOIN TB_SVPD_EGER_ASN_ADR_IZ T1 /* 엔지니어배정주소내역 */
                    ON T1.NEW_ADR_ZIP = V1.NEW_ADR_ZIP
                   AND T1.EMD_SN = (SELECT MAX(EMD_SN) FROM TB_SVPD_EGER_ASN_ADR_IZ WHERE NEW_ADR_ZIP = T1.NEW_ADR_ZIP)
                 INNER JOIN TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ T2 /* 책임지역관리주소내역 */
                    ON T2.FR2P_LGLD_CD = T1.FR2P_LGLD_CD
                   AND T2.CTPV_NM = T1.CTPV_NM
                   AND T2.CTCTY_NM = T1.CTCTY_NM
                   AND T2.LAWC_EMD_NM = T1.LAWC_EMD_NM
                   AND T2.AMTD_NM = T1.AMTD_NM
                   AND T2.LOCARA_SN = (SELECT MAX(LOCARA_SN)
                                         FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ
                                        WHERE RPB_LOCARA_CD = T2.RPB_LOCARA_CD
                                          AND #{applyDate} BETWEEN APY_STRTDT AND T2.APY_ENDDT)
                 WHERE #{applyDate} BETWEEN T2.APY_STRTDT AND T2.APY_ENDDT
                 GROUP BY RPB_LOCARA_CD
                 ORDER BY RPB_LOCARA_CD
            ), TEMP3 AS ( /* 지역별 리스트 */
                SELECT DISTINCT
                       (SELECT LISTAGG(T1.NEW_ADR_ZIP, ', ') WITHIN GROUP (ORDER BY T1.NEW_ADR_ZIP)
                          FROM TB_SVPD_EGER_ASN_ADR_IZ T1 /* 엔지니어배정주소내역 */
                         INNER JOIN TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ T2 /* 책임지역관리주소내역 */
                            ON T2.FR2P_LGLD_CD = T1.FR2P_LGLD_CD
                           AND T2.CTPV_NM = T1.CTPV_NM
                           AND T2.CTCTY_NM = T1.CTCTY_NM
                           AND T2.LAWC_EMD_NM = T1.LAWC_EMD_NM
                           AND T2.AMTD_NM = T1.AMTD_NM
                           AND T1.EMD_SN = (SELECT MAX(V1.EMD_SN) FROM TB_SVPD_EGER_ASN_ADR_IZ V1 WHERE V1.NEW_ADR_ZIP = T1.NEW_ADR_ZIP)
                           AND T2.LOCARA_SN  = (SELECT MAX(V2.LOCARA_SN)
                                                  FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ V2
                                                 WHERE V2.RPB_LOCARA_CD = T2.RPB_LOCARA_CD
                                                   AND #{applyDate} BETWEEN V2.APY_STRTDT AND V2.APY_ENDDT)
                         WHERE #{applyDate} BETWEEN T2.APY_STRTDT AND T2.APY_ENDDT
                           AND T3.RPB_LOCARA_CD = T2.RPB_LOCARA_CD) AS ZIP_LIST /* 우편번호리스트 */
                     , (SELECT LISTAGG(T2.FR2P_LGLD_CD || T2.CTPV_NM || T2.CTCTY_NM || T2.LAWC_EMD_NM || T2.AMTD_NM, CHR(10)) WITHIN GROUP (ORDER BY T2.FR2P_LGLD_CD || T2.CTPV_NM || T2.CTCTY_NM || T2.LAWC_EMD_NM || T2.AMTD_NM)
                          FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ T2 /* 책임지역관리주소내역 */
                         WHERE 1 = 1
                           AND #{applyDate} BETWEEN T2.APY_STRTDT AND T2.APY_ENDDT
                           AND T2.LOCARA_SN = (SELECT MAX(V2.LOCARA_SN)
                                                 FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ V2
                                                WHERE V2.RPB_LOCARA_CD = T2.RPB_LOCARA_CD
                                                  AND #{applyDate} BETWEEN V2.APY_STRTDT AND V2.APY_ENDDT)
                           AND T3.RPB_LOCARA_CD = T2.RPB_LOCARA_CD) AS HEMD_LIST /* 행정동리스트 */
                     , T3.RPB_LOCARA_CD /* 책임지역코드 */
                     , T3.WK_GRP_CD /* 작업그룹코드 */
                     , T3.IZ_SN /* 파트너한글명 */
                     , T3.APY_STRTDT /* 유효시작일시 */
                     , T3.APY_ENDDT /* 유효종료일시 */
                     , T3.ICHR_PRTNR_NO /* 담당파트너번호 */
                     , T4.PRTNR_KNM /* 파트너한글명 */
                     , T3.PPRN_ICHR_PRTNR_NO1 /* 예비담당파트너번호1 */
                     , (SELECT PRTNR_KNM FROM TB_OGBS_MM_PRTNR_CL WHERE PRTNR_NO = T3.PPRN_ICHR_PRTNR_NO1) AS PPRN_ICHR_PRTNR_KNM1
                     , T3.PPRN_ICHR_PRTNR_NO2 /* 예비담당파트너번호2 */
                     , (SELECT PRTNR_KNM FROM TB_OGBS_MM_PRTNR_CL WHERE PRTNR_NO = T3.PPRN_ICHR_PRTNR_NO2) AS PPRN_ICHR_PRTNR_KNM2
                     , T3.PPRN_ICHR_PRTNR_NO3 /* 예비담당파트너번호3 */
                     , (SELECT PRTNR_KNM FROM TB_OGBS_MM_PRTNR_CL WHERE PRTNR_NO = T3.PPRN_ICHR_PRTNR_NO3) AS PPRN_ICHR_PRTNR_KNM3
                     , T3.PPRN_ICHR_PRTNR_NO4 /* 예비담당파트너번호4 */
                     , (SELECT PRTNR_KNM FROM TB_OGBS_MM_PRTNR_CL WHERE PRTNR_NO = T3.PPRN_ICHR_PRTNR_NO4) AS PPRN_ICHR_PRTNR_KNM4
                     , T3.PPRN_ICHR_PRTNR_NO5 /* 예비담당파트너번호5 */
                     , (SELECT PRTNR_KNM FROM TB_OGBS_MM_PRTNR_CL WHERE PRTNR_NO = T3.PPRN_ICHR_PRTNR_NO5) AS PPRN_ICHR_PRTNR_KNM5
                     , T3.RSTR_CNDT_USE_YN /* 제약조건사용여부 */
                     , T3.UDSN_USE_YN /* 미지정사용여부 */
                     , T3.RPB_LOCARA_GRP_CD /* 책임지역그룹코드 */
                     , T3.VST_DOW_VAL /* 방문요일값 */
                     , T3.MMT_AV_LDTM /* 이동평균시간 */
                     , T3.LOCARA_CEN_STRU_ADR /* 지역중심건물주소 */
                     , T3.W1_W3_SAT_WRK_YN /* 1주3주토요일근무여부 */
                     , T4.OG_NM /* 조직명 */
                  FROM (SELECT M1.NEW_ADR_ZIP, M1.EMD_SN, M1.FR2P_LGLD_CD, M1.CTPV_NM, M1.CTCTY_NM, M1.LAWC_EMD_NM, M1.AMTD_NM
                          FROM TB_SVPD_EGER_ASN_ADR_IZ M1
                         WHERE M1.EMD_SN = (SELECT MAX(EMD_SN) FROM TB_SVPD_EGER_ASN_ADR_IZ WHERE NEW_ADR_ZIP = M1.NEW_ADR_ZIP)
                     ) T1 /* 엔지니어배정주소내역 */
                 INNER JOIN (SELECT M2.RPB_LOCARA_CD, M2.LOCARA_SN, M2.FR2P_LGLD_CD, M2.CTPV_NM, M2.CTCTY_NM, M2.LAWC_EMD_NM, M2.AMTD_NM, M2.APY_STRTDT, M2.APY_ENDDT
                               FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ M2
                              WHERE M2.LOCARA_SN = (SELECT MAX(LOCARA_SN) FROM TB_SVPD_RPB_LOCARA_MNGT_ADR_IZ WHERE RPB_LOCARA_CD = M2.RPB_LOCARA_CD AND #{applyDate} BETWEEN M2.APY_STRTDT AND M2.APY_ENDDT)
                     ) T2 /* 책임지역관리주소내역 */
                    ON T2.FR2P_LGLD_CD = T1.FR2P_LGLD_CD
                   AND T2.CTPV_NM = T1.CTPV_NM
                   AND T2.CTCTY_NM = T1.CTCTY_NM
                   AND T2.LAWC_EMD_NM = T1.LAWC_EMD_NM
                   AND T2.AMTD_NM = T1.AMTD_NM
                 INNER JOIN (SELECT M3.WK_GRP_CD, M3.RPB_LOCARA_CD, M3.IZ_SN, M3.APY_STRTDT, M3.APY_ENDDT, M3.W1_W3_SAT_WRK_YN, M3.RSTR_CNDT_USE_YN, M3.UDSN_USE_YN, M3.RPB_LOCARA_GRP_CD, M3.VST_DOW_VAL, M3.MMT_AV_LDTM, M3.LOCARA_CEN_STRU_ADR, M3.ICHR_PRTNR_NO, M3.PPRN_ICHR_PRTNR_NO1, M3.PPRN_ICHR_PRTNR_NO2, M3.PPRN_ICHR_PRTNR_NO3, M3.PPRN_ICHR_PRTNR_NO4, M3.PPRN_ICHR_PRTNR_NO5
                               FROM TB_SVPD_RPB_LOCARA_PSIC_IZ M3
                              WHERE M3.IZ_SN = (SELECT MAX(IZ_SN) FROM TB_SVPD_RPB_LOCARA_PSIC_IZ WHERE WK_GRP_CD = M3.WK_GRP_CD AND RPB_LOCARA_CD = M3.RPB_LOCARA_CD AND #{applyDate} BETWEEN M3.APY_STRTDT AND M3.APY_ENDDT)
                     ) T3 /* 책임지역별담당자내역 */
                    ON T3.RPB_LOCARA_CD = T2.RPB_LOCARA_CD
                  LEFT OUTER JOIN (SELECT DISTINCT M4.BASE_YM, M4.PRTNR_NO, M4.PRTNR_KNM, M4.OG_ID, M4.OG_NM
                                     FROM TB_OGBS_MM_PRTNR_CL M4
                                    WHERE M4.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                     ) T4 /* 월파트너마감 */
                    ON T4.PRTNR_NO = T3.ICHR_PRTNR_NO
                 WHERE 1 = 1
                   AND T3.WK_GRP_CD = #{wkGrpCd}
               <if test="@MybatisUtils@isNotEmpty(ctpvNm)">
                   AND T2.CTPV_NM = #{ctpvNm}
               </if>
               <if test="@MybatisUtils@isNotEmpty(ctctyNm)">
                   AND T2.CTCTY_NM = #{ctctyNm}
               </if>
               <if test="@MybatisUtils@isNotEmpty(ogId)">
                   AND T4.OG_ID = #{ogId}
               </if>
               <if test="@MybatisUtils@isNotEmpty(zipFrom)">
                   AND T1.NEW_ADR_ZIP <![CDATA[>=]]> #{zipFrom}
               </if>
               <if test="@MybatisUtils@isNotEmpty(zipTo)">
                   AND T1.NEW_ADR_ZIP <![CDATA[<=]]> #{zipTo}
               </if>
               <if test="@MybatisUtils@isNotEmpty(rpbLocaraCdFrom)">
                   AND T2.RPB_LOCARA_CD <![CDATA[>=]]> #{rpbLocaraCdFrom}
               </if>
               <if test="@MybatisUtils@isNotEmpty(rpbLocaraCdTo)">
                   AND T2.RPB_LOCARA_CD <![CDATA[<=]]> #{rpbLocaraCdTo}
               </if>
                   AND #{applyDate} BETWEEN T2.APY_STRTDT AND T2.APY_ENDDT
                   AND #{applyDate} BETWEEN T3.APY_STRTDT AND T3.APY_ENDDT
            )
        SELECT T3.ZIP_LIST /* 우편번호 리스트 */
             , T3.HEMD_LIST /* 행정동 리스트 */
             , T1.MGT_CNT /* 서비스계정수 */
             , T2.WRK_CNT /* 월별수임건수 */
             , T3.RPB_LOCARA_CD /* 책임지역코드 */
             , T3.WK_GRP_CD /* 작업그룹코드 */
             , T3.IZ_SN /* 내역일련번호 */
             , T3.APY_STRTDT /* 유효시작일시 */
             , T3.APY_ENDDT /* 유효종료일시 */
             , T3.ICHR_PRTNR_NO /* 담당파트너번호 */
             , T3.PRTNR_KNM /* 파트너한글명 */
             , T3.PPRN_ICHR_PRTNR_NO1 /* 예비담당파트너번호1 */
             , T3.PPRN_ICHR_PRTNR_KNM1  /* 예비담당파트너번호1 한글명 */
             , T3.PPRN_ICHR_PRTNR_NO2 /* 예비담당파트너번호2 */
             , T3.PPRN_ICHR_PRTNR_KNM2  /* 예비담당파트너번호2 한글명 */
             , T3.PPRN_ICHR_PRTNR_NO3 /* 예비담당파트너번호3 */
             , T3.PPRN_ICHR_PRTNR_KNM3  /* 예비담당파트너번호3 한글명 */
             , T3.PPRN_ICHR_PRTNR_NO4 /* 예비담당파트너번호4 */
             , T3.PPRN_ICHR_PRTNR_KNM4  /* 예비담당파트너번호4 한글명 */
             , T3.PPRN_ICHR_PRTNR_NO5 /* 예비담당파트너번호5 */
             , T3.PPRN_ICHR_PRTNR_KNM5  /* 예비담당파트너번호5 한글명 */
             , T3.RSTR_CNDT_USE_YN /* 제약조건사용여부 */
             , T3.UDSN_USE_YN /* 미지정사용여부 */
             , T3.RPB_LOCARA_GRP_CD /* 책임지역그룹코드 */
             , T3.VST_DOW_VAL /* 방문요일값 */
             , T3.MMT_AV_LDTM /* 이동평균시간 */
             , T3.LOCARA_CEN_STRU_ADR /* 지역중심건물주소 */
             , T3.W1_W3_SAT_WRK_YN /* 1주3주토요일근무여부 */
             , T3.OG_NM /* 조직명 */
          FROM TEMP3 T3
          LEFT OUTER JOIN TEMP1 T1
            ON T1.RPB_LOCARA_CD = T3.RPB_LOCARA_CD
          LEFT OUTER JOIN TEMP2 T2
            ON T2.RPB_LOCARA_CD = T3.RPB_LOCARA_CD
         ORDER BY T3.RPB_LOCARA_CD, T3.WK_GRP_CD
         -->
    </select>

    <insert id="insertPersonInCharge">
        INSERT INTO TB_SVPD_RPB_LOCARA_PSIC_IZ (  /* 책임지역담당자내역 */
               WK_GRP_CD           /* 작업그룹코드 */
             , RPB_LOCARA_CD       /* 책임지역코드 */
             , IZ_SN               /* 내역일련번호 */
             , ICHR_PRTNR_NO       /* 담당파트너번호 */
         <if test="@MybatisUtils@isNotEmpty(pprnIchrPrtnrNo1)">
             , PPRN_ICHR_PRTNR_NO1 /* 예비담당파트너번호1 */
         </if>
         <if test="@MybatisUtils@isNotEmpty(pprnIchrPrtnrNo2)">
             , PPRN_ICHR_PRTNR_NO2 /* 예비담당파트너번호2 */
         </if>
         <if test="@MybatisUtils@isNotEmpty(pprnIchrPrtnrNo3)">
             , PPRN_ICHR_PRTNR_NO3 /* 예비담당파트너번호3 */
         </if>
         <if test="@MybatisUtils@isNotEmpty(pprnIchrPrtnrNo4)">
             , PPRN_ICHR_PRTNR_NO4 /* 예비담당파트너번호4 */
         </if>
         <if test="@MybatisUtils@isNotEmpty(pprnIchrPrtnrNo5)">
             , PPRN_ICHR_PRTNR_NO5 /* 예비담당파트너번호5 */
         </if>
             , VST_DOW_VAL         /* 방문요일값 */
             , MMT_AV_LDTM         /* 이동평균소요시간 */
             , RSTR_CNDT_USE_YN    /* 제약조건사용여부 */
             , UDSN_USE_YN         /* 미지정사용여부 */
             , LOCARA_CEN_STRU_ADR /* 지역중심건물주소 */
             , W1_W3_SAT_WRK_YN    /* 1주3주토요일근무여부 */
             , RPB_LOCARA_GRP_CD   /* 책임지역그룹코드 */
             , APY_STRTDT         /* 유효시작일시 */
             , APY_ENDDT          /* 유효종료일시 */
             , DTA_DL_YN           /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />)
        VALUES (
               #{wkGrpCd}
             , #{rpbLocaraCd}
             , NVL((SELECT MAX(IZ_SN) + 1
                      FROM TB_SVPD_RPB_LOCARA_PSIC_IZ
                     WHERE RPB_LOCARA_CD = #{rpbLocaraCd}
                       AND WK_GRP_CD = #{wkGrpCd}), 1)
             , #{ichrPrtnrNo}
         <if test="@MybatisUtils@isNotEmpty(pprnIchrPrtnrNo1)">
             , #{pprnIchrPrtnrNo1}
         </if>
         <if test="@MybatisUtils@isNotEmpty(pprnIchrPrtnrNo2)">
             , #{pprnIchrPrtnrNo2}
         </if>
         <if test="@MybatisUtils@isNotEmpty(pprnIchrPrtnrNo3)">
             , #{pprnIchrPrtnrNo3}
         </if>
         <if test="@MybatisUtils@isNotEmpty(pprnIchrPrtnrNo4)">
             , #{pprnIchrPrtnrNo4}
         </if>
         <if test="@MybatisUtils@isNotEmpty(pprnIchrPrtnrNo5)">
             , #{pprnIchrPrtnrNo5}
         </if>
             , #{vstDowVal}
             , ${mmtAvLdtm}
             , #{rstrCndtUseYn}
             , #{udsnUseYn}
             , #{locaraCenStruAdr}
             , #{w1W3SatWrkYn}
             , #{rpbLocaraGrpCd}
             , #{apyStrtdt}
             , #{apyEnddt}
             , 'N'
             <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

</mapper>
