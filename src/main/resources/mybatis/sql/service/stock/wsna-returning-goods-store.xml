<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaReturningGoodsStoreMapper">

    <select id="selectReturningGoodsStores" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaReturningGoodsStoreDto$SearchRes" fetchSize="1000">
        SELECT A1.CST_SV_ASN_NO        /* 고객서비스배정번호 */
             , A1.SAP_CD               /* SAP코드 */
             , A1.ITM_PD_CD            /* 품목상품코드 */
             , A1.ITM_PD_NM            /* 품목상품명 */
             , A1.STKR_PRNT_YN         /* 스티커출력여부 */
             , A1.IST_DT               /* 설치일자 */
             , A1.REQD_DT              /* 철거일자 */
             , A1.VST_FSH_DT           /* 작업일자 */
             , A1.RTNGD_CONF_YN        /* 반품확인여부 */
             , A1.RTNGD_CONF_YN1       /* 반품확인여부 */
             , A1.USE_DAY              /* 사용일수 */
             , A1.USE_MTHS             /* 사용월 */
             , CASE WHEN A1.SV_BIZ_DCLSF_CD LIKE '34%'
                     AND A1.ITEM_KND = '4'
                     AND A1.FNL_ITM_GD_CD = 'X'                  THEN ''
                    WHEN A1.FRISU_YN = 'Y'                       THEN ''
                    WHEN A1.SV_BIZ_DCLSF_CD LIKE '34%'
                     AND A1.ITEM_KND = '4'
                     AND A1.FNL_ITM_GD_CD <![CDATA[<>]]> ( CASE WHEN A1.SELL_TP_CD = '1'         THEN 'E'   /*일시불(할부)판매고객*/
                                                                WHEN A1.SELL_TP_CD IN ('2', '4') THEN CASE WHEN A1.ALNCMP_CD = '45'
                                                                                                            AND A1.GD_USE_DAYS <![CDATA[<=]]> 7  THEN 'E'   /* K멤버스 7일 이하 */
                                                                                                           WHEN NVL(A1.ALNCMP_CD, ' ') <![CDATA[<>]]> '45'
                                                                                                            AND A1.GD_USE_DAYS <![CDATA[<=]]> 14 THEN 'E'   /* K멤버스외 14일 이하 */
                                                                                                           ELSE 'R'
                                                                                                      END
                                                                ELSE 'R'
                                                           END ) THEN '1'
               END AS ERROR_CHECK      /* 등급오류건 */
             , A1.REFURBISH_YN         /* 리퍼여부 */
             , A1.FNL_ITM_GD_CD        /* 등급 */
             , A1.USE_QTY              /* 사용수량 */
             , A1.REFR_AS_RCP_YN       /* 리퍼접수여부 */
             , A1.CNTR_DTL_NO          /* 고객번호 */
             , A1.RCGVP_KNM            /* 수령자한글명 */
             , A1.SELL_TP_CD           /* 판매유형코드 */
             , A1.SELL_TP_NM           /* 판매유형명 */
             , A1.MNGT_UNIT_NM         /* 관리단위명 */
             , A1.REFER_ARTC           /* 참고사항 */
             , A1.SV_BIZ_DCLSF_CD      /* 서비스업무세분류코드 BA04 */
             , A1.SV_BIZ_DCLSF_NM      /* 서비스업무세분류코드명 BA04 */
             , A1.OSTR_CONF_DT         /* 확인일자 */
             , A1.OSTR_CONF_DT1        /* 체크용확인일자 */
             , A1.OSTR_DT              /* 출고일자 */
             , A1.RTNGD_PROCS_TP_CD    /* 반품처리유형코드 */
             , A1.RTNGD_PROCS_TP_CD1   /* 반품처리유형코드 */
             , A1.RMK_CN               /* 비고 */
             , A1.CNTR_NO_NEW          /* 신규계약번호 */
             , A1.BAR_CD               /* 바코드 */
             , A1.AS_LCT_NM            /* AS위치코드명 */
             , A1.AS_PHN_NM            /* AS현상코드명 */
             , A1.AS_CAUS_NM           /* AS원인코드명 */
             , A1.SV_PROCS_CN          /* 서비스처리내용 */
             , A1.ICHR_PRTNR_NO        /* 담당엔지니어사번 */
             , A1.EMP_NM               /* 담당엔지니어명 */
             , A1.RCP_ICHR_PRTNR_NO    /* 철거요청사번 */
             , A1.FST_RGST_USER_NM     /* 철거요청자명 */
             , A1.CNSL_MO_CN           /* 접수내역 */
             , A1.OG_NM                /* 접수자소속 */
             , A1.RCST_DV              /* 접수자 구분 */
             , A1.PRTNR_KNM            /* 접수자명 */
             , A1.BAD_DV_NM            /* 불량구분 */
             , A1.WK_OSTR_SN           /* 작업출고일련번호 */
             , A1.SV_BIZ_HCLSF_CD      /* 서비스대분류코드 */
             , A1.WK_WARE_NO           /* 작업창고번호 */
             , A1.WARE_NM              /* 작업창고명 */
             , A1.MNGR_DV_CD           /* 관리자 구분코드 */
             , A1.ITM_OSTR_NO          /* 품목출고번호 */
             , A1.STKR_R_PRNT_YN       /* 스티거R출력여부 */
             , A1.RTNGD_RVPY_PROCS_YN  /* 반품수불처리여부 */
             , A1.ITEM_KND             /* 품목구분 */
             , A1.MGT_UNT              /* 관리구분 */
             , A1.CNTR_NO              /* 고객번호 */
             , A1.CNTR_SN              /* 고객순번 */
             , A1.ITEM_GR              /* 상품그룹 */
          FROM
             (
               SELECT T1.CST_SV_ASN_NO                                                                        /* 고객서비스배정내역 */
                    , T1.WK_OSTR_SN                                                                           /* 작업출고일련번호 */
                    , T1.SV_BIZ_HCLSF_CD                                                                      /* 서비스대분류코드 */
                    , T1.WK_WARE_NO                                                                           /* 작업창고번호 */
                    , T1.SV_BIZ_DCLSF_CD                                                                      /* 서비스업무세분류코드 */
                    , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_DCLSF_CD', T1.SV_BIZ_DCLSF_CD) AS SV_BIZ_DCLSF_NM      /* 업무유형 */
                    , T6.PD_PRP_VAL19                                                 AS ITEM_KND             /* 품목종류 */
                    , T1.FNL_ITM_GD_CD                                                                        /* 최종품목등급 */
                    , TO_CHAR(TO_NUMBER(T5.SAP_MAT_CD))                               AS SAP_CD               /* SAP코드 */
                    , T1.ITM_PD_CD                                                                            /* 품목상품코드 */
                    , T5.PD_ABBR_NM                                                   AS ITM_PD_NM            /* 품목상품명 */
                    , T1.STKR_PRNT_YN                                                                         /* 스티커출력여부 */
                    , T3.IST_DT                                                                               /* 설치일자 */
                    , T13.RSG_APLC_DT                                                 AS REQD_DT              /* 철거일자 */
                    , TO_CHAR( TO_DATE(T4.VST_FSH_DT || T4.VST_FSH_HH, 'YYYYMMDDHH24MISS')
                             , 'YYYY-MM-DD HH24:MI:SS')                               AS VST_FSH_DT           /* 작업일자 */
                    , T1.RTNGD_CONF_YN                                                                        /* 반품확인여부 */
                    , T1.RTNGD_CONF_YN                                                AS RTNGD_CONF_YN1       /* 기존반품확인여부 */
                    , CASE WHEN T3.IST_DT IS NULL       THEN 0
                           ELSE TO_DATE(NVL(T13.RSG_APLC_DT, T1.FNL_VST_FSH_DT), 'YYYYMMDD') - TO_DATE(T3.IST_DT, 'YYYYMMDD')
                      END                                                             AS USE_DAY              /* 사용일수 */
                    , CASE WHEN T3.IST_DT IS NULL           THEN 0
                           WHEN T13.RSG_APLC_DT IS NOT NULL THEN TO_DATE(T13.RSG_APLC_DT, 'YYYYMMDD') - TO_DATE(T3.IST_DT, 'YYYYMMDD')
                           ELSE TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') - TO_DATE(T3.IST_DT, 'YYYYMMDD')
                      END                                                             AS GD_USE_DAYS          /* 사용일수(등급계산) */
                    , CEIL( MONTHS_BETWEEN( TO_DATE(NVL(T13.RSG_APLC_DT, T1.FNL_VST_FSH_DT), 'YYYYMMDD')
                                          , TO_DATE(T3.IST_DT, 'YYYYMMDD')) )         AS USE_MTHS             /* 사용개월 */

                    , T7.SELL_TP_CD                                                                           /* 판매유형코드 */
                    , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', T7.SELL_TP_CD)           AS SELL_TP_NM           /* 판매유형명 */
                    , F_CMZ_CD_NM('TNT_WELLS', 'PRD_MNGT_TP_CD', T7.SELL_TP_CD)       AS MNGT_UNIT_NM         /* 관리단위 */
                    , T7.ALNCMP_CD                                                                            /* 제휴사코드 */
                    , T7.FRISU_YN                                                                             /* 무상여부 */
                    , CASE WHEN MONTHS_BETWEEN(TO_DATE(T1.FNL_VST_FSH_DT, 'YYYYMMDD'), TO_DATE(T3.IST_DT, 'YYYYMMDD')) <![CDATA[<=]]> 1 THEN 'Y'
                           ELSE 'N'
                      END                                                             AS REFURBISH_YN         /* 리퍼여부 */
                    , T1.USE_QTY                                                                              /* 사용수량 */
                    , CASE WHEN T1.REFR_AS_RCP_YN = 'Y' THEN '접수완료' END             AS REFR_AS_RCP_YN       /* 리퍼접수 */
                    , T1.CNTR_NO || '-' || T1.CNTR_SN                                 AS CNTR_DTL_NO          /* 계약상세번호 */
                    , T9.RCGVP_KNM                                                                            /* 고객명 */
                    , CASE WHEN T7.FRISU_YN = 'Y'   THEN '무료체험'
                           WHEN T7.ALNCMP_CD = '45' THEN F_CMZ_CD_NM('TNT_WELLS', 'ALNCMP_CD', T7.ALNCMP_CD)
                      END                                                             AS REFER_ARTC           /* 참고사항 */
                    , T1.OSTR_CONF_DT                                                                         /* 확인일자 */
                    , T1.OSTR_CONF_DT                                                 AS OSTR_CONF_DT1        /* 확인일자 */
                    , T1.OSTR_DT                                                                              /* 전산반품 */
                    , T1.RTNGD_PROCS_TP_CD                                                                    /* 반품처리유형코드 */
                    , T1.RTNGD_PROCS_TP_CD                                            AS RTNGD_PROCS_TP_CD1   /* 반품처리유형코드 */
                    , T1.RMK_CN                                                                               /* 특이사항 */
                    , CASE WHEN T1.CST_SV_ASN_NO LIKE '9%' THEN T2.CNTR_NO END        AS CNTR_NO_NEW          /* 신규 고객번호 */
                    , CASE WHEN T1.FNL_ITM_GD_CD = 'E'
                            AND T1.SV_BIZ_DCLSF_CD = '3210' THEN T1.FST_BC_NO
                           ELSE T4.BC_NO
                      END                                                             AS BAR_CD               /* 제조번호 */
                    , F_CMZ_CD_NM('TNT_WELLS', 'AS_LCT_CD', T4.AS_LCT_CD)             AS AS_LCT_NM            /* AS위치코드 */
                    , F_CMZ_CD_NM('TNT_WELLS', 'AS_PHN_CD', T4.AS_PHN_CD)             AS AS_PHN_NM            /* AS현상코드 */
                    , F_CMZ_CD_NM('TNT_WELLS', 'AS_CAUS_CD', T4.AS_CAUS_CD)           AS AS_CAUS_NM           /* AS원인코드 */
                    , F_CMZ_CD_NM('TNT_WELLS', 'BAD_DV_CD', T4.BAD_DV_CD)             AS BAD_DV_NM            /* 불량구분 */
                    , T4.SV_PROCS_CN                                                                          /* 서비스처리내용 */
                    , T1.ICHR_PRTNR_NO                                                                        /* 담당엔지니어사번 */
                    , ( SELECT PRTNR_KNM
                          FROM TB_OGBS_PRTNR_BAS
                         WHERE DTA_DL_YN = 'N'
                           AND PRTNR_NO  = T1.ICHR_PRTNR_NO
                           AND OG_TP_CD  = T1.OG_TP_CD )                              AS EMP_NM               /* 담당엔지니어명 */
                    , T2.RCP_ICHR_PRTNR_NO                                                                    /* 철거요청사번 */
                    , ( SELECT PRTNR_KNM
                          FROM TB_OGBS_PRTNR_BAS
                         WHERE DTA_DL_YN = 'N'
                           AND PRTNR_NO  = T2.RCP_ICHR_PRTNR_NO
                           AND OG_TP_CD  = T2.RCP_OG_TP_CD )                          AS FST_RGST_USER_NM     /* 철거요청자명*/
                    , T2.CNSL_MO_CN                                                                           /* 접수내역 */
                    , T11.OG_NM                                                                               /* 접수자소속 */
                    , T11.PRTNR_KNM                                                                           /* 접수자명 */
                    , CASE WHEN SUBSTR(T11.OG_CD, 1, 1) BETWEEN 'A' AND 'H' THEN '방판'
                           WHEN SUBSTR(T11.OG_CD, 1, 1) BETWEEN 'Y' AND 'Z'
                             OR T11.OG_CD = '75050'                         THEN '신규채널'
                           ELSE '기타'
                      END                                                             AS RCST_DV              /* 접수자 구분 */
                    , T12.WARE_NM                                                                             /* 창고명 */
                    , T1.MNGR_DV_CD                                                                           /* 관리자 구분코드 */
                    , T1.ITM_OSTR_NO                                                                          /* 품목출고번호 */
                    , T1.STKR_R_PRNT_YN                                                                       /* 스티거R출력여부 */
                    , CASE WHEN T1.RTNGD_RVPY_PROCS_YN = 'Y' THEN 'Y' ELSE 'N' END    AS RTNGD_RVPY_PROCS_YN  /* 반품수불처리여부 */
                    , T6.PD_PRP_VAL05                                                 AS MGT_UNT              /* 관리단위 */
                    , T1.CNTR_NO                                                                              /* 계약번호 */
                    , T1.CNTR_SN                                                                              /* 계약일련번호 */
                    , CASE WHEN T6.PD_PRP_VAL20 IN ('5', '7', '8')
                             OR T1.ITM_PD_CD IN ('WM07100357', 'WM03100514', 'WM01100660', 'WM01100661', 'WM07100344')
                           THEN '999'   /* 기타 */
                           WHEN T1.ITM_PD_CD IN ( 'WM01100303', 'WM01100073', 'WM01100277', 'WM01100275', 'WM01100276', 'WM01100074', 'WM01100088'
                                                , 'WM01100309', 'WM01100307', 'WM01100308', 'WM01100038', 'WM01100037', 'WM01100061', 'WM01100057'
                                                , 'WM01100210', 'WM01100215', 'WM01100281', 'WM01100313', 'WM01100282', 'WM01100314', 'WM01100278'
                                                , 'WM01100310', 'WM01100211', 'WM01100216', 'WM01100283', 'WM01100315', 'WM01103461', 'WM01103428' )
                           THEN '998'   /* tt특별자재대상 */
                           ELSE NVL(T14.PART_ITEM_GR, T6.PD_PRP_VAL20)
                      END                                                             AS ITEM_GR              /* 상품그룹 */
                 FROM TB_SVST_SV_WK_OSTR_IZ T1                   /* 서비스 작업출고내역 */
                INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ T2         /* 고객서비스AS설치대상내역 */
                   ON T2.CST_SV_ASN_NO = CASE WHEN T1.CST_SV_ASN_NO LIKE '9%' THEN '1' || SUBSTR(T1.CST_SV_ASN_NO, 2)
                                              ELSE T1.CST_SV_ASN_NO
                                         END
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ T3             /* 고객서비스수행내역 */
                   ON T3.CNTR_NO = T1.CNTR_NO
                  AND T3.CNTR_SN = T1.CNTR_SN
                INNER JOIN TB_SVPD_CST_SV_WK_RS_IZ T4            /* 고객서비스작업결과내역 */
                   ON T4.CST_SV_ASN_NO = T1.CST_SV_ASN_NO
                INNER JOIN TB_PDBS_PD_BAS T5                     /* 상품기본 */
                   ON T5.PD_CD = T1.ITM_PD_CD
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL T6            /* 상품각사속성상세 */
                   ON T6.PD_CD = T5.PD_CD
                 LEFT OUTER JOIN TB_SSCT_CNTR_DTL T7             /* 계약상세 */
                   ON T7.CNTR_NO   = T3.CNTR_NO
                  AND T7.CNTR_SN   = T3.CNTR_SN
                  AND T7.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN TB_SSCT_CNTR_ADR_REL T8         /* 계약주소관계 */
                   ON T8.DTL_CNTR_NO  = T7.CNTR_NO
                  AND T8.DTL_CNTR_SN  = T7.CNTR_SN
                  AND T8.ADRPC_TP_CD IN ('2','3')
                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T8.VL_STRT_DTM AND T8.VL_END_DTM
                  AND T8.DTA_DL_YN     = 'N'
                 LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS T9       /* 계약주소지기본 */
                   ON T9.CNTR_ADRPC_ID = T8.CNTR_ADRPC_ID
                 LEFT OUTER JOIN
                    (
                      SELECT S1.CNTR_NO
                           , S1.CNTR_SN
                           , S1.RCP_ICHR_PRTNR_NO
                           , S1.RCP_OG_TP_CD
                           , NVL(S1.FNL_RCPDT, S1.RCPDT)                                      AS RCP_DT
                           , ROW_NUMBER() OVER(PARTITION BY S1.CNTR_NO, S1.CNTR_SN
                                                   ORDER BY S1.FNL_RCPDT DESC, S1.RCPDT DESC) AS RN
                        FROM TB_SVPD_CST_SVAS_IST_OJ_IZ S1   /* 고객서비스AS설치대상내역 */
                       WHERE S1.DTA_DL_YN = 'N'
                         AND S1.SV_BIZ_DCLSF_CD LIKE '11%'
                         AND S1.MTR_STAT_CD <![CDATA[<>]]> '3'
                         AND S1.RCP_OG_TP_CD IN ('W02', 'W03', 'W06', 'HR1')
                         AND EXISTS ( SELECT /*+ NO_UNNEST */ 1
                                        FROM TB_SVPD_CST_SVAS_IST_ASN_IZ S2
                                       WHERE S2.DTA_DL_YN       = 'N'
                                         AND S2.WK_PRGS_STAT_CD = '20'
                                         AND S2.CST_SV_ASN_NO   = S1.CST_SV_ASN_NO
                                         AND S2.VST_CNFMDT BETWEEN #{stFnlVstFshDtFrom} AND #{edFnlVstFshDtTo} )
                    ) T10
                   ON T10.CNTR_NO = T1.CNTR_NO
                  AND T10.CNTR_SN = T1.CNTR_SN
                  AND T10.RN = 1
                 LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ T11         /* 월파트너내역 */
                   ON T11.BASE_YM   = SUBSTR(T10.RCP_DT, 1, 6)
                  AND T11.OG_TP_CD  = T10.RCP_OG_TP_CD
                  AND T11.PRTNR_NO  = T10.RCP_ICHR_PRTNR_NO
                  AND T11.DTA_DL_YN = 'N'
                INNER JOIN
                    (
                      SELECT WARE_NO
                           , MAX(WARE_NM) AS WARE_NM
                        FROM TB_SVST_MCBY_WARE_IZ   /* 월별창고내역 */
                       WHERE DTA_DL_YN   = 'N'
                         AND WARE_DV_CD  = #{strWareDvCd}
                         AND WARE_NO LIKE #{strWareDvCd} || '%'
                         AND APY_YM BETWEEN SUBSTR(#{stFnlVstFshDtFrom}, 1, 6) AND SUBSTR(#{edFnlVstFshDtTo}, 1, 6)
                    <if test="@MybatisUtils@isNotEmpty(strWareNoM)">
                         AND HGR_WARE_NO = #{strWareNoM}
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(strWareNoD)">
                         AND WARE_NO     = #{strWareNoD}
                    </if>
                       GROUP BY WARE_NO
                    ) T12
                   ON T12.WARE_NO = T1.WK_WARE_NO
                 LEFT OUTER JOIN TB_SSCT_CNTR_RSG_PROCS_IZ T13   /* 계약해지처리내역 */
                   ON T13.CNTR_NO   = T3.CNTR_NO
                  AND T13.CNTR_SN   = T3.CNTR_SN
                  AND T13.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN
                    (
                      SELECT S1.OJ_PD_CD
                           , MAX(S2.PD_PRP_VAL20) AS PART_ITEM_GR
                        FROM TB_PDBS_PD_REL S1                 /* 상품관계 */
                       INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S2   /* 상품각사속성상세 */
                          ON S2.PD_CD = S1.BASE_PD_CD
                       WHERE S1.DTA_DL_YN          = 'N'
                         AND S1.PD_REL_TP_CD       = '14'   /* AS부품 */
                         AND S2.DTA_DL_YN          = 'N'
                         AND S2.PD_EXTS_PRP_GRP_CD = 'PART'
                         AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN S1.VL_STRT_DTM AND S1.VL_END_DTM
                       GROUP BY S1.OJ_PD_CD
                    ) T14
                   ON T14.OJ_PD_CD = T1.ITM_PD_CD
                WHERE T1.DTA_DL_YN          = 'N'
                  AND T1.SV_BIZ_HCLSF_CD    = '6'
                  AND T2.DTA_DL_YN          = 'N'
                  AND T3.DTA_DL_YN          = 'N'
                  AND T4.DTA_DL_YN          = 'N'
                  AND T5.DTA_DL_YN          = 'N'
                  AND T5.PD_TP_CD           = 'M'
                  AND T6.DTA_DL_YN          = 'N'
                  AND T6.PD_EXTS_PRP_GRP_CD = 'PART'
            <if test="@MybatisUtils@isEmpty(stRtngdProcsTpCd)">
                  AND T1.FNL_VST_FSH_DT BETWEEN #{stFnlVstFshDtFrom} AND #{edFnlVstFshDtTo}
            </if>
            <if test="@MybatisUtils@isNotEmpty(stRtngdProcsTpCd)">
                  AND T1.RTNGD_PROCS_TP_CD  = #{stRtngdProcsTpCd}
                  AND T1.OSTR_CONF_DT BETWEEN #{stFnlVstFshDtFrom} AND #{edFnlVstFshDtTo}
            </if>
            <if test="@MybatisUtils@isNotEmpty(stOstrConfDt)">
                  AND T1.OSTR_CONF_DT       = #{stOstrConfDt}
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
                  AND T6.PD_PRP_VAL19       = #{itmKndCd}
            </if>
            <if test="@MybatisUtils@isNotEmpty(fnlItmGdCd)">
                  AND T1.FNL_ITM_GD_CD      = #{fnlItmGdCd}
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND T1.ITM_PD_CD          = #{itmPdCd}
            </if>
            <if test="@MybatisUtils@equals(strConfYnCd, '1')">
                  AND T1.OSTR_CONF_DT IS NOT NULL
            </if>
            <if test="@MybatisUtils@equals(strConfYnCd, '2')">
                  AND T1.OSTR_CONF_DT IS NULL
            </if>
            <if test="@MybatisUtils@isNotEmpty(svBizDclsfCd)">
                  AND T1.SV_BIZ_DCLSF_CD    = #{svBizDclsfCd}
            </if>
             ) A1
    <where>
    <if test='@MybatisUtils@equals(chkErrorCheck, "Y")'>
          AND ( CASE WHEN A1.SV_BIZ_DCLSF_CD LIKE '34%'
                      AND A1.ITEM_KND = '4'
                      AND A1.FNL_ITM_GD_CD = 'X'                  THEN ''
                     WHEN A1.FRISU_YN = 'Y'                       THEN ''
                     WHEN A1.SV_BIZ_DCLSF_CD LIKE '34%'
                      AND A1.ITEM_KND = '4'
                      AND A1.FNL_ITM_GD_CD <![CDATA[<>]]> ( CASE WHEN A1.SELL_TP_CD = '1'         THEN 'E'   /*일시불(할부)판매고객*/
                                                                 WHEN A1.SELL_TP_CD IN ('2', '4') THEN CASE WHEN A1.ALNCMP_CD = '45'
                                                                                                             AND A1.GD_USE_DAYS <![CDATA[<=]]> 7  THEN 'E'   /* K멤버스 7일 이하 */
                                                                                                            WHEN NVL(A1.ALNCMP_CD, ' ') <![CDATA[<>]]> '45'
                                                                                                             AND A1.GD_USE_DAYS <![CDATA[<=]]> 14 THEN 'E'   /* K멤버스외 14일 이하 */
                                                                                                            ELSE 'R'
                                                                                                       END
                                                                 ELSE 'R'
                                                            END ) THEN '1'
                END ) = '1'
    </if>
    <if test='@MybatisUtils@isNotEmpty(barCode)'>
          AND A1.BAR_CD = #{barCode}
    </if>
    </where>
         ORDER BY A1.CST_SV_ASN_NO
    </select>

    <select id="selectNextItmOstrNo" resultType="java.lang.String">
        SELECT #{ostrTpCd} ||#{ostrDt} || LPAD(SQ_SVST_ITM_OSTR_IZ$ITM_OSTR_NO.NEXTVAL,7,'0') AS ITM_OSTR_NO
          FROM DUAL
    </select>

    <select id="selectNextItmStrNo" resultType="java.lang.String">
    <!-- 반품인 경우 입고번호 채번 261 -> 161 itmStrNo (161 + 등록일자8 + 일련번호7) -->
        SELECT (CASE #{ostrTpCd} WHEN '261' THEN '161' WHEN '281' THEN '161' WHEN '123' THEN '123' ELSE '' END) || #{ostrDt} || LPAD(SQ_SVST_ITM_STR_IZ$ITM_STR_NO.NEXTVAL,7,'0') AS ITM_STR_NO
          FROM DUAL
    </select>

    <select id="selectHgrWareNo" resultType="java.lang.String">
        SELECT A.HGR_WARE_NO
          FROM TB_SVST_MCBY_WARE_IZ A
         WHERE 1 = 1
           AND APY_YM = SUBSTR(#{cfrmDt}, 1, 6)
           AND WARE_NO = #{wkWareNo}
    </select>

    <select id="selectUpHgrWareNo" resultType="java.lang.String">
        SELECT A.HGR_WARE_NO
          FROM TB_SVST_MCBY_WARE_IZ A
         WHERE 1 = 1
           AND APY_YM = SUBSTR(#{cfrmDt}, 1, 6)
           AND WARE_NO = #{hgrWareNo}
    </select>

    <select id="selectRmkCn" resultType="java.lang.String">
        SELECT REPLACE(TRIM(''),' ', '') || ' ' || #{cfrmDt} || ' ' || #{fnlItmGdCd} || '급 ' || DECODE(#{rtngdProcsTpCd},'10','물류폐기','20','리퍼용','21','품질팀','22','리퍼-tt특별자재','') || ' 반품입니다'
          FROM DUAL
    </select>

    <select id="selectRefrRmkCn"  resultType="java.lang.String">
        SELECT REPLACE(TRIM(''),' ', '') || ' ' || #{cfrmDt} || ' ' || #{fnlItmGdCd} || '급 ' || DECODE(#{rtngdProcsTpCd},'80','리퍼작업완료-A급','81','리퍼작업완료-B-1급','82','리퍼작업완료-B-2급','') || ' 리퍼완료 기타 출고 입니다.'
          FROM DUAL
    </select>

    <insert id="insertQuantityItmOstrIz" >

        INSERT INTO TB_SVST_ITM_OSTR_IZ (  /* 품목출고내역 */
                  ITM_OSTR_NO              /* 품목출고번호 */
                , OSTR_SN                  /* 출고일련번호 */
                , OSTR_TP_CD               /* 출고유형코드 */
                , OSTR_WARE_NO             /* 출고창고번호 */
                , OSTR_DT                  /* 출고일자 */
                , ITM_KND_CD               /* 품목종류코드 */
                , ITM_PD_CD                /* 품목상품코드 */
                , OSTR_WARE_DV_CD          /* 출고창고구분코드 */
                , MNGT_UNIT_CD             /* 관리단위코드 */
                , BOX_UNIT_QTY             /* 박스단위수량 */
                , ITM_GD_CD                /* 품목등급코드 */
                , OSTR_QTY                 /* 출고수량 */
                , OSTR_AK_NO               /* 출고요청번호 */
                , OSTR_AK_SN               /* 출고요청일련번호 */
                , STR_AK_WARE_DV_CD        /* 입고요청창고구분코드 */
                , WARE_MNGT_PRTNR_NO       /* 창고관리파트너번호 */
                , WARE_MNGT_PRTNR_OG_TP_CD /* 창고관리파트너조직유형코드 */
                , STR_HOP_DT               /* 입고희망일자 */
                , OSTR_RSON_CD             /* 출고사유코드 */
                , ACB_DT                   /* 회계일자 */
                , EVID_DV_CD               /* 증빙구분코드 */
                , SELL_AK_RCP_NO           /* 판매요청접수번호 */
                , SELL_RCPDT               /* 판매접수일자 */
                , STR_TP_CD                /* 입고유형코드 */
                , STR_WARE_NO              /* 입고창고번호 */
                , STR_RGST_DT              /* 입고등록일자 */
                , COTP_ADJ_DT              /* 운송비정산일자 */
                , ITM_STR_NO               /* 품목입고번호 */
                , STR_SN                   /* 입고일련번호 */
                , STR_CONF_DT              /* 입고확인일자 */
                , STR_CONF_HH              /* 입고확인시간 */
                , STR_CONF_PRTNR_NO        /* 입고확인파트너번호 */
                , STR_CONF_PRTNR_OG_TP_CD  /* 입고확인파트너조직유형코드 */
                , DIDY_DV_CD               /* 직배구분코드 */
                , DTA_DL_YN                /* 데이터삭제여부 */
                , RMK_CN                   /* 비고내용 */
                <include refid="COMMON.insertSystemField" />)
            VALUES (
                  #{quantityItmOstrNo}
                , #{ostrSn}
                , #{ostrTpCd}
                , #{hgrWareNo}
                , #{cfrmDt}
                , #{itemKnd}
                , #{itmPdCd}
                , (SELECT WARE_DV_CD
                     FROM TB_SVST_MCBY_WARE_IZ
                     WHERE 1 = 1
                      AND WARE_NO = #{hgrWareNo}
                      AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
                , #{mgtUnt}
                , 0
                , #{fnlItmGdCd}
                , #{useQty}
                , #{ostrAkNo}
                , #{ostrAkSn}
                , #{strAkWareDvCd}
                , ( SELECT WARE_MNGT_PRTNR_NO
                      FROM TB_SVST_MCBY_WARE_IZ
                     WHERE 1 = 1
                       AND APY_YM =  SUBSTR(#{cfrmDt},1,6)
                       AND WARE_NO = #{hgrWareNo})
                , (SELECT OG_TP_CD
                     FROM TB_SVST_MCBY_WARE_IZ
                    WHERE 1 = 1
                      AND WARE_NO = #{hgrWareNo}
                      AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
                , #{strHopDt}
                , #{ostrRsonCd}
                , #{acbDt}
                , #{evidDvCd}
                , #{sellAkRcpNo}
                , #{sellRcpdt}
                , '161'
                , (CASE #{rtngdProcsTpCd} WHEN '20' THEN '100010' WHEN '21' THEN '100004' ELSE '' END)
                , #{cfrmDt}
                , #{cotpAdjDt}
                , #{strQuantityItmStrNo}
                , #{strSn}
                , #{cfrmDt}
                , TO_CHAR(SYSDATE, 'HH24MISS')
                , #{strConfPrtnrNo}
                , #{strConfPrtnrOgTpCd}
                , #{didyDvCd}
                , 'N'
                , #{rmkCn}
                <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <insert id="insertQuantityItmStrIz">

            INSERT INTO TB_SVST_ITM_STR_IZ (  /* 품목입고내역 */
                  ITM_STR_NO                /* 품목입고번호 */
                , STR_SN                    /* 입고일련번호 */
                , STR_TP_CD                 /* 입고유형코드 */
                , STR_RGST_DT               /* 입고등록일자 */
                , STR_WARE_NO               /* 입고창고번호 */
                , WARE_MNGT_PRTNR_NO        /* 창고관리파트너번호 */
                , WARE_MNGT_PRTNR_OG_TP_CD  /* 창고관리파트너조직유형코드 */
                , STR_WARE_DV_CD            /* 입고창고구분코드 */
                , DRT_STR_YN                /* 직접입고여부 */
                , DLVG_DLPNR_NO             /* 납품거래처번호 */
                , ITM_PD_CD                 /* 품목상품코드 */
                , ITM_GD_CD                 /* 품목등급코드 */
                , MNGT_UNIT_CD              /* 관리단위코드 */
                , STR_QTY                   /* 입고수량 */
                , STR_UPRC_AMT              /* 입고단가금액 */
                , STR_LOT_NO                /* 입고LOT번호 */
                , ACB_DT                    /* 회계일자 */
                , EVID_DV_CD                /* 증빙구분코드 */
                , OSTR_AK_NO                /* 출고요청번호 */
                , OSTR_AK_SN                /* 출고요청일련번호 */
                , ITM_OSTR_NO               /* 품목출고번호 */
                , OSTR_SN                   /* 출고일련번호 */
                , OSTR_TP_CD                /* 출고유형코드 */
                , OSTR_WARE_NO              /* 출고창고번호 */
                , OSTR_DT                   /* 출고일자 */
                , COTP_ADJ_DT               /* 운송비정산일자 */
                , ITM_GD_CTR_DT             /* 품목등급조정일자 */
                , ITM_GD_CTR_PRTNR_NO       /* 품목등급조정파트너번호 */
                , ITM_GD_CTR_PRTNR_OG_TP_CD /* 품목등급조정파트너조직유형코드 */
                , BFCT_ITM_GD_CD            /* 조정전품목등급코드 */
                , STR_CONF_DT               /* 입고확인일자 */
                , STR_CONF_HH               /* 입고확인시간 */
                , STR_CONF_PRTNR_NO         /* 입고확인파트너번호 */
                , STR_CONF_PRTNR_OG_TP_CD   /* 입고확인파트너조직유형코드 */
                , OJ_ORD_NO                 /* 대상주문번호 */
                , ORD_ITM_CD                /* 주문품목코드 */
                , STR_RSON_CD               /* 입고사유코드 */
                , RMK_CN                    /* 비고내용 */
                , DTA_DL_YN                 /* 데이터삭제여부 */
                <include refid="COMMON.insertSystemField" />)
            VALUES (
                  #{itmStrNo}
                , #{strSn}
                , '161'
                , #{cfrmDt}
                , (CASE #{rtngdProcsTpCd} WHEN '20' THEN '100010' WHEN '21' THEN '100004' ELSE '' END)
                , ( SELECT WARE_MNGT_PRTNR_NO
                      FROM TB_SVST_MCBY_WARE_IZ
                     WHERE 1 = 1
                       AND APY_YM =  SUBSTR(#{cfrmDt},1,6)
                       AND WARE_NO = #{upHgrWareNo})
                , ( SELECT OG_TP_CD
                      FROM TB_SVST_MCBY_WARE_IZ
                     WHERE 1 = 1
                       AND APY_YM =  SUBSTR(#{cfrmDt},1,6)
                       AND WARE_NO = #{upHgrWareNo})
                , (SELECT WARE_DV_CD
                     FROM TB_SVST_MCBY_WARE_IZ
                     WHERE 1 = 1
                      AND WARE_NO = #{upHgrWareNo}
                      AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
                , 'N'
                , #{hgrWareNo}
                , #{itmPdCd}
                , #{fnlItmGdCd}
                , #{mgtUnt}
                , #{useQty}
                , 0
                , #{strLotNo}
                , #{cfrmDt}
                , '1'
                , #{ostrAkNo}
                , #{ostrAkSn}
                , #{quantityItmOstrNo}
                , #{ostrSn}
                , '261'
                , #{hgrWareNo}
                , #{cfrmDt}
                , #{cotpAdjDt}
                , #{itmGdCtrDt}
                , #{itmGdCtrPrtnrNo}
                , #{itmGdCtrPrtnrOgTpCd}
                , #{bfctItmGdCd}
                , TO_CHAR(SYSDATE, 'YYYYMMDD')
                , TO_CHAR(SYSDATE, 'HH24MISS')
                , #{strConfPrtnrNo}
                , #{strConfPrtnrOgTpCd}
                , #{ojOrdNo}
                , #{ordItmCd}
                , #{strRsonCd}
                , #{rmkCn}
                , 'N'
                <include refid="COMMON.insertSystemFieldValue" /> )

    </insert>

    <insert id="insertRefrOstrFinish">
        INSERT INTO TB_SVST_ITM_OSTR_IZ (  /* 품목출고내역 */
              ITM_OSTR_NO              /* 품목출고번호 */
            , OSTR_SN                  /* 출고일련번호 */
            , OSTR_TP_CD               /* 출고유형코드 */
            , OSTR_WARE_NO             /* 출고창고번호 */
            , OSTR_DT                  /* 출고일자 */
            , ITM_KND_CD               /* 품목종류코드 */
            , ITM_PD_CD                /* 품목상품코드 */
            , OSTR_WARE_DV_CD          /* 출고창고구분코드 */
            , MNGT_UNIT_CD             /* 관리단위코드 */
            , BOX_UNIT_QTY             /* 박스단위수량 */
            , ITM_GD_CD                /* 품목등급코드 */
            , OSTR_QTY                 /* 출고수량 */
            , OSTR_AK_NO               /* 출고요청번호 */
            , OSTR_AK_SN               /* 출고요청일련번호 */
            , STR_AK_WARE_DV_CD        /* 입고요청창고구분코드 */
            , WARE_MNGT_PRTNR_NO       /* 창고관리파트너번호 */
            , WARE_MNGT_PRTNR_OG_TP_CD /* 창고관리파트너조직유형코드 */
            , STR_HOP_DT               /* 입고희망일자 */
            , OSTR_RSON_CD             /* 출고사유코드 */
            , ACB_DT                   /* 회계일자 */
            , EVID_DV_CD               /* 증빙구분코드 */
            , SELL_AK_RCP_NO           /* 판매요청접수번호 */
            , SELL_RCPDT               /* 판매접수일자 */
            , STR_TP_CD                /* 입고유형코드 */
            , STR_WARE_NO              /* 입고창고번호 */
            , COTP_ADJ_DT              /* 운송비정산일자 */
            , ITM_STR_NO               /* 품목입고번호 */
            , STR_SN                   /* 입고일련번호 */
            , STR_CONF_DT              /* 입고확인일자 */
            , STR_CONF_HH              /* 입고확인시간 */
            , STR_CONF_PRTNR_NO        /* 입고확인파트너번호 */
            , STR_CONF_PRTNR_OG_TP_CD  /* 입고확인파트너조직유형코드 */
            , DIDY_DV_CD               /* 직배구분코드 */
            , DTA_DL_YN                /* 데이터삭제여부 */
            , RMK_CN                   /* 비고내용 */
            <include refid="COMMON.insertSystemField" />)
        VALUES (
              #{itmOstrNo}
            , #{ostrSn}
            , #{ostrTpCd}
            , #{hgrWareNo}
            , #{cfrmDt}
            , #{itemKnd}
            , #{itmPdCd}
            , (SELECT WARE_DV_CD
                 FROM TB_SVST_MCBY_WARE_IZ
                 WHERE 1 = 1
                  AND WARE_NO = #{hgrWareNo}
                  AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
            , #{mgtUnt}
            , 0
            , #{fnlItmGdCd}
            , #{useQty}
            , #{ostrAkNo}
            , #{ostrAkSn}
            , #{strAkWareDvCd}
            , ( SELECT WARE_MNGT_PRTNR_NO
                  FROM TB_SVST_MCBY_WARE_IZ
                 WHERE 1 = 1
                   AND APY_YM =  SUBSTR(#{cfrmDt},1,6)
                   AND WARE_NO = #{hgrWareNo})
            , (SELECT OG_TP_CD
                 FROM TB_SVST_MCBY_WARE_IZ
                WHERE 1 = 1
                  AND WARE_NO = #{hgrWareNo}
                  AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
            , #{strHopDt}
            , #{ostrRsonCd}
            , #{cfrmDt}
            , '1'
            , #{sellAkRcpNo}
            , #{sellRcpdt}
            , #{strTpCd}
            , '71314'
            , #{cotpAdjDt}
            , ''
            , ''
            , TO_CHAR(SYSDATE, 'YYYYMMDD')
            , TO_CHAR(SYSDATE, 'HH24MISS')
            , #{session.employeeIDNumber}
            , #{session.ogTpCd}
            , #{didyDvCd}
            , 'N'
            , #{rmkCn}
            <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <update id="updateWkOstrIz">
	    UPDATE TB_SVST_SV_WK_OSTR_IZ /*서비스 작업출고내역 */
	       SET OSTR_CONF_DT = #{ostrConfDt}             /* 출고확인일자 */
	         , STKR_PRNT_YN = #{stkrPrntYn}             /* 스티커출력여부 */
	         , RMK_CN = #{rmkCn}                        /* 비고 */
	         , RTNGD_PROCS_TP_CD = #{rtngdProcsTpCd}    /* 반품처리유형코드 */
	         , RTNGD_RVPY_PROCS_YN = 'Y'                /* 반품수불처리여부 */
	         , OSTR_TP_CD = '261'                       /* 출고구분코드 */
	         , OSTR_WARE_NO = #{hgrWareNo}              /* 출고창고번호 */
	         , OSTR_DT = #{cfrmDt}                      /* 출고일자 */
	         , ITM_OSTR_NO = #{itmOstrNo}               /* 품목출고번호 */
	         , OSTR_SN = #{ostrSn}                      /* 출고순번 */
	       <include refid="COMMON.updateSystemField"/>
	     WHERE 1 = 1
	       AND CST_SV_ASN_NO = #{cstSvAsnNo}            /* 고객서비스배정번호 */
	       AND CNTR_NO = #{cntrNo}                      /* 계약번호 */
	       AND CNTR_SN = #{cntrSn}                      /* 계약순번 */
    </update>

    <update id="updateRefrOstrFinish">
	    UPDATE TB_SVST_SV_WK_OSTR_IZ /*서비스 작업출고내역 */
	       SET OSTR_CONF_DT = #{ostrConfDt}                 /* 출고확인일자 */
	         , STKR_PRNT_YN = #{stkrPrntYn}                 /* 스티커출력여부 */
	         , RMK_CN = #{rmkCn}                            /* 비고 */
	         , RTNGD_PROCS_TP_CD = #{rtngdProcsTpCd}        /* 반품처리유형코드 */
	         , RTNGD_RVPY_PROCS_YN = 'Y'                    /* 반품수불처리여부 */
	         , OSTR_TP_CD = '218'                           /* 출고구분코드 */
	         , OSTR_WARE_NO = #{hgrWareNo}                  /* 출고창고번호 */
	         , OSTR_DT = #{cfrmDt}                          /* 출고일자 */
	         , ITM_OSTR_NO = #{itmOstrNo}                   /* 품목출고번호 */
	         , OSTR_SN = #{ostrSn}                          /* 출고순번 */
	       <include refid="COMMON.updateSystemField"/>
	     WHERE 1 = 1
	       AND CST_SV_ASN_NO = #{cstSvAsnNo}                /* 고객서비스배정번호 */
	       AND CNTR_NO = #{cntrNo}                          /* 계약번호 */
	       AND CNTR_SN = #{cntrSn}                          /* 계약순번 */


    </update>

    <update id="updateNotOstrConfDt">
		UPDATE TB_SVST_SV_WK_OSTR_IZ                    /*서비스 작업출고내역 */
	       SET OSTR_CONF_DT = #{ostrConfDt}             /* 출고확인일자 */
	         , STKR_PRNT_YN = #{stkrPrntYn}             /* 스티커출력여부 */
	         , RMK_CN = #{rmkCn}                        /* 비고 */
	         , RTNGD_PROCS_TP_CD = #{rtngdProcsTpCd}    /* 반품처리유형코드 */
	       <include refid="COMMON.updateSystemField"/>
	     WHERE 1 = 1
	       AND CST_SV_ASN_NO = #{cstSvAsnNo}            /* 고객서비스배정번호 */
	       AND CNTR_NO = #{cntrNo}                      /* 계약번호 */
	       AND CNTR_SN = #{cntrSn}                      /* 계약순번 */
    </update>


    <select id="selectHgrWarePrtnrNo" resultType="java.lang.String">
        SELECT WARE_MNGT_PRTNR_NO               /*창고관리파트너번호*/
          FROM TB_SVST_MCBY_WARE_IZ             /*월별창고내역*/
         WHERE 1 = 1
           AND APY_YM =  SUBSTR(#{cfrmDt},1,6)
           AND WARE_NO = #{hgrWareNo}

    </select>

    <select id="selectUpHgrWarePrtnrNo" resultType="java.lang.String">
        SELECT WARE_MNGT_PRTNR_NO           /*창고관리파트너번호*/
          FROM TB_SVST_MCBY_WARE_IZ         /*월별창고내역*/
         WHERE 1 = 1
           AND APY_YM =  SUBSTR(#{cfrmDt},1,6)
           AND WARE_NO = #{upHgrWareNo}
    </select>

    <update id="updateReturningGoodsStoreConfirmations">
         UPDATE TB_SVST_SV_WK_OSTR_IZ                       /*서비스작업출고내역*/
            SET RTNGD_CONF_YN = #{rtngdConfYn}              /*반품확인여부*/
              , RTNGD_PROCS_TP_CD = #{rtngdProcsTpCd}       /*반품처리유형코드*/
              , RMK_CN = #{rmkCn}                           /*비고*/
          <include refid="COMMON.updateSystemField"/>
          WHERE CST_SV_ASN_NO = #{cstSvAsnNo}               /*고객서비스배정번호*/
            AND WK_OSTR_SN = #{wkOstrSn}                    /*작업출고순번*/
            AND CNTR_NO = #{cntrNo}                         /*계약번호*/
            AND CNTR_SN = #{cntrSn}                         /*계약순번*/

    </update>

    <insert id="insertDiDisuseOstrIz" >
        INSERT INTO TB_SVST_ITM_OSTR_IZ (  /* 품목출고내역 */
                  ITM_OSTR_NO              /* 품목출고번호 */
                , OSTR_SN                  /* 출고일련번호 */
                , OSTR_TP_CD               /* 출고유형코드 */
                , OSTR_WARE_NO             /* 출고창고번호 */
                , OSTR_DT                  /* 출고일자 */
                , ITM_KND_CD               /* 품목종류코드 */
                , ITM_PD_CD                /* 품목상품코드 */
                , OSTR_WARE_DV_CD          /* 출고창고구분코드 */
                , MNGT_UNIT_CD             /* 관리단위코드 */
                , BOX_UNIT_QTY             /* 박스단위수량 */
                , ITM_GD_CD                /* 품목등급코드 */
                , OSTR_QTY                 /* 출고수량 */
                , OSTR_AK_NO               /* 출고요청번호 */
                , OSTR_AK_SN               /* 출고요청일련번호 */
                , STR_AK_WARE_DV_CD        /* 입고요청창고구분코드 */
                , WARE_MNGT_PRTNR_NO       /* 창고관리파트너번호 */
                , WARE_MNGT_PRTNR_OG_TP_CD /* 창고관리파트너조직유형코드 */
                , STR_HOP_DT               /* 입고희망일자 */
                , OSTR_RSON_CD             /* 출고사유코드 */
                , ACB_DT                   /* 회계일자 */
                , EVID_DV_CD               /* 증빙구분코드 */
                , SELL_AK_RCP_NO           /* 판매요청접수번호 */
                , SELL_RCPDT               /* 판매접수일자 */
                , STR_TP_CD                /* 입고유형코드 */
                , STR_WARE_NO              /* 입고창고번호 */
                , STR_RGST_DT              /* 입고등록일자 */
                , COTP_ADJ_DT              /* 운송비정산일자 */
                , ITM_STR_NO               /* 품목입고번호 */
                , STR_SN                   /* 입고일련번호 */
                , STR_CONF_DT              /* 입고확인일자 */
                , STR_CONF_HH              /* 입고확인시간 */
                , STR_CONF_PRTNR_NO        /* 입고확인파트너번호 */
                , STR_CONF_PRTNR_OG_TP_CD  /* 입고확인파트너조직유형코드 */
                , DIDY_DV_CD               /* 직배구분코드 */
                , DTA_DL_YN                /* 데이터삭제여부 */
                , RMK_CN                   /* 비고내용 */
                <include refid="COMMON.insertSystemField" />)
            VALUES (
                  #{disuseItmOstrNo}
                , #{ostrSn}
                , #{disuseOstrTpCd}
                , #{hgrWareNo}
                , #{cfrmDt}
                , #{itemKnd}
                , #{itmPdCd}
                , (SELECT WARE_DV_CD
                     FROM TB_SVST_MCBY_WARE_IZ
                     WHERE 1 = 1
                      AND WARE_NO = #{hgrWareNo}
                      AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
                , #{mgtUnt}
                , 0
                , #{fnlItmGdCd}
                , #{useQty}
                , ''
                , ''
                , #{strAkWareDvCd}
                , ( SELECT WARE_MNGT_PRTNR_NO
                      FROM TB_SVST_MCBY_WARE_IZ
                     WHERE 1 = 1
                       AND APY_YM =  SUBSTR(#{cfrmDt},1,6)
                       AND WARE_NO = #{hgrWareNo})
                , (SELECT OG_TP_CD
                     FROM TB_SVST_MCBY_WARE_IZ
                    WHERE 1 = 1
                      AND WARE_NO = #{hgrWareNo}
                      AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
                , #{strHopDt}
                , #{ostrRsonCd}
                , #{cfrmDt}
                , '1'
                , #{sellAkRcpNo}
                , #{sellRcpdt}
                , '212'
                , '200879'
                , #{cfrmDt}
                , #{cotpAdjDt}
                , ''
                , ''
                , TO_CHAR(SYSDATE, 'YYYYMMDD')
                , TO_CHAR(SYSDATE, 'HH24MISS')
                , #{session.employeeIDNumber}
                , #{session.ogTpCd}
                , #{didyDvCd}
                , 'N'
                , #{ostrConfDt} || '폐기출고'
                <include refid="COMMON.insertSystemFieldValue" /> )
    </insert>

    <update id="updateReturningGoodsStrConfirm">
        UPDATE TB_SVST_CST_SV_ITM_STOC_IZ T1        /*고객서비스품목재고내역*/
           SET T1.MMT_STOC_A_GD_QTY = CASE WHEN NVL(T1.MMT_STOC_A_GD_QTY, 0) - DECODE(#{fnlItmGdCd}, 'A', #{useQty}, 0) <![CDATA[<]]> 0
                                           THEN 0
                                           ELSE NVL(T1.MMT_STOC_A_GD_QTY, 0) - DECODE(#{fnlItmGdCd}, 'A', #{useQty}, 0)
                                       END
             , T1.MMT_STOC_B_GD_QTY = CASE WHEN NVL(T1.MMT_STOC_B_GD_QTY, 0) - DECODE(#{fnlItmGdCd}, 'B', #{useQty}, 0) <![CDATA[<]]> 0
                                           THEN 0
                                           ELSE NVL(T1.MMT_STOC_B_GD_QTY, 0) - DECODE(#{fnlItmGdCd}, 'B', #{useQty}, 0)
                                       END
             , T1.MMT_STOC_E_GD_QTY = CASE WHEN NVL(T1.MMT_STOC_E_GD_QTY, 0) - DECODE(#{fnlItmGdCd}, 'E', #{useQty}, 0) <![CDATA[<]]> 0
                                           THEN 0
                                           ELSE NVL(T1.MMT_STOC_E_GD_QTY, 0) - DECODE(#{fnlItmGdCd}, 'E', #{useQty}, 0)
                                       END
             , T1.MMT_STOC_R_GD_QTY = CASE WHEN NVL(T1.MMT_STOC_R_GD_QTY, 0) - DECODE(#{fnlItmGdCd}, 'R', #{useQty}, 0) <![CDATA[<]]> 0
                                           THEN 0
                                           ELSE NVL(T1.MMT_STOC_R_GD_QTY, 0) - DECODE(#{fnlItmGdCd}, 'R', #{useQty}, 0)
                                       END
             <include refid="COMMON.updateSystemField"/>
         WHERE T1.WARE_NO = (CASE #{rtngdProcsTpCd} WHEN '20' THEN '100010' WHEN '21' THEN '100004' ELSE '' END)
           AND T1.ITM_PD_CD = #{itmPdCd}
    </update>


    <select id="selectReturningGoodsStoresLoginWarehouse" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaReturningGoodsStoreDto$SearchWareRes">
        SELECT DISTINCT A.HGR_WARE_NO /* 창고번호 */
          FROM TB_SVST_MCBY_WARE_IZ A /*월별창고내역*/
         WHERE 1 = 1
           AND A.DTA_DL_YN          = 'N'
           AND A.WARE_DV_CD         = '2'
           AND A.WARE_USE_YN        = 'Y'
           AND A.WARE_DTL_DV_CD     = '21'
           AND A.WARE_MNGT_PRTNR_NO = #{prtnrNo}
        <choose>
        <when test="@MybatisUtils@isNotEmpty(strtDt) and @MybatisUtils@isNotEmpty(endDt)">
           AND A.APY_YM BETWEEN SUBSTR(#{strtDt}, 1, 6) AND SUBSTR(#{endDt}, 1, 6)
        </when>
        <otherwise>
           AND A.APY_YM             = TO_CHAR(SYSDATE, 'YYYYMM')
        </otherwise>
        </choose>
           AND ROWNUM               = 1
    </select>



</mapper>
