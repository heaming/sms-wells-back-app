<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaWarehouseOrganizationMapper">
    <insert id="insertWareCarried">
        INSERT INTO TB_SVST_MCBY_WARE_IZ ( /*월병창고내역*/
               APY_YM             /* 적용년월 */
             , WARE_NO            /* 창고번호 */
             , WARE_DV_CD         /* 창고구분코드 */
             , WARE_DTL_DV_CD     /* 창고상세구분코드 */
             , WARE_LOCARA_CD     /* 창고지역코드 */
             , WARE_LOCARA_SN     /* 창고지역일련번호 */
             , HGR_WARE_NO        /* 상위창고번호 */
             , WARE_NM            /* 창고명 */
             , WARE_ICHR_NO       /* 창고담당번호 */
             , WARE_MNGT_PRTNR_NO /* 창고관리파트너번호 */
             , OG_TP_CD           /* 조직유형코드 */
             , OG_ID              /* 조직ID */
             , CO_CD              /* 회사코드 */
             , DIDY_DV_CD         /* 직배구분코드 */
             , SORT_DV_VAL        /* 정렬구분값 */
             , WARE_ADR_ID        /* 창고주소ID */
             , BLD_CD             /* 빌딩코드 */
             , WARE_USE_YN        /* 창고사용여부 */
             , ADR_USE_YN         /* 주소사용여부 */
             , STD_WARE_USE_YN    /* 표준창고사용여부 */
             , AUTO_APLC_EXCD_YN  /* 자동신청제외여부 */
             , APY_STRTDT         /* 적용시작일자 */
             , APY_ENDDT          /* 적용종료일자 */
             , RMK_CN             /* 비고내용 */
             , DTA_DL_YN          /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField"/>
        )
        SELECT TO_CHAR(ADD_MONTHS(TO_DATE(APY_YM,'YYYYMM'),1),'YYYYMM')
             , WARE_NO
             , WARE_DV_CD
             , WARE_DTL_DV_CD
             , WARE_LOCARA_CD
             , WARE_LOCARA_SN
             , HGR_WARE_NO
             , WARE_NM
             , WARE_ICHR_NO
             , WARE_MNGT_PRTNR_NO
             , OG_TP_CD           /* 조직유형코드 */
             , OG_ID              /* 조직ID */
             , CO_CD
             , DIDY_DV_CD
             , SORT_DV_VAL
             , WARE_ADR_ID
             , BLD_CD
             , WARE_USE_YN
             , ADR_USE_YN
             , STD_WARE_USE_YN
             , AUTO_APLC_EXCD_YN
             , APY_STRTDT
             , APY_ENDDT
             , RMK_CN             /* 비고내용 */
             , DTA_DL_YN          /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemFieldValue"/>
         FROM TB_SVST_MCBY_WARE_IZ
        WHERE APY_YM=TO_CHAR(TO_DATE(#{baseYm},'YYYYMM'),'YYYYMM')

    </insert>

    <select id="selectWarehouseOgs"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaWarehouseOrganizationDto$SearchRes">
        SELECT B.APY_YM AS APY_YM       /* 적용년월 */
             , B.WARE_DV_CD AS WARE_DV_CD    /* 창고구분코드 */
             , B.WARE_DV_CD ||B.WARE_LOCARA_CD||B.WARE_ICHR_NO AS WARE_CD /*창고코드*/
             , A.WARE_DV_CD ||A.WARE_LOCARA_CD||A.WARE_ICHR_NO AS HGR_WARE /*상위창고코드*/
             , B.WARE_DTL_DV_CD AS WARE_DTL_DV_CD /*창고상세구분코드*/
             , B.WARE_LOCARA_CD AS WARE_LOCARA_CD /*창고지역코드*/
             , B.WARE_LOCARA_SN AS WARE_LOCARA_SN /*창고지역순번*/
             , B.HGR_WARE_NO AS HGR_WARE_NO /*상위창고번호*/
             , A.WARE_NM AS HGR_WARE_NM /*상위창고명*/
             , B.WARE_NO AS WARE_NO /*창고번호*/
             , B.WARE_NM AS WARE_NM /*창고명*/
             , B.WARE_MNGT_PRTNR_NO AS WARE_MNGT_PRTNR_NO /*파트너번호*/
             , B.DIDY_DV_CD AS DIDY_DV_CD /*직배구분코드*/
             , B.WARE_ADR_ID AS WARE_ADR_ID /*창고주소*/
             , B.WARE_USE_YN AS WARE_USE_YN /*창고사용여부*/
             , B.ADR_USE_YN AS ADR_USE_YN /*지정주소사용여부*/
             , C.RNADR || ' ' || C.RDADR AS ADR_NM
             , (SELECT A.BLD_NM
              	  FROM TB_OGBS_BLD_BAS A
              	 WHERE A.BLD_CD = B.BLD_CD) AS DSN_BLD_NM /*지정빌딩명*/
             , ( SELECT PRTNR_KNM
                   FROM TB_OGBS_MM_PRTNR_IZ A
                  WHERE A.PRTNR_NO = B.WARE_MNGT_PRTNR_NO
                    AND A.BASE_YM = B.APY_YM
                    AND A.OG_TP_CD IN ('W02', 'W06')
                    AND ROWNUM = 1) AS WARE_STOC_MGR /*파트너담당자명*/
             , (SELECT A.BLD_NM
                  FROM TB_OGBS_MM_OG_IZ A
                     , TB_OGBS_MM_PRTNR_IZ C
                 WHERE A.OG_ID = C.OG_ID
                   AND A.BASE_YM = C.BASE_YM
                   AND C.OG_TP_CD IN ('W02','W06')
                   AND C.PRTNR_NO = B.WARE_MNGT_PRTNR_NO
                   AND C.BASE_YM = B.APY_YM ) AS BLD_NM /*빌딩명*/
<!--             , C.RNADR AS RNADR /*도로명주소*/ -->
<!--             , C.RDADR AS RDADR /*도로명상세주소*/ -->
          FROM TB_SVST_MCBY_WARE_IZ B
          LEFT OUTER JOIN TB_SVST_MCBY_WARE_IZ A
            ON B.HGR_WARE_NO = A.WARE_NO
           AND B.APY_YM = A.APY_YM
          LEFT OUTER JOIN TB_GBCO_ADR_BAS C
            ON C.ADR_ID = B.WARE_ADR_ID
<!--          INNER JOIN TB_GBCO_ADR_BAS C
            ON C.ADR_ID = B.WARE_ADR_ID -->
         WHERE 1 = 1
           AND B.APY_YM = #{baseYm}
         <if test="@MybatisUtils@isNotEmpty(wareDtlDvCd)">
           AND B.WARE_DTL_DV_CD = #{wareDtlDvCd}
         </if>
         <if test="@MybatisUtils@isNotEmpty(wareMngtPrtnrNo)">
           AND B.WARE_MNGT_PRTNR_NO = #{wareMngtPrtnrNo}
         </if>
         <if test="@MybatisUtils@isNotEmpty(wareDvCd)">
           AND B.WARE_DV_CD = #{wareDvCd}
         </if>
         <if test="@MybatisUtils@isNotEmpty(wareNoM)">
           AND (B.HGR_WARE_NO = #{wareNoM} or B.WARE_NO = #{wareNoM})
         </if>
         <if test="@MybatisUtils@isNotEmpty(wareNoD)">
           AND B.WARE_NO = #{wareNoD}
         </if>
         <if test="@MybatisUtils@isNotEmpty(codeUseYn)">
           AND B.WARE_USE_YN = #{codeUseYn}
         </if>
            /*AND B.WARE_NO = '305821'*/
         ORDER BY B.WARE_DV_CD, B.HGR_WARE_NO, B.WARE_NM, B.WARE_LOCARA_CD, B.WARE_LOCARA_SN, B.WARE_DTL_DV_CD

    </select>
    <select id="selectWareCarriedCounter" resultType="integer">
        SELECT COUNT(WARE_LOCARA_CD || WARE_LOCARA_SN || WARE_ICHR_NO) AS CNT
          FROM TB_SVST_MCBY_WARE_IZ
         WHERE APY_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{baseYm}, 'YYYYMM'), 1), 'YYYYMM')
    </select>

    <select id="selectWarehouseByPk" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaWarehouseOrganizationDvo">
        SELECT T1.APY_YM /* 적용년월 */
             , T1.WARE_DV_CD /* 창고구분코드 */
             , T1.WARE_DTL_DV_CD /* 창고상세구분코드 */
             , T1.WARE_NO /* 창고번호 */
             , T2.PRTNR_NO /* 관리자번호 */
             , T2.PRTNR_KNM /* 관리자명 */
             , T1.WARE_NM /* 창고명 */
             , T1.HGR_WARE_NO /* 상위창고번호 */
             , (SELECT WARE_NM
                  FROM TB_SVST_MCBY_WARE_IZ
                 WHERE WARE_NO = T1.HGR_WARE_NO
                   AND APY_YM = T1.APY_YM
                   AND WARE_USE_YN = 'Y'
                   AND DTA_DL_YN = 'N') AS HGR_WARE_NM /* 상위창고명 */
             , T1.RMK_CN /* 비고내용 */
             , T1.WARE_USE_YN /* 창고사용여부 */
             , SUBSTR(T1.FST_RGST_DTM, 1, 8) AS FST_RGST_DT /* 최초등록일 */
             , T1.ADR_USE_YN /* 주소사용여부 */
             , T1.BLD_CD /* 빌딩코드 */
             , T1.WARE_ADR_ID
             , T4.RNADR
             , T4.RDADR
             , T4.NEW_ADR_ZIP
             , T3.OG_ID
             , T3.OG_CD
             , T3.OG_NM
             , T3.DGR1_LEVL_OG_CD
             , T3.DGR1_LEVL_OG_NM
             , (CASE WHEN T3.DGR1_LEVL_OG_CD IS NOT NULL THEN '[' || T3.DGR1_LEVL_OG_CD || '] ' || T3.DGR1_LEVL_OG_NM
                     ELSE ''
                END) AS DGR1_LEVL_OG_CD_NM
             , T3.DGR2_LEVL_OG_CD
             , T3.DGR2_LEVL_OG_NM
             , (CASE WHEN T3.DGR2_LEVL_OG_CD IS NOT NULL THEN '[' || T3.DGR2_LEVL_OG_CD || '] ' || T3.DGR2_LEVL_OG_NM
                     ELSE ''
                END) AS DGR2_LEVL_OG_CD_NM
          FROM TB_SVST_MCBY_WARE_IZ T1 /* 월별창고내역 */
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS T2 /* 파트너기본 */
            ON T2.OG_TP_CD = T1.OG_TP_CD
           AND T2.PRTNR_NO = T1.WARE_MNGT_PRTNR_NO
           AND T2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_OGBS_MM_OG_IZ T3 /* 월조직내역 */
              ON T3.BASE_YM = T1.APY_YM
             AND T3.OG_ID = T1.OG_ID
             AND T3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_GBCO_ADR_BAS T4 /* 주소기본 */
            ON T4.ADR_ID = T1.WARE_ADR_ID
           AND T4.DTA_DL_YN = 'N'
         WHERE T1.APY_YM = SUBSTR(#{apyYmWareNo}, 1, 6)
           AND T1.WARE_NO = SUBSTR(#{apyYmWareNo}, 7)
           AND T1.DTA_DL_YN = 'N'
    </select>

    <select id="selectWarehouseOgPartner" resultType="java.lang.Integer">
        SELECT COUNT(T1.WARE_NO)
          FROM TB_SVST_MCBY_WARE_IZ T1 /* 월별창고내역 */
         WHERE 1 = 1
           AND T1.APY_YM = #{apyYm}
       <if test='@MybatisUtils@isNotEmpty(wareNo)'>
           AND T1.WARE_NO != #{wareNo}
       </if>
       <choose>
           <when test='@MybatisUtils@equals(wareDtlDvCd, "20") or @MybatisUtils@equals(wareDtlDvCd, "30")'>
           AND T1.WARE_DTL_DV_CD IN ('20', '30') /* 조직창고인 경우 */
           AND T1.WARE_ICHR_NO = '000' /* TODO: 추후 컬럼 삭제 예정 */
           </when>
           <otherwise>
           AND T1.WARE_DTL_DV_CD IN ('21', '31', '32') /* 조직창고가 아닌 경우 */
           AND T1.WARE_ICHR_NO != '000' /* TODO: 추후 컬럼 삭제 예정 */
           </otherwise>
       </choose>
           AND T1.WARE_USE_YN = 'Y'
           AND TRIM(T1.WARE_MNGT_PRTNR_NO) = TRIM(#{prtnrNo})
    </select>

    <insert id="insertWarehouseOg">
        INSERT INTO TB_SVST_MCBY_WARE_IZ (  /* 월별창고내역 */
              APY_YM             /* 적용년월 */
            , WARE_NO            /* 창고번호 */
            , WARE_DV_CD         /* 창고구분코드 */
            , WARE_DTL_DV_CD     /* 창고상세구분코드 */
            , HGR_WARE_NO        /* 상위창고번호 */
            , WARE_NM            /* 창고명 */
            , WARE_ICHR_NO       /* 창고담당번호 */
            , WARE_MNGT_PRTNR_NO /* 창고관리파트너번호 */
            , OG_TP_CD           /* 조직유형코드 */
            , OG_ID              /* 조직ID */
            , DIDY_DV_CD         /* 직배구분코드 */
            , WARE_ADR_ID        /* 창고주소ID */
            , BLD_CD             /* 빌딩코드 */
            , WARE_USE_YN        /* 창고사용여부 */
            , ADR_USE_YN         /* 주소사용여부 */
            , APY_STRTDT         /* 적용시작일자 */
            , APY_ENDDT          /* 적용종료일자 */
            , RMK_CN             /* 비고내용 */
            , DTA_DL_YN          /* 데이터삭제여부 */
            <include refid="COMMON.insertSystemField" />)
        SELECT #{apyYm}
            , (SELECT #{wareDvCd} || LPAD(NVL(TO_NUMBER(MAX(SUBSTR(WARE_NO, 2))), 0) + 1, 5, '0')
                 FROM TB_SVST_MCBY_WARE_IZ
                WHERE APY_YM = #{apyYm}
                  AND WARE_DV_CD = #{wareDvCd})
            , #{wareDvCd}
            , #{wareDtlDvCd}
            , #{hgrWareNo}
            , #{wareNm}
            , (CASE WHEN #{wareDtlDvCd} IN ('20', '30') THEN '000' ELSE '010' END) /* 창고담당번호 */
            , #{prtnrNo}
            , #{ogTpCd}
            , #{ogId}
            , (CASE WHEN #{wareDtlDvCd} = '32' THEN '2' ELSE '1' END) /* 직배구분코드 */
            , #{wareAdrId}
            , (CASE WHEN #{adrUseYn} = 'Y' THEN #{bldCd} ELSE NULL END) /* 빌딩코드 */
            , 'Y'
            , #{adrUseYn}
            , TO_CHAR(SYSDATE, 'YYYYMMDD')
            , '99991231'
            , #{rmkCn}
            , 'N'
            <include refid="COMMON.insertSystemFieldValue" />
         FROM DUAL
    </insert>

    <update id="updateWarehouseOg">
        UPDATE TB_SVST_MCBY_WARE_IZ /* 월별창고내역 */
           SET WARE_DTL_DV_CD = #{wareDtlDvCd}
             , WARE_ICHR_NO = (CASE WHEN #{wareDtlDvCd} IN ('20', '30') THEN '000' ELSE '010' END)
             , DIDY_DV_CD = (CASE WHEN #{wareDtlDvCd} = '32' THEN '2' ELSE '1' END)
             , WARE_ADR_ID = #{wareAdrId}
             , BLD_CD = (CASE WHEN #{adrUseYn} = 'Y' THEN #{bldCd} ELSE NULL END)
             , WARE_USE_YN = #{wareUseYn}
             , ADR_USE_YN = #{adrUseYn}
             , RMK_CN = #{rmkCn}
             , WARE_NM = #{wareNm}
            <include refid="COMMON.updateSystemField"/>
         WHERE 1 = 1
           AND APY_YM = #{apyYm}
           AND WARE_NO = #{wareNo}
    </update>

    <select id="selectIndvIndpWarehouses" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaWarehouseOrganizationDto$SearchWarehouseRes">
        SELECT DISTINCT
               V1.HGR_WARE_NO AS CODE_ID
             , V2.WARE_NM AS CODE_NAME
          FROM TB_SVST_MCBY_WARE_IZ V1 /* 월별창고내역 */
         INNER JOIN TB_SVST_MCBY_WARE_IZ V2 /* 월별창고내역 */
            ON V2.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND V2.WARE_NO = V1.HGR_WARE_NO
           AND V2.WARE_USE_YN = 'Y'
           AND V2.DTA_DL_YN = 'N'
         WHERE V1.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND V1.OG_ID = #{ogId}
           AND V1.WARE_DV_CD = #{wareDvCd}
           AND V1.WARE_DTL_DV_CD IN ('21', '31', '32')
           AND V1.WARE_USE_YN = 'Y'
           AND V1.DTA_DL_YN = 'N'
         ORDER BY CODE_ID
    </select>

    <select id="selectOrganizationWarehouses" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaWarehouseOrganizationDto$SearchWarehouseRes">
        SELECT DISTINCT
               V1.HGR_WARE_NO AS CODE_ID
             , V2.WARE_NM AS CODE_NAME
          FROM TB_SVST_MCBY_WARE_IZ V1 /* 월별창고내역 */
         INNER JOIN TB_SVST_MCBY_WARE_IZ V2 /* 월별창고내역 */
            ON V2.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND V2.WARE_NO = V1.HGR_WARE_NO
           AND V2.WARE_USE_YN = 'Y'
           AND V2.DTA_DL_YN = 'N'
         WHERE V1.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND V1.OG_ID = #{ogId}
           AND V1.WARE_DV_CD = #{wareDvCd}
           AND V1.WARE_DTL_DV_CD IN ('20', '30')
           AND V1.WARE_USE_YN = 'Y'
           AND V1.DTA_DL_YN = 'N'
         ORDER BY CODE_ID
    </select>

    <select id="selectLogisticsCenters" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaWarehouseOrganizationDto$SearchWarehouseRes">
        SELECT V1.WARE_NO AS CODE_ID
             , V1.WARE_NM AS CODE_NAME
          FROM TB_SVST_MCBY_WARE_IZ V1 /* 월별창고내역 */
         WHERE V1.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND V1.WARE_DV_CD = '1'
           AND V1.WARE_USE_YN = 'Y'
           AND V1.DTA_DL_YN = 'N'
         ORDER BY CODE_ID
    </select>

    <select id="selectBuildingInformations" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaWarehouseOrganizationDto$SearchBuildingRes">
        SELECT DISTINCT T2.BLD_CD
             , T2.BLD_NM
             , T2.BLD_NM || '(' || T2.BLD_CD || ')' AS BLD_CD_NM
             , T3.RNADR || ' ' || T3.RDADR AS BLD_ADR
             , T3.RNADR
             , T3.RDADR
             , T3.NEW_ADR_ZIP
             , T2.ADR_ID
          FROM TB_OGBS_MM_OG_IZ T1
         INNER JOIN TB_OGBS_BLD_BAS T2
            ON T1.OG_TP_CD = T2.OG_TP_CD
           AND T1.BLD_CD = T2.BLD_CD
         LEFT OUTER JOIN TB_GBCO_ADR_BAS T3
           ON T3.ADR_ID = T2.ADR_ID
         WHERE T1.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND T2.DTA_DL_YN = 'N'
           AND T1.DTA_DL_YN = 'N'
           AND T2.OG_TP_CD IN ('W02', 'ALC')
         <if test='@MybatisUtils@isNotEmpty(dgr1LevlOgId)'>
           AND T1.DGR1_LEVL_OG_ID = #{dgr1LevlOgId}
         </if>
         <if test='@MybatisUtils@isNotEmpty(dgr2LevlOgId)'>
           AND T1.DGR2_LEVL_OG_ID = #{dgr2LevlOgId}
         </if>
         ORDER BY T2.BLD_CD

    </select>

</mapper>
