<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaItemByStockAggregationMapper">

    <select id="selectItemByStockWareHouses" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaItemByStockAggregationDto$SearchWareRes">
        SELECT WARE_DTL_DV_CD
             , WARE_NO
             , WARE_NM
          FROM TB_SVST_MCBY_WARE_IZ
         WHERE DTA_DL_YN       = 'N'
           AND WARE_USE_YN     = 'Y'
           AND WARE_DTL_DV_CD IN ('20', '30')
           AND APY_YM          = SUBSTR(#{baseDt}, 1, 6)
         ORDER BY WARE_DTL_DV_CD, SORT_DV_VAL, WARE_NO
    </select>

    <select id="selectItemByStockAggCount" resultType="java.lang.Long">
        SELECT COUNT(*)
          FROM
             (
               SELECT D1.SAP_MAT_CD
                    , D1.PD_CD
                    , D1.PD_NM
                    , D2.PD_PRP_VAL06 AS LEAD_TIME
                    , D2.PD_PRP_VAL07 AS MOQ
                 FROM TB_PDBS_PD_BAS D1                 /* 상품기본 */
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D2   /* 상품각사속성상세 */
                   ON D2.PD_CD = D1.PD_CD
                WHERE D1.DTA_DL_YN          = 'N'
                  AND D1.PD_TP_CD           = 'M'
                  AND D2.DTA_DL_YN          = 'N'
                  AND D2.PD_EXTS_PRP_GRP_CD = 'PART'
                <if test="@MybatisUtils@isNotEmpty(mgtTypCd)">
                  AND D2.PD_PRP_VAL02       = #{mgtTypCd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
                  AND D2.PD_PRP_VAL19       = #{itmKndCd}
                </if>
                <if test='@MybatisUtils@equals(useYn, "Y")'>
                  AND #{baseDt} BETWEEN NVL(D1.RVPY_STRTDT, '19000101') AND NVL(D1.RVPY_ENDDT, '99991231')
                </if>
                <if test='@MybatisUtils@equals(useYn, "N")'>
                  AND #{baseDt} NOT BETWEEN NVL(D1.RVPY_STRTDT, '19000101') AND NVL(D1.RVPY_ENDDT, '99991231')
                </if>
                <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PD_CD IN
                                <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                   #{itmPdCd}
                                </foreach>
                </if>
                <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PD_CD              = #{itmPdCd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(strtSapCd)">
                  AND D1.SAP_MAT_CD <![CDATA[>=]]> LPAD(#{strtSapCd}, 18, '0')
                </if>
                <if test="@MybatisUtils@isNotEmpty(endSapCd)">
                  AND D1.SAP_MAT_CD <![CDATA[<=]]>  LPAD(#{endSapCd}, 18, '0')
                </if>
                <if test="@MybatisUtils@isNotEmpty(strtSapCd) or @MybatisUtils@isNotEmpty(endSapCd)">
                  AND D1.SAP_MAT_CD IS NOT NULL
                </if>
                <if test="@MybatisUtils@isNotEmpty(matUtlzDvCd)">
                  AND D2.PD_PRP_VAL21       = #{matUtlzDvCd}
                </if>
             ) T1
    </select>

    <select id="selectItemByStockAggs" resultType="camelMap">
          WITH TB_QTY AS
             (
               SELECT D1.ITM_PD_CD
                    , D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END        AS WARE_NO
                    , SUM( CASE #{itmGdCd} WHEN 'A' THEN D1.PITM_STOC_A_GD_QTY
                                           WHEN 'B' THEN D1.PITM_STOC_B_GD_QTY
                                           WHEN 'E' THEN D1.PITM_STOC_E_GD_QTY
                                           WHEN 'R' THEN D1.PITM_STOC_R_GD_QTY
                                           ELSE NVL(D1.PITM_STOC_A_GD_QTY, 0) + NVL(D1.PITM_STOC_B_GD_QTY, 0) + NVL(D1.PITM_STOC_E_GD_QTY, 0) + NVL(D1.PITM_STOC_R_GD_QTY, 0)
                           END ) AS QTY   /* 기초재고수량 */
                 FROM TB_SVST_MCITM_STOC_IZ D1       /* 월별품목재고내역 */
                INNER JOIN TB_SVST_MCBY_WARE_IZ D2   /* 월별창고내역 */
                   ON D2.APY_YM  = D1.BASE_YM
                  AND D2.WARE_NO = D1.WARE_NO
                WHERE D1.DTA_DL_YN = 'N'
                  AND D2.DTA_DL_YN = 'N'
                  AND D1.BASE_YM   = TO_CHAR(ADD_MONTHS( TO_DATE(#{baseDt}, 'YYYYMMDD'), -1 ), 'YYYYMM')
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.ITM_PD_CD IN
                                  <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                       #{itmPdCd}
                                  </foreach>
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.ITM_PD_CD = #{itmPdCd}
            </if>
                GROUP BY D1.ITM_PD_CD, D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END
                UNION ALL
               SELECT D1.ITM_PD_CD
                    , D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END        AS WARE_NO
                    , SUM( CASE #{itmGdCd} WHEN 'A' THEN NVL(D1.STOC_ACINSP_STR_A_GD_QTY, 0) - NVL(D1.STOC_ACINSP_OSTR_A_GD_QTY, 0)
                                           WHEN 'B' THEN NVL(D1.STOC_ACINSP_STR_B_GD_QTY, 0) - NVL(D1.STOC_ACINSP_OSTR_B_GD_QTY, 0)
                                           WHEN 'E' THEN NVL(D1.STOC_ACINSP_STR_E_GD_QTY, 0) - NVL(D1.STOC_ACINSP_OSTR_E_GD_QTY, 0)
                                           WHEN 'R' THEN NVL(D1.STOC_ACINSP_STR_R_GD_QTY, 0) - NVL(D1.STOC_ACINSP_OSTR_R_GD_QTY, 0)
                                           ELSE ( NVL(D1.STOC_ACINSP_STR_A_GD_QTY, 0) + NVL(D1.STOC_ACINSP_STR_B_GD_QTY, 0) + NVL(D1.STOC_ACINSP_STR_E_GD_QTY, 0) + NVL(D1.STOC_ACINSP_STR_R_GD_QTY, 0) )
                                                  - ( NVL(D1.STOC_ACINSP_OSTR_A_GD_QTY, 0) + NVL(D1.STOC_ACINSP_OSTR_B_GD_QTY, 0) + NVL(D1.STOC_ACINSP_OSTR_E_GD_QTY, 0) + NVL(D1.STOC_ACINSP_OSTR_R_GD_QTY, 0) )
                           END ) AS QTY   /* 재고실사수량 */
                 FROM TB_SVST_MCITM_STOC_IZ D1       /* 월별품목재고내역 */
                INNER JOIN TB_SVST_MCBY_WARE_IZ D2   /* 월별창고내역 */
                   ON D2.APY_YM  = D1.BASE_YM
                  AND D2.WARE_NO = D1.WARE_NO
                WHERE D1.DTA_DL_YN = 'N'
                  AND D2.DTA_DL_YN = 'N'
                  AND D1.BASE_YM   = SUBSTR(#{baseDt}, 1, 6)
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.ITM_PD_CD IN
                                <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                       #{itmPdCd}
                                </foreach>
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.ITM_PD_CD = #{itmPdCd}
            </if>
                GROUP BY D1.ITM_PD_CD, D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END
                UNION ALL
               SELECT D1.ITM_PD_CD
                    , D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.STR_WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END             AS WARE_NO
                    , SUM(D1.STR_QTY) AS QTY   /* 입고수량 */
                 FROM TB_SVST_ITM_STR_IZ D1          /* 품목입고내역 */
                INNER JOIN TB_SVST_MCBY_WARE_IZ D2   /* 월별창고내역 */
                   ON D2.WARE_NO = D1.STR_WARE_NO
                WHERE D1.DTA_DL_YN = 'N'
                  AND D2.DTA_DL_YN = 'N'
                  AND D2.APY_YM    = SUBSTR(#{baseDt}, 1, 6)
                  AND D1.STR_RGST_DT BETWEEN SUBSTR(#{baseDt}, 1, 6) || '01' AND #{baseDt}
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.ITM_PD_CD IN
                                <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                       #{itmPdCd}
                                </foreach>
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.ITM_PD_CD = #{itmPdCd}
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                  AND D1.ITM_GD_CD = #{itmGdCd}
            </if>
                GROUP BY D1.ITM_PD_CD, D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.STR_WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END
                UNION ALL
               SELECT /*+ INDEX(D1 IX_SVST_SV_WK_OSTR_IZ_01) */
                      D1.ITM_PD_CD
                    , D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.WK_WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END        AS WARE_NO
                    , SUM( CASE WHEN D1.SV_BIZ_HCLSF_CD = '6' THEN D1.USE_QTY
                                ELSE D1.USE_QTY * -1
                           END ) AS QTY   /* 작업수량 */
                 FROM TB_SVST_SV_WK_OSTR_IZ D1       /* 서비스작업출고내역 */
                INNER JOIN TB_SVST_MCBY_WARE_IZ D2   /* 월별창고내역 */
                   ON D2.WARE_NO = D1.WK_WARE_NO
                WHERE D1.DTA_DL_YN       = 'N'
                  AND D1.SV_BIZ_HCLSF_CD IN ('1', '2', '3', '4', '6')
                  AND D1.FNL_ITM_GD_CD <![CDATA[<>]]> 'X'
                  AND D2.DTA_DL_YN       = 'N'
                  AND D2.APY_YM          = SUBSTR(#{baseDt}, 1, 6)
                  AND D1.FNL_VST_FSH_DT BETWEEN SUBSTR(#{baseDt}, 1, 6) || '01' AND #{baseDt}
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.ITM_PD_CD IN
                                <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                       #{itmPdCd}
                                </foreach>
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.ITM_PD_CD       = #{itmPdCd}
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                  AND D1.FNL_ITM_GD_CD   = #{itmGdCd}
            </if>
                GROUP BY D1.ITM_PD_CD, D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.WK_WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END
                UNION ALL
               SELECT D1.PD_CD        AS ITM_PD_CD
                    , D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END             AS WARE_NO
                    , SUM(D1.CTR_QTY) AS QTY   /* 등급조정수량 */
                 FROM TB_SVST_ITM_GD_CTR_IZ D1       /* 품목등급조정내역 */
                INNER JOIN TB_SVST_MCBY_WARE_IZ D2   /* 월별창고내역 */
                   ON D2.WARE_NO = D1.WARE_NO
                WHERE D1.DTA_DL_YN      = 'N'
                  AND D2.DTA_DL_YN      = 'N'
                  AND D2.APY_YM         = SUBSTR(#{baseDt}, 1, 6)
                  AND D1.STAT_CTR_APY_DT BETWEEN SUBSTR(#{baseDt}, 1, 6) || '01' AND #{baseDt}
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PD_CD IN
                                <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                   #{itmPdCd}
                                </foreach>
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PD_CD          = #{itmPdCd}
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                  AND D1.AFCT_ITM_GD_CD = #{itmGdCd}
            </if>
                GROUP BY D1.PD_CD, D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END
                UNION ALL
               SELECT D1.ITM_PD_CD
                    , D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.OSTR_WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END              AS WARE_NO
                    , SUM(D1.OSTR_QTY) AS QTY   /* 출고수량 */
                 FROM TB_SVST_ITM_OSTR_IZ D1   /* 품목출고내역 */
                INNER JOIN TB_SVST_MCBY_WARE_IZ D2   /* 월별창고내역 */
                   ON D2.WARE_NO = D1.OSTR_WARE_NO
                WHERE D1.DTA_DL_YN = 'N'
                  AND D1.ITM_GD_CD <![CDATA[<>]]> 'X'
                  AND D2.DTA_DL_YN = 'N'
                  AND D2.APY_YM    = SUBSTR(#{baseDt}, 1, 6)
                  AND D1.OSTR_DT BETWEEN SUBSTR(#{baseDt}, 1, 6) || '01' AND #{baseDt}
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.ITM_PD_CD IN
                                    <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                       #{itmPdCd}
                                    </foreach>
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.ITM_PD_CD = #{itmPdCd}
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                  AND D1.ITM_GD_CD = #{itmGdCd}
            </if>
                GROUP BY D1.ITM_PD_CD, D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.OSTR_WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END
                UNION ALL
               SELECT D1.PD_CD             AS ITM_PD_CD
                    , D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END                  AS WARE_NO
                    , SUM(D1.CTR_QTY) * -1 AS QTY   /* 등급조정수량 */
                 FROM TB_SVST_ITM_GD_CTR_IZ D1       /* 품목등급조정내역 */
                INNER JOIN TB_SVST_MCBY_WARE_IZ D2   /* 월별창고내역 */
                   ON D2.WARE_NO = D1.WARE_NO
                WHERE D1.DTA_DL_YN      = 'N'
                  AND D2.DTA_DL_YN      = 'N'
                  AND D2.APY_YM         = SUBSTR(#{baseDt}, 1, 6)
                  AND D1.STAT_CTR_APY_DT BETWEEN SUBSTR(#{baseDt}, 1, 6) || '01' AND #{baseDt}
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PD_CD IN
                                <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                   #{itmPdCd}
                                </foreach>
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PD_CD          = #{itmPdCd}
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                  AND D1.BFCT_ITM_GD_CD = #{itmGdCd}
            </if>
                GROUP BY D1.PD_CD, D2.WARE_DTL_DV_CD
                    , CASE WHEN D2.WARE_DTL_DV_CD IN ('10', '20', '30') THEN D1.WARE_NO
                           ELSE D2.HGR_WARE_NO
                      END
             )
        SELECT T1.SAP_MAT_CD     /* SAP코드 */
             , T1.PD_CD          /* 품목코드 */
             , T1.PD_NM          /* 품목명 */
             , T1.CSMR_UPRC_AMT  /* 소비자가 */
             , T1.LEAD_TIME      /* L/T */
             , T1.MOQ            /* MOQ */
             , T1.QTY_100002     /* 파주물류센터 */
             , T1.QTY_100008     /* 성수물류센터 */
             , T1.QTY_200000     /* 서비스센터 */
             , T1.QTY_299999     /* 엔지니어 */
             , T1.QTY_300000     /* 영업센터 */
             , T1.QTY_999999     /* 재고현황 계 */
             , ${wareNoFields}   /* PIVOT 필드 */
          FROM
             (
               SELECT D1.SAP_MAT_CD
                    , D1.PD_CD
                    , D1.PD_NM
                    , D2.PD_PRP_VAL06                                                AS LEAD_TIME
                    , D2.PD_PRP_VAL07                                                AS MOQ
                    , NVL( ( SELECT CSMR_UPRC_AMT
                               FROM TB_SVPD_RCAS_ITM_PRC_IZ
                              WHERE USE_MAT_PD_CD = D1.PD_CD
                                AND DTA_DL_YN = 'N'
                                AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN APY_STRTDT AND APY_ENDDT
                                AND ROWNUM    = 1 ), 0 )                             AS CSMR_UPRC_AMT
                    , SUM(CASE WHEN D3.WARE_NO = '100002' THEN D3.QTY ELSE 0 END)    AS QTY_100002   /* 파주물류센터 */
                    , SUM(CASE WHEN D3.WARE_NO = '100008'
                                AND #{itmKndCd} IN ('5', '6') THEN D3.QTY
                               ELSE 0
                          END)                                                       AS QTY_100008   /* 성수물류센터 */
                    , SUM(CASE WHEN D3.WARE_DTL_DV_CD = '20' THEN D3.QTY ELSE 0 END) AS QTY_200000   /* 서비스센터 */
                    , SUM(CASE WHEN D3.WARE_DTL_DV_CD = '21' THEN D3.QTY ELSE 0 END) AS QTY_299999   /* 엔지니어 */
                    , SUM(CASE WHEN D3.WARE_DTL_DV_CD = '30' THEN D3.QTY ELSE 0 END) AS QTY_300000   /* 영업센터 */
                    , SUM(CASE WHEN D3.WARE_NO IN ('100002', '100003')
                                 OR D3.WARE_DTL_DV_CD IN ('20', '21', '30', '31', '32')
                                 OR ( D3.WARE_NO = '100008' AND #{itmKndCd} IN ('5', '6') ) THEN D3.QTY
                               ELSE 0
                          END)                                                       AS QTY_999999   /* 재고현황 계 */
                 FROM TB_PDBS_PD_BAS D1                 /* 상품기본 */
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D2   /* 상품각사속성상세 */
                   ON D2.PD_CD = D1.PD_CD
                 LEFT OUTER JOIN TB_QTY D3              /* WITH절 재고수량 */
                   ON D3.ITM_PD_CD = D1.PD_CD
                WHERE D1.DTA_DL_YN          = 'N'
                  AND D1.PD_TP_CD           = 'M'
                  AND D2.DTA_DL_YN          = 'N'
                  AND D2.PD_EXTS_PRP_GRP_CD = 'PART'
                <if test="@MybatisUtils@isNotEmpty(mgtTypCd)">
                  AND D2.PD_PRP_VAL02       = #{mgtTypCd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
                  AND D2.PD_PRP_VAL19       = #{itmKndCd}
                </if>
                <if test='@MybatisUtils@equals(useYn, "Y")'>
                  AND #{baseYm} || '01' BETWEEN NVL(D1.RVPY_STRTDT, '19000101') AND NVL(D1.RVPY_ENDDT, '99991231')
                </if>
                <if test='@MybatisUtils@equals(useYn, "N")'>
                  AND #{baseYm} || '01' NOT BETWEEN NVL(D1.RVPY_STRTDT, '19000101') AND NVL(D1.RVPY_ENDDT, '99991231')
                </if>
                <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PD_CD IN
                                <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                   #{itmPdCd}
                                </foreach>
                </if>
                <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PD_CD              = #{itmPdCd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(strtSapCd)">
                  AND D1.SAP_MAT_CD <![CDATA[>=]]> LPAD(#{strtSapCd}, 18, '0')
                </if>
                <if test="@MybatisUtils@isNotEmpty(endSapCd)">
                  AND D1.SAP_MAT_CD <![CDATA[<=]]> LPAD(#{endSapCd}, 18, '0')
                </if>
                <if test="@MybatisUtils@isNotEmpty(strtSapCd) or @MybatisUtils@isNotEmpty(endSapCd)">
                  AND D1.SAP_MAT_CD IS NOT NULL
                </if>
                <if test="@MybatisUtils@isNotEmpty(matUtlzDvCd)">
                  AND D2.PD_PRP_VAL21       = #{matUtlzDvCd}
                </if>
                GROUP BY D1.SAP_MAT_CD, D1.PD_CD, D1.PD_NM, D2.PD_PRP_VAL06, D2.PD_PRP_VAL07
             ) T1
          LEFT OUTER JOIN
             (
               SELECT *
                 FROM
                    (
                      SELECT ITM_PD_CD
                           , WARE_NO
                           , QTY
                        FROM TB_QTY
                <where>
                <choose>
                    <when test='@MybatisUtils@equals(wareTpCd, "CORP")'>
                         AND WARE_DTL_DV_CD IN ('20', '30')
                    </when>
                    <when test='@MybatisUtils@equals(wareTpCd, "INDI")'>
                         AND WARE_DTL_DV_CD IN ('21', '31', '32')
                    </when>
                    <otherwise>
                         AND WARE_DTL_DV_CD <![CDATA[<>]]> '10'
                    </otherwise>
                </choose>
                </where>
                    ) T1
                PIVOT
                    (
                          SUM(QTY)
                      FOR WARE_NO IN (${wareNoInStr})
                    )
             ) T2
            ON T2.ITM_PD_CD = T1.PD_CD
         ORDER BY T1.PD_CD
    <if test="@MybatisUtils@isNotEmpty(offSet) and @MybatisUtils@isNotEmpty(size)">
        OFFSET ${offSet} ROW FETCH NEXT ${size} ROW ONLY
    </if>
    </select>


</mapper>
