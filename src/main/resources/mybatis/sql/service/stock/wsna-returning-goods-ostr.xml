<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaReturningGoodsOstrMapper">

    <select id="selectWareHouses" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaReturningGoodsOstrDto$SearchWarehouseRes">
        SELECT T1.WARE_NO AS CODE_ID
             , T1.WARE_NM AS CODE_NAME
             , T1.WARE_MNGT_PRTNR_NO
             , T1.WARE_ICHR_NO
             , T1.WARE_DV_CD
             , T1.WARE_DTL_DV_CD /* 창고상세구분코드 (10: 물류센터) */
             , T2.WARE_NO AS CODE_ID_UP
             , T2.WARE_NM AS CODE_NAME_UP
             , T2.WARE_MNGT_PRTNR_NO AS WARE_MNGT_PRTNR_NO_UP
             , T2.WARE_LOCARA_CD AS WARE_LOCARA_CD_UP
             , T2.WARE_DV_CD AS WARE_DV_CD_UP
             , T2.WARE_DTL_DV_CD AS WARE_DTL_DV_CD_UP /* 상위창고상세구분코드 (10: 물류센터) */
          FROM TB_SVST_MCBY_WARE_IZ T1 /* 월별창고내역 */
         INNER JOIN TB_SVST_MCBY_WARE_IZ T2 /* 월별창고내역 */
            ON T2.APY_YM = T1.APY_YM
           AND T2.WARE_NO = T1.HGR_WARE_NO
         WHERE 1 = 1
           AND T1.DTA_DL_YN = 'N'
           AND T2.DTA_DL_YN = 'N'
           AND T1.WARE_MNGT_PRTNR_NO = #{userId}
           AND T1.APY_YM = #{apyYm}
           AND T1.WARE_USE_YN = 'Y'
           AND T2.WARE_USE_YN = 'Y'
         ORDER BY WARE_DV_CD_UP
    </select>

    <select id="selectItemOutOfStorage" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaReturningGoodsOstrDto$ItemOutOfStorage">
        SELECT T1.ITM_OSTR_NO /* 품목출고번호 */
             , T1.OSTR_WARE_NO /* 출고창고번호 */
             , O1.WARE_NM AS OSTR_WARE_NM /* 출고창고명 */
             , O1.WARE_MNGT_PRTNR_NO AS WARE_MNGT_PRTNR_NO /* 출고창고관리파트너번호 */
             , O1.WARE_DV_CD /* 출고창고구분코드 */
             , T1.OSTR_TP_CD /* 출고유형코드 */
             , T1.ITM_GD_CD /* 품목등급코드 */
             , T1.OSTR_DT /* 출고일자 */
             , T1.OSTR_SN /* 출고일련번호 */
             , T1.OSTR_RSON_CD /* 출고사유코드 */
             , SUBSTR(T1.OSTR_AK_NO, 4, 6) AS OSTR_REQ_WARE_NO /* 출고요청창고번호 */
             , T1.ACB_DT /* 회계일자 */
             , T1.EVID_DV_CD /* 증빙구분코드 */
             , I1.WARE_NM AS STR_WARE_NM /* 입고창고명 */
             , I1.WARE_MNGT_PRTNR_NO AS STR_WARE_MNGT_PRTNR_NO /* 입고창고관리파트너번호 */
             , T1.STR_TP_CD /* 입고유형코드 */
             , I1.WARE_DV_CD AS STR_WARE_DV_CD /* 입고창고구분코드 */
          FROM TB_SVST_ITM_OSTR_IZ T1 /* 품목출고내역 */
         INNER JOIN TB_SVST_MCBY_WARE_IZ O1 /* 월별창고내역 - 출고 */
            ON O1.WARE_NO = T1.OSTR_WARE_NO
           AND O1.APY_YM = SUBSTR(T1.OSTR_DT, 1, 6)
          LEFT OUTER JOIN TB_SVST_MCBY_WARE_IZ I1 /* 월별창고내역 - 입고 */
            ON I1.WARE_NO = T1.STR_WARE_NO
           AND I1.APY_YM = SUBSTR(T1.OSTR_AK_NO, 4, 6)
         WHERE 1 = 1
           AND T1.DTA_DL_YN = 'N'
           AND O1.DTA_DL_YN = 'N'
           AND I1.DTA_DL_YN = 'N'
           AND O1.WARE_USE_YN = 'Y'
           AND I1.WARE_USE_YN = 'Y'
           AND T1.ITM_OSTR_NO = #{itmOstrNo}
           AND ROWNUM = 1
    </select>

    <select id="selectReturningGoodsOstrs" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaReturningGoodsDvo">
        SELECT T1.ITM_OSTR_NO /* 품목출고번호 */
             , T1.OSTR_SN /* 출고일련번호 */
             , T1.ITM_KND_CD /* 품목종류코드 */
             , T1.ITM_PD_CD /* 품목상품코드 */
             , T1.ITM_CD /* 품목코드 */
             , '품목명' AS ITM_NM /* 품목명 */
             , T1.ITM_GD_CD /* 품목등급코드 */
             , T1.ACB_DT /* 회계일자 */
             , T1.EVID_DV_CD /* 증빙구분코드 */
             , T1.STR_TP_CD /* 입고유형코드 */
             , (SELECT ((CASE T1.ITM_GD_CD WHEN 'A' THEN PITM_STOC_A_GD_QTY
                                           WHEN 'B' THEN PITM_STOC_B_GD_QTY
                                           WHEN 'E' THEN PITM_STOC_E_GD_QTY
                                           WHEN 'R' THEN PITM_STOC_R_GD_QTY
                                           ELSE 0
                         END)
                         -
                        (CASE T1.ITM_GD_CD WHEN 'A' THEN MMT_STOC_A_GD_QTY
                                           WHEN 'B' THEN MMT_STOC_B_GD_QTY
                                           WHEN 'E' THEN MMT_STOC_E_GD_QTY
                                           WHEN 'R' THEN MMT_STOC_R_GD_QTY
                                           ELSE 0
                        END))
                  FROM TB_SVST_CST_SV_ITM_STOC_IZ
                 WHERE WARE_NO = T1.OSTR_WARE_NO
                   AND ITM_PD_CD = T1.ITM_PD_CD) AS ON_QTY /* 재고수량 */
             , T1.MNGT_UNIT_CD /* 관리단위코드 */
             , T1.OSTR_RSON_CD /* 출고사유코드 */
             , T1.OSTR_QTY /* 출고수량 */
             , T1.RMK_CN /* 비고내용 */
             , T1.STR_CONF_DT /* 입고확인일자 */
          FROM TB_SVST_ITM_OSTR_IZ T1 /* 품목출고내역 */
         WHERE T1.ITM_OSTR_NO = #{itmOstrNo}
           AND T1.DTA_DL_YN = 'N'
         ORDER BY T1.ITM_OSTR_NO
    </select>

    <select id="selectIsClosedByPk" resultType="java.lang.String">
        SELECT T1.SELL_RCPDT /* 판매접수일자 */
          FROM TB_SVST_ITM_OSTR_IZ T1 /* 품목출고내역 */
         WHERE T1.ITM_OSTR_NO = #{itmOstrNo}
           AND T1.DTA_DL_YN = 'N'
         GROUP BY T1.SELL_RCPDT
    </select>

    <insert id="insertItemForwardingHistory">
        INSERT INTO TB_SVST_ITM_OSTR_IZ (  /* 품목출고내역 */
               ITM_OSTR_NO              /* 품목출고번호 */
             , OSTR_SN                  /* 출고일련번호 */
             , OSTR_TP_CD               /* 출고유형코드 */
             , OSTR_WARE_NO             /* 출고창고번호 */
             , OSTR_DT                  /* 출고일자 */
             , ITM_KND_CD               /* 품목종류코드 */
             , ITM_PD_CD                /* 품목상품코드 */
             , ITM_CD                   /* 품목코드 */
             , OSTR_WARE_DV_CD          /* 출고창고구분코드 */
             , MNGT_UNIT_CD             /* 관리단위코드 */
             , BOX_UNIT_QTY             /* 박스단위수량 */
             , ITM_GD_CD                /* 품목등급코드 */
             , OSTR_QTY                 /* 출고수량 */
             , WARE_MNGT_PRTNR_NO       /* 창고관리파트너번호 */
             , WARE_MNGT_PRTNR_OG_TP_CD /* 창고관리파트너조직유형코드 */
             , OSTR_RSON_CD             /* 출고사유코드 */
             , ACB_DT                   /* 회계일자 */
             , EVID_DV_CD               /* 증빙구분코드 */
             , STR_TP_CD                /* 입고유형코드 */
             , STR_WARE_NO              /* 입고창고번호 */
        <if test='@MybatisUtils@equals(ostrTpCd, "261")'>
        <!-- 반품인 경우 입고번호 채번 261 -> 161 itmStrNo (입고유형3 + 등록일자8 + 일련번호7) -->
             , ITM_STR_NO               /* 품목입고번호 */
             , STR_SN                   /* 입고일련번호 */
        </if>
             , DTA_DL_YN                /* 데이터삭제여부 */
             , RMK_CN                   /* 비고내용 */
             <include refid="COMMON.insertSystemField" />)
        VALUES (
               SELECT #{ostrTpCd} || #{ostrDt} || LPAD(NVL(SUBSTR(MAX(V1.ITM_OSTR_NO), 12, 7), 0) + 1, 7, '0')
                 FROM TB_SVST_ITM_OSTR_IZ V1
                WHERE V1.OSTR_TP_CD = #{ostrTpCd}
                  AND V1.OSTR_DT = #{ostrDt}
             , ${ostrSn}
             , #{ostrTpCd}
             , #{ostrWareNo}
             , #{ostrDt}
             , #{itmKndCd}
             , #{itmPdCd}
             , #{itmCd}
             , #{wareDvCd}
             , #{mngtUnitCd}
             , 0
             , #{itmGdCd}
             , ${ostrQty}
             , #{wareMngtPrtnrNo}
             , (SELECT P1.OG_TP_CD
                  FROM TB_OGBS_MM_PRTNR_IZ P1 /* 월파트너내역 */
                 WHERE P1.BASE_YM = SUBSTR(#{ostrDt}, 1, 6)
                   AND P1.PRTNR_NO = #{wareMngtPrtnrNo})
             , #{ostrRsonCd}
             , #{acbDt}
             , #{evidDvCd}
             , (CASE #{ostrTpCd} WHEN '261' THEN '161' WHEN '262' THEN '162' ELSE '' END)
             , #{strWareNo}
         <if test='@MybatisUtils@equals(ostrTpCd, "261")'>
         <!-- 반품인 경우 입고번호 채번 261 -> 161 itmStrNo (입고유형3 + 등록일자8 + 일련번호7) -->
             , SELECT (CASE #{ostrTpCd} WHEN '261' THEN '161' WHEN '262' THEN '162' ELSE '' END) || #{ostrDt} || LPAD(NVL(SUBSTR(MAX(V2.ITM_STR_NO), 12, 7), 0) + 1, 7, '0')
                 FROM TB_SVST_ITM_STR_IZ V2
                WHERE V2.STR_TP_CD = (CASE #{ostrTpCd} WHEN '261' THEN '161' WHEN '262' THEN '162' ELSE '' END)
                  AND V2.STR_WARE_NO = #{strWareNo}
                  AND V2.STR_RGST_DT = #{ostrDt}
             , ${strSn}
         </if>
             , 'N'
             , #{rmkCn}
             <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <insert id="insertItemReceivingHistory">
        INSERT INTO TB_SVST_ITM_STR_IZ (  /* 품목입고내역 */
               ITM_STR_NO                /* 품목입고번호 */
             , STR_SN                    /* 입고일련번호 */
             , STR_TP_CD                 /* 입고유형코드 */
             , STR_RGST_DT               /* 입고등록일자 */
             , STR_WARE_NO               /* 입고창고번호 */
             , WARE_MNGT_PRTNR_NO        /* 창고관리파트너번호 */
             , WARE_MNGT_PRTNR_OG_TP_CD  /* 창고관리파트너조직유형코드 */
             , STR_WARE_DV_CD            /* 입고창고구분코드 */
             , DLVG_DLPNR_NO             /* 납품거래처번호 */
             , ITM_PD_CD                 /* 품목상품코드 */
             , ITM_CD                    /* 품목코드 */
             , ITM_GD_CD                 /* 품목등급코드 */
             , MNGT_UNIT_CD              /* 관리단위코드 */
             , STR_QTY                   /* 입고수량 */
             , STR_UPRC_AMT              /* 입고단가금액 */
             , ACB_DT                    /* 회계일자 */
             , EVID_DV_CD                /* 증빙구분코드 */
             , ITM_OSTR_NO               /* 품목출고번호 */
             , OSTR_SN                   /* 출고일련번호 */
             , OSTR_TP_CD                /* 출고유형코드 */
             , OSTR_WARE_NO              /* 출고창고번호 */
             , OSTR_DT                   /* 출고일자 */
             , RMK_CN                    /* 비고내용 */
             , DTA_DL_YN                 /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField" />)
        VALUES (
               SELECT (CASE #{ostrTpCd} WHEN '261' THEN '161' WHEN '262' THEN '162' ELSE '' END) || #{ostrDt} || LPAD(NVL(SUBSTR(MAX(V2.ITM_STR_NO), 12, 7), 0) + 1, 7, '0')
                 FROM TB_SVST_ITM_STR_IZ V2
                WHERE V2.STR_TP_CD = (CASE #{ostrTpCd} WHEN '261' THEN '161' WHEN '262' THEN '162' ELSE '' END)
                  AND V2.STR_WARE_NO = #{strWareNo}
                  AND V2.STR_RGST_DT = #{ostrDt}
             , ${strSn}
             , (CASE #{ostrTpCd} WHEN '261' THEN '161' WHEN '262' THEN '162' ELSE '' END)
             , #{strRgstDt}
             , #{strWareNo}
             , #{strWareMngtPrtnrNo}
             , (SELECT P1.OG_TP_CD
                  FROM TB_OGBS_MM_PRTNR_IZ P1 /* 월파트너내역 */
                 WHERE P1.BASE_YM = SUBSTR(#{ostrDt}, 1, 6)
                   AND P1.PRTNR_NO = #{strWareMngtPrtnrNo})
             , #{strWareDvCd}
             , #{ostrWareNo}
             , #{itmPdCd}
             , #{itmCd}
             , #{itmGdCd}
             , #{mngtUnitCd}
             , ${ostrQty}
             , 0
             , #{acbDt}
             , #{evidDvCd}
             , SELECT #{ostrTpCd} || #{ostrDt} || LPAD(NVL(SUBSTR(MAX(V1.ITM_OSTR_NO), 12, 7), 0) + 1, 7, '0')
                 FROM TB_SVST_ITM_OSTR_IZ V1
                WHERE V1.OSTR_TP_CD = #{ostrTpCd}
                  AND V1.OSTR_DT = #{ostrDt}
             , ${ostrSn}
             , #{ostrTpCd}
             , #{ostrWareNo}
             , #{ostrDt}
             , #{rmkCn}
             , 'N'
             <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <delete id="deleteItemForwardingHistory">
        UPDATE TB_SVST_ITM_OSTR_IZ /* 품목출고내역 */
           SET DTA_DL_YN = 'Y'
         WHERE ITM_OSTR_NO = #{itmOstrNo}
           AND OSTR_SN = ${ostrSn}
    </delete>

    <delete id="deleteItemReceivingHistory">
        UPDATE TB_SVST_ITM_STR_IZ /* 품목입고내역 */
           SET DTA_DL_YN = 'Y'
         WHERE ITM_STR_NO = #{itmStrNo}
           AND STR_SN = ${strSn}
    </delete>

</mapper>
