<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaBsCsmbDeliveryAggregateMapper">
    <select id="selectDeliveryAggregate" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaBsCsmbDeliveryAggregateDvo">
        SELECT *
          FROM (SELECT M.CSMB_PD_CD
                     , M.SAP_MAT_CD
                     , M.BLD_NM
                     , M.BLD_CD
                     , M.BLD_CD AS ACL_BLD_CD
                     , M.PD_NM
                     , M.NWCMR
                     , M.INDV
                     , M.BLD
                     , NVL(SUM(M.NWCMR_SUM + M.INDV_SUM + M.BLD_SUM), 0) AS BFSVC_CSMB_DDLV_SUM
                  FROM (SELECT T1.CSMB_PD_CD
                             , T1.SAP_MAT_CD
                             , NVL(O2.BLD_NM, O3.BLD_NM) AS BLD_NM
                             , NVL(O2.BLD_CD, O3.BLD_CD) AS BLD_CD
                             , P1.PD_NM
                             , F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_CSMB_DDLV_TP_CD', T2.BFSVC_CSMB_DDLV_TP_CD, 'ko') AS NWCMR
                             , F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_CSMB_DDLV_TP_CD', T3.BFSVC_CSMB_DDLV_TP_CD, 'ko') AS INDV
                             , F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_CSMB_DDLV_TP_CD', T4.BFSVC_CSMB_DDLV_TP_CD, 'ko') AS BLD
                             , NVL(SUM(CASE WHEN T1.BFSVC_CSMB_DDLV_OJ_CD = '1' THEN T1.BFSVC_CSMB_DDLV_QTY END), 0) AS NWCMR_SUM
                             , NVL(SUM(CASE WHEN T1.BFSVC_CSMB_DDLV_OJ_CD = '2' THEN T1.BFSVC_CSMB_DDLV_QTY END), 0) AS INDV_SUM
                             , NVL(SUM(CASE WHEN T1.BFSVC_CSMB_DDLV_OJ_CD = '3' THEN T1.BFSVC_CSMB_DDLV_QTY END), 0) AS BLD_SUM
                          FROM TB_SVST_BFSVC_CSMB_DDLV_IZ T1
                          LEFT JOIN TB_SVST_BFSVC_CSMB_BASE_DTL T2
                            ON T1.MNGT_YM = T2.MNGT_YM
                           AND T1.CSMB_PD_CD = T2.CSMB_PD_CD
                           AND T2.BFSVC_CSMB_DDLV_OJ_CD = '1'
                           AND T2.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
                          LEFT JOIN TB_SVST_BFSVC_CSMB_BASE_DTL T3
                            ON T1.MNGT_YM = T3.MNGT_YM
                           AND T1.CSMB_PD_CD = T3.CSMB_PD_CD
                           AND T3.BFSVC_CSMB_DDLV_OJ_CD = '2'
                           AND T3.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
                          LEFT JOIN TB_SVST_BFSVC_CSMB_BASE_DTL T4
                            ON T1.MNGT_YM = T4.MNGT_YM
                           AND T1.CSMB_PD_CD = T4.CSMB_PD_CD
                           AND T4.BFSVC_CSMB_DDLV_OJ_CD = '3'
                           AND T4.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
                          LEFT JOIN TB_OGBS_MM_PRTNR_IZ O1
                            ON T1.MNGT_YM = O1.BASE_YM
                           AND T1.STR_WARE_NO = O1.PRTNR_NO
                           AND O1.OG_TP_CD = 'W02'
                          LEFT JOIN TB_OGBS_MM_OG_IZ O2
                            ON T1.MNGT_YM = O2.BASE_YM
                           AND O1.OG_TP_CD = O2.OG_TP_CD
                           AND O1.OG_ID = O2.OG_ID
                          LEFT JOIN TB_OGBS_BLD_BAS O3
                            ON T1.STR_WARE_NO = O3.BLD_CD
                           AND O3.OG_TP_CD = 'W02'
                         INNER JOIN TB_PDBS_PD_BAS P1
                            ON T1.CSMB_PD_CD = P1.PD_CD
                         WHERE 1 = 1
                           AND T1.MNGT_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                           AND T1.BFSVC_CSMB_DDLV_STAT_CD = '30'
                         <if test='@MybatisUtils@isNotEmpty(bfsvcCsmbDdlvOjCd)'>
                           AND T1.BFSVC_CSMB_DDLV_OJ_CD = #{bfsvcCsmbDdlvOjCd}
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(itmCds)'>
                           AND T1.CSMB_PD_CD IN (
                                                <foreach collection="itmCds" item="itmCd" separator=", ">
                                                 #{itmCd}
                                                </foreach>
                                                )
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(sapCdFrom)'>
                           AND T1.SAP_MAT_CD <![CDATA[>=]]> #{sapCdFrom}
                         </if>
                         <if test='@MybatisUtils@isNotEmpty(sapCdTo)'>
                           AND T1.SAP_MAT_CD <![CDATA[<=]]> #{sapCdTo}
                         </if>
                         GROUP BY T1.CSMB_PD_CD, T1.SAP_MAT_CD, O2.BLD_NM, O3.BLD_NM, O2.BLD_CD, O3.BLD_CD, P1.PD_NM,
                                  T2.BFSVC_CSMB_DDLV_TP_CD, T3.BFSVC_CSMB_DDLV_TP_CD, T4.BFSVC_CSMB_DDLV_TP_CD
                       ) M
                 WHERE 1 = 1
                 GROUP BY M.CSMB_PD_CD, M.SAP_MAT_CD, M.BLD_NM, M.BLD_CD, M.PD_NM, M.NWCMR, M.INDV, M.BLD
               ) M1
         INNER JOIN (SELECT /*+ index (S1 IX_SVPD_CST_SV_BFSVC_ASN_IZ_08)*/
                            O2.BLD_CD
                          , COUNT(S1.CST_SV_ASN_NO) AS VST_ACC_SUM
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '1' AND C1.COPN_DV_CD = '1' THEN 1 ELSE 0 END) AS BDT_INDV /* 비데개인 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '1' AND C1.COPN_DV_CD = '2' THEN 1 ELSE 0 END) AS BDT_CRP /* 비데법인 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '2' THEN 1 ELSE 0 END) AS WRFR /* 정수기 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '3' AND C1.COPN_DV_CD = '1' THEN 1 ELSE 0 END) AS ARCLE_INDV /* 공기청정기개인 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '3' AND C1.COPN_DV_CD = '2' THEN 1 ELSE 0 END) AS ARCLE_CRP /* 공기청정기법인 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '4' THEN 1 ELSE 0 END) AS WTR_SFTNR /* 연수기 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '93' THEN 1 ELSE 0 END) AS MSGCR /* 안마의자 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '96' THEN 1 ELSE 0 END) AS CFF_MCHN /* 커피머신 */
                          , SUM(CASE WHEN P1.PD_CD IN ('WM04100121' , 'WM04100152' , 'WM04100153') THEN 1 ELSE 0 END) AS DRYR /* 건조기 */
                          , SUM(CASE WHEN P1.PD_CD IN ('WM04100127' , 'WM04100155' , 'WM04100156') THEN 1 ELSE 0 END) AS WASH /* 세탁기 */
                          , SUM(CASE WHEN P1.PD_CD IN ('WM04100164', 'WM04100166', 'WM04100192', 'WM04100193', 'WM04100194', 'WM07101222') THEN 1 ELSE 0 END) AS ARDRSSR /* 에어드레서 */
                          , SUM(CASE WHEN P1.PD_CD IN ('WM04100200', 'WM04100201', 'WM04100202') THEN 1 ELSE 0 END) AS SSCLING /* 삼성청소기 */
                       FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ S1
                      INNER JOIN (SELECT /*+ index (Y PK_SVPD_CST_SV_EXCN_IZ)*/
                                         X.CST_SV_ASN_NO
                                       , Y.PDCT_PD_CD
                                    FROM TB_SVPD_CST_SV_BFSVC_OJ_IZ X
                                   INNER JOIN TB_SVPD_CST_SV_EXCN_IZ Y
                                      ON X.CNTR_NO = Y.CNTR_NO
                                     AND X.CNTR_SN = Y.CNTR_SN
                                     AND TRIM(X.SV_BIZ_DCLSF_CD) <![CDATA[<>]]> '2140'
                                     AND X.ASN_OJ_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                                 ) S2
                         ON S2.CST_SV_ASN_NO = S1.CST_SV_ASN_NO
                      INNER JOIN TB_OGBS_PRTNR_BAS O1
                         ON O1.OG_TP_CD = S1.CNFM_PSIC_PRTNR_OG_TP_CD
                        AND O1.PRTNR_NO = S1.CNFM_PSIC_PRTNR_NO
                      INNER JOIN TB_OGBS_OG_BAS O2
                         ON O2.OG_ID = O1.OG_ID
                     -- INNER JOIN TB_OGBS_BLD_BAS O3
                     --    ON O3.OG_TP_CD = O2.OG_TP_CD
                     --   AND O3.BLD_CD = O2.OG_CD
                      INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL P1
                         ON P1.PD_CD = S2.PDCT_PD_CD
                        AND P1.PD_EXTS_PRP_GRP_CD = 'PART'
                        AND P1.PD_PRP_VAL20 <![CDATA[<>]]> '11'
                      INNER JOIN TB_SSCT_CNTR_BAS C1
                         ON C1.CNTR_NO = S1.CNTR_NO
                      WHERE 1=1
                        AND S1.ASN_OJ_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                        AND TRIM(S1.SV_BIZ_DCLSF_CD) <![CDATA[<>]]> '2140'
                        AND S1.CNFM_PSIC_PRTNR_OG_TP_CD = 'W02'
                        AND S1.VST_PRGS_STAT_CD = '20'
                      GROUP BY O2.BLD_CD
                    ) M2
            ON M2.BLD_CD = M1.BLD_CD
         WHERE 1=1
         <if test='@MybatisUtils@isNotEmpty(bldCds)'>
           AND M1.BLD_CD IN (
                            <foreach collection="bldCds" item="bldCd" separator=", ">
                             #{bldCd}
                            </foreach>
                            )
         </if>
         ORDER BY BLD_NM, CSMB_PD_CD
    </select>

    <select id="selectItemQtys" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaBsCsmbDeliveryAggregateDto$SearchQtysRes">
        SELECT M.MNGT_YM
             , M.CSMB_PD_CD
             , SUM(M.BFSVC_CSMB_DDLV_QTY) AS BFSVC_CSMB_DDLV_QTY
             , M.BLD_CD
             , M.BLD_NM
          FROM (SELECT T1.MNGT_YM
                     , P1.PD_CD AS CSMB_PD_CD
                     , NVL(SUM(T1.BFSVC_CSMB_DDLV_QTY), 0) AS BFSVC_CSMB_DDLV_QTY
                     , O3.BLD_CD
                     , O3.BLD_NM
                  FROM TB_SVST_BFSVC_CSMB_DDLV_IZ T1
                 INNER JOIN TB_OGBS_PRTNR_BAS O1
                    ON O1.OG_TP_CD = 'W02'
                   AND O1.PRTNR_NO = T1.STR_WARE_NO
                 INNER JOIN TB_OGBS_OG_BAS O2
                    ON O2.OG_TP_CD = 'W02'
                   AND O2.OG_ID = O1.OG_ID
                 INNER JOIN TB_OGBS_BLD_BAS O3
                    ON O3.OG_TP_CD = 'W02'
                   AND O3.BLD_CD = O2.BLD_CD
                 INNER JOIN TB_PDBS_PD_BAS P1
                    ON T1.CSMB_PD_CD = P1.PD_CD
                 WHERE 1 = 1
                   AND T1.MNGT_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                   AND TRIM(T1.BFSVC_CSMB_DDLV_OJ_CD) IN ('1','2')
                   AND TRIM(T1.DTA_DL_YN) = 'N'
                   AND T1.BFSVC_CSMB_DDLV_STAT_CD = '30'
                 <if test='@MybatisUtils@isNotEmpty(bldCds)'>
                   AND O3.BLD_CD IN (
                                    <foreach collection="bldCds" item="bldCd" separator=", ">
                                     #{bldCd}
                                    </foreach>
                                    )
                 </if>
                 GROUP BY T1.MNGT_YM, P1.PD_CD, O3.BLD_CD, O3.BLD_NM
                 UNION ALL
                SELECT T1.MNGT_YM
                     , P1.PD_CD AS CSMB_PD_CD
                     , NVL(SUM(T1.BFSVC_CSMB_DDLV_QTY), 0) AS BFSVC_CSMB_DDLV_QTY
                     , O3.BLD_CD
                     , O3.BLD_NM
                  FROM TB_SVST_BFSVC_CSMB_DDLV_IZ T1
                 INNER JOIN TB_OGBS_BLD_BAS O3
                    ON O3.OG_TP_CD = 'W02'
                   AND O3.BLD_CD = T1.STR_WARE_NO
                 INNER JOIN TB_PDBS_PD_BAS P1
                    ON T1.CSMB_PD_CD = P1.PD_CD
                 WHERE 1 = 1
                   AND T1.MNGT_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                   AND TRIM(T1.BFSVC_CSMB_DDLV_OJ_CD) = '3'
                   AND TRIM(T1.DTA_DL_YN) = 'N'
                   AND T1.BFSVC_CSMB_DDLV_STAT_CD = '30'
                 <if test='@MybatisUtils@isNotEmpty(bldCds)'>
                   AND O3.BLD_CD IN (
                                    <foreach collection="bldCds" item="bldCd" separator=", ">
                                     #{bldCd}
                                    </foreach>
                                    )
                 </if>
                 GROUP BY T1.MNGT_YM, P1.PD_CD, O3.BLD_CD, O3.BLD_NM
               ) M
         WHERE 1 = 1
         GROUP BY M.MNGT_YM, M.CSMB_PD_CD, M.BLD_CD, M.BLD_NM
         ORDER BY M.BLD_NM, M.CSMB_PD_CD
    </select>
</mapper>
