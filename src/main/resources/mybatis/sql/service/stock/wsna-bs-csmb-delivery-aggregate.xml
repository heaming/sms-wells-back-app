<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaBsCsmbDeliveryAggregateMapper">
    <select id="selectDeliveryAggregate" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaBsCsmbDeliveryAggregateDvo">
        SELECT *
          FROM (SELECT T1.CSMB_PD_CD
                     , T1.STR_WARE_NO
                     , T1.SAP_MAT_CD
                     , CASE WHEN T1.STR_WARE_NO = T2.PRTNR_NO THEN T2.BLD_NM
                            WHEN T1.STR_WARE_NO = T3.PRTNR_NO THEN T3.BLD_NM
                            WHEN T1.STR_WARE_NO = T4.BLD_CD THEN T4.BLD_NM
                        END BLD_NM
                     , CASE WHEN T1.STR_WARE_NO = T2.PRTNR_NO THEN T2.BLD_CD
                            WHEN T1.STR_WARE_NO = T3.PRTNR_NO THEN T3.BLD_CD
                            WHEN T1.STR_WARE_NO = T4.BLD_CD THEN T4.BLD_CD
                        END BLD_CD
                     , CASE WHEN T1.STR_WARE_NO = T2.PRTNR_NO THEN T2.BLD_CD
                            WHEN T1.STR_WARE_NO = T3.PRTNR_NO THEN T3.BLD_CD
                            WHEN T1.STR_WARE_NO = T4.BLD_CD THEN T4.BLD_CD
                        END ACL_BLD_CD
                     , (SELECT DISTINCT X.ITM_KNM
                          FROM TB_SVST_BFSVC_CSMB_BASE_BAS X
                         WHERE X.CSMB_PD_CD = T1.CSMB_PD_CD
                       ) PD_NM
                     , (SELECT F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_CSMB_DDLV_TP_CD', X.BFSVC_CSMB_DDLV_TP_CD, 'ko') AS BFSVC_CSMB_DDLV_TP_NM
                          FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
                         WHERE X.CSMB_PD_CD = T1.CSMB_PD_CD
                           AND X.BFSVC_CSMB_DDLV_OJ_CD = '1'
                           AND X.MNGT_YM = T1.MNGT_YM
                       ) NWCMR
                     , (SELECT F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_CSMB_DDLV_TP_CD', X.BFSVC_CSMB_DDLV_TP_CD, 'ko') AS BFSVC_CSMB_DDLV_TP_NM
                          FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
                         WHERE X.CSMB_PD_CD = T1.CSMB_PD_CD
                           AND X.BFSVC_CSMB_DDLV_OJ_CD = '2'
                           AND X.MNGT_YM = T1.MNGT_YM
                       ) INDV
                     , (SELECT F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_CSMB_DDLV_TP_CD', X.BFSVC_CSMB_DDLV_TP_CD, 'ko') AS BFSVC_CSMB_DDLV_TP_NM
                          FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
                         WHERE X.CSMB_PD_CD = T1.CSMB_PD_CD
                           AND X.BFSVC_CSMB_DDLV_OJ_CD = '3'
                           AND X.MNGT_YM = T1.MNGT_YM
                       ) BLD
                     , SUM(NVL(T2.BFSVC_CSMB_DDLV_QTY, 0) + NVL(T3.BFSVC_CSMB_DDLV_QTY, 0) + NVL(T4.BFSVC_CSMB_DDLV_QTY, 0)) BFSVC_CSMB_DDLV_SUM
                  FROM TB_SVST_BFSVC_CSMB_DDLV_IZ T1
                  LEFT OUTER JOIN (SELECT T1.MNGT_YM
                                        , T1.STR_WARE_NO
                                        , T1.BFSVC_CSMB_DDLV_OJ_CD
                                        , T2.PRTNR_NO
                                        , T3.BLD_CD
                                        , T3.BLD_NM
                                        , T1.CSMB_PD_CD
                                        , SUM(T1.BFSVC_CSMB_DDLV_QTY) AS BFSVC_CSMB_DDLV_QTY
                                     FROM TB_SVST_BFSVC_CSMB_DDLV_IZ T1
                                    INNER JOIN TB_OGBS_MM_PRTNR_IZ T2
                                       ON T1.MNGT_YM = T2.BASE_YM
                                      AND T2.OG_TP_CD = 'W02'
                                      AND T1.STR_WARE_NO = T2.PRTNR_NO
                                    INNER JOIN TB_OGBS_MM_OG_IZ T3
                                       ON T2.BASE_YM = T3.BASE_YM
                                      AND T2.OG_ID = T3.OG_ID
                                    WHERE T1.BFSVC_CSMB_DDLV_OJ_CD = '1'
                                      AND T1.BFSVC_CSMB_DDLV_STAT_CD = '30'
                                    GROUP BY T1.MNGT_YM, T1.STR_WARE_NO, T1.BFSVC_CSMB_DDLV_OJ_CD, T2.PRTNR_NO, T3.BLD_CD, T3.BLD_NM, T1.CSMB_PD_CD
                                  ) T2
                    ON T2.MNGT_YM = T1.MNGT_YM
                   AND T2.STR_WARE_NO = T1.STR_WARE_NO
                   AND T2.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND T2.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   LEFT OUTER JOIN (SELECT T1.MNGT_YM
                                         , T1.STR_WARE_NO
                                         , T1.BFSVC_CSMB_DDLV_OJ_CD
                                         , T2.PRTNR_NO
                                         , T3.BLD_CD
                                         , T3.BLD_NM
                                         , T1.CSMB_PD_CD
                                         , SUM(T1.BFSVC_CSMB_DDLV_QTY) AS BFSVC_CSMB_DDLV_QTY
                                      FROM TB_SVST_BFSVC_CSMB_DDLV_IZ T1
                                     INNER JOIN TB_OGBS_MM_PRTNR_IZ T2
                                        ON T1.MNGT_YM = T2.BASE_YM
                                       AND T2.OG_TP_CD = 'W02'
                                       AND T1.STR_WARE_NO = T2.PRTNR_NO
                                     INNER JOIN TB_OGBS_MM_OG_IZ T3
                                        ON T2.BASE_YM = T3.BASE_YM
                                       AND T2.OG_ID = T3.OG_ID
                                     WHERE T1.BFSVC_CSMB_DDLV_OJ_CD = '2'
                                       AND T1.BFSVC_CSMB_DDLV_STAT_CD = '30'
                                     GROUP BY T1.MNGT_YM, T1.STR_WARE_NO, T1.BFSVC_CSMB_DDLV_OJ_CD, T2.PRTNR_NO, T3.BLD_CD, T3.BLD_NM, T1.CSMB_PD_CD
                                   ) T3
                    ON T3.MNGT_YM = T1.MNGT_YM
                   AND T3.STR_WARE_NO = T1.STR_WARE_NO
                   AND T3.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND T3.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                  LEFT OUTER JOIN (SELECT T1.MNGT_YM
                                        , T1.STR_WARE_NO
                                        , T1.BFSVC_CSMB_DDLV_OJ_CD
                                        , T2.BLD_CD
                                        , T2.BLD_NM
                                        , T1.CSMB_PD_CD
                                        , SUM(T1.BFSVC_CSMB_DDLV_QTY) AS BFSVC_CSMB_DDLV_QTY
                                     FROM TB_SVST_BFSVC_CSMB_DDLV_IZ T1
                                    INNER JOIN TB_OGBS_BLD_BAS T2
                                       ON T2.OG_TP_CD = 'W02'
                                      AND T1.STR_WARE_NO = T2.BLD_CD
                                    WHERE T1.BFSVC_CSMB_DDLV_OJ_CD = '3'
                                      AND T1.BFSVC_CSMB_DDLV_STAT_CD = '30'
                                    GROUP BY T1.MNGT_YM, T1.STR_WARE_NO, T1.BFSVC_CSMB_DDLV_OJ_CD, T2.BLD_CD, T2.BLD_NM, T1.CSMB_PD_CD
                                  ) T4
                    ON T4.MNGT_YM = T1.MNGT_YM
                   AND T4.STR_WARE_NO = T1.STR_WARE_NO
                   AND T4.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND T4.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                 WHERE 1=1
                   AND T1.MNGT_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                 <if test='@MybatisUtils@isNotEmpty(bfsvcCsmbDdlvOjCd)'>
                   AND T1.BFSVC_CSMB_DDLV_OJ_CD = #{bfsvcCsmbDdlvOjCd}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(itmCds)'>
                   AND T1.CSMB_PD_CD IN (
                                        <foreach collection="bldCds" item="bldCd" separator=", ">
                                         #{itmCd}
                                        </foreach>
                                        )
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(sapCdFrom)'>
                   AND T1.SAP_MAT_CD <![CDATA[>=]]> #{sapCdFrom}
                 </if>
                 <if test='@MybatisUtils@isNotEmpty(sapCdTo)'>
                   AND T1.SAP_MAT_CD <![CDATA[<=]]> #{sapCdTo}
                 </if>
                 GROUP BY T1.CSMB_PD_CD, T1.SAP_MAT_CD, T1.STR_WARE_NO, T2.PRTNR_NO, T1.MNGT_YM,
                          T2.BLD_CD, T2.BLD_NM, T3.PRTNR_NO, T3.BLD_CD, T3.BLD_NM, T4.BLD_CD, T4.BLD_NM
               ) M1
         INNER JOIN (SELECT O2.BLD_CD
                          , COUNT(S1.CST_SV_ASN_NO) AS VST_ACC_SUM
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '1' AND C1.COPN_DV_CD = '1' THEN 1 ELSE 0 END) AS BDT_INDV /* 비데개인 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '1' AND C1.COPN_DV_CD = '2' THEN 1 ELSE 0 END) AS BDT_CRP /* 비데법인 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '2' THEN 1 ELSE 0 END) AS WRFR /* 정수기 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '3' AND C1.COPN_DV_CD = '1' THEN 1 ELSE 0 END) AS ARCLE_INDV /* 공기청정기개인 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '3' AND C1.COPN_DV_CD = '2' THEN 1 ELSE 0 END) AS ARCLE_CRP /* 공기청정기법인 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '4' THEN 1 ELSE 0 END) AS WTR_SFTNR /* 연수기 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '93' THEN 1 ELSE 0 END) AS MSGCR /* 안마의자 */
                          , SUM(CASE WHEN P1.PD_PRP_VAL20 = '96' THEN 1 ELSE 0 END) AS CFF_MCHN /* 커피머신 */
                          , SUM(CASE WHEN P1.PD_CD IN ('WM04100121' , 'WM04100152' , 'WM04100153') THEN 1 ELSE 0 END) AS DRYR /* 건조기 */
                          , SUM(CASE WHEN P1.PD_CD IN ('WM04100127' , 'WM04100155' , 'WM04100156') THEN 1 ELSE 0 END) AS WASH /* 세탁기 */
                          , SUM(CASE WHEN P1.PD_CD IN ('WM04100164', 'WM04100166', 'WM04100192', 'WM04100193', 'WM04100194', 'WM07101222') THEN 1 ELSE 0 END) AS ARDRSSR /* 에어드레서 */
                          , SUM(CASE WHEN P1.PD_CD IN ('WM04100200', 'WM04100201', 'WM04100202') THEN 1 ELSE 0 END) AS SSCLING /* 삼성청소기 */
                       FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ S1
                      INNER JOIN (SELECT X.CST_SV_ASN_NO
                                       , Y.PDCT_PD_CD
                                    FROM TB_SVPD_CST_SV_BFSVC_OJ_IZ X
                                   INNER JOIN TB_SVPD_CST_SV_EXCN_IZ Y
                                      ON Y.CNTR_NO = X.CNTR_NO
                                     AND Y.CNTR_SN = X.CNTR_SN
                                     AND X.SV_BIZ_DCLSF_CD <![CDATA[<>]]> '2140'
                                     AND X.ASN_OJ_YM BETWEEN '202206' AND '202306'
                                 ) S2
                         ON S2.CST_SV_ASN_NO = S1.CST_SV_ASN_NO
                      INNER JOIN TB_OGBS_PRTNR_BAS O1
                         ON O1.OG_TP_CD = S1.CNFM_PSIC_PRTNR_OG_TP_CD
                        AND O1.PRTNR_NO = S1.CNFM_PSIC_PRTNR_NO
                      INNER JOIN TB_OGBS_OG_BAS O2
                         ON O2.OG_ID = O1.OG_ID
                     -- INNER JOIN TB_OGBS_BLD_BAS O3
                     --    ON O3.OG_TP_CD = O2.OG_TP_CD
                     --   AND O3.BLD_CD = O2.OG_CD
                      INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL P1
                         ON P1.PD_CD = S2.PDCT_PD_CD
                        AND P1.PD_EXTS_PRP_GRP_CD = 'PART'
                        AND P1.PD_PRP_VAL20 <![CDATA[<>]]> '11'
                      INNER JOIN TB_SSCT_CNTR_BAS C1
                         ON C1.CNTR_NO = S1.CNTR_NO
                      WHERE 1=1
                        AND S1.ASN_OJ_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                        AND S1.SV_BIZ_DCLSF_CD <![CDATA[<>]]> '2140'
                        AND S1.CNFM_PSIC_PRTNR_OG_TP_CD = 'W02'
                        AND S1.VST_PRGS_STAT_CD = '20'
                      GROUP BY O2.BLD_CD
                    ) M2
            ON M2.BLD_CD = M1.BLD_CD
         WHERE 1=1
         <if test='@MybatisUtils@isNotEmpty(bldCds)'>
           AND M1.ACL_BLD_CD IN (
                                <foreach collection="bldCds" item="bldCd" separator=", ">
                                 #{bldCd}
                                </foreach>
                                )
         </if>
         ORDER BY BLD_NM, CSMB_PD_CD
    </select>

    <select id="selectItemQtys" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaBsCsmbDeliveryAggregateDto$SearchQtysRes">
        SELECT T1.MNGT_YM
             , T1.CSMB_PD_CD
             , T1.STR_WARE_NO
             , CASE WHEN T1.BFSVC_CSMB_DDLV_QTY = 0 THEN NULL
                    ELSE T1.BFSVC_CSMB_DDLV_QTY
                END BFSVC_CSMB_DDLV_QTY
             , O3.BLD_CD
             , O3.BLD_NM
          FROM TB_SVST_BFSVC_CSMB_DDLV_IZ T1
         INNER JOIN TB_OGBS_PRTNR_BAS O1
            ON O1.OG_TP_CD = 'W02'
           AND O1.PRTNR_NO = T1.STR_WARE_NO
         INNER JOIN TB_OGBS_OG_BAS O2
            ON O2.OG_TP_CD = 'W02'
           AND O2.OG_ID = O1.OG_ID
         INNER JOIN TB_OGBS_BLD_BAS O3
            ON O3.OG_TP_CD = 'W02'
           AND O3.BLD_CD = O2.BLD_CD
         WHERE 1 = 1
           AND T1.MNGT_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
           AND TRIM(T1.BFSVC_CSMB_DDLV_OJ_CD) IN ('1','2')
           AND TRIM(T1.DTA_DL_YN) = 'N'
         UNION ALL
        SELECT T1.MNGT_YM
             , T1.CSMB_PD_CD
             , T1.STR_WARE_NO
             , CASE WHEN T1.BFSVC_CSMB_DDLV_QTY = 0 THEN NULL
                    ELSE T1.BFSVC_CSMB_DDLV_QTY
                END BFSVC_CSMB_DDLV_QTY
             , O3.BLD_CD
             , O3.BLD_NM
          FROM TB_SVST_BFSVC_CSMB_DDLV_IZ T1
         INNER JOIN TB_OGBS_BLD_BAS O3
            ON O3.OG_TP_CD = 'W02'
           AND O3.BLD_CD = T1.STR_WARE_NO
         WHERE 1 = 1
           AND T1.MNGT_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
           AND TRIM(T1.BFSVC_CSMB_DDLV_OJ_CD) = '3'
           AND TRIM(T1.DTA_DL_YN) = 'N'
         ORDER BY BLD_NM, CSMB_PD_CD
    </select>
</mapper>
