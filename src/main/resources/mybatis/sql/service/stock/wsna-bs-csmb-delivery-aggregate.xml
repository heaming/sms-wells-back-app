<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaBsCsmbDeliveryAggregateMapper">

    <select id="selectBuildingList" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaBuildingBsConsumableDto$SearchBldRes">
        SELECT DISTINCT D1.BLD_CD
             , D1.BLD_NM
          FROM TB_OGBS_BLD_BAS D1         /* 빌딩기본 */
         INNER JOIN TB_OGBS_MM_OG_IZ D2   /* 월조직내역 */
            ON D2.OG_TP_CD = D1.OG_TP_CD
           AND D2.BLD_CD   = D1.BLD_CD
         WHERE D1.DTA_DL_YN = 'N'
           AND D2.DTA_DL_YN = 'N'
           AND D2.OG_TP_CD  = 'W02'
           AND D2.CLO_YN    = 'N'
           AND D2.BASE_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
         ORDER BY D1.BLD_NM
    </select>

    <select id="selectDeliveryAggregate" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaBsCsmbDeliveryAggregateDvo">
        SELECT CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN T1.BLD_CD
               END                                                                                  AS BLD_CD         /* 빌딩코드 */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN T1.BLD_NM
               END                                                                                  AS BLD_NM         /* 빌딩명 */
             , TO_CHAR(TO_NUMBER(T1.SAP_MAT_CD))                                                    AS SAP_MAT_CD     /* SAP코드 */
             , T1.CSMB_PD_CD                                                                                          /* 품목코드 */
             , T2.PD_NM                                                                                               /* 품목명 */
             , F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_CSMB_DDLV_TP_CD', T1.NWCMR_TP_CD, #{session.langId}) AS NWCMR          /* 신입 배부유형 */
             , F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_CSMB_DDLV_TP_CD', T1.INDV_TP_CD, #{session.langId})  AS INDV           /* 개인 배부유형 */
             , F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_CSMB_DDLV_TP_CD', T1.BLD_TP_CD, #{session.langId})   AS BLD            /* 빌딩 배부유형 */
             , NVL(T1.DDLV_QTY_SUM, 0)                                                              AS DDLV_QTY_SUM   /* 합계 배부수량 */
             , NVL(T1.MMS5B_DDLV_QTY, 0)                                                            AS MM1_QTY        /* 5개월전 배부수량 */
             , NVL(T1.MMS4B_DDLV_QTY, 0)                                                            AS MM2_QTY        /* 4개월전 배부수량 */
             , NVL(T1.MMS3B_DDLV_QTY, 0)                                                            AS MM3_QTY        /* 3개월전 배부수량 */
             , NVL(T1.MMS2B_DDLV_QTY, 0)                                                            AS MM4_QTY        /* 2개월전 배부수량 */
             , NVL(T1.MMS1B_DDLV_QTY, 0)                                                            AS MM5_QTY        /* 1개월전 배부수량 */
             , NVL(T1.TLST_MCNT_QTY, 0)                                                             AS MM6_QTY        /* 당월 배부수량 */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.VST_ACC_SUM, 0)
               END                                                                                  AS VST_ACC_SUM    /* 합계 방문계정 */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.BDT_INDV, 0)
               END                                                                                  AS BDT_INDV       /* 비데(개인) */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.BDT_CRP, 0)
               END                                                                                  AS BDT_CRP        /* 비데(법인) */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.WRFR, 0)
               END                                                                                  AS WRFR          /* 정수기 */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.ARCLE_INDV, 0)
               END                                                                                  AS ARCLE_INDV    /* 공기청정기(개인) */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.ARCLE_CRP, 0)
               END                                                                                  AS ARCLE_CRP     /* 공기청정기(법인) */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.WTR_SFTNR, 0)
               END                                                                                  AS WTR_SFTNR     /* 연수기 */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.MSGCR, 0)
               END                                                                                  AS MSGCR         /* 안마의자 */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.CFF_MCHN, 0)
               END                                                                                  AS CFF_MCHN      /* 커피머신 */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.DRYR, 0)
               END                                                                                  AS DRYR          /* 건조기 */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.WASH, 0)
               END                                                                                  AS WASH          /* 세탁기 */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.ARDRSSR, 0)
               END                                                                                  AS ARDRSSR       /* 에어드레서 */
             , CASE WHEN ROW_NUMBER() OVER(PARTITION BY T1.BLD_CD ORDER BY T1.BLD_NM, T1.CSMB_PD_CD) = 1
                    THEN NVL(T3.SSCLING, 0)
               END                                                                                  AS SSCLING       /* 삼성청소기 */
          FROM
             (
               SELECT T.BLD_CD                                       /* 빌딩코드 */
                    , T.BLD_NM                                       /* 빌딩명 */
                    , T.SAP_MAT_CD                                   /* SAP코드 */
                    , T.CSMB_PD_CD                                   /* 소모품상품코드 */
                    , MAX(T.NWCMR_TP_CD)         AS NWCMR_TP_CD      /* 신입 배부유형 */
                    , MAX(T.INDV_TP_CD)          AS INDV_TP_CD       /* 개인 배부유형 */
                    , MAX(T.BLD_TP_CD)           AS BLD_TP_CD        /* 빌딩 배부유형 */
                    , SUM(T.BFSVC_CSMB_DDLV_QTY) AS DDLV_QTY_SUM     /* 합계 배부수량 */
                    , SUM(CASE WHEN T.MNGT_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{mngtYmTo}, 'YYYYMM'), -5), 'YYYYMM')
                               THEN T.BFSVC_CSMB_DDLV_QTY
                          END)                   AS MMS5B_DDLV_QTY   /* 5개월전 배부수량 */
                    , SUM(CASE WHEN T.MNGT_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{mngtYmTo}, 'YYYYMM'), -4), 'YYYYMM')
                               THEN T.BFSVC_CSMB_DDLV_QTY
                          END)                   AS MMS4B_DDLV_QTY   /* 4개월전 배부수량 */
                    , SUM(CASE WHEN T.MNGT_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{mngtYmTo}, 'YYYYMM'), -3), 'YYYYMM')
                               THEN T.BFSVC_CSMB_DDLV_QTY
                          END)                   AS MMS3B_DDLV_QTY   /* 3개월전 배부수량 */
                    , SUM(CASE WHEN T.MNGT_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{mngtYmTo}, 'YYYYMM'), -2), 'YYYYMM')
                               THEN T.BFSVC_CSMB_DDLV_QTY
                          END)                   AS MMS2B_DDLV_QTY   /* 2개월전 배부수량 */
                    , SUM(CASE WHEN T.MNGT_YM = TO_CHAR(ADD_MONTHS(TO_DATE(#{mngtYmTo}, 'YYYYMM'), -1), 'YYYYMM')
                               THEN T.BFSVC_CSMB_DDLV_QTY
                          END)                   AS MMS1B_DDLV_QTY   /* 1개월전 배부수량 */
                    , SUM(CASE WHEN T.MNGT_YM = #{mngtYmTo}
                               THEN T.BFSVC_CSMB_DDLV_QTY
                          END)                   AS TLST_MCNT_QTY    /* 당월 배부수량 */
                 FROM
                    (
                      SELECT CASE WHEN D1.BFSVC_CSMB_DDLV_OJ_CD IN ('1', '2') THEN D4.BLD_CD
                                  ELSE D2.BLD_CD
                             END                                                                        AS BLD_CD        /* 빌딩코드 */
                           , CASE WHEN D1.BFSVC_CSMB_DDLV_OJ_CD IN ('1', '2') THEN D4.BLD_NM
                                  ELSE D2.BLD_NM
                             END                                                                        AS BLD_NM        /* 빌딩명 */
                           , D1.SAP_MAT_CD                                                                               /* SAP코드 */
                           , D1.CSMB_PD_CD                                                                               /* 소모품상품코드 */
                           , CASE WHEN D1.BFSVC_CSMB_DDLV_OJ_CD = '1' THEN D5.BFSVC_CSMB_DDLV_TP_CD END AS NWCMR_TP_CD   /* 신입 배부유형코드 */
                           , CASE WHEN D1.BFSVC_CSMB_DDLV_OJ_CD = '2' THEN D5.BFSVC_CSMB_DDLV_TP_CD END AS INDV_TP_CD    /* 개인 배부유형코드 */
                           , CASE WHEN D1.BFSVC_CSMB_DDLV_OJ_CD = '3' THEN D5.BFSVC_CSMB_DDLV_TP_CD END AS BLD_TP_CD     /* 빌딩 배부유형코드 */
                           , D1.BFSVC_CSMB_DDLV_QTY                                                                      /* 배부수량 */
                           , D1.MNGT_YM                                                                                  /* 관리년월 */
                        FROM TB_SVST_BFSVC_CSMB_DDLV_IZ D1   /* BS소모품배부내역 */
                        LEFT OUTER JOIN TB_OGBS_BLD_BAS D2   /* 빌딩기본 */
                          ON D2.BLD_CD    = D1.STR_WARE_NO
                         AND D2.DTA_DL_YN = 'N'
                         AND D2.OG_TP_CD  = 'W02'
                        LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ D3   /* 월파트너내역 */
                          ON D3.BASE_YM   = D1.MNGT_YM
                         AND D3.PRTNR_NO  = D1.STR_WARE_NO
                         AND D3.DTA_DL_YN = 'N'
                         AND D3.OG_TP_CD  = 'W02'
                         AND D3.BASE_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                        LEFT OUTER JOIN TB_OGBS_MM_OG_IZ D4   /* 월조직내역 */
                          ON D4.BASE_YM   = D3.BASE_YM
                         AND D4.OG_TP_CD  = D3.OG_TP_CD
                         AND D4.OG_ID     = D3.OG_ID
                         AND D4.DTA_DL_YN = 'N'
                         AND D4.OG_TP_CD  = 'W02'
                         AND D4.BASE_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                       INNER JOIN TB_SVST_BFSVC_CSMB_BASE_DTL D5 /* BS소모품기준상세 */
                          ON D5.MNGT_YM               = D1.MNGT_YM
                         AND D5.CSMB_PD_CD            = D1.CSMB_PD_CD
                         AND D5.BFSVC_CSMB_DDLV_OJ_CD = D1.BFSVC_CSMB_DDLV_OJ_CD
                       WHERE D1.DTA_DL_YN               = 'N'
                         AND D1.BFSVC_CSMB_DDLV_STAT_CD = '30'
                         AND D5.DTA_DL_YN               = 'N'
                         AND D1.MNGT_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                         AND D5.MNGT_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                    <if test="@MybatisUtils@isNotEmpty(itmCd)">
                         AND D1.CSMB_PD_CD              = #{itmCd}
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(bfsvcCsmbDdlvOjCd)">
                         AND D1.BFSVC_CSMB_DDLV_OJ_CD   = #{bfsvcCsmbDdlvOjCd}
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(sapCdFrom)">
                         AND D1.SAP_MAT_CD <![CDATA[>=]]> LPAD(#{sapCdFrom}, 18, '0')
                    </if>
                    <if test="@MybatisUtils@isNotEmpty(sapCdTo)">
                         AND D1.SAP_MAT_CD <![CDATA[<=]]> LPAD(#{sapCdTo}, 18, '0')
                    </if>
                    ) T
                WHERE T.BLD_CD IS NOT NULL
                GROUP BY T.BLD_CD, T.BLD_NM, T.SAP_MAT_CD, T.CSMB_PD_CD
             ) T1
         INNER JOIN TB_PDBS_PD_BAS T2   /* 상품기본 */
            ON T2.PD_CD = T1.CSMB_PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ ORDERED USE_HASH(D1 D2 D3) */
                      D7.BLD_CD
                    , D7.BLD_NM
                    , COUNT(1)                                                                                                                     AS VST_ACC_SUM  /* 방문계정수 */
                    , COUNT(CASE WHEN D4.PD_PRP_VAL20 = '1' AND D3.COPN_DV_CD = '1' THEN 1 END)                                                    AS BDT_INDV     /* 비데(개인) */
                    , COUNT(CASE WHEN D4.PD_PRP_VAL20 = '1' AND D3.COPN_DV_CD = '2' THEN 1 END)                                                    AS BDT_CRP      /* 비데(법인) */
                    , COUNT(CASE WHEN D4.PD_PRP_VAL20 = '2' THEN 1 END)                                                                            AS WRFR         /* 정수기 */
                    , COUNT(CASE WHEN D4.PD_PRP_VAL20 = '3' AND D3.COPN_DV_CD = '1' THEN 1 END)                                                    AS ARCLE_INDV   /* 공기청정기(개인) */
                    , COUNT(CASE WHEN D4.PD_PRP_VAL20 = '3' AND D3.COPN_DV_CD = '2' THEN 1 END)                                                    AS ARCLE_CRP    /* 공기청정기(법인) */
                    , COUNT(CASE WHEN D4.PD_PRP_VAL20 = '4' THEN 1 END)                                                                            AS WTR_SFTNR    /* 연수기 */
                    , COUNT(CASE WHEN D4.PD_PRP_VAL20 = '93' THEN 1 END)                                                                           AS MSGCR        /* 안마의자 */
                    , COUNT(CASE WHEN D4.PD_PRP_VAL20 = '96' THEN 1 END)                                                                           AS CFF_MCHN     /* 커피머신 */
                    , COUNT(CASE WHEN D4.PD_CD IN ('WM04100121' , 'WM04100152' , 'WM04100153') THEN 1 END)                                         AS DRYR         /* 건조기 */
                    , COUNT(CASE WHEN D4.PD_CD IN ('WM04100127' , 'WM04100155' , 'WM04100156') THEN 1 END)                                         AS WASH         /* 세탁기 */
                    , COUNT(CASE WHEN D4.PD_CD IN ('WM04100164', 'WM04100166', 'WM04100192', 'WM04100193', 'WM04100194', 'WM07101222') THEN 1 END) AS ARDRSSR      /* 에어드레서 */
                    , COUNT(CASE WHEN D4.PD_CD IN ('WM04100200', 'WM04100201', 'WM04100202') THEN 1 END)                                           AS SSCLING      /* 삼성청소기 */
                 FROM TB_SVPD_MCBY_CST_SV_OJ_IZ D1      /* 월별고객서비스대상내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2    /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                INNER JOIN TB_SSCT_CNTR_BAS D3          /* 계약기본 */
                   ON D3.CNTR_NO = D1.CNTR_NO
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D4   /* 상품각사속성상세 */
                   ON D4.PD_CD = D2.PDCT_PD_CD
                INNER JOIN TB_OGBS_MM_PRTNR_IZ D5       /* 월파트너내역 */
                   ON D5.BASE_YM  = D1.MNGT_YM
                  AND D5.OG_TP_CD = D1.MNGT_PRTNR_OG_TP_CD
                  AND D5.PRTNR_NO = D1.MNGT_PRTNR_NO
                INNER JOIN TB_OGBS_MM_OG_IZ D6          /* 월조직내역 */
                   ON D6.BASE_YM  = D5.BASE_YM
                  AND D6.OG_TP_CD = D5.OG_TP_CD
                  AND D6.OG_ID    = D5.OG_ID
                INNER JOIN TB_OGBS_BLD_BAS D7           /* 빌딩기본 */
                   ON D7.OG_TP_CD = D6.OG_TP_CD
                  AND D7.BLD_CD   = D6.BLD_CD
                WHERE D1.DTA_DL_YN           = 'N'
                  AND D1.MNGT_PRTNR_OG_TP_CD = 'W02'
                  AND D2.DTA_DL_YN           = 'N'
                  AND D2.CNTR_DTL_STAT_CD NOT IN ('301', '302', '303', '401', '402')
                  AND D3.DTA_DL_YN           = 'N'
                  AND D4.DTA_DL_YN           = 'N'
                  AND D4.PD_EXTS_PRP_GRP_CD  = 'PART'
                  AND D4.PD_PRP_VAL20 <![CDATA[<>]]> '11'   /* 모종제외 */
                  AND D5.DTA_DL_YN           = 'N'
                  AND D5.OG_TP_CD            = 'W02'
                  AND D6.DTA_DL_YN           = 'N'
                  AND D6.OG_TP_CD            = 'W02'
                  AND D7.DTA_DL_YN           = 'N'
                  AND D7.OG_TP_CD            = 'W02'
                  AND D1.MNGT_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                  AND D5.BASE_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
                  AND D6.BASE_YM BETWEEN #{mngtYmFrom} AND #{mngtYmTo}
            <if test="@MybatisUtils@isNotEmpty(bldCds)">
                  AND D7.BLD_CD IN
                            <foreach collection="bldCds" item="item" open="(" close=")" separator=",">
                                    #{item}
                            </foreach>
            </if>
                GROUP BY D7.BLD_CD, D7.BLD_NM
             ) T3
            ON T3.BLD_CD = T1.BLD_CD
         WHERE T2.DTA_DL_YN = 'N'
           AND T2.PD_TP_CD  = 'M'
        <if test="@MybatisUtils@isNotEmpty(bldCds)">
           AND T1.BLD_CD IN
                        <foreach collection="bldCds" item="item" open="(" close=")" separator=",">
                             #{item}
                        </foreach>
        </if>
         ORDER BY T1.BLD_NM, T1.CSMB_PD_CD
    </select>

</mapper>
