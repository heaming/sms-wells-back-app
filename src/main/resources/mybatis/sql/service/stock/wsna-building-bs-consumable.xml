<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaBuildingBsConsumableMapper">

    <select id="selectBuildingList" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaBuildingBsConsumableDto$SearchBldRes">
        SELECT DISTINCT D1.BLD_CD
             , D1.BLD_NM
          FROM TB_OGBS_BLD_BAS D1         /* 빌딩기본 */
         INNER JOIN TB_OGBS_MM_OG_IZ D2   /* 월조직내역 */
            ON D2.OG_TP_CD = D1.OG_TP_CD
           AND D2.BLD_CD   = D1.BLD_CD
         WHERE D1.DTA_DL_YN = 'N'
           AND D2.DTA_DL_YN = 'N'
           AND D2.OG_TP_CD  = 'W02'
           AND D2.CLO_YN    = 'N'
           AND D2.BASE_YM   = #{mngtYm}
         ORDER BY D1.BLD_NM
    </select>

    <select id="selectItems" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaBuildingBsConsumableDvo">
        SELECT D1.BFSVC_CSMB_DDLV_TP_CD                               /* 배부유형코드 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '1'
                    THEN D1.CSMB_PD_CD
               END                               AS FXN_PD_CD         /* 고정품목코드 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '1'
                    THEN D3.BOX_UNIT_QTY || F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', D3.MNGT_UNIT_CD, #{session.langId})
               END                               AS FXN_PCKNG_UNIT    /* 고정포장단위 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '1'
                    THEN D2.PD_NM
               END                               AS FXN_PD_NM         /* 고정품목명 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '1'
                    THEN TO_CHAR(TO_NUMBER(D2.SAP_MAT_CD))
               END                               AS FXN_SAP_MAT_CD    /* 고정SAP자재코드 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '2'
                    THEN D1.CSMB_PD_CD
               END                               AS APLC_PD_CD        /* 신청품목코드 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '2'
                    THEN D3.BOX_UNIT_QTY || F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', D3.MNGT_UNIT_CD, #{session.langId})
               END                               AS APLC_PCKNG_UNIT   /* 신청포장단위 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '2'
                    THEN D2.PD_NM
               END                               AS APLC_PD_NM        /* 신청품목명 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '2'
                    THEN TO_CHAR(TO_NUMBER(D2.SAP_MAT_CD))
               END                               AS APLC_SAP_MAT_CD   /* 신청SAP자재코드 */
             , NULL                              AS QTY               /* 수량 */
             , D1.CSMB_PD_CD                                          /* 소모품상품코드 */
             , TO_CHAR(TO_NUMBER(D2.SAP_MAT_CD)) AS SAP_MAT_CD        /* SAP자재코드 */
          FROM TB_SVST_BFSVC_CSMB_BASE_DTL D1        /* BS소모품기준상세 */
         INNER JOIN TB_PDBS_PD_BAS D2                /* 상품기본 */
            ON D2.PD_CD = D1.CSMB_PD_CD
         INNER JOIN TB_SVST_BFSVC_CSMB_BASE_BAS D3   /* BS소모품기준기본 */
            ON D3.MNGT_YM    = D1.MNGT_YM
           AND D3.CSMB_PD_CD = D1.CSMB_PD_CD
         WHERE D1.DTA_DL_YN              = 'N'
           AND D1.BFSVC_CSMB_DDLV_OJ_CD  = '3'
           AND D1.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
           AND D2.DTA_DL_YN              = 'N'
           AND D2.PD_TP_CD               = 'M'
           AND D3.DTA_DL_YN              = 'N'
           AND D1.MNGT_YM                = #{mngtYm}
           AND D3.MNGT_YM                = #{mngtYm}
         ORDER BY D1.BFSVC_CSMB_DDLV_TP_CD, D1.SORT_ODR, SAP_MAT_CD
    </select>

    <select id="selectBuildingBsConsumableAplcClose" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaBuildingBsConsumableDto$FindTmlmRes">
        SELECT BIZ_STRTDT
             , SUBSTR(BIZ_STRT_HH, 1, 4) AS BIZ_STRT_HH
             , BIZ_ENDDT
             , SUBSTR(BIZ_END_HH, 1, 4)  AS BIZ_END_HH
          FROM TB_SVST_BIZ_CL_BAS   /* 업무마감기본 */
         WHERE DTA_DL_YN     = 'N'
           AND CL_MNGT_DV_CD = '4'   /* 빌딩BS소모품신청 */
           AND MNGT_YM       = #{mngtYm}
    </select>

    <select id="selectBuildingBsConsumableAplcFirstClose" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaBuildingBsConsumableDto$FindTmlmRes">
          WITH T AS
             (
               SELECT TO_DATE(SUBSTR(HLDY_APPY_START_DTM, 1, 8), 'YYYYMMDD') AS START_DATE
                    , TO_DATE(SUBSTR(HLDY_APPY_FINS_DTM, 1, 8), 'YYYYMMDD')  AS END_DATE
                 FROM T_CMZ_HLDY_M   /* 휴일기본 */
                WHERE DEL_YN    = 'N'
                  AND TENANT_ID = 'TNT_WELLS'
                  AND ( HLDY_APPY_START_DTM LIKE #{mngtYm} || '%' OR HLDY_APPY_FINS_DTM LIKE #{mngtYm} || '%' )
             )
        SELECT MIN(STNRD_YR || STNRD_MN || STNRD_DY) AS BIZ_STRTDT
             , MAX(STNRD_YR || STNRD_MN || STNRD_DY) AS BIZ_ENDDT
             , ''                                    AS BIZ_STRT_HH
             , ''                                    AS BIZ_END_HH
          FROM T_CMY_CALR_M   /* 달력기본 */
         WHERE DEL_YN    = 'N'
           AND TENANT_ID = 'TNT_WELLS'
           AND STNRD_YR  = SUBSTR(#{mngtYm}, 1, 4)
           AND STNRD_MN  = SUBSTR(#{mngtYm}, 5, 2)
           AND STNRD_YR || STNRD_MN || STNRD_DY NOT IN ( SELECT TO_CHAR(START_DATE + LV - 1, 'YYYYMMDD') DT
                                                           FROM T
                                                          INNER JOIN
                                                              (
                                                                SELECT LEVEL LV
                                                                  FROM DUAL
                                                               CONNECT BY LEVEL <![CDATA[<=]]> 99
                                                              ) LV
                                                             ON LV.LV <![CDATA[<=]]> END_DATE - START_DATE + 1 )
    </select>

    <insert id="mergeBuildingBsConsumableAplcClose">
         MERGE INTO TB_SVST_BIZ_CL_BAS TB_TGT   /* 업무마감기본 */
         USING
             (
               SELECT #{mngtYm}            AS MNGT_YM       /* 관리년월 */
                    , #{bizStrtdt}         AS BIZ_STRTDT    /* 업무시작일자 */
                    , #{bizStrtHh} || '00' AS BIZ_STRT_HH   /* 업무시작시간 */
                    , #{bizEnddt}          AS BIZ_ENDDT     /* 업무종료일자 */
                    , #{bizEndHh} || '00'  AS BIZ_END_HH    /* 업무종료시간 */
                 FROM DUAL
             ) TB_SRC
            ON
             (
                   TB_TGT.MNGT_YM       = TB_SRC.MNGT_YM
               AND TB_TGT.CL_MNGT_DV_CD = '4'   /* 빌딩BS소모품신청 */
             )
          WHEN MATCHED THEN
        UPDATE
           SET TB_TGT.BIZ_STRTDT  = TB_SRC.BIZ_STRTDT
             , TB_TGT.BIZ_STRT_HH = TB_SRC.BIZ_STRT_HH
             , TB_TGT.BIZ_ENDDT   = TB_SRC.BIZ_ENDDT
             , TB_TGT.BIZ_END_HH  = TB_SRC.BIZ_END_HH
        <include refid="COMMON.updateSystemField"/>
          WHEN NOT MATCHED THEN
        INSERT
             (
               TB_TGT.MNGT_YM         /* 관리년월 */
             , TB_TGT.CL_MNGT_DV_CD   /* 마감관리구분코드 */
             , TB_TGT.BIZ_STRTDT      /* 업무시작일자 */
             , TB_TGT.BIZ_STRT_HH     /* 업무시작시간 */
             , TB_TGT.BIZ_ENDDT       /* 업무종료일자 */
             , TB_TGT.BIZ_END_HH      /* 업무종료시간 */
             , TB_TGT.DTA_DL_YN       /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             (
               TB_SRC.MNGT_YM
             , '4'
             , TB_SRC.BIZ_STRTDT
             , TB_SRC.BIZ_STRT_HH
             , TB_SRC.BIZ_ENDDT
             , TB_SRC.BIZ_END_HH
             , 'N'
        <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <select id="selectApplicationLimitQty" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaBuildingBsConsumableDto$SearchLmQtyRes">
        SELECT TO_CHAR(TO_NUMBER(D2.SAP_MAT_CD)) AS SAP_MAT_CD
             , NVL(D1.BFSVC_CSMB_APLC_LM_QTY, 0) AS BFSVC_CSMB_APLC_LM_QTY
          FROM TB_SVST_BFSVC_CSMB_BASE_DTL D1   /* BS소모품기준상세 */
         INNER JOIN TB_PDBS_PD_BAS D2           /* 상품기본 */
            ON D2.PD_CD = D1.CSMB_PD_CD
         WHERE D1.DTA_DL_YN              = 'N'
           AND D1.BFSVC_CSMB_DDLV_OJ_CD  = '3'
           AND D1.BFSVC_CSMB_DDLV_TP_CD  = '2'
           AND D1.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
           AND D2.DTA_DL_YN              = 'N'
           AND D2.PD_TP_CD               = 'M'
           AND D1.MNGT_YM                = #{mngtYm}
    </select>

    <select id="selectBuildingBsConsumables" resultType="camelMap">
        SELECT T1.BFSVC_CSMB_DDLV_STAT_CD   /* BS소모품배부상태코드 */
             , T1.REQ_YN                    /* 신청여부 */
             , T1.BLD_CD                    /* 빌딩코드 */
             , T1.BLD_NM                    /* 빌딩명 */
             , T1.RSPP_PRTNR_NO             /* 책임자파트너번호 */
             , T1.VST_CST_N                 /* 방문계정수 */
             , ${pivotColumns}              /* PIVOT 컬럼 */
          FROM
             (
               SELECT /*+ INDEX(D1 PK_OGBS_BLD_BAS) NO_MERGE(D2) */
                      D3.BFSVC_CSMB_DDLV_STAT_CD
                    , CASE WHEN D3.BFSVC_CSMB_DDLV_STAT_CD IS NULL THEN ( SELECT MLNG_CNTN
                                                                            FROM T_CMZ_MLNG_D
                                                                           WHERE MLNG_ID   = 'MSG_TXT_NAPC'   /* 미신청 */
                                                                             AND TENANT_ID = 'TNT_BASE'
                                                                             AND LNG_ID    = #{session.langId} )
                           ELSE F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_CSMB_DDLV_STAT_CD', D3.BFSVC_CSMB_DDLV_STAT_CD, #{session.langId})
                      END                  AS REQ_YN
                    , D1.BLD_CD
                    , D1.BLD_NM
                    , D1.RSPP_PRTNR_NO
                    , NVL(D2.VST_CST_N, 0) AS VST_CST_N
                 FROM TB_OGBS_BLD_BAS D1   /* 빌딩기본 */
                 LEFT OUTER JOIN
                    (
                      SELECT /*+ USE_HASH(S1 S2 S4 S5) */
                             S5.BLD_CD
                           , S5.OG_TP_CD
                           , COUNT(1) AS VST_CST_N
                        FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ S1
                       INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ S2
                          ON S2.ASN_OJ_YM     = S1.ASN_OJ_YM
                         AND S2.CST_SV_ASN_NO = S1.CST_SV_ASN_NO
                       INNER JOIN TB_SVPD_CST_SV_EXCN_IZ S3
                          ON S3.CNTR_NO = S1.CNTR_NO
                         AND S3.CNTR_SN = S1.CNTR_SN
                       INNER JOIN TB_OGBS_MM_PRTNR_IZ S4
                          ON S4.BASE_YM  = S1.ASN_OJ_YM
                         AND S4.OG_TP_CD = S1.CNFM_PSIC_PRTNR_OG_TP_CD
                         AND S4.PRTNR_NO = S1.CNFM_PSIC_PRTNR_NO
                       INNER JOIN TB_OGBS_MM_OG_IZ S5
                          ON S5.BASE_YM  = S4.BASE_YM
                         AND S5.OG_TP_CD = S4.OG_TP_CD
                         AND S5.OG_ID    = S4.OG_ID
                       WHERE S1.DTA_DL_YN                = 'N'
                         AND S1.CNFM_PSIC_PRTNR_OG_TP_CD = 'W02'
                         AND S1.VST_PRGS_STAT_CD IN ('00', '20')
                         AND S2.DTA_DL_YN                = 'N'
                         AND S3.DTA_DL_YN                = 'N'
                         AND S4.DTA_DL_YN                = 'N'
                         AND S4.OG_TP_CD                 = 'W02'
                         AND S5.DTA_DL_YN                = 'N'
                         AND S5.OG_TP_CD                 = 'W02'
                         AND S5.BLD_CD IS NOT NULL
                         AND (    S1.VST_PRGS_STAT_CD = '20'
                               OR ( S1.VST_PRGS_STAT_CD = '00' AND S3.CNTR_DTL_STAT_CD = '101' )
                             )   /* 작업완료이거나 정상인 작업대기 건 */
                         AND S1.ASN_OJ_YM                = #{mngtYm}
                         AND S4.BASE_YM                  = #{mngtYm}
                         AND S5.BASE_YM                  = #{mngtYm}
                       GROUP BY S5.BLD_CD, S5.OG_TP_CD
                    ) D2
                   ON D2.BLD_CD   = D1.BLD_CD
                  AND D2.OG_TP_CD = D1.OG_TP_CD
                 LEFT OUTER JOIN
                    (
                      SELECT STR_WARE_NO
                           , MAX(BFSVC_CSMB_DDLV_STAT_CD) AS BFSVC_CSMB_DDLV_STAT_CD
                        FROM TB_SVST_BFSVC_CSMB_DDLV_IZ   /* BS소모품배부내역 */
                       WHERE DTA_DL_YN             = 'N'
                         AND BFSVC_CSMB_DDLV_OJ_CD = '3'
                         AND MNGT_YM               = #{mngtYm}
                       GROUP BY STR_WARE_NO
                    ) D3
                   ON D3.STR_WARE_NO = D1.BLD_CD
                WHERE D1.DTA_DL_YN           = 'N'
                  AND D1.OG_TP_CD            = 'W02'
                  AND D1.RSPP_PRTNR_NO IS NOT NULL
            <if test="@MybatisUtils@isNotEmpty(bldCds)">
                  AND D1.BLD_CD IN
                            <foreach collection="bldCds" item="item" open="(" close=")" separator=",">
                                    #{item}
                            </foreach>
            </if>
             ) T1
          LEFT OUTER JOIN
             (
               SELECT *
                 FROM
                    (
                      SELECT /*+ NO_MERGE(S1) */
                             NVL(S2.STR_WARE_NO, S1.STR_WARE_NO)                      AS STR_WARE_NO
                           , TO_CHAR(TO_NUMBER(NVL(S2.SAP_MAT_CD, S1.SAP_MAT_CD)))    AS SAP_MAT_CD
                           , NVL(S2.BFSVC_CSMB_DDLV_QTY, S1.BFSVC_CSMB_DDLV_UNIT_QTY) AS BFSVC_CSMB_DDLV_UNIT_QTY
                        FROM
                           (
                             SELECT /*+ USE_HASH(D1 D2 D4) NO_MERGE(D4) */
                                    D1.BLD_CD AS STR_WARE_NO
                                  , D2.CSMB_PD_CD
                                  , D3.SAP_MAT_CD
                                  , CASE WHEN D2.BFSVC_CSMB_DDLV_CMPT_BASE_CD = '2'
                                         THEN NVL(D2.BFSVC_CSMB_DDLV_UNIT_QTY, 0)
                                         WHEN D2.BFSVC_CSMB_DDLV_CMPT_BASE_CD = '1'
                                          AND D2.BFSVC_CSMB_DDLV_UNIT_ACC_N <![CDATA[<>]]> 0
                                         THEN NVL( CEIL( SUM(D4.CNT) / D2.BFSVC_CSMB_DDLV_UNIT_ACC_N * D2.BFSVC_CSMB_DDLV_UNIT_QTY), 0)
                                         ELSE 0
                                    END       AS BFSVC_CSMB_DDLV_UNIT_QTY
                               FROM TB_OGBS_MM_OG_IZ D1                   /* 월조직내역 */
                              INNER JOIN TB_SVST_BFSVC_CSMB_BASE_DTL D2   /* BS소모품기준상세 */
                                 ON D2.MNGT_YM = D1.BASE_YM
                              INNER JOIN TB_PDBS_PD_BAS D3                /* 상품기본 */
                                 ON D3.PD_CD = D2.CSMB_PD_CD
                               LEFT OUTER JOIN
                                  (
                                    SELECT /*+ USE_HASH(S1 S2 O1 O2)  */
                                           O2.BLD_CD
                                         , S4.COPN_DV_CD
                                         , S5.PD_PRP_VAL20
                                         , COUNT(1) AS CNT
                                      FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ S1       /* 고객서비스BS배정내역 */
                                     INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ S2   /* 고객서비스BS대상내역 */
                                        ON S2.ASN_OJ_YM     = S1.ASN_OJ_YM
                                       AND S2.CST_SV_ASN_NO = S1.CST_SV_ASN_NO
                                     INNER JOIN TB_SVPD_CST_SV_EXCN_IZ S3       /* 고객서비스수행내역 */
                                        ON S3.CNTR_NO = S1.CNTR_NO
                                       AND S3.CNTR_SN = S1.CNTR_SN
                                     INNER JOIN TB_SSCT_CNTR_BAS S4             /* 계약기본 */
                                        ON S4.CNTR_NO = S1.CNTR_NO
                                     INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S5      /* 상품각사속성상세 */
                                        ON S5.PD_CD = S2.PDCT_PD_CD
                                     INNER JOIN TB_OGBS_MM_PRTNR_IZ O1          /* 월파트너내역 */
                                        ON O1.BASE_YM  = S1.ASN_OJ_YM
                                       AND O1.OG_TP_CD = S1.CNFM_PSIC_PRTNR_OG_TP_CD
                                       AND O1.PRTNR_NO = S1.CNFM_PSIC_PRTNR_NO
                                     INNER JOIN TB_OGBS_MM_OG_IZ O2             /* 월조직내역 */
                                        ON O2.BASE_YM  = O1.BASE_YM
                                       AND O2.OG_TP_CD = O1.OG_TP_CD
                                       AND O2.OG_ID    = O1.OG_ID
                                     WHERE S1.DTA_DL_YN                = 'N'
                                       AND S1.CNFM_PSIC_PRTNR_OG_TP_CD = 'W02'
                                       AND S1.VST_PRGS_STAT_CD        IN ('00', '20')
                                       AND S2.DTA_DL_YN                = 'N'
                                       AND S3.DTA_DL_YN                = 'N'
                                       AND S4.DTA_DL_YN                = 'N'
                                       AND S5.DTA_DL_YN                = 'N'
                                       AND S5.PD_EXTS_PRP_GRP_CD       = 'PART'
                                       AND O1.DTA_DL_YN                = 'N'
                                       AND O1.OG_TP_CD                 = 'W02'
                                       AND O2.DTA_DL_YN                = 'N'
                                       AND O2.OG_TP_CD                 = 'W02'
                                       AND O2.BLD_CD IS NOT NULL
                                       AND (    S1.VST_PRGS_STAT_CD = '20'
                                             OR ( S1.VST_PRGS_STAT_CD = '00' AND S3.CNTR_DTL_STAT_CD = '101' )
                                           )   /* 작업완료이거나 정상인 작업대기 건 */
                                       AND S1.ASN_OJ_YM                = #{mngtYm}
                                       AND S2.ASN_OJ_YM                = #{mngtYm}
                                       AND O1.BASE_YM                  = #{mngtYm}
                                       AND O2.BASE_YM                  = #{mngtYm}
                                     GROUP BY O2.BLD_CD, S4.COPN_DV_CD, S5.PD_PRP_VAL20
                                  ) D4
                                 ON D4.BLD_CD       = D1.BLD_CD
                                AND D4.COPN_DV_CD   = NVL(D2.BFSVC_CSMB_DDLV_OJ_ACC_TP_CD, D4.COPN_DV_CD)
                                AND D4.PD_PRP_VAL20 = NVL(D2.BFSVC_CSMB_DDLV_OJ_PD_GRP_CD, D4.PD_PRP_VAL20)
                              WHERE D1.DTA_DL_YN              = 'N'
                                AND D1.OG_TP_CD               = 'W02'
                                AND D2.DTA_DL_YN              = 'N'
                                AND D2.BFSVC_CSMB_DDLV_OJ_CD  = '3'
                                AND D2.BFSVC_CSMB_DDLV_TP_CD  = '1'
                                AND D2.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
                                AND D3.DTA_DL_YN              = 'N'
                                AND D3.PD_TP_CD               = 'M'
                                AND D1.BLD_CD IS NOT NULL
                                AND D1.BASE_YM                = #{mngtYm}
                                AND D2.MNGT_YM                = #{mngtYm}
                              GROUP BY D1.BLD_CD, D2.CSMB_PD_CD, D3.SAP_MAT_CD, D2.BFSVC_CSMB_DDLV_CMPT_BASE_CD
                                  , NVL(D2.BFSVC_CSMB_DDLV_UNIT_QTY, 0), D2.BFSVC_CSMB_DDLV_UNIT_ACC_N, D2.BFSVC_CSMB_DDLV_UNIT_QTY
                              UNION ALL
                             SELECT /*+ USE_HASH(D1 D2) */
                                    D2.BLD_CD AS STR_WARE_NO
                                  , D1.CSMB_PD_CD
                                  , D3.SAP_MAT_CD
                                  , 0         AS BFSVC_CSMB_DDLV_UNIT_QTY
                               FROM TB_SVST_BFSVC_CSMB_BASE_DTL D1   /* BS소모품기준상세 */
                              INNER JOIN TB_OGBS_MM_OG_IZ D2         /* 월조직내역 */
                                 ON D2.BASE_YM  = D1.MNGT_YM
                              INNER JOIN TB_PDBS_PD_BAS D3           /* 상품기본 */
                                 ON D3.PD_CD = D1.CSMB_PD_CD
                              WHERE D1.DTA_DL_YN              = 'N'
                                AND D1.BFSVC_CSMB_DDLV_OJ_CD  = '3'
                                AND D1.BFSVC_CSMB_DDLV_TP_CD  = '2'
                                AND D1.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
                                AND D2.DTA_DL_YN              = 'N'
                                AND D2.OG_TP_CD               = 'W02'
                                AND D3.DTA_DL_YN              = 'N'
                                AND D3.PD_TP_CD               = 'M'
                                AND D2.BLD_CD IS NOT NULL
                                AND D1.MNGT_YM                = #{mngtYm}
                                AND D2.BASE_YM                = #{mngtYm}
                           ) S1
                        LEFT OUTER JOIN
                           (
                             SELECT STR_WARE_NO
                                  , CSMB_PD_CD
                                  , SAP_MAT_CD
                                  , NVL(BFSVC_CSMB_DDLV_QTY, 0) AS BFSVC_CSMB_DDLV_QTY
                               FROM TB_SVST_BFSVC_CSMB_DDLV_IZ   /* BS소모품배부내역 */
                              WHERE DTA_DL_YN             = 'N'
                                AND BFSVC_CSMB_DDLV_OJ_CD = '3'
                                AND MNGT_YM               = #{mngtYm}
                           ) S2
                          ON S2.STR_WARE_NO = S1.STR_WARE_NO
                         AND S2.CSMB_PD_CD  = S1.CSMB_PD_CD
                    ) DDLV
                PIVOT
                    (
                          SUM(BFSVC_CSMB_DDLV_UNIT_QTY)
                      FOR SAP_MAT_CD IN (${pivotInStr})
                    )
             ) T2
            ON T2.STR_WARE_NO = T1.BLD_CD
         ORDER BY T1.BLD_NM
    </select>

    <insert id="mergeBuildingBsConsumables">
         MERGE INTO TB_SVST_BFSVC_CSMB_DDLV_IZ TB_TGT   /* BS소모품배부내역 */
         USING
             (
               SELECT #{mngtYm}                  AS MNGT_YM
                    , #{bfsvcCsmbDdlvOjCd}       AS BFSVC_CSMB_DDLV_OJ_CD
                    , #{strWareNo}               AS STR_WARE_NO
                    , #{csmbPdCd}                AS CSMB_PD_CD
                    , LPAD(#{sapMatCd}, 18, '0') AS SAP_MAT_CD
                    , #{bfsvcCsmbDdlvQty}        AS BFSVC_CSMB_DDLV_QTY
                    , #{bfsvcCsmbDdlvStatCd}     AS BFSVC_CSMB_DDLV_STAT_CD
                 FROM DUAL
             ) TB_SRC
            ON
             (
                   TB_TGT.MNGT_YM               = TB_SRC.MNGT_YM
               AND TB_TGT.BFSVC_CSMB_DDLV_OJ_CD = TB_SRC.BFSVC_CSMB_DDLV_OJ_CD
               AND TB_TGT.STR_WARE_NO           = TB_SRC.STR_WARE_NO
               AND TB_TGT.CSMB_PD_CD            = TB_SRC.CSMB_PD_CD
             )
          WHEN MATCHED THEN
        UPDATE
           SET TB_TGT.SAP_MAT_CD              = TB_SRC.SAP_MAT_CD
             , TB_TGT.BFSVC_CSMB_DDLV_QTY     = TB_SRC.BFSVC_CSMB_DDLV_QTY
             , TB_TGT.BFSVC_CSMB_DDLV_STAT_CD = TB_SRC.BFSVC_CSMB_DDLV_STAT_CD
        <include refid="COMMON.updateSystemField"/>
          WHEN NOT MATCHED THEN
        INSERT
             (
               TB_TGT.MNGT_YM
             , TB_TGT.BFSVC_CSMB_DDLV_OJ_CD
             , TB_TGT.STR_WARE_NO
             , TB_TGT.CSMB_PD_CD
             , TB_TGT.SAP_MAT_CD
             , TB_TGT.BFSVC_CSMB_DDLV_QTY
             , TB_TGT.BFSVC_CSMB_DDLV_STAT_CD
             , TB_TGT.DTA_DL_YN
        <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             (
               TB_SRC.MNGT_YM
             , TB_SRC.BFSVC_CSMB_DDLV_OJ_CD
             , TB_SRC.STR_WARE_NO
             , TB_SRC.CSMB_PD_CD
             , TB_SRC.SAP_MAT_CD
             , TB_SRC.BFSVC_CSMB_DDLV_QTY
             , TB_SRC.BFSVC_CSMB_DDLV_STAT_CD
             , 'N'
        <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <select id="selectBfsvcCsmbDdlvIzByMngtYm" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaBuildingBsConsumableDvo">
        SELECT S1.MNGT_YM
             , S1.BFSVC_CSMB_DDLV_OJ_CD
             , S1.STR_WARE_NO
             , S1.CSMB_PD_CD
             , S1.SAP_MAT_CD
             , S1.BFSVC_CSMB_DDLV_QTY
             , S1.BFSVC_CSMB_DDLV_STAT_CD
             , S1.OSTR_AK_NO
             , S1.OSTR_AK_SN
          FROM TB_SVST_BFSVC_CSMB_DDLV_IZ S1
         WHERE BFSVC_CSMB_DDLV_STAT_CD = '20'
           AND BFSVC_CSMB_DDLV_OJ_CD   = '3'
           AND BFSVC_CSMB_DDLV_QTY <![CDATA[>]]> 0
           AND MNGT_YM                 = #{mngtYm}
           AND STR_WARE_NO             = #{strWareNo}
    </select>

    <select id="selectNewOstrAkNo" resultType="String">
        SELECT #{ostrAkTpCd} || #{ostrAkRgstDt} || LPAD(SQ_SVST_ITM_OSTR_AK_IZ$OSTR_AK_NO.NEXTVAL,7,'0') AS OSTR_AK_NO
          FROM DUAL
    </select>

    <update id="updateBfsvcCsmbDdlvIzOstrAkNoSn">
        UPDATE TB_SVST_BFSVC_CSMB_DDLV_IZ
           SET OSTR_AK_NO = #{ostrAkNo}
             , OSTR_AK_SN = #{ostrAkSn}
        <include refid="COMMON.updateSystemField"/>
         WHERE MNGT_YM               = #{mngtYm}
           AND BFSVC_CSMB_DDLV_OJ_CD = #{bfsvcCsmbDdlvOjCd}
           AND STR_WARE_NO           = #{strWareNo}
           AND CSMB_PD_CD            = #{csmbPdCd}
    </update>

    <update id="updateBfsvcCsmbDdlvIzDdlvStatCd">
        UPDATE TB_SVST_BFSVC_CSMB_DDLV_IZ
           SET BFSVC_CSMB_DDLV_STAT_CD = '30'
        <include refid="COMMON.updateSystemField"/>
         WHERE BFSVC_CSMB_DDLV_OJ_CD = '3'
           AND MNGT_YM               = #{mngtYm}
           AND STR_WARE_NO           = #{strWareNo}
    </update>


</mapper>
