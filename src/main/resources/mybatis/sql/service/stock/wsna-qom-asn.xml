<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaQomAsnMapper">

    <select id="selectQomAsnOstrWares" resultType="com.kyowon.sms.wells.web.service.common.dvo.WsnzWellsCodeWareHouseDvo">
        SELECT WARE_NO   /* 창고번호 */
             , WARE_NM   /* 창고명 */
          FROM TB_SVST_MCBY_WARE_IZ   /* 월별창고내역 */
         WHERE DTA_DL_YN   = 'N'
           AND WARE_NO    IN ('100002', '100008')   /* 파주, 성수 물류센터 */
           AND APY_YM      = #{apyYm}
    </select>

    <select id="selectQomAsnStrWares" resultType="com.kyowon.sms.wells.web.service.common.dvo.WsnzWellsCodeWareHouseDvo">
        SELECT D1.WARE_NO
             , D1.WARE_NM
          FROM TB_SVST_MCBY_WARE_IZ D1   /* 월별창고내역 */
         INNER JOIN
             (
               SELECT DISTINCT STR_WARE_NO   /* 입고창고번호 */
                 FROM TB_SVST_ITM_QOM_ASN_IZ   /* 품목물량배정내역 */
                WHERE DTA_DL_YN = 'N'
                  AND ASN_OJ_YM = #{apyYm}
             ) D2
            ON D2.STR_WARE_NO = D1.WARE_NO
         WHERE D1.DTA_DL_YN      = 'N'
           AND D1.APY_YM         = #{apyYm}
           AND D1.WARE_DV_CD     = #{wareDvCd}
           AND D1.WARE_DTL_DV_CD = #{wareDtlDvCd}
         ORDER BY D1.WARE_USE_YN DESC, TO_NUMBER(D1.SORT_DV_VAL), D1.WARE_NO
    </select>

    <select id="selectQomAsnCount" resultType="java.lang.Integer">
        SELECT 1
          FROM TB_SVST_ITM_QOM_ASN_IZ   /* 품목물량배정내역 */
         WHERE DTA_DL_YN = 'N'
           AND ASN_OJ_YM = #{asnOjYm}
           AND ASN_TN_N  = #{cnt}
           AND ROWNUM    = 1
    </select>

    <sql id="selectWithTwQty1">
          WITH TW_QTY1 AS   /* 금주 수량 계산 */
             (
               SELECT D1.CNFM_PSIC_PRTNR_NO AS PRTNR_NO
                    , D3.PU_PART_PD_CD      AS PD_CD
                    , SUM(D3.PU_QTY)        AS QTY
                 FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ D1       /* 고객서비스BS배정내역 */
                INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D2   /* 고객서비스BS대상내역 */
                   ON D2.CST_SV_ASN_NO = D1.CST_SV_ASN_NO
                INNER JOIN TB_SVPD_RGBS_PU_ITM_IZ D3       /* 정기BS투입품목내역 */
                   ON D3.ASN_OJ_YM  = D2.ASN_OJ_YM
                  AND D3.CNTR_NO    = D2.CNTR_NO
                  AND D3.CNTR_SN    = D2.CNTR_SN
                  AND D3.PDCT_PD_CD = D2.PDCT_PD_CD
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D4       /* 고객서비스수행내역 */
                   ON D4.CNTR_NO = D1.CNTR_NO
                  AND D4.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN = 'N'
                  AND D2.DTA_DL_YN = 'N'
                  AND D3.DTA_DL_YN = 'N'
                  AND D4.DTA_DL_YN = 'N'
                  AND D1.VST_PRGS_STAT_CD <![CDATA[<>]]> '20'
                  AND D4.CNTR_DTL_STAT_CD <![CDATA[<>]]> '303'   /* 계약취소 */
                  AND D4.REQD_DT IS NULL
                  AND D4.CPS_DT IS NULL
                  AND D1.ASN_OJ_YM = #{apyYm}
                GROUP BY D1.CNFM_PSIC_PRTNR_NO, D3.PU_PART_PD_CD
             )
    </sql>

    <select id="selectQomAsnFirstTnIndividualsForCreate" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaQomAsnCreateDvo">
        <include refid="selectWithTwQty1" />
        SELECT #{asnOjYm}                                           AS ASN_OJ_YM
             , #{cnt}                                               AS ASN_TN_N
             , T1.STR_WARE_NO
             , #{ostrWareNo}                                        AS OSTR_WARE_NO
             , T1.ITM_PD_CD
             , #{wareDvCd}                                          AS WARE_DV_CD
             , #{wareDtlDvCd}                                       AS WARE_DTL_DV_CD
             , T1.SPP_DV_CD
             , T1.WARE_MNGT_PRTNR_NO
             , T1.OG_TP_CD
             , T1.BLD_CD
             , T1.ADR_ID
             , 'A'                                                  AS MAT_GD_CD
             , T1.GE_ASN_QOM_CT
             , T1.CRP_ASN_QOM_CT
             , NVL(T1.GE_ASN_QOM_CT, 0) + NVL(T1.CRP_ASN_QOM_CT, 0) AS WO_ASN_QOM_CT
             , T1.ETN_WTCF_APY_QTY
             , ( SELECT NVL( SUM(ACL_OSTR_QTY), 0 )
                   FROM TB_SVST_ITM_QOM_ASN_IZ
                  WHERE STR_WARE_NO = T1.STR_WARE_NO
                    AND ITM_PD_CD   = T1.ITM_PD_CD
                    AND DTA_DL_YN   = 'N'
                   AND ASN_OJ_YM   = #{asnOjYm} )                   AS MCBY_ACU_OSTR_QTY
             , 0                                                    AS CRTL_STOC_QTY
             , NVL( ( SELECT QTY
                        FROM TW_QTY1
                       WHERE PRTNR_NO = T1.WARE_MNGT_PRTNR_NO
                         AND PD_CD    = T1.ITM_PD_CD ), 0)          AS THWK_EXP_QTY
             , 0 AS BORR_EXP_QTY
             , CASE WHEN T1.ITM_PD_CD IN ('WM07104793', 'WM07104794', 'WM07104795', 'WM07104796', 'WM07104797', 'WM07104798', 'WM07105097')
                    THEN NVL(T1.ETN_WTCF_APY_QTY, 0) + MOD(T1.ETN_WTCF_APY_QTY, 2)
                    ELSE T1.ETN_WTCF_APY_QTY
               END                                                  AS CNFM_QTY
             , CASE WHEN T1.BOX_QTY <![CDATA[>]]> 0 THEN T1.BOX_QTY * CEIL( GREATEST( ( SELECT QTY
                                                                                          FROM TW_QTY1
                                                                                         WHERE PRTNR_NO = T1.WARE_MNGT_PRTNR_NO
                                                                                           AND PD_CD    = T1.ITM_PD_CD ), T1.ETN_WTCF_APY_QTY, 0 ) / T1.BOX_QTY ) / T1.BOX_QTY
                    ELSE 0
               END                                                  AS BOX_UNIT_QTY
             , 0                                                    AS ACL_OSTR_QTY
             , 0                                                    AS BFSVC_FSH_CT
          FROM
             (
               SELECT QOM.STR_WARE_NO
                    , QOM.ITM_PD_CD
                    , QOM.SPP_DV_CD
                    , QOM.WARE_MNGT_PRTNR_NO
                    , QOM.OG_TP_CD
                    , QOM.BLD_CD
                    , QOM.ADR_ID
                    , SUM(QOM.GE_ASN_QOM_CT)                       AS GE_ASN_QOM_CT
                    , SUM(QOM.CRP_ASN_QOM_CT)                      AS CRP_ASN_QOM_CT
                    , QOM.BOX_QTY
                    , CASE WHEN QOM.ITM_KND_CD <![CDATA[<>]]> '5' THEN SUM(QOM.GE_ASN_QOM_CT)
                           WHEN QOM.BLD_CD NOT IN ('885', '951')  THEN CASE WHEN SUM(QOM.GE_ASN_QOM_CT) <![CDATA[<]]> 5
                                                                            THEN SUM(QOM.GE_ASN_QOM_CT)
                                                                            ELSE ROUND(SUM(QOM.GE_ASN_QOM_CT) * 0.4, 0)
                                                                       END
                           ELSE SUM(QOM.GE_ASN_QOM_CT)
                      END + SUM(QOM.CRP_ASN_QOM_CT)                AS ETN_WTCF_APY_QTY
                 FROM
                    (
                      SELECT D7.WARE_NO             AS STR_WARE_NO
                           , D1.PART_PD_CD          AS ITM_PD_CD
                           , D7.DIDY_DV_CD          AS SPP_DV_CD
                           , D3.MNGT_PRTNR_NO       AS WARE_MNGT_PRTNR_NO
                           , D3.MNGT_PRTNR_OG_TP_CD AS OG_TP_CD
                           , D9.BLD_CD
                           , D7.WARE_ADR_ID         AS ADR_ID
                           , CASE WHEN D5.COPN_DV_CD = '1' THEN D1.PART_USE_QTY
                                  ELSE 0
                             END                    AS GE_ASN_QOM_CT
                           , CASE WHEN D5.COPN_DV_CD = '2' THEN D1.PART_USE_QTY
                                  ELSE 0
                             END                    AS CRP_ASN_QOM_CT
                           , CASE WHEN D1.PART_PD_CD IN ('WM07103020', 'WM07105668') THEN NVL(TO_NUMBER(D6.PD_PRP_VAL12), 0)
                                  ELSE 0
                             END                    AS BOX_QTY
                           , D6.PD_PRP_VAL19        AS ITM_KND_CD
                        FROM TB_SVPD_CST_SV_RGBSPR_IZ D1          /* 고객서비스정기BS주기내역 */
                       INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2       /* 고객서비스수행내역 */
                          ON D2.CNTR_NO = D1.CNTR_NO
                         AND D2.CNTR_SN = D1.CNTR_SN
                       INNER JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ D3    /* 월별고객서비스대상내역 */
                          ON D3.CNTR_NO = D2.CNTR_NO
                         AND D3.CNTR_SN = D2.CNTR_SN
                       INNER JOIN TB_SSCT_CNTR_CST_REL D4         /* 계약고객관계 */
                          ON D4.DTL_CNTR_NO = D1.CNTR_NO
                         AND D4.DTL_CNTR_SN = D1.CNTR_SN
                       INNER JOIN TB_CUBS_CST_BAS D5              /* 고객기본 */
                          ON D5.CST_NO = D4.CST_NO
                       INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D6      /* 상품각사속성상세 */
                          ON D6.PD_CD = D1.PART_PD_CD
                       INNER JOIN TB_SVST_MCBY_WARE_IZ D7         /* 월별창고내역 */
                          ON D7.APY_YM             = D3.MNGT_YM
                         AND D7.OG_TP_CD           = D3.MNGT_PRTNR_OG_TP_CD
                         AND D7.WARE_MNGT_PRTNR_NO = D3.MNGT_PRTNR_NO
                       INNER JOIN TB_OGBS_MM_PRTNR_IZ D8          /* 월파트너내역 */
                          ON D8.BASE_YM  = D3.MNGT_YM
                         AND D8.OG_TP_CD = D3.MNGT_PRTNR_OG_TP_CD
                         AND D8.PRTNR_NO = D3.MNGT_PRTNR_NO
                       INNER JOIN TB_OGBS_MM_OG_IZ D9             /* 월조직내역 */
                          ON D9.BASE_YM  = D8.BASE_YM
                         AND D9.OG_ID    = D8.OG_ID
                         AND D9.OG_TP_CD = D8.OG_TP_CD
                       WHERE D1.DTA_DL_YN          = 'N'
                         AND D2.DTA_DL_YN          = 'N'
                         AND D3.DTA_DL_YN          = 'N'
                         AND D4.DTA_DL_YN          = 'N'
                         AND D4.CNTR_CST_REL_TP_CD = '10'    /* 계약자 */
                         AND D5.DTA_DL_YN          = 'N'
                         AND D6.DTA_DL_YN          = 'N'
                         AND D6.PD_EXTS_PRP_GRP_CD = 'PART'
                         AND D7.DTA_DL_YN          = 'N'
                         AND D7.WARE_USE_YN        = 'Y'
                         AND D8.DTA_DL_YN          = 'N'
                         AND D9.DTA_DL_YN          = 'N'
                         AND D1.VST_DV_CD LIKE '1%'
                         AND D1.VST_DV_CD <![CDATA[<>]]> '13'
                         AND D1.PART_USE_QTY <![CDATA[>]]> 0
                         AND D8.PSTN_DV_CD <![CDATA[<>]]> '4'
                         AND D7.DIDY_DV_CD <![CDATA[<>]]> '2'
                         AND D2.REQD_DT IS NULL
                         AND D2.CPS_DT IS NULL
                         AND D2.CNTR_DTL_STAT_CD NOT IN ('201', '202', '203', '303')   /* 고객요청정지, 연체정지, 해약접수정지, 계약취소 */
                         AND D1.PART_PD_CD NOT IN ('WM07105924', 'WM07105925', 'WM07106025', 'WM07106030', 'WM07106035', 'WM07104436', 'WM07105952', 'WM07105745'
                                                 , 'WM07105746', 'WM07105747', 'WM07105748', 'WM07102129', 'WM07105703', 'WM07105704', 'WM07105705')
                         AND ( D6.PD_PRP_VAL20 IS NULL OR D6.PD_PRP_VAL20 <![CDATA[<>]]> '11' )
                         AND D3.MNGT_YM            = #{apyYm}
                         AND D7.WARE_DV_CD         = #{wareDvCd}
                         AND D7.WARE_DTL_DV_CD     = #{wareDtlDvCd}
                         AND D1.VST_DUEDT LIKE #{asnOjYm} || '%'
                         AND NOT EXISTS ( SELECT 1
                                            FROM TB_SVPD_SLF_MNGT_SPP_STP_AK_IZ S1   /* 자가관리배송중지요청내역 */
                                           WHERE S1.CNTR_NO       = D1.CNTR_NO
                                             AND S1.CNTR_SN       = D1.CNTR_SN
                                             AND S1.DTA_DL_YN     = 'N'
                                             AND S1.SPP_STP_DV_CD = 'B'
                                             AND S1.AK_SN         = ( SELECT MAX(AK_SN)
                                                                        FROM TB_SVPD_SLF_MNGT_SPP_STP_AK_IZ
                                                                       WHERE CNTR_NO   = S1.CNTR_NO
                                                                         AND CNTR_SN   = S1.CNTR_SN
                                                                         AND DTA_DL_YN = 'N' ) )
                    ) QOM
                GROUP BY QOM.STR_WARE_NO, QOM.ITM_PD_CD, QOM.SPP_DV_CD, QOM.WARE_MNGT_PRTNR_NO, QOM.OG_TP_CD, QOM.BLD_CD, QOM.ADR_ID, QOM.BOX_QTY, QOM.ITM_KND_CD
             ) T1
         WHERE NOT EXISTS ( SELECT 1
                              FROM TB_SVST_QOM_ASN_EXCD_IZ   /* 물량배정제외내역 */
                             WHERE ITM_PD_CD = T1.ITM_PD_CD
                               AND (    ( ASN_EXCD_DV_CD = '0' AND STR_WARE_NO = '300000' )
                                     OR ( ASN_EXCD_DV_CD = '3' AND STR_WARE_NO = T1.STR_WARE_NO )
                                   ) )
           AND NOT EXISTS ( SELECT 1
                              FROM TB_SVST_QOM_ASN_PRTNR_APY_IZ S1   /* 물량배정파트너적용내역 */
                             WHERE S1.PRTNR_NO       = T1.WARE_MNGT_PRTNR_NO
                               AND S1.OG_TP_CD       = T1.OG_TP_CD
                               AND S1.DTA_DL_YN      = 'N'
                               AND S1.QOM_ASN_APY_YN = 'N'
                               AND S1.APY_SN         = ( SELECT MAX(APY_SN)
                                                           FROM TB_SVST_QOM_ASN_PRTNR_APY_IZ
                                                          WHERE PRTNR_NO = S1.PRTNR_NO
                                                            AND OG_TP_CD = S1.OG_TP_CD ) )
    </select>

    <select id="selectQomAsnIndividualsForCreate" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaQomAsnCreateDvo">
        <include refid="selectWithTwQty1" />
             , TW_QTY2 AS
             (
               SELECT D1.CNFM_PSIC_PRTNR_NO AS PRTNR_NO
                    , D3.PU_PART_PD_CD      AS PD_CD
                    , SUM(D3.PU_QTY)        AS QTY
                 FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ D1       /* 고객서비스BS배정내역 */
                INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D2   /* 고객서비스BS대상내역 */
                   ON D2.CST_SV_ASN_NO = D1.CST_SV_ASN_NO
                INNER JOIN TB_SVPD_RGBS_PU_ITM_IZ D3       /* 정기BS투입품목내역 */
                   ON D3.ASN_OJ_YM  = D2.ASN_OJ_YM
                  AND D3.CNTR_NO    = D2.CNTR_NO
                  AND D3.CNTR_SN    = D2.CNTR_SN
                  AND D3.PDCT_PD_CD = D2.PDCT_PD_CD
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D4       /* 고객서비스수행내역 */
                   ON D4.CNTR_NO = D1.CNTR_NO
                  AND D4.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN = 'N'
                  AND D2.DTA_DL_YN = 'N'
                  AND D3.DTA_DL_YN = 'N'
                  AND D4.DTA_DL_YN = 'N'
                  AND D1.VST_PRGS_STAT_CD <![CDATA[<>]]> '20'
                  AND D4.CNTR_DTL_STAT_CD <![CDATA[<>]]> '303'   /* 계약취소 */
                  AND D4.REQD_DT IS NULL
                  AND D4.CPS_DT IS NULL
                  AND D1.ASN_OJ_YM = #{asnOjYm}
                  AND TO_CHAR(TO_DATE(D1.VST_CNFMDT, 'YYYYMMDD'), 'W') = TO_CHAR(SYSDATE, 'W')
                GROUP BY D1.CNFM_PSIC_PRTNR_NO, D3.PU_PART_PD_CD
             )
             , NW_QTY1 AS
             (
               SELECT D1.CNFM_PSIC_PRTNR_NO AS PRTNR_NO
                    , D3.PU_PART_PD_CD      AS PD_CD
                    , SUM(D3.PU_QTY)        AS QTY
                 FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ D1       /* 고객서비스BS배정내역 */
                INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D2   /* 고객서비스BS대상내역 */
                   ON D2.CST_SV_ASN_NO = D1.CST_SV_ASN_NO
                INNER JOIN TB_SVPD_RGBS_PU_ITM_IZ D3       /* 정기BS투입품목내역 */
                   ON D3.ASN_OJ_YM  = D2.ASN_OJ_YM
                  AND D3.CNTR_NO    = D2.CNTR_NO
                  AND D3.CNTR_SN    = D2.CNTR_SN
                  AND D3.PDCT_PD_CD = D2.PDCT_PD_CD
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D4       /* 고객서비스수행내역 */
                   ON D4.CNTR_NO = D1.CNTR_NO
                  AND D4.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN = 'N'
                  AND D2.DTA_DL_YN = 'N'
                  AND D3.DTA_DL_YN = 'N'
                  AND D4.DTA_DL_YN = 'N'
                  AND D1.VST_PRGS_STAT_CD <![CDATA[<>]]> '20'
                  AND D4.CNTR_DTL_STAT_CD <![CDATA[<>]]> '303'   /* 계약취소 */
                  AND D4.REQD_DT IS NULL
                  AND D4.CPS_DT IS NULL
                  AND D1.ASN_OJ_YM = #{asnOjYm}
                  AND TO_CHAR(TO_DATE(D1.VST_CNFMDT, 'YYYYMMDD'), 'W') = TO_CHAR(SYSDATE + 7, 'W')
                GROUP BY D1.CNFM_PSIC_PRTNR_NO, D3.PU_PART_PD_CD
             )
             , BS_QTY1 AS
             (
               SELECT D1.CNFM_PSIC_PRTNR_NO AS PRTNR_NO
                    , D3.PU_PART_PD_CD      AS PD_CD
                    , SUM(D3.PU_QTY)        AS QTY
                 FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ D1       /* 고객서비스BS배정내역 */
                INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D2   /* 고객서비스BS대상내역 */
                   ON D2.CST_SV_ASN_NO = D1.CST_SV_ASN_NO
                INNER JOIN TB_SVPD_RGBS_PU_ITM_IZ D3       /* 정기BS투입품목내역 */
                   ON D3.ASN_OJ_YM  = D2.ASN_OJ_YM
                  AND D3.CNTR_NO    = D2.CNTR_NO
                  AND D3.CNTR_SN    = D2.CNTR_SN
                  AND D3.PDCT_PD_CD = D2.PDCT_PD_CD
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D4       /* 고객서비스수행내역 */
                   ON D4.CNTR_NO = D1.CNTR_NO
                  AND D4.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D3.DTA_DL_YN        = 'N'
                  AND D4.DTA_DL_YN        = 'N'
                  AND D1.VST_PRGS_STAT_CD = '20'
                  AND D4.CNTR_DTL_STAT_CD <![CDATA[<>]]> '303'   /* 계약취소 */
                  AND D4.REQD_DT IS NULL
                  AND D4.CPS_DT IS NULL
                  AND D1.ASN_OJ_YM        = #{asnOjYm}
                  AND TO_CHAR(TO_DATE(D1.VST_CNFMDT, 'YYYYMMDD'), 'W') = TO_CHAR(SYSDATE, 'W')
                GROUP BY D1.CNFM_PSIC_PRTNR_NO, D3.PU_PART_PD_CD
             )
        SELECT #{asnOjYm}                                           AS ASN_OJ_YM
             , #{cnt}                                               AS ASN_TN_N
             , T1.STR_WARE_NO
             , #{ostrWareNo}                                        AS OSTR_WARE_NO
             , T1.ITM_PD_CD
             , #{wareDvCd}                                          AS WARE_DV_CD
             , #{wareDtlDvCd}                                       AS WARE_DTL_DV_CD
             , T1.SPP_DV_CD
             , T1.WARE_MNGT_PRTNR_NO
             , T1.OG_TP_CD
             , T1.BLD_CD
             , T1.ADR_ID
             , 'A'                                                  AS MAT_GD_CD
             , T1.GE_ASN_QOM_CT
             , T1.CRP_ASN_QOM_CT
             , NVL(T1.GE_ASN_QOM_CT, 0) + NVL(T1.CRP_ASN_QOM_CT, 0) AS WO_ASN_QOM_CT
             , T1.ETN_WTCF_APY_QTY
             , ( SELECT NVL( SUM(ACL_OSTR_QTY), 0 )
                   FROM TB_SVST_ITM_QOM_ASN_IZ
                  WHERE STR_WARE_NO = T1.STR_WARE_NO
                    AND ITM_PD_CD   = T1.ITM_PD_CD
                    AND DTA_DL_YN   = 'N'
                    AND ASN_OJ_YM   = #{asnOjYm} )                  AS MCBY_ACU_OSTR_QTY
             , T1.CRTL_STOC_QTY
             , T1.THWK_EXP_QTY
             , T1.BORR_EXP_QTY
             , CASE WHEN T1.ITM_PD_CD IN ('WM07104793', 'WM07104794', 'WM07104795', 'WM07104796', 'WM07104797', 'WM07104798', 'WM07105097')
                    THEN GREATEST( T1.THWK_EXP_QTY + T1.BORR_EXP_QTY - T1.CRTL_STOC_QTY
                                 , T1.ETN_WTCF_APY_QTY - T1.CRTL_STOC_QTY - T1.BFSVC_FSH_CT
                                 , 0 ) + MOD( GREATEST( T1.THWK_EXP_QTY + T1.BORR_EXP_QTY - T1.CRTL_STOC_QTY
                                                      , T1.ETN_WTCF_APY_QTY - T1.CRTL_STOC_QTY - T1.BFSVC_FSH_CT
                                                      , 0 ), 2 )
                    WHEN T1.BOX_QTY <![CDATA[>]]> 0
                    THEN T1.BOX_QTY * CEIL( GREATEST( T1.THWK_EXP_QTY + T1.BORR_EXP_QTY - T1.CRTL_STOC_QTY
                                                    , T1.ETN_WTCF_APY_QTY - T1.CRTL_STOC_QTY - T1.BFSVC_FSH_CT
                                                    , 0 ) / T1.BOX_QTY )
                    ELSE GREATEST( T1.THWK_EXP_QTY + T1.BORR_EXP_QTY - T1.CRTL_STOC_QTY
                                 , T1.ETN_WTCF_APY_QTY - T1.CRTL_STOC_QTY - T1.BFSVC_FSH_CT
                                 , 0 )
               END                                                  AS CNFM_QTY
             , CASE WHEN T1.BOX_QTY <![CDATA[>]]> 0 THEN T1.BOX_QTY * CEIL( GREATEST( T1.THWK_EXP_QTY + T1.BORR_EXP_QTY - T1.CRTL_STOC_QTY
                                                                                    , T1.ETN_WTCF_APY_QTY - T1.CRTL_STOC_QTY - T1.BFSVC_FSH_CT
                                                                                    , 0 ) / T1.BOX_QTY ) / T1.BOX_QTY
                    ELSE 0
               END                                                  AS BOX_UNIT_QTY
             , 0                                                    AS ACL_OSTR_QTY
             , T1.BFSVC_FSH_CT
          FROM
             (
               SELECT QOM.STR_WARE_NO
                    , QOM.ITM_PD_CD
                    , QOM.SPP_DV_CD
                    , QOM.WARE_MNGT_PRTNR_NO
                    , QOM.OG_TP_CD
                    , QOM.BLD_CD
                    , QOM.ADR_ID
                    , SUM(QOM.GE_ASN_QOM_CT)        AS GE_ASN_QOM_CT
                    , SUM(QOM.CRP_ASN_QOM_CT)       AS CRP_ASN_QOM_CT
                    , QOM.BOX_QTY
                    , CASE WHEN QOM.ITM_KND_CD <![CDATA[<>]]> '5' THEN SUM(QOM.GE_ASN_QOM_CT)
                           WHEN #{cnt} = 1                        THEN CASE WHEN SUM(QOM.GE_ASN_QOM_CT) <![CDATA[<]]> 5
                                                                            THEN SUM(QOM.GE_ASN_QOM_CT)
                                                                            ELSE ROUND(SUM(QOM.GE_ASN_QOM_CT) * 0.4, 0)
                                                                       END
                           ELSE SUM(QOM.GE_ASN_QOM_CT)
                      END + SUM(QOM.CRP_ASN_QOM_CT) AS ETN_WTCF_APY_QTY
                    , CASE WHEN #{apyYm} <![CDATA[<>]]> #{asnOjYm} THEN 0
                           ELSE NVL( ( SELECT SUM(PITM_STOC_A_GD_QTY)
                                         FROM TB_SVST_CST_SV_ITM_STOC_IZ
                                        WHERE WARE_NO   = QOM.STR_WARE_NO
                                          AND ITM_PD_CD = QOM.ITM_PD_CD
                                          AND DTA_DL_YN = 'N' ), 0 )
                      END                           AS CRTL_STOC_QTY
                    , CASE WHEN #{apyYm} <![CDATA[<>]]> #{asnOjYm} THEN NVL( ( SELECT QTY
                                                                                 FROM TW_QTY1
                                                                                WHERE PRTNR_NO = QOM.WARE_MNGT_PRTNR_NO
                                                                                  AND PD_CD    = QOM.ITM_PD_CD ), 0)
                           ELSE NVL( ( SELECT QTY
                                         FROM TW_QTY2
                                        WHERE PRTNR_NO = QOM.WARE_MNGT_PRTNR_NO
                                          AND PD_CD    = QOM.ITM_PD_CD ), 0)
                      END                           AS THWK_EXP_QTY
                    , CASE WHEN #{apyYm} <![CDATA[<>]]> #{asnOjYm}                     THEN 0
                           WHEN #{apyYm} <![CDATA[<>]]> TO_CHAR(SYSDATE + 7, 'YYYYMM') THEN 0
                           ELSE NVL( ( SELECT QTY
                                         FROM NW_QTY1
                                        WHERE PRTNR_NO = QOM.WARE_MNGT_PRTNR_NO
                                          AND PD_CD    = QOM.ITM_PD_CD ), 0)
                      END                           AS BORR_EXP_QTY
                    , CASE WHEN #{apyYm} <![CDATA[<>]]> #{asnOjYm} THEN 0
                           ELSE NVL( ( SELECT QTY
                                         FROM BS_QTY1
                                        WHERE PRTNR_NO = QOM.WARE_MNGT_PRTNR_NO
                                          AND PD_CD    = QOM.ITM_PD_CD ), 0)
                      END                           AS BFSVC_FSH_CT
                 FROM
                    (
                      SELECT D8.WARE_NO                  AS STR_WARE_NO
                           , D1.PU_PART_PD_CD            AS ITM_PD_CD
                           , D8.DIDY_DV_CD               AS SPP_DV_CD
                           , D3.CNFM_PSIC_PRTNR_NO       AS WARE_MNGT_PRTNR_NO
                           , D3.CNFM_PSIC_PRTNR_OG_TP_CD AS OG_TP_CD
                           , D10.BLD_CD
                           , D8.WARE_ADR_ID              AS ADR_ID
                           , CASE WHEN D6.COPN_DV_CD = '1' THEN D1.PU_QTY
                                  ELSE 0
                             END                         AS GE_ASN_QOM_CT
                           , CASE WHEN D6.COPN_DV_CD = '2' THEN D1.PU_QTY
                                  ELSE 0
                             END                         AS CRP_ASN_QOM_CT
                           , CASE WHEN D1.PU_PART_PD_CD IN ('WM07103020', 'WM07105668') THEN NVL(TO_NUMBER(D7.PD_PRP_VAL12), 0)
                                  ELSE 0
                             END                         AS BOX_QTY
                           , D7.PD_PRP_VAL19             AS ITM_KND_CD
                        FROM TB_SVPD_RGBS_PU_ITM_IZ D1             /* 정기BS투입품목내역 */
                       INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D2    /* 고객서비스BS대상내역 */
                          ON D2.ASN_OJ_YM = D1.ASN_OJ_YM
                         AND D2.CNTR_NO   = D1.CNTR_NO
                         AND D2.CNTR_SN   = D1.CNTR_SN
                       INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ D3   /* 고객서비스BS배정내역 */
                          ON D3.CST_SV_ASN_NO = D2.CST_SV_ASN_NO
                       INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D4        /* 고객서비스수행내역 */
                          ON D4.CNTR_NO = D2.CNTR_NO
                         AND D4.CNTR_SN = D2.CNTR_SN
                       INNER JOIN TB_SSCT_CNTR_CST_REL D5         /* 계약고객관계 */
                          ON D5.DTL_CNTR_NO = D2.CNTR_NO
                         AND D5.DTL_CNTR_SN = D2.CNTR_SN
                       INNER JOIN TB_CUBS_CST_BAS D6              /* 고객기본 */
                          ON D6.CST_NO = D5.CST_NO
                       INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D7      /* 상품각사속성상세 */
                          ON D7.PD_CD = D1.PU_PART_PD_CD
                       INNER JOIN TB_SVST_MCBY_WARE_IZ D8         /* 월별창고내역 */
                          ON D8.APY_YM             = D3.ASN_OJ_YM
                         AND D8.OG_TP_CD           = D3.CNFM_PSIC_PRTNR_OG_TP_CD
                         AND D8.WARE_MNGT_PRTNR_NO = D3.CNFM_PSIC_PRTNR_NO
                       INNER JOIN TB_OGBS_MM_PRTNR_IZ D9          /* 월파트너내역 */
                          ON D9.BASE_YM  = D3.ASN_OJ_YM
                         AND D9.OG_TP_CD = D3.CNFM_PSIC_PRTNR_OG_TP_CD
                         AND D9.PRTNR_NO = D3.CNFM_PSIC_PRTNR_NO
                       INNER JOIN TB_OGBS_MM_OG_IZ D10             /* 월조직내역 */
                          ON D10.BASE_YM  = D9.BASE_YM
                         AND D10.OG_ID    = D9.OG_ID
                         AND D10.OG_TP_CD = D9.OG_TP_CD
                       WHERE D1.DTA_DL_YN           = 'N'
                         AND D2.DTA_DL_YN           = 'N'
                         AND D3.DTA_DL_YN           = 'N'
                         AND D4.DTA_DL_YN           = 'N'
                         AND D5.DTA_DL_YN           = 'N'
                         AND D5.CNTR_CST_REL_TP_CD  = '10'    /* 계약자 */
                         AND D6.DTA_DL_YN           = 'N'
                         AND D7.DTA_DL_YN           = 'N'
                         AND D7.PD_EXTS_PRP_GRP_CD  = 'PART'
                         AND D8.DTA_DL_YN           = 'N'
                         AND D8.WARE_USE_YN         = 'Y'
                         AND D9.DTA_DL_YN           = 'N'
                         AND D10.DTA_DL_YN          = 'N'
                         AND D2.VST_DV_CD LIKE '1%'
                         AND D2.VST_DV_CD <![CDATA[<>]]> '13'
                         AND D1.PU_QTY <![CDATA[>]]> 0
                         AND D9.PSTN_DV_CD <![CDATA[<>]]> '4'
                         AND D8.DIDY_DV_CD <![CDATA[<>]]> '2'
                         AND D4.REQD_DT IS NULL
                         AND D4.CPS_DT IS NULL
                         AND D4.CNTR_DTL_STAT_CD NOT IN ('201', '202', '203', '303')   /* 고객요청정지, 연체정지, 해약접수정지, 계약취소 */
                         AND ( D7.PD_PRP_VAL20 IS NULL OR D7.PD_PRP_VAL20 <![CDATA[<>]]> '11' )
                         AND D1.PU_PART_PD_CD NOT IN ( 'WM07105924', 'WM07105925', 'WM07106025', 'WM07106030', 'WM07106035', 'WM07104436', 'WM07105952', 'WM07105745', 'WM07105746'
                                                     , 'WM07105747', 'WM07105748', 'WM07102129', 'WM07105703', 'WM07105704', 'WM07105705', 'WM07105708', 'WM07105709', 'WM07105712' )
                         AND D1.ASN_OJ_YM           = #{asnOjYm}
                         AND D2.ASN_OJ_YM           = #{asnOjYm}
                         AND D8.WARE_DV_CD          = #{wareDvCd}
                         AND D8.WARE_DTL_DV_CD      = #{wareDtlDvCd}
                    ) QOM
                GROUP BY QOM.STR_WARE_NO, QOM.ITM_PD_CD, QOM.SPP_DV_CD, QOM.WARE_MNGT_PRTNR_NO, QOM.OG_TP_CD, QOM.BLD_CD, QOM.ADR_ID, QOM.BOX_QTY, QOM.ITM_KND_CD
             ) T1
         WHERE NOT EXISTS ( SELECT 1
                              FROM TB_SVST_QOM_ASN_EXCD_IZ   /* 물량배정제외내역 */
                             WHERE ITM_PD_CD = T1.ITM_PD_CD
                               AND (    ( ASN_EXCD_DV_CD = '0' AND STR_WARE_NO = '300000' )
                                     OR ( ASN_EXCD_DV_CD = '3' AND STR_WARE_NO = T1.STR_WARE_NO )
                                   ) )
           AND NOT EXISTS ( SELECT 1
                              FROM TB_SVST_QOM_ASN_PRTNR_APY_IZ S1   /* 물량배정파트너적용내역 */
                             WHERE S1.PRTNR_NO       = T1.WARE_MNGT_PRTNR_NO
                               AND S1.OG_TP_CD       = T1.OG_TP_CD
                               AND S1.DTA_DL_YN      = 'N'
                               AND S1.QOM_ASN_APY_YN = 'N'
                               AND S1.APY_SN         = ( SELECT MAX(APY_SN)
                                                           FROM TB_SVST_QOM_ASN_PRTNR_APY_IZ
                                                          WHERE PRTNR_NO = S1.PRTNR_NO
                                                            AND OG_TP_CD = S1.OG_TP_CD ) )
    </select>

    <select id="selectQomAsnIndependenceForCreate" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaQomAsnCreateDvo">
        SELECT #{asnOjYm}     AS ASN_OJ_YM
             , #{cnt}         AS ASN_TN_N
             , T1.STR_WARE_NO
             , #{ostrWareNo}  AS OSTR_WARE_NO
             , T1.ITM_PD_CD
             , #{wareDvCd}    AS WARE_DV_CD
             , #{wareDtlDvCd} AS WARE_DTL_DV_CD
             , T1.SPP_DV_CD
             , T1.WARE_MNGT_PRTNR_NO
             , T1.OG_TP_CD
             , T3.BLD_CD
             , CASE WHEN T1.ADR_USE_YN = 'Y' THEN T1.ADR_ID
                    ELSE T4.ADR_ID
               END            AS ADR_ID
             , 'A'            AS MAT_GD_CD
             , T1.GE_ASN_QOM_CT
             , T1.CRP_ASN_QOM_CT
             , T1.WO_ASN_QOM_CT
             , T1.ETN_WTCF_APY_QTY
             , 0              AS MCBY_ACU_OSTR_QTY
             , T1.CRTL_STOC_QTY
             , T1.THWK_EXP_QTY
             , T1.CNFM_QTY
             , T1.BOX_QTY
             , CASE WHEN T1.BOX_QTY > 1 THEN T1.CNFM_QTY / T1.BOX_QTY
                    ELSE 0
               END            AS BOX_UNIT_QTY
          FROM
             (
               SELECT QOM.STR_WARE_NO
                    , QOM.ITM_PD_CD
                    , WARE.DIDY_DV_CD  AS SPP_DV_CD
                    , WARE.WARE_MNGT_PRTNR_NO
                    , WARE.OG_TP_CD
                    , WARE.WARE_ADR_ID AS ADR_ID
                    , WARE.ADR_USE_YN
                    , CASE WHEN WARE.WARE_DTL_DV_CD <![CDATA[<>]]> '30' THEN STOC.PITM_STOC_A_GD_QTY
                           ELSE ( SELECT SUM(S1.PITM_STOC_A_GD_QTY)
                                    FROM TB_SVST_MCITM_STOC_IZ S1       /* 월별품목재고내역 */
                                   INNER JOIN TB_SVST_MCBY_WARE_IZ S2   /* 월별창고내역 */
                                      ON S2.APY_YM  = S1.BASE_YM
                                     AND S2.WARE_NO = S1.WARE_NO
                                   WHERE S1.ITM_PD_CD   = QOM.ITM_PD_CD
                                     AND S2.HGR_WARE_NO = QOM.STR_WARE_NO
                                     AND S1.BASE_YM     = TO_CHAR(SYSDATE, 'YYYYMM')
                                     AND S2.APY_YM      = TO_CHAR(SYSDATE, 'YYYYMM') )
                      END              AS GE_ASN_QOM_CT
                    , CASE WHEN WARE.WARE_DTL_DV_CD = '30' THEN STOC.PITM_STOC_A_GD_QTY
                           ELSE ( SELECT PITM_STOC_A_GD_QTY
                                    FROM TB_SVST_MCITM_STOC_IZ   /* 월별품목재고내역 */
                                   WHERE ITM_PD_CD = QOM.ITM_PD_CD
                                     AND WARE_NO   = WARE.HGR_WARE_NO
                                     AND BASE_YM   = TO_CHAR(SYSDATE, 'YYYYMM') )
                      END              AS CRP_ASN_QOM_CT
                    , QOM.WO_ASN_QOM_CT
                    , QOM.ETN_WTCF_APY_QTY
                    , QOM.CRTL_STOC_QTY
                    , CASE WHEN QOM.ETN_WTCF_APY_QTY <![CDATA[<]]> QOM.CRTL_STOC_QTY THEN 0
                           WHEN QOM.ETN_WTCF_APY_QTY = QOM.CRTL_STOC_QTY             THEN 1
                           ELSE NVL(QOM.ETN_WTCF_APY_QTY, 0) - NVL(QOM.CRTL_STOC_QTY, 0)
                      END              AS THWK_EXP_QTY
                    , CASE WHEN WARE.WARE_DTL_DV_CD <![CDATA[<>]]> '30' THEN CASE WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) > 0
                                                                                  THEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0)
                                                                                  ELSE 0
                                                                             END
                           ELSE CASE WHEN NVL(QOM.BOX_QTY, 0) <![CDATA[>]]> 0
                                     THEN CASE WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) <![CDATA[<]]> -3    THEN 0
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN -3 AND 0    THEN QOM.BOX_QTY * CEIL( 3 / QOM.BOX_QTY )
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 1 AND 3     THEN QOM.BOX_QTY * CEIL( (NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0)) * 3 / QOM.BOX_QTY )
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 4 AND 9     THEN QOM.BOX_QTY * CEIL( (NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0)) * 2 / QOM.BOX_QTY )
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 10 AND 19   THEN QOM.BOX_QTY * CEIL( (NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0)) * 1.5 / QOM.BOX_QTY )
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 20 AND 49   THEN QOM.BOX_QTY * CEIL( (NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0)) * 1.4 / QOM.BOX_QTY )
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 50 AND 99   THEN QOM.BOX_QTY * CEIL( (NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0)) * 1.3 / QOM.BOX_QTY )
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 100 AND 199 THEN QOM.BOX_QTY * CEIL( (NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0)) * 1.2 / QOM.BOX_QTY )
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) <![CDATA[>=]]> 200  THEN QOM.BOX_QTY * CEIL( (NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0)) * 1.1 / QOM.BOX_QTY )
                                          END
                                     ELSE CASE WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) <![CDATA[<]]> -3    THEN 0
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN -3 AND 0    THEN 3
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 1 AND 3     THEN ( NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) ) * 3
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 4 AND 9     THEN ( NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) ) * 2
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 10 AND 19   THEN CEIL( ( NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) ) * 1.5 )
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 20 AND 49   THEN CEIL( ( NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) ) * 1.4 )
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 50 AND 99   THEN CEIL( ( NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) ) * 1.3 )
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) BETWEEN 100 AND 199 THEN CEIL( ( NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) ) * 1.2 )
                                               WHEN NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) <![CDATA[>=]]> 200  THEN CEIL( ( NVL(QOM.WO_ASN_QOM_CT, 0) - NVL(QOM.CRTL_STOC_QTY, 0) ) * 1.1 )
                                          END
                                END
                      END              AS CNFM_QTY
                    , QOM.BOX_QTY
                 FROM
                    (
                      SELECT QOM.STR_WARE_NO
                           , QOM.ITM_PD_CD
                           , MAX(QOM.BOX_QTY) AS BOX_QTY
                           , SUM(QOM.PU_QTY)  AS WO_ASN_QOM_CT
                           , SUM(QOM.PU_QTY)  AS ETN_WTCF_APY_QTY
                           , ( SELECT NVL(SUM(S1.PITM_STOC_A_GD_QTY), 0)
                                 FROM TB_SVST_MCITM_STOC_IZ S1       /* 월별품목재고내역 */
                                INNER JOIN TB_SVST_MCBY_WARE_IZ S2   /* 월별창고내역 */
                                   ON S2.APY_YM  = S1.BASE_YM
                                  AND S2.WARE_NO = S1.WARE_NO
                                WHERE S1.ITM_PD_CD   = QOM.ITM_PD_CD
                                  AND S2.WARE_USE_YN = 'Y'
                                  AND S1.BASE_YM     = #{apyYm}
                                  AND S2.APY_YM      = #{apyYm}
                        <choose>
                            <when test="@MybatisUtils@equals(cnt, 1)">
                                  AND S2.WARE_NO     = QOM.STR_WARE_NO
                            </when>
                            <otherwise>
                                  AND ( S2.WARE_NO = QOM.STR_WARE_NO OR S2.HGR_WARE_NO = QOM.STR_WARE_NO )
                            </otherwise>
                        </choose>
                             )                AS CRTL_STOC_QTY
                        FROM
                           (
                             SELECT D1.ASN_OJ_YM
                                  , D1.CNTR_NO
                                  , D1.CNTR_SN
                                  , D1.PU_PART_PD_CD           AS ITM_PD_CD
                                  , D1.PU_QTY
                                  , D1.STR_WARE_DV_CD
                                  , CASE WHEN D3.DIDY_DV_CD = '2' THEN D3.WARE_NO
                                         ELSE D3.HGR_WARE_NO
                                    END                        AS STR_WARE_NO
                                  , TO_NUMBER(D7.PD_PRP_VAL12) AS BOX_QTY
                               FROM TB_SVPD_RGBS_PU_ITM_IZ D1             /* 정기BS투입품목내역 */
                              INNER JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ D2     /* 월별고객서비스대상내역 */
                                 ON D2.CNTR_NO    = D1.CNTR_NO
                                AND D2.CNTR_SN    = D1.CNTR_SN
                                AND D2.PDCT_PD_CD = D1.PDCT_PD_CD
                              INNER JOIN TB_SVST_MCBY_WARE_IZ D3          /* 월별창고내역 */
                                 ON D3.OG_TP_CD           = CASE WHEN #{cnt} = 1 THEN D2.MNGT_PRTNR_OG_TP_CD
                                                                 ELSE D2.FXN_PRTNR_OG_TP_CD
                                                            END
                                AND D3.WARE_MNGT_PRTNR_NO = CASE WHEN #{cnt} = 1 THEN D2.MNGT_PRTNR_NO
                                                                 ELSE D2.FXN_PRTNR_NO
                                                            END
                            <if test="!@MybatisUtils@equals(cnt, 1)">
                              INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ D4   /* 고객서비스BS배정내역 */
                                 ON D4.ASN_OJ_YM = D1.ASN_OJ_YM
                                AND D4.CNTR_NO   = D1.CNTR_NO
                                AND D4.CNTR_SN   = D1.CNTR_SN
                                AND D4.DTA_DL_YN = 'N'
                                AND D4.VST_PRGS_STAT_CD IN ('00', '10')
                            </if>
                              INNER JOIN TB_OGBS_MM_PRTNR_IZ D5           /* 월파트너내역 */
                                 ON D5.BASE_YM  = D3.APY_YM
                                AND D5.OG_TP_CD = D3.OG_TP_CD
                                AND D5.PRTNR_NO = D3.WARE_MNGT_PRTNR_NO
                              INNER JOIN TB_OGBS_MM_OG_IZ D6              /* 월조직내역 */
                                 ON D6.BASE_YM  = D5.BASE_YM
                                AND D6.OG_ID    = D5.OG_ID
                                AND D6.OG_TP_CD = D5.OG_TP_CD
                              INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D7      /* 상품각사속성상세 */
                                 ON D7.PD_CD = D1.PU_PART_PD_CD
                              WHERE D1.DTA_DL_YN           = 'N'
                                AND D2.DTA_DL_YN           = 'N'
                                AND D3.DTA_DL_YN           = 'N'
                                AND D3.WARE_USE_YN         = 'Y'
                                AND D5.DTA_DL_YN           = 'N'
                                AND D6.DTA_DL_YN           = 'N'
                                AND D7.DTA_DL_YN           = 'N'
                                AND D7.PD_EXTS_PRP_GRP_CD  = 'PART'
                                AND D1.ASN_OJ_YM           = #{asnOjYm}
                                AND D2.MNGT_YM             = #{apyYm}
                                AND D3.APY_YM              = #{apyYm}
                                AND D1.QOM_ASN_WARE_NO     = #{ostrWareNo}
                                AND D1.STR_WARE_DV_CD      = #{wareDvCd}
                                AND ( D7.PD_PRP_VAL20 IS NULL OR D7.PD_PRP_VAL20 <![CDATA[<>]]> '11' )
                                AND NOT(     D3.DIDY_DV_CD <![CDATA[<>]]> '2'
                                         AND D5.PSTN_DV_CD <![CDATA[<>]]> '4'
                                         AND (    D6.DGR2_LEVL_OG_CD IN ('D940000', 'H930000')
                                               OR D6.BLD_CD IN ( '679', '955', '670', '859', '650', '953', '665', '739', '647', '705', '786'
                                                               , '838', '680', '685', '797', '809', '682', '708', '681', '690', '654', '815'
                                                               , '1024', '1095', '1037', '1036', '648', '885', '646', '723', '421', '1085'
                                                               , '878', '649', '877', '867', '738', '858', '692', '726', '697', '818', '850'
                                                               , '698', '1071', '715', '746', '683', '847', '1039', '835', '844', '1038', '684', '786' )
                                             ) )
                                AND NOT EXISTS ( SELECT 1
                                                   FROM TB_SVPD_SLF_MNGT_SPP_STP_AK_IZ S1   /* 자가관리배송중지요청내역 */
                                                  WHERE S1.CNTR_NO       = D1.CNTR_NO
                                                    AND S1.CNTR_SN       = D1.CNTR_SN
                                                    AND S1.DTA_DL_YN     = 'N'
                                                    AND S1.SPP_STP_DV_CD = 'B'
                                                    AND S1.AK_SN         = ( SELECT MAX(AK_SN)
                                                                               FROM TB_SVPD_SLF_MNGT_SPP_STP_AK_IZ
                                                                              WHERE CNTR_NO   = S1.CNTR_NO
                                                                                AND CNTR_SN   = S1.CNTR_SN
                                                                                AND DTA_DL_YN = 'N' ) )
                           ) QOM
                       GROUP BY QOM.STR_WARE_NO, QOM.ITM_PD_CD
                    ) QOM
                 LEFT OUTER JOIN TB_SVST_MCITM_STOC_IZ STOC   /* 월별품목재고내역 */
                   ON STOC.ITM_PD_CD = QOM.ITM_PD_CD
                  AND STOC.WARE_NO   = QOM.STR_WARE_NO
                  AND STOC.BASE_YM   = TO_CHAR(SYSDATE, 'YYYYMM')
                  AND STOC.DTA_DL_YN = 'N'
                INNER JOIN TB_SVST_MCBY_WARE_IZ WARE    /* 월별창고내역 */
                   ON WARE.WARE_NO   = QOM.STR_WARE_NO
                WHERE WARE.DTA_DL_YN      = 'N'
                  AND WARE.APY_YM         = #{apyYm}
             ) T1
         INNER JOIN TB_OGBS_MM_PRTNR_IZ T2     /* 월파트너내역 */
            ON T2.OG_TP_CD = T1.OG_TP_CD
           AND T2.PRTNR_NO = T1.WARE_MNGT_PRTNR_NO
         INNER JOIN TB_OGBS_MM_OG_IZ T3        /* 월조직내역 */
            ON T3.BASE_YM  = T2.BASE_YM
           AND T3.OG_ID    = T2.OG_ID
           AND T3.OG_TP_CD = T2.OG_TP_CD
         INNER JOIN TB_OGBS_BLD_BAS T4   /* 빌딩기본 */
            ON T4.OG_TP_CD  = T3.OG_TP_CD
           AND T4.BLD_CD    = T3.BLD_CD
         WHERE T2.DTA_DL_YN = 'N'
           AND T3.DTA_DL_YN = 'N'
           AND T4.DTA_DL_YN = 'N'
           AND T2.BASE_YM   = #{apyYm}
           AND T3.BASE_YM   = #{apyYm}
           AND NOT EXISTS ( SELECT 1
                              FROM TB_SVST_QOM_ASN_EXCD_IZ   /* 물량배정제외내역 */
                             WHERE ITM_PD_CD = T1.ITM_PD_CD
                               AND (    ( ASN_EXCD_DV_CD = '0' AND STR_WARE_NO = '300000' )
                                     OR ( ASN_EXCD_DV_CD = '3' AND STR_WARE_NO = T1.STR_WARE_NO )
                                   ) )
           AND NOT EXISTS ( SELECT 1
                              FROM TB_SVST_QOM_ASN_PRTNR_APY_IZ S1   /* 물량배정파트너적용내역 */
                             WHERE S1.PRTNR_NO       = T1.WARE_MNGT_PRTNR_NO
                               AND S1.OG_TP_CD       = T1.OG_TP_CD
                               AND S1.DTA_DL_YN      = 'N'
                               AND S1.QOM_ASN_APY_YN = 'N'
                               AND S1.APY_SN         = ( SELECT MAX(APY_SN)
                                                           FROM TB_SVST_QOM_ASN_PRTNR_APY_IZ
                                                          WHERE PRTNR_NO = S1.PRTNR_NO
                                                            AND OG_TP_CD = S1.OG_TP_CD ) )
    </select>

    <select id="selectItmQomAsnNoMax" resultType="java.lang.Integer">
        SELECT NVL(MAX(TO_NUMBER(SUBSTR(ITM_QOM_ASN_NO, 9))), 0) + 1
          FROM TB_SVST_ITM_QOM_ASN_IZ
         WHERE ITM_QOM_ASN_NO LIKE #{wareDtlDvCd} || #{asnOjYm} || '%'
    </select>

    <update id="insertItmQomAsns">
    <foreach collection="list" item="item" index="idx" separator=" " open="INSERT ALL" close="SELECT * FROM DUAL">
          INTO TB_SVST_ITM_QOM_ASN_IZ   /* 품목물량배정내역 */
             (
               ITM_QOM_ASN_NO       /* 품목물량배정번호 */
             , ASN_OJ_YM            /* 배정대상년월 */
             , ASN_TN_N             /* 배정회차수 */
             , STR_WARE_NO          /* 입고창고번호 */
             , OSTR_WARE_NO         /* 출고창고번호 */
             , ITM_PD_CD            /* 품목상품코드 */
             , WARE_DV_CD           /* 창고구분코드 */
             , WARE_DTL_DV_CD       /* 창고상세구분코드 */
             , SPP_DV_CD            /* 배송구분코드 */
             , WARE_MNGT_PRTNR_NO   /* 창고관리파트너번호 */
             , OG_TP_CD             /* 조직유형코드 */
             , BLD_CD               /* 빌딩코드 */
             , ADR_ID               /* 주소ID */
             , MAT_GD_CD            /* 자재등급코드 */
             , GE_ASN_QOM_CT        /* 일반배정물량건수 */
             , CRP_ASN_QOM_CT       /* 법인배정물량건수 */
             , WO_ASN_QOM_CT        /* 전체배정물량건수 */
             , ETN_WTCF_APY_QTY     /* 회차별가중치적용수량 */
             , MCBY_ACU_OSTR_QTY    /* 월별누적출고수량 */
             , CRTL_STOC_QTY        /* 현재재고수량 */
             , THWK_EXP_QTY         /* 금주예정수량 */
             , BORR_EXP_QTY         /* 차주예정수량 */
             , CNFM_QTY             /* 확정수량 */
             , BOX_QTY              /* 박스수량 */
             , BOX_UNIT_QTY         /* 박수단위수량 */
             , ACL_OSTR_QTY         /* 실제출고수량 */
             , BFSVC_FSH_CT         /* BS완료수량 */
             , DTA_DL_YN            /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        VALUES
             (
               #{item.wareDtlDvCd} || #{item.asnOjYm} || LPAD( #{item.qomAsnNo} + #{idx}, 7, '0')
             , #{item.asnOjYm}
             , #{item.asnTnN}
             , #{item.strWareNo}
             , #{item.ostrWareNo}
             , #{item.itmPdCd}
             , #{item.wareDvCd}
             , #{item.wareDtlDvCd}
             , #{item.sppDvCd}
             , #{item.wareMngtPrtnrNo}
             , #{item.ogTpCd}
             , #{item.bldCd}
             , #{item.adrId}
             , #{item.matGdCd}
             , #{item.geAsnQomCt}
             , #{item.crpAsnQomCt}
             , #{item.woAsnQomCt}
             , #{item.etnWtcfApyQty}
             , #{item.mcbyAcuOstrQty}
             , #{item.crtlStocQty}
             , #{item.thwkExpQty}
             , #{item.borrExpQty}
             , #{item.cnfmQty}
             , #{item.boxQty}
             , #{item.boxUnitQty}
             , #{item.aclOstrQty}
             , #{item.bfsvcFshCt}
             , 'N'
        <include refid="COMMON.insertSystemFieldValue" />
             )
    </foreach>
    </update>

    <select id="selectQomAsnsForIndividual" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaQomAsnIndividualSearchDvo">
        SELECT D2.SAP_MAT_CD                            AS SAP_CD       /* SAP코드 */
             , D1.ITM_PD_CD                                             /* 품목코드 */
             , D2.PD_ABBR_NM                            AS ITM_PD_NM    /* 품목이름 */
             , D1.STR_WARE_NO                           AS WARE_NO      /* 창고번호 */
             , D1.WARE_MNGT_PRTNR_NO                    AS PRTNR_NO     /* 파트너번호 */
             , D6.PRTNR_KNM                             AS PRTNR_NM     /* 파트너명 */
             , D4.WARE_NM                                               /* 창고명 */
             , ( SELECT S1.PITM_STOC_A_GD_QTY
                   FROM TB_SVST_CST_SV_ITM_STOC_IZ S1   /* 고객서비스품목재고내역 */
                  INNER JOIN TB_SVST_MCBY_WARE_IZ S2    /* 월별창고내역 */
                     ON S2.HGR_WARE_NO = S1.WARE_NO
                    AND S2.APY_YM    = TO_CHAR(SYSDATE, 'YYYYMM')
                  WHERE S1.ITM_PD_CD = D1.ITM_PD_CD
                    AND S2.WARE_NO   = D1.STR_WARE_NO ) AS CENTER_QTY   /* 센터수량 */
             , D1.GE_ASN_QOM_CT                         AS GE_QTY       /* 일반수량 */
             , D1.CRP_ASN_QOM_CT                        AS CRP_QTY      /* 법인수량 */
             , D1.WO_ASN_QOM_CT                         AS TOTAL_QTY    /* 전체수량 */
             , D1.ETN_WTCF_APY_QTY                      AS APY_QTY      /* 가중치적용 */
             , D1.MCBY_ACU_OSTR_QTY                     AS OSTR_QTY     /* 누적출고 */
             , D1.BFSVC_FSH_CT                          AS BS_QTY       /* BS완료 */
             , D1.CRTL_STOC_QTY                         AS STOC_QTY     /* 현재재고 */
             , D1.THWK_EXP_QTY                          AS THWK_QTY     /* 금주예정 */
             , D1.BORR_EXP_QTY                          AS BORR_QTY     /* 차주예정 */
             , D1.CNFM_QTY                                              /* 확정수량 */
             , D1.BOX_UNIT_QTY                          AS BOX_QTY      /* 박스수량 */
             , D1.BLD_CD                                                /* 빌딩코드 */
             , D5.BLD_NM                                                /* 빌딩명 */
             , D8.LOCARA_TNO                                            /* 지역전화번호 */
             , D8.EXNO_ENCR                                             /* 전화국번호암호화 */
             , D8.IDV_TNO                                               /* 개별전화번호 */
             , NVL(D7.NEW_ADR_ZIP, D7.OLD_ADR_ZIP)      AS ADR_ZIP      /* 우편번호 */
             , D7.RNADR                                                 /* 주소1 */
             , D7.RDADR                                                 /* 주소2 */
          FROM TB_SVST_ITM_QOM_ASN_IZ D1            /* 품목물량배정내역 */
         INNER JOIN TB_PDBS_PD_BAS D2               /* 상품기본 */
            ON D2.PD_CD = D1.ITM_PD_CD
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D3      /* 상품각사속성상세 */
            ON D3.PD_CD = D2.PD_CD
          LEFT OUTER JOIN TB_SVST_MCBY_WARE_IZ D4   /* 월별창고내역 */
            ON D4.WARE_NO   = D1.STR_WARE_NO
	       AND D4.DTA_DL_YN = 'N'
	       AND D4.APY_YM    = #{apyYm}
          LEFT OUTER JOIN TB_OGBS_BLD_BAS D5        /* 빌딩기본 */
            ON D5.OG_TP_CD  = D1.OG_TP_CD
	       AND D5.BLD_CD    = D1.BLD_CD
           AND D5.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ D6    /* 월파트너내역 */
            ON D6.BASE_YM   = D1.ASN_OJ_YM
           AND D6.OG_TP_CD  = D1.OG_TP_CD
	       AND D6.PRTNR_NO  = D1.WARE_MNGT_PRTNR_NO
           AND D6.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_GBCO_ADR_BAS D7        /* 주소기본 */
            ON D7.ADR_ID    = D5.ADR_ID
           AND D7.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS D8      /* 파트너기본 */
            ON D8.OG_TP_CD  = D6.OG_TP_CD
           AND D8.PRTNR_NO  = D6.PRTNR_NO
           AND D8.DTA_DL_YN = 'N'
         WHERE D1.DTA_DL_YN          = 'N'
           AND D2.DTA_DL_YN          = 'N'
           AND D2.PD_TP_CD           = 'M'
           AND D3.DTA_DL_YN          = 'N'
           AND D3.PD_EXTS_PRP_GRP_CD = 'PART'
	       AND D1.ASN_OJ_YM          = #{asnOjYm}
           AND D1.ASN_TN_N           = #{cnt}
           AND D1.OSTR_WARE_NO       = #{ostrWareNo}
           AND D1.WARE_DV_CD         = #{wareDvCd}
           AND D1.WARE_DTL_DV_CD     = #{wareDtlDvCd}
        <if test="@MybatisUtils@isNotEmpty(strWareNo)">
           AND D4.HGR_WARE_NO        = #{strWareNo}
        </if>
        <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
           AND D1.ITM_PD_CD          = #{itmPdCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
           AND D3.PD_PRP_VAL19       = #{itmKndCd}
        </if>
         ORDER BY D5.BLD_NM, D6.PRTNR_KNM, D1.ITM_PD_CD
    </select>

    <select id="selectQomAsnsForIndependence" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaQomAsnIndividualSearchDvo">
        SELECT D1.STR_WARE_NO                                                               AS WARE_NO          /* 창고번호 */
             , D1.WARE_MNGT_PRTNR_NO                                                        AS PRTNR_NO         /* 파트너번호 */
             , D6.PRTNR_KNM                                                                 AS PRTNR_NM         /* 파트너명 */
             , D4.WARE_NM                                                                                       /* 창고명 */
             , D2.SAP_MAT_CD                                                                AS SAP_CD           /* SAP코드 */
             , D1.ITM_PD_CD                                                                                     /* 품목코드 */
             , D2.PD_ABBR_NM                                                                AS ITM_PD_NM        /* 품목이름 */
             , F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', D3.PD_PRP_VAL05, #{session.langId}) AS MNGT_UNIT        /* 관리단위 */
             , D1.MAT_GD_CD                                                                                     /* 자재등급코드 */
             , D1.WO_ASN_QOM_CT                                                             AS BS_FULL_QTY      /* 당월BS FULL수량 */
             , D1.ETN_WTCF_APY_QTY                                                          AS BS_ASN_QTY       /* 당월BS 배정수량 */
             , D1.CRP_ASN_QOM_CT                                                            AS STOCK_OG_QTY     /* 재고(조직) */
             , D1.GE_ASN_QOM_CT                                                             AS STOCK_INDV_QTY   /* 재고(개인) */
             , D1.THWK_EXP_QTY                                                              AS NED_QTY          /* 소요수량 */
             , D1.CNFM_QTY                                                                                      /* 확정수량 */
             , D1.BOX_QTY                                                                   AS BOX_UNIT_QTY     /* 박스단위수량 */
             , D1.BOX_UNIT_QTY                                                              AS BOX_QTY          /* 박스수량 */
             , D1.BLD_CD                                                                                        /* 빌딩코드 */
             , D5.BLD_NM                                                                                        /* 빌딩명 */
             , D8.LOCARA_TNO                                                                                    /* 지역전화번호 */
             , D8.EXNO_ENCR                                                                                     /* 전화국번호암호화 */
             , D8.IDV_TNO                                                                                       /* 개별전화번호 */
             , NVL(D7.NEW_ADR_ZIP, D7.OLD_ADR_ZIP)                                          AS ADR_ZIP          /* 우편번호 */
             , D7.RNADR                                                                                         /* 주소1 */
             , D7.RDADR                                                                                         /* 주소2 */
          FROM TB_SVST_ITM_QOM_ASN_IZ D1            /* 품목물량배정내역 */
         INNER JOIN TB_PDBS_PD_BAS D2               /* 상품기본 */
            ON D2.PD_CD = D1.ITM_PD_CD
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D3      /* 상품각사속성상세 */
            ON D3.PD_CD = D2.PD_CD
          LEFT OUTER JOIN TB_SVST_MCBY_WARE_IZ D4   /* 월별창고내역 */
            ON D4.WARE_NO   = D1.STR_WARE_NO
	       AND D4.DTA_DL_YN = 'N'
	       AND D4.APY_YM    = #{apyYm}
          LEFT OUTER JOIN TB_OGBS_BLD_BAS D5        /* 빌딩기본 */
            ON D5.OG_TP_CD  = D1.OG_TP_CD
	       AND D5.BLD_CD    = D1.BLD_CD
           AND D5.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ D6    /* 월파트너내역 */
            ON D6.BASE_YM   = D1.ASN_OJ_YM
           AND D6.OG_TP_CD  = D1.OG_TP_CD
	       AND D6.PRTNR_NO  = D1.WARE_MNGT_PRTNR_NO
           AND D6.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_GBCO_ADR_BAS D7        /* 주소기본 */
            ON D7.ADR_ID    = D5.ADR_ID
           AND D7.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS D8      /* 파트너기본 */
            ON D8.OG_TP_CD  = D6.OG_TP_CD
           AND D8.PRTNR_NO  = D6.PRTNR_NO
           AND D8.DTA_DL_YN = 'N'
         WHERE D1.DTA_DL_YN          = 'N'
           AND D2.DTA_DL_YN          = 'N'
           AND D2.PD_TP_CD           = 'M'
           AND D3.DTA_DL_YN          = 'N'
           AND D3.PD_EXTS_PRP_GRP_CD = 'PART'
	       AND D1.ASN_OJ_YM          = #{asnOjYm}
           AND D1.ASN_TN_N           = #{cnt}
           AND D1.OSTR_WARE_NO       = #{ostrWareNo}
           AND D1.WARE_DV_CD         = #{wareDvCd}
           AND D1.WARE_DTL_DV_CD     = #{wareDtlDvCd}
        <if test="@MybatisUtils@isNotEmpty(strWareNo)">
           AND D1.STR_WARE_NO        = #{strWareNo}
        </if>
        <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
           AND D1.ITM_PD_CD          = #{itmPdCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
           AND D3.PD_PRP_VAL19       = #{itmKndCd}
        </if>
         ORDER BY D5.BLD_NM, D6.PRTNR_KNM, D1.ITM_PD_CD
    </select>

    <update id="updateRgbsPuItmForWareRenewal">
         MERGE INTO TB_SVPD_RGBS_PU_ITM_IZ TB_TGT   /* 정기BS투입품목내역 */
         USING
             (
               SELECT T1.ASN_OJ_YM
                    , T1.CNTR_NO
                    , T1.CNTR_SN
                    , T1.SV_BIZ_MCLSF_CD
                    , T1.SV_BIZ_DCLSF_CD
                    , T1.WK_SN
                    , T1.PDCT_PD_CD
                    , T1.IST_NMN_N
                    , T1.PU_PART_PD_CD
                    , T1.QOM_ASN_WARE_NO
                    , T1.WARE_DV_CD
                    , T1.STR_WARE_NO
                 FROM
                    (
                      SELECT D1.ASN_OJ_YM                                /* 배정대상년월 */
                           , D1.CNTR_NO                                  /* 계약번호 */
	                       , D1.CNTR_SN                                  /* 계약일련번호 */
                           , D1.SV_BIZ_MCLSF_CD                          /* 서비스업무중분류코드 */
	                       , D1.SV_BIZ_DCLSF_CD                          /* 서비스업무세분류코드 */
                           , D1.WK_SN                                    /* 작업일련번호 */
                           , D1.PDCT_PD_CD                               /* 제품상품코드 */
      	                   , D1.IST_NMN_N                                /* 설치차월수 */
                           , D1.PU_PART_PD_CD                            /* 투입부품상품코드 */
                           , D1.QOM_ASN_WARE_NO AS BEF_QOM_ASN_WARE_NO   /* 변경전 물량배정창고번호 */
                           , #{ostrWareNo}      AS QOM_ASN_WARE_NO       /* 물량배정창고번호 */
                           , D1.STR_WARE_DV_CD  AS BEF_WARE_DV_CD        /* 변경전 창고구분코드 */
	                       , CASE WHEN D5.DIDY_DV_CD = '1'
 	                               AND D5.WARE_DV_CD = '2' THEN '1'
			                      WHEN D5.DIDY_DV_CD = '1'
			                       AND D5.WARE_DV_CD = '3' THEN '2'
			                      WHEN D5.DIDY_DV_CD = '2' THEN '3'
			                      ELSE '9'
	                         END                AS WARE_DV_CD            /* 창고구분코드 */
                           , D1.STR_WARE_NO     AS BEF_STR_WARE_NO       /* 변경전 입고창고번호 */
	                       , CASE WHEN D5.DIDY_DV_CD = '2' THEN D5.WARE_NO
 	                              ELSE D5.HGR_WARE_NO
	                         END                AS STR_WARE_NO           /* 입고창고번호 */
                        FROM TB_SVPD_RGBS_PU_ITM_IZ D1                   /* 정기BS투입품목내역 */
                       INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D2          /* 고객서비스BS대상내역 */
                          ON D2.ASN_OJ_YM = D1.ASN_OJ_YM
                         AND D2.CNTR_NO   = D1.CNTR_NO
                         AND D2.CNTR_SN   = D1.CNTR_SN
                       INNER JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ D3           /* 월별고객서비스대상내역 */
                          ON D3.CNTR_NO = D2.CNTR_NO
                         AND D3.CNTR_SN = D2.CNTR_SN
                        LEFT OUTER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ D4   /* 고객서비스BS배정내역 */
                          ON D4.ASN_OJ_YM = D1.ASN_OJ_YM
                         AND D4.CNTR_NO   = D1.CNTR_NO
                         AND D4.CNTR_SN   = D1.CNTR_SN
                         AND D4.DTA_DL_YN = 'N'
                       INNER JOIN TB_SVST_MCBY_WARE_IZ D5               /* 월별창고내역 */
                          ON D5.OG_TP_CD           = CASE WHEN #{apyYm} = #{asnOjYm} THEN NVL(D4.CNFM_PSIC_PRTNR_OG_TP_CD, D3.FXN_PRTNR_OG_TP_CD)
	                                                      ELSE D3.FXN_PRTNR_OG_TP_CD
							                         END
                         AND D5.WARE_MNGT_PRTNR_NO = CASE WHEN #{apyYm} = #{asnOjYm} THEN NVL(D4.CNFM_PSIC_PRTNR_NO, D3.FXN_PRTNR_NO)
	                                                      ELSE D3.FXN_PRTNR_NO
					   		                         END
                       WHERE D1.DTA_DL_YN   = 'N'
                         AND D2.DTA_DL_YN   = 'N'
                         AND D3.DTA_DL_YN   = 'N'
                         AND D5.DTA_DL_YN   = 'N'
                         AND D5.WARE_USE_YN = 'Y'
                         AND D2.VST_DV_CD LIKE '1%'
                         AND D1.ASN_OJ_YM   = #{asnOjYm}
                         AND D3.MNGT_YM     = #{apyYm}
                         AND D5.APY_YM      = #{apyYm}
                    ) T1
                WHERE T1.BEF_QOM_ASN_WARE_NO <![CDATA[<>]]> T1.QOM_ASN_WARE_NO
                   OR T1.BEF_WARE_DV_CD <![CDATA[<>]]> T1.WARE_DV_CD
                   OR T1.BEF_STR_WARE_NO <![CDATA[<>]]> T1.STR_WARE_NO
             ) TB_SRC
            ON
             (
                   TB_TGT.ASN_OJ_YM       = TB_SRC.ASN_OJ_YM
               AND TB_TGT.CNTR_NO         = TB_SRC.CNTR_NO
               AND TB_TGT.CNTR_SN         = TB_SRC.CNTR_SN
               AND TB_TGT.SV_BIZ_MCLSF_CD = TB_SRC.SV_BIZ_MCLSF_CD
               AND TB_TGT.SV_BIZ_DCLSF_CD = TB_SRC.SV_BIZ_DCLSF_CD
               AND TB_TGT.WK_SN           = TB_SRC.WK_SN
               AND TB_TGT.PDCT_PD_CD      = TB_SRC.PDCT_PD_CD
               AND TB_TGT.IST_NMN_N       = TB_SRC.IST_NMN_N
               AND TB_TGT.PU_PART_PD_CD   = TB_SRC.PU_PART_PD_CD
             )
          WHEN MATCHED THEN
        UPDATE
           SET TB_TGT.QOM_ASN_WARE_NO = TB_SRC.QOM_ASN_WARE_NO
             , TB_TGT.STR_WARE_DV_CD  = TB_SRC.WARE_DV_CD
	         , TB_TGT.STR_WARE_NO     = TB_SRC.STR_WARE_NO
        <include refid="COMMON.updateSystemField"/>
    </update>


</mapper>
