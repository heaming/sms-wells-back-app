<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaItemOrderQuantityMapper">

    <sql id="selectWithProduct">
        SELECT T1.PD_CD
             , T1.PD_ABBR_NM                                 AS PD_NM
             , T1.SAP_MAT_CD                                 AS SAP_CD
             , REGEXP_REPLACE(T2.PD_PRP_VAL07, '[^0-9]', '') AS MOQ
             , T2.PD_PRP_VAL06                               AS LEAD_TIME
             , MIN(NVL(T2.PD_PRP_VAL20, T5.PD_PRP_VAL20))    AS ITEM_GR
          FROM TB_PDBS_PD_BAS T1                        /* 상품기본 */
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL T2          /* 상품각사속성상세 */
            ON T2.PD_CD = T1.PD_CD
          LEFT OUTER JOIN TB_SVST_CMPT_EXCD_ITM_IZ T3   /* 산출제외품목 */
            ON T3.ITM_PD_CD = T1.PD_CD
           AND T3.DTA_DL_YN = 'N'
           AND T3.MNGT_YM   = #{inqrYm}
          LEFT OUTER JOIN TB_PDBS_PD_REL T4             /* 상품관계 */
            ON T4.OJ_PD_CD     = T1.PD_CD
           AND T4.DTA_DL_YN    = 'N'
           AND T4.PD_REL_TP_CD = '14'   /* AS부품 */
           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T4.VL_STRT_DTM AND T4.VL_END_DTM
          LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL T5    /* 상품각사속성상세 */
            ON T5.PD_CD              = T4.BASE_PD_CD
           AND T5.DTA_DL_YN          = 'N'
           AND T5.PD_EXTS_PRP_GRP_CD = 'PART'
         WHERE T1.PD_TP_CD           = 'M'
           AND T1.DTA_DL_YN          = 'N'
           AND T2.PD_EXTS_PRP_GRP_CD = 'PART'
           AND T2.DTA_DL_YN          = 'N'
           AND T3.ITM_PD_CD IS NULL                 /* 산출제외품목이 아닌 것 */
        <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
           AND T2.PD_PRP_VAL19       = #{itmKndCd}
        </if>
        <if test="@MybatisUtils@isEmpty(itmKndCd)">
           AND T2.PD_PRP_VAL19      IN ('5', '6')   /* 필터, A/S자재 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
           AND T1.PD_CD              = #{itmPdCd}
        </if>
        <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
           AND T1.PD_CD IN
                        <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                            #{itmPdCd}
                        </foreach>
        </if>
        <if test="@MybatisUtils@isNotEmpty(strtSapCd)">
           AND T1.SAP_MAT_CD <![CDATA[>=]]> LPAD(#{strtSapCd}, 18, '0')
        </if>
        <if test="@MybatisUtils@isNotEmpty(endSapCd)">
           AND T1.SAP_MAT_CD <![CDATA[<=]]> LPAD(#{endSapCd}, 18, '0')
        </if>
        <if test="@MybatisUtils@isNotEmpty(strtSapCd) or @MybatisUtils@isNotEmpty(endSapCd)">
           AND T1.SAP_MAT_CD IS NOT NULL
        </if>
         GROUP BY T1.PD_CD, T1.PD_ABBR_NM, T1.SAP_MAT_CD, REGEXP_REPLACE(T2.PD_PRP_VAL07, '[^0-9]', ''), T2.PD_PRP_VAL06
    </sql>

    <select id="selectItemOrderQuantityCount" resultType="java.lang.Long">
          WITH PD AS
             ( <include refid="selectWithProduct" /> )
        SELECT COUNT(*)
          FROM PD D1   /* WITH절 상품 */
          LEFT OUTER JOIN
             (
               SELECT /*+ USE_HASH(D1 D2) */
                      D1.PART_PD_CD        AS ITM_PD_CD
                    , SUM(D1.PART_USE_QTY) AS PART_USE_QTY
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1      /* 고객서비스정기BS주기내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D2.CNTR_DTL_STAT_CD = '101'   /* 정상 */
                  AND D1.MTR_CAN_DT IS NULL
                  AND D2.REQD_DT IS NULL
                  AND D2.CPS_DT IS NULL
                  AND D2.CHNG_DT IS NULL
                  AND D2.IST_DT IS NOT NULL
                  AND D1.VST_DUEDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), 1), 'YYYYMM') || '%'
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PART_PD_CD = #{itmPdCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PART_PD_CD IN
                                     <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                        #{itmPdCd}
                                     </foreach>
            </if>
                GROUP BY D1.PART_PD_CD
             ) D3
            ON D3.ITM_PD_CD = D1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ USE_HASH(D1 D2) */
                      D1.PART_PD_CD        AS ITM_PD_CD
                    , SUM(D1.PART_USE_QTY) AS PART_USE_QTY
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1      /* 고객서비스정기BS주기내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D2.CNTR_DTL_STAT_CD = '101'   /* 정상 */
                  AND D1.MTR_CAN_DT IS NULL
                  AND D2.REQD_DT IS NULL
                  AND D2.CPS_DT IS NULL
                  AND D2.CHNG_DT IS NULL
                  AND D2.IST_DT IS NOT NULL
                  AND D1.VST_DUEDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), 2), 'YYYYMM') || '%'
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PART_PD_CD = #{itmPdCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PART_PD_CD IN
                                     <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                        #{itmPdCd}
                                     </foreach>
            </if>
                GROUP BY D1.PART_PD_CD
             ) D4
            ON D4.ITM_PD_CD = D1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ USE_HASH(D1 D2) */
                      D1.PART_PD_CD        AS ITM_PD_CD
                    , SUM(D1.PART_USE_QTY) AS PART_USE_QTY
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1      /* 고객서비스정기BS주기내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D2.CNTR_DTL_STAT_CD = '101'   /* 정상 */
                  AND D1.MTR_CAN_DT IS NULL
                  AND D2.REQD_DT IS NULL
                  AND D2.CPS_DT IS NULL
                  AND D2.CHNG_DT IS NULL
                  AND D2.IST_DT IS NOT NULL
                  AND D1.VST_DUEDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), 3), 'YYYYMM') || '%'
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PART_PD_CD = #{itmPdCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PART_PD_CD IN
                                     <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                        #{itmPdCd}
                                     </foreach>
            </if>
                GROUP BY D1.PART_PD_CD
             ) D5
            ON D5.ITM_PD_CD = D1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ USE_HASH(D1 D2) */
                      D1.PART_PD_CD        AS ITM_PD_CD
                    , SUM(D1.PART_USE_QTY) AS PART_USE_QTY
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1      /* 고객서비스정기BS주기내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D2.CNTR_DTL_STAT_CD = '101'   /* 정상 */
                  AND D1.MTR_CAN_DT IS NULL
                  AND D2.REQD_DT IS NULL
                  AND D2.CPS_DT IS NULL
                  AND D2.CHNG_DT IS NULL
                  AND D2.IST_DT IS NOT NULL
                  AND D1.VST_DUEDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), 4), 'YYYYMM') || '%'
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PART_PD_CD = #{itmPdCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PART_PD_CD IN
                                     <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                        #{itmPdCd}
                                     </foreach>
            </if>
                GROUP BY D1.PART_PD_CD
             ) D6
            ON D6.ITM_PD_CD = D1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ USE_HASH(D1 D2) */
                      D1.PART_PD_CD        AS ITM_PD_CD
                    , SUM(D1.PART_USE_QTY) AS PART_USE_QTY
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1      /* 고객서비스정기BS주기내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D2.CNTR_DTL_STAT_CD = '101'   /* 정상 */
                  AND D1.MTR_CAN_DT IS NULL
                  AND D2.REQD_DT IS NULL
                  AND D2.CPS_DT IS NULL
                  AND D2.CHNG_DT IS NULL
                  AND D2.IST_DT IS NOT NULL
                  AND D1.VST_DUEDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), 5), 'YYYYMM') || '%'
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PART_PD_CD = #{itmPdCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PART_PD_CD IN
                                     <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                        #{itmPdCd}
                                     </foreach>
            </if>
                GROUP BY D1.PART_PD_CD
             ) D7
            ON D7.ITM_PD_CD = D1.PD_CD
         WHERE D3.PART_USE_QTY <![CDATA[>]]> 0
            OR D4.PART_USE_QTY <![CDATA[>]]> 0
            OR D5.PART_USE_QTY <![CDATA[>]]> 0
            OR D6.PART_USE_QTY <![CDATA[>]]> 0
            OR D7.PART_USE_QTY <![CDATA[>]]> 0
    </select>

    <select id="selectItemOrderQuantitiy" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaItemOrderQuantityDvo">
          WITH PD AS
             ( <include refid="selectWithProduct" /> )
        SELECT F_CMZ_CD_NM('TNT_WELLS', 'PD_GRP_CD', D1.ITEM_GR, #{session.langId})            AS COMM_GB_NM        /* 제품군 */
             , TO_CHAR(TO_NUMBER(D1.SAP_CD))                                                   AS SAP_CD            /* SAP코드 */
             , D1.PD_CD                                                                                             /* 품목코드 */
             , D1.PD_NM                                                                                             /* 품목명 */
             , NVL(D2.BZNS_OG_QTY, 0)                                                          AS BZNS_OG_QTY       /* 영업조직 */
             , NVL(D2.BZNS_INDV_QTY, 0)                                                        AS BZNS_INDV_QTY     /* 영업개인 */
             , NVL(D2.SV_CNR_QTY, 0)                                                           AS SV_CNR_QTY        /* 서비스센터 */
             , NVL(D9.BTD_STOC_A_GD_QTY, 0)                                                    AS LOGISTIC_CNR_QTY  /* 물류센터 재고 */
             , NVL(D8.THM_QOM_ASN_QTY, 0)                                                      AS THM_QOM_ASN_QTY   /* 당월물량배정 */
             , NVL(D8.PCSV_QTY, 0)                                                             AS PCSV_QTY          /* 택배 */
             , NVL(D9.BTD_STOC_A_GD_QTY, 0) + NVL(D8.THM_QOM_ASN_QTY, 0) + NVL(D8.PCSV_QTY, 0) AS LOGISTIC_SUM      /* 물류 계 */
             , NVL(D3.PART_USE_QTY, 0)                                                         AS ET_NED_QTY1       /* 예상소요량 1개월 */
             , NVL(D4.PART_USE_QTY, 0)                                                         AS ET_NED_QTY2       /* 예상소요량 2개월 */
             , NVL(D5.PART_USE_QTY, 0)                                                         AS ET_NED_QTY3       /* 예상소요량 3개월 */
             , NVL(D6.PART_USE_QTY, 0)                                                         AS ET_NED_QTY4       /* 예상소요량 4개월 */
             , D1.MOQ                                                                                               /* 최소발주량 */
             , D1.LEAD_TIME                                                                                         /* 리드타임 */
             , NVL(D7.PART_USE_QTY, 0)                                                         AS ET_NED_QTY5       /* 예상소요량 5개월 */
          FROM PD D1   /* WITH절 상품 */
          LEFT OUTER JOIN
             (
               SELECT T.ITM_PD_CD
                    , SUM(T.BZNS_OG_QTY)     AS BZNS_OG_QTY
                    , SUM(T.BZNS_INDV_QTY)   AS BZNS_INDV_QTY
                    , SUM(T.SV_CNR_QTY)      AS SV_CNR_QTY
                 FROM
                    (
                      SELECT D1.ITM_PD_CD
                           , SUM(CASE WHEN D3.WARE_DTL_DV_CD = '30'
                                      THEN D1.PITM_STOC_A_GD_QTY
                                 END) AS BZNS_OG_QTY       /* 영업조직 */
                           , SUM(CASE WHEN D3.WARE_DV_CD = '3' AND D3.WARE_DTL_DV_CD <![CDATA[<>]]> '30'
                                      THEN D1.PITM_STOC_A_GD_QTY
                                 END) AS BZNS_INDV_QTY     /* 영업개인 */
                           , SUM(CASE WHEN D3.WARE_DV_CD = '2'
                                      THEN D1.PITM_STOC_A_GD_QTY
                                 END) AS SV_CNR_QTY        /* 서비스센터 */
                        FROM TB_SVST_MCITM_STOC_IZ D1       /* 월별품목재고내역 */
                       INNER JOIN TB_SVST_MCBY_WARE_IZ D3   /* 월별창고내역 */
                          ON D3.WARE_NO = D1.WARE_NO
                         AND D3.APY_YM  = D1.BASE_YM
                       WHERE D1.DTA_DL_YN   = 'N'
                         AND D3.DTA_DL_YN   = 'N'
                         AND D3.WARE_USE_YN = 'Y'
                         AND D1.BASE_YM     = TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), -1),'YYYYMM')
                         AND D3.APY_YM      = TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), -1),'YYYYMM')
                    <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                         AND D1.ITM_PD_CD = #{itmPdCd}
                    </if>
                    <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                         AND D1.ITM_PD_CD IN
                                             <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                              #{itmPdCd}
                                             </foreach>
                    </if>
                       GROUP BY D1.ITM_PD_CD
                       UNION ALL
                      SELECT D1.ITM_PD_CD
                           , SUM(CASE WHEN D3.WARE_DTL_DV_CD = '30'
                                      THEN NVL(D1.STOC_ACINSP_STR_A_GD_QTY, 0) - NVL(D1.STOC_ACINSP_OSTR_A_GD_QTY, 0)
                                 END) AS BZNS_OG_QTY       /* 영업조직 */
                           , SUM(CASE WHEN D3.WARE_DV_CD = '3' AND D3.WARE_DTL_DV_CD <![CDATA[<>]]> '30'
                                      THEN NVL(D1.STOC_ACINSP_STR_A_GD_QTY, 0) - NVL(D1.STOC_ACINSP_OSTR_A_GD_QTY, 0)
                                 END) AS BZNS_INDV_QTY     /* 영업개인 */
                           , SUM(CASE WHEN D3.WARE_DV_CD = '2'
                                      THEN NVL(D1.STOC_ACINSP_STR_A_GD_QTY, 0) - NVL(D1.STOC_ACINSP_OSTR_A_GD_QTY, 0)
                                 END) AS SV_CNR_QTY        /* 서비스센터 */
                        FROM TB_SVST_MCITM_STOC_IZ D1       /* 월별품목재고내역 */
                       INNER JOIN TB_SVST_MCBY_WARE_IZ D3   /* 월별창고내역 */
                          ON D3.APY_YM  = D1.BASE_YM
                         AND D3.WARE_NO = D1.WARE_NO
                       WHERE D1.DTA_DL_YN   = 'N'
                         AND D3.DTA_DL_YN   = 'N'
                         AND D3.WARE_USE_YN = 'Y'
                         AND D1.BASE_YM     = #{inqrYm}
                         AND D3.APY_YM      = #{inqrYm}
                    <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                         AND D1.ITM_PD_CD   = #{itmPdCd}
                    </if>
                    <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                         AND D1.ITM_PD_CD IN
                                             <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                              #{itmPdCd}
                                             </foreach>
                    </if>
                       GROUP BY D1.ITM_PD_CD
                       UNION ALL
                      SELECT D1.ITM_PD_CD
                           , SUM(CASE WHEN D3.WARE_DTL_DV_CD = '30' THEN D1.STR_QTY END) AS BZNS_OG_QTY       /* 영업조직 */
                           , SUM(CASE WHEN D3.WARE_DV_CD = '3'
                                       AND D3.WARE_DTL_DV_CD <![CDATA[<>]]> '30' THEN D1.STR_QTY
                                 END)                                                    AS BZNS_INDV_QTY     /* 영업개인 */
                           , SUM(CASE WHEN D3.WARE_DV_CD = '2' THEN D1.STR_QTY END)      AS SV_CNR_QTY        /* 서비스센터 */
                        FROM TB_SVST_ITM_STR_IZ D1          /* 품목입고내역 */
                       INNER JOIN TB_SVST_MCBY_WARE_IZ D3   /* 월별창고내역 */
                          ON D3.WARE_NO = D1.STR_WARE_NO
                         AND D3.APY_YM  = SUBSTR(D1.STR_RGST_DT, 1, 6)
                       WHERE D1.DTA_DL_YN   = 'N'
                         AND D1.ITM_GD_CD   = 'A'   /* A급*/
                         AND D3.DTA_DL_YN   = 'N'
                         AND D3.WARE_USE_YN = 'Y'
                         AND D3.APY_YM      = #{inqrYm}
                         AND D1.STR_RGST_DT LIKE #{inqrYm} || '%'
                    <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                         AND D1.ITM_PD_CD   = #{itmPdCd}
                    </if>
                    <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                         AND D1.ITM_PD_CD IN
                                             <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                              #{itmPdCd}
                                             </foreach>
                    </if>
                       GROUP BY D1.ITM_PD_CD
                       UNION ALL
                      SELECT D1.ITM_PD_CD
                           , SUM(CASE WHEN D3.WARE_DTL_DV_CD = '30'
                                      THEN CASE WHEN D1.SV_BIZ_HCLSF_CD = '6' THEN D1.USE_QTY
                                                ELSE D1.USE_QTY * -1
                                           END
                                 END) AS BZNS_OG_QTY       /* 영업조직 */
                           , SUM(CASE WHEN D3.WARE_DV_CD = '3'
                                       AND D3.WARE_DTL_DV_CD <![CDATA[<>]]> '30' THEN CASE WHEN D1.SV_BIZ_HCLSF_CD = '6' THEN D1.USE_QTY
                                                                                           ELSE D1.USE_QTY * -1
                                                                                      END
                                 END) AS BZNS_INDV_QTY     /* 영업개인 */
                           , SUM(CASE WHEN D3.WARE_DV_CD = '2'
                                      THEN CASE WHEN D1.SV_BIZ_HCLSF_CD = '6' THEN D1.USE_QTY
                                                ELSE D1.USE_QTY * -1
                                           END
                                 END) AS SV_QTY            /* 서비스 */
                        FROM TB_SVST_SV_WK_OSTR_IZ D1       /* 서비스작업출고내역 */
                       INNER JOIN TB_SVST_MCBY_WARE_IZ D3   /* 월별창고내역 */
                          ON D3.WARE_NO = D1.WK_WARE_NO
                         AND D3.APY_YM  = SUBSTR(D1.FNL_VST_FSH_DT, 1, 6)
                       WHERE D1.DTA_DL_YN     = 'N'
                         AND D1.FNL_ITM_GD_CD = 'A'   /* A급 */
                         AND D1.USE_QTY <![CDATA[>]]> 0
                         AND D1.SV_BIZ_HCLSF_CD IN ('1', '2', '3', '4', '6')
                         AND D3.DTA_DL_YN     = 'N'
                         AND D3.WARE_USE_YN   = 'Y'
                         AND D3.APY_YM        = #{inqrYm}
                         AND D1.FNL_VST_FSH_DT LIKE #{inqrYm} || '%'
                    <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                         AND D1.ITM_PD_CD = #{itmPdCd}
                    </if>
                    <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                         AND D1.ITM_PD_CD IN
                                         <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                              #{itmPdCd}
                                         </foreach>
                    </if>
                       GROUP BY D1.ITM_PD_CD
                       UNION ALL
                      SELECT D1.ITM_PD_CD
                           , SUM(CASE WHEN D3.WARE_DTL_DV_CD = '30' THEN D1.OSTR_QTY * -1 END) AS BZNS_OG_QTY       /* 영업조직 */
                           , SUM(CASE WHEN D3.WARE_DV_CD = '3'
                                       AND D3.WARE_DTL_DV_CD <![CDATA[<>]]> '30' THEN D1.OSTR_QTY * -1
                                 END)                                                          AS BZNS_INDV_QTY     /* 영업개인 */
                           , SUM(CASE WHEN D3.WARE_DV_CD = '2' THEN D1.OSTR_QTY * -1 END)      AS SV_CNR_QTY        /* 서비스 */
                        FROM TB_SVST_ITM_OSTR_IZ D1         /* 품목출고내역 */
                       INNER JOIN TB_SVST_MCBY_WARE_IZ D3   /* 월별창고내역 */
                          ON D3.WARE_NO = D1.OSTR_WARE_NO
                         AND D3.APY_YM  = SUBSTR(D1.OSTR_DT, 1, 6)
                       WHERE D1.DTA_DL_YN   = 'N'
                         AND D1.ITM_GD_CD   = 'A'   /* A급 */
                         AND D3.DTA_DL_YN   = 'N'
                         AND D3.WARE_USE_YN = 'Y'
                         AND D3.APY_YM      = #{inqrYm}
                         AND D1.OSTR_DT LIKE #{inqrYm} || '%'
                    <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                         AND D1.ITM_PD_CD = #{itmPdCd}
                    </if>
                    <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                         AND D1.ITM_PD_CD IN
                                         <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                              #{itmPdCd}
                                         </foreach>
                    </if>
                       GROUP BY D1.ITM_PD_CD
                    ) T
                GROUP BY T.ITM_PD_CD
             ) D2
            ON D2.ITM_PD_CD = D1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ USE_HASH(D1 D2) */
                      D1.PART_PD_CD        AS ITM_PD_CD
                    , SUM(D1.PART_USE_QTY) AS PART_USE_QTY
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1      /* 고객서비스정기BS주기내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D2.CNTR_DTL_STAT_CD = '101'   /* 정상 */
                  AND D1.MTR_CAN_DT IS NULL
                  AND D2.REQD_DT IS NULL
                  AND D2.CPS_DT IS NULL
                  AND D2.CHNG_DT IS NULL
                  AND D2.IST_DT IS NOT NULL
                  AND D1.VST_DUEDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), 1), 'YYYYMM') || '%'
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PART_PD_CD = #{itmPdCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PART_PD_CD IN
                                     <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                        #{itmPdCd}
                                     </foreach>
            </if>
                GROUP BY D1.PART_PD_CD
             ) D3
            ON D3.ITM_PD_CD = D1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ USE_HASH(D1 D2) */
                      D1.PART_PD_CD        AS ITM_PD_CD
                    , SUM(D1.PART_USE_QTY) AS PART_USE_QTY
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1      /* 고객서비스정기BS주기내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D2.CNTR_DTL_STAT_CD = '101'   /* 정상 */
                  AND D1.MTR_CAN_DT IS NULL
                  AND D2.REQD_DT IS NULL
                  AND D2.CPS_DT IS NULL
                  AND D2.CHNG_DT IS NULL
                  AND D2.IST_DT IS NOT NULL
                  AND D1.VST_DUEDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), 2), 'YYYYMM') || '%'
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PART_PD_CD = #{itmPdCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PART_PD_CD IN
                                     <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                        #{itmPdCd}
                                     </foreach>
            </if>
                GROUP BY D1.PART_PD_CD
             ) D4
            ON D4.ITM_PD_CD = D1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ USE_HASH(D1 D2) */
                      D1.PART_PD_CD        AS ITM_PD_CD
                    , SUM(D1.PART_USE_QTY) AS PART_USE_QTY
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1      /* 고객서비스정기BS주기내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D2.CNTR_DTL_STAT_CD = '101'   /* 정상 */
                  AND D1.MTR_CAN_DT IS NULL
                  AND D2.REQD_DT IS NULL
                  AND D2.CPS_DT IS NULL
                  AND D2.CHNG_DT IS NULL
                  AND D2.IST_DT IS NOT NULL
                  AND D1.VST_DUEDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), 3), 'YYYYMM') || '%'
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PART_PD_CD = #{itmPdCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PART_PD_CD IN
                                     <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                        #{itmPdCd}
                                     </foreach>
            </if>
                GROUP BY D1.PART_PD_CD
             ) D5
            ON D5.ITM_PD_CD = D1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ USE_HASH(D1 D2) */
                      D1.PART_PD_CD        AS ITM_PD_CD
                    , SUM(D1.PART_USE_QTY) AS PART_USE_QTY
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1      /* 고객서비스정기BS주기내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D2.CNTR_DTL_STAT_CD = '101'   /* 정상 */
                  AND D1.MTR_CAN_DT IS NULL
                  AND D2.REQD_DT IS NULL
                  AND D2.CPS_DT IS NULL
                  AND D2.CHNG_DT IS NULL
                  AND D2.IST_DT IS NOT NULL
                  AND D1.VST_DUEDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), 4), 'YYYYMM') || '%'
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PART_PD_CD = #{itmPdCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PART_PD_CD IN
                                     <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                        #{itmPdCd}
                                     </foreach>
            </if>
                GROUP BY D1.PART_PD_CD
             ) D6
            ON D6.ITM_PD_CD = D1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ USE_HASH(D1 D2) */
                      D1.PART_PD_CD        AS ITM_PD_CD
                    , SUM(D1.PART_USE_QTY) AS PART_USE_QTY
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1      /* 고객서비스정기BS주기내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D2.CNTR_DTL_STAT_CD = '101'   /* 정상 */
                  AND D1.MTR_CAN_DT IS NULL
                  AND D2.REQD_DT IS NULL
                  AND D2.CPS_DT IS NULL
                  AND D2.CHNG_DT IS NULL
                  AND D2.IST_DT IS NOT NULL
                  AND D1.VST_DUEDT LIKE TO_CHAR(ADD_MONTHS(TO_DATE(#{inqrYm}, 'YYYYMM'), 5), 'YYYYMM') || '%'
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PART_PD_CD = #{itmPdCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PART_PD_CD IN
                                     <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                        #{itmPdCd}
                                     </foreach>
            </if>
                GROUP BY D1.PART_PD_CD
             ) D7
            ON D7.ITM_PD_CD = D1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ INDEX(D2 IX_SVPD_CST_SV_BFSVC_OJ_IZ_03) USE_NL(D2 D1) */
                      D1.PU_PART_PD_CD AS ITM_PD_CD
                    , SUM(CASE WHEN D2.VST_DV_CD LIKE '1%' THEN D1.PU_QTY END) AS THM_QOM_ASN_QTY
                    , SUM(CASE WHEN D2.VST_DV_CD = '20' THEN D1.PU_QTY END)    AS PCSV_QTY
                 FROM TB_SVPD_RGBS_PU_ITM_IZ D1            /* 정기BS투입품목내역 */
                INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D2   /* 고객서비스BS대상내역 */
                   ON D2.CST_SV_ASN_NO = D1.CST_SV_ASN_NO
                  AND D2.ASN_OJ_YM     = D1.ASN_OJ_YM
                WHERE D1.DTA_DL_YN     = 'N'
                  AND D2.VST_DV_CD <![CDATA[<>]]> '13'
                  AND D1.ASN_OJ_YM     = #{inqrYm}
                  AND D2.ASN_OJ_YM     = #{inqrYm}
            <if test="@MybatisUtils@isNotEmpty(itmPdCd)">
                  AND D1.PU_PART_PD_CD = #{itmPdCd}
            </if>
            <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND D1.PU_PART_PD_CD IN
                                     <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                           #{itmPdCd}
                                     </foreach>
            </if>
                GROUP BY D1.PU_PART_PD_CD
             ) D8
            ON D8.ITM_PD_CD = D1.PD_CD
          LEFT OUTER JOIN TB_SVST_MCITM_STOC_IZ D9   /* 월별품목재고내역 */
            ON D9.ITM_PD_CD = D1.PD_CD
           AND D9.DTA_DL_YN = 'N'
           AND D9.WARE_NO   = '100002'   /* 교원파주물류센터 */
           AND D9.BASE_YM   = #{inqrYm}
         WHERE D3.PART_USE_QTY <![CDATA[>]]> 0
            OR D4.PART_USE_QTY <![CDATA[>]]> 0
            OR D5.PART_USE_QTY <![CDATA[>]]> 0
            OR D6.PART_USE_QTY <![CDATA[>]]> 0
            OR D7.PART_USE_QTY <![CDATA[>]]> 0
         ORDER BY D1.PD_CD
        <if test="@MybatisUtils@isNotEmpty(offSet) and @MybatisUtils@isNotEmpty(size)">
        OFFSET ${offSet} ROW FETCH NEXT ${size} ROW ONLY
        </if>
    </select>

</mapper>
