<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaMaterialsAssignStocksMapper">
    <select id="selectMaterialsAssignStocks"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaMaterialsAssignStocksDto$SearchRes">
        SELECT T1.BASE_YM
             , T1.OG_TP_CD
             , T1.PRTNR_NO
             , T1.PRTNR_KNM
             , T1.OG_ID
             , T1.OG_CD
             , T1.OG_NM
             , T2.QOM_ASN_APY_YN
             , ( SELECT MAX(S1.APY_SN)
                   FROM TB_SVST_QOM_ASN_PRTNR_APY_IZ S1
                  WHERE S1.PRTNR_NO = T1.PRTNR_NO
               ) AS APY_SN
             , T3.WARE_NO
             , T3.WARE_NM
             , T3.WARE_DV_CD
             , T3.WARE_DTL_DV_CD
             , F_CMZ_CD_NM(#{session.tenantId}
                 , 'WARE_DTL_DV_CD'
                 , T3.WARE_DTL_DV_CD) AS WARE_DTL_DV_NM
             , T3.HGR_WARE_NO
             , ( SELECT WARE_NM
                   FROM TB_SVST_MCBY_WARE_IZ S2
                  WHERE S2.APY_YM = T3.APY_YM
                    AND S2.WARE_NO = T3.HGR_WARE_NO
               ) AS HGR_WARE_NM
             , T3.DIDY_DV_CD
             , ( CASE WHEN T3.DIDY_DV_CD  = '2' THEN '독립'
                      ELSE '개인'
                 END
               ) AS DIDY_DV_NM
             , T3.BLD_CD
             , T3.ADR_USE_YN
             , T3.RMK_CN
             , T3.WARE_ADR_ID
             , T4.RNADR
             , T4.RDADR
             , T4.NEW_ADR_ZIP
             , T5.BLD_NM
        FROM TB_OGBS_MM_PRTNR_IZ T1
       INNER JOIN TB_SVST_QOM_ASN_PRTNR_APY_IZ T2
          ON T2.PRTNR_NO = T1.PRTNR_NO
       INNER JOIN TB_SVST_MCBY_WARE_IZ T3
          ON T3.WARE_MNGT_PRTNR_NO = T2.PRTNR_NO
             AND T3.APY_YM = T1.BASE_YM
       INNER JOIN TB_GBCO_ADR_BAS T4
          ON T3.WARE_ADR_ID = T4.ADR_ID
       INNER JOIN TB_OGBS_BLD_BAS T5
          ON T3.BLD_CD = T5.BLD_CD
     <where>
         AND T1.BASE_YM = #{baseYm}
       <if test="@MybatisUtils@isNotEmpty(ogTpCd)">
         AND T1.OG_TP_CD = #{ogTpCd}
       </if>
       <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
         AND T1.PRTNR_NO = #{prtnrNo}
       </if>
       <if test="@MybatisUtils@isNotEmpty(prtnrKnm)">
         AND T1.PRTNR_KNM LIKE '%'||#{prtnrKnm}||'%'
       </if>
       <if test="@MybatisUtils@isNotEmpty(wareDvCd)">
         AND T3.WARE_DV_CD = #{wareDvCd}
       </if>
        <if test="@MybatisUtils@isNotEmpty(wareDtlDvCd)">
         AND T3.WARE_DTL_DV_CD = #{wareDtlDvCd}
       </if>
       <if test="@MybatisUtils@isNotEmpty(wareNo)">
         AND T3.WARE_NO = #{wareNo}
       </if>
       <if test="@MybatisUtils@isNotEmpty(hgrWareNo)">
         AND T3.WARE_NO = #{hgrWareNo}
       </if>
         AND T3.WARE_USE_YN = 'Y'
         AND T1.DTA_DL_YN = 'N'
         AND T2.DTA_DL_YN = 'N'
         AND T3.DTA_DL_YN = 'N'
         AND T4.DTA_DL_YN = 'N'
         AND T5.DTA_DL_YN = 'N'
     </where>
    </select>

    <select id="selectMaterialsAssignStocks_old"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaMaterialsAssignStocksDto$SearchRes">
        SELECT T1.BASE_YM
             , T1.OG_ID
             , T1.HGR_OG_ID
             , T1.OG_TP_CD
             , T1.OG_CD
             , T1.OG_NM
             , T1.BLD_CD
             , T1.BLD_NM
             , T2.PRTNR_NO
             , T2.PRTNR_KNM
             , ( SELECT MAX(S1.APY_SN)
                   FROM TB_SVST_QOM_ASN_PRTNR_APY_IZ S1
                  WHERE S1.PRTNR_NO = T3.PRTNR_NO) AS APY_SN
             , T3.QOM_ASN_APY_YN
             , T4.WARE_NO
             , T4.WARE_NM
             , T4.HGR_WARE_NO
             , ( SELECT S2.WARE_NM
                   FROM TB_SVST_MCBY_WARE_IZ S2
                  WHERE S2.WARE_NO = T4.HGR_WARE_NO
                    AND S2.APY_YM = T4.APY_YM) AS HGR_WARE_NM
             , T4.DIDY_DV_CD
             , (CASE WHEN T4.DIDY_DV_CD = '2' THEN '독립'
                     ELSE '개인'
                END
               ) AS DIDY_DV_NM
             , T4.ADR_USE_YN
             , T4.WARE_ADR_ID
             , T5.RDADR
             , T5.NEW_ADR_ZIP
          FROM ( SELECT BASE_YM
                      , OG_ID
                      , HGR_OG_ID
                      , OG_TP_CD
                      , OG_CD
                      , OG_NM
                      , BLD_CD
                      , BLD_NM
                   FROM TB_OGBS_MM_OG_IZ
                  WHERE BASE_YM = #{baseYm}
                    /* AND OG_TP_CD = 'W02' */
                    AND OG_CD IS NOT NULL
                    AND OG_NM IS NOT NULL
                    AND DTA_DL_YN = 'N'
                  START WITH HGR_OG_ID = #{ogId}
                CONNECT BY PRIOR OG_ID = HGR_OG_ID
               ) T1
         INNER JOIN TB_OGBS_MM_PRTNR_IZ T2
            ON T2.BASE_YM = T1.BASE_YM AND T2.OG_ID = T1.OG_ID
         INNER JOIN TB_SVST_QOM_ASN_PRTNR_APY_IZ T3
            ON T3.PRTNR_NO = T2.PRTNR_NO
         INNER JOIN TB_SVST_MCBY_WARE_IZ T4
            ON T4.WARE_MNGT_PRTNR_NO = T3.PRTNR_NO
           AND T4.APY_YM = T1.BASE_YM
         INNER JOIN TB_GBCO_ADR_BAS T5
            ON T4.WARE_ADR_ID = T5.ADR_ID
        <where>
          <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
           AND T3.PRTNR_NO = #{prtnrNo}
          </if>
          <if test="@MybatisUtils@isNotEmpty(hgrWareNo)">
           AND T4.HGR_WARE_NO = #{hgrWareNo}
          </if>
           AND T2.DTA_DL_YN = 'N'
           AND T3.DTA_DL_YN = 'N'
           AND T4.DTA_DL_YN = 'N'
           AND T5.DTA_DL_YN = 'N'
           AND T4.WARE_USE_YN = 'Y'
        </where>
    </select>

    <select id="selectOrganizations"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaMaterialsAssignStocksDto$OgRes">
        SELECT OG_ID
             , HGR_OG_ID
             , OG_TP_CD
             , OG_LEVL_DV_CD
             , OG_CD
             , ( CASE OG_LEVL_DV_CD
                 WHEN '1' THEN NULL
                 WHEN '2' THEN DGR1_LEVL_OG_CD
                 WHEN '3' THEN DGR2_LEVL_OG_CD
                 WHEN '4' THEN DGR3_LEVL_OG_CD
                 WHEN '5' THEN DGR4_LEVL_OG_CD
                 ELSE NULL END
               ) AS HGR_OG_CD
             , OG_NM
             , BLD_CD
             , BLD_NM
             , HOO_OG_TP_CD
             , HOO_PRTNR_NO
             , HOO_PRTNR_NM
          FROM TB_OGBS_MM_OG_IZ
         WHERE BASE_YM = #{baseYm}
           <if test="@MybatisUtils@isNotEmpty(ogLevlDvCd)">
           AND OG_LEVL_DV_CD = #{ogLevlDvCd}
           </if>
           <if test="@MybatisUtils@isNotEmpty(ogId)">
           AND OG_ID = #{ogId}
           </if>
           <if test="@MybatisUtils@isNotEmpty(ogTpCd)">
           AND OG_TP_CD = #{ogTpCd}
           </if>
           AND CLO_YN = 'N'
           AND DTA_DL_YN = 'N'
           AND OG_CD IS NOT NULL
           AND OG_NM IS NOT NULL
         START WITH HGR_OG_ID IS NULL
       CONNECT BY PRIOR OG_ID = HGR_OG_ID
    </select>
    <select id="selectPartners"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaMaterialsAssignStocksDto$PrtnrRes">
        SELECT OG_ID
             , PRTNR_NO
             , PRTNR_KNM
          FROM TB_OGBS_MM_PRTNR_IZ
         WHERE BASE_YM = #{baseYm}
           <if test="@MybatisUtils@isNotEmpty(ogId)">
           AND OG_ID = #{ogId}
           </if>
    </select>
    <insert id="insertMaterialsAssignStocks">
        INSERT INTO TB_SVST_QOM_ASN_PRTNR_APY_IZ (
               PRTNR_NO /* 파트너번호 */
             , OG_TP_CD /*조직유형코드 */
             , APY_SN /* 적용일련번호 */
             , QOM_ASN_APY_YN /* 물량배정적용여부 */
             , DTA_DL_YN /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemField"/>
        )
        <foreach collection="list" item="item" separator=" UNION ALL" >
        SELECT
             #{item.prtnrNo}
             , OG_TP_CD /*조직유형코드 */
             , APY_SN + 1 /* 적용일련번호 */
             , #{item.qomAsnApyYn} /* 물량배정적용여부 */
             , DTA_DL_YN /* 데이터삭제여부 */
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_SVST_QOM_ASN_PRTNR_APY_IZ
         WHERE PRTNR_NO = #{item.prtnrNo}
           AND APY_SN = (SELECT MAX(APY_SN)
                           FROM TB_SVST_QOM_ASN_PRTNR_APY_IZ
                          WHERE PRTNR_NO = #{item.prtnrNo}
                        )
        </foreach>
    </insert>
</mapper>
