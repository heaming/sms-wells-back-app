<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaInAggregateMapper">

    <select id="selectMcByWares" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaInAggregateWareDvo">
      SELECT WARE_NO                AS WARE_NO
           , SUBSTR(WARE_NM, 1, 5)  AS WARE_NM
           , 0                      AS SORT_DV_VAL
      FROM TB_SVST_MCBY_WARE_IZ
      WHERE APY_YM = SUBSTR(#{baseDateFrom}, 1, 6)   /* 서비스센터, 영업센터 */
       AND WARE_DTL_DV_CD IN ('20', '30')
       AND DTA_DL_YN = 'N'
       AND WARE_USE_YN = 'Y'
       AND WARE_NM IS NOT NULL
       AND WARE_DV_CD = #{wareDvCd}
      UNION ALL
      (
        SELECT WARE_NO               AS WARE_NO
             , SUBSTR(WARE_NM, 1, 4) AS WARE_NM
             , 0                     AS SORT_DV_VAL
        FROM TB_SVST_MCBY_WARE_IZ
        WHERE WARE_NO  IN ('100002')               /* 물류센터 */
         AND APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
         AND DTA_DL_YN = 'N'
         AND WARE_USE_YN = 'Y'
      )
      UNION ALL                                   /* 엔지니어, LP */
	  (
        <if test='@MybatisUtils@equals(wareDvCd, "2")'>
        (
         SELECT '299999'     AS WARE_NO
              , '엔지니어'     AS WARE_NM
              , 0            AS SORT_DV_VAL
         FROM DUAL
        )
        </if>
        <if test='@MybatisUtils@equals(wareDvCd, "3")'>
        (
         SELECT '399999'     AS WARE_NO
              , 'LP'         AS WARE_NM
              , 0            AS SORT_DV_VAL
         FROM DUAL
        )
        </if>
        <if test="@MybatisUtils@equals( isSumFields , true )">
        UNION ALL                                /* 합계 */
        (
         SELECT '100000'      AS WARE_NO
              , '계'         AS WARE_NM         /* 물류센터 합계 */
              , 1            AS SORT_DV_VAL
         FROM DUAL
        )
        <if test='@MybatisUtils@equals(wareDvCd, "2")'>
        UNION ALL
        (
         SELECT '200000'    AS WARE_NO
              , '계'        AS WARE_NM         /* 서비스센터 합계 */
              , 1          AS SORT_DV_VAL
         FROM DUAL
        )
        </if>
        <if test='@MybatisUtils@equals(wareDvCd, "3")'>
        UNION ALL
        (
         SELECT '300000'     AS WARE_NO
              , '계'          AS WARE_NM       /* 영업센터 합계 */
              , 1            AS SORT_DV_VAL
         FROM DUAL
        )
        </if>
        UNION ALL
        (
         SELECT '999999'     AS WARE_NO
              , '계'         AS WARE_NM         /* 총 합계 */
              , 1            AS SORT_DV_VAL
         FROM DUAL
        )
        </if>
      )
      ORDER BY SORT_DV_VAL ASC , WARE_NO ASC
    </select>

    <select id="selectInAggregateList" resultType="camelMap">
        WITH TEMP_PD_BAS
          AS (
               SELECT T1.PD_CD
                    , T1.PD_ABBR_NM
                    , T2.PD_PRP_VAL17
                    , T1.SAP_MAT_CD
                 FROM TB_PDBS_PD_BAS T1
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL T2
                   ON T1.PD_CD = T2.PD_CD
                  AND T2.PD_EXTS_PRP_GRP_CD = 'PART'
                  AND T2.DTA_DL_YN = 'N'
                  AND T2.PD_PRP_VAL19 = #{itmKndCd}
                WHERE T1.DTA_DL_YN ='N'
        <if test='@MybatisUtils@isNotEmpty(itmGrpCd)'>
                  AND (
                        T2.PD_PRP_VAL20 = #{itmGrpCd}
                        OR EXISTS (
                                    SELECT 1
                                      FROM TB_PDBS_PD_REL RT1
                                     INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL DT2
                                        ON DT2.PD_CD = RT1.BASE_PD_CD
                                     WHERE RT1.DTA_DL_YN = 'N'
                                       AND RT1.PD_REL_TP_CD = '14'   /* AS부품 */
                                       AND DT2.DTA_DL_YN = 'N'
                                       AND DT2.PD_EXTS_PRP_GRP_CD = 'PART'
                                       AND RT1.OJ_PD_CD = T2.PD_CD
                                       AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN RT1.VL_STRT_DTM AND RT1.VL_END_DTM
                                       AND DT2.PD_PRP_VAL20 = #{itmGrpCd}
                                  )
                      )
        </if>
        <if test="@MybatisUtils@isNotEmpty(itmPdCds)">
                  AND T1.PD_CD IN
            <foreach collection="itmPdCds" item="item" separator=", " open="(" close=")">
                      #{item}
            </foreach>
        </if>
        <if test='@MybatisUtils@isNotEmpty(useYn)'>
                  AND T2.PD_PRP_VAL32 = #{useYn}
        </if>
        <if test='@MybatisUtils@isNotEmpty(sapCdFrom) or @MybatisUtils@isNotEmpty(sapCdTo)'>
               AND TO_NUMBER(T1.SAP_MAT_CD) BETWEEN TO_NUMBER(NVL(#{sapCdFrom}, #{sapCdTo})) AND TO_NUMBER(NVL(#{sapCdTo}, #{sapCdFrom}))
        </if>

        <if test='@MybatisUtils@isNotEmpty(pdCdFrom) or @MybatisUtils@isNotEmpty(pdCdTo)'>
               AND T1.PD_CD BETWEEN NVL(#{pdCdFrom}, #{pdCdTo}) AND NVL(#{pdCdTo}, #{pdCdFrom})
        </if>
             )
        SELECT T2.PD_PRP_VAL17	AS MAT_MNGT_DV_CD
             , T1.PD_CD
             , TO_CHAR(TO_NUMBER(T2.SAP_MAT_CD))
             , T2.PD_ABBR_NM
             , ${wareNoFields}
             , ${wareLogisticsFieldsSumStr}  AS WARE_100000
        <if test='@MybatisUtils@equals(wareDvCd, "2")'>
             , ${wareServiceFieldsSumStr}    AS WARE_200000
             , ${wareLogisticsFieldsSumStr} + ${wareServiceFieldsSumStr} AS WARE_999999
        </if>
        <if test='@MybatisUtils@equals(wareDvCd, "3")'>
             , ${wareBusinessFieldsSumStr}    AS WARE_300000
             , ${wareLogisticsFieldsSumStr} + ${wareBusinessFieldsSumStr} AS WARE_999999
        </if>
          FROM (
                 SELECT PD_CD
                      , WARE_NO
                      , SUM(QTY) QTY
                   FROM (
                          SELECT STR1.ITM_PD_CD PD_CD
                               , CASE WHEN W1.WARE_ICHR_NO = '000' THEN W1.WARE_NO
                                      ELSE SUBSTR(W1.WARE_NO, 1, 1)||'99999'
                                 END WARE_NO
                               , STR1.STR_QTY QTY
                               , STR_TP_CD IN_TYP
                            FROM TB_SVST_ITM_STR_IZ STR1
                           INNER JOIN TEMP_PD_BAS P1
                              ON STR1.ITM_PD_CD = P1.PD_CD
                           INNER JOIN TB_SVST_MCBY_WARE_IZ W1
                              ON STR1.STR_WARE_NO = W1.WARE_NO
                             AND SUBSTR(STR1.STR_RGST_DT, 1, 6) = W1.APY_YM
                           WHERE 1=1
                             AND STR1.STR_RGST_DT BETWEEN #{baseDateFrom} AND #{baseDateTo}
                             AND STR1.DTA_DL_YN = 'N'
                             AND STR1.STR_QTY > 0
        <if test='@MybatisUtils@isNotEmpty(pdGdCd)'>
                             AND STR1.ITM_GD_CD = #{pdGdCd}
        </if>
                           UNION ALL
                          SELECT STR1.ITM_PD_CD
                               , CASE WHEN W1.WARE_ICHR_NO = '000' THEN W1.WARE_NO
                                      ELSE SUBSTR(W1.WARE_NO, 1, 1)||'99999'
                                 END WARE_NO
                               , STR1.USE_QTY
                               , '162' IN_TYP
                            FROM TB_SVST_SV_WK_OSTR_IZ STR1
                           INNER JOIN TEMP_PD_BAS P1
                              ON STR1.ITM_PD_CD = P1.PD_CD
                           INNER JOIN TB_SVST_MCBY_WARE_IZ W1
                              ON SUBSTR(STR1.FST_VST_FSH_DT, 1, 6) = W1.APY_YM
                             AND STR1.WK_WARE_NO = W1.WARE_NO
                           WHERE 1=1
                             AND STR1.FST_VST_FSH_DT BETWEEN #{baseDateFrom} AND #{baseDateTo}
                             AND STR1.SV_BIZ_HCLSF_CD = '6'
                             AND STR1.DTA_DL_YN = 'N'
                             AND STR1.USE_QTY > 0
        <if test='@MybatisUtils@isNotEmpty(pdGdCd)'>
                             AND STR1.FNL_ITM_GD_CD = #{pdGdCd}
        </if>
                           UNION ALL
                          SELECT STR1.PD_CD
                               , CASE WHEN W1.WARE_ICHR_NO = '000' THEN W1.WARE_NO
                                      ELSE SUBSTR(W1.WARE_NO, 1, 1)||'99999'
                                 END WARE_NO
                               , STR1.CTR_QTY QTY
                               , '190' IN_TYP
                            FROM TB_SVST_ITM_GD_CTR_IZ STR1
                           INNER JOIN TEMP_PD_BAS P1
                              ON STR1.PD_CD = P1.PD_CD
                           INNER JOIN TB_SVST_MCBY_WARE_IZ W1
                              ON STR1.WARE_NO = W1.WARE_NO
                             AND SUBSTR(STR1.CTR_WK_DT, 1, 6) = W1.APY_YM
                           WHERE 1=1
                             AND STR1.CTR_WK_DT BETWEEN #{baseDateFrom} AND #{baseDateTo}
                             AND STR1.DTA_DL_YN = 'N'
                             AND STR1.CTR_QTY > 0
        <if test='@MybatisUtils@isNotEmpty(pdGdCd)'>
                             AND STR1.AFCT_ITM_GD_CD = #{pdGdCd}
        </if>
                        )
                  WHERE 1=1
        <if test='@MybatisUtils@isNotEmpty(strTpCd)'>
                    AND IN_TYP = #{strTpCd}
        </if>
                  GROUP
                     BY PD_CD, WARE_NO
               )
           PIVOT ( SUM(QTY)
                    FOR WARE_NO IN (${wareNoInStr})
                 ) T1
      LEFT OUTER JOIN TEMP_PD_BAS T2
              ON T1.PD_CD = T2.PD_CD
           ORDER
              BY T1.PD_CD
    </select>
</mapper>
