<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaNormalOutOfStorageMapper">

    <select id="selectNormalOutOfStorage"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$SearchRes">
        SELECT J1.OSTR_AK_NO
             , J1.OSTR_AK_TP_CD
             , J1.OSTR_OJ_WARE_NO
             , J1.OSTR_OJ_WARE_NM
             , J1.STR_HOP_DT
             , J1.OVIV_TP_CD
             , J1.RECT_OSTR_DT
             , J1.ITM_PD_CD
             , J1.OSTR_AK_RGST_DT
             , J1.OSTR_DTRN_YN
             , J2.PD_NM
             , ' ' AS RMK_CN
          FROM (SELECT T1.OSTR_AK_NO
                     , T1.OSTR_AK_TP_CD
                     , T1.OSTR_OJ_WARE_NO
                     , T2.WARE_NM AS OSTR_OJ_WARE_NM
                     , T1.STR_HOP_DT
                     , T1.OVIV_TP_CD
                     , MAX(T1.RECT_OSTR_DT) AS RECT_OSTR_DT
                     , MIN(T1.ITM_PD_CD) AS ITM_PD_CD
                     , T1.OSTR_AK_RGST_DT
                     , (CASE WHEN T1.OSTR_AK_RGST_DT > '20190700'
                             THEN CASE WHEN COUNT(T1.OSTR_CNFM_QTY) - COUNT(T1.OSTR_AGG_QTY) = 0
                                       THEN '출고완료'
                                       WHEN COUNT(T1.OSTR_CNFM_QTY) = COUNT(T1.OSTR_AGG_QTY)
                                       THEN '출고대기'
                                       ELSE '일부출고'
                                        END
                             ELSE CASE WHEN COUNT(*) = COUNT(T1.RECT_OSTR_DT) THEN '출고완료'
                                       ELSE ''
                                        END
                      END) AS OSTR_DTRN_YN
                  FROM TB_SVST_ITM_OSTR_AK_IZ T1
                 INNER JOIN TB_SVST_MCBY_WARE_IZ T2
                    ON T2.APY_YM = SUBSTR(#{strHopDtStr}, 1,6)
                   AND T1.OSTR_OJ_WARE_NO = T2.WARE_NO
                 WHERE T1.STR_HOP_DT BETWEEN #{strHopDtStr} AND #{strHopDtEnd}
                   AND T1.OSTR_OJ_WARE_NO = #{ostrOjWareNo}
                 <if test="@MybatisUtils@isNotEmpty(ostrAkTpCd)">
                   AND T1.OSTR_AK_TP_CD = #{ostrAkTpCd}
                 </if>
                 <if test="@MybatisUtils@isNotEmpty(wareDvCd)">
                   AND T1.OSTR_AK_WARE_DV_CD = #{wareDvCd}
                 </if>
                 <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
                   AND T1.ITM_PD_CD = #{itmKndCd}
                 </if>
                 <if test="@MybatisUtils@isNotEmpty(ostrOjWareNo)">
                   AND T1.OSTR_OJ_WARE_NO = #{ostrOjWareNo}
                 </if>
                 <if test="@MybatisUtils@isNotEmpty(wareLocaraCd)">
                   AND T2.WARE_LOCARA_CD = #{wareLocaraCd}
                 </if>
                 GROUP BY T1.OSTR_AK_TP_CD
                        , T1.OSTR_OJ_WARE_NO
                        , T1.OSTR_AK_RGST_DT
                        , T1.OSTR_AK_NO
                        , T1.STR_HOP_DT
                        , T2.WARE_NM
                        , T1.OVIV_TP_CD
                HAVING (CASE WHEN T1.OSTR_AK_RGST_DT > '20190700'
			                 THEN CASE WHEN COUNT(T1.OSTR_CNFM_QTY) - COUNT(T1.OSTR_AGG_QTY) = 0
			                           THEN '1'
			                           ELSE '0'
			                            END
			            ELSE CASE WHEN COUNT(*) = COUNT(T1.RECT_OSTR_DT)
			                      THEN '1'
			                      ELSE '0'
			                       END
			             END) = CASE WHEN #{ostrCnfm} = 'Y' THEN '1'
                                     ELSE '0'
                                      END
               )J1
         INNER JOIN TB_PDBS_PD_BAS J2
            ON J1.ITM_PD_CD = J2.PD_CD
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL J3
            ON J2.PD_CD = J3.PD_CD AND J3.PD_EXTS_PRP_GRP_CD = 'PART'
         <where>
            <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
               AND T4.PD_PRP_VAL19 = #{itmKndCd}
            </if>
         </where>
    </select>

    <select id="selectWarehouses"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$SearchWarehouse">
        SELECT T1.WARE_NO
             , T1.WARE_NM
          FROM TB_SVST_MCBY_WARE_IZ T1
         WHERE T1.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND T1.WARE_MNGT_PRTNR_NO = '36680'
           <!-- AND T1.WARE_MNGT_PRTNR_NO = #{session.tenantId} -->
           AND T1.WARE_USE_YN = 'Y'
         ORDER BY T1.WARE_NO
    </select>

    <select id="selectAskMaterialsHavePss"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$AskRes">
        SELECT TA.WARE_MNGT_PRTNR_NO
             , TA.WARE_NM
             , TB.ITM_PD_CD
             , TA.WARE_NO
             , NVL((TB.PITM_STOC_A_GD_QTY - MMT_STOC_A_GD_QTY),0) AS QTY
          FROM TB_SVST_MCBY_WARE_IZ TA
         INNER JOIN TB_SVST_CST_SV_ITM_STOC_IZ TB
            ON TB.WARE_NO = TA.WARE_NO
         WHERE 1 = 1
           AND TA.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND TA.WARE_USE_YN = 'Y'
           AND TA.WARE_DV_CD = '2'
           AND TB.ITM_PD_CD = #{itmPdCd}
           AND TA.HGR_WARE_NO = (SELECT HGR_WARE_NO
                                   FROM TB_SVST_MCBY_WARE_IZ
                                  WHERE APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                                    AND WARE_USE_YN = 'Y'
                                    AND WARE_NO = #{strOjWareNo}
                                    AND WARE_DTL_DV_CD != '20')
         ORDER BY WARE_NM
    </select>

    <select id="selectAskMaterialsCenterPresentState" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$CenterRes">
            SELECT WARE_NO
                , NVL((PITM_STOC_A_GD_QTY - MMT_STOC_A_GD_QTY),0) AS QTY
                , (SELECT T2.OG_NM
                     FROM TB_SVST_MCBY_WARE_IZ T1
                    INNER JOIN TB_OGBS_MM_OG_IZ T2
                       ON T1.OG_ID = T2.OG_ID
                      AND T1.APY_YM = T2.BASE_YM
                    WHERE 1 = 1
                      AND T1.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                      AND WARE_DTL_DV_CD = '20') AS OG_NM
             FROM TB_SVST_CST_SV_ITM_STOC_IZ
            WHERE 1 = 1
              AND ITM_PD_CD = #{itmPdCd}
              AND WARE_NO IN ( SELECT WARE_NO
                                 FROM TB_SVST_MCBY_WARE_IZ
                                WHERE 1 = 1
                                  AND APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                                  AND WARE_DTL_DV_CD = '20')
    </select>




</mapper>
