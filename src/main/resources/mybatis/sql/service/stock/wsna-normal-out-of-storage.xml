<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaNormalOutOfStorageMapper">

     <select id="selectWarehouses" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$SearchWarehouse">
        SELECT WARE_NO   /* 창고번호 */
             , WARE_NM   /* 창고명 */
          FROM TB_SVST_MCBY_WARE_IZ   /* 월별창고내역 */
         WHERE DTA_DL_YN          = 'N'
           AND WARE_USE_YN        = 'Y'
           AND APY_YM             = #{apyYm}
           AND WARE_MNGT_PRTNR_NO = #{session.employeeIDNumber}
         ORDER BY WARE_NO
    </select>

    <select id="selectNormalOutOfStorage" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$SearchRes">
        SELECT T1.OSTR_AK_NO                                              /* 출고요청번호 */
             , T1.OSTR_AK_TP_CD                                           /* 출고요청유형코드 */
             , T1.OSTR_OJ_WARE_NO                                         /* 출고창고번호 */
             , T1.OSTR_OJ_WARE_NM                                         /* 출고창고 */
             , T1.STR_OJ_WARE_NO                                          /* 입고창고번호 */
             , T1.STR_OJ_WARE_NM                                          /* 입고창고 */
             , T1.STR_HOP_DT                                              /* 입고희망일자 */
             , T1.OVIV_TP_CD                                              /* 배차유형코드 */
             , T1.RECT_OSTR_DT                                            /* 최근출고일자 */
             , T1.ITM_PD_CD                                               /* 품목상품코드 */
             , T1.OSTR_AK_RGST_DT                                         /* 출고요청등록일자 */
             , ( SELECT MLNG_CNTN
                   FROM T_CMZ_MLNG_D
                  WHERE MLNG_ID   = T1.OSTR_DTRN_TXT
                    AND TENANT_ID = 'TNT_BASE'
                    AND LNG_ID    = #{session.langId} ) AS OSTR_DTRN_YN   /* 출고확정여부 */
             , T2.PD_ABBR_NM || CASE WHEN T1.CNT <![CDATA[>]]> 1 THEN ( SELECT ' ' || MLNG_CNTN || ' ' || TO_CHAR(T1.CNT -1)
                                                                          FROM T_CMZ_MLNG_D
                                                                         WHERE TENANT_ID = 'TNT_BASE'
                                                                           AND MLNG_ID   = 'MSG_TXT_EXCP'
                                                                           AND LNG_ID    = #{session.langId} )
                                     ELSE ''
                                END                     AS PD_NM          /* 품목명 */
             , T1.OSTR_AK_SN                                              /* 출고요청일련번호 */
             , ' '                                      AS RMK_CN         /* 비고 */
          FROM
             (
               SELECT D1.OSTR_AK_NO                             /* 출고요청번호 */
                    , D1.OSTR_AK_TP_CD                          /* 출고요청유형 */
                    , D1.OSTR_OJ_WARE_NO                        /* 출고대상창고번호 */
                    , D1.STR_OJ_WARE_NO                         /* 입고대상창고번호 */
                    , D1.STR_HOP_DT                             /* 입고희망일자 */
                    , D1.OVIV_TP_CD                             /* 배차형태 */
                    , D1.OSTR_AK_RGST_DT
                    , COUNT(1)             AS CNT               /* 건수 */
                    , MIN(D1.OSTR_AK_SN)   AS OSTR_AK_SN        /* 출고요청일련번호 */
                    , MAX(D1.RECT_OSTR_DT) AS RECT_OSTR_DT      /* 최근출고일자 */
                    , MIN(D1.ITM_PD_CD)    AS ITM_PD_CD         /* 품목상품코드 */
                    , CASE COUNT(D1.RECT_OSTR_DT) WHEN COUNT(1) THEN 'MSG_TXT_OSTR_FSH'    /* 출고완료 */
                                                  WHEN 0        THEN 'MSG_TXT_OSTR_STNB'   /* 출고대기 */
                                                  ELSE 'MSG_TXT_PRTN_OSTR'                 /* 일부출고 */
                      END                  AS OSTR_DTRN_TXT     /* 출고확정 텍스트 */
                    , D2.WARE_NM           AS OSTR_OJ_WARE_NM   /* 출고창고명 */
                    , D4.WARE_NM           AS STR_OJ_WARE_NM    /* 입고창고명 */
                 FROM TB_SVST_ITM_OSTR_AK_IZ D1         /* 품목출고요청내역 */
                INNER JOIN TB_SVST_MCBY_WARE_IZ D2      /* 월별창고내역(출고) */
                   ON D2.WARE_NO = D1.OSTR_OJ_WARE_NO
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D3   /* 상품각사속성상세 */
                   ON D3.PD_CD = D1.ITM_PD_CD
                INNER JOIN TB_SVST_MCBY_WARE_IZ D4      /* 월별창고내역(입고) */
                   ON D4.WARE_NO = D1.STR_OJ_WARE_NO
                WHERE D1.DTA_DL_YN          = 'N'
                  AND D2.DTA_DL_YN          = 'N'
                  AND D2.WARE_USE_YN        = 'Y'
                  AND D3.DTA_DL_YN          = 'N'
                  AND D3.PD_EXTS_PRP_GRP_CD = 'PART'
                  AND D4.DTA_DL_YN          = 'N'
                  AND D4.WARE_USE_YN        = 'Y'
                  AND (
                           D1.OSTR_AK_TP_CD IN ('310', '330')
                        OR ( D1.OSTR_AK_TP_CD = '320' AND D4.WARE_DTL_DV_CD IN ('20', '30') )   /* 물량이동의 경우 입고창고가 조직창고인 경우만 해당, 개인창고는 모바일에서 처리 */
                      )
                  AND D1.OSTR_OJ_WARE_NO    = #{ostrOjWareNo}
                  AND D1.STR_HOP_DT BETWEEN #{strHopDtStr} AND #{strHopDtEnd}
                  AND D2.APY_YM             = SUBSTR(#{strHopDtStr}, 1, 6)
                  AND D4.APY_YM             = SUBSTR(#{strHopDtStr}, 1, 6)
                  AND D4.WARE_DV_CD         = #{wareDvCd}
            <if test="@MybatisUtils@isNotEmpty(ostrAkTpCd)">
                  AND D1.OSTR_AK_TP_CD      = #{ostrAkTpCd}
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
                  AND D3.PD_PRP_VAL19       = #{itmKndCd}
            </if>
                GROUP BY D1.OSTR_AK_NO, D1.OSTR_AK_TP_CD, D1.OSTR_OJ_WARE_NO, D1.STR_OJ_WARE_NO, D1.STR_HOP_DT, D1.OVIV_TP_CD, D1.OSTR_AK_RGST_DT, D2.WARE_NM, D4.WARE_NM
            <if test="@MybatisUtils@isNotEmpty(ostrStts)">
               HAVING CASE COUNT(D1.RECT_OSTR_DT) WHEN COUNT(1) THEN 'FSH'    /* 출고완료 */
                                                  WHEN 0        THEN 'STNB'   /* 출고대기 */
                                                  ELSE 'PRTN'                 /* 일부출고 */
                      END IN
                        <foreach collection="ostrStts" item="item" open="(" close=")" separator=",">
                               #{item}
                        </foreach>
            </if>
              ) T1
          INNER JOIN TB_PDBS_PD_BAS T2
             ON T2.PD_CD = T1.ITM_PD_CD
          WHERE T2.DTA_DL_YN = 'N'
            AND T2.PD_TP_CD  = 'M'
          ORDER BY T1.OSTR_AK_TP_CD, T1.OSTR_AK_NO, T1.OSTR_OJ_WARE_NO, T1.STR_HOP_DT
    </select>

    <select id="selectItmOstrAk" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$SearchItmOstrAkRes">
        SELECT D1.OSTR_AK_NO                                                                                       /* 출고요청번호 */
             , D1.STR_OJ_WARE_NO                                                                                   /* 입고대상창고번호 */
             , D1.OSTR_OJ_WARE_NO                                                                                  /* 출고대상창고번호 */
             , D1.OSTR_AK_TP_CD                                                                                    /* 출고요청유형코드 */
             , D1.STR_HOP_DT                                                                                       /* 입고희망일자 */
             , D1.OSTR_AK_RGST_DT                                                                                  /* 출고요청등록일자 */
             , D1.ITM_PD_CD                                                                                        /* 품목상품코드 */
             , F_CMZ_CD_NM('TNT_WELLS', 'OSTR_AK_TP_CD', D1.OSTR_AK_TP_CD, #{session.langId}) AS OSTR_AK_TP_NM     /* 출고요청유형명 */
             , D2.WARE_NM                                                                     AS OSTR_OJ_WARE_NM   /* 출고대상창고명 */
             , D3.WARE_NM                                                                     AS STR_OJ_WARE_NM    /* 입고대상창고명 */
             , NVL(D4.ITM_OSTR_NO, D5.ITM_OSTR_NO)                                            AS ITM_OSTR_NO       /* 품목출고번호 */
             , NVL(D4.OSTR_TP_CD, D5.OSTR_TP_CD)                                              AS OSTR_TP_CD        /* 출고유형코드 */
             , NVL(D4.OSTR_DT, D5.OSTR_DT)                                                    AS OSTR_DT           /* 출고일자 */
             , NVL(D2.STD_WARE_USE_YN, 'N')                                                   AS STCK_STD_GB       /* 표준창고사용여부 */
             , D2.APY_YM                                                                      AS BASE_YM           /* 기준년월 */
          FROM TB_SVST_ITM_OSTR_AK_IZ D1
         INNER JOIN TB_SVST_MCBY_WARE_IZ D2
            ON D2.APY_YM  = NVL(SUBSTR(D1.STR_HOP_DT, 1, 6), TO_CHAR(SYSDATE, 'YYYYMM'))
           AND D2.WARE_NO = D1.OSTR_OJ_WARE_NO
         INNER JOIN TB_SVST_MCBY_WARE_IZ D3
            ON D3.APY_YM  = NVL(SUBSTR(D1.STR_HOP_DT, 1, 6), TO_CHAR(SYSDATE, 'YYYYMM'))
           AND D3.WARE_NO = D1.STR_OJ_WARE_NO
          LEFT OUTER JOIN TB_SVST_ITM_OSTR_IZ D4
            ON D4.OSTR_AK_NO   = D1.OSTR_AK_NO
           AND D4.OSTR_AK_SN   = D1.OSTR_AK_SN
           AND D4.DTA_DL_YN    = 'N'
          LEFT OUTER JOIN TB_SVST_ITM_OSTR_IZ D5
            ON D5.DTA_DL_YN   = 'N'
           AND D5.ITM_OSTR_NO = #{itmOstrNo}
           AND ROWNUM         = 1
         WHERE D1.DTA_DL_YN  = 'N'
           AND D2.DTA_DL_YN  = 'N'
           AND D3.DTA_DL_YN  = 'N'
           AND D1.OSTR_AK_NO = #{ostrAkNo}
           AND D1.OSTR_AK_SN = #{ostrAkSn}
           AND ROWNUM        = 1
    </select>

    <select id="selectStandardWareHouse" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$StandardWareRes">
        SELECT NVL(STD_WARE_USE_YN, 'N') AS STCK_STD_GB   /* 표준창고사용여부 */
             , WARE_NO                                    /* 창고번호 */
             , APY_YM                                     /* 적용년월 */
          FROM TB_SVST_MCBY_WARE_IZ   /* 월별창고내역 */
         WHERE DTA_DL_YN = 'N'
           AND APY_YM    = #{apyYm}
           AND WARE_NO   = #{wareNo}
    </select>

     <update id="updateStandardWareHouse">
        UPDATE TB_SVST_MCBY_WARE_IZ   /* 월별창고내역 */
           SET STD_WARE_USE_YN = #{stckStdGb}   /* 표준창고사용여부 */
         <include refid="COMMON.updateSystemField"/>
         WHERE APY_YM  = #{apyYm}
           AND WARE_NO = #{wareNo}
    </update>

    <select id="selectNormalOstrRgsts" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaNormalOutOfStorageDetailDvo">
        SELECT CASE WHEN D1.RECT_OSTR_DT IS NULL THEN 'Y'
                    ELSE 'N'
               END                                                                            AS CHK                   /* Row 체크여부 */
             , D1.OSTR_AK_TP_CD                                                                                        /* 출고요청유형코드 */
             , CASE D1.OSTR_AK_TP_CD WHEN '310' THEN '221'   /* 정상출고 */
                                     WHEN '320' THEN '223'   /* 물량이동 */
                                     WHEN '330' THEN '221'   /* 정상출고 */
               END                                                                            AS OSTR_TP_CD            /* 출고유형코드 */
             , CASE D1.OSTR_AK_TP_CD WHEN '310' THEN '121'   /* 정상입고 */
                                     WHEN '320' THEN '123'   /* 물량이동 */
                                     WHEN '330' THEN '121'   /* 정상입고 */
               END                                                                            AS STR_TP_CD             /* 입고유형코드 */
             , D1.OSTR_OJ_WARE_NO                                                                                      /* 출고대상창고번호 */
             , D1.STR_OJ_WARE_NO                                                                                       /* 입고창고번호 */
             , D1.OSTR_AK_RGST_DT                                                                                      /* 출고요청등록일자 */
             , D1.OSTR_AK_NO                                                                                           /* 출고요청번호 */
             , D1.OSTR_AK_SN                                                                                           /* 출고요청일련번호 */
             , D1.STR_HOP_DT                                                                                           /* 입고희망일자 */
             , F_CMZ_CD_NM('TNT_WELLS', 'MAT_MNGT_DV_CD', D5.PD_PRP_VAL02, #{session.langId}) AS SVPD_MGT_TYP          /* 재고유형 */
             , TO_CHAR(TO_NUMBER(D4.SAP_MAT_CD))                                              AS SVPD_SAP_CD           /* SAP코드 */
             , D1.ITM_PD_CD                                                                                            /* 품목상품코드 */
             , D4.PD_ABBR_NM                                                                  AS SVPD_NM_KOR           /* 품목명 */
             , D5.PD_PRP_VAL19                                                                AS SVPD_ITEM_KND         /* 품목종류코드 */
             , ( SELECT CASE WHEN #{ostrOjWareNo} = '100002'   /* 교원파주물류센터 */
                             THEN F_CMZ_CD_NM('TNT_WELLS', 'WARE_TP_CD', WARE_TP_CD, #{session.langId})
                                  || CASE WHEN WARE_TP_CD IS NOT NULL THEN '-' ELSE '' END
                                  || CASE WHEN ITM_LCT_ANGLE_VAL IS NULL THEN ' '
                                          ELSE F_CMZ_CD_NM('TNT_WELLS', 'LCT_ANGLE_CD', ITM_LCT_ANGLE_VAL, #{session.langId})
                                     END || '-'
                                  || CASE WHEN ITM_LCT_FLOR_NO_VAL IS NULL THEN ' '
                                          ELSE F_CMZ_CD_NM('TNT_WELLS', 'LCT_FLOR_NO_CD', ITM_LCT_FLOR_NO_VAL, #{session.langId})
                                     END || '-'
                                  || CASE WHEN ITM_LCT_COF_VAL IS NULL THEN ' '
                                          ELSE F_CMZ_CD_NM('TNT_WELLS', 'LCT_COF_CD', ITM_LCT_COF_VAL, #{session.langId})
                                     END
                                  || CASE WHEN ITM_LCT_MAT_GRP_CD IS NOT NULL THEN '-' ELSE '' END
                                  || F_CMZ_CD_NM('TNT_WELLS', 'LCT_MAT_GRP_CD', ITM_LCT_MAT_GRP_CD, #{session.langId})
                             ELSE F_CMZ_CD_NM('TNT_WELLS', 'WARE_TP_CD', WARE_TP_CD, #{session.langId})
                                  || CASE WHEN WARE_TP_CD IS NOT NULL THEN '-' ELSE '' END
                                  || CASE WHEN ITM_LCT_ANGLE_VAL IS NULL THEN ' '
                                          ELSE F_CMZ_CD_NM('TNT_WELLS', 'LCT_ANGLE_CD', ITM_LCT_ANGLE_VAL, #{session.langId})
                                     END || '-'
                                  || CASE WHEN ITM_LCT_COF_VAL IS NULL THEN ' '
                                          ELSE F_CMZ_CD_NM('TNT_WELLS', 'LCT_COF_CD', ITM_LCT_COF_VAL, #{session.langId})
                                     END || '-'
                                  || CASE WHEN ITM_LCT_FLOR_NO_VAL IS NULL THEN ' '
                                          ELSE F_CMZ_CD_NM('TNT_WELLS', 'LCT_FLOR_NO_CD', ITM_LCT_FLOR_NO_VAL, #{session.langId})
                                     END
                                  || CASE WHEN ITM_LCT_MAT_GRP_CD IS NOT NULL THEN '-' ELSE '' END
                                  || F_CMZ_CD_NM('TNT_WELLS', 'LCT_MAT_GRP_CD', ITM_LCT_MAT_GRP_CD, #{session.langId})
                        END
                   FROM TB_SVST_CST_SV_ITM_LCT_IZ   /* 고객서비스품목위치내역 */
                  WHERE ITM_PD_CD = D1.ITM_PD_CD
                    AND DTA_DL_YN = 'N'
                    AND WARE_NO   = CASE WHEN D2.WARE_DV_CD = '2'
                                          AND D2.STD_WARE_USE_YN = 'Y' THEN '200012'   /* 표준적용 */
                                         ELSE #{ostrOjWareNo}
                                    END )                                                     AS ITEM_LOC              /* 품목위치 */
             , D1.ITM_GD_CD                                                                                            /* 상품등급코드 */
             , CASE WHEN D2.WARE_DV_CD <![CDATA[<>]]> '1'   /* 물류센터가아닌경우, 물류센터는 EAI API로 조회 */
                    THEN CASE D1.ITM_GD_CD WHEN 'A' THEN NVL(D7.PITM_STOC_A_GD_QTY, 0) - NVL(D7.MMT_STOC_A_GD_QTY, 0)
                                           WHEN 'B' THEN NVL(D7.PITM_STOC_B_GD_QTY, 0) - NVL(D7.MMT_STOC_B_GD_QTY, 0)
                                           WHEN 'E' THEN NVL(D7.PITM_STOC_E_GD_QTY, 0) - NVL(D7.MMT_STOC_E_GD_QTY, 0)
                                           WHEN 'R' THEN NVL(D7.PITM_STOC_R_GD_QTY, 0) - NVL(D7.MMT_STOC_R_GD_QTY, 0)
                         END
                    ELSE 0
               END                                                                            AS QTY                   /* 출고창고재고 */
             , CASE D1.ITM_GD_CD WHEN 'A' THEN NVL(D6.PITM_STOC_A_GD_QTY, 0) - NVL(D6.MMT_STOC_A_GD_QTY, 0)
                                 WHEN 'B' THEN NVL(D6.PITM_STOC_B_GD_QTY, 0) - NVL(D6.MMT_STOC_B_GD_QTY, 0)
                                 WHEN 'E' THEN NVL(D6.PITM_STOC_E_GD_QTY, 0) - NVL(D6.MMT_STOC_E_GD_QTY, 0)
                                 WHEN 'R' THEN NVL(D6.PITM_STOC_R_GD_QTY, 0) - NVL(D6.MMT_STOC_R_GD_QTY, 0)
               END                                                                            AS REQ_STCK_QTY          /* 입고창고재고 */
             , D1.OSTR_AK_QTY                                                                                          /* 신청수량 */
             , NVL(D1.OSTR_CNFM_QTY, 0)                                                       AS OSTR_CNFM_QTY         /* 출고확정수량 */
             , D1.RMK_CN                                                                                               /* 비고 */
             , D1.OSTR_CNFM_CD                                                                                         /* 출고확정코드 */
             , D1.RECT_OSTR_DT                                                                                         /* 최근출고일자 */
             , NVL(D1.OSTR_AGG_QTY, 0)                                                        AS OSTR_AGG_QTY          /* 출고누계수량 */
             , NVL(D1.OSTR_CNFM_QTY, 0) - NVL(D1.OSTR_AGG_QTY, 0)                             AS OUT_QTY               /* 출고수량 */
             , NVL(D1.OSTR_CNFM_QTY, 0) - NVL(D1.OSTR_AGG_QTY, 0)                             AS OUT_QTY_ORG           /* 출고수량 Origin */
             , ''                                                                             AS STR_CONF_DT           /* 입고확정일자 */
             , D3.WARE_DV_CD                                                                  AS STR_WARE_DV_CD        /* 입고창고구분코드 */
             , D3.WARE_DTL_DV_CD                                                              AS STR_WARE_DTL_DV_CD    /* 입고창고상세구분코드 */
             , D3.WARE_NM                                                                     AS STR_WARE_NM           /* 입고창고 */
             , D3.WARE_MNGT_PRTNR_NO                                                          AS STR_PRTNR_NO          /* 입고창고파트너번호 */
             , D3.OG_TP_CD                                                                    AS STR_OG_TP_CD          /* 입고창고조직유형코드 */
             , D2.WARE_DV_CD                                                                  AS OSTR_WARE_DV_CD       /* 출고창고구분코드 */
             , D2.WARE_DTL_DV_CD                                                              AS OSTR_WARE_DTL_DV_CD   /* 출고창고상세구분코드 */
             , D2.WARE_NM                                                                     AS OSTR_WARE_NM          /* 출고창고 */
             , D2.WARE_MNGT_PRTNR_NO                                                          AS OSTR_PRTNR_NO         /* 출고창고파트너번호 */
             , D2.OG_TP_CD                                                                    AS OSTR_OG_TP_CD         /* 출고창고조직유형코드 */
             , D1.BOX_UNIT_QTY                                                                                         /* 박스단위수량 */
             , D1.MNGT_UNIT_CD                                                                                         /* 관리단위코드 */
             , F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', D1.MNGT_UNIT_CD, #{session.langId})   AS MNGT_UNIT_NM          /* 관리단위 */
             , ( SELECT OSTR_TMS
                   FROM TB_SVST_CST_SV_ITM_LCT_IZ   /* 고객서비스품목위치내역 */
                  WHERE ITM_PD_CD = D1.ITM_PD_CD
                    AND DTA_DL_YN = 'N'
                    AND WARE_NO   = #{ostrOjWareNo} )                                         AS OSTR_TMS              /* 출고빈도 */
             , ( SELECT /*+ INDEX(S1 IX_SVST_SV_WK_OSTR_IZ_01) */
                        ROUND(SUM(S1.USE_QTY) / 3, 1)
                   FROM TB_SVST_SV_WK_OSTR_IZ S1
                  INNER JOIN TB_SVST_MCBY_WARE_IZ S2
                     ON S2.WARE_NO = S1.WK_WARE_NO
                  WHERE S1.ITM_PD_CD     = D1.ITM_PD_CD
                    AND S1.FNL_ITM_GD_CD = D1.ITM_GD_CD
                    AND S1.DTA_DL_YN     = 'N'
                    AND S1.FNL_VST_FSH_DT BETWEEN TO_CHAR( ADD_MONTHS( TO_DATE( NVL(D1.RECT_OSTR_DT, TO_CHAR(SYSDATE, 'YYYYMMDD')), 'YYYYMMDD' ), -3), 'YYYYMM') || '01'
                                              AND TO_CHAR( LAST_DAY( ADD_MONTHS( TO_DATE( SUBSTR(NVL(D1.RECT_OSTR_DT, TO_CHAR(SYSDATE, 'YYYYMMDD')), 1, 6) || '01', 'YYYYMMDD' ), -1 ) ), 'YYYYMMDD' )
                    AND S2.DTA_DL_YN     = 'N'
                    AND S2.APY_YM        = TO_CHAR(SYSDATE, 'YYYYMM')
                    AND S2.HGR_WARE_NO   = #{strOjWareNo} )                                   AS AVG_OUT               /* 센터평균출고량 */
          FROM TB_SVST_ITM_OSTR_AK_IZ D1                  /* 품목출고요청내역 */
         INNER JOIN TB_SVST_MCBY_WARE_IZ D2               /* 월별창고내역(출고) */
            ON D2.APY_YM  = NVL(SUBSTR(D1.STR_HOP_DT, 1, 6), TO_CHAR(SYSDATE, 'YYYYMM'))
           AND D2.WARE_NO = D1.OSTR_OJ_WARE_NO
         INNER JOIN TB_SVST_MCBY_WARE_IZ D3               /* 월별창고내역(입고) */
            ON D3.APY_YM  = NVL(SUBSTR(D1.STR_HOP_DT, 1, 6), TO_CHAR(SYSDATE, 'YYYYMM'))
           AND D3.WARE_NO = D1.STR_OJ_WARE_NO
         INNER JOIN TB_PDBS_PD_BAS D4                     /* 상품기본 */
            ON D4.PD_CD = D1.ITM_PD_CD
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D5            /* 상품각사속성상세 */
            ON D5.PD_CD = D4.PD_CD
          LEFT OUTER JOIN TB_SVST_CST_SV_ITM_STOC_IZ D6   /* 고객서비스품목재고내역(입고) */
            ON D6.WARE_NO   = D1.STR_OJ_WARE_NO
           AND D6.ITM_PD_CD = D1.ITM_PD_CD
           AND D6.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SVST_CST_SV_ITM_STOC_IZ D7   /* 고객서비스품목재고내역(출고) */
            ON D7.WARE_NO   = D1.OSTR_OJ_WARE_NO
           AND D7.ITM_PD_CD = D1.ITM_PD_CD
           AND D7.DTA_DL_YN = 'N'
         WHERE D1.DTA_DL_YN          = 'N'
           AND D2.DTA_DL_YN          = 'N'
           AND D2.WARE_USE_YN        = 'Y'
           AND D3.DTA_DL_YN          = 'N'
           AND D3.WARE_USE_YN        = 'Y'
           AND D4.DTA_DL_YN          = 'N'
           AND D4.PD_TP_CD           = 'M'
           AND D5.DTA_DL_YN          = 'N'
           AND D5.PD_EXTS_PRP_GRP_CD = 'PART'
           AND D1.OSTR_AK_NO         = #{ostrAkNo}
           AND D1.OSTR_AK_TP_CD      = #{ostrAkTpCd}
           AND D1.STR_OJ_WARE_NO     = #{strOjWareNo}
         ORDER BY D1.OSTR_AK_SN
    </select>

    <select id="selectNormalOstrRgstsForRemove" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaNormalOutOfStorageDetailDvo">
        SELECT CASE WHEN D1.STR_CONF_DT IS NULL THEN 'Y'
                    ELSE 'N'
               END                                                                            AS CHK                 /* Row체크여부 */
             , D1.ITM_OSTR_NO                                                                                        /* 품목출고번호 */
             , D1.OSTR_SN                                                                                            /* 출고일련번호 */
             , D4.OSTR_AK_TP_CD                                                                                      /* 출고요청유형코드 */
             , D1.OSTR_TP_CD                                                                                         /* 출고유형코드 */
             , D1.STR_TP_CD                                                                                          /* 입고유형코드 */
             , D1.OSTR_WARE_NO                                                                AS OSTR_OJ_WARE_NO     /* 출고대상창고번호 */
             , D1.STR_WARE_NO                                                                 AS STR_OJ_WARE_NO      /* 입고창고번호 */
             , D4.OSTR_AK_RGST_DT                                                                                    /* 출고요청등록일자 */
             , D4.OSTR_AK_NO                                                                                         /* 출고요청번호 */
             , D4.OSTR_AK_SN                                                                                         /* 출고요청일련번호 */
             , D1.STR_HOP_DT                                                                                         /* 입고희망일자 */
             , F_CMZ_CD_NM('TNT_WELLS', 'MAT_MNGT_DV_CD', D3.PD_PRP_VAL02, #{session.langId}) AS SVPD_MGT_TYP        /* 재고유형 */
             , TO_CHAR(TO_NUMBER(D2.SAP_MAT_CD))                                              AS SVPD_SAP_CD         /* SAP코드 */
             , D1.ITM_PD_CD                                                                                          /* 품목상품코드 */
             , D2.PD_ABBR_NM                                                                  AS SVPD_NM_KOR         /* 품목명 */
             , D3.PD_PRP_VAL19                                                                AS SVPD_ITEM_KND       /* 품목종류코드 */
             , ( SELECT F_CMZ_CD_NM('TNT_WELLS', 'WARE_TP_CD', WARE_TP_CD, #{session.langId})
                        || CASE WHEN WARE_TP_CD IS NOT NULL THEN '-' ELSE '' END
                        || CASE WHEN ITM_LCT_ANGLE_VAL IS NULL THEN ' '
                                ELSE F_CMZ_CD_NM('TNT_WELLS', 'LCT_ANGLE_CD', ITM_LCT_ANGLE_VAL, #{session.langId})
                           END || '-'
                        || CASE WHEN ITM_LCT_COF_VAL IS NULL THEN ' '
                                ELSE F_CMZ_CD_NM('TNT_WELLS', 'LCT_COF_CD', ITM_LCT_COF_VAL, #{session.langId})
                           END || '-'
                        || CASE WHEN ITM_LCT_FLOR_NO_VAL IS NULL THEN ' '
                                ELSE F_CMZ_CD_NM('TNT_WELLS', 'LCT_FLOR_NO_CD', ITM_LCT_FLOR_NO_VAL, #{session.langId})
                           END
                        || CASE WHEN ITM_LCT_MAT_GRP_CD IS NOT NULL THEN '-' ELSE '' END
                        || F_CMZ_CD_NM('TNT_WELLS', 'LCT_MAT_GRP_CD', ITM_LCT_MAT_GRP_CD, #{session.langId})
                   FROM TB_SVST_CST_SV_ITM_LCT_IZ   /* 고객서비스품목위치내역 */
                  WHERE ITM_PD_CD = D1.ITM_PD_CD
                    AND DTA_DL_YN = 'N'
                    AND WARE_NO   = CASE WHEN D8.WARE_DV_CD = '2'
                                          AND D8.STD_WARE_USE_YN = 'Y' THEN '200012'   /* 표준적용 */
                                         ELSE #{ostrOjWareNo}
                                    END )                                                     AS ITEM_LOC            /* 품목위치 */
             , D1.ITM_GD_CD                                                                                          /* 상품등급코드 */
             , CASE WHEN D1.OSTR_WARE_DV_CD <![CDATA[<>]]> '1'   /* 물류센터가아닌경우, 물류센터는 EAI API로 조회 */
                    THEN CASE D1.ITM_GD_CD WHEN 'A' THEN NVL(D6.PITM_STOC_A_GD_QTY, 0) - NVL(D6.MMT_STOC_A_GD_QTY, 0)
                                           WHEN 'B' THEN NVL(D6.PITM_STOC_B_GD_QTY, 0) - NVL(D6.MMT_STOC_B_GD_QTY, 0)
                                           WHEN 'E' THEN NVL(D6.PITM_STOC_E_GD_QTY, 0) - NVL(D6.MMT_STOC_E_GD_QTY, 0)
                                           WHEN 'R' THEN NVL(D6.PITM_STOC_R_GD_QTY, 0) - NVL(D6.MMT_STOC_R_GD_QTY, 0)
                         END
                    ELSE 0
               END                                                                            AS QTY                 /* 출고창고재고 */
             , CASE D1.ITM_GD_CD WHEN 'A' THEN NVL(D5.PITM_STOC_A_GD_QTY, 0) - NVL(D5.MMT_STOC_A_GD_QTY, 0)
                                 WHEN 'B' THEN NVL(D5.PITM_STOC_B_GD_QTY, 0) - NVL(D5.MMT_STOC_B_GD_QTY, 0)
                                 WHEN 'E' THEN NVL(D5.PITM_STOC_E_GD_QTY, 0) - NVL(D5.MMT_STOC_E_GD_QTY, 0)
                                 WHEN 'R' THEN NVL(D5.PITM_STOC_R_GD_QTY, 0) - NVL(D5.MMT_STOC_R_GD_QTY, 0)
               END                                                                            AS REQ_STCK_QTY        /* 입고창고재고 */
             , D1.BOX_UNIT_QTY                                                                                       /* 박스단위수량 */
             , D1.MNGT_UNIT_CD                                                                                       /* 관리단위코드 */
             , F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', D1.MNGT_UNIT_CD, #{session.langId})   AS MNGT_UNIT_NM        /* 관리단위 */
             , D4.OSTR_AK_QTY                                                                                        /* 출고요청수량 */
             , D1.OSTR_QTY                                                                    AS OSTR_CNFM_QTY       /* 출고확정수량 */
             , D1.OSTR_QTY                                                                    AS OSTR_CNFM_QTY_ORG   /* 출고확정수량 Origin */
             , D1.RMK_CN                                                                                             /* 비고 */
             , D4.OSTR_CNFM_CD                                                                                       /* 출고확정코드 */
             , D1.OSTR_DT                                                                     AS RECT_OSTR_DT        /* 출고일자 */
             , D1.OSTR_QTY                                                                    AS OSTR_AGG_QTY        /* 출고누계수량 */
             , D1.OSTR_QTY                                                                    AS OUT_QTY             /* 출고수량 */
             , D1.STR_CONF_DT                                                                                        /* 입고확인일자 */
             , D7.WARE_DV_CD                                                                  AS STR_WARE_DV_CD      /* 입고창고구분코드 */
             , D7.WARE_NM                                                                     AS STR_WARE_NM         /* 입고창고 */
             , D7.WARE_MNGT_PRTNR_NO                                                          AS STR_PRTNR_NO        /* 입고창고파트너번호 */
             , D7.OG_TP_CD                                                                    AS STR_OG_TP_CD        /* 입고창고조직유형코드 */
             , D8.WARE_DV_CD                                                                  AS OSTR_WARE_DV_CD     /* 출고창고구분코드 */
             , D8.WARE_NM                                                                     AS OSTR_WARE_NM        /* 출고창고 */
             , D8.WARE_MNGT_PRTNR_NO                                                          AS OSTR_PRTNR_NO       /* 출고창고파트너번호 */
             , D8.OG_TP_CD                                                                    AS OSTR_OG_TP_CD       /* 출고창고조직유형코드 */
             , D1.ITM_STR_NO                                                                                         /* 품목입고번호 */
             , D1.STR_SN                                                                                             /* 입고일련번호 */
             , ( SELECT OSTR_TMS
                   FROM TB_SVST_CST_SV_ITM_LCT_IZ   /* 고객서비스품목위치내역 */
                  WHERE ITM_PD_CD = D1.ITM_PD_CD
                    AND DTA_DL_YN = 'N'
                    AND WARE_NO   = #{ostrOjWareNo} )                                         AS OSTR_TMS            /* 출고빈도 */
             , ( SELECT /*+ INDEX(S1 IX_SVST_SV_WK_OSTR_IZ_01) */
                        ROUND(SUM(S1.USE_QTY) / 3, 1)
                   FROM TB_SVST_SV_WK_OSTR_IZ S1
                  INNER JOIN TB_SVST_MCBY_WARE_IZ S2
                     ON S2.WARE_NO = S1.WK_WARE_NO
                  WHERE S1.ITM_PD_CD     = D1.ITM_PD_CD
                    AND S1.FNL_ITM_GD_CD = D1.ITM_GD_CD
                    AND S1.DTA_DL_YN     = 'N'
                    AND S1.FNL_VST_FSH_DT BETWEEN TO_CHAR( ADD_MONTHS( TO_DATE( NVL(D1.STR_CONF_DT, TO_CHAR(SYSDATE, 'YYYYMMDD')), 'YYYYMMDD' ), -3), 'YYYYMM') || '01'
                                              AND TO_CHAR( LAST_DAY( ADD_MONTHS( TO_DATE( SUBSTR(NVL(D1.STR_CONF_DT, TO_CHAR(SYSDATE, 'YYYYMMDD')), 1, 6) || '01', 'YYYYMMDD' ), -1 ) ), 'YYYYMMDD' )
                    AND S2.DTA_DL_YN     = 'N'
                    AND S2.APY_YM        = TO_CHAR(SYSDATE, 'YYYYMM')
                    AND S2.HGR_WARE_NO   = #{strOjWareNo} )                                   AS AVG_OUT               /* 센터평균출고량 */
          FROM TB_SVST_ITM_OSTR_IZ D1                     /* 품목출고내역 */
         INNER JOIN TB_PDBS_PD_BAS D2                     /* 상품기본 */
            ON D2.PD_CD = D1.ITM_PD_CD
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D3            /* 상품각사속성상세 */
            ON D3.PD_CD = D2.PD_CD
          LEFT OUTER JOIN TB_SVST_ITM_OSTR_AK_IZ D4       /* 품목출고요청내역 */
            ON D4.OSTR_AK_NO = D1.OSTR_AK_NO
           AND D4.OSTR_AK_SN = D1.OSTR_AK_SN
           AND D4.DTA_DL_YN  = 'N'
          LEFT OUTER JOIN TB_SVST_CST_SV_ITM_STOC_IZ D5   /* 고객서비스품목재고내역(입고) */
            ON D5.WARE_NO   = D4.STR_OJ_WARE_NO
           AND D5.ITM_PD_CD = D4.ITM_PD_CD
           AND D5.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SVST_CST_SV_ITM_STOC_IZ D6   /* 고객서비스품목재고내역(출고) */
            ON D6.WARE_NO   = D1.OSTR_WARE_NO
           AND D6.ITM_PD_CD = D1.ITM_PD_CD
           AND D6.DTA_DL_YN = 'N'
         INNER JOIN TB_SVST_MCBY_WARE_IZ D7               /* 월별창고내역(입고) */
            ON D7.APY_YM  = SUBSTR(D1.OSTR_DT, 1, 6)
           AND D7.WARE_NO = D1.STR_WARE_NO
         INNER JOIN TB_SVST_MCBY_WARE_IZ D8               /* 월별창고내역(출고) */
            ON D8.APY_YM  = SUBSTR(D1.OSTR_DT, 1, 6)
           AND D8.WARE_NO = D1.OSTR_WARE_NO
         WHERE D1.DTA_DL_YN          = 'N'
           AND D2.DTA_DL_YN          = 'N'
           AND D2.PD_TP_CD           = 'M'
           AND D3.DTA_DL_YN          = 'N'
           AND D3.PD_EXTS_PRP_GRP_CD = 'PART'
           AND D7.DTA_DL_YN          = 'N'
           AND D8.DTA_DL_YN          = 'N'
           AND D1.OSTR_TP_CD         = #{ostrTpCd}
           AND D1.ITM_OSTR_NO        = #{itmOstrNo}
           AND D1.OSTR_WARE_NO       = #{ostrOjWareNo}
         ORDER BY D1.OSTR_SN
    </select>

    <select id="selectAskMaterialsHavePss" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$AskRes">
        SELECT D1.WARE_MNGT_PRTNR_NO                                              /* 관리창고파트너번호 */
             , D1.WARE_NM                                                         /* 창고명 */
             , D2.ITM_PD_CD                                                       /* 품목상품코드 */
             , D1.WARE_NO                                                         /* 창고번호 */
             , NVL(D2.PITM_STOC_A_GD_QTY, 0) - NVL(MMT_STOC_A_GD_QTY, 0) AS QTY   /* 수량 */
          FROM TB_SVST_MCBY_WARE_IZ D1              /* 월별창고내역 */
         INNER JOIN TB_SVST_CST_SV_ITM_STOC_IZ D2   /* 고객서비스품목재고내역 */
            ON D2.WARE_NO = D1.WARE_NO
         WHERE D1.DTA_DL_YN   = 'N'
           AND D1.WARE_USE_YN = 'Y'
           AND D1.APY_YM      = TO_CHAR(SYSDATE, 'YYYYMM')
           AND D2.DTA_DL_YN   = 'N'
           AND D1.WARE_DV_CD  = #{wareDvCd}
           AND D2.ITM_PD_CD   = #{itmPdCd}
           AND D1.HGR_WARE_NO = ( SELECT HGR_WARE_NO
                                    FROM TB_SVST_MCBY_WARE_IZ   /* 월별창고내역 */
                                   WHERE DTA_DL_YN   = 'N'
                                     AND WARE_USE_YN = 'Y'
                                     AND APY_YM      = TO_CHAR(SYSDATE, 'YYYYMM')
                                     AND WARE_NO     = #{strOjWareNo}
                                <if test="@MybatisUtils@equals(wareDvCd, '2')">
                                     AND WARE_DTL_DV_CD <![CDATA[<>]]> '20'
                                </if>
                                <if test="@MybatisUtils@equals(wareDvCd, '3')">
                                     AND WARE_DTL_DV_CD <![CDATA[<>]]> '30'
                                </if> )
         ORDER BY D1.WARE_NM
    </select>

    <select id="selectAskMaterialsCenterPresentState" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$CenterRes">
        SELECT D1.WARE_NO                                                            /* 창고번호 */
             , NVL(D1.PITM_STOC_A_GD_QTY, 0) - NVL(D1.MMT_STOC_A_GD_QTY, 0) AS QTY   /* 수량 */
             , D2.WARE_NM                                                            /* 창고명 */
          FROM TB_SVST_CST_SV_ITM_STOC_IZ D1   /* 고객서비스품목재고내역 */
         INNER JOIN TB_SVST_MCBY_WARE_IZ D2    /* 월별창고내역 */
            ON D2.WARE_NO = D1.WARE_NO
         WHERE D1.DTA_DL_YN      = 'N'
           AND D2.DTA_DL_YN      = 'N'
           AND D2.APY_YM         = TO_CHAR(SYSDATE, 'YYYYMM')
           AND D1.ITM_PD_CD      = #{itmPdCd}
      <if test="@MybatisUtils@equals(wareDvCd, '2')">
           AND D2.WARE_DTL_DV_CD = '20'
      </if>
      <if test="@MybatisUtils@equals(wareDvCd, '3')">
           AND D2.WARE_DTL_DV_CD = '30'
      </if>
         ORDER BY D2.WARE_NM
    </select>

    <select id="selectWareCloseYn" resultType="java.lang.String">
        SELECT WARE_CL_YN   /* 창고마감여부 */
          FROM TB_SVST_MCBY_WARE_CL_IZ   /* 월별창고마감내역 */
         WHERE DTA_DL_YN = 'N'
           AND APY_YM    = SUBSTR(#{ostrDt}, 1, 6)
           AND WARE_NO   = #{ostrOjWareNo}
    </select>

    <update id="updateItmOstrIzForRemove">
        UPDATE TB_SVST_ITM_OSTR_IZ   /* 품목출고내역 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN   = 'N'
           AND ITM_OSTR_NO = #{itmOstrNo}
           AND OSTR_SN     = #{ostrSn}
    </update>

    <update id="updateItmStrIzForRemove">
        UPDATE TB_SVST_ITM_STR_IZ   /* 품목입고내역 */
           SET DTA_DL_YN = 'Y'
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN  = 'N'
           AND ITM_STR_NO = #{itmStrNo}
           AND STR_SN     = #{strSn}
    </update>

    <update id="updateItmOstrAkIzForRemove">
        UPDATE TB_SVST_ITM_OSTR_AK_IZ   /* 품목출고요청내역 */
           SET RECT_OSTR_DT = NULL
             , OSTR_AGG_QTY = NVL(OSTR_AGG_QTY, 0) - #{outQty}
        <include refid="COMMON.updateSystemField"/>
         WHERE OSTR_AK_NO = #{ostrAkNo}
           AND OSTR_AK_SN = #{ostrAkSn}
    </update>

   <select id="selectNewItmOstrNo" resultType="java.lang.String">
        SELECT #{ostrTpCd} || TO_CHAR(SYSDATE, 'YYYYMMDD') || LPAD(SQ_SVST_ITM_OSTR_IZ$ITM_OSTR_NO.NEXTVAL, 7, '0') AS ITM_OSTR_NO
          FROM DUAL
    </select>

    <select id="selectNewItmStrNo" resultType="java.lang.String">
        SELECT #{strTpCd} || TO_CHAR(SYSDATE, 'YYYYMMDD') || LPAD(SQ_SVST_ITM_STR_IZ$ITM_STR_NO.NEXTVAL, 7, '0') AS ITM_STR_NO
          FROM DUAL
    </select>

    <select id="selectNewOstrSn" resultType="java.lang.Integer">
        SELECT NVL(MAX(OSTR_SN), 0) + 1 AS OSTR_SN
          FROM TB_SVST_ITM_OSTR_IZ
         WHERE ITM_OSTR_NO = #{itmOstrNo}
    </select>

    <select id="selectNewStrSn" resultType="java.lang.Integer">
        SELECT NVL(MAX(STR_SN), 0) + 1 AS STR_SN
          FROM TB_SVST_ITM_STR_IZ
         WHERE ITM_STR_NO = #{itmStrNo}
    </select>

     <insert id="insertNormalOstrRgst">
        INSERT INTO TB_SVST_ITM_OSTR_IZ   /* 품목출고내역 */
             (
               ITM_OSTR_NO                /* 품목출고번호 */
             , OSTR_SN                    /* 출고일련번호 */
             , OSTR_TP_CD                 /* 출고유형코드 */
             , OSTR_WARE_NO               /* 출고창고번호 */
             , OSTR_DT                    /* 출고일자 */
             , ITM_KND_CD                 /* 품목종류코드 */
             , ITM_PD_CD                  /* 품목상품코드 */
             , OSTR_WARE_DV_CD            /* 출고창고구분코드 */
             , MNGT_UNIT_CD               /* 관리단위코드 */
             , BOX_UNIT_QTY               /* 박스단위수량 */
             , ITM_GD_CD                  /* 품목등급코드 */
             , OSTR_QTY                   /* 출고수량 */
             , OSTR_AK_NO                 /* 출고요청번호 */
             , OSTR_AK_SN                 /* 출고요청일련번호 */
             , STR_AK_WARE_DV_CD          /* 입고요청창고구분코드 */
             , WARE_MNGT_PRTNR_NO         /* 창고관리파트너번호 */
             , WARE_MNGT_PRTNR_OG_TP_CD   /* 창고관리파트너조직유형코드 */
             , STR_HOP_DT                 /* 입고희망일자 */
             , STR_TP_CD                  /* 입고유형코드 */
             , STR_WARE_NO                /* 입고창고번호 */
             , STR_RGST_DT                /* 입고등록일자 */
             , COTP_ADJ_DT                /* 운송비정산일자 */
             , ITM_STR_NO                 /* 품목입고번호 */
             , STR_SN                     /* 입고일련번호 */
             , RMK_CN                     /* 비고내용 */
             , DTA_DL_YN                  /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        VALUES
             (
               #{itmOstrNo}                                     /* 품목출고번호 */
             , #{ostrSn}                                        /* 출고일련번호 */
             , #{ostrTpCd}                                      /* 출고유형코드 */
             , #{ostrOjWareNo}                                  /* 출고창고번호 */
             , #{ostrDt}                                        /* 출고일자 */
             , #{svpdItemKnd}                                   /* 품목종류코드 */
             , #{itmPdCd}                                       /* 품목상품코드 */
             , #{ostrWareDvCd}                                  /* 출고창고구분코드 */
             , #{mngtUnitCd}                                    /* 관리단위코드 */
             , #{boxUnitQty}                                    /* 박스단위수량 */
             , #{itmGdCd}                                       /* 품목등급코드 */
             , #{outQty}                                        /* 출고수량 */
             , #{ostrAkNo}                                      /* 출고요청번호 */
             , #{ostrAkSn}                                      /* 출고요청일련번호 */
             , #{strWareDvCd}                                   /* 입고요청창고구분코드 */
             , #{ostrPrtnrNo}                                   /* 창고관리파트너번호 */
             , #{ostrOgTpCd}                                    /* 창고관리파트너조직유형코드 */
             , NVL(#{strHopDt}, TO_CHAR(SYSDATE, 'YYYYMMDD'))   /* 입고희망일자 */
             , #{strTpCd}                                       /* 입고유형코드 */
             , #{strOjWareNo}                                   /* 입고창고번호 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')                     /* 입고등록일자 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')                     /* 운송비정산일자 */
             , #{itmStrNo}                                      /* 품목입고번호 */
             , #{strSn}                                         /* 입고일련번호 */
             , #{rmkCn}                                         /* 비고내용 */
             , 'N'                                              /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <insert id="insertNormalStrRgst">
        INSERT INTO TB_SVST_ITM_STR_IZ   /* 품목입고내역 */
             (
               ITM_STR_NO                 /* 품목입고번호 */
             , STR_SN                     /* 입고일련번호 */
             , STR_TP_CD                  /* 입고유형코드 */
             , STR_RGST_DT                /* 입고등록일자 */
             , STR_WARE_NO                /* 입고창고번호 */
             , WARE_MNGT_PRTNR_NO         /* 창고관리파트너번호 */
             , WARE_MNGT_PRTNR_OG_TP_CD   /* 창고관리파트너조직유형코드 */
             , STR_WARE_DV_CD             /* 입고창고구분코드 */
             , DRT_STR_YN                 /* 직접입고여부 */
             , DLVG_DLPNR_NO              /* 납품거래처번호 */
             , ITM_PD_CD                  /* 품목상품코드 */
             , ITM_GD_CD                  /* 품목등급코드 */
             , MNGT_UNIT_CD               /* 관리단위코드 */
             , STR_QTY                    /* 입고수량 */
             , STR_UPRC_AMT               /* 입고단가금액 */
             , OSTR_AK_NO                 /* 출고요청번호 */
             , OSTR_AK_SN                 /* 출고요청일련번호 */
             , ITM_OSTR_NO                /* 품목출고번호 */
             , OSTR_SN                    /* 출고일련번호 */
             , OSTR_TP_CD                 /* 출고유형코드 */
             , OSTR_WARE_NO               /* 출고창고번호 */
             , OSTR_DT                    /* 출고일자 */
             , RMK_CN                     /* 비고내용 */
             , DTA_DL_YN                  /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        VALUES
             (
               #{itmStrNo}                     /* 품목입고번호 */
             , #{strSn}                        /* 입고일련번호 */
             , #{strTpCd}                      /* 입고유형코드 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')    /* 입고등록일자 */
             , #{strOjWareNo}                  /* 입고창고번호 */
             , #{strPrtnrNo}                   /* 창고관리파트너번호 */
             , #{strOgTpCd}                    /* 창고관리파트너조직유형코드 */
             , #{strWareDvCd}                  /* 입고창고구분코드 */
             , 'N'                             /* 직접입고여부 */
             , #{ostrOjWareNo}                 /* 납품거래처번호 */
             , #{itmPdCd}                      /* 품목상품코드 */
             , #{itmGdCd}                      /* 품목등급코드 */
             , #{mngtUnitCd}                   /* 관리단위코드 */
             , #{outQty}                       /* 입고수량 */
             , 0                               /* 입고단가금액 */
             , #{ostrAkNo}                     /* 출고요청번호 */
             , #{ostrAkSn}                     /* 출고요청일련번호 */
             , #{itmOstrNo}                    /* 품목출고번호 */
             , #{ostrSn}                       /* 출고일련번호 */
             , #{ostrTpCd}                     /* 출고유형 */
             , #{ostrOjWareNo}                 /* 출고창고번호 */
             , #{ostrDt}                       /* 출고일자 */
             , #{rmkCn}                        /* 비고내용 */
             , 'N'                             /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <update id="updateItmOstrAkIz">
        UPDATE TB_SVST_ITM_OSTR_AK_IZ   /* 품목출고요청내역 */
           SET RECT_OSTR_DT  = #{ostrDt}                          /* 최근출고일자 */
             , OSTR_AGG_QTY  = NVL(OSTR_AGG_QTY, 0) + #{outQty}   /* 출고누계수량 */
             , RMK_CN        = #{rmkCn}                           /* 비고내용 */
             , OSTR_CNFM_CD  = '0'                                /* 출고확정코드 */
        <include refid="COMMON.updateSystemField"/>
         WHERE OSTR_AK_NO = #{ostrAkNo}
           AND OSTR_AK_SN = #{ostrAkSn}
    </update>

    <select id="selectOstrCnfmCount" resultType="java.lang.Integer">
        SELECT COUNT( CASE WHEN OSTR_AK_RGST_DT <![CDATA[>]]> '20190700' THEN CASE WHEN OSTR_CNFM_QTY = OSTR_AGG_QTY THEN 1 END
                           ELSE CASE WHEN RECT_OSTR_DT IS NOT NULL THEN 1 END
                      END )
          FROM TB_SVST_ITM_OSTR_AK_IZ   /* 품목출고요청내역 */
         WHERE DTA_DL_YN   = 'N'
           AND OSTR_AK_NO  = #{ostrAkNo}
           AND OSTR_AK_SN IN
                        <foreach collection="ostrAkSns" item="item" open="(" close=")" separator=",">
                              #{item}
                        </foreach>
    </select>

</mapper>
