<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaNormalOutOfStorageMapper">

     <select id="selectWarehouses" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$SearchWarehouse">
        SELECT WARE_NO
             , WARE_NM
          FROM TB_SVST_MCBY_WARE_IZ
         WHERE DTA_DL_YN          = 'N'
           AND WARE_USE_YN        = 'Y'
           AND APY_YM             = #{apyYm}
           AND WARE_MNGT_PRTNR_NO = #{session.employeeIDNumber}
         ORDER BY WARE_NO
    </select>

    <select id="selectNormalOutOfStorage" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$SearchRes">
        SELECT T1.OSTR_AK_NO
             , T1.OSTR_AK_TP_CD
             , T1.OSTR_OJ_WARE_NO
             , T1.STR_OJ_WARE_NO
             , ( SELECT WARE_NM
                   FROM TB_SVST_MCBY_WARE_IZ
                  WHERE WARE_NO   = T1.STR_OJ_WARE_NO
                    AND DTA_DL_YN = 'N'
                    AND APY_YM    = SUBSTR(#{strHopDtStr}, 1, 6) ) AS STR_OJ_WARE_NM
             , T1.STR_HOP_DT
             , T1.OVIV_TP_CD
             , T1.RECT_OSTR_DT
             , T1.ITM_PD_CD
             , T1.OSTR_AK_RGST_DT
             , T1.OSTR_DTRN_YN
             , T2.PD_NM || ' 외'                                   AS PD_NM
             , T1.OSTR_AK_SN
             , ' '                                                 AS RMK_CN
          FROM
             (
               SELECT D1.OSTR_AK_NO                          /* 출고요청번호 */
                    , D1.OSTR_AK_TP_CD                       /* 출고요청유형 */
                    , D1.OSTR_OJ_WARE_NO                     /* 출고대상창고번호 */
                    , D1.STR_OJ_WARE_NO                      /* 입고대상창고번호 */
                    , D1.STR_HOP_DT                          /* 입고희망일자 */
                    , D1.OVIV_TP_CD                          /* 배차형태 */
                    , D1.OSTR_AK_RGST_DT
                    , MIN(D1.OSTR_AK_SN)   AS OSTR_AK_SN     /* 출고요청일련번호 */
                    , MAX(D1.RECT_OSTR_DT) AS RECT_OSTR_DT   /* 최근출고일자 */
                    , MIN(D1.ITM_PD_CD)    AS ITM_PD_CD      /* 품목상품코드 */
                    , CASE WHEN D1.OSTR_AK_RGST_DT <![CDATA[>]]> '20190700' THEN CASE COUNT(CASE WHEN D1.OSTR_CNFM_QTY = D1.OSTR_AGG_QTY THEN 1 END) WHEN COUNT(1) THEN '출고완료'
                                                                                                                                                     WHEN 0        THEN '출고대기'
                                                                                                                                                     ELSE '일부출고'
                                                                                 END
                           ELSE CASE WHEN COUNT(*) = COUNT(D1.RECT_OSTR_DT) THEN '출고완료'
                                END
                      END                  AS OSTR_DTRN_YN   /* 출고확정여부 */
                 FROM TB_SVST_ITM_OSTR_AK_IZ D1         /* 품목출고요청내역 */
                INNER JOIN TB_SVST_MCBY_WARE_IZ D2      /* 월별창고내역 */
                   ON D2.WARE_NO = D1.OSTR_OJ_WARE_NO
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D3   /* 상품각사속성상세 */
                   ON D3.PD_CD = D1.ITM_PD_CD
                WHERE D1.DTA_DL_YN          = 'N'
                  AND D2.DTA_DL_YN          = 'N'
                  AND D2.WARE_USE_YN        = 'Y'
                  AND D3.DTA_DL_YN          = 'N'
                  AND D3.PD_EXTS_PRP_GRP_CD = 'PART'
                  AND D1.OSTR_OJ_WARE_NO    = #{ostrOjWareNo}
                  AND D1.STR_HOP_DT BETWEEN #{strHopDtStr} AND #{strHopDtEnd}
                  AND D2.APY_YM             = SUBSTR(#{strHopDtStr}, 1, 6)
                  AND D2.WARE_DV_CD         = #{wareDvCd}
            <if test="@MybatisUtils@isNotEmpty(ostrAkTpCd)">
                  AND D1.OSTR_AK_TP_CD      = #{ostrAkTpCd}
            </if>
            <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
                  AND D3.PD_PRP_VAL19       = #{itmKndCd}
            </if>
                GROUP BY D1.OSTR_AK_NO, D1.OSTR_AK_TP_CD, D1.OSTR_OJ_WARE_NO, D1.STR_OJ_WARE_NO, D1.STR_HOP_DT, D1.OVIV_TP_CD, D1.OSTR_AK_RGST_DT
            <if test='@MybatisUtils@equals(ostrCnfm, "Y")'>
               HAVING CASE WHEN D1.OSTR_AK_RGST_DT <![CDATA[>]]> '20190700' THEN CASE COUNT(CASE WHEN D1.OSTR_CNFM_QTY = D1.OSTR_AGG_QTY THEN 1 END) WHEN COUNT(1) THEN '1'
                                                                                                                                                     ELSE '0'
                                                                                 END
                           ELSE CASE WHEN COUNT(*) = COUNT(D1.RECT_OSTR_DT) THEN '1'
                                     ELSE '0'
                                END
                      END = '1'   /* 출고확정 */
            </if>
            <if test='@MybatisUtils@equals(ostrCnfm, "N")'>
               HAVING CASE WHEN D1.OSTR_AK_RGST_DT <![CDATA[>]]> '20190700' THEN CASE COUNT(CASE WHEN D1.OSTR_CNFM_QTY = D1.OSTR_AGG_QTY THEN 1 END) WHEN COUNT(1) THEN '1'
                                                                                                                                                     ELSE '0'
                                                                                 END
                           ELSE CASE WHEN COUNT(*) = COUNT(D1.RECT_OSTR_DT) THEN '1'
                                     ELSE '0'
                                END
                      END = '0'   /* 출고미확정 */
            </if>
              ) T1
          INNER JOIN TB_PDBS_PD_BAS T2
             ON T2.PD_CD = T1.ITM_PD_CD
          WHERE T2.DTA_DL_YN = 'N'
            AND T2.PD_TP_CD  = 'M'
          ORDER BY T1.OSTR_AK_TP_CD, T1.OSTR_OJ_WARE_NO, T1.STR_HOP_DT, T1.OSTR_AK_NO
    </select>

    <select id="selectItmOstrAk" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$SearchItmOstrAkRes">
        SELECT D1.OSTR_AK_NO                                                                                       /* 출고요청번호 */
             , D1.STR_OJ_WARE_NO                                                                                   /* 입고대상창고번호 */
             , D1.OSTR_OJ_WARE_NO                                                                                  /* 출고대상창고번호 */
             , D1.OSTR_AK_TP_CD                                                                                    /* 출고요청유형코드 */
             , D1.STR_HOP_DT                                                                                       /* 입고희망일자 */
             , D1.OSTR_AK_RGST_DT                                                                                  /* 출고요청등록일자 */
             , D1.ITM_PD_CD                                                                                        /* 품목상품코드 */
             , F_CMZ_CD_NM('TNT_WELLS', 'OSTR_AK_TP_CD', D1.OSTR_AK_TP_CD, #{session.langId}) AS OSTR_AK_TP_NM     /* 출고요청유형명 */
             , D2.WARE_NM                                                                     AS OSTR_OJ_WARE_NM   /* 출고대상창고명 */
             , D3.WARE_NM                                                                     AS STR_OJ_WARE_NM    /* 입고대상창고명 */
             , D4.ITM_OSTR_NO                                                                                      /* 품목출고번호 */
             , D4.OSTR_TP_CD                                                                                       /* 출고유형코드 */
          FROM TB_SVST_ITM_OSTR_AK_IZ D1
         INNER JOIN TB_SVST_MCBY_WARE_IZ D2
            ON D2.APY_YM  = NVL(SUBSTR(D1.STR_HOP_DT, 1, 6), TO_CHAR(SYSDATE, 'YYYYMM'))
           AND D2.WARE_NO = D1.OSTR_OJ_WARE_NO
         INNER JOIN TB_SVST_MCBY_WARE_IZ D3
            ON D3.APY_YM  = NVL(SUBSTR(D1.STR_HOP_DT, 1, 6), TO_CHAR(SYSDATE, 'YYYYMM'))
           AND D3.WARE_NO = D1.STR_OJ_WARE_NO
          LEFT OUTER JOIN TB_SVST_ITM_OSTR_IZ D4
            ON D4.OSTR_AK_NO   = D1.OSTR_AK_NO
           AND D4.OSTR_AK_SN   = D1.OSTR_AK_SN
           AND D4.OSTR_WARE_NO = D1.OSTR_OJ_WARE_NO
           AND D4.ITM_PD_CD    = D1.ITM_PD_CD
           AND D4.DTA_DL_YN    = 'N'
         WHERE D1.DTA_DL_YN  = 'N'
           AND D2.DTA_DL_YN  = 'N'
           AND D3.DTA_DL_YN  = 'N'
           AND D1.OSTR_AK_NO = #{ostrAkNo}
           AND D1.OSTR_AK_SN = #{ostrAkSn}
           AND ROWNUM        = 1
    </select>

    <select id="selectStandardWareHouse" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$StandardWareRes">
        SELECT NVL(STD_WARE_USE_YN, 'N') AS STCK_STD_GB   /* 표준창고사용여부 */
             , WARE_NO
             , APY_YM
          FROM TB_SVST_MCBY_WARE_IZ
         WHERE DTA_DL_YN = 'N'
           AND APY_YM = #{apyYm}
           AND WARE_NO = #{wareNo}
    </select>

    <select id="selectAskMaterialsHavePss"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$AskRes">
        SELECT TA.WARE_MNGT_PRTNR_NO
             , TA.WARE_NM
             , TB.ITM_PD_CD
             , TA.WARE_NO
             , NVL((TB.PITM_STOC_A_GD_QTY - MMT_STOC_A_GD_QTY),0) AS QTY
          FROM TB_SVST_MCBY_WARE_IZ TA
         INNER JOIN TB_SVST_CST_SV_ITM_STOC_IZ TB
            ON TB.WARE_NO = TA.WARE_NO
         WHERE 1 = 1
           AND TA.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND TA.WARE_USE_YN = 'Y'
           AND TA.WARE_DV_CD = #{wareDvCd}
           AND TB.ITM_PD_CD = #{itmPdCd}
           AND TA.HGR_WARE_NO = (SELECT HGR_WARE_NO
                                   FROM TB_SVST_MCBY_WARE_IZ
                                  WHERE APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                                    AND WARE_USE_YN = 'Y'
                                    AND WARE_NO = #{strOjWareNo}
                                <if test="@MybatisUtils@equals(wareDvCd, '2')">
                                    AND WARE_DTL_DV_CD != '20'
                                </if>
                                <if test="@MybatisUtils@equals(wareDvCd, '3')">
                                    AND WARE_DTL_DV_CD != '30'
                                </if>)
           AND TA.DTA_DL_YN = 'N'
           AND TB.DTA_DL_YN = 'N'
         ORDER BY WARE_NM
    </select>

    <select id="selectAskMaterialsCenterPresentState" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$CenterRes">
            SELECT A1.WARE_NO
                , NVL((A1.PITM_STOC_A_GD_QTY - A1.MMT_STOC_A_GD_QTY),0) AS QTY
                , A2.WARE_NM
             FROM TB_SVST_CST_SV_ITM_STOC_IZ A1
            INNER JOIN TB_SVST_MCBY_WARE_IZ A2
               ON A1.WARE_NO = A2.WARE_NO
            WHERE 1 = 1
              AND A1.ITM_PD_CD = #{itmPdCd}
              AND A2.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
          <if test="@MybatisUtils@equals(wareDvCd, '2')">
              AND A2.WARE_DTL_DV_CD = '20'
          </if>
          <if test="@MybatisUtils@equals(wareDvCd, '3')">
              AND A2.WARE_DTL_DV_CD = '30'
          </if>
              AND A1.DTA_DL_YN = 'N'
              AND A2.DTA_DL_YN = 'N'
    </select>

    <select id="getNormalOstrRgsts"
        resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$DetailRes">
        SELECT 'I' AS FLAG
             , (CASE WHEN T1.OSTR_AK_RGST_DT <![CDATA[>]]> '20190700'
                     THEN CASE WHEN (NVL(T1.OSTR_CNFM_QTY,0) - NVL(T1.OSTR_AGG_QTY,0)) = 0
                              THEN '0'
                              ELSE '1'
                          END
                     ELSE CASE WHEN T1.RECT_OSTR_DT IS NULL
                              THEN '1'
                              ELSE '0'
                          END
               END) AS CHK
             , '0' AS DUMMY_QTY
             , T1.OSTR_AK_TP_CD
             , (CASE T1.OSTR_AK_TP_CD
                     WHEN '310' THEN '221'
                     WHEN '320' THEN '223'
                     WHEN '330' THEN '221'
               END) AS OSTR_TP_CD
             , T1.STR_OJ_WARE_NO AS STR_WARE_NO
             , T1.OSTR_AK_RGST_DT
             , T1.OSTR_AK_SN || '' AS OSTR_AK_SN
             , T1.OSTR_AK_NO
             , T1.STR_HOP_DT
             , T2.SVPD_ITEM_KND /* ST156_ITEM_KND */
             , T1.ITM_PD_CD
             , T2.SVPD_NM_KOR
             , T2.SVPD_SAP_CD
             , (SELECT CASE WHEN #{ostrOjWareNm} = '교원파주물류센터'
                            THEN F_CMZ_CD_NM('TNT_WELLS', 'WARE_TP_CD', S1.WARE_TP_CD)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_ANGLE_CD', S1.ITM_LCT_ANGLE_VAL)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_FLOR_NO_CD', S1.ITM_LCT_FLOR_NO_VAL)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_COF_CD', S1.ITM_LCT_COF_VAL)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_MAT_GRP_CD', S1.ITM_LCT_MAT_GRP_CD)
                            ELSE F_CMZ_CD_NM('TNT_WELLS', 'WARE_TP_CD', S1.WARE_TP_CD)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_ANGLE_CD', S1.ITM_LCT_ANGLE_VAL)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_COF_CD', S1.ITM_LCT_COF_VAL)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_FLOR_NO_CD', S1.ITM_LCT_FLOR_NO_VAL)
                                 ||' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_MAT_GRP_CD', S1.ITM_LCT_MAT_GRP_CD)
		               END
                  FROM TB_SVST_CST_SV_ITM_LCT_IZ S1
                 WHERE S1.WARE_NO = (SELECT CASE WHEN #{stckStdGb} != '1' THEN '200012'
                                                 WHEN S2.WARE_NO = '100002' THEN '' /* 교원파주물류센터로 조회 시 품목위치 조회되게 변경(2020.12.03 안승기 매니저님) */
                                                 ELSE S2.WARE_NO
                                                  END
                                       FROM TB_SVST_MCBY_WARE_IZ S2
                                      WHERE S2.WARE_NM = #{ostrOjWareNm}
                                        AND S2.APY_YM = SUBSTR(#{ostrAkRgstDt},1,6)
                                        AND S2.DTA_DL_YN = 'N'
                                    )
                   AND S1.ITM_PD_CD  = T1.ITM_PD_CD
                   AND S1.DTA_DL_YN = 'N'
               ) AS ITEM_LOC
             , (SELECT S3.OSTR_TMS || ''
                  FROM TB_SVST_CST_SV_ITM_LCT_IZ S3
                 WHERE S3.WARE_NO = (SELECT CASE WHEN S4.WARE_NO = '100002' THEN S4.WARE_NO
                                                 ELSE ''
                                             END
                                       FROM TB_SVST_MCBY_WARE_IZ S4
                                      WHERE S4.WARE_NM = #{ostrOjWareNm}
                                        AND S4.APY_YM = SUBSTR(#{ostrAkRgstDt},1,6)
                                        AND S4.DTA_DL_YN = 'N'
                                    )
                   AND S3.ITM_PD_CD  = T1.ITM_PD_CD
                   AND S3.DTA_DL_YN = 'N'
               ) AS PAJU_LOC
             , T1.OSTR_AK_WARE_DV_CD /* ST156_REQ_DEPT_GB */
             , T1.WARE_MNGT_PRTNR_NO /* ST156_REQ_STCK_MGR */
             , T1.ITM_GD_CD
             , (CASE T1.ITM_GD_CD
                     WHEN 'A' THEN (T4.PITM_STOC_A_GD_QTY - T4.MMT_STOC_A_GD_QTY)
                     WHEN 'B' THEN (T4.PITM_STOC_B_GD_QTY - T4.MMT_STOC_B_GD_QTY)
                     WHEN 'E' THEN (T4.PITM_STOC_E_GD_QTY - T4.MMT_STOC_E_GD_QTY)
                     WHEN 'R' THEN (T4.PITM_STOC_R_GD_QTY - T4.MMT_STOC_R_GD_QTY)
               END) AS REQ_STCK_QTY  <!-- 요청창고 재고수량 -->
             , T1.OSTR_OJ_WARE_NO AS OSTR_WARE_NO
             , T1.OSTR_WARE_MNGT_PRTNR_NO
             , T1.MNGT_UNIT_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', T1.MNGT_UNIT_CD) AS MGT_UNT_NM
             , T1.BOX_UNIT_QTY || '' AS BOX_UNIT_QTY
             , T1.OSTR_AK_QTY || '' AS OSTR_AK_QTY
             , (CASE T1.ITM_GD_CD
                     WHEN 'A' THEN (T5.PITM_STOC_A_GD_QTY - T5.MMT_STOC_A_GD_QTY)
                     WHEN 'B' THEN (T5.PITM_STOC_B_GD_QTY - T5.MMT_STOC_B_GD_QTY)
                     WHEN 'E' THEN (T5.PITM_STOC_E_GD_QTY - T5.MMT_STOC_E_GD_QTY)
                     WHEN 'R' THEN (T5.PITM_STOC_R_GD_QTY - T5.MMT_STOC_R_GD_QTY)
               END) AS QTY
             , NVL(T1.OSTR_CNFM_QTY, 0) || '' AS OSTR_CNFM_QTY
             , T1.RMK_CN
             , T1.OSTR_CNFM_CD
             , T1.RECT_OSTR_DT
             , NVL(T1.OSTR_AGG_QTY, 0) || '' AS OSTR_AGG_QTY
             , (NVL(T1.OSTR_CNFM_QTY, 0) - NVL(T1.OSTR_AGG_QTY, 0)) || '' AS OUT_QTY
             , (NVL(T1.OSTR_CNFM_QTY, 0) - NVL(T1.OSTR_AGG_QTY, 0)) || '' AS OUT_QTY_ORG
             , '' AS STR_CONF_DT
             , T2.SVPD_BASE_GB /* ST101_BASE_GB */
             , T2.SVPD_BASE_COLOR_GB /* ST101_BASE_COLOR_GB */
             , T2.SVPD_MGT_TYP /* ST101_MGT_TYP */
             , '' AS CFRM_CNT
             , (SELECT ROUND(SUM(S7.USE_QTY)/3,1)
                  FROM TB_SVST_SV_WK_OSTR_IZ S7
                 INNER JOIN TB_SVST_MCBY_WARE_IZ S8
                    ON S8.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                   AND S8.HGR_WARE_NO = T1.STR_OJ_WARE_NO
                 WHERE S7.WK_WARE_NO = S8.WARE_NO
                   AND S7.ITM_PD_CD = T1.ITM_PD_CD
                   AND S7.FNL_ITM_GD_CD = T1.ITM_GD_CD
                   AND S7.FNL_VST_FSH_DT BETWEEN TO_CHAR(
                                                    ADD_MONTHS(
                                                        TO_DATE(
                                                            NVL( T1.RECT_OSTR_DT,TO_CHAR(SYSDATE, 'YYYYMMDD'))
                                                            , 'YYYYMMDD')
                                                        , -3)
                                                    , 'YYYYMM'
                                                 ) || '01'
                                             AND TO_CHAR(
                                                    LAST_DAY(
                                                        ADD_MONTHS(
                                                            TO_DATE(
                                                                SUBSTR( NVL( T1.RECT_OSTR_DT
                                                                             , TO_CHAR(SYSDATE, 'YYYYMMDD'))
                                                                        , 1
                                                                        , 6)
                                                                || '01'
                                                                , 'YYYYMMDD')
                                                            , -1)
                                                    ), 'YYYYMMDD')
                   AND S7.DTA_DL_YN = 'N'
                   AND S8.DTA_DL_YN = 'N'
               ) AS AVG_OUT
             , (SELECT S5.WARE_DV_CD
                 FROM TB_SVST_MCBY_WARE_IZ S5
                WHERE S5.WARE_NO = T1.STR_OJ_WARE_NO
                  AND S5.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                  AND S5.DTA_DL_YN = 'N'
               ) AS STR_WARE_DV_CD
             , (SELECT S6.WARE_DTL_DV_CD
                 FROM TB_SVST_MCBY_WARE_IZ S6
                WHERE S6.WARE_NO = T1.OSTR_OJ_WARE_NO
                  AND S6.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                  AND S6.DTA_DL_YN = 'N'
               ) AS OSTR_WARE_DV_CD
             , (SELECT S5.WARE_DTL_DV_CD
                 FROM TB_SVST_MCBY_WARE_IZ S5
                WHERE S5.WARE_NO = T1.STR_OJ_WARE_NO
                  AND S5.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                  AND S5.DTA_DL_YN = 'N'
               ) AS STR_WARE_DTL_DV_CD
             , (SELECT S6.WARE_DV_CD
                 FROM TB_SVST_MCBY_WARE_IZ S6
                WHERE S6.WARE_NO = T1.OSTR_OJ_WARE_NO
                  AND S6.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                  AND S6.DTA_DL_YN = 'N'
               ) AS OSTR_WARE_DTL_DV_CD
             , T6.WARE_NM AS STR_WARE_NM
             , T7.WARE_NM AS OSTR_WARE_NM
          FROM TB_SVST_ITM_OSTR_AK_IZ T1
         INNER JOIN (<include refid="com.kyowon.sms.wells.web.service.common.BASE.selectPartMaster"/>) T2
            ON T1.ITM_PD_CD = T2.SVPD_PD_CD
          LEFT OUTER JOIN TB_SVST_CST_SV_ITM_STOC_IZ T4
            ON T1.ITM_PD_CD = T4.ITM_PD_CD
           AND T1.STR_OJ_WARE_NO = T4.WARE_NO
           AND T4.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SVST_CST_SV_ITM_STOC_IZ T5
            ON T1.ITM_PD_CD = T5.ITM_PD_CD
           AND T1.OSTR_OJ_WARE_NO = T5.WARE_NO
           AND T5.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SVST_MCBY_WARE_IZ T6
            ON T6.WARE_NO =  T1.STR_OJ_WARE_NO
           AND T6.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND T6.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SVST_MCBY_WARE_IZ T7
            ON T7.WARE_NO =  T1.OSTR_OJ_WARE_NO
           AND T7.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND T7.DTA_DL_YN = 'N'
         WHERE T1.OSTR_AK_TP_CD = #{ostrAkTpCd}
           AND T1.STR_OJ_WARE_NO = #{strOjWareNo}
           AND T1.OSTR_AK_RGST_DT = #{rgstDt}
           AND T1.OSTR_AK_NO = #{ostrAkNo}
           AND T1.DTA_DL_YN = 'N'
          ORDER BY T1.OSTR_AK_NO, T1.OSTR_AK_SN
    </select>
    <select id="removeNormalOstrRgsts"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$DetailRes">
        SELECT 'D' AS FLAG
             , '1' AS CHK
             , '0' AS DUMMY_QTY
             , T3.OSTR_AK_TP_CD
             , T1.OSTR_TP_CD
             , T1.STR_WARE_NO
             , T3.OSTR_AK_RGST_DT
             , T1.OSTR_AK_SN || '' AS OSTR_AK_SN
             , T1.OSTR_AK_NO
             , T1.STR_HOP_DT
             , T2.SVPD_ITEM_KND /* ST156_ITEM_KND */
             , T1.ITM_PD_CD
             , T2.SVPD_NM_KOR
             , T2.SVPD_SAP_CD
             , (SELECT CASE WHEN #{ostrOjWareNm} = '교원파주물류센터'
                            THEN F_CMZ_CD_NM('TNT_WELLS', 'WARE_TP_CD', S1.WARE_TP_CD)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_ANGLE_CD', S1.ITM_LCT_ANGLE_VAL)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_FLOR_NO_CD', S1.ITM_LCT_FLOR_NO_VAL)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_COF_CD', S1.ITM_LCT_COF_VAL)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_MAT_GRP_CD', S1.ITM_LCT_MAT_GRP_CD)
                                 ELSE F_CMZ_CD_NM('TNT_WELLS', 'WARE_TP_CD', S1.WARE_TP_CD)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_ANGLE_CD', S1.ITM_LCT_ANGLE_VAL)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_COF_CD', S1.ITM_LCT_COF_VAL)
                                 || ' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_FLOR_NO_CD', S1.ITM_LCT_FLOR_NO_VAL)
                                 ||' '
                                 || F_CMZ_CD_NM('TNT_WELLS', 'LCT_MAT_GRP_CD', S1.ITM_LCT_MAT_GRP_CD)
                       END
                  FROM TB_SVST_CST_SV_ITM_LCT_IZ S1
                 WHERE S1.WARE_NO = (SELECT CASE WHEN #{stckStdGb} != '1' THEN '200012'
                                                 WHEN S2.WARE_NO = '100002' THEN '' /* 교원파주물류센터로 조회 시 품목위치 조회되게 변경(2020.12.03 안승기 매니저님) */
                                                 ELSE S2.WARE_NO
                                             END
                                       FROM TB_SVST_MCBY_WARE_IZ S2
                                      WHERE S2.WARE_NM = #{ostrOjWareNm}
                                        AND S2.APY_YM = SUBSTR(#{ostrAkRgstDt},1,6)
                                        AND S2.DTA_DL_YN = 'N'
                                    )
                   AND S1.ITM_PD_CD  = T1.ITM_PD_CD
                   AND S1.DTA_DL_YN = 'N'
               ) AS ITEM_LOC
             , (SELECT S3.OSTR_TMS || ''
                  FROM TB_SVST_CST_SV_ITM_LCT_IZ S3
                 WHERE S3.WARE_NO = (SELECT CASE WHEN S4.WARE_NO = '100002' THEN S4.WARE_NO
                                                 ELSE ''
                                             END
                                       FROM TB_SVST_MCBY_WARE_IZ S4
                                      WHERE S4.WARE_NM = #{ostrOjWareNm}
                                        AND S4.APY_YM = SUBSTR(#{ostrAkRgstDt},1,6)
                                        AND S4.DTA_DL_YN = 'N'
                                    )
                   AND S3.ITM_PD_CD  = T1.ITM_PD_CD
                   AND S3.DTA_DL_YN = 'N'
               ) AS PAJU_LOC
             , T3.OSTR_AK_WARE_DV_CD /* ST156_REQ_DEPT_GB */
             , T1.ITM_GD_CD
             , (CASE T1.ITM_GD_CD
                     WHEN 'A' THEN (T4.PITM_STOC_A_GD_QTY - T4.MMT_STOC_A_GD_QTY)
                     WHEN 'B' THEN (T4.PITM_STOC_B_GD_QTY - T4.MMT_STOC_B_GD_QTY)
                     WHEN 'E' THEN (T4.PITM_STOC_E_GD_QTY - T4.MMT_STOC_E_GD_QTY)
                     WHEN 'R' THEN (T4.PITM_STOC_R_GD_QTY - T4.MMT_STOC_R_GD_QTY)
                 END) AS REQ_STCK_QTY  <!-- 요청창고 재고수량 -->
             , T1.OSTR_WARE_NO
             , T1.WARE_MNGT_PRTNR_NO
             , T1.MNGT_UNIT_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', T3.MNGT_UNIT_CD) AS MGT_UNT_NM
             , T3.BOX_UNIT_QTY || '' AS BOX_UNIT_QTY
             , '' AS OSTR_AK_QTY
             , (CASE T1.ITM_GD_CD
                     WHEN 'A' THEN (T5.PITM_STOC_A_GD_QTY - T5.MMT_STOC_A_GD_QTY)
                     WHEN 'B' THEN (T5.PITM_STOC_B_GD_QTY - T5.MMT_STOC_B_GD_QTY)
                     WHEN 'E' THEN (T5.PITM_STOC_E_GD_QTY - T5.MMT_STOC_E_GD_QTY)
                     WHEN 'R' THEN (T5.PITM_STOC_R_GD_QTY - T5.MMT_STOC_R_GD_QTY)
                 END) AS QTY
             , NVL(T1.OSTR_QTY, 0) || '' AS OSTR_CNFM_QTY
             , T3.RMK_CN
             , T3.OSTR_CNFM_CD
             , T1.OSTR_DT AS RECT_OSTR_DT
             , NVL(T1.OSTR_QTY, 0) || '' AS OSTR_AGG_QTY
             , NVL(T1.OSTR_QTY, 0) || '' AS OUT_QTY
             , NVL(T1.OSTR_QTY, 0) || '' AS OUT_QTY_ORG
             , '' AS STR_CONF_DT
             , T2.SVPD_BASE_GB /* ST101_BASE_GB */
             , T2.SVPD_BASE_COLOR_GB /* ST101_BASE_COLOR_GB */
             , T2.SVPD_MGT_TYP /* ST101_MGT_TYP */
             , 0 || '' AS CFRM_CNT
             , (SELECT ROUND(SUM(S7.USE_QTY)/3,1)
                  FROM TB_SVST_SV_WK_OSTR_IZ S7
                 INNER JOIN TB_SVST_MCBY_WARE_IZ S8
                    ON S8.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                   AND S8.HGR_WARE_NO = T3.STR_OJ_WARE_NO
                 WHERE S7.WK_WARE_NO = S8.WARE_NO
                   AND S7.ITM_PD_CD = T1.ITM_PD_CD
                   AND S7.FNL_ITM_GD_CD = T1.ITM_GD_CD
                   AND S7.FNL_VST_FSH_DT
                       BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(NVL( T1.STR_CONF_DT,TO_CHAR(SYSDATE, 'YYYYMMDD'))
                                                    , 'YYYYMMDD')
                                        , -3), 'YYYYMM'
                                       ) || '01'
                           AND TO_CHAR(LAST_DAY
                                        (ADD_MONTHS
                                            (TO_DATE(SUBSTR( NVL( T1.STR_CONF_DT, TO_CHAR(SYSDATE, 'YYYYMMDD')), 1, 6)
                                              || '01', 'YYYYMMDD')
                                         , -1)
                                       ), 'YYYYMMDD')
                           AND S7.DTA_DL_YN = 'N'
                           AND S8.DTA_DL_YN = 'N'
               ) AS AVG_OUT
             , (SELECT S5.WARE_DV_CD
                  FROM TB_SVST_MCBY_WARE_IZ S5
                 WHERE S5.WARE_NO = T3.STR_OJ_WARE_NO
                   AND S5.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                   AND S5.DTA_DL_YN = 'N'
                ) AS STR_WARE_DV_CD
             , (SELECT S6.WARE_DV_CD
                  FROM TB_SVST_MCBY_WARE_IZ S6
                 WHERE S6.WARE_NO = T1.OSTR_WARE_NO
                   AND S6.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                   AND S6.DTA_DL_YN = 'N'
               ) AS OSTR_WARE_DV_CD
             , (SELECT S5.WARE_DTL_DV_CD
                  FROM TB_SVST_MCBY_WARE_IZ S5
                 WHERE S5.WARE_NO = T3.STR_OJ_WARE_NO
                   AND S5.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                   AND S5.DTA_DL_YN = 'N'
                ) AS STR_WARE_DTL_DV_CD
             , (SELECT S6.WARE_DTL_DV_CD
                  FROM TB_SVST_MCBY_WARE_IZ S6
                 WHERE S6.WARE_NO = T1.OSTR_WARE_NO
                   AND S6.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                   AND S6.DTA_DL_YN = 'N'
               ) AS OSTR_WARE_DTL_DV_CD
             , T6.WARE_NM AS STR_WARE_NM
             , T7.WARE_NM AS OSTR_WARE_NM
          FROM TB_SVST_ITM_OSTR_IZ T1
         INNER JOIN (<include refid="com.kyowon.sms.wells.web.service.common.BASE.selectPartMaster"/>) T2
            ON T1.ITM_PD_CD = T2.SVPD_PD_CD
         INNER JOIN TB_SVST_ITM_OSTR_AK_IZ T3
            ON T1.OSTR_AK_NO = T3.OSTR_AK_NO
           AND T1.OSTR_AK_SN = T3.OSTR_AK_SN
          LEFT OUTER JOIN TB_SVST_CST_SV_ITM_STOC_IZ T4
            ON T1.ITM_PD_CD = T4.ITM_PD_CD
           AND T1.STR_WARE_NO = T4.WARE_NO
           AND T4.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SVST_CST_SV_ITM_STOC_IZ T5
            ON T3.ITM_PD_CD = T5.ITM_PD_CD
           AND T1.OSTR_WARE_NO = T5.WARE_NO
           AND T5.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SVST_MCBY_WARE_IZ T6
            ON T6.WARE_NO = T1.STR_WARE_NO
           AND T6.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND T6.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SVST_MCBY_WARE_IZ T7
            ON T7.WARE_NO =  T1.OSTR_WARE_NO
           AND T7.APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND T7.DTA_DL_YN = 'N'
         WHERE T1.ITM_OSTR_NO = #{itmOstrNo}
           AND T1.OSTR_TP_CD = #{ostrTpCd}
           AND T1.OSTR_AK_NO = #{ostrAkNo}
           AND T1.STR_CONF_DT IS NULL
           AND T1.DTA_DL_YN = 'N'
         ORDER BY T1.ITM_OSTR_NO, T1.OSTR_SN
    </select>
    <select id="selectStrNoAndOstrNo"
        resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaNormalOutOfStorageDto$StrNoAndOstrNoRes">
        SELECT T2.OSTR_TP_CD || T2.TODAY_STR || LPAD(SQ_SVST_ITM_OSTR_IZ$ITM_OSTR_NO.NEXTVAL, 7, 0) AS ITM_OSTR_NO
             , T2.STR_TP_CD || T2.TODAY_STR || LPAD(SQ_SVST_ITM_STR_IZ$ITM_STR_NO.NEXTVAL, 7, 0) AS ITM_STR_NO
             , T2.OSTR_TP_CD
             , T2.STR_TP_CD
             , T2.TODAY_STR
        FROM
        (
            SELECT T1.TODAY_STR
                 , T1.OSTR_TP_CD
                 , T1.STR_TP_CD
              FROM (SELECT TO_CHAR(SYSDATE,'YYYYMMDD') AS TODAY_STR
                         , #{ostrTpCd} AS OSTR_TP_CD
                         , DECODE(#{ostrTpCd} ,'221','121','222','122','223','123','261','161','262','162') AS STR_TP_CD
                      FROM DUAL
                   ) T1
        )T2
    </select>

    <insert id="insertNormalOstrRgst">
        /* 품목출고 내역 등록 */
        INSERT INTO TB_SVST_ITM_OSTR_IZ (
               ITM_OSTR_NO
             , OSTR_TP_CD
             , OSTR_DT
             , OSTR_WARE_NO
             , OSTR_SN
             , ITM_KND_CD
             , ITM_PD_CD
             , STR_AK_WARE_DV_CD
             , WARE_MNGT_PRTNR_NO
             , OSTR_WARE_DV_CD
             , MNGT_UNIT_CD
             , BOX_UNIT_QTY
             , ITM_GD_CD
             , OSTR_QTY
             , RMK_CN
             , OSTR_AK_NO
             , OSTR_AK_SN
             , STR_HOP_DT
             , ITM_STR_NO
             , STR_TP_CD
             , STR_WARE_NO
             , STR_SN
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField"/>
        )
        SELECT #{itmOstrNo}
             , #{ostrTpCd}
             , #{todayStr}
             , #{ostrWareNo}
             , #{ostrSn}
             , #{pdPrpVal19}/*ITM_KND_CD*/
             , #{itmPdCd}
             , #{ostrAkWareDvCd}  /* STR_AK_WARE_DV_CD */
             , #{ostrWareMngtPrtnrNo}
             , #{ostrWareDvCd} /* OSTR_WARE_DV_CD */
             , #{mngtUnitCd}
             , #{boxUnitQty}
             , #{itmGdCd}
             , #{outQty}/*ostrQty*/
             , #{rmkCn}
             , #{ostrAkNo}
             , #{ostrAkSn}
             , #{strHopDt}
             , #{itmStrNo}
             , #{strTpCd}
             , #{strWareNo}
             , #{strSn}
             , 'N' /* DTA_DL_YN : DEFAULT : N */
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM DUAL
    </insert>

    <insert id="insertNormalStrRgst">
        /* 품목입고 내역 등록 */
        INSERT INTO TB_SVST_ITM_STR_IZ (
               ITM_STR_NO
             , STR_TP_CD
             , STR_WARE_NO
             , STR_RGST_DT
             , STR_SN
             , WARE_MNGT_PRTNR_NO
             , STR_WARE_DV_CD
             , DRT_STR_YN
             , ITM_PD_CD
             , ITM_GD_CD
             , MNGT_UNIT_CD
	         , STR_QTY
	         , STR_UPRC_AMT
             , ITM_OSTR_NO
	         , OSTR_TP_CD
	         , OSTR_WARE_NO
             , OSTR_AK_NO
	         , OSTR_DT
	         , OSTR_SN
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField"/>
        )
        SELECT #{itmStrNo}
             , #{strTpCd}
             , #{strWareNo}
             , #{todayStr}
             , #{strSn}
             , (SELECT WARE_MNGT_PRTNR_NO
                  FROM TB_SVST_MCBY_WARE_IZ
                 WHERE WARE_NO = #{strWareNo}
                   AND APY_YM = SUBSTR(#{todayStr}, 1, 6))
             , '1'
             , 'N' /* DRT_STR_YN : DEFAULT : N */
             , #{itmPdCd}
             , #{itmGdCd}
             , #{mngtUnitCd}
	         , #{outQty}
	         , 0
             , #{itmOstrNo}
	         , #{ostrTpCd}
	         , #{ostrWareNo}
             , #{ostrAkNo}
	         , #{todayStr}
	         , #{ostrSn}
             , 'N' /* DTA_DL_YN : DEFAULT : N */
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM DUAL
    </insert>

    <update id="updateOstrAkIz">
        UPDATE TB_SVST_ITM_OSTR_AK_IZ
           SET RECT_OSTR_DT = #{todayStr}
             , OSTR_AGG_QTY = NVL(OSTR_AGG_QTY,0) + #{outQty}
             , OSTR_CNFM_CD = 0
             , RMK_CN = #{rmkCn}
             <include refid="COMMON.updateSystemField"/>
         WHERE OSTR_AK_NO = #{ostrAkNo}
           AND OSTR_AK_SN = #{ostrAkSn}
    </update>
    <update id="updateOstrAkIzAfter">
        UPDATE TB_SVST_ITM_OSTR_AK_IZ
           SET OSTR_AK_QTY = #{ostrAkQty}
             , OSTR_CNFM_QTY = #{ostrCnfmQty}
             , RMK_CN = #{rmkCn}
             , BOX_UNIT_QTY = #{boxUnitQty}
             <include refid="COMMON.updateSystemField"/>
         WHERE OSTR_AK_NO = #{ostrAkNo}
           AND OSTR_AK_SN = #{ostrAkSn}
    </update>

    <select id="selectNormalOstrRgstChecked"
        resultType="int">
        SELECT (CASE WHEN #{ostrAkNo} > '20190700'
                    THEN COUNT(CASE WHEN (T1.OSTR_CNFM_QTY - T1.STR_AGG_QTY) != 0 THEN 1 END)
                    ELSE COUNT(CASE WHEN T1.RECT_OSTR_DT IS NULL THEN 1 END)
                END) AS CNT
          FROM TB_SVST_ITM_OSTR_AK_IZ T1
        <where>
           AND T1.OSTR_AK_NO = #{ostrAkNo}
           AND T1.OSTR_AK_SN IN (
           <foreach collection="list" item="item" separator=",">
               #{item}
           </foreach>
            )
           AND T1.DTA_DL_YN = 'N'
        </where>
    </select>

    <update id="updateStandardWareHouse">
        UPDATE TB_SVST_MCBY_WARE_IZ
           SET STD_WARE_USE_YN = #{stckStdGb}
             <include refid="COMMON.updateSystemField"/>
         WHERE WARE_NO = #{wareNo}
           AND APY_YM = #{apyYm}
    </update>




    <delete id="removeNormalStr">
        DELETE
          FROM TB_SVST_ITM_STR_IZ
         WHERE ITM_STR_NO = #{itmStrNo}
           AND STR_SN = #{strSn}
    </delete>
    <delete id="removeNormalOstr">
        DELETE
          FROM TB_SVST_ITM_OSTR_IZ
         WHERE ITM_OSTR_NO = #{itmOstrNo}
           AND OSTR_SN = #{ostrSn}
    </delete>
    <update id="updateRemoveOstrAkIzAfter">
        UPDATE TB_SVST_ITM_OSTR_AK_IZ
           SET RECT_OSTR_DT = ''
             , OSTR_AGG_QTY = OSTR_AGG_QTY - #{outQty}
             <include refid="COMMON.updateSystemField"/>
         WHERE OSTR_AK_NO = #{ostrAkNo}
           AND OSTR_AK_SN = #{ostrAkSn}
    </update>

</mapper>
