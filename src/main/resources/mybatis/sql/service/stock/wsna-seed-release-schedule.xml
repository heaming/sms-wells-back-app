<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaSeedReleaseScheduleMapper">

    <select id="selectSeedReleaseSchedulesPaging" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaSeedReleaseScheduleSearchDvo">
        SELECT CASE WHEN T1.REFRI_DV_CD = '1' THEN 'X'
                    WHEN T1.REFRI_DV_CD = '2' THEN CASE WHEN T1.OSTR_CNFMDT IS NOT NULL THEN 'C'
                                                        ELSE 'R'
                                                   END
                    ELSE 'N'
               END                                                                                AS DP_YN                  /* 입금 */
             , CASE WHEN T1.OSTR_CNFMDT IS NOT NULL THEN 'Y'
                    ELSE 'N'
               END                                                                                AS OSTR_YN                /* 출고 */
             , F_CMZ_CD_NM('TNT_WELLS', 'REFRI_DV_CD', T1.REFRI_DV_CD, #{session.langId})         AS REFRI_DIV              /* 유/무상구분 */
             , F_CMZ_CD_NM('TNT_WELLS', 'ITM_IOST_DV_CD', T1.ITM_IOST_DV_CD, #{session.langId})   AS SHIP_DIV               /* 배송구분 */
             , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_HCLSF_CD', T1.SV_BIZ_HCLSF_CD, #{session.langId}) AS RECEIPT_DIV            /* 접수구분 */
             , T1.CNTR_NO                                                                                                   /* 계약번호 */
             , T1.CNTR_NO || '-' || T1.CNTR_SN                                                    AS CNTR_DTL_NO            /* 계약상세번호 */
             , NVL(T10.RCGVP_KNM, T6.CST_KNM)                                                     AS CST_NM                 /* 고객명 */
             , T1.SDING_SPP_NO                                                                    AS SPP_ORD_NO             /* 배송번호 */
             , T4.PD_ABBR_NM                                                                      AS MCHN_MODEL             /* 기기모델 */
             , T1.OJ_DTL_CNTR_NO                                                                  AS MCHN_CST_NO            /* 기기고객번호 */
             , T1.OJ_DTL_CNTR_NO || '-' || T1.OJ_DTL_CNTR_SN                                      AS MCHN_CST_DTL_NO        /* 기기계약상세번호 */
             , T6.CST_KNM                                                                         AS MCHN_CST_NM            /* 기기고객명 */
             , T7.PD_ABBR_NM                                                                      AS CTRL_PKG               /* 현재패키지 */
             , T8.PD_ABBR_NM                                                                      AS SHIP_PKG               /* 배송패키지 */
             , REGEXP_SUBSTR(T1.SDING_PD_CD_LIST, '[^|]+', 1, 1)                                  AS SDING_PD_CD1           /* 모종1 상품코드 */
             , REGEXP_SUBSTR(T1.SDING_PD_NM_LIST, '[^|]+', 1, 1)                                  AS SDING1                 /* 모종1 */
             , REGEXP_SUBSTR(T1.SDING_QTY_LIST, '[^|]+', 1, 1)                                    AS QTY1                   /* 수량1 */
             , REGEXP_SUBSTR(T1.SOW_DT_LIST, '[^|]+', 1, 1)                                       AS SOW_DT1                /* 파종일자1 */
             , REGEXP_SUBSTR(T1.SDING_PD_CD_LIST, '[^|]+', 1, 2)                                  AS SDING_PD_CD2           /* 모종2 상품코드 */
             , REGEXP_SUBSTR(T1.SDING_PD_NM_LIST, '[^|]+', 1, 2)                                  AS SDING2                 /* 모종2 */
             , REGEXP_SUBSTR(T1.SDING_QTY_LIST, '[^|]+', 1, 2)                                    AS QTY2                   /* 수량2 */
             , REGEXP_SUBSTR(T1.SOW_DT_LIST, '[^|]+', 1, 2)                                       AS SOW_DT2                /* 파종일자2 */
             , REGEXP_SUBSTR(T1.SDING_PD_CD_LIST, '[^|]+', 1, 3)                                  AS SDING_PD_CD3           /* 모종3 상품코드 */
             , REGEXP_SUBSTR(T1.SDING_PD_NM_LIST, '[^|]+', 1, 3)                                  AS SDING3                 /* 모종3 */
             , REGEXP_SUBSTR(T1.SDING_QTY_LIST, '[^|]+', 1, 3)                                    AS QTY3                   /* 수량3 */
             , REGEXP_SUBSTR(T1.SOW_DT_LIST, '[^|]+', 1, 3)                                       AS SOW_DT3                /* 파종일자3 */
             , REGEXP_SUBSTR(T1.SDING_PD_CD_LIST, '[^|]+', 1, 4)                                  AS SDING_PD_CD4           /* 모종4 상품코드 */
             , REGEXP_SUBSTR(T1.SDING_PD_NM_LIST, '[^|]+', 1, 4)                                  AS SDING4                 /* 모종4 */
             , REGEXP_SUBSTR(T1.SDING_QTY_LIST, '[^|]+', 1, 4)                                    AS QTY4                   /* 수량4 */
             , REGEXP_SUBSTR(T1.SOW_DT_LIST, '[^|]+', 1, 4)                                       AS SOW_DT4                /* 파종일자4 */
             , REGEXP_SUBSTR(T1.SDING_PD_CD_LIST, '[^|]+', 1, 5)                                  AS SDING_PD_CD5           /* 모종5 상품코드 */
             , REGEXP_SUBSTR(T1.SDING_PD_NM_LIST, '[^|]+', 1, 5)                                  AS SDING5                 /* 모종5 */
             , REGEXP_SUBSTR(T1.SDING_QTY_LIST, '[^|]+', 1, 5)                                    AS QTY5                   /* 수량5 */
             , REGEXP_SUBSTR(T1.SOW_DT_LIST, '[^|]+', 1, 5)                                       AS SOW_DT5                /* 파종일자5 */
             , REGEXP_SUBSTR(T1.SDING_PD_CD_LIST, '[^|]+', 1, 6)                                  AS SDING_PD_CD6           /* 모종6 상품코드 */
             , REGEXP_SUBSTR(T1.SDING_PD_NM_LIST, '[^|]+', 1, 6)                                  AS SDING6                 /* 모종6 */
             , REGEXP_SUBSTR(T1.SDING_QTY_LIST, '[^|]+', 1, 6)                                    AS QTY6                   /* 수량6 */
             , REGEXP_SUBSTR(T1.SOW_DT_LIST, '[^|]+', 1, 6)                                       AS SOW_DT6                /* 파종일자6 */
             , REGEXP_SUBSTR(T1.SDING_PD_CD_LIST, '[^|]+', 1, 7)                                  AS SDING_PD_CD7           /* 모종7 상품코드 */
             , REGEXP_SUBSTR(T1.SDING_PD_NM_LIST, '[^|]+', 1, 7)                                  AS SDING7                 /* 모종7 */
             , REGEXP_SUBSTR(T1.SDING_QTY_LIST, '[^|]+', 1, 7)                                    AS QTY7                   /* 수량7 */
             , REGEXP_SUBSTR(T1.SOW_DT_LIST, '[^|]+', 1, 7)                                       AS SOW_DT7                /* 파종일자7 */
             , REGEXP_SUBSTR(T1.SDING_PD_CD_LIST, '[^|]+', 1, 8)                                  AS SDING_PD_CD8           /* 모종8 상품코드 */
             , REGEXP_SUBSTR(T1.SDING_PD_NM_LIST, '[^|]+', 1, 8)                                  AS SDING8                 /* 모종8 */
             , REGEXP_SUBSTR(T1.SDING_QTY_LIST, '[^|]+', 1, 8)                                    AS QTY8                   /* 수량8 */
             , REGEXP_SUBSTR(T1.SOW_DT_LIST, '[^|]+', 1, 8)                                       AS SOW_DT8                /* 파종일자8 */
             , REGEXP_SUBSTR(T1.SDING_PD_CD_LIST, '[^|]+', 1, 9)                                  AS SDING_PD_CD9           /* 모종9 상품코드 */
             , REGEXP_SUBSTR(T1.SDING_PD_NM_LIST, '[^|]+', 1, 9)                                  AS SDING9                 /* 모종9 */
             , REGEXP_SUBSTR(T1.SDING_QTY_LIST, '[^|]+', 1, 9)                                    AS QTY9                   /* 수량9 */
             , REGEXP_SUBSTR(T1.SOW_DT_LIST, '[^|]+', 1, 9)                                       AS SOW_DT9                /* 파종일자9 */
             , REGEXP_SUBSTR(T1.SDING_PD_CD_LIST, '[^|]+', 1, 10)                                 AS SDING_PD_CD10          /* 모종10 상품코드 */
             , REGEXP_SUBSTR(T1.SDING_PD_NM_LIST, '[^|]+', 1, 10)                                 AS SDING10                /* 모종10 */
             , REGEXP_SUBSTR(T1.SDING_QTY_LIST, '[^|]+', 1, 10)                                   AS QTY10                  /* 수량10 */
             , REGEXP_SUBSTR(T1.SOW_DT_LIST, '[^|]+', 1, 10)                                      AS SOW_DT10               /* 파종일자10 */
             , T1.REQD_DT                                                                         AS MCHN_DEM_DT            /* 기기철거일자 */
             , T1.RCPDT                                                                           AS RECEIPT_DT             /* 접수일자 */
             , T1.VST_CNFMDT                                                                      AS VST_DT                 /* 방문일자 */
             , T1.OSTR_DUEDT                                                                      AS OSTR_SCHE_DT           /* 출고예정일자 */
             , T1.BS_FSH_DT                                                                                                 /* B/S완료일자 */
             , T1.DP_DT                                                                                                     /* 입금일자 */
             , T1.OSTR_CNFMDT                                                                     AS OSTR_CNFM_DT           /* 출고확정일자 */
             , T13.CNR_NM                                                                         AS SDING_RCG_WARE_NM      /* 모종수령창고 */
             , T1.OG_NM                                                                           AS VST_CENTER             /* 방문센터 */
             , T11.PRTNR_KNM                                                                      AS VST_ICHR               /* 방문담당 */
             , CASE WHEN T11.BIZ_USE_LOCARA_TNO IS NOT NULL
                     AND T11.BIZ_USE_EXNO_ENCR IS NOT NULL
                     AND T11.BIZ_USE_IDV_TNO IS NOT NULL THEN T11.BIZ_USE_LOCARA_TNO
                    ELSE T11.CRAL_LOCARA_TNO
                END                                                                               AS ICHR_CRAL_LOCARA_TNO   /* 담당휴대지역전화번호 */
             , CASE WHEN T11.BIZ_USE_LOCARA_TNO IS NOT NULL
                     AND T11.BIZ_USE_EXNO_ENCR IS NOT NULL
                     AND T11.BIZ_USE_IDV_TNO IS NOT NULL THEN T11.BIZ_USE_EXNO_ENCR
                    ELSE T11.MEXNO_ENCR
                END                                                                               AS ICHR_MEXNO_ENCR        /* 담당전화국번호암호화 */
             , CASE WHEN T11.BIZ_USE_LOCARA_TNO IS NOT NULL
                     AND T11.BIZ_USE_EXNO_ENCR IS NOT NULL
                     AND T11.BIZ_USE_IDV_TNO IS NOT NULL THEN T11.BIZ_USE_IDV_TNO
                    ELSE T11.CRAL_IDV_TNO
                END                                                                               AS ICHR_CRAL_IDV_TNO      /* 담당휴대개별전화번호 */
             , T10.CRAL_LOCARA_TNO                                                                AS CST_CRAL_LOCARA_TNO    /* 고객휴대지역전화번호 */
             , T10.MEXNO_ENCR                                                                     AS CST_MEXNO_ENCR         /* 고객전화국번호암호화 */
             , T10.CRAL_IDV_TNO                                                                   AS CST_CRAL_IDV_TNO       /* 고객휴대개별전화번호 */
             , T12.NEW_ADR_ZIP                                                                    AS CST_ZIP                /* 고객우편번호 */
             , T12.RNADR || T12.RDADR                                                             AS CST_ADR                /* 고객주소 */
             , T1.REFRI_DV_CD                                                                                               /* 유무상구분코드 */
             , T1.CNTR_SN                                                                                                   /* 계약일련번호 */
             , T1.SV_BIZ_HCLSF_CD                                                                                           /* 서비스업무대분류코드 */
             , T1.SV_BIZ_DCLSF_CD                                                                                           /* 서비스업무세분류코드 */
             , T1.SDING_SPP_SN                                                                    AS SPP_PLAN_SN            /* 배송계획일련번호 */
             , T1.SDING_PKG_PD_CD                                                                                           /* 모종패키지상품코드 */
             , T1.MNGR_DV_CD                                                                                                /* 관리자구분코드 */
             , T1.DP_EPTT_NM                                                                                                /* 입금예정자명 */
             , T1.OG_TP_CD                                                                                                  /* 조직유형코드 */
             , T1.PRTNR_NO                                                                                                  /* 파트너번호 */
             , T9.CNTR_ADRPC_ID                                                                                             /* 계약주소지ID */
             , T1.RECAP_CS_AMT                                                                                              /* 유상비용금액 */
             , T1.ITM_IOST_DV_CD                                                                  AS SPP_DV_CD              /* 배송구분코드 */
             , T1.CST_SV_ASN_NO                                                                                             /* 고객서비스배정번호 */
             , T4.PD_CD                                                                           AS SDING_MCNR_PD_CD       /* 모종기계상품코드 */
             , T1.VST_DUEDT                                                                                                 /* 방문예정일자 */
             , NVL(T1.SV_PD_CD, T1.SDING_PKG_PD_CD)                                               AS SV_PD_CD               /* 서비스상품코드 */
             , T1.PKG_DV_CD                                                                                                 /* 패키지구분코드 */
          FROM
             (
            <if test='!@MybatisUtils@equals(svBizHclsfCd, "2") or @MybatisUtils@isEmpty(svBizHclsfCd)'>
               SELECT D1.CNTR_NO                                       /* 계약번호 */
                    , D1.CNTR_SN                                       /* 계약일련번호 */
                    , D1.SV_BIZ_HCLSF_CD                               /* 서비스업무대분류코드 */
                    , D1.SV_BIZ_DCLSF_CD                               /* 서비스업무세분류코드 */
                    , D1.SDING_SPP_NO                                  /* 배송주문번호 */
                    , D1.SDING_SPP_SN                                  /* 배송계획일련번호 */
                    , D1.REFRI_DV_CD                                   /* 유무상구분코드 */
                    , D1.OSTR_CNFMDT                                   /* 출고확정일자 */
                    , D1.ITM_IOST_DV_CD                                /* 품목입출고구분코드 */
                    , D1.SDING_PKG_PD_CD                               /* 배송 패키지 상품코드 */
                    , D5.PDCT_PD_CD                                    /* 현재 패키지 상품코드 */
                    , D5.REQD_DT                                       /* 철거일자 */
                    , D2.RCPDT                                         /* 접수일자 */
                    , D3.VST_CNFMDT                                    /* 방문일자 */
                    , D1.OSTR_DUEDT                                    /* 출고예정일자 */
                    , ''                            AS BS_FSH_DT       /* B/S완료일자 */
                    , D1.DP_DT                                         /* 입금일자 */
                    , NVL(D4.OG_NM, D7.OG_NM)       AS OG_NM           /* 방문센터 */
                    , NVL(D4.OG_TP_CD, D7.OG_TP_CD) AS OG_TP_CD        /* 조직유형코드 */
                    , NVL(D4.PRTNR_NO, D7.PRTNR_NO) AS PRTNR_NO        /* 파트너번호 */
                    , D5.SV_PD_CD                                      /* 서비스상품코드 */
                    , D1.MNGR_DV_CD                                    /* 관리자구분코드 */
                    , D1.DP_EPTT_NM                                    /* 입금예정자명 */
                    , D1.RECAP_CS_AMT                                  /* 유상비용금액 */
                    , D3.CST_SV_ASN_NO                                 /* 고객서비스배정번호 */
                    , NULL                          AS VST_DUEDT       /* 방문예정일 */
                    , D8.SDING_PD_CD_LIST                              /* 모종품목코드 리스트 */
                    , D8.SDING_PD_NM_LIST                              /* 모종품목명 리스트 */
                    , D8.SDING_QTY_LIST                                /* 모종수량 리스트 */
                    , D8.SOW_DT_LIST                                   /* 파종일자 리스트 */
                    , D9.OJ_DTL_CNTR_NO                                /* 기기계약번호 */
                    , D9.OJ_DTL_CNTR_SN                                /* 기기계약일련번호 */
                    , D11.PD_PRP_VAL12              AS PKG_DV_CD       /* 패키지구분코드 */
                 FROM TB_SVPD_SDING_SPP_PLAN_IZ D1            /* 모종배송계획내역 */
                INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ D2      /* 고객서비스AS설치대상내역 */
                   ON D2.CNTR_NO         = D1.CNTR_NO
                  AND D2.CNTR_SN         = D1.CNTR_SN
                  AND D2.SV_BIZ_HCLSF_CD = D1.SV_BIZ_HCLSF_CD
                  AND D2.SV_BIZ_DCLSF_CD = D1.SV_BIZ_DCLSF_CD
                  AND D2.CST_SV_ASN_NO   = D1.SDING_SPP_NO
                INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ D3     /* 고객서비스AS설치배정내역 */
                   ON D3.CST_SV_ASN_NO = D2.CST_SV_ASN_NO
                 LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ D4       /* 월파트너내역 */
                   ON D4.OG_TP_CD  = D3.ICHR_OG_TP_CD
                  AND D4.PRTNR_NO  = D3.ICHR_PRTNR_NO
                  AND D4.DTA_DL_YN = 'N'
                  AND D4.BASE_YM   = SUBSTR(#{strtDt}, 1, 6)
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D5         /* 고객서비스수행내역 */
                   ON D5.CNTR_NO = D1.CNTR_NO
                  AND D5.CNTR_SN = D1.CNTR_SN
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D6        /* 상품각사속성상세 */
                   ON D6.PD_CD = D2.PD_CD
                 LEFT OUTER JOIN TB_OGBS_PRTNR_BAS D7        /* 파트너기본 */
                   ON D7.OG_TP_CD  = D3.ICHR_OG_TP_CD
                  AND D7.PRTNR_NO  = D3.ICHR_PRTNR_NO
                  AND D7.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN LATERAL
                    (
                      SELECT DISTINCT
                             LISTAGG(S1.SDING_PD_CD, '|') WITHIN GROUP (ORDER BY S1.SDING_SN)
                                                            OVER (PARTITION BY S1.CNTR_NO, S1.CNTR_SN, S1.SV_BIZ_HCLSF_CD, S1.SV_BIZ_DCLSF_CD, S1.SDING_SPP_NO, S1.SDING_SPP_SN) AS SDING_PD_CD_LIST
                           , LISTAGG(S2.PD_ABBR_NM, '|') WITHIN GROUP (ORDER BY S1.SDING_SN)
                                                           OVER (PARTITION BY S1.CNTR_NO, S1.CNTR_SN, S1.SV_BIZ_HCLSF_CD, S1.SV_BIZ_DCLSF_CD, S1.SDING_SPP_NO, S1.SDING_SPP_SN)  AS SDING_PD_NM_LIST
                           , LISTAGG(S1.SDING_QTY, '|') WITHIN GROUP (ORDER BY S1.SDING_SN)
                                                          OVER (PARTITION BY S1.CNTR_NO, S1.CNTR_SN, S1.SV_BIZ_HCLSF_CD, S1.SV_BIZ_DCLSF_CD, S1.SDING_SPP_NO, S1.SDING_SPP_SN)   AS SDING_QTY_LIST
                           , LISTAGG(CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                          ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                     END, '|') WITHIN GROUP (ORDER BY S1.SDING_SN)
                                                 OVER (PARTITION BY S1.CNTR_NO, S1.CNTR_SN, S1.SV_BIZ_HCLSF_CD, S1.SV_BIZ_DCLSF_CD, S1.SDING_SPP_NO, S1.SDING_SPP_SN)            AS SOW_DT_LIST
                        FROM TB_SVPD_SDING_SPP_EXP_IZ S1       /* 모종배송예정내역 */
                       INNER JOIN TB_PDBS_PD_BAS S2            /* 상품기본 */
                          ON S2.PD_CD = S1.SDING_PD_CD
                       INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3   /* 상품각사속성상세 */
                          ON S3.PD_CD = S2.PD_CD
                       WHERE S1.CNTR_NO            = D1.CNTR_NO
                         AND S1.CNTR_SN            = D1.CNTR_SN
                         AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                         AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                         AND S1.SDING_SPP_NO       = D1.SDING_SPP_NO
                         AND S1.SDING_SPP_SN       = D1.SDING_SPP_SN
                         AND S1.DTA_DL_YN          = 'N'
                         AND S2.DTA_DL_YN          = 'N'
				         AND S2.PD_TP_CD           = 'M'
				         AND S3.DTA_DL_YN          = 'N'
				         AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
                    <if test='@MybatisUtils@equals(sppDvCd, "1")'>
                         AND S3.PD_PRP_VAL20       = '11'         /* 모종 */
                         AND S3.PD_PRP_VAL19      IN ('3', '4')   /* 모종, 상품 */
                    </if>
                    ) D8
                   ON 1 = 1
                INNER JOIN TB_SSCT_CNTR_REL D9               /* 계약관계-(모종패키지 계약과 결합된) 웰스팜계약 */
                   ON D9.BASE_DTL_CNTR_NO = D1.CNTR_NO
                  AND D9.BASE_DTL_CNTR_SN = D1.CNTR_SN
                 LEFT OUTER JOIN TB_PDBS_PD_REL D10
                   ON D10.OJ_PD_CD     = D2.PD_CD
                  AND D10.DTA_DL_YN    = 'N'
                  AND D10.PD_REL_TP_CD = '18'   /* 정기배송 */
                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN D10.VL_STRT_DTM AND D10.VL_END_DTM
                 LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL D11
                   ON D11.PD_CD              = D10.BASE_PD_CD
                  AND D11.DTA_DL_YN          = 'N'
                  AND D11.PD_EXTS_PRP_GRP_CD = 'SPP'
                WHERE D1.DTA_DL_YN          = 'N'
                  AND D2.DTA_DL_YN          = 'N'
                  AND D3.DTA_DL_YN          = 'N'
                  AND D3.WK_PRGS_STAT_CD   IN ('00', '10', '20')   /* 작업대기, 진행중, 완료 */
                  AND D5.DTA_DL_YN          = 'N'
                  AND D5.CNTR_DTL_STAT_CD  IN ('101', '201', '202', '203')   /* 정상, 고객요청정지, 연체정지, 해약접수정지 */
                  AND D6.DTA_DL_YN          = 'N'
                  AND D6.PD_EXTS_PRP_GRP_CD = 'PART'
                  AND D6.PD_PRP_VAL20       = '11'         /* 모종 */
                  AND D6.PD_PRP_VAL19      IN ('3', '4')   /* 모종, 상품 */
                  AND D1.CAN_DT IS NULL
                  AND D5.REQD_DT IS NULL
                  AND D9.DTA_DL_YN          = 'N'
                  AND D9.CNTR_REL_DTL_CD    = '216'              /* 모종결합(웰스팜+모종) */
                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN D9.VL_STRT_DTM AND D9.VL_END_DTM
                  AND CASE WHEN D11.PD_PRP_VAL12 = '4'   /* 플로린일 경우 */
                            AND D1.SV_BIZ_DCLSF_CD = '1112'
                            AND D3.WK_PRGS_STAT_CD IN ('00', '10')
                            AND (    ( SELECT COUNT(1)
                                         FROM TB_SVPD_CST_SVAS_IST_ASN_IZ
                                        WHERE DTA_DL_YN       = 'N'
                                          AND SV_BIZ_DCLSF_CD = '1112'
                                          AND WK_PRGS_STAT_CD = '20'
                                          AND CNTR_NO         = D9.OJ_DTL_CNTR_NO
                                          AND CNTR_SN         = D9.OJ_DTL_CNTR_SN ) = 0   /* 기기배송완료가 아닌 경우 */
                                  OR ( SELECT COUNT(1)
                                         FROM TB_SVPD_CST_SVAS_IST_ASN_IZ
                                        WHERE DTA_DL_YN        = 'N'
                                          AND SV_BIZ_DCLSF_CD  = '3460'
                                          AND WK_PRGS_STAT_CD IN ('00', '10', '20')
                                          AND CNTR_NO         = D9.OJ_DTL_CNTR_NO
                                          AND CNTR_SN         = D9.OJ_DTL_CNTR_SN ) <![CDATA[>]]> 0   /* 기기반품오더가 생성된 경우 */
                                )
                           THEN 0   /* 플로린의 경우 기기배송이 완료 + 기기반품오더가 생성되지 않아야 함 */
                           ELSE 1
                      END = 1
               <if test="@MybatisUtils@isNotEmpty(svBizHclsfCd)">
                  AND D1.SV_BIZ_HCLSF_CD    = #{svBizHclsfCd}
               </if>
               <choose>
               <when test='@MybatisUtils@equals(dtTpCd, "1")'>
                  AND D2.RCPDT BETWEEN #{strtDt} AND #{endDt}         /* 접수일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "2")'>
                  AND D3.VST_CNFMDT BETWEEN #{strtDt} AND #{endDt}    /* 방문일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "3")'>
                  AND D1.OSTR_CNFMDT BETWEEN #{strtDt} AND #{endDt}   /* 확정일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "4")'>
                  AND (
                           (     ( SELECT SPP_DV_CD
                                     FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                    WHERE CNR_OG_CD = NVL(D4.OG_CD, D7.OG_CD)
                                      AND DTA_DL_YN = 'N'
                                      AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                      AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ) = '1'
                             AND D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD') AND TO_CHAR( TO_DATE(#{strtDt}, 'YYYYMMDD') + ( SELECT SPP_PRD
                                                                                                                                                                 FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                                                                                                                                WHERE CNR_OG_CD = NVL(D4.OG_CD, D7.OG_CD)
                                                                                                                                                                  AND DTA_DL_YN = 'N'
                                                                                                                                                                  AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                                                                                                                                  AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ), 'YYYYMMDD')
                           )
                        OR
                           (     ( SELECT SPP_DV_CD
                                     FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                    WHERE CNR_OG_CD = NVL(D4.OG_CD, D7.OG_CD)
                                      AND DTA_DL_YN = 'N'
                                      AND DOW_DV_CD IN ('1', '2', '3', '4')
                                      AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                      AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ) = '2'
                             AND D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 2, 'YYYYMMDD') AND TO_CHAR( TO_DATE(#{strtDt}, 'YYYYMMDD') + ( SELECT SPP_PRD
                                                                                                                                                                 FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                                                                                                                                WHERE CNR_OG_CD = NVL(D4.OG_CD, D7.OG_CD)
                                                                                                                                                                  AND DTA_DL_YN = 'N'
                                                                                                                                                                  AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                                                                                                                                  AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ), 'YYYYMMDD')
                           )
                      )
               </when>
               </choose>
               <if test="@MybatisUtils@isNotEmpty(refriDivCd)">
                  AND D1.REFRI_DV_CD    = #{refriDivCd}
               </if>
               <if test="@MybatisUtils@isNotEmpty(sppDvCd)">
                  AND D1.ITM_IOST_DV_CD = #{sppDvCd}
               </if>
               <if test="@MybatisUtils@isNotEmpty(fshProcsCd)">
               <choose>
                <when test='!@MybatisUtils@equals(fshProcsCd, "20")'>
                  AND D3.WK_PRGS_STAT_CD IN ('00', '10')   /* 작업대기, 진행중 */
                </when>
                <otherwise>
                  AND D3.WK_PRGS_STAT_CD = #{fshProcsCd}
                </otherwise>
               </choose>
               </if>
               <if test="@MybatisUtils@isNotEmpty(pkgDvCd)">
                  AND D11.PD_PRP_VAL12   = #{pkgDvCd}
               </if>
               <if test='@MybatisUtils@equals(ostrYn, "Y")'>
                  AND D1.OSTR_CNFMDT IS NOT NULL
               </if>
               <if test='@MybatisUtils@equals(ostrYn, "N")'>
                  AND D1.OSTR_CNFMDT IS NULL
               </if>
            </if>
            <if test="@MybatisUtils@isEmpty(svBizHclsfCd)">
                UNION ALL
            </if>
            <if test='@MybatisUtils@equals(svBizHclsfCd, "2") or @MybatisUtils@isEmpty(svBizHclsfCd)'>
               SELECT D1.CNTR_NO                                     /* 계약번호 */
                    , D1.CNTR_SN                                     /* 계약일련번호 */
                    , D1.SV_BIZ_HCLSF_CD                             /* 서비스업무대분류코드 */
                    , D1.SV_BIZ_DCLSF_CD                             /* 서비스업무세분류코드 */
                    , D1.SDING_SPP_NO                                /* 배송주문번호 */
                    , D1.SDING_SPP_SN                                /* 배송계획일련번호 */
                    , D1.REFRI_DV_CD                                 /* 유무상구분코드 */
                    , D1.OSTR_CNFMDT                                 /* 출고확정일자 */
                    , D1.ITM_IOST_DV_CD                              /* 품목입출고구분코드 */
                    , D1.SDING_PKG_PD_CD                             /* 배송 패키지 상품코드 */
                    , D5.PDCT_PD_CD                                  /* 현재 패키지 상품코드 */
                    , D5.REQD_DT                                     /* 철거일자 */
                    , SUBSTR(D2.FST_RGST_DTM, 1, 8) AS RCPDT         /* 접수일자 */
                    , D3.VST_CNFMDT                                  /* 방문일자 */
                    , D1.OSTR_DUEDT                                  /* 출고예정일자 */
                    , D3.WK_EXCN_DT                 AS BS_FSH_DT     /* B/S완료일자 */
                    , D1.DP_DT                                       /* 입금일자 */
                    , NVL(D4.OG_NM, D7.OG_NM)       AS OG_NM         /* 방문센터 */
                    , NVL(D4.OG_TP_CD, D7.OG_TP_CD) AS OG_TP_CD      /* 조직유형코드 */
                    , NVL(D4.PRTNR_NO, D7.PRTNR_NO) AS PRTNR_NO      /* 파트너번호 */
                    , D5.SV_PD_CD                                    /* 서비스상품코드 */
                    , D1.MNGR_DV_CD                                  /* 관리자구분코드 */
                    , D1.DP_EPTT_NM                                  /* 입금예정자명 */
                    , D1.RECAP_CS_AMT                                /* 유상비용금액 */
                    , D3.CST_SV_ASN_NO                               /* 고객서비스배정번호 */
                    , D2.VST_DUEDT                                   /* 방문예정일자 */
                    , D8.SDING_PD_CD_LIST                            /* 모종품목코드 리스트 */
                    , D8.SDING_PD_NM_LIST                            /* 모종품목명 리스트 */
                    , D8.SDING_QTY_LIST                              /* 모종수량 리스트 */
                    , D8.SOW_DT_LIST                                 /* 파종일자 리스트 */
                    , D9.OJ_DTL_CNTR_NO                              /* 기기계약번호 */
                    , D9.OJ_DTL_CNTR_SN                              /* 기기계약일련번호 */
                    , ''                            AS PKG_DV_CD     /* 패키지구분코드 */
                 FROM TB_SVPD_SDING_SPP_PLAN_IZ D1            /* 모종배송계획내역 */
                INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D2      /* 고객서비스BS대상내역 */
                   ON D2.CNTR_NO         = D1.CNTR_NO
                  AND D2.CNTR_SN         = D1.CNTR_SN
                  AND D2.SV_BIZ_DCLSF_CD = D1.SV_BIZ_DCLSF_CD
                  AND D2.CST_SV_ASN_NO   = D1.SDING_SPP_NO
                INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ D3     /* 고객서비스BS배정내역 */
                   ON D3.CST_SV_ASN_NO = D2.CST_SV_ASN_NO
                  AND D3.ASN_OJ_YM     = D2.ASN_OJ_YM
                 LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ D4       /* 월파트너내역 */
                   ON D4.OG_TP_CD  = D3.CNFM_PSIC_PRTNR_OG_TP_CD
                  AND D4.PRTNR_NO  = D3.CNFM_PSIC_PRTNR_NO
                  AND D4.DTA_DL_YN = 'N'
                  AND D4.BASE_YM   = SUBSTR(#{strtDt}, 1, 6)
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D5          /* 고객서비스수행내역 */
                   ON D5.CNTR_NO = D1.CNTR_NO
                  AND D5.CNTR_SN = D1.CNTR_SN
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D6         /* 상품각사속성상세 */
                   ON D6.PD_CD = D2.PDCT_PD_CD
                 LEFT OUTER JOIN TB_OGBS_PRTNR_BAS D7         /* 파트너기본 */
                   ON D7.OG_TP_CD  = D3.CNFM_PSIC_PRTNR_OG_TP_CD
                  AND D7.PRTNR_NO  = D3.CNFM_PSIC_PRTNR_NO
                  AND D7.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN LATERAL
                    (
                      SELECT DISTINCT
                             LISTAGG(S1.SDING_PD_CD, '|') WITHIN GROUP (ORDER BY S1.SDING_SN)
                                                            OVER (PARTITION BY S1.CNTR_NO, S1.CNTR_SN, S1.SV_BIZ_HCLSF_CD, S1.SV_BIZ_DCLSF_CD, S1.SDING_SPP_NO, S1.SDING_SPP_SN) AS SDING_PD_CD_LIST
                           , LISTAGG(S2.PD_ABBR_NM, '|') WITHIN GROUP (ORDER BY S1.SDING_SN)
                                                           OVER (PARTITION BY S1.CNTR_NO, S1.CNTR_SN, S1.SV_BIZ_HCLSF_CD, S1.SV_BIZ_DCLSF_CD, S1.SDING_SPP_NO, S1.SDING_SPP_SN)  AS SDING_PD_NM_LIST
                           , LISTAGG(S1.SDING_QTY, '|') WITHIN GROUP (ORDER BY S1.SDING_SN)
                                                          OVER (PARTITION BY S1.CNTR_NO, S1.CNTR_SN, S1.SV_BIZ_HCLSF_CD, S1.SV_BIZ_DCLSF_CD, S1.SDING_SPP_NO, S1.SDING_SPP_SN)   AS SDING_QTY_LIST
                           , LISTAGG(CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                          ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                     END, '|') WITHIN GROUP (ORDER BY S1.SDING_SN)
                                                 OVER (PARTITION BY S1.CNTR_NO, S1.CNTR_SN, S1.SV_BIZ_HCLSF_CD, S1.SV_BIZ_DCLSF_CD, S1.SDING_SPP_NO, S1.SDING_SPP_SN)            AS SOW_DT_LIST
                        FROM TB_SVPD_SDING_SPP_EXP_IZ S1       /* 모종배송예정내역 */
                       INNER JOIN TB_PDBS_PD_BAS S2            /* 상품기본 */
                          ON S2.PD_CD = S1.SDING_PD_CD
                       INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3   /* 상품각사속성상세 */
                          ON S3.PD_CD = S2.PD_CD
                       WHERE S1.CNTR_NO            = D1.CNTR_NO
                         AND S1.CNTR_SN            = D1.CNTR_SN
                         AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                         AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                         AND S1.SDING_SPP_NO       = D1.SDING_SPP_NO
                         AND S1.SDING_SPP_SN       = D1.SDING_SPP_SN
                         AND S1.DTA_DL_YN          = 'N'
                         AND S2.DTA_DL_YN          = 'N'
				         AND S2.PD_TP_CD           = 'M'
				         AND S3.DTA_DL_YN          = 'N'
				         AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
                    <if test='@MybatisUtils@equals(sppDvCd, "1")'>
                         AND S3.PD_PRP_VAL20       = '11'         /* 모종 */
                         AND S3.PD_PRP_VAL19      IN ('3', '4')   /* 모종, 상품 */
                    </if>
                    ) D8
                   ON 1 = 1
                INNER JOIN TB_SSCT_CNTR_REL D9                /* 계약관계-(모종패키지 계약과 결합된) 웰스팜계약 */
                   ON D9.BASE_DTL_CNTR_NO = D1.CNTR_NO
                  AND D9.BASE_DTL_CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN          = 'N'
                  AND D1.SV_BIZ_HCLSF_CD    = '2'
                  AND D2.DTA_DL_YN          = 'N'
                  AND D3.DTA_DL_YN          = 'N'
                  AND D3.VST_PRGS_STAT_CD  IN ('00', '10', '20')   /* 작업대기, 진행중, 완료 */
                  AND D5.DTA_DL_YN          = 'N'
                  AND D5.CNTR_DTL_STAT_CD   = '101'   /* 정상 */
                  AND D6.DTA_DL_YN          = 'N'
                  AND D6.PD_EXTS_PRP_GRP_CD = 'PART'
                  AND D6.PD_PRP_VAL20       = '11'         /* 모종 */
                  AND D6.PD_PRP_VAL19      IN ('3', '4')   /* 모종, 상품 */
                  AND D1.CAN_DT IS NULL
                  AND D5.REQD_DT IS NULL
                  AND D9.DTA_DL_YN          = 'N'
                  AND D9.CNTR_REL_DTL_CD    = '216'              /* 모종결합(웰스팜+모종) */
                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN D9.VL_STRT_DTM AND D9.VL_END_DTM
               <if test="@MybatisUtils@isNotEmpty(svBizHclsfCd)">
                  AND D1.SV_BIZ_HCLSF_CD    = #{svBizHclsfCd}
               </if>
               <choose>
               <when test='@MybatisUtils@equals(dtTpCd, "1")'>
                  AND D2.FST_RGST_DTM BETWEEN #{strtDt} || '000000' AND #{endDt} || '235959'   /* 접수일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "2")'>
                  AND D3.VST_CNFMDT BETWEEN #{strtDt} AND #{endDt}                             /* 방문일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "3")'>
                  AND D1.OSTR_CNFMDT BETWEEN #{strtDt} AND #{endDt}                            /* 확정일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "4")'>
                  AND (
                           (     ( SELECT SPP_DV_CD
                                     FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                    WHERE CNR_OG_CD = NVL(D4.OG_CD, D7.OG_CD)
                                      AND DTA_DL_YN = 'N'
                                      AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                      AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ) = '1'
                             AND D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD') AND TO_CHAR( TO_DATE(#{strtDt}, 'YYYYMMDD') + ( SELECT SPP_PRD
                                                                                                                                                                 FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                                                                                                                                WHERE CNR_OG_CD = NVL(D4.OG_CD, D7.OG_CD)
                                                                                                                                                                  AND DTA_DL_YN = 'N'
                                                                                                                                                                  AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                                                                                                                                  AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ), 'YYYYMMDD')
                           )
                        OR
                           (     ( SELECT SPP_DV_CD
                                     FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                    WHERE CNR_OG_CD = NVL(D4.OG_CD, D7.OG_CD)
                                      AND DTA_DL_YN = 'N'
                                      AND DOW_DV_CD IN ('1', '2', '3', '4')
                                      AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                      AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ) = '2'
                             AND D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 2, 'YYYYMMDD') AND TO_CHAR( TO_DATE(#{strtDt}, 'YYYYMMDD') + ( SELECT SPP_PRD
                                                                                                                                                                 FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                                                                                                                                WHERE CNR_OG_CD = NVL(D4.OG_CD, D7.OG_CD)
                                                                                                                                                                  AND DTA_DL_YN = 'N'
                                                                                                                                                                  AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                                                                                                                                  AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ), 'YYYYMMDD')
                           )
                      )
               </when>
               </choose>
               <if test="@MybatisUtils@isNotEmpty(refriDivCd)">
                  AND D1.REFRI_DV_CD    = #{refriDivCd}
               </if>
               <if test="@MybatisUtils@isNotEmpty(sppDvCd)">
                  AND D1.ITM_IOST_DV_CD = #{sppDvCd}
               </if>
               <if test="@MybatisUtils@isNotEmpty(fshProcsCd)">
                <choose>
                <when test='!@MybatisUtils@equals(fshProcsCd, "20")'>
                  AND D3.VST_PRGS_STAT_CD IN ('00', '10')   /* 작업대기, 진행중 */
                </when>
                <otherwise>
                  AND D3.VST_PRGS_STAT_CD = #{fshProcsCd}
                </otherwise>
                </choose>
               </if>
               <if test="@MybatisUtils@isNotEmpty(pkgDvCd)">
                  AND EXISTS ( SELECT 1
                                 FROM TB_PDBS_PD_REL S1
                                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S2
                                   ON S2.PD_CD = S1.BASE_PD_CD
                                WHERE S1.DTA_DL_YN          = 'N'
                                  AND S1.PD_REL_TP_CD       = '18'   /* 정기배송 */
                                  AND S2.DTA_DL_YN          = 'N'
                                  AND S2.PD_EXTS_PRP_GRP_CD = 'SPP'
                                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN S1.VL_STRT_DTM AND S1.VL_END_DTM
                                  AND S1.OJ_PD_CD           = D2.PDCT_PD_CD
                                  AND S2.PD_PRP_VAL12       = #{pkgDvCd} )
               </if>
               <if test='@MybatisUtils@equals(ostrYn, "Y")'>
                  AND D1.OSTR_CNFMDT IS NOT NULL
               </if>
               <if test='@MybatisUtils@equals(ostrYn, "N")'>
                  AND D1.OSTR_CNFMDT IS NULL
               </if>
            </if>
             ) T1
         INNER JOIN TB_SSCT_CNTR_DTL T3                /* 계약상세-웰스팜 */
            ON T3.CNTR_NO = T1.OJ_DTL_CNTR_NO
           AND T3.CNTR_SN = T1.OJ_DTL_CNTR_SN
         INNER JOIN TB_PDBS_PD_BAS T4                  /* 상품기본-웰스팜 */
            ON T4.PD_CD   = T3.BASE_PD_CD
         INNER JOIN TB_SSCT_CNTR_CST_REL T5            /* 계약고객관계-웰스팜 */
            ON T5.DTL_CNTR_NO = T3.CNTR_NO
           AND T5.DTL_CNTR_SN = T3.CNTR_SN
         INNER JOIN TB_CUBS_CST_BAS T6                 /* 고객기본-웰스팜 */
            ON T6.CST_NO = T5.CST_NO
         INNER JOIN TB_PDBS_PD_BAS T7                  /* 상품기본-현재패키지 */
            ON T7.PD_CD     = T1.PDCT_PD_CD
         INNER JOIN TB_PDBS_PD_BAS T8                  /* 상품기본-배송패키지 */
            ON T8.PD_CD     = T1.SDING_PKG_PD_CD
         INNER JOIN TB_SSCT_CNTR_ADR_REL T9            /* 계약주소관계-모종패키지 */
            ON T9.DTL_CNTR_NO = T1.CNTR_NO
           AND T9.DTL_CNTR_SN = T1.CNTR_SN
          LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS T10   /* 계약주소지기본-모종패키지 */
            ON T10.CNTR_ADRPC_ID = T9.CNTR_ADRPC_ID
           AND T10.DTA_DL_YN     = 'N'
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS T11        /* 파트너기본 */
            ON T11.OG_TP_CD = T1.OG_TP_CD
           AND T11.PRTNR_NO = T1.PRTNR_NO
          LEFT OUTER JOIN TB_GBCO_ADR_BAS T12          /* 주소기본 */
            ON T12.ADR_ID    = NVL(T10.ADR_ID, T6.ADR_ID)
           AND T12.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SVPD_BYZIP_SHPADR_IZ T13  /* 우편번호별배송처내역 */
            ON T13.NEW_ADR_ZIP = T12.NEW_ADR_ZIP
           AND T13.DTA_DL_YN   = 'N'
         WHERE T3.DTA_DL_YN          = 'N'
           AND T3.CNTR_DTL_STAT_CD <![CDATA[<>]]> '303'   /* 계약취소 */
           AND T5.CNTR_CST_REL_TP_CD = '10'               /* 계약자 */
           AND T9.DTA_DL_YN          = 'N'
           AND T9.ADRPC_TP_CD       IN ('2', '3')         /* 배달주소, 설치주소 */
           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T9.VL_STRT_DTM AND T9.VL_END_DTM
         ORDER BY T1.CNTR_NO, T1.CNTR_SN, T1.SDING_SPP_NO, T1.SDING_SPP_SN
    </select>

    <update id="updateSdingSppPlanIzDpDt">
        UPDATE TB_SVPD_SDING_SPP_PLAN_IZ   /* 모종배송계획내역 */
           SET DP_DT = #{dpDt}
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN       = 'N'
           AND REFRI_DV_CD     = '2'   /* 유상서비스 */
           AND OSTR_CNFMDT IS NULL
           AND CNTR_NO         = #{cntrNo}
           AND CNTR_SN         = #{cntrSn}
           AND SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
           AND SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND SDING_SPP_NO    = #{sppOrdNo}
           AND SDING_SPP_SN    = #{sppPlanSn}
    </update>

    <select id="selectSdingSppCnfmIzCount" resultType="java.lang.Integer">
        SELECT 1
          FROM TB_SVPD_SDING_SPP_CNFM_IZ   /* 모종배송확정내역 */
         WHERE CNTR_NO         = #{cntrNo}
           AND CNTR_SN         = #{cntrSn}
           AND SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
           AND SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND SDING_SPP_NO    = #{sppOrdNo}
           AND SDING_SPP_SN    = #{sppPlanSn}
           AND ROWNUM          = 1
    </select>

    <insert id="insertSdingSppCnfmIz">
        INSERT INTO TB_SVPD_SDING_SPP_CNFM_IZ   /* 모종배송확정내역 */
             (
               CNTR_NO              /* 계약번호 */
             , CNTR_SN              /* 계약일련번호 */
             , SV_BIZ_HCLSF_CD      /* 서비스업무대분류코드 */
             , SV_BIZ_DCLSF_CD      /* 서비스업무세분류코드 */
             , SDING_SPP_NO         /* 배송주문번호 */
             , SDING_SPP_SN         /* 배송계획일련번호 */
             , CST_NM               /* 고객명 */
             , SDING_MCNR_CNTR_NO   /* 모종기계계약번호 */
             , SDING_MCNR_PD_CD     /* 모종기계상품코드 */
             , SDING_PKG_PD_CD      /* 모종패키지상품코드 */
             , SDING_PD_CD1         /* 모종상품코드1 */
             , SDING_QTY1           /* 모종수량1 */
             , SDING_SOW_DT1        /* 모종파종일자1 */
             , SDING_PD_CD2         /* 모종상품코드2 */
             , SDING_QTY2           /* 모종수량2 */
             , SDING_SOW_DT2        /* 모종파종일자2 */
             , SDING_PD_CD3         /* 모종상품코드3 */
             , SDING_QTY3           /* 모종수량3 */
             , SDING_SOW_DT3        /* 모종파종일자3 */
             , SDING_PD_CD4         /* 모종상품코드4 */
             , SDING_QTY4           /* 모종수량4 */
             , SDING_SOW_DT4        /* 모종파종일자4 */
             , SDING_PD_CD5         /* 모종상품코드5 */
             , SDING_QTY5           /* 모종수량5 */
             , SDING_SOW_DT5        /* 모종파종일자5 */
             , SDING_PD_CD6         /* 모종상품코드6 */
             , SDING_QTY6           /* 모종수량6 */
             , SDING_SOW_DT6        /* 모종파종일자6 */
             , SDING_PD_CD7         /* 모종상품코드7 */
             , SDING_QTY7           /* 모종수량7 */
             , SDING_SOW_DT7        /* 모종파종일자7 */
             , SDING_PD_CD8         /* 모종상품코드8 */
             , SDING_QTY8           /* 모종수량8 */
             , SDING_SOW_DT8        /* 모종파종일자8 */
             , SDING_PD_CD9         /* 모종상품코드9 */
             , SDING_QTY9           /* 모종수량9 */
             , SDING_SOW_DT9        /* 모종파종일자9 */
             , SDING_PD_CD10        /* 모종상품코드10 */
             , SDING_QTY10          /* 모종수량10 */
             , SDING_SOW_DT10       /* 모종파종일자10 */
             , RCPDT                /* 접수일자 */
             , VST_DT               /* 방문일자 */
             , SPP_DUEDT            /* 배송예정일자 */
             , SPP_CNFMDT           /* 배송확정일자 */
             , MNGR_DV_CD           /* 관리자구분코드 */
             , OG_TP_CD             /* 조직유형코드 */
             , ICHR_PRTNR_NO        /* 담당파트너번호 */
             , CNTR_ADRPC_ID        /* 계약주소지ID */
             , REFRI_DV_CD          /* 유무상구분코드 */
             , RECAP_CS_AMT         /* 유상비용금액 */
             , DP_EPTT_NM           /* 입금예정자명 */
             , DP_DT                /* 입금일자 */
             , SPP_DV_CD            /* 배송구분코드 */
             , DTA_DL_YN            /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        VALUES
             (
               #{cntrNo}            /* 계약번호 */
             , #{cntrSn}            /* 계약일련번호 */
             , #{svBizHclsfCd}      /* 서비스업무대분류코드 */
             , #{svBizDclsfCd}      /* 서비스업무세분류코드 */
             , #{sppOrdNo}          /* 배송주문번호 */
             , #{sppPlanSn}         /* 배송계획일련번호 */
             , #{cstNm}             /* 고객명 */
             , #{sdingMcnrCntrNo}   /* 모종기계계약번호 */
             , #{sdingMcnrPdCd}     /* 모종기계상품코드 */
             , #{sdingPkgPdCd}      /* 모종패키지상품코드 */
             , #{sdingPdCd1}        /* 모종상품코드1 */
             , #{sdingQty1}         /* 모종수량1 */
             , #{sdingSowDt1}       /* 모종파종일자1 */
             , #{sdingPdCd2}        /* 모종상품코드2 */
             , #{sdingQty2}         /* 모종수량2 */
             , #{sdingSowDt2}       /* 모종파종일자2 */
             , #{sdingPdCd3}        /* 모종상품코드3 */
             , #{sdingQty3}         /* 모종수량3 */
             , #{sdingSowDt3}       /* 모종파종일자3 */
             , #{sdingPdCd4}        /* 모종상품코드4 */
             , #{sdingQty4}         /* 모종수량4 */
             , #{sdingSowDt4}       /* 모종파종일자4 */
             , #{sdingPdCd5}        /* 모종상품코드5 */
             , #{sdingQty5}         /* 모종수량5 */
             , #{sdingSowDt5}       /* 모종파종일자5 */
             , #{sdingPdCd6}        /* 모종상품코드6 */
             , #{sdingQty6}         /* 모종수량6 */
             , #{sdingSowDt6}       /* 모종파종일자6 */
             , #{sdingPdCd7}        /* 모종상품코드7 */
             , #{sdingQty7}         /* 모종수량7 */
             , #{sdingSowDt7}       /* 모종파종일자7 */
             , #{sdingPdCd8}        /* 모종상품코드8 */
             , #{sdingQty8}         /* 모종수량8 */
             , #{sdingSowDt8}       /* 모종파종일자8 */
             , #{sdingPdCd9}        /* 모종상품코드9 */
             , #{sdingQty9}         /* 모종수량9 */
             , #{sdingSowDt9}       /* 모종파종일자9 */
             , #{sdingPdCd10}       /* 모종상품코드10 */
             , #{sdingQty10}        /* 모종수량10 */
             , #{sdingSowDt10}      /* 모종파종일자10 */
             , #{rcpDt}             /* 접수일자 */
             , #{vstDt}             /* 방문일자 */
             , #{sppDuedt}          /* 배송예정일자 */
             , #{sppCnfmdt}         /* 배송확정일자 */
             , #{mngrDvCd}          /* 관리자구분코드 */
             , #{ogTpCd}            /* 조직유형코드 */
             , #{ichrPrtnrNo}       /* 담당파트너번호 */
             , #{cntrAdrpcId}       /* 계약주소지ID */
             , #{refriDvCd}         /* 유무상구분코드 */
             , #{recapCsAmt}        /* 유상비용금액 */
             , #{dpEpttNm}          /* 입금예정자명 */
             , #{dpDt}              /* 입금일자 */
             , #{sppDvCd}           /* 배송구분코드 */
             , 'N'                  /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <update id="updateCstSvasIstAsnIzForCnfm">
        UPDATE TB_SVPD_CST_SVAS_IST_ASN_IZ   /* 고객서비스AS설치배정내역 */
           SET WK_ACPTE_STAT_CD = 'Y'                            /* 작업수락상태코드 */
             , WK_ACPTE_DT      = TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 작업수락일자 */
             , WK_ACPTE_HH      = TO_CHAR(SYSDATE, 'HH24MISS')   /* 작업수락시간 */
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN     = 'N'
           AND CST_SV_ASN_NO = #{cstSvAsnNo}
    </update>

    <update id="updateCstSvExcnIzForInstl">
        UPDATE TB_SVPD_CST_SV_EXCN_IZ   /* 고객서비스수행내역 */
           SET IST_DT = #{istDt}
        <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </update>

    <insert id="insertWelcomeBS">
        INSERT INTO TB_SVPD_CST_SV_RGBSPR_IZ   /* 고객서비스정기BS주기내역 */
             (
               CNTR_NO           /* 계약번호 */
             , CNTR_SN           /* 계약일련번호 */
             , SV_BIZ_MCLSF_CD   /* 서비스업무중분류코드 */
             , SV_BIZ_DCLSF_CD   /* 서비스업무세분류코드 */
             , WK_SN             /* 작업일련번호 */
             , VST_DUEDT         /* 방문예정일자 */
             , FILT_CHNG_LV_CD   /* 필터교체단계코드 */
             , VST_DV_CD         /* 방문구분코드 */
             , IST_NMN_N         /* 설치차월수 */
             , VST_NMN_N         /* 방문차월수 */
             , PART_USE_QTY      /* 부품사용수량 */
             , DTA_DL_YN         /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        VALUES
             (
               #{cntrNo}                                                /* 계약번호 */
             , #{cntrSn}                                                /* 계약일련번호 */
             , '22'                                                     /* 서비스업무중분류코드 - 비정기 */
             , '2250'                                                   /* 서비스업무세분류코드 - 웰컴BS */
             , 1                                                        /* 작업일련번호 */
             , TO_CHAR(TO_DATE(#{istDt}, 'YYYYMMDD') + 7, 'YYYYMMDD')   /* 방문예정일자 */
             , '00'                                                     /* 필터교체단계코드 */
             , '10'                                                     /* 방문구분코드 */
             , CASE WHEN TO_CHAR(TO_DATE(#{istDt}, 'YYYYMMDD') + 7, 'YYYYMM') = SUBSTR(#{istDt}, 1, 6)
                    THEN 0
                    ELSE 1
               END                                                      /* 설치차월수 */
             , 0                                                        /* 방문차월수 */
             , 0                                                        /* 부품사용수량 */
             , 'N'                                                      /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <update id="updateSdingSppPlanIzForCnfm">
        UPDATE TB_SVPD_SDING_SPP_PLAN_IZ   /* 모종배송계획내역 */
           SET DP_DT       = #{dpDt}        /* 입금일자 */
             , OSTR_CNFMDT = #{sppCnfmdt}   /* 출고확정일자 */
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN       = 'N'
           AND CNTR_NO         = #{cntrNo}
           AND CNTR_SN         = #{cntrSn}
           AND SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
           AND SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND SDING_SPP_NO    = #{sppOrdNo}
           AND SDING_SPP_SN    = #{sppPlanSn}
           AND OSTR_CNFMDT IS NULL
    </update>

    <insert id="insertSvWkOstrIzsForAS">
        INSERT INTO TB_SVST_SV_WK_OSTR_IZ   /* 서비스작업출고내역 */
             (
               CST_SV_ASN_NO         /* 고객서비스배정번호 */
             , WK_OSTR_SN            /* 작업출고일련번호 */
             , CNTR_NO               /* 계약번호 */
             , CNTR_SN               /* 계약일련번호 */
             , SV_BIZ_HCLSF_CD       /* 서비스업무대분류코드 */
             , SV_BIZ_DCLSF_CD       /* 서비스업무세분류코드 */
             , ITM_PD_CD             /* 품목상품코드 */
             , REFRI_DV_CD           /* 유무상구분코드 */
             , FST_PD_CD             /* 최초상품코드 */
             , FST_SELL_TP_CD        /* 최초판매유형코드 */
             , FST_PD_USWY_CD        /* 최초상품용도코드 */
             , FST_ITM_GD_CD         /* 최초품목등급코드 */
             , FST_VST_FSH_DT        /* 최초방문완료일자 */
             , FNL_PD_CD             /* 최종상품코드 */
             , FNL_SELL_TP_CD        /* 최종판매유형코드 */
             , FNL_PD_USWY_CD        /* 최종상품용도코드 */
             , FNL_ITM_GD_CD         /* 최종품목등급코드 */
             , FNL_VST_FSH_DT        /* 최종방문완료일자 */
             , USE_QTY               /* 사용수량 */
             , CSMR_UPRC_AMT         /* 소비자단가금액 */
             , FRE_EXPN_DC           /* 무료체험일수 */
             , FRE_EXPN_IST_DT       /* 무료체험설치일자 */
             , ITM_BIL_AMT           /* 품목청구금액 */
             , SV_BIL_AMT            /* 서비스청구금액 */
             , MNGR_DV_CD            /* 관리자구분코드 */
             , DGR1_LEVL_OG_ID       /* 1차레벨조직ID */
             , DGR2_LEVL_OG_ID       /* 2차레벨조직ID */
             , BRCH_OG_ID            /* 지점조직ID */
             , ICHR_PRTNR_NO         /* 담당파트너번호 */
             , OG_TP_CD              /* 조직유형코드 */
             , WK_WARE_NO            /* 작업창고번호 */
             , STKR_PRNT_YN          /* 스티커출력여부 */
             , RTNGD_RVPY_PROCS_YN   /* 반품수불처리여부 */
             , RTNGD_CONF_YN         /* 반품확인여부 */
             , REFR_AS_RCP_YN        /* 리퍼AS접수여부 */
             , DTA_DL_YN             /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        SELECT D2.CST_SV_ASN_NO               /* 고객서비스배정번호 */
             , ( SELECT NVL(MAX(WK_OSTR_SN), 0)
                   FROM TB_SVST_SV_WK_OSTR_IZ
                  WHERE CST_SV_ASN_NO = D2.CST_SV_ASN_NO )
               + ROWNUM                       /* 작업출고일련번호 */
             , D1.CNTR_NO                     /* 계약번호 */
             , D1.CNTR_SN                     /* 계약일련번호 */
             , D1.SV_BIZ_HCLSF_CD             /* 서비스업무대분류코드 */
             , D1.SV_BIZ_DCLSF_CD             /* 서비스업무세분류코드 */
             , D1.SDING_PD_CD                 /* 품목상품코드 */
             , #{refriDvCd}                   /* 유무상구분코드 */
             , #{sdingPkgPdCd}                /* 최초상품코드 */
             , D4.SELL_TP_CD                  /* 최초판매유형코드 */
             , D5.SV_PD_TP_CD                 /* 최초상품용도코드 */
             , NVL(D4.PD_GD_CD, 'A')          /* 최초품목등급코드 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 최초방문일자 */
             , #{sdingPkgPdCd}                /* 최종상품코드 */
             , D4.SELL_TP_CD                  /* 최종판매유형코드 */
             , D5.SV_PD_TP_CD                 /* 최종상품용도코드 */
             , NVL(D4.PD_GD_CD, 'A')          /* 최종품목등급코드 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 최종방문완료일자 */
             , D1.SDING_QTY                   /* 사용수량 */
             , 0                              /* 소비자단가금액 */
             , 2                              /* 무료체험일수 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 무료체험설치일자 */
             , 0                              /* 품목청구금액 */
             , 0                              /* 서비스청구금액 */
             , #{mngrDvCd}                    /* 관리자구분코드 */
             , '71314'                        /* 1차레벨조직ID */
             , '99992'                        /* 2차레벨조직ID */
             , '99992'                        /* 지점조직ID */
             , #{session.employeeIDNumber}    /* 담당파트너번호 */
             , #{session.ogTpCd}              /* 조직유형코드 */
             , '100009'                       /* 작업창고번호 */
             , 'N'                            /* 스티커출력여부 */
             , 'N'                            /* 반품수불처리여부 */
             , 'N'                            /* 반품확인여부 */
             , 'N'                            /* 리퍼AS접수여부 */
             , 'N'                            /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemFieldValue" />
          FROM TB_SVPD_SDING_SPP_EXP_IZ D1           /* 모종배송예정내역 */
         INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ D2    /* 고객서비스AS설치대상내역 */
            ON D2.CNTR_NO         = D1.CNTR_NO
           AND D2.CNTR_SN         = D1.CNTR_SN
           AND D2.SV_BIZ_HCLSF_CD = D1.SV_BIZ_HCLSF_CD
           AND D2.SV_BIZ_DCLSF_CD = D1.SV_BIZ_DCLSF_CD
           AND D2.CST_SV_ASN_NO   = D1.SDING_SPP_NO
         INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ D3   /* 고객서비스AS설치배정내역 */
            ON D3.CST_SV_ASN_NO = D2.CST_SV_ASN_NO
         INNER JOIN TB_SSCT_CNTR_DTL D4              /* 계약상세 */
            ON D4.CNTR_NO = D1.CNTR_NO
           AND D4.CNTR_SN = D1.CNTR_SN
         INNER JOIN TB_PDBS_PD_BAS D5                /* 상품기본 */
            ON D5.PD_CD = #{svPdCd}
         WHERE D1.DTA_DL_YN       = 'N'
           AND D2.DTA_DL_YN       = 'N'
           AND D3.DTA_DL_YN       = 'N'
           AND D4.DTA_DL_YN       = 'N'
           AND D1.CNTR_NO         = #{cntrNo}
           AND D1.CNTR_SN         = #{cntrSn}
           AND D1.SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
           AND D1.SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND D1.SDING_SPP_NO    = #{sppOrdNo}
           AND D1.SDING_SPP_SN    = #{sppPlanSn}
         ORDER BY D1.SDING_SN
    </insert>

    <insert id="insertSvWkOstrIzsForBS">
        INSERT INTO TB_SVST_SV_WK_OSTR_IZ   /* 서비스작업출고내역 */
             (
               CST_SV_ASN_NO         /* 고객서비스배정번호 */
             , WK_OSTR_SN            /* 작업출고일련번호 */
             , CNTR_NO               /* 계약번호 */
             , CNTR_SN               /* 계약일련번호 */
             , SV_BIZ_HCLSF_CD       /* 서비스업무대분류코드 */
             , SV_BIZ_DCLSF_CD       /* 서비스업무세분류코드 */
             , ITM_PD_CD             /* 품목상품코드 */
             , REFRI_DV_CD           /* 유무상구분코드 */
             , FST_PD_CD             /* 최초상품코드 */
             , FST_SELL_TP_CD        /* 최초판매유형코드 */
             , FST_PD_USWY_CD        /* 최초상품용도코드 */
             , FST_ITM_GD_CD         /* 최초품목등급코드 */
             , FST_VST_FSH_DT        /* 최초방문완료일자 */
             , FNL_PD_CD             /* 최종상품코드 */
             , FNL_SELL_TP_CD        /* 최종판매유형코드 */
             , FNL_PD_USWY_CD        /* 최종상품용도코드 */
             , FNL_ITM_GD_CD         /* 최종품목등급코드 */
             , FNL_VST_FSH_DT        /* 최종방문완료일자 */
             , USE_QTY               /* 사용수량 */
             , CSMR_UPRC_AMT         /* 소비자단가금액 */
             , FRE_EXPN_DC           /* 무료체험일수 */
             , FRE_EXPN_IST_DT       /* 무료체험설치일자 */
             , ITM_BIL_AMT           /* 품목청구금액 */
             , SV_BIL_AMT            /* 서비스청구금액 */
             , MNGR_DV_CD            /* 관리자구분코드 */
             , DGR1_LEVL_OG_ID       /* 1차레벨조직ID */
             , DGR2_LEVL_OG_ID       /* 2차레벨조직ID */
             , BRCH_OG_ID            /* 지점조직ID */
             , ICHR_PRTNR_NO         /* 담당파트너번호 */
             , OG_TP_CD              /* 조직유형코드 */
             , WK_WARE_NO            /* 작업창고번호 */
             , STKR_PRNT_YN          /* 스티커출력여부 */
             , RTNGD_RVPY_PROCS_YN   /* 반품수불처리여부 */
             , RTNGD_CONF_YN         /* 반품확인여부 */
             , REFR_AS_RCP_YN        /* 리퍼AS접수여부 */
             , DTA_DL_YN             /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        SELECT D2.CST_SV_ASN_NO               /* 고객서비스배정번호 */
             , ( SELECT NVL(MAX(WK_OSTR_SN), 0)
                   FROM TB_SVST_SV_WK_OSTR_IZ
                  WHERE CST_SV_ASN_NO = D2.CST_SV_ASN_NO )
               + ROWNUM                       /* 작업출고일련번호 */
             , D1.CNTR_NO                     /* 계약번호 */
             , D1.CNTR_SN                     /* 계약일련번호 */
             , D1.SV_BIZ_HCLSF_CD             /* 서비스업무대분류코드 */
             , D1.SV_BIZ_DCLSF_CD             /* 서비스업무세분류코드 */
             , D1.SDING_PD_CD                 /* 품목상품코드 */
             , #{refriDvCd}                   /* 유무상구분코드 */
             , #{sdingPkgPdCd}                /* 최초상품코드 */
             , D4.SELL_TP_CD                  /* 최초판매유형코드 */
             , D5.SV_PD_TP_CD                 /* 최초상품용도코드 */
             , NVL(D4.PD_GD_CD, 'A')          /* 최초품목등급코드 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 최초방문일자 */
             , #{sdingPkgPdCd}                /* 최종상품코드 */
             , D4.SELL_TP_CD                  /* 최종판매유형코드 */
             , D5.SV_PD_TP_CD                 /* 최종상품용도코드 */
             , NVL(D4.PD_GD_CD, 'A')          /* 최종품목등급코드 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 최종방문완료일자 */
             , D1.SDING_QTY                   /* 사용수량 */
             , 0                              /* 소비자단가금액 */
             , 2                              /* 무료체험일수 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 무료체험설치일자 */
             , 0                              /* 품목청구금액 */
             , 0                              /* 서비스청구금액 */
             , #{mngrDvCd}                    /* 관리자구분코드 */
             , '71314'                        /* 1차레벨조직ID */
             , '99992'                        /* 2차레벨조직ID */
             , '99992'                        /* 지점조직ID */
             , #{session.employeeIDNumber}    /* 담당파트너번호 */
             , #{session.ogTpCd}              /* 조직유형코드 */
             , '100009'                       /* 작업창고번호 */
             , 'N'                            /* 스티커출력여부 */
             , 'N'                            /* 반품수불처리여부 */
             , 'N'                            /* 반품확인여부 */
             , 'N'                            /* 리퍼AS접수여부 */
             , 'N'                            /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemFieldValue" />
          FROM TB_SVPD_SDING_SPP_EXP_IZ D1           /* 모종배송예정내역 */
         INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D2    /* 고객서비스BS대상내역 */
            ON D2.CNTR_NO         = D1.CNTR_NO
           AND D2.CNTR_SN         = D1.CNTR_SN
           AND D2.SV_BIZ_DCLSF_CD = D1.SV_BIZ_DCLSF_CD
           AND D2.CST_SV_ASN_NO   = D1.SDING_SPP_NO
         INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ D3   /* 고객서비스BS배정내역 */
            ON D3.CST_SV_ASN_NO = D2.CST_SV_ASN_NO
         INNER JOIN TB_SSCT_CNTR_DTL D4              /* 계약상세 */
            ON D4.CNTR_NO = D1.CNTR_NO
           AND D4.CNTR_SN = D1.CNTR_SN
         INNER JOIN TB_PDBS_PD_BAS D5                /* 상품기본 */
            ON D5.PD_CD = #{svPdCd}
         WHERE D1.DTA_DL_YN       = 'N'
           AND D2.DTA_DL_YN       = 'N'
           AND D3.DTA_DL_YN       = 'N'
           AND D4.DTA_DL_YN       = 'N'
           AND D1.CNTR_NO         = #{cntrNo}
           AND D1.CNTR_SN         = #{cntrSn}
           AND D1.SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
           AND D1.SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND D1.SDING_SPP_NO    = #{sppOrdNo}
           AND D1.SDING_SPP_SN    = #{sppPlanSn}
         ORDER BY D1.SDING_SN
    </insert>

    <update id="updateCstSvRgbsprIz">
        UPDATE TB_SVPD_CST_SV_RGBSPR_IZ   /* 고객서비스정기BS주기내역 */
           SET WK_DT            = TO_CHAR(SYSDATE,'YYYYMMDD')   /* 작업일자 */
             , WK_PSIC_DV_CD	= '2'                           /* 작업담당자구분코드 */
             , WK_PSIC_OG_TP_CD = #{session.ogTpCd}             /* 작업담당자조직유형코드 */
             , WK_PSIC_NO       = #{session.employeeIDNumber}   /* 작업담당자번호 */
        <include refid="COMMON.updateSystemField" />
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND VST_DUEDT BETWEEN SUBSTR(#{vstDuedt}, 1, 6) || '01' AND SUBSTR(#{vstDuedt}, 1, 6) || '31'
    </update>

    <select id="selectCstSvWkRsIzCount" resultType="java.lang.Integer">
        SELECT 1
          FROM TB_SVPD_CST_SV_WK_RS_IZ   /* 고객서비스작업결과내역 */
         WHERE CST_SV_ASN_NO = #{cstSvAsnNo}
           AND ROWNUM        = 1
    </select>

    <select id="selectAsTpCdInfo" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaSeedReleaseScheduleAsTpDvo">
        SELECT D1.AS_LCT_CD        /* AS위치코드 */
             , D1.AS_PHN_CD        /* AS현상코드 */
             , D1.AS_CAUS_CD       /* AS원인코드 */
             , D1.SITE_AW_ATC_CD   /* 현장수당항목코드 */
             , CASE WHEN D2.PD_CD IN ('WM05106481', 'WM05106365', 'WM05106345', 'WM05106346', 'WM05106355', 'WM05106356', 'WM05106364') THEN '901R'
                    WHEN D2.PD_CD IN ('WM05106357', 'WM05106358', 'WM05106481', 'WM05106366', 'WM05106367', 'WM05106347', 'WM05106348') THEN '902R'
                    WHEN D2.PD_CD IN ('WM05106359', 'WM05106360', 'WM05106481', 'WM05106368', 'WM05106369', 'WM05106349', 'WM05106350') THEN '903R'
                    WHEN D2.PD_CD IN ('WM05106351', 'WM05106352', 'WM05106361', 'WM05106362', 'WM05106481', 'WM05106370', 'WM05106371') THEN '904R'
                    WHEN D2.PD_CD = 'WM05106251' THEN '905R'
               END AS BAD_DV_CD    /* 불량구분코드 */
          FROM TB_SVPD_AS_TP_CD D1   /* AS유형코드 */
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D2   /* 상품각사속성상세 */
            ON D2.PD_CD = D1.PD_CD
         WHERE D1.DTA_DL_YN          = 'N'
           AND D1.PD_GRP_CD          = '11'
           AND D1.AS_LCT_CD          = '903G'
           AND D1.AS_PHN_CD          = '903P'
           AND D2.DTA_DL_YN          = 'N'
           AND D2.PD_EXTS_PRP_GRP_CD = 'PART'
           AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN D1.APY_STRTDT AND D1.APY_ENDDT
           AND D1.PD_CD              = #{sdingPdCd1}
           AND D1.SV_TP_CD           = #{svBizHclsfCd}
           AND D1.SV_ANA_HCLSF_CD    = #{svBizDclsfCd}
           AND ROWNUM                = 1
    </select>

    <update id="updateCstSvasIstAsnIz">
        UPDATE TB_SVPD_CST_SVAS_IST_ASN_IZ   /* 고객서비스AS설치배정내역 */
           SET WK_PRGS_STAT_CD   = '20'                                             /* 작업진행상태코드 - 완료 */
             , WK_ACPTE_STAT_CD  = NVL(WK_ACPTE_STAT_CD, 'Y')                       /* 작업수락상태코드 */
             , WK_ACPTE_DT       = NVL(WK_ACPTE_DT, TO_CHAR(SYSDATE, 'YYYYMMDD'))   /* 작업수락일자 */
             , WK_ACPTE_HH       = NVL(WK_ACPTE_HH, TO_CHAR(SYSDATE, 'HH24MISS'))   /* 작업수락시간 */
             , ARV_DT            = NVL(VST_DUEDT, TO_CHAR(SYSDATE, 'YYYYMMDD'))     /* 도착일자 */
             , ARV_HH            = NVL(VST_EXP_HH, TO_CHAR(SYSDATE, 'HH24MISS'))    /* 도착시간 */
             , WK_EXCN_DT        = TO_CHAR(SYSDATE, 'YYYYMMDD')                     /* 작업수행일자 */
             , WK_EXCN_HH        = TO_CHAR(SYSDATE, 'HH24MISS')                     /* 작업수행시간 */
             , WK_PRTNR_OG_TP_CD = #{session.ogTpCd}                                /* 작업파트너조직유형코드 */
             , WK_PRTNR_NO       = #{session.employeeIDNumber}                      /* 작업파트너번호 */
             , SITE_AW_PD_GRP_CD = '11'                                             /* 현장수당상품그룹코드 - 모종 */
             , SITE_AW_SV_TP_CD  = #{svBizHclsfCd}                                  /* 현장수당서비스유형코드 */
             , SITE_AW_ATC_CD    = #{siteAwAtcCd}                                   /* 현장수당항목코드 */
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN     = 'N'
           AND CST_SV_ASN_NO = #{cstSvAsnNo}
    </update>

    <select id="selectPdGrpAtcCdInfo" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaSeedReleaseScheduleAsTpDvo">
        SELECT D2.AS_LCT_CD                   /* AS위치코드 */
             , D2.AS_PHN_CD                   /* AS현상코드 */
             , D2.AS_CAUS_CD                  /* AS원인코드 */
             , D2.SITE_AW_ATC_CD              /* 현장수당항목코드 */
             , CASE WHEN D1.PD_CD IN ('WM05106355', 'WM05106356', 'WM05106364', 'WM05106481', 'WM05106365', 'WM05106346', 'WM05106345') THEN '901R'
                    WHEN D1.PD_CD IN ('WM05106357', 'WM05106358', 'WM05106481', 'WM05106366', 'WM05106367', 'WM05106347', 'WM05106348') THEN '902R'
                    WHEN D1.PD_CD IN ('WM05106359', 'WM05106360', 'WM05106481', 'WM05106368', 'WM05106369', 'WM05106349', 'WM05106350') THEN '903R'
                    WHEN D1.PD_CD IN ('WM05106351', 'WM05106352', 'WM05106361', 'WM05106362', 'WM05106481', 'WM05106370', 'WM05106371') THEN '904R'
                    WHEN D1.PD_CD = 'WM05106251' THEN '905R'
               END             AS BAD_DV_CD   /* 불량구분코드 */
          FROM TB_PDBS_PD_ECOM_PRP_DTL D1   /* 상품각사속성상세 */
          LEFT OUTER JOIN TB_SVPD_AS_TP_CD D2   /* AS유형코드 */
            ON D2.PD_CD           = D1.PD_CD
           AND D2.PD_GRP_CD       = NVL(D1.PD_PRP_VAL20, '11')
           AND D2.DTA_DL_YN       = 'N'
           AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN D2.APY_STRTDT AND D2.APY_ENDDT
           AND D2.SV_TP_CD        = '2'
           AND D2.SV_ANA_HCLSF_CD = #{svBizDclsfCd}
         WHERE D1.DTA_DL_YN          = 'N'
           AND D1.PD_EXTS_PRP_GRP_CD = 'PART'
           AND D1.PD_CD              = #{pdCd}
           AND ROWNUM                = 1
    </select>

    <update id="updateCstSvBfSvcAsnIz">
        UPDATE TB_SVPD_CST_SV_BFSVC_ASN_IZ   /* 고객서비스BS배정내역 */
           SET VST_PRGS_STAT_CD         = '20'                          /* 방문진행상태코드 - 완료 */
             , WK_EXCN_DT               = TO_CHAR(SYSDATE,'YYYYMMDD')   /* 작업수행일자 */
             , CNFM_PSIC_DV_CD          = '2'                           /* 확정담당자구분코드 */
             , CNFM_PSIC_PRTNR_NO       = #{session.employeeIDNumber}   /* 확정담당자파트너번호 */
             , CNFM_PSIC_PRTNR_OG_TP_CD = #{session.ogTpCd}             /* 확정담당자파트너조직유형코드 */
             , SITE_AW_PD_GRP_CD        = '11'                          /* 현재수당상품그룹코드 - 모종 */
             , SITE_AW_SV_TP_CD         = #{svBizHclsfCd}               /* 현장수당서비스유형코드 */
             , SITE_AW_ATC_CD           = #{siteAwAtcCd}                /* 현장수당항목코드 */
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN     = 'N'
           AND CST_SV_ASN_NO = #{cstSvAsnNo}
    </update>

    <insert id="insertCstSvWkRsIz">
        INSERT INTO TB_SVPD_CST_SV_WK_RS_IZ   /* 고객서비스작업결과내역 */
             (
               CST_SV_ASN_NO                  /* 고객서비스배정번호 */
             , CNTR_NO                        /* 계약번호 */
             , CNTR_SN                        /* 계약일련번호 */
             , OG_ID                          /* 조직ID */
             , OG_TP_CD                       /* 조직유형코드 */
             , PRTNR_NO                       /* 파트너번호 */
             , PDCT_PD_CD                     /* 제품상품코드 */
             , SV_BIZ_HCLSF_CD                /* 서비스업무대분류코드 */
             , SV_BIZ_DCLSF_CD                /* 서비스업무세분류코드 */
             , VST_FSH_DT                     /* 방문완료일자 */
             , VST_FSH_HH                     /* 방문완료시간 */
             , REFRI_DV_CD                    /* 유무상구분코드 */
             , WK_PRGS_STAT_CD                /* 작업진행상태코드 */
             , AS_LCT_CD                      /* AS위치코드 */
             , AS_PHN_CD                      /* AS현상코드 */
             , AS_CAUS_CD                     /* AS원인코드 */
             , BAD_DV_CD                      /* 불량구분코드 */
             , SV_PROCS_FOM_CD                /* 서비스처리형태코드 */
             , SV_PROCS_CN                    /* 서비스처리내용 */
             , CRAL_LOCARA_TNO                /* 휴대지역전화번호 */
             , MEXNO_ENCR                     /* 휴대전화국번호암호화 */
             , CRAL_IDV_TNO                   /* 휴대개별전화번호 */
             , URGT_DV_CD                     /* 긴급구분코드 */
             , CLN_YN                         /* 회수여부 */
             , AS_AK_RCP_YN                   /* AS요청접수여부 */
             , INF_CH_AK_YN                   /* 정보변경요청여부 */
             , ETC_CH_AK_YN                   /* 기타변경요청여부 */
             , IST_CTF_MTMS_FW_YN             /* 설치인증MMS발송여부 */
             , SFT_ACDN_YN                    /* 안전사고여부 */
             , PLS_SV_YN                      /* 플러스서비스여부 */
             , PESL_ARTC_DFRN_YN              /* 인적사항상이여부 */
             , TONEP_IST_OPT_YN               /* 더원정수기설치옵션여부 */
             , TONEP_RCVRY_OPT_YN             /* 더원정수기복구옵션여부 */
             , TONEP_FRISU_RCVRY_VT1_USE_YN   /* 더원정수기무상복구1회사용여부 */
             , CST_SIGN_HS_YN                 /* 고객서명본인여부 */
             , DCEVDN_CONF_YN                 /* 증빙서류확인여부 */
             , IST_FIT_YN                     /* 설치적합여부 */
             , DTA_DL_YN                      /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        VALUES
             (
               #{cstSvAsnNo}                  /* 고객서비스배정번호 */
             , #{cntrNo}                      /* 계약번호 */
             , #{cntrSn}                      /* 계약일련번호 */
             , '99992'                        /* 조직ID */
             , #{session.ogTpCd}              /* 조직유형코드 */
             , #{session.employeeIDNumber}    /* 파트너번호 */
             , #{pdctPdCd}                    /* 제품상품코드 */
             , #{svBizHclsfCd}                /* 서비스업무대분류코드 */
             , #{svBizDclsfCd}                /* 서비스업무세분류코드 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 방문완료일자 */
             , TO_CHAR(SYSDATE, 'HH24MISS')   /* 방문완료시간 */
             , #{refriDvCd}                   /* 유무상구분코드 */
             , '20'                           /* 작업진행상태코드 - 완료 */
             , #{asLctCd}                     /* AS위치코드 */
             , #{asPhnCd}                     /* AS현상코드 */
             , #{asCausCd}                    /* AS원인코드 */
             , #{badDvCd}                     /* 불량구분코드 */
             , '906A'                         /* 서비스처리형태코드 */
             , #{svProcsCn}                   /* 서비스처리내용 */
             , #{cstCralLocaraTno}            /* 휴대지역전화번호 */
             , #{cstMexnoEncr}                /* 휴대전화국번호암호화 */
             , #{cstCralIdvTno}               /* 휴대개별전화번호 */
             , '0'                            /* 긴급구분코드 - 정상설치 */
             , 'N'                            /* 회수여부 */
             , 'N'                            /* AS요청접수여부 */
             , 'N'                            /* 정보변경요청여부 */
             , 'N'                            /* 기타변경요청여부 */
             , 'N'                            /* 설치인증MMS발송여부 */
             , 'N'                            /* 안전사고여부 */
             , 'N'                            /* 플러스서비스여부 */
             , 'N'                            /* 인적사항상이여부 */
             , 'N'                            /* 더원정수기설치옵션여부 */
             , 'N'                            /* 더원정수기복구옵션여부 */
             , 'N'                            /* 더원정수기무상복구1회사용여부 */
             , 'N'                            /* 고객서명본인여부 */
             , 'N'                            /* 증빙서류확인여부 */
             , ' '                            /* 설치적합여부 */
             , 'N'                            /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <update id="updateSdingSppPlanIzForPcsv">
        UPDATE TB_SVPD_SDING_SPP_PLAN_IZ   /* 모종배송계획내역 */
           SET WK_DT         = TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 작업일자 */
             , OG_TP_CD      = #{session.ogTpCd}              /* 조직유형코드 */
             , WK_PRTNR_NO   = #{session.employeeIDNumber}    /* 작업파트너번호 */
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN       = 'N'
           AND CNTR_NO         = #{cntrNo}
           AND CNTR_SN         = #{cntrSn}
           AND SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
           AND SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND SDING_SPP_NO    = #{sppOrdNo}
           AND SDING_SPP_SN    = #{sppPlanSn}
    </update>

    <select id="selectSdingSproutInfo" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaSeedReleaseScheduleSproutDvo">
        SELECT D4.CST_SV_ASN_NO                                /* 고객서비스배정번호 */
             , D4.CNTR_NO                                      /* 계약번호 */
             , D4.CNTR_SN                                      /* 계약일련번호 */
             , D4.SV_BIZ_MCLSF_CD                              /* 서비스업무대분류코드 */
             , D4.SV_BIZ_DCLSF_CD                              /* 서비스업무세분류코드 */
             , D4.WK_SN                                        /* 작업일련번호 */
             , D4.VST_DUEDT                                    /* 방문예정일자 */
             , D2.PDCT_PD_CD                   AS PD_CD        /* 상품코드 */
             , NVL(D2.SV_PD_CD, D2.PDCT_PD_CD) AS SV_PD_CD     /* 서비스상품코드 */
             , #{mngrDvCd}                     AS MNGR_DV_CD   /* 관리자구분코드 */
          FROM TB_SSCT_CNTR_REL D1                   /* 계약관계 */
         INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2        /* 고객서비스수행내역 (기기) */
            ON D2.CNTR_NO = D1.OJ_DTL_CNTR_NO
           AND D2.CNTR_SN = D1.OJ_DTL_CNTR_SN
         INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ D3   /* 고객서비스BS배정내역 (모종) */
            ON D3.CST_SV_ASN_NO = #{cstSvAsnNo}
         INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D4    /* 고객서비스BS대상내역 (기기) */
            ON D4.CNTR_NO   = D2.CNTR_NO
           AND D4.CNTR_SN   = D2.CNTR_SN
           AND D4.ASN_OJ_YM = D3.ASN_OJ_YM
         INNER JOIN TB_SSCT_CNTR_DTL D5              /* 계약상세 */
            ON D5.CNTR_NO = D2.CNTR_NO
           AND D5.CNTR_SN = D2.CNTR_SN
         WHERE D1.DTA_DL_YN        = 'N'
           AND D1.CNTR_REL_DTL_CD  = '216'          /* 모종결합 */
           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN D1.VL_STRT_DTM AND D1.VL_END_DTM
           AND D2.DTA_DL_YN        = 'N'
           AND D2.PDCT_PD_CD       = 'WM05100045'   /* 새싹재배기 */
           AND D3.DTA_DL_YN        = 'N'
           AND D4.DTA_DL_YN        = 'N'
           AND D5.DTA_DL_YN        = 'N'
           AND D5.CNTR_DTL_STAT_CD NOT IN ('202', '303')   /* 연체정지, 계약취소 */
           AND D1.BASE_DTL_CNTR_NO = #{cntrNo}
           AND D1.BASE_DTL_CNTR_SN = #{cntrSn}
           AND ROWNUM              = 1
    </select>

     <insert id="insertSvWkOstrIzsForSprout">
        INSERT INTO TB_SVST_SV_WK_OSTR_IZ   /* 서비스작업출고내역 */
             (
               CST_SV_ASN_NO         /* 고객서비스배정번호 */
             , WK_OSTR_SN            /* 작업출고일련번호 */
             , CNTR_NO               /* 계약번호 */
             , CNTR_SN               /* 계약일련번호 */
             , SV_BIZ_HCLSF_CD       /* 서비스업무대분류코드 */
             , SV_BIZ_DCLSF_CD       /* 서비스업무세분류코드 */
             , ITM_PD_CD             /* 품목상품코드 */
             , REFRI_DV_CD           /* 유무상구분코드 */
             , FST_PD_CD             /* 최초상품코드 */
             , FST_SELL_TP_CD        /* 최초판매유형코드 */
             , FST_PD_USWY_CD        /* 최초상품용도코드 */
             , FST_ITM_GD_CD         /* 최초품목등급코드 */
             , FST_VST_FSH_DT        /* 최초방문완료일자 */
             , FNL_PD_CD             /* 최종상품코드 */
             , FNL_SELL_TP_CD        /* 최종판매유형코드 */
             , FNL_PD_USWY_CD        /* 최종상품용도코드 */
             , FNL_ITM_GD_CD         /* 최종품목등급코드 */
             , FNL_VST_FSH_DT        /* 최종방문완료일자 */
             , USE_QTY               /* 사용수량 */
             , CSMR_UPRC_AMT         /* 소비자단가금액 */
             , FRE_EXPN_DC           /* 무료체험일수 */
             , FRE_EXPN_IST_DT       /* 무료체험설치일자 */
             , ITM_BIL_AMT           /* 품목청구금액 */
             , SV_BIL_AMT            /* 서비스청구금액 */
             , MNGR_DV_CD            /* 관리자구분코드 */
             , DGR1_LEVL_OG_ID       /* 1차레벨조직ID */
             , DGR2_LEVL_OG_ID       /* 2차레벨조직ID */
             , BRCH_OG_ID            /* 지점조직ID */
             , ICHR_PRTNR_NO         /* 담당파트너번호 */
             , OG_TP_CD              /* 조직유형코드 */
             , WK_WARE_NO            /* 작업창고번호 */
             , STKR_PRNT_YN          /* 스티커출력여부 */
             , RTNGD_RVPY_PROCS_YN   /* 반품수불처리여부 */
             , RTNGD_CONF_YN         /* 반품확인여부 */
             , REFR_AS_RCP_YN        /* 리퍼AS접수여부 */
             , DTA_DL_YN             /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        SELECT D1.CST_SV_ASN_NO               /* 고객서비스배정번호 */
             , ( SELECT NVL(MAX(WK_OSTR_SN), 0)
                   FROM TB_SVST_SV_WK_OSTR_IZ
                  WHERE CST_SV_ASN_NO = D1.CST_SV_ASN_NO )
               + ROWNUM                       /* 작업출고일련번호 */
             , D1.CNTR_NO                     /* 계약번호 */
             , D1.CNTR_SN                     /* 계약일련번호 */
             , '2'                            /* 서비스업무대분류코드 */
             , D1.SV_BIZ_DCLSF_CD             /* 서비스업무세분류코드 */
             , #{pdCd}                        /* 품목상품코드 - 새싹재배기 */
             , '1'                            /* 유무상구분코드 - 무상 */
             , #{pdCd}                        /* 최초상품코드 - 새싹재배기 */
             , D2.SELL_TP_CD                  /* 최초판매유형코드 */
             , D3.SV_PD_TP_CD                 /* 최초상품용도코드 */
             , NVL(D2.PD_GD_CD, 'A')          /* 최초품목등급코드 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 최초방문완료일자 */
             , #{pdCd}                        /* 최종상품코드 - 새싹재배기 */
             , D2.SELL_TP_CD                  /* 최종판매유형코드 */
             , D3.SV_PD_TP_CD                 /* 최종상품용도코드 */
             , NVL(D2.PD_GD_CD, 'A')          /* 최종품목등급코드 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 최종방문완료일자 */
             , 1                              /* 사용수량 */
             , 0                              /* 소비자단가금액 */
             , 2                              /* 무료체험일수 */
             , TO_CHAR(SYSDATE, 'YYYYMMDD')   /* 무료체험설치일자 */
             , 0                              /* 품목청구금액 */
             , 0                              /* 서비스청구금액 */
             , #{mngrDvCd}                    /* 관리자구분코드 */
             , '71314'                        /* 1차레벨조직ID */
             , '99992'                        /* 2차레벨조직ID */
             , '99992'                        /* 지점조직ID */
             , #{session.employeeIDNumber}    /* 담당파트너번호 */
             , #{session.ogTpCd}              /* 조직유형코드 */
             , '100009'                       /* 작업창고번호 */
             , 'N'                            /* 스티커출력여부 */
             , 'N'                            /* 반품수불처리여부 */
             , 'N'                            /* 반품확인여부 */
             , 'N'                            /* 리퍼AS접수여부 */
             , 'N'                            /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemFieldValue" />
          FROM TB_SVPD_CST_SV_BFSVC_OJ_IZ D1   /* 고객서비스BS대상내역 */
         INNER JOIN TB_SSCT_CNTR_DTL D2        /* 계약상세 */
            ON D2.CNTR_NO = D1.CNTR_NO
           AND D2.CNTR_SN = D1.CNTR_SN
         INNER JOIN TB_PDBS_PD_BAS D3          /* 상품기본 */
            ON D3.PD_CD = #{svPdCd}
         WHERE D1.DTA_DL_YN       = 'N'
           AND D2.DTA_DL_YN       = 'N'
           AND D3.DTA_DL_YN       = 'N'
           AND D1.CST_SV_ASN_NO   = #{cstSvAsnNo}
           AND D1.CNTR_NO         = #{cntrNo}
           AND D1.CNTR_SN         = #{cntrSn}
           AND D1.SV_BIZ_MCLSF_CD = #{svBizMclsfCd}
           AND D1.SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND D1.WK_SN           = #{wkSn}
    </insert>

    <select id="selectSeedReleaseAggregations" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaSeedReleaseScheduleAggDvo">
          WITH TEMP_T AS
             (
               SELECT T1.SV_BIZ_HCLSF_CD      /* 서비스업무대분류코드 */
                    , T1.OG_CD                /* 센터코드 */
                <if test="@MybatisUtils@isNotEmpty(svBizHclsfCd)">
                    , T2.SDING_PKG_CD         /* 모종패키지코드 */
                    , T2.SDING_PKG_CD_NM      /* 모종패키지코드명 */
                </if>
                <if test="@MybatisUtils@isEmpty(svBizHclsfCd)">
                    , T2.SDING_PKG_GRP_CD     /* 모종패키지그룹코드 */
                    , T2.SDING_PKG_APY_WTCF   /* 모종패키지적용가중치 */
                </if>
                    , COUNT(1) AS CNT_SUB     /* 건수 */
                 FROM
                    (
                      SELECT S1.PD_CD                            /* 품목코드 */
                           , S1.SDING_PKG_PD_CD                  /* 모종패키지품목코드 */
                           , S1.SV_BIZ_HCLSF_CD                  /* 서비스업무대분류코드 */
                           , ( SELECT DG_GG_LCT_CD
                                 FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                WHERE DTA_DL_YN = 'N'
                                  AND CNR_OG_CD = S1.OG_CD
                                  AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT
                                  AND ROWNUM    = 1 ) AS OG_CD   /* 센터코드 */
                        FROM
                           (
                        <if test='!@MybatisUtils@equals(svBizHclsfCd, "2") or @MybatisUtils@isEmpty(svBizHclsfCd)'>
                             SELECT D1.SV_BIZ_HCLSF_CD                      /* 서비스업무대분류코드 */
                                  , NVL(D4.OG_CD, D8.OG_CD)    AS OG_CD     /* 조직코드 */
                                  , D2.PD_CD                                /* 상품코드 */
                                  , D1.SDING_PKG_PD_CD                      /* 모종패키지상품코드 */
                                  , D7.OJ_DTL_CNTR_NO                       /* 기기계약번호 */
                                  , ( SELECT REQD_DT
                                        FROM TB_SVPD_CST_SV_EXCN_IZ   /* 고객서비스수행내역 */
                                       WHERE CNTR_NO   = D7.OJ_DTL_CNTR_NO
                                         AND CNTR_SN   = D7.OJ_DTL_CNTR_SN
                                         AND DTA_DL_YN = 'N' ) AS REQD_DT   /* 철거일자 */
                               FROM TB_SVPD_SDING_SPP_PLAN_IZ D1            /* 모종배송계획내역 */
                              INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ D2      /* 고객서비스AS설치대상내역 */
                                 ON D2.CNTR_NO         = D1.CNTR_NO
                                AND D2.CNTR_SN         = D1.CNTR_SN
                                AND D2.SV_BIZ_HCLSF_CD = D1.SV_BIZ_HCLSF_CD
                                AND D2.SV_BIZ_DCLSF_CD = D1.SV_BIZ_DCLSF_CD
                                AND D2.CST_SV_ASN_NO   = D1.SDING_SPP_NO
                              INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ D3     /* 고객서비스AS설치배정내역 */
                                 ON D3.CST_SV_ASN_NO = D2.CST_SV_ASN_NO
                               LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ D4             /* 월파트너내역 */
                                 ON D4.OG_TP_CD  = D3.ICHR_OG_TP_CD
                                AND D4.PRTNR_NO  = D3.ICHR_PRTNR_NO
                                AND D4.DTA_DL_YN = 'N'
                                AND D4.BASE_YM   = SUBSTR(#{strtDt}, 1, 6)
                              INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D5         /* 고객서비스수행내역 */
                                 ON D5.CNTR_NO = D2.CNTR_NO
                                AND D5.CNTR_SN = D2.CNTR_SN
                              INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D6        /* 상품각사속성상세 */
                                 ON D6.PD_CD = D2.PD_CD
                              INNER JOIN TB_SSCT_CNTR_REL D7               /* 계약관계-(모종패키지 계약과 결합된) 웰스팜계약 */
                                 ON D7.BASE_DTL_CNTR_NO = D1.CNTR_NO
                                AND D7.BASE_DTL_CNTR_SN = D1.CNTR_SN
                               LEFT OUTER JOIN TB_OGBS_PRTNR_BAS D8        /* 파트너기본 */
                                 ON D8.OG_TP_CD  = D3.ICHR_OG_TP_CD
                                AND D8.PRTNR_NO  = D3.ICHR_PRTNR_NO
                                AND D8.DTA_DL_YN = 'N'
                              WHERE D1.DTA_DL_YN          = 'N'
                                AND D2.DTA_DL_YN          = 'N'
                                AND D3.DTA_DL_YN          = 'N'
                                AND D3.WK_PRGS_STAT_CD   IN ('00', '10', '20')   /* 작업대기, 진행중, 완료 */
                                AND D5.DTA_DL_YN          = 'N'
                                AND D5.CNTR_DTL_STAT_CD  IN ('101', '201', '202', '203')   /* 정상, 고객요청정지, 연체정지, 해약접수정지 */
                                AND D6.DTA_DL_YN          = 'N'
                                AND D6.PD_EXTS_PRP_GRP_CD = 'PART'
                                AND D7.DTA_DL_YN          = 'N'
                                AND D7.CNTR_REL_DTL_CD    = '216'   /* 모종결합(웰스팜+모종) */
                                AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN D7.VL_STRT_DTM AND D7.VL_END_DTM
                                AND D1.CAN_DT IS NULL
                                AND D5.REQD_DT IS NULL
                                AND D6.PD_PRP_VAL20       = '11'         /* 모종 */
                                AND D6.PD_PRP_VAL19      IN ('3', '4')   /* 모종, 상품 */
                            <if test="@MybatisUtils@isNotEmpty(svBizHclsfCd)">
                                AND D1.SV_BIZ_HCLSF_CD    = #{svBizHclsfCd}
                            </if>
                            <choose>
                            <when test='@MybatisUtils@equals(dtTpCd, "1")'>
                                AND D2.RCPDT BETWEEN #{strtDt} AND #{endDt}         /* 접수일자 */
                            </when>
                            <when test='@MybatisUtils@equals(dtTpCd, "2")'>
                                AND D3.VST_CNFMDT BETWEEN #{strtDt} AND #{endDt}    /* 방문일자 */
                            </when>
                            <when test='@MybatisUtils@equals(dtTpCd, "3")'>
                                AND D1.OSTR_CNFMDT BETWEEN #{strtDt} AND #{endDt}   /* 확정일자 */
                            </when>
                            <when test='@MybatisUtils@equals(dtTpCd, "4")'>
                                AND (
                                         (     ( SELECT SPP_DV_CD
                                                   FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                  WHERE CNR_OG_CD = NVL(D4.OG_CD, D8.OG_CD)
                                                    AND DTA_DL_YN = 'N'
                                                    AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                    AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ) = '1'
                                           AND D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD') AND TO_CHAR( TO_DATE(#{strtDt}, 'YYYYMMDD') + ( SELECT SPP_PRD
                                                                                                                                                                               FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                                                                                                                                              WHERE CNR_OG_CD = NVL(D4.OG_CD, D8.OG_CD)
                                                                                                                                                                                AND DTA_DL_YN = 'N'
                                                                                                                                                                                AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                                                                                                                                                AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ), 'YYYYMMDD')
                                         )
                                      OR
                                         (     ( SELECT SPP_DV_CD
                                                   FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                  WHERE CNR_OG_CD = NVL(D4.OG_CD, D8.OG_CD)
                                                    AND DTA_DL_YN = 'N'
                                                    AND DOW_DV_CD IN ('1', '2', '3', '4')
                                                    AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                    AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ) = '2'
                                                    AND D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 2, 'YYYYMMDD') AND TO_CHAR( TO_DATE(#{strtDt}, 'YYYYMMDD') + ( SELECT SPP_PRD
                                                                                                                                                                                        FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                                                                                                                                                       WHERE CNR_OG_CD = NVL(D4.OG_CD, D8.OG_CD)
                                                                                                                                                                                         AND DTA_DL_YN = 'N'
                                                                                                                                                                                         AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                                                                                                                                                         AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ), 'YYYYMMDD')
                                         )
                                    )
                            </when>
                            </choose>
                            <if test="@MybatisUtils@isNotEmpty(refriDivCd)">
                                AND D1.REFRI_DV_CD    = #{refriDivCd}
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(sppDvCd)">
                                AND D1.ITM_IOST_DV_CD = #{sppDvCd}
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(fshProcsCd)">
                            <choose>
                            <when test='!@MybatisUtils@equals(fshProcsCd, "20")'>
                                AND D3.WK_PRGS_STAT_CD IN ('00', '10')   /* 작업대기, 진행중 */
                            </when>
                            <otherwise>
                                AND D3.WK_PRGS_STAT_CD = #{fshProcsCd}
                            </otherwise>
                            </choose>
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(pkgDvCd)">
                                AND EXISTS ( SELECT 1
                                               FROM TB_PDBS_PD_REL S1
                                              INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S2
                                                 ON S2.PD_CD = S1.BASE_PD_CD
                                              WHERE S1.DTA_DL_YN          = 'N'
                                                AND S1.PD_REL_TP_CD       = '18'   /* 정기배송 */
                                                AND S2.DTA_DL_YN          = 'N'
                                                AND S2.PD_EXTS_PRP_GRP_CD = 'SPP'
                                                AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN S1.VL_STRT_DTM AND S1.VL_END_DTM
                                                AND S1.OJ_PD_CD           = D2.PD_CD
                                                AND S2.PD_PRP_VAL12       = #{pkgDvCd} )
                            </if>
                            <if test='@MybatisUtils@equals(ostrYn, "Y")'>
                                AND D1.OSTR_CNFMDT IS NOT NULL
                            </if>
                            <if test='@MybatisUtils@equals(ostrYn, "N")'>
                                AND D1.OSTR_CNFMDT IS NULL
                            </if>
                        </if>
                        <if test="@MybatisUtils@isEmpty(svBizHclsfCd)">
                              UNION ALL
                        </if>
                        <if test='@MybatisUtils@equals(svBizHclsfCd, "2") or @MybatisUtils@isEmpty(svBizHclsfCd)'>
                             SELECT D1.SV_BIZ_HCLSF_CD                      /* 서비스업무대분류코드 */
                                  , NVL(D4.OG_CD, D8.OG_CD)    AS OG_CD     /* 조직코드 */
                                  , D2.PDCT_PD_CD              AS PD_CD     /* 상품코드 */
                                  , D1.SDING_PKG_PD_CD                      /* 모종패키지상품코드 */
                                  , D7.OJ_DTL_CNTR_NO                       /* 기기계약번호 */
                                  , ( SELECT REQD_DT
                                        FROM TB_SVPD_CST_SV_EXCN_IZ   /* 고객서비스수행내역 */
                                       WHERE CNTR_NO   = D7.OJ_DTL_CNTR_NO
                                         AND CNTR_SN   = D7.OJ_DTL_CNTR_SN
                                         AND DTA_DL_YN = 'N' ) AS REQD_DT   /* 철거일자 */
                               FROM TB_SVPD_SDING_SPP_PLAN_IZ D1            /* 모종배송계획내역 */
                              INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D2      /* 고객서비스BS대상내역 */
                                 ON D2.CNTR_NO         = D1.CNTR_NO
                                AND D2.CNTR_SN         = D1.CNTR_SN
                                AND D2.SV_BIZ_DCLSF_CD = D1.SV_BIZ_DCLSF_CD
                                AND D2.CST_SV_ASN_NO   = D1.SDING_SPP_NO
                              INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ D3     /* 고객서비스BS배정내역 */
                                 ON D3.CST_SV_ASN_NO = D2.CST_SV_ASN_NO
                                AND D3.ASN_OJ_YM     = D2.ASN_OJ_YM
                               LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ D4       /* 월파트너내역 */
                                 ON D4.OG_TP_CD  = D3.CNFM_PSIC_PRTNR_OG_TP_CD
                                AND D4.PRTNR_NO  = D3.CNFM_PSIC_PRTNR_NO
                                AND D4.DTA_DL_YN = 'N'
                                AND D4.BASE_YM   = SUBSTR(#{strtDt}, 1, 6)
                              INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D5          /* 고객서비스수행내역 */
                                 ON D5.CNTR_NO = D2.CNTR_NO
                                AND D5.CNTR_SN = D2.CNTR_SN
                              INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D6         /* 상품각사속성상세 */
                                 ON D6.PD_CD = D2.PDCT_PD_CD
                              INNER JOIN TB_SSCT_CNTR_REL D7                /* 계약관계-(모종패키지 계약과 결합된) 웰스팜계약 */
                                 ON D7.BASE_DTL_CNTR_NO = D1.CNTR_NO
                                AND D7.BASE_DTL_CNTR_SN = D1.CNTR_SN
                               LEFT OUTER JOIN TB_OGBS_PRTNR_BAS D8         /* 파트너기본 */
                                 ON D8.OG_TP_CD  = D3.CNFM_PSIC_PRTNR_OG_TP_CD
                                AND D8.PRTNR_NO  = D3.CNFM_PSIC_PRTNR_NO
                                AND D8.DTA_DL_YN = 'N'
                              WHERE D1.DTA_DL_YN          = 'N'
                                AND D1.SV_BIZ_HCLSF_CD    = '2'
                                AND D2.DTA_DL_YN          = 'N'
                                AND D3.DTA_DL_YN          = 'N'
                                AND D3.VST_PRGS_STAT_CD  IN ('00', '10', '20')   /* 작업대기, 진행중, 완료 */
                                AND D5.DTA_DL_YN          = 'N'
                                AND D5.CNTR_DTL_STAT_CD   = '101'   /* 정상 */
                                AND D6.DTA_DL_YN          = 'N'
                                AND D6.PD_EXTS_PRP_GRP_CD = 'PART'
                                AND D7.DTA_DL_YN          = 'N'
                                AND D7.CNTR_REL_DTL_CD    = '216'   /* 모종결합(웰스팜+모종) */
                                AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN D7.VL_STRT_DTM AND D7.VL_END_DTM
                                AND D1.CAN_DT IS NULL
                                AND D5.REQD_DT IS NULL
                                AND D6.PD_PRP_VAL20       = '11'         /* 모종 */
                                AND D6.PD_PRP_VAL19      IN ('3', '4')   /* 모종, 상품 */
                            <if test="@MybatisUtils@isNotEmpty(svBizHclsfCd)">
                                AND D1.SV_BIZ_HCLSF_CD    = #{svBizHclsfCd}
                            </if>
                            <choose>
                            <when test='@MybatisUtils@equals(dtTpCd, "1")'>
                                AND D2.FST_RGST_DTM BETWEEN #{strtDt} || '000000' AND #{endDt} || '235959'   /* 접수일자 */
                            </when>
                            <when test='@MybatisUtils@equals(dtTpCd, "2")'>
                                AND D3.VST_CNFMDT BETWEEN #{strtDt} AND #{endDt}                             /* 방문일자 */
                            </when>
                            <when test='@MybatisUtils@equals(dtTpCd, "3")'>
                                AND D1.OSTR_CNFMDT BETWEEN #{strtDt} AND #{endDt}                            /* 확정일자 */
                            </when>
                            <when test='@MybatisUtils@equals(dtTpCd, "4")'>
                                AND (
                                         (     ( SELECT SPP_DV_CD
                                                   FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                  WHERE CNR_OG_CD = NVL(D4.OG_CD, D8.OG_CD)
                                                    AND DTA_DL_YN = 'N'
                                                    AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                    AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ) = '1'
                                           AND D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD') AND TO_CHAR( TO_DATE(#{strtDt}, 'YYYYMMDD') + ( SELECT SPP_PRD
                                                                                                                                                                               FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                                                                                                                                              WHERE CNR_OG_CD = NVL(D4.OG_CD, D8.OG_CD)
                                                                                                                                                                                AND DTA_DL_YN = 'N'
                                                                                                                                                                                AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                                                                                                                                                AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ), 'YYYYMMDD')
                                         )
                                      OR
                                         (     ( SELECT SPP_DV_CD
                                                   FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                  WHERE CNR_OG_CD = NVL(D4.OG_CD, D8.OG_CD)
                                                    AND DTA_DL_YN = 'N'
                                                    AND DOW_DV_CD IN ('1', '2', '3', '4')
                                                    AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                    AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ) = '2'
                                                    AND D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 2, 'YYYYMMDD') AND TO_CHAR( TO_DATE(#{strtDt}, 'YYYYMMDD') + ( SELECT SPP_PRD
                                                                                                                                                                                        FROM TB_SVPD_SDING_CNR_SPP_DOW_IZ
                                                                                                                                                                                       WHERE CNR_OG_CD = NVL(D4.OG_CD, D8.OG_CD)
                                                                                                                                                                                         AND DTA_DL_YN = 'N'
                                                                                                                                                                                         AND DOW_DV_CD = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD'), 'D') - 1
                                                                                                                                                                                         AND #{strtDt} BETWEEN APY_STRTDT AND APY_ENDDT ), 'YYYYMMDD')
                                         )
                                    )
                            </when>
                            </choose>
                            <if test="@MybatisUtils@isNotEmpty(refriDivCd)">
                                AND D1.REFRI_DV_CD    = #{refriDivCd}
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(sppDvCd)">
                                AND D1.ITM_IOST_DV_CD = #{sppDvCd}
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(fshProcsCd)">
                            <choose>
                            <when test='!@MybatisUtils@equals(fshProcsCd, "20")'>
                                AND D3.VST_PRGS_STAT_CD IN ('00', '10')   /* 작업대기, 진행중 */
                            </when>
                            <otherwise>
                                AND D3.VST_PRGS_STAT_CD = #{fshProcsCd}
                            </otherwise>
                            </choose>
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(pkgDvCd)">
                                AND EXISTS ( SELECT 1
                                               FROM TB_PDBS_PD_REL S1
                                              INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S2
                                                 ON S2.PD_CD = S1.BASE_PD_CD
                                              WHERE S1.DTA_DL_YN          = 'N'
                                                AND S1.PD_REL_TP_CD       = '18'   /* 정기배송 */
                                                AND S2.DTA_DL_YN          = 'N'
                                                AND S2.PD_EXTS_PRP_GRP_CD = 'SPP'
                                                AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN S1.VL_STRT_DTM AND S1.VL_END_DTM
                                                AND S1.OJ_PD_CD           = D2.PDCT_PD_CD
                                                AND S2.PD_PRP_VAL12       = #{pkgDvCd} )
                            </if>
                            <if test='@MybatisUtils@equals(ostrYn, "Y")'>
                                AND D1.OSTR_CNFMDT IS NOT NULL
                            </if>
                            <if test='@MybatisUtils@equals(ostrYn, "N")'>
                                AND D1.OSTR_CNFMDT IS NULL
                            </if>
                        </if>
                           ) S1
                       WHERE S1.REQD_DT IS NULL
                         AND S1.OJ_DTL_CNTR_NO IS NOT NULL
                    ) T1
                INNER JOIN
                    (
                      SELECT SDING_PKG_CD          /* 모종패키지코드 */
                           , SDING_PKG_CD_NM       /* 모종패키지코드명 */
                           , SDING_PKG_APY_WTCF    /* 모종패키지적용가중치 */
                           , SDING_PKG_GRP_CD      /* 모종패키지그룹코드 */
                           , SDING_PKG_GRP_CD_NM   /* 모종패키지그룹코드명 */
                           , SDING_PD_CD           /* 모종상품코드 */
                    <if test="@MybatisUtils@isNotEmpty(svBizHclsfCd)">
                           , ROW_NUMBER() OVER(PARTITION BY SDING_PKG_CD, SDING_PD_CD ORDER BY SDING_PKG_CD) AS RN
                    </if>
                    <if test="@MybatisUtils@isEmpty(svBizHclsfCd)">
                           , ROW_NUMBER() OVER(PARTITION BY SDING_PKG_CD, SDING_PD_CD, SDING_PKG_GRP_CD, SDING_PKG_APY_WTCF
                                                   ORDER BY SDING_PKG_CD) AS RN
                    </if>
                        FROM TB_SVPD_SDING_PKG_ITM_IZ   /* 모종패키지품목내역 */
                       WHERE DTA_DL_YN = 'N'
                    ) T2
                   ON T2.SDING_PD_CD = NVL(T1.PD_CD, T1.SDING_PKG_PD_CD)
                WHERE T2.RN = 1
            <if test="@MybatisUtils@isNotEmpty(svBizHclsfCd)">
                GROUP BY T1.SV_BIZ_HCLSF_CD, T1.OG_CD, T2.SDING_PKG_CD, T2.SDING_PKG_CD_NM
            </if>
            <if test="@MybatisUtils@isEmpty(svBizHclsfCd)">
                GROUP BY T1.SV_BIZ_HCLSF_CD, T1.OG_CD, T2.SDING_PKG_GRP_CD, T2.SDING_PKG_APY_WTCF
            </if>
             )
    <if test="@MybatisUtils@isEmpty(svBizHclsfCd)">
             , T_A AS
             (
               SELECT T2.DG_GG_LCT_CD                       /* 센터코드 */
                    , T1.SDING_PKG_GRP_CD                   /* 모종패키지그룹코드 */
                    , T1.SDING_PKG_APY_WTCF                 /* 모종패키지적용가중치 */
                    , '2'              AS SV_BIZ_HCLSF_CD   /* 서비스업무대분류코드 */
                    , SUM(T2.EXCD_QTY) AS EXCD_QTY          /* 제외수량 */
                    , SUM(T2.SPMT_QTY) AS SPMT_QTY          /* 추가수량 */
                 FROM
                    (
                      SELECT SDING_PKG_CD          /* 모종패키지코드 */
                           , SDING_PKG_CD_NM       /* 모종패키지코드명 */
                           , SDING_PKG_APY_WTCF    /* 모종패키지적용가중치 */
                           , SDING_PKG_GRP_CD      /* 모종패키지그룹코드 */
                           , SDING_PKG_GRP_CD_NM   /* 모종패키지그룹코드명 */
                           , SDING_PD_CD           /* 모종상품코드 */
                           , ROW_NUMBER() OVER(PARTITION BY SDING_PKG_CD, SDING_PKG_GRP_CD, SDING_PKG_APY_WTCF ORDER BY SDING_PKG_CD) AS RN
                        FROM TB_SVPD_SDING_PKG_ITM_IZ   /* 모종패키지품목내역 */
                       WHERE DTA_DL_YN = 'N'
                    ) T1
                INNER JOIN
                    (
                      SELECT S1.DEPT             AS DG_GG_LCT_CD
                           , S1.GDS              AS SDING_PKG_CD
                           , NVL(S2.EXCD_QTY, 0) AS EXCD_QTY
                           , NVL(S2.SPMT_QTY, 0) AS SPMT_QTY
                        FROM
                           (
                             SELECT TEMP_DEPT.DEPT
                                  , TEMP_GDS.GDS
                               FROM
                                  (
                                    SELECT CD_VLD_VAL AS GDS
                                      FROM T_CMZ_CD_D
                                     WHERE DEL_YN    = 'N'
                                       AND TENANT_ID = 'TNT_WELLS'
                                       AND CD_ID     = 'SDING_PKG_CD'
                                  ) TEMP_GDS
                              INNER JOIN
                                  (
                                    SELECT CD_VLD_VAL AS DEPT
                                      FROM T_CMZ_CD_D
                                     WHERE DEL_YN    = 'N'
                                       AND TENANT_ID = 'TNT_WELLS'
                                       AND CD_ID     = 'GG_LCT_CD'
                                     UNION ALL
                                    SELECT '17'       AS DEPT   /* 택배 */
                                      FROM DUAL
                                  ) TEMP_DEPT
                                 ON 1 = 1
                           ) S1
                        LEFT OUTER JOIN
                           (
                             SELECT DG_GG_LCT_CD   /* 대표집하위치코드 */
                                  , SDING_PKG_CD   /* 모종패키지코드 */
                                  , OSTR_DUEDT     /* 출고예정일자 */
                                  , EXCD_QTY       /* 제외수량 */
                                  , SPMT_QTY       /* 추가수량 */
                               FROM TB_SVPD_SDING_PKG_QTY_CTR_IZ   /* 모종패키지수량조정내역 */
                              WHERE DTA_DL_YN  = 'N'
                                AND OSTR_DUEDT = #{strtDt}
                           ) S2
                          ON S2.DG_GG_LCT_CD = S1.DEPT
                         AND S2.SDING_PKG_CD = S1.GDS
                    ) T2
                   ON T2.SDING_PKG_CD = T1.SDING_PKG_CD
                WHERE T1.RN = 1
                GROUP BY T2.DG_GG_LCT_CD, T1.SDING_PKG_GRP_CD, T1.SDING_PKG_APY_WTCF
             )
        SELECT T.DEPT                                                                          /* 센터코드 */
             , T.DEPT_NM                                                                       /* 센터명 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK01' THEN T.CNT END), 0) AS PAK01     /* 샐러드 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK02' THEN T.CNT END), 0) AS PAK02     /* 채소식단 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK03' THEN T.CNT END), 0) AS PAK03     /* 건강밥상 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK04' THEN T.CNT END), 0) AS PAK04     /* 항암건강 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK05' THEN T.CNT END), 0) AS PAK05     /* 숙면힐링 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK13' THEN T.CNT END), 0) AS PAK13     /* 이유식 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK23' THEN T.CNT END), 0) AS PAK23     /* 미니 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK50' THEN T.CNT END), 0) AS PAK50     /* 아이쑥쑥유엔젤 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK24' THEN T.CNT END), 0) AS PAK24     /* 선택모종 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK08' THEN T.CNT END), 0) AS PAK08     /* 버터헤드 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK09' THEN T.CNT END), 0) AS PAK09     /* 케일 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK12' THEN T.CNT END), 0) AS PAK12     /* 비타민다채 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK51' THEN T.CNT END), 0) AS PAK51     /* 먹치마 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK52' THEN T.CNT END), 0) AS PAK52     /* 여름청치마 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK53' THEN T.CNT END), 0) AS PAK53     /* 청경채 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK54' THEN T.CNT END), 0) AS PAK54     /* 먹치마+여름청치마 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK55' THEN T.CNT END), 0) AS PAK55     /* 먹치마+청경채 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK56' THEN T.CNT END), 0) AS PAK56     /* 먹치마+적소렐 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK57' THEN T.CNT END), 0) AS PAK57     /* 여름청치마+청경채 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK58' THEN T.CNT END), 0) AS PAK58     /* 여름청치마+적소렐 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK61' THEN T.CNT END), 0) AS PAK61     /* 설치_자유WIDE */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK62' THEN T.CNT END), 0) AS PAK62     /* BS/AS_자유WIDE */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK63' THEN T.CNT END), 0) AS PAK63     /* 설치_자유SLIM */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK64' THEN T.CNT END), 0) AS PAK64     /* BS/AS_자유SLIM */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK28' THEN T.CNT END), 0) AS PAK28     /* 유러피안 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK29' THEN T.CNT END), 0) AS PAK29     /* 우리가족 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK30' THEN T.CNT END), 0) AS PAK30     /* 모둠쌈 */
             , NVL(SUM(CASE WHEN T.SDING_PKG_GRP_CD = 'PAK31' THEN T.CNT END), 0) AS PAK31     /* 기능성채소 */
             , NVL(SUM(T.CNT), 0)                                                 AS TOT_SUM   /* 소계 */
          FROM
             (
               SELECT T1.DEPT
                    , T1.DEPT_NM
                    , CASE WHEN T2.SDING_PKG_GRP_CD = 'PAK59'
                            AND T2.SV_BIZ_HCLSF_CD = '1'         THEN 'PAK61'
                           WHEN T2.SDING_PKG_GRP_CD = 'PAK59'
                            AND T2.SV_BIZ_HCLSF_CD IN ('2', '3') THEN 'PAK62'
                           WHEN T2.SDING_PKG_GRP_CD = 'PAK60'
                            AND T2.SV_BIZ_HCLSF_CD = '1'         THEN 'PAK63'
                           WHEN T2.SDING_PKG_GRP_CD = 'PAK60'
                            AND T2.SV_BIZ_HCLSF_CD IN ('2', '3') THEN 'PAK64'
                           ELSE SDING_PKG_GRP_CD
                      END AS SDING_PKG_GRP_CD
                    , NVL(SUM(T2.CNT_TOTAL), 0) AS CNT
                 FROM
                    (
                      SELECT CD_VLD_VAL AS DEPT
                           , CD_CNTN    AS DEPT_NM
                        FROM T_CMZ_CD_D
                       WHERE DEL_YN    = 'N'
                         AND TENANT_ID = 'TNT_WELLS'
                         AND CD_ID     = 'GG_LCT_CD'
                       UNION ALL
                      SELECT '17'       AS DEPT   /* 택배 */
                           , MLNG_CNTN  AS DEPT_NM
                        FROM T_CMZ_MLNG_D
                       WHERE TENANT_ID = 'TNT_BASE'
                         AND MLNG_ID   = 'MSG_TXT_PCSV'
                         AND LNG_ID    = #{session.langId}
                    ) T1
                 LEFT OUTER JOIN
                    (
                      SELECT SDING_PKG_GRP_CD
                           , SV_BIZ_HCLSF_CD
                           , OG_CD  AS DG_GG_LCT_CD
                           , SUM( NVL(CNT_SUB, 0) * NVL(SDING_PKG_APY_WTCF, 0) ) AS CNT_TOTAL
                        FROM TEMP_T
                    <where>
                    <if test='@MybatisUtils@equals(dtTpCd, "3")'>
                         AND SV_BIZ_HCLSF_CD IN ('1', '3')
                    </if>
                    </where>
                       GROUP BY SDING_PKG_GRP_CD, SV_BIZ_HCLSF_CD, OG_CD
                    <if test='@MybatisUtils@equals(dtTpCd, "3")'>
                       UNION ALL
                      SELECT D1.SDING_PKG_GRP_CD
                           , D1.SV_BIZ_HCLSF_CD
                           , D1.DG_GG_LCT_CD
                           , SUM( NVL(D2.CNT_SUB, 0) * NVL(D2.SDING_PKG_APY_WTCF, 0) )
                             + SUM( D1.SPMT_QTY * NVL(D1.SDING_PKG_APY_WTCF, 0) )
                             - SUM( D1.EXCD_QTY * NVL(D1.SDING_PKG_APY_WTCF, 0) ) AS CNT_TOTAL
                        FROM T_A D1
                        LEFT OUTER JOIN TEMP_T D2
                          ON D2.OG_CD              = D1.DG_GG_LCT_CD
                         AND D2.SDING_PKG_GRP_CD   = D1.SDING_PKG_GRP_CD
                         AND D2.SDING_PKG_APY_WTCF = D1.SDING_PKG_APY_WTCF
                         AND D2.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                       GROUP BY D1.SDING_PKG_GRP_CD, D1.SV_BIZ_HCLSF_CD, D1.DG_GG_LCT_CD
                    </if>
                    ) T2
                   ON T2.DG_GG_LCT_CD = T1.DEPT
                GROUP BY T1.DEPT, T1.DEPT_NM
                    , CASE WHEN T2.SDING_PKG_GRP_CD = 'PAK59'
                            AND T2.SV_BIZ_HCLSF_CD = '1'         THEN 'PAK61'
                           WHEN T2.SDING_PKG_GRP_CD = 'PAK59'
                            AND T2.SV_BIZ_HCLSF_CD IN ('2', '3') THEN 'PAK62'
                           WHEN T2.SDING_PKG_GRP_CD = 'PAK60'
                            AND T2.SV_BIZ_HCLSF_CD = '1'         THEN 'PAK63'
                           WHEN T2.SDING_PKG_GRP_CD = 'PAK60'
                            AND T2.SV_BIZ_HCLSF_CD IN ('2', '3') THEN 'PAK64'
                           ELSE SDING_PKG_GRP_CD
                      END
                ORDER BY T1.DEPT, SDING_PKG_GRP_CD
             ) T
         GROUP BY T.DEPT, T.DEPT_NM
         ORDER BY T.DEPT
    </if>
    <if test="@MybatisUtils@isNotEmpty(svBizHclsfCd)">
             , TEMP_PCK_INFO AS
             (
               SELECT T.SDING_PKG_CD
                    , T.SDING_PKG_CD_NM
                    , T.SDING_PKG_APY_WTCF
                    , T.SDING_PKG_GRP_CD
                    , T.SDING_PKG_GRP_CD_NM
                    , T.SDING_PD_CD
                 FROM
                    (
                      SELECT SDING_PKG_CD          /* 모종패키지코드 */
                           , SDING_PKG_CD_NM       /* 모종패키지코드명 */
                           , SDING_PKG_APY_WTCF    /* 모종패키지적용가중치 */
                           , SDING_PKG_GRP_CD      /* 모종패키지그룹코드 */
                           , SDING_PKG_GRP_CD_NM   /* 모종패키지그룹코드명 */
                           , SDING_PD_CD           /* 모종상품코드 */
                           , ROW_NUMBER() OVER(PARTITION BY SDING_PKG_CD ORDER BY SDING_PKG_CD) AS RN
                        FROM TB_SVPD_SDING_PKG_ITM_IZ   /* 모종패키지품목내역 */
                       WHERE DTA_DL_YN = 'N'
                    ) T
                WHERE T.RN = 1
             )
        SELECT T.DEPT                                                                                      /* 센터코드 */
             , T.DEPT_NM                                                                                   /* 센터명 */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK01001' THEN T.CNT END), 0)                AS PAK01001         /* 건강샐러드/주스SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK01002' THEN T.CNT END), 0)                AS PAK01002         /* 건강샐러드/주스WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK02001' THEN T.CNT END), 0)                AS PAK02001         /* 우리아이채소식단SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK02002' THEN T.CNT END), 0)                AS PAK02002         /* 우리아이채소식단WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK03001' THEN T.CNT END), 0)                AS PAK03001         /* 건강밥상SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK03002' THEN T.CNT END), 0)                AS PAK03002         /* 건강밥상WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK04001' THEN T.CNT END), 0)                AS PAK04001         /* 항암건강SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK04002' THEN T.CNT END), 0)                AS PAK04002         /* 항암건강WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK05001' THEN T.CNT END), 0)                AS PAK05001         /* 숙면힐링SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK05002' THEN T.CNT END), 0)                AS PAK05002         /* 숙면힐링WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK13001' THEN T.CNT END), 0)                AS PAK13001         /* 우리아이신선이유식SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK13002' THEN T.CNT END), 0)                AS PAK13002         /* 우리아이신선이유식WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK08003' THEN T.CNT END), 0)                AS PAK08003         /* 버터헤드SLIME */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK08004' THEN T.CNT END), 0)                AS PAK08004         /* 버터헤드WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK09003' THEN T.CNT END), 0)                AS PAK09003         /* 케일SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK09004' THEN T.CNT END), 0)                AS PAK09004         /* 케일WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK12003' THEN T.CNT END), 0)                AS PAK12003         /* 비타민다채SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK12004' THEN T.CNT END), 0)                AS PAK12004         /* 비타민다채WIDE */
             , NVL(SUM(CASE WHEN T.GDS IN ('PAK08002', 'PAK09001') THEN T.CNT END), 0) AS PAK08002         /* 버터헤드+케일WIDE */
             , NVL(SUM(CASE WHEN T.GDS IN ('PAK08001', 'PAK12001') THEN T.CNT END), 0) AS PAK08001         /* 버터헤드+비타민다채WIDE */
             , NVL(SUM(CASE WHEN T.GDS IN ('PAK09002', 'PAK12002') THEN T.CNT END), 0) AS PAK09002         /* 케일+비타민다채WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK23001' THEN T.CNT END), 0)                AS PAK23001         /* 웰스팜미니채소 */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK50001' THEN T.CNT END), 0)                AS PAK50001         /* 아이쑥쑥유엔젤WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK24001' THEN T.CNT END), 0)                AS PAK24001         /* 선택모종 */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK51001' THEN T.CNT END), 0)                AS PAK51001         /* 먹치마_미니 */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK52001' THEN T.CNT END), 0)                AS PAK52001         /* 여름청치마_미니 */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK53001' THEN T.CNT END), 0)                AS PAK53001         /* 청경채_미니 */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK54001' THEN T.CNT END), 0)                AS PAK54001         /* 먹치마+여름청치마_미니 */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK55001' THEN T.CNT END), 0)                AS PAK55001         /* 먹치마+청경채_미니 */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK56001' THEN T.CNT END), 0)                AS PAK56001         /* 먹치마+적소렐_미니 */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK57001' THEN T.CNT END), 0)                AS PAK57001         /* 여름청치마+청경채_미니 */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK58001' THEN T.CNT END), 0)                AS PAK58001         /* 여름청치마+적소렐_미니 */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK59001' THEN T.CNT END), 0)                AS PAK59001         /* 선택모종WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK60001' THEN T.CNT END), 0)                AS PAK60001         /* 선택모종SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK28001' THEN T.CNT END), 0)                AS PAK28001         /* 유러피안샐러드SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK28002' THEN T.CNT END), 0)                AS PAK28002         /* 유러피안샐러드WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK29001' THEN T.CNT END), 0)                AS PAK29001         /* 우리가족건강채소SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK29002' THEN T.CNT END), 0)                AS PAK29002         /* 우리가족건강채소WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK30002' THEN T.CNT END), 0)                AS PAK30002         /* 모둠쌈채소WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK30001' THEN T.CNT END), 0)                AS PAK30001         /* 모둠쌈채소SLIM */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK31002' THEN T.CNT END), 0)                AS PAK31002         /* 기능성채소WIDE */
             , NVL(SUM(CASE WHEN T.GDS = 'PAK31001' THEN T.CNT END), 0)                AS PAK31001         /* 기능성채소SLIM */
          FROM
             (
               SELECT T1.DEPT
                    , T1.DEPT_NM
                    , T1.GDS
                    , NVL(T2.CNT_BY_DATA_GB, 0) AS CNT
                 FROM
                    (
                      SELECT TEMP_DEPT.DEPT
                           , TEMP_DEPT.DEPT_NM
                           , TEMP_GDS.GDS
                        FROM
                           (
                             SELECT CD_VLD_VAL AS GDS
                               FROM T_CMZ_CD_D
                              WHERE DEL_YN    = 'N'
                                AND TENANT_ID = 'TNT_WELLS'
                                AND CD_ID     = 'SDING_PKG_CD'
                           ) TEMP_GDS
                       INNER JOIN
                           (
                             SELECT CD_VLD_VAL AS DEPT
                                  , CD_CNTN    AS DEPT_NM
                               FROM T_CMZ_CD_D
                              WHERE DEL_YN    = 'N'
                                AND TENANT_ID = 'TNT_WELLS'
                                AND CD_ID     = 'GG_LCT_CD'
                              UNION ALL
                             SELECT '17'       AS DEPT   /* 택배 */
                                  , MLNG_CNTN  AS DEPT_NM
                               FROM T_CMZ_MLNG_D
                              WHERE TENANT_ID = 'TNT_BASE'
                                AND MLNG_ID   = 'MSG_TXT_PCSV'
                                AND LNG_ID    = #{session.langId}
                           ) TEMP_DEPT
                          ON 1 = 1
                       ORDER BY TEMP_DEPT.DEPT
                    ) T1
                 LEFT OUTER JOIN
                    (
                      SELECT D1.SDING_PKG_CD
                           , D2.SV_BIZ_HCLSF_CD
                           , D2.OG_CD
                           , D1.SDING_PKG_GRP_CD
                           , SUM(D2.CNT_SUB) AS CNT_BY_DATA_GB
                        FROM TEMP_PCK_INFO D1
                        LEFT OUTER JOIN TEMP_T D2
                          ON D2.SDING_PKG_CD = D1.SDING_PKG_CD
                       GROUP BY D1.SDING_PKG_CD, D2.SV_BIZ_HCLSF_CD, D2.OG_CD, D1.SDING_PKG_GRP_CD
                       ORDER BY D2.OG_CD, D1.SDING_PKG_GRP_CD, D1.SDING_PKG_CD
                    ) T2
                   ON T2.SDING_PKG_CD = T1.GDS
                  AND T2.OG_CD        = T1.DEPT
             ) T
         GROUP BY T.DEPT, T.DEPT_NM
         ORDER BY T.DEPT
    </if>
    </select>


</mapper>
