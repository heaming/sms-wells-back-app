<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaSeedReleaseScheduleMapper">

    <select id="selectSeedReleaseSchedulesPaging" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaSeedReleaseScheduleSearchDvo">
        SELECT CASE WHEN T1.REFRI_DV_CD = '1' THEN 'X'
                    WHEN T1.REFRI_DV_CD = '2' THEN CASE WHEN T1.OSTR_CNFMDT IS NOT NULL THEN 'C'
                                                        ELSE 'R'
                                                   END
                    ELSE 'N'
               END                                                                                AS DP_YN                  /* 입금 */
             , CASE WHEN T1.OSTR_CNFMDT IS NOT NULL THEN 'Y'
                    ELSE 'N'
               END                                                                                AS OSTR_YN                /* 출고 */
             , F_CMZ_CD_NM('TNT_WELLS', 'REFRI_DV_CD', T1.REFRI_DV_CD, #{session.langId})         AS REFRI_DIV              /* 유/무상구분 */
             , F_CMZ_CD_NM('TNT_WELLS', 'ITM_IOST_DV_CD', T1.ITM_IOST_DV_CD, #{session.langId})   AS SHIP_DIV               /* 배송구분 */
             , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_HCLSF_CD', T1.SV_BIZ_HCLSF_CD, #{session.langId}) AS RECEIPT_DIV            /* 접수구분 */
             , T1.CNTR_NO                                                                                                   /* 계약번호 */
             , T1.CNTR_NO || '-' || T1.CNTR_SN                                                    AS CNTR_DTL_NO            /* 계약상세번호 */
             , T10.CST_KNM                                                                        AS CST_NM                 /* 고객명 */
             , T1.SPP_ORD_NO                                                                                                /* 배송번호 */
             , T4.PD_NM                                                                           AS MCHN_MODEL             /* 기기모델 */
             , T2.BASE_DTL_CNTR_NO                                                                AS MCHN_CST_NO            /* 기기고객번호 */
             , T2.BASE_DTL_CNTR_NO || '-' || T2.BASE_DTL_CNTR_SN                                  AS MCHN_CST_DTL_NO        /* 기기계약상세번호 */
             , T6.CST_KNM                                                                         AS MCHN_CST_NM            /* 기기고객명 */
             , T7.PD_NM                                                                           AS CTRL_PKG               /* 현재패키지 */
             , T8.PD_NM                                                                           AS SHIP_PKG               /* 배송패키지 */
             , SUBSTR(T1.SDING_INFO1, 1, INSTR(T1.SDING_INFO1, '|', 1, 1) -1)                     AS SDING_PD_CD1           /* 모종1 상품코드 */
             , SUBSTR( T1.SDING_INFO1
                     , INSTR(T1.SDING_INFO1, '|', 1, 1) + 1
                     , INSTR(T1.SDING_INFO1, '|', 1, 2) - INSTR(T1.SDING_INFO1, '|', 1, 1) - 1)   AS SDING1                 /* 모종1 */
             , SUBSTR( T1.SDING_INFO1
                     , INSTR(T1.SDING_INFO1, '|', 1, 2) + 1
                     , INSTR(T1.SDING_INFO1, '|', 1, 3) - INSTR(T1.SDING_INFO1, '|', 1, 2) - 1)   AS QTY1                   /* 수량1 */
             , SUBSTR(T1.SDING_INFO1, INSTR(T1.SDING_INFO1, '|', 1, 3) + 1)                       AS SOW_DT1                /* 파종일자1 */
             , SUBSTR(T1.SDING_INFO2, 1, INSTR(T1.SDING_INFO2, '|', 1, 1) -1)                     AS SDING_PD_CD2           /* 모종2 상품코드 */
             , SUBSTR( T1.SDING_INFO2
                     , INSTR(T1.SDING_INFO2, '|', 1, 1) + 1
                     , INSTR(T1.SDING_INFO2, '|', 1, 2) - INSTR(T1.SDING_INFO2, '|', 1, 1) - 1)   AS SDING2                 /* 모종2 */
             , SUBSTR( T1.SDING_INFO2
                     , INSTR(T1.SDING_INFO2, '|', 1, 2) + 1
                     , INSTR(T1.SDING_INFO2, '|', 1, 3) - INSTR(T1.SDING_INFO2, '|', 1, 2) - 1)   AS QTY2                   /* 수량2 */
             , SUBSTR(T1.SDING_INFO2, INSTR(T1.SDING_INFO2, '|', 1, 3) + 1)                       AS SOW_DT2                /* 파종일자2 */
             , SUBSTR(T1.SDING_INFO3, 1, INSTR(T1.SDING_INFO3, '|', 1, 1) -1)                     AS SDING_PD_CD3           /* 모종3 상품코드 */
             , SUBSTR( T1.SDING_INFO3
                     , INSTR(T1.SDING_INFO3, '|', 1, 1) + 1
                     , INSTR(T1.SDING_INFO3, '|', 1, 2) - INSTR(T1.SDING_INFO3, '|', 1, 1) - 1)   AS SDING3                 /* 모종3 */
             , SUBSTR( T1.SDING_INFO3
                     , INSTR(T1.SDING_INFO3, '|', 1, 2) + 1
                     , INSTR(T1.SDING_INFO3, '|', 1, 3) - INSTR(T1.SDING_INFO3, '|', 1, 2) - 1)   AS QTY3                   /* 수량3 */
             , SUBSTR(T1.SDING_INFO3, INSTR(T1.SDING_INFO3, '|', 1, 3) + 1)                       AS SOW_DT3                /* 파종일자3 */
             , SUBSTR(T1.SDING_INFO4, 1, INSTR(T1.SDING_INFO4, '|', 1, 1) -1)                     AS SDING_PD_CD4           /* 모종4 상품코드 */
             , SUBSTR( T1.SDING_INFO4
                     , INSTR(T1.SDING_INFO4, '|', 1, 1) + 1
                     , INSTR(T1.SDING_INFO4, '|', 1, 2) - INSTR(T1.SDING_INFO4, '|', 1, 1) - 1)   AS SDING4                 /* 모종4 */
             , SUBSTR( T1.SDING_INFO4
                     , INSTR(T1.SDING_INFO4, '|', 1, 2) + 1
                     , INSTR(T1.SDING_INFO4, '|', 1, 3) - INSTR(T1.SDING_INFO4, '|', 1, 2) - 1)   AS QTY4                   /* 수량4 */
             , SUBSTR(T1.SDING_INFO4, INSTR(T1.SDING_INFO4, '|', 1, 3) + 1)                       AS SOW_DT4                /* 파종일자4 */
             , SUBSTR(T1.SDING_INFO5, 1, INSTR(T1.SDING_INFO5, '|', 1, 1) -1)                     AS SDING_PD_CD5           /* 모종5 상품코드 */
             , SUBSTR( T1.SDING_INFO5
                     , INSTR(T1.SDING_INFO5, '|', 1, 1) + 1
                     , INSTR(T1.SDING_INFO5, '|', 1, 2) - INSTR(T1.SDING_INFO5, '|', 1, 1) - 1)   AS SDING5                 /* 모종5 */
             , SUBSTR( T1.SDING_INFO5
                     , INSTR(T1.SDING_INFO5, '|', 1, 2) + 1
                     , INSTR(T1.SDING_INFO5, '|', 1, 3) - INSTR(T1.SDING_INFO5, '|', 1, 2) - 1)   AS QTY5                   /* 수량5 */
             , SUBSTR(T1.SDING_INFO5, INSTR(T1.SDING_INFO5, '|', 1, 3) + 1)                       AS SOW_DT5                /* 파종일자5 */
             , T1.REQD_DT                                                                         AS MCHN_DEM_DT            /* 기기철거일자 */
             , T1.RCPDT                                                                           AS RECEIPT_DT             /* 접수일자 */
             , T1.VST_CNFMDT                                                                      AS VST_DT                 /* 방문일자 */
             , T1.OSTR_DUEDT                                                                      AS OSTR_SCHE_DT           /* 출고예정일자 */
             , T1.BS_FSH_DT                                                                                                 /* B/S완료일자 */
             , T1.DP_DT                                                                                                     /* 입금일자 */
             , T1.OSTR_CNFMDT                                                                     AS OSTR_CNFM_DT           /* 출고확정일자 */
             , T13.CNR_NM                                                                         AS SDING_RCG_WARE_NM      /* 모종수령창고 */
             , T1.OG_NM                                                                           AS VST_CENTER             /* 방문센터 */
             , T11.PRTNR_KNM                                                                      AS VST_ICHR               /* 방문담당 */
             , T11.CRAL_LOCARA_TNO                                                                AS ICHR_CRAL_LOCARA_TNO   /* 담당휴대지역전화번호 */
             , T11.MEXNO_ENCR                                                                     AS ICHR_MEXNO_ENCR        /* 담당전화국번호암호화 */
             , T11.CRAL_IDV_TNO                                                                   AS ICHR_CRAL_IDV_TNO      /* 담당휴대개별전화번호 */
             , T10.CRAL_LOCARA_TNO                                                                AS CST_CRAL_LOCARA_TNO    /* 고객휴대지역전화번호 */
             , T10.MEXNO_ENCR                                                                     AS CST_MEXNO_ENCR         /* 고객전화국번호암호화 */
             , T10.CRAL_IDV_TNO                                                                   AS CST_CRAL_IDV_TNO       /* 고객휴대개별전화번호 */
             , T12.NEW_ADR_ZIP                                                                    AS CST_ZIP                /* 고객우편번호 */
             , T12.RNADR || T12.RDADR                                                             AS CST_ADR                /* 고객주소 */
             , T1.REFRI_DV_CD                                                                                               /* 유무상구분코드 */
             , T1.CNTR_SN                                                                                                   /* 계약일련번호 */
             , T1.SV_BIZ_HCLSF_CD                                                                                           /* 서비스업무대분류코드 */
             , T1.SV_BIZ_DCLSF_CD                                                                                           /* 서비스업무세분류코드 */
             , T1.SPP_PLAN_SN                                                                                               /* 배송계획일련번호 */
             , T1.SDING_PKG_PD_CD                                                                                           /* 모종패키지상품코드 */
             , T1.MNGR_DV_CD                                                                                                /* 관리자구분코드 */
             , T1.DP_EPTT_NM                                                                                                /* 입금예정자명 */
             , T1.OG_TP_CD                                                                                                  /* 조직유형코드 */
             , T1.PRTNR_NO                                                                                                  /* 파트너번호 */
             , T1.CNTR_ADRPC_ID                                                                                             /* 계약주소지ID */
             , T1.RECAP_CS_AMT                                                                                              /* 유상비용금액 */
             , T1.ITM_IOST_DV_CD                                                                  AS SPP_DV_CD              /* 배송구분코드 */
             , T1.CST_SV_ASN_NO                                                                                             /* 고객서비스배정번호 */
             , T4.PD_CD                                                                           AS SDING_MCNR_PD_CD       /* 모종기계상품코드 */
          FROM
             (
            <if test='!@MybatisUtils@equals(svBizHclsfCd, "2") or @MybatisUtils@isEmpty(svBizHclsfCd)'>
               SELECT D1.CNTR_NO                                    /* 계약번호 */
                    , D1.CNTR_SN                                    /* 계약일련번호 */
                    , D1.SV_BIZ_HCLSF_CD                            /* 서비스업무대분류코드 */
                    , D1.SV_BIZ_DCLSF_CD                            /* 서비스업무세분류코드 */
                    , D1.SPP_ORD_NO                                 /* 배송주문번호 */
                    , D1.SPP_PLAN_SN                                /* 배송계획일련번호 */
                    , D1.REFRI_DV_CD                                /* 유무상구분코드 */
                    , D1.OSTR_CNFMDT                                /* 출고확정일자 */
                    , D1.ITM_IOST_DV_CD                             /* 품목입출고구분코드 */
                    , D1.SDING_PKG_PD_CD                            /* 배송 패키지 상품코드 */
                    , D5.PDCT_PD_CD                                 /* 현재 패키지 상품코드 */
                    , D5.REQD_DT                                    /* 철거일자 */
                    , D2.RCPDT                                      /* 접수일자 */
                    , D3.VST_CNFMDT                                 /* 방문일자 */
                    , D1.OSTR_DUEDT                                 /* 출고예정일자 */
                    , ''                         AS BS_FSH_DT       /* B/S완료일자 */
                    , D1.DP_DT                                      /* 입금일자 */
                    , D4.OG_NM                                      /* 방문센터 */
                    , D4.OG_TP_CD                                   /* 조직유형코드 */
                    , D4.PRTNR_NO                                   /* 파트너번호 */
                    , ( SELECT S2.CNTR_ADRPC_ID
                          FROM TB_SSCT_CNTR_ADR_REL S1
                         INNER JOIN TB_SSCT_CNTR_ADRPC_BAS S2
                            ON S2.CNTR_ADRPC_ID = S1.CNTR_ADRPC_ID
                         WHERE S1.DTL_CNTR_NO = D2.CNTR_NO
                           AND S1.DTL_CNTR_SN = D2.CNTR_SN
                           AND S2.ADR_ID      = D2.ADR_ID
                           AND S1.ADRPC_TP_CD = '1'
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN S1.VL_STRT_DTM AND S1.VL_END_DTM
                           AND ROWNUM      = 1 ) AS CNTR_ADRPC_ID   /* 계약주소지ID */
                    , D1.MNGR_DV_CD                                 /* 관리자구분코드 */
                    , D1.DP_EPTT_NM                                 /* 입금예정자명 */
                    , D1.RECAP_CS_AMT                               /* 유상비용금액 */
                    , D3.CST_SV_ASN_NO                              /* 고객서비스배정번호 */
                    , ( SELECT T.SDING_PD_CD || '|' || T.PD_NM || '|' || T.SDING_QTY || '|' || T.SOW_DT
                          FROM
                             (
                               SELECT S1.SDING_PD_CD
                                    , S2.PD_NM
                                    , S1.SDING_QTY
                                    , CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                           ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                      END AS SOW_DT
                                    , ROW_NUMBER() OVER(ORDER BY S1.SDING_SN) AS RN
                                 FROM TB_SVPD_SDING_SPP_EXP_IZ S1   /* 모종배송예정내역 */
                                INNER JOIN TB_PDBS_PD_BAS S2                  /* 상품기본 */
                                   ON S2.PD_CD = S1.SDING_PD_CD
                                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3        /* 상품각사속성상세 */
                                   ON S3.PD_CD = S2.PD_CD
                                WHERE S1.CNTR_NO            = D1.CNTR_NO
                                  AND S1.CNTR_SN            = D1.CNTR_SN
                                  AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                                  AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                                  AND S1.SPP_ORD_NO         = D1.SPP_ORD_NO
                                  AND S1.SPP_PLAN_SN        = D1.SPP_PLAN_SN
                                  AND S1.DTA_DL_YN          = 'N'
                                  AND S2.DTA_DL_YN          = 'N'
				                  AND S2.PD_TP_CD           = 'M'
				                  AND S3.DTA_DL_YN          = 'N'
				                  AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
				                  AND S3.PD_PRP_VAL01 LIKE ( CASE WHEN D1.ITM_IOST_DV_CD = '1' THEN '6%'
				                                                  ELSE '%'
				                                             END )
                             ) T
                         WHERE T.RN = 1 )        AS SDING_INFO1     /* 모종1 정보 */
                    , ( SELECT T.SDING_PD_CD || '|' || T.PD_NM || '|' || T.SDING_QTY || '|' || T.SOW_DT
                          FROM
                             (
                               SELECT S1.SDING_PD_CD
                                    , S2.PD_NM
                                    , S1.SDING_QTY
                                    , CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                           ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                      END AS SOW_DT
                                    , ROW_NUMBER() OVER(ORDER BY S1.SDING_SN) AS RN
                                 FROM TB_SVPD_SDING_SPP_EXP_IZ S1   /* 모종배송예정내역 */
                                INNER JOIN TB_PDBS_PD_BAS S2                  /* 상품기본 */
                                   ON S2.PD_CD = S1.SDING_PD_CD
                                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3        /* 상품각사속성상세 */
                                   ON S3.PD_CD = S2.PD_CD
                                WHERE S1.CNTR_NO            = D1.CNTR_NO
                                  AND S1.CNTR_SN            = D1.CNTR_SN
                                  AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                                  AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                                  AND S1.SPP_ORD_NO         = D1.SPP_ORD_NO
                                  AND S1.SPP_PLAN_SN        = D1.SPP_PLAN_SN
                                  AND S1.DTA_DL_YN          = 'N'
                                  AND S2.DTA_DL_YN          = 'N'
				                  AND S2.PD_TP_CD           = 'M'
				                  AND S3.DTA_DL_YN          = 'N'
				                  AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
				                  AND S3.PD_PRP_VAL01 LIKE ( CASE WHEN D1.ITM_IOST_DV_CD = '1' THEN '6%'
				                                                  ELSE '%'
				                                             END )
                             ) T
                         WHERE T.RN = 2 )        AS SDING_INFO2     /* 모종2 정보 */
                    , ( SELECT T.SDING_PD_CD || '|' || T.PD_NM || '|' || T.SDING_QTY || '|' || T.SOW_DT
                          FROM
                             (
                               SELECT S1.SDING_PD_CD
                                    , S2.PD_NM
                                    , S1.SDING_QTY
                                    , CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                           ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                      END AS SOW_DT
                                    , ROW_NUMBER() OVER(ORDER BY S1.SDING_SN) AS RN
                                 FROM TB_SVPD_SDING_SPP_EXP_IZ S1   /* 모종배송예정내역 */
                                INNER JOIN TB_PDBS_PD_BAS S2                  /* 상품기본 */
                                   ON S2.PD_CD = S1.SDING_PD_CD
                                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3        /* 상품각사속성상세 */
                                   ON S3.PD_CD = S2.PD_CD
                                WHERE S1.CNTR_NO            = D1.CNTR_NO
                                  AND S1.CNTR_SN            = D1.CNTR_SN
                                  AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                                  AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                                  AND S1.SPP_ORD_NO         = D1.SPP_ORD_NO
                                  AND S1.SPP_PLAN_SN        = D1.SPP_PLAN_SN
                                  AND S1.DTA_DL_YN          = 'N'
                                  AND S2.DTA_DL_YN          = 'N'
				                  AND S2.PD_TP_CD           = 'M'
				                  AND S3.DTA_DL_YN          = 'N'
				                  AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
				                  AND S3.PD_PRP_VAL01 LIKE ( CASE WHEN D1.ITM_IOST_DV_CD = '1' THEN '6%'
				                                                  ELSE '%'
				                                             END )
                             ) T
                         WHERE T.RN = 3 )        AS SDING_INFO3     /* 모종3 정보 */
                    , ( SELECT T.SDING_PD_CD || '|' || T.PD_NM || '|' || T.SDING_QTY || '|' || T.SOW_DT
                          FROM
                             (
                               SELECT S1.SDING_PD_CD
                                    , S2.PD_NM
                                    , S1.SDING_QTY
                                    , CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                           ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                      END AS SOW_DT
                                    , ROW_NUMBER() OVER(ORDER BY S1.SDING_SN) AS RN
                                 FROM TB_SVPD_SDING_SPP_EXP_IZ S1   /* 모종배송예정내역 */
                                INNER JOIN TB_PDBS_PD_BAS S2                  /* 상품기본 */
                                   ON S2.PD_CD = S1.SDING_PD_CD
                                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3        /* 상품각사속성상세 */
                                   ON S3.PD_CD = S2.PD_CD
                                WHERE S1.CNTR_NO            = D1.CNTR_NO
                                  AND S1.CNTR_SN            = D1.CNTR_SN
                                  AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                                  AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                                  AND S1.SPP_ORD_NO         = D1.SPP_ORD_NO
                                  AND S1.SPP_PLAN_SN        = D1.SPP_PLAN_SN
                                  AND S1.DTA_DL_YN          = 'N'
                                  AND S2.DTA_DL_YN          = 'N'
				                  AND S2.PD_TP_CD           = 'M'
				                  AND S3.DTA_DL_YN          = 'N'
				                  AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
				                  AND S3.PD_PRP_VAL01 LIKE ( CASE WHEN D1.ITM_IOST_DV_CD = '1' THEN '6%'
				                                                  ELSE '%'
				                                             END )
                             ) T
                         WHERE T.RN = 4 )        AS SDING_INFO4     /* 모종4 정보 */
                    , ( SELECT T.SDING_PD_CD || '|' || T.PD_NM || '|' || T.SDING_QTY || '|' || T.SOW_DT
                          FROM
                             (
                               SELECT S1.SDING_PD_CD
                                    , S2.PD_NM
                                    , S1.SDING_QTY
                                    , CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                           ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                      END AS SOW_DT
                                    , ROW_NUMBER() OVER(ORDER BY S1.SDING_SN) AS RN
                                 FROM TB_SVPD_SDING_SPP_EXP_IZ S1   /* 모종배송예정내역 */
                                INNER JOIN TB_PDBS_PD_BAS S2                  /* 상품기본 */
                                   ON S2.PD_CD = S1.SDING_PD_CD
                                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3        /* 상품각사속성상세 */
                                   ON S3.PD_CD = S2.PD_CD
                                WHERE S1.CNTR_NO            = D1.CNTR_NO
                                  AND S1.CNTR_SN            = D1.CNTR_SN
                                  AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                                  AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                                  AND S1.SPP_ORD_NO         = D1.SPP_ORD_NO
                                  AND S1.SPP_PLAN_SN        = D1.SPP_PLAN_SN
                                  AND S1.DTA_DL_YN          = 'N'
                                  AND S2.DTA_DL_YN          = 'N'
				                  AND S2.PD_TP_CD           = 'M'
				                  AND S3.DTA_DL_YN          = 'N'
				                  AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
				                  AND S3.PD_PRP_VAL01 LIKE ( CASE WHEN D1.ITM_IOST_DV_CD = '1' THEN '6%'
				                                                  ELSE '%'
				                                             END )
                             ) T
                         WHERE T.RN = 5 )        AS SDING_INFO5    /* 모종5 정보 */
                 FROM TB_SVPD_SDING_SPP_PLAN_IZ D1            /* 모종배송계획내역 */
                INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ D2      /* 고객서비스AS설치대상내역 */
                   ON D2.CNTR_NO         = D1.CNTR_NO
                  AND D2.CNTR_SN         = D1.CNTR_SN
                  AND D2.SV_BIZ_HCLSF_CD = D1.SV_BIZ_HCLSF_CD
                  AND D2.SV_BIZ_DCLSF_CD = D1.SV_BIZ_DCLSF_CD
                  AND D1.SPP_ORD_NO      = D2.SV_BIZ_HCLSF_CD || D2.RCPDT || SUBSTR(D2.AS_IST_OJ_NO, -5)
                INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ D3     /* 고객서비스AS설치배정내역 */
                   ON D3.CST_SV_ASN_NO = D2.CST_SV_ASN_NO
                INNER JOIN TB_OGBS_MM_PRTNR_IZ D4             /* 월파트너내역 */
                   ON D4.OG_TP_CD = D3.ICHR_OG_TP_CD
                  AND D4.PRTNR_NO = D3.ICHR_PRTNR_NO
                  AND D4.BASE_YM  = SUBSTR(#{strtDt}, 1, 6)
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D5         /* 고객서비스수행내역 */
                   ON D5.CNTR_NO = D2.CNTR_NO
                  AND D5.CNTR_NO = D2.CNTR_NO
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D6        /* 상품각사속성상세 */
                   ON D6.PD_CD = D2.PD_CD
                WHERE D1.DTA_DL_YN          = 'N'
                  AND D2.DTA_DL_YN          = 'N'
                  AND D3.DTA_DL_YN          = 'N'
                  AND D4.DTA_DL_YN          = 'N'
                  AND D5.DTA_DL_YN          = 'N'
                  AND D5.CNTR_DTL_STAT_CD   = '101'   /* 정상 */
                  AND D6.DTA_DL_YN          = 'N'
                  AND D6.PD_EXTS_PRP_GRP_CD = 'PART'
                  AND D1.CAN_DT IS NULL
                  AND D5.REQD_DT IS NULL
                  AND D6.PD_PRP_VAL01 LIKE '60%'
               <if test="@MybatisUtils@isNotEmpty(svBizHclsfCd)">
                  AND D1.SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
               </if>
               <choose>
               <when test='@MybatisUtils@equals(dtTpCd, "1")'>
                  AND D2.RCPDT BETWEEN #{strtDt} AND #{endDt}         /* 접수일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "2")'>
                  AND D3.VST_CNFMDT BETWEEN #{strtDt} AND #{endDt}    /* 방문일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "3")'>
                  AND D1.OSTR_CNFMDT BETWEEN #{strtDt} AND #{endDt}   /* 확정일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "4")'>
               <choose>
                <when test='@MybatisUtils@equals(dayOfWeek, "1") or @MybatisUtils@equals(dayOfWeek, "3")'>   /* 월, 수 */
                  AND (  (
                               D3.VST_CNFMDT = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD')
                           AND D4.OG_CD IN ( '71350'     /* 의정부지점 */
                                           , '71352'     /* 일산지점 */
                                           , '71355'     /* 인천지점 */
                                           , '71356'     /* 수원지점 */
                                           , '71367'     /* 하남지점 */
                                           , '71394'     /* Wells생산팀 */
                                           , '71623'     /* Wellsfarm */
                                           , '75041'     /* 북부서비스센터 */
                                           , '75041'     /* 서부서비스센터 */
                                           , '75043'     /* 남부서비스센터 */
                                           , '75044' )   /* 동부서비스센터 */
                         )
                        OR
                         (
                               D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD') AND TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 2, 'YYYYMMDD')
                           AND D4.OG_CD IN ( '71357'     /* 부산지점 */
                                           , '71359'     /* 원주지점 */
                                           , '71360'     /* 청주지점 */
                                           , '71361'     /* 서대구지점 */
                                           , '71363'     /* 광주지점 */
                                           , '71364'     /* 전주지점 */
                                           , '71365'     /* 제주지점 */
                                           , '75047'     /* 경북서비스센터 */
                                           , '75041'     /* 경남서비스센터 */
                                           , '75045'     /* 충청서비스센터 */
                                           , '75046'     /* 호남서비스센터 */
                                           , '71782'     /* 원주서비스센터 */
                                           , '71783'     /* 광양서비스센터 */
                                           , '71784' )   /* 광양지점 */
                         ) )
                </when>
                <when test='@MybatisUtils@equals(dayOfWeek, "2") or @MybatisUtils@equals(dayOfWeek, "4")'>   /* 화, 목 */
                  AND D3.VST_CNFMDT = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD')
                  AND D4.OG_CD IN ( '71350'     /* 의정부지점 */
                                  , '71352'     /* 일산지점 */
                                  , '71355'     /* 인천지점 */
                                  , '71356'     /* 수원지점 */
                                  , '71367'     /* 하남지점 */
                                  , '71394'     /* Wells생산팀 */
                                  , '71623'     /* Wellsfarm */
                                  , '75041'     /* 북부서비스센터 */
                                  , '75041'     /* 서부서비스센터 */
                                  , '75043'     /* 남부서비스센터 */
                                  , '75044' )   /* 동부서비스센터 */
                </when>
                <when test='@MybatisUtils@equals(dayOfWeek, "5")'>   /* 금요일 */
                  AND D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD') AND TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 3, 'YYYYMMDD')
                  AND D4.OG_CD IN ( '71350'     /* 의정부지점 */
                                  , '71352'     /* 일산지점 */
                                  , '71355'     /* 인천지점 */
                                  , '71356'     /* 수원지점 */
                                  , '71367'     /* 하남지점 */
                                  , '71394'     /* Wells생산팀 */
                                  , '71623'     /* Wellsfarm */
                                  , '75041'     /* 북부서비스센터 */
                                  , '75041'     /* 서부서비스센터 */
                                  , '75043'     /* 남부서비스센터 */
                                  , '75044'     /* 동부서비스센터 */
                                  , '71357'     /* 부산지점 */
                                  , '71359'     /* 원주지점 */
                                  , '71360'     /* 청주지점 */
                                  , '71361'     /* 서대구지점 */
                                  , '71363'     /* 광주지점 */
                                  , '71364'     /* 전주지점 */
                                  , '71365'     /* 제주지점 */
                                  , '75047'     /* 경북서비스센터 */
                                  , '75041'     /* 경남서비스센터 */
                                  , '75045'     /* 충청서비스센터 */
                                  , '75046'     /* 호남서비스센터 */
                                  , '71782'     /* 원주서비스센터 */
                                  , '71783'     /* 광양서비스센터 */
                                  , '71784' )   /* 광양지점 */
                </when>
               </choose>
               </when>
               </choose>
               <if test="@MybatisUtils@isNotEmpty(refriDivCd)">
                  AND D1.REFRI_DV_CD    = #{refriDivCd}
               </if>
               <if test="@MybatisUtils@isNotEmpty(sppDvCd)">
                  AND D1.ITM_IOST_DV_CD = #{sppDvCd}
               </if>
               <if test="@MybatisUtils@isNotEmpty(fshProcsCd)">
               <choose>
                <when test='!@MybatisUtils@equals(fshProcsCd, "20")'>
                  AND D3.WK_PRGS_STAT_CD IN ('00', '10')   /* 작업대기, 진행중 */
                </when>
                <otherwise>
                  AND D3.WK_PRGS_STAT_CD = #{fshProcsCd}
                </otherwise>
               </choose>
               </if>
               <if test="@MybatisUtils@isNotEmpty(pkgDvCd)">
               <choose>
                <when test='@MybatisUtils@equals(pkgDvCd, "1")'>
                  AND D6.PD_PRP_VAL01 BETWEEN '60100' AND '60799'
                </when>
                <when test='@MybatisUtils@equals(pkgDvCd, "2")'>
                  AND D6.PD_PRP_VAL01 BETWEEN '60801' AND '60805'
                </when>
                <when test='@MybatisUtils@equals(pkgDvCd, "3")'>
                  AND D6.PD_PRP_VAL01 BETWEEN '60810' AND '60821'
                </when>
               </choose>
               </if>
               <if test='@MybatisUtils@equals(ostrYn, "Y")'>
                  AND D1.OSTR_CNFMDT IS NOT NULL
               </if>
               <if test='@MybatisUtils@equals(ostrYn, "N")'>
                  AND D1.OSTR_CNFMDT IS NULL
               </if>
            </if>
            <if test="@MybatisUtils@isEmpty(svBizHclsfCd)">
                UNION ALL
            </if>
            <if test='@MybatisUtils@equals(svBizHclsfCd, "2") or @MybatisUtils@isEmpty(svBizHclsfCd)'>
               SELECT D1.CNTR_NO                                     /* 계약번호 */
                    , D1.CNTR_SN                                     /* 계약일련번호 */
                    , D1.SV_BIZ_HCLSF_CD                             /* 서비스업무대분류코드 */
                    , D1.SV_BIZ_DCLSF_CD                             /* 서비스업무세분류코드 */
                    , D1.SPP_ORD_NO                                  /* 배송주문번호 */
                    , D1.SPP_PLAN_SN                                 /* 배송계획일련번호 */
                    , D1.REFRI_DV_CD                                 /* 유무상구분코드 */
                    , D1.OSTR_CNFMDT                                 /* 출고확정일자 */
                    , D1.ITM_IOST_DV_CD                              /* 품목입출고구분코드 */
                    , D1.SDING_PKG_PD_CD                             /* 배송 패키지 상품코드 */
                    , D5.PDCT_PD_CD                                  /* 현재 패키지 상품코드 */
                    , D5.REQD_DT                                     /* 철거일자 */
                    , SUBSTR(D2.FST_RGST_DTM, 1, 8) AS RCPDT         /* 접수일자 */
                    , D3.VST_CNFMDT                                  /* 방문일자 */
                    , D1.OSTR_DUEDT                                  /* 출고예정일자 */
                    , D3.WK_EXCN_DT                 AS BS_FSH_DT     /* B/S완료일자 */
                    , D1.DP_DT                                       /* 입금일자 */
                    , D4.OG_NM                                       /* 방문센터 */
                    , D4.OG_TP_CD                                    /* 조직유형코드 */
                    , D4.PRTNR_NO                                    /* 파트너번호 */
                    , ( SELECT S2.CNTR_ADRPC_ID
                          FROM TB_SSCT_CNTR_ADR_REL S1
                         INNER JOIN TB_SSCT_CNTR_ADRPC_BAS S2
                            ON S2.CNTR_ADRPC_ID = S1.CNTR_ADRPC_ID
                         WHERE S1.DTL_CNTR_NO = D2.CNTR_NO
                           AND S1.DTL_CNTR_SN = D2.CNTR_SN
                           AND S2.ADR_ID      = D2.ADR_ID
                           AND S1.ADRPC_TP_CD = '1'
                           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN S1.VL_STRT_DTM AND S1.VL_END_DTM
                           AND ROWNUM      = 1 )    AS CNTR_ADRPC_ID /* 계약주소지ID */
                    , D1.MNGR_DV_CD                                  /* 관리자구분코드 */
                    , D1.DP_EPTT_NM                                  /* 입금예정자명 */
                    , D1.RECAP_CS_AMT                                /* 유상비용금액 */
                    , D3.CST_SV_ASN_NO                               /* 고객서비스배정번호 */
                    , ( SELECT T.SDING_PD_CD || '|' || T.PD_NM || '|' || T.SDING_QTY || '|' || T.SOW_DT
                          FROM
                             (
                               SELECT S1.SDING_PD_CD
                                    , S2.PD_NM
                                    , S1.SDING_QTY
                                    , CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                           ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                      END AS SOW_DT
                                    , ROW_NUMBER() OVER(ORDER BY S1.SDING_SN) AS RN
                                 FROM TB_SVPD_SDING_SPP_EXP_IZ S1   /* 모종배송예정내역 */
                                INNER JOIN TB_PDBS_PD_BAS S2                  /* 상품기본 */
                                   ON S2.PD_CD = S1.SDING_PD_CD
                                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3        /* 상품각사속성상세 */
                                   ON S3.PD_CD = S2.PD_CD
                                WHERE S1.CNTR_NO            = D1.CNTR_NO
                                  AND S1.CNTR_SN            = D1.CNTR_SN
                                  AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                                  AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                                  AND S1.SPP_ORD_NO         = D1.SPP_ORD_NO
                                  AND S1.SPP_PLAN_SN        = D1.SPP_PLAN_SN
                                  AND S1.DTA_DL_YN          = 'N'
                                  AND S2.DTA_DL_YN          = 'N'
				                  AND S2.PD_TP_CD           = 'M'
				                  AND S3.DTA_DL_YN          = 'N'
				                  AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
				                  AND S3.PD_PRP_VAL01 LIKE ( CASE WHEN D1.ITM_IOST_DV_CD = '1' THEN '6%'
				                                                  ELSE '%'
				                                             END )
                             ) T
                         WHERE T.RN = 1 )           AS SDING_INFO1   /* 모종1 정보 */
                    , ( SELECT T.SDING_PD_CD || '|' || T.PD_NM || '|' || T.SDING_QTY || '|' || T.SOW_DT
                          FROM
                             (
                               SELECT S1.SDING_PD_CD
                                    , S2.PD_NM
                                    , S1.SDING_QTY
                                    , CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                           ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                      END AS SOW_DT
                                    , ROW_NUMBER() OVER(ORDER BY S1.SDING_SN) AS RN
                                 FROM TB_SVPD_SDING_SPP_EXP_IZ S1   /* 모종배송예정내역 */
                                INNER JOIN TB_PDBS_PD_BAS S2                  /* 상품기본 */
                                   ON S2.PD_CD = S1.SDING_PD_CD
                                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3        /* 상품각사속성상세 */
                                   ON S3.PD_CD = S2.PD_CD
                                WHERE S1.CNTR_NO            = D1.CNTR_NO
                                  AND S1.CNTR_SN            = D1.CNTR_SN
                                  AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                                  AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                                  AND S1.SPP_ORD_NO         = D1.SPP_ORD_NO
                                  AND S1.SPP_PLAN_SN        = D1.SPP_PLAN_SN
                                  AND S1.DTA_DL_YN          = 'N'
                                  AND S2.DTA_DL_YN          = 'N'
				                  AND S2.PD_TP_CD           = 'M'
				                  AND S3.DTA_DL_YN          = 'N'
				                  AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
				                  AND S3.PD_PRP_VAL01 LIKE ( CASE WHEN D1.ITM_IOST_DV_CD = '1' THEN '6%'
				                                                  ELSE '%'
				                                             END )
                             ) T
                         WHERE T.RN = 2 )           AS SDING_INFO2   /* 모종2 정보 */
                    , ( SELECT T.SDING_PD_CD || '|' || T.PD_NM || '|' || T.SDING_QTY || '|' || T.SOW_DT
                          FROM
                             (
                               SELECT S1.SDING_PD_CD
                                    , S2.PD_NM
                                    , S1.SDING_QTY
                                    , CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                           ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                      END AS SOW_DT
                                    , ROW_NUMBER() OVER(ORDER BY S1.SDING_SN) AS RN
                                 FROM TB_SVPD_SDING_SPP_EXP_IZ S1   /* 모종배송예정내역 */
                                INNER JOIN TB_PDBS_PD_BAS S2                  /* 상품기본 */
                                   ON S2.PD_CD = S1.SDING_PD_CD
                                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3        /* 상품각사속성상세 */
                                   ON S3.PD_CD = S2.PD_CD
                                WHERE S1.CNTR_NO            = D1.CNTR_NO
                                  AND S1.CNTR_SN            = D1.CNTR_SN
                                  AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                                  AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                                  AND S1.SPP_ORD_NO         = D1.SPP_ORD_NO
                                  AND S1.SPP_PLAN_SN        = D1.SPP_PLAN_SN
                                  AND S1.DTA_DL_YN          = 'N'
                                  AND S2.DTA_DL_YN          = 'N'
				                  AND S2.PD_TP_CD           = 'M'
				                  AND S3.DTA_DL_YN          = 'N'
				                  AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
				                  AND S3.PD_PRP_VAL01 LIKE ( CASE WHEN D1.ITM_IOST_DV_CD = '1' THEN '6%'
				                                                  ELSE '%'
				                                             END )
                             ) T
                         WHERE T.RN = 3 )           AS SDING_INFO3   /* 모종3 정보 */
                    , ( SELECT T.SDING_PD_CD || '|' || T.PD_NM || '|' || T.SDING_QTY || '|' || T.SOW_DT
                          FROM
                             (
                               SELECT S1.SDING_PD_CD
                                    , S2.PD_NM
                                    , S1.SDING_QTY
                                    , CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                           ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                      END AS SOW_DT
                                    , ROW_NUMBER() OVER(ORDER BY S1.SDING_SN) AS RN
                                 FROM TB_SVPD_SDING_SPP_EXP_IZ S1   /* 모종배송예정내역 */
                                INNER JOIN TB_PDBS_PD_BAS S2                  /* 상품기본 */
                                   ON S2.PD_CD = S1.SDING_PD_CD
                                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3        /* 상품각사속성상세 */
                                   ON S3.PD_CD = S2.PD_CD
                                WHERE S1.CNTR_NO            = D1.CNTR_NO
                                  AND S1.CNTR_SN            = D1.CNTR_SN
                                  AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                                  AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                                  AND S1.SPP_ORD_NO         = D1.SPP_ORD_NO
                                  AND S1.SPP_PLAN_SN        = D1.SPP_PLAN_SN
                                  AND S1.DTA_DL_YN          = 'N'
                                  AND S2.DTA_DL_YN          = 'N'
				                  AND S2.PD_TP_CD           = 'M'
				                  AND S3.DTA_DL_YN          = 'N'
				                  AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
				                  AND S3.PD_PRP_VAL01 LIKE ( CASE WHEN D1.ITM_IOST_DV_CD = '1' THEN '6%'
				                                                  ELSE '%'
				                                             END )
                             ) T
                         WHERE T.RN = 4 )           AS SDING_INFO4   /* 모종4 정보 */
                    , ( SELECT T.SDING_PD_CD || '|' || T.PD_NM || '|' || T.SDING_QTY || '|' || T.SOW_DT
                          FROM
                             (
                               SELECT S1.SDING_PD_CD
                                    , S2.PD_NM
                                    , S1.SDING_QTY
                                    , CASE WHEN S3.PD_PRP_VAL19 = '6' THEN ''
                                           ELSE TO_CHAR(TO_DATE(D3.VST_CNFMDT, 'YYYYMMDD') - TO_NUMBER(S3.PD_PRP_VAL06), 'YYYYMMDD')
                                      END AS SOW_DT
                                    , ROW_NUMBER() OVER(ORDER BY S1.SDING_SN) AS RN
                                 FROM TB_SVPD_SDING_SPP_EXP_IZ S1   /* 모종배송예정내역 */
                                INNER JOIN TB_PDBS_PD_BAS S2                  /* 상품기본 */
                                   ON S2.PD_CD = S1.SDING_PD_CD
                                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S3        /* 상품각사속성상세 */
                                   ON S3.PD_CD = S2.PD_CD
                                WHERE S1.CNTR_NO            = D1.CNTR_NO
                                  AND S1.CNTR_SN            = D1.CNTR_SN
                                  AND S1.SV_BIZ_HCLSF_CD    = D1.SV_BIZ_HCLSF_CD
                                  AND S1.SV_BIZ_DCLSF_CD    = D1.SV_BIZ_DCLSF_CD
                                  AND S1.SPP_ORD_NO         = D1.SPP_ORD_NO
                                  AND S1.SPP_PLAN_SN        = D1.SPP_PLAN_SN
                                  AND S1.DTA_DL_YN          = 'N'
                                  AND S2.DTA_DL_YN          = 'N'
				                  AND S2.PD_TP_CD           = 'M'
				                  AND S3.DTA_DL_YN          = 'N'
				                  AND S3.PD_EXTS_PRP_GRP_CD = 'PART'
				                  AND S3.PD_PRP_VAL01 LIKE ( CASE WHEN D1.ITM_IOST_DV_CD = '1' THEN '6%'
				                                                  ELSE '%'
				                                             END )
                             ) T
                         WHERE T.RN = 5 )           AS SDING_INFO5   /* 모종5 정보 */
                 FROM TB_SVPD_SDING_SPP_PLAN_IZ D1            /* 모종배송계획내역 */
                INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D2      /* 고객서비스BS대상내역 */
                   ON D2.CNTR_NO         = D1.CNTR_NO
                  AND D2.CNTR_SN         = D1.CNTR_SN
                  AND D2.SV_BIZ_DCLSF_CD = D1.SV_BIZ_DCLSF_CD
                  AND D1.SV_BIZ_HCLSF_CD = '2'
                  AND D1.SPP_ORD_NO      = '2' || D2.VST_DUEDT || LPAD(D2.IST_NMN_N, 5, '0')
                INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ D3     /* 고객서비스BS배정내역 */
                   ON D3.CST_SV_ASN_NO = D2.CST_SV_ASN_NO
                 LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ D4       /* 월파트너내역 */
                   ON D4.OG_TP_CD  = D3.CNFM_PSIC_PRTNR_OG_TP_CD
                  AND D4.PRTNR_NO  = D3.CNFM_PSIC_PRTNR_NO
                  AND D4.DTA_DL_YN = 'N'
                  AND D4.BASE_YM   = SUBSTR(#{strtDt}, 1, 6)
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D5          /* 고객서비스수행내역 */
                   ON D5.CNTR_NO = D2.CNTR_NO
                  AND D5.CNTR_SN = D2.CNTR_SN
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D6        /* 상품각사속성상세 */
                   ON D6.PD_CD = D2.PDCT_PD_CD
                WHERE D1.DTA_DL_YN          = 'N'
                  AND D2.DTA_DL_YN          = 'N'
                  AND D3.DTA_DL_YN          = 'N'
                  AND D5.DTA_DL_YN          = 'N'
                  AND D5.CNTR_DTL_STAT_CD   = '101'   /* 정상 */
                  AND D6.DTA_DL_YN          = 'N'
                  AND D6.PD_EXTS_PRP_GRP_CD = 'PART'
                  AND D1.CAN_DT IS NULL
                  AND D5.REQD_DT IS NULL
                  AND D6.PD_PRP_VAL01 LIKE '60%'
               <if test="@MybatisUtils@isNotEmpty(svBizHclsfCd)">
                  AND D1.SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
               </if>
               <choose>
               <when test='@MybatisUtils@equals(dtTpCd, "1")'>
                  AND D2.FST_RGST_DTM BETWEEN #{strtDt} || '000000' AND #{endDt} || '235959'   /* 접수일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "2")'>
                  AND D3.VST_CNFMDT BETWEEN #{strtDt} AND #{endDt}                             /* 방문일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "3")'>
                  AND D1.OSTR_CNFMDT BETWEEN #{strtDt} AND #{endDt}                            /* 확정일자 */
               </when>
               <when test='@MybatisUtils@equals(dtTpCd, "4")'>
               <choose>
                <when test='@MybatisUtils@equals(dayOfWeek, "1") or @MybatisUtils@equals(dayOfWeek, "3")'>   /* 월, 수 */
                  AND (  (
                               D3.VST_CNFMDT = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD')
                           AND D4.OG_CD IN ( '71350'     /* 의정부지점 */
                                           , '71352'     /* 일산지점 */
                                           , '71355'     /* 인천지점 */
                                           , '71356'     /* 수원지점 */
                                           , '71367'     /* 하남지점 */
                                           , '71394'     /* Wells생산팀 */
                                           , '71623'     /* Wellsfarm */
                                           , '75041'     /* 북부서비스센터 */
                                           , '75041'     /* 서부서비스센터 */
                                           , '75043'     /* 남부서비스센터 */
                                           , '75044' )   /* 동부서비스센터 */
                         )
                        OR
                         (
                               D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD') AND TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 2, 'YYYYMMDD')
                           AND D4.OG_CD IN ( '71357'     /* 부산지점 */
                                           , '71359'     /* 원주지점 */
                                           , '71360'     /* 청주지점 */
                                           , '71361'     /* 서대구지점 */
                                           , '71363'     /* 광주지점 */
                                           , '71364'     /* 전주지점 */
                                           , '71365'     /* 제주지점 */
                                           , '75047'     /* 경북서비스센터 */
                                           , '75041'     /* 경남서비스센터 */
                                           , '75045'     /* 충청서비스센터 */
                                           , '75046'     /* 호남서비스센터 */
                                           , '71782'     /* 원주서비스센터 */
                                           , '71783'     /* 광양서비스센터 */
                                           , '71784' )   /* 광양지점 */
                         ) )
                </when>
                <when test='@MybatisUtils@equals(dayOfWeek, "2") or @MybatisUtils@equals(dayOfWeek, "4")'>   /* 화, 목 */
                  AND D3.VST_CNFMDT = TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD')
                  AND D4.OG_CD IN ( '71350'     /* 의정부지점 */
                                  , '71352'     /* 일산지점 */
                                  , '71355'     /* 인천지점 */
                                  , '71356'     /* 수원지점 */
                                  , '71367'     /* 하남지점 */
                                  , '71394'     /* Wells생산팀 */
                                  , '71623'     /* Wellsfarm */
                                  , '75041'     /* 북부서비스센터 */
                                  , '75041'     /* 서부서비스센터 */
                                  , '75043'     /* 남부서비스센터 */
                                  , '75044' )   /* 동부서비스센터 */
                </when>
                <when test='@MybatisUtils@equals(dayOfWeek, "5")'>   /* 금요일 */
                  AND D3.VST_CNFMDT BETWEEN TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 1, 'YYYYMMDD') AND TO_CHAR(TO_DATE(#{strtDt}, 'YYYYMMDD') + 3, 'YYYYMMDD')
                  AND D4.OG_CD IN ( '71350'     /* 의정부지점 */
                                  , '71352'     /* 일산지점 */
                                  , '71355'     /* 인천지점 */
                                  , '71356'     /* 수원지점 */
                                  , '71367'     /* 하남지점 */
                                  , '71394'     /* Wells생산팀 */
                                  , '71623'     /* Wellsfarm */
                                  , '75041'     /* 북부서비스센터 */
                                  , '75041'     /* 서부서비스센터 */
                                  , '75043'     /* 남부서비스센터 */
                                  , '75044'     /* 동부서비스센터 */
                                  , '71357'     /* 부산지점 */
                                  , '71359'     /* 원주지점 */
                                  , '71360'     /* 청주지점 */
                                  , '71361'     /* 서대구지점 */
                                  , '71363'     /* 광주지점 */
                                  , '71364'     /* 전주지점 */
                                  , '71365'     /* 제주지점 */
                                  , '75047'     /* 경북서비스센터 */
                                  , '75041'     /* 경남서비스센터 */
                                  , '75045'     /* 충청서비스센터 */
                                  , '75046'     /* 호남서비스센터 */
                                  , '71782'     /* 원주서비스센터 */
                                  , '71783'     /* 광양서비스센터 */
                                  , '71784' )   /* 광양지점 */
                </when>
               </choose>
               </when>
               </choose>
               <if test="@MybatisUtils@isNotEmpty(refriDivCd)">
                  AND D1.REFRI_DV_CD    = #{refriDivCd}
               </if>
               <if test="@MybatisUtils@isNotEmpty(sppDvCd)">
                  AND D1.ITM_IOST_DV_CD = #{sppDvCd}
               </if>
               <if test="@MybatisUtils@isNotEmpty(fshProcsCd)">
                <choose>
                <when test='!@MybatisUtils@equals(fshProcsCd, "20")'>
                  AND D3.VST_PRGS_STAT_CD IN ('00', '10')   /* 작업대기, 진행중 */
                </when>
                <otherwise>
                  AND D3.VST_PRGS_STAT_CD = #{fshProcsCd}
                </otherwise>
                </choose>
               </if>
               <if test="@MybatisUtils@isNotEmpty(pkgDvCd)">
                <choose>
                <when test='@MybatisUtils@equals(pkgDvCd, "1")'>
                  AND D9.PD_PRP_VAL01 BETWEEN '60100' AND '60799'
                </when>
                <when test='@MybatisUtils@equals(pkgDvCd, "2")'>
                  AND D9.PD_PRP_VAL01 BETWEEN '60801' AND '60805'
                </when>
                <when test='@MybatisUtils@equals(pkgDvCd, "3")'>
                  AND D9.PD_PRP_VAL01 BETWEEN '60810' AND '60821'
                </when>
                </choose>
               </if>
               <if test='@MybatisUtils@equals(ostrYn, "Y")'>
                  AND D1.OSTR_CNFMDT IS NOT NULL
               </if>
               <if test='@MybatisUtils@equals(ostrYn, "N")'>
                  AND D1.OSTR_CNFMDT IS NULL
               </if>
            </if>
             ) T1
         INNER JOIN TB_SSCT_CNTR_REL T2                /* 계약관계-(모종패키지 계약과 결합된) 웰스팜계약 */
            ON T2.OJ_DTL_CNTR_NO = T1.CNTR_NO
           AND T2.OJ_DTL_CNTR_SN = T1.CNTR_SN
         INNER JOIN TB_SSCT_CNTR_DTL T3                /* 계약상세-웰스팜 */
            ON T3.CNTR_NO = T2.BASE_DTL_CNTR_NO
           AND T3.CNTR_SN = T2.BASE_DTL_CNTR_SN
         INNER JOIN TB_PDBS_PD_BAS T4                  /* 상품기본-웰스팜 */
            ON T4.PD_CD   = T3.BASE_PD_CD
         INNER JOIN TB_SSCT_CNTR_CST_REL T5            /* 계약고객관계-웰스팜 */
            ON T5.DTL_CNTR_NO = T3.CNTR_NO
           AND T5.DTL_CNTR_SN = T3.CNTR_SN
         INNER JOIN TB_CUBS_CST_BAS T6                 /* 고객기본-웰스팜 */
            ON T6.CST_NO = T5.CST_NO
         INNER JOIN TB_PDBS_PD_BAS T7                  /* 상품기본-현재패키지 */
            ON T7.PD_CD     = T1.PDCT_PD_CD
         INNER JOIN TB_PDBS_PD_BAS T8                  /* 상품기본-배송패키지 */
            ON T8.PD_CD     = T1.SDING_PKG_PD_CD
         INNER JOIN TB_SSCT_CNTR_CST_REL T9            /* 계약고객관계-모종패키지 */
            ON T9.DTL_CNTR_NO = T1.CNTR_NO
           AND T9.DTL_CNTR_SN = T1.CNTR_SN
         INNER JOIN TB_CUBS_CST_BAS T10                /* 고객기본-모종패키지 */
            ON T10.CST_NO = T9.CST_NO
          LEFT OUTER JOIN TB_OGBS_PRTNR_BAS T11        /* 파트너기본 */
            ON T11.OG_TP_CD = T1.OG_TP_CD
           AND T11.PRTNR_NO = T1.PRTNR_NO
          LEFT OUTER JOIN TB_GBCO_ADR_BAS T12          /* 주소기본 */
            ON T12.ADR_ID = T10.ADR_ID
          LEFT OUTER JOIN TB_SVPD_BYZIP_SHPADR_IZ T13  /* 우편번호별배송처내역 */
            ON T13.NEW_ADR_ZIP = T12.NEW_ADR_ZIP
         WHERE T2.DTA_DL_YN          = 'N'
           AND T2.CNTR_REL_DTL_CD    = '216'   /* 모종결합(웰스팜+모종) */
           AND T3.DTA_DL_YN          = 'N'
           AND T3.CNTR_DTL_STAT_CD <![CDATA[<>]]> '303'   /* 계약취소 */
           AND T5.CNTR_CST_REL_TP_CD = '10'    /* 계약자 */
           AND T9.CNTR_CST_REL_TP_CD = '10'    /* 계약자 */
         ORDER BY T1.CNTR_NO, T1.CNTR_SN, T1.SPP_ORD_NO, T1.SPP_PLAN_SN
    </select>

    <update id="updateSdingSppPlanIzDpDt">
        UPDATE TB_SVPD_SDING_SPP_PLAN_IZ   /* 모종배송계획내역 */
           SET DP_DT = #{dpDt}
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN   = 'N'
           AND REFRI_DV_CD = '2'   /* 유상서비스 */
           AND OSTR_CNFMDT IS NULL
           AND CNTR_NO         = #{cntrNo}
           AND CNTR_SN         = #{cntrSn}
           AND SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
           AND SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND SPP_ORD_NO      = #{sppOrdNo}
           AND SPP_PLAN_SN     = #{sppPlanSn}
    </update>

    <select id="selectSdingSppCnfmIzCount" resultType="java.lang.Integer">
        SELECT 1
          FROM TB_SVPD_SDING_SPP_CNFM_IZ   /* 모종배송확정내역 */
         WHERE CNTR_NO         = #{cntrNo}
           AND CNTR_SN         = #{cntrSn}
           AND SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
           AND SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND SPP_ORD_NO      = #{sppOrdNo}
           AND SPP_PLAN_SN     = #{sppPlanSn}
           AND ROWNUM          = 1
    </select>

    <insert id="insertSdingSppCnfmIz">
        INSERT INTO TB_SVPD_SDING_SPP_CNFM_IZ   /* 모종배송확정내역 */
             (
               CNTR_NO              /* 계약번호 */
             , CNTR_SN              /* 계약일련번호 */
             , SV_BIZ_HCLSF_CD      /* 서비스업무대분류코드 */
             , SV_BIZ_DCLSF_CD      /* 서비스업무세분류코드 */
             , SPP_ORD_NO           /* 배송주문번호 */
             , SPP_PLAN_SN          /* 배송계획일련번호 */
             , CST_NM               /* 고객명 */
             , SDING_MCNR_CNTR_NO   /* 모종기계계약번호 */
             , SDING_MCNR_PD_CD     /* 모종기계상품코드 */
             , SDING_PKG_PD_CD      /* 모종패키지상품코드 */
             , SDING_PD_CD1         /* 모종상품코드1 */
             , SDING_QTY1           /* 모종수량1 */
             , SDING_SOW_DT1        /* 모종파종일자1 */
             , SDING_PD_CD2         /* 모종상품코드2 */
             , SDING_QTY2           /* 모종수량2 */
             , SDING_SOW_DT2        /* 모종파종일자2 */
             , SDING_PD_CD3         /* 모종상품코드3 */
             , SDING_QTY3           /* 모종수량3 */
             , SDING_SOW_DT3        /* 모종파종일자3 */
             , SDING_PD_CD4         /* 모종상품코드4 */
             , SDING_QTY4           /* 모종수량4 */
             , SDING_SOW_DT4        /* 모종파종일자4 */
             , SDING_PD_CD5         /* 모종상품코드5 */
             , SDING_QTY5           /* 모종수량5 */
             , SDING_SOW_DT5        /* 모종파종일자5 */
             , RCPDT                /* 접수일자 */
             , VST_DT               /* 방문일자 */
             , SPP_DUEDT            /* 배송예정일자 */
             , SPP_CNFMDT           /* 배송확정일자 */
             , MNGR_DV_CD           /* 관리자구분코드 */
             , OG_TP_CD             /* 조직유형코드 */
             , ICHR_PRTNR_NO        /* 담당파트너번호 */
             , CNTR_ADRPC_ID        /* 계약주소지ID */
             , REFRI_DV_CD          /* 유무상구분코드 */
             , RECAP_CS_AMT         /* 유상비용금액 */
             , DP_EPTT_NM           /* 입금예정자명 */
             , DP_DT                /* 입금일자 */
             , SPP_DV_CD            /* 배송구분코드 */
             , DTA_DL_YN            /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        VALUES
             (
               #{cntrNo}            /* 계약번호 */
             , #{cntrSn}            /* 계약일련번호 */
             , #{svBizHclsfCd}      /* 서비스업무대분류코드 */
             , #{svBizDclsfCd}      /* 서비스업무세분류코드 */
             , #{sppOrdNo}          /* 배송주문번호 */
             , #{sppPlanSn}         /* 배송계획일련번호 */
             , #{cstNm}             /* 고객명 */
             , #{sdingMcnrCntrNo}   /* 모종기계계약번호 */
             , #{sdingMcnrPdCd}     /* 모종기계상품코드 */
             , #{sdingPkgPdCd}      /* 모종패키지상품코드 */
             , #{sdingPdCd1}        /* 모종상품코드1 */
             , #{sdingQty1}         /* 모종수량1 */
             , #{sdingSowDt1}       /* 모종파종일자1 */
             , #{sdingPdCd2}        /* 모종상품코드2 */
             , #{sdingQty2}         /* 모종수량2 */
             , #{sdingSowDt2}       /* 모종파종일자2 */
             , #{sdingPdCd3}        /* 모종상품코드3 */
             , #{sdingQty3}         /* 모종수량3 */
             , #{sdingSowDt3}       /* 모종파종일자3 */
             , #{sdingPdCd4}        /* 모종상품코드4 */
             , #{sdingQty4}         /* 모종수량4 */
             , #{sdingSowDt4}       /* 모종파종일자4 */
             , #{sdingPdCd5}        /* 모종상품코드5 */
             , #{sdingQty5}         /* 모종수량5 */
             , #{sdingSowDt5}       /* 모종파종일자5 */
             , #{rcpDt}             /* 접수일자 */
             , #{vstDt}             /* 방문일자 */
             , #{sppDuedt}          /* 배송예정일자 */
             , #{sppCnfmdt}         /* 배송확정일자 */
             , #{mngrDvCd}          /* 관리자구분코드 */
             , #{ogTpCd}            /* 조직유형코드 */
             , #{ichrPrtnrNo}       /* 담당파트너번호 */
             , #{cntrAdrpcId}       /* 계약주소지ID */
             , #{refriDvCd}         /* 유무상구분코드 */
             , #{recapCsAmt}        /* 유상비용금액 */
             , #{dpEpttNm}          /* 입금예정자명 */
             , #{dpDt}              /* 입금일자 */
             , #{sppDvCd}           /* 배송구분코드 */
             , 'N'                  /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <update id="updateCstSvasIstAsnIzForCnfm">
        UPDATE TB_SVPD_CST_SVAS_IST_ASN_IZ   /* 고객서비스AS설치배정내역 */
           SET WK_ACPTE_STAT_CD = 'Y'
             , WK_ACPTE_DT      = TO_CHAR(SYSDATE, 'YYYYMMDD')
             , WK_ACPTE_HH      = TO_CHAR(SYSDATE, 'HH24MISS')
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN     = 'N'
           AND CST_SV_ASN_NO = #{cstSvAsnNo}
    </update>

    <update id="updateCstSvasIstAsnIzForInstl">
        UPDATE TB_SVPD_CST_SVAS_IST_ASN_IZ   /* 고객서비스AS설치배정내역 */
           SET WK_ACPTE_STAT_CD = 'Y'
             , WK_ACPTE_DT      = TO_CHAR(SYSDATE, 'YYYYMMDD')
             , WK_ACPTE_HH      = TO_CHAR(SYSDATE, 'HH24MISS')
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN       = 'N'
           AND SV_BIZ_HCLSF_CD = '1'
           AND WK_PRGS_STAT_CD NOT IN ('20', '71', '72')   /* 작업완료, 대기취소, 진행취소 */
           AND WK_EXCN_DT IS NULL
           AND CNTR_NO         = #{sdingMcnrCntrNo}
    </update>

    <update id="updateSdingSppPlanIzForCnfm">
        UPDATE TB_SVPD_SDING_SPP_PLAN_IZ   /* 모종배송계획내역 */
           SET DP_DT       = #{dpDt}
             , OSTR_CNFMDT = #{sppCnfmdt}
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN       = 'N'
           AND CNTR_NO         = #{cntrNo}
           AND CNTR_SN         = #{cntrSn}
           AND SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
           AND SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND SPP_ORD_NO      = #{sppOrdNo}
           AND SPP_PLAN_SN     = #{sppPlanSn}
           AND OSTR_CNFMDT IS NULL
    </update>

    <insert id="insertSvWkOstrIzs">
        INSERT INTO TB_SVST_SV_WK_OSTR_IZ   /* 서비스작업출고내역 */
             (
               CST_SV_ASN_NO         /* 고객서비스배정번호 */
             , WK_OSTR_SN            /* 작업출고일련번호 */
             , CNTR_NO               /* 계약번호 */
             , CNTR_SN               /* 계약일련번호 */
             , SV_BIZ_HCLSF_CD       /* 서비스업무대분류코드 */
             , SV_BIZ_DCLSF_CD       /* 서비스업무세분류코드 */
             , ITM_PD_CD             /* 품목상품코드 */
             , REFRI_DV_CD           /* 유무상구분코드 */
             , FST_PD_CD             /* 최초상품코드 */
             , FST_SELL_TP_CD        /* 최초판매유형코드 */
             , FST_PD_USWY_CD        /* 최초상품용도코드 */
             , FST_ITM_GD_CD         /* 최초품목등급코드 */
             , FST_VST_FSH_DT        /* 최초방문완료일자 */
             , FNL_PD_CD             /* 최종상품코드 */
             , FNL_SELL_TP_CD        /* 최종판매유형코드 */
             , FNL_PD_USWY_CD        /* 최종상품용도코드 */
             , FNL_ITM_GD_CD         /* 최종품목등급코드 */
             , FNL_VST_FSH_DT        /* 최종방문완료일자 */
             , USE_QTY               /* 사용수량 */
             , CSMR_UPRC_AMT         /* 소비자단가금액 */
             , FRE_EXPN_DC           /* 무료체험일수 */
             , FRE_EXPN_IST_DT       /* 무료체험설치일자 */
             , ITM_BIL_AMT           /* 품목청구금액 */
             , SV_BIL_AMT            /* 서비스청구금액 */
             , MNGR_DV_CD            /* 관리자구분코드 */
             , DGR1_LEVL_OG_ID       /* 1차레벨조직ID */
             , DGR2_LEVL_OG_ID       /* 2차레벨조직ID */
             , BRCH_OG_ID            /* 지점조직ID */
             , ICHR_PRTNR_NO         /* 담당파트너번호 */
             , OG_TP_CD              /* 조직유형코드 */
             , WK_WARE_NO            /* 작업창고번호 */
             , STKR_PRNT_YN          /* 스티커출력여부 */
             , RTNGD_RVPY_PROCS_YN   /* 반품수불처리여부 */
             , RTNGD_CONF_YN         /* 반품확인여부 */
             , REFR_AS_RCP_YN        /* 리퍼AS접수여부 */
             , DTA_DL_YN             /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        SELECT D2.CST_SV_ASN_NO
             , ( SELECT NVL(MAX(WK_OSTR_SN), 0)
                   FROM TB_SVST_SV_WK_OSTR_IZ
                  WHERE CST_SV_ASN_NO = D2.CST_SV_ASN_NO )
               + ROWNUM
             , D1.CNTR_NO
             , D1.CNTR_SN
             , D1.SV_BIZ_HCLSF_CD
             , D1.SV_BIZ_DCLSF_CD
             , D1.SDING_PD_CD
             , #{refriDvCd}
             , #{sdingPkgPdCd}
             , D5.SELL_TP_CD
             , D6.SV_PD_TP_CD
             , D5.PD_GD_CD
             , TO_CHAR(SYSDATE, 'YYYYMMDD')
             , #{sdingPkgPdCd}
             , D5.SELL_TP_CD
             , D6.SV_PD_TP_CD
             , D5.PD_GD_CD
             , TO_CHAR(SYSDATE, 'YYYYMMDD')
             , D1.SDING_QTY
             , 0
             , 2
             , TO_CHAR(SYSDATE, 'YYYYMMDD')
             , 0
             , 0
             , #{mngrDvCd}
             , '71314'
             , '99992'
             , '99992'
             , #{session.employeeIDNumber}
             , #{session.ogTpCd}
             , '100009'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
        <include refid="COMMON.insertSystemFieldValue" />
          FROM TB_SVPD_SDING_SPP_EXP_IZ D1           /* 모종배송예정내역 */
         INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ D2    /* 고객서비스AS설치대상내역 */
            ON D2.CNTR_NO         = D1.CNTR_NO
           AND D2.CNTR_SN         = D1.CNTR_SN
           AND D2.SV_BIZ_HCLSF_CD = D1.SV_BIZ_HCLSF_CD
           AND D2.SV_BIZ_DCLSF_CD = D1.SV_BIZ_DCLSF_CD
           AND D1.SPP_ORD_NO      = D2.SV_BIZ_HCLSF_CD || D2.RCPDT || SUBSTR(D2.AS_IST_OJ_NO, -5)
         INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ D3   /* 고객서비스AS설치배정내역 */
            ON D3.CST_SV_ASN_NO = D2.CST_SV_ASN_NO
         INNER JOIN TB_SSCT_CNTR_REL D4              /* 계약관계 */
            ON D4.OJ_DTL_CNTR_NO = D1.CNTR_NO
           AND D4.OJ_DTL_CNTR_SN = D1.CNTR_SN
         INNER JOIN TB_SSCT_CNTR_DTL D5              /* 계약상세 */
            ON D5.CNTR_NO = D4.BASE_DTL_CNTR_NO
           AND D5.CNTR_SN = D4.BASE_DTL_CNTR_SN
         INNER JOIN TB_PDBS_PD_BAS D6                /* 상품기본 */
            ON D6.PD_CD = #{sdingPkgPdCd}
         WHERE D1.DTA_DL_YN       = 'N'
           AND D2.DTA_DL_YN       = 'N'
           AND D3.DTA_DL_YN       = 'N'
           AND D4.DTA_DL_YN       = 'N'
           AND D4.CNTR_REL_DTL_CD = '216'   /* 모종결합 */
           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN D4.VL_STRT_DTM AND D4.VL_END_DTM
           AND D5.DTA_DL_YN       = 'N'
           AND D1.CNTR_NO         = #{cntrNo}
           AND D1.CNTR_SN         = #{cntrSn}
           AND D1.SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
           AND D1.SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND D1.SPP_ORD_NO      = #{sppOrdNo}
           AND D1.SPP_PLAN_SN     = #{sppPlanSn}
    </insert>

    <select id="selectCstSvWkRsIzCount" resultType="java.lang.Integer">
        SELECT 1
          FROM TB_SVPD_CST_SV_WK_RS_IZ
         WHERE CST_SV_ASN_NO = #{cstSvAsnNo}
           AND ROWNUM        = 1
    </select>

    <select id="selectAsTpCdInfo" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaSeedReleaseScheduleAsTpDvo">
        SELECT D1.AS_LCT_CD
             , D1.AS_PHN_CD
             , D1.AS_CAUS_CD
             , D1.SITE_AW_ATC_CD
             , CASE WHEN D2.PD_PRP_VAL01 || D2.PD_PRP_VAL31 IN ('60111000000','60112000000','60121000000','60122000000','60131000000','60132000000','60810000000') THEN '901R'
                    WHEN D2.PD_PRP_VAL01 || D2.PD_PRP_VAL31 IN ('60113000000','60114000000','60123000000','60124000000','60133000000','60134000000','60810000000') THEN '902R'
                    WHEN D2.PD_PRP_VAL01 || D2.PD_PRP_VAL31 IN ('60115000000','60116000000','60125000000','60126000000','60135000000','60136000000','60810000000') THEN '903R'
                    WHEN D2.PD_PRP_VAL01 || D2.PD_PRP_VAL31 IN ('60117000000','60118000000','60127000000','60128000000','60137000000','60138000000','60810000000') THEN '904R'
                    WHEN D2.PD_PRP_VAL01 || D2.PD_PRP_VAL31 IN ('60100000000') THEN '905R'
               END AS BAD_DV_CD
          FROM TB_SVPD_AS_TP_CD D1   /* AS유형코드 */
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D2   /* 상품각사속성상세 */
            ON D2.PD_CD = D1.PD_CD
         WHERE D1.DTA_DL_YN          = 'N'
           AND D1.PD_GRP_CD          = '11'
           AND D1.AS_LCT_CD          = '903G'
           AND D1.AS_PHN_CD          = '903P'
           AND D2.DTA_DL_YN          = 'N'
           AND D2.PD_EXTS_PRP_GRP_CD = 'PART'
           AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN D1.APY_STRTDT AND D1.APY_ENDDT
           AND D1.PD_CD              = #{sdingPdCd1}
           AND D1.SV_TP_CD           = #{svBizHclsfCd}
           AND D1.SV_ANA_HCLSF_CD    = #{svBizDclsfCd}
           AND ROWNUM                = 1
    </select>

    <update id="updateCstSvasIstAsnIz">
        UPDATE TB_SVPD_CST_SVAS_IST_ASN_IZ   /* 고객서비스AS설치배정내역 */
           SET WK_PRGS_STAT_CD   = '20'
             , WK_ACPTE_STAT_CD  = NVL(WK_ACPTE_STAT_CD, 'Y')
             , WK_ACPTE_DT       = NVL(WK_ACPTE_DT, TO_CHAR(SYSDATE, 'YYYYMMDD'))
             , WK_ACPTE_HH       = NVL(WK_ACPTE_HH, TO_CHAR(SYSDATE, 'HH24MISS'))
             , ARV_DT            = NVL(VST_DUEDT, TO_CHAR(SYSDATE, 'YYYYMMDD'))
             , ARV_HH            = NVL(VST_EXP_HH, TO_CHAR(SYSDATE, 'HH24MISS'))
             , WK_EXCN_DT        = TO_CHAR(SYSDATE, 'YYYYMMDD')
             , WK_EXCN_HH        = TO_CHAR(SYSDATE, 'HH24MISS')
             , WK_PRTNR_OG_TP_CD = #{session.ogTpCd}
             , WK_PRTNR_NO       = #{session.employeeIDNumber}
             , SITE_AW_PD_GRP_CD = '11'
             , SITE_AW_SV_TP_CD  = #{svBizHclsfCd}
             , SITE_AW_ATC_CD    = #{siteAwAtcCd}
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN     = 'N'
           AND CST_SV_ASN_NO = #{cstSvAsnNo}
    </update>

    <insert id="insertCstSvWkRsIz">
        INSERT INTO TB_SVPD_CST_SV_WK_RS_IZ   /* 고객서비스작업결과내역 */
             (
               CST_SV_ASN_NO                  /* 고객서비스배정번호 */
             , CNTR_NO                        /* 계약번호 */
             , CNTR_SN                        /* 계약일련번호 */
             , OG_ID                          /* 조직ID */
             , OG_TP_CD                       /* 조직유형코드 */
             , PRTNR_NO                       /* 파트너번호 */
             , PDCT_PD_CD                     /* 제품상품코드 */
             , SV_BIZ_HCLSF_CD                /* 서비스업무대분류코드 */
             , SV_BIZ_DCLSF_CD                /* 서비스업무세분류코드 */
             , VST_FSH_DT                     /* 방문완료일자 */
             , VST_FSH_HH                     /* 방문완료시간 */
             , REFRI_DV_CD                    /* 유무상구분코드 */
             , WK_PRGS_STAT_CD                /* 작업진행상태코드 */
             , AS_LCT_CD                      /* AS위치코드 */
             , AS_PHN_CD                      /* AS현상코드 */
             , AS_CAUS_CD                     /* AS원인코드 */
             , BAD_DV_CD                      /* 불량구분코드 */
             , SV_PROCS_FOM_CD                /* 서비스처리형태코드 */
             , SV_PROCS_CN                    /* 서비스처리내용 */
             , URGT_YN                        /* 긴급여부 */
             , CLN_YN                         /* 회수여부 */
             , AS_AK_RCP_YN                   /* AS요청접수여부 */
             , INF_CH_AK_YN                   /* 정보변경요청여부 */
             , ETC_CH_AK_YN                   /* 기타변경요청여부 */
             , IST_CTF_MTMS_FW_YN             /* 설치인증MMS발송여부 */
             , SFT_ACDN_YN                    /* 안전사고여부 */
             , PLS_SV_YN                      /* 플러스서비스여부 */
             , PESL_ARTC_DFRN_YN              /* 인적사항상이여부 */
             , TONEP_IST_OPT_YN               /* 더원정수기설치옵션여부 */
             , TONEP_RCVRY_OPT_YN             /* 더원정수기복구옵션여부 */
             , TONEP_FRISU_RCVRY_VT1_USE_YN   /* 더원정수기무상복구1회사용여부 */
             , CST_SIGN_HS_YN                 /* 고객서명본인여부 */
             , DCEVDN_CONF_YN                 /* 증빙서류확인여부 */
             , IST_FIT_YN                     /* 설치적합여부 */
             , DTA_DL_YN                      /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField" />
             )
        VALUES
             (
               #{cstSvAsnNo}
             , #{cntrNo}
             , #{cntrSn}
             , '99992'
             , #{session.ogTpCd}
             , #{session.employeeIDNumber}
             , #{sdingPkgPdCd}
             , #{svBizHclsfCd}
             , #{svBizDclsfCd}
             , TO_CHAR(SYSDATE, 'YYYYMMDD')
             , TO_CHAR(SYSDATE, 'HH24MISS')
             , #{refriDvCd}
             , '20'
             , #{asLctCd}
             , #{asPhnCd}
             , #{asCausCd}
             , #{badDvCd}
             , '906A'
             , #{svProcCn}
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , 'N'
             , ' '
             , 'N'
        <include refid="COMMON.insertSystemFieldValue" />
             )
    </insert>

    <update id="updateSdingSppPlanIzForPcsv">
        UPDATE TB_SVPD_SDING_SPP_PLAN_IZ   /* 모종배송계획내역 */
           SET CST_SV_ASN_NO = #{cstSvAsnNo}
             , WK_DT         = TO_CHAR(SYSDATE, 'YYYYMMDD')
             , OG_TP_CD      = #{session.ogTpCd}
             , WK_PRTNR_NO   = #{session.employeeIDNumber}
        <include refid="COMMON.updateSystemField"/>
         WHERE DTA_DL_YN       = 'N'
           AND CNTR_NO         = #{cntrNo}
           AND CNTR_SN         = #{cntrSn}
           AND SV_BIZ_HCLSF_CD = #{svBizHclsfCd}
           AND SV_BIZ_DCLSF_CD = #{svBizDclsfCd}
           AND SPP_ORD_NO      = #{sppOrdNo}
           AND SPP_PLAN_SN     = #{sppPlanSn}
    </update>


</mapper>
