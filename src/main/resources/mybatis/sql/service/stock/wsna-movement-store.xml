<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaMovementStoreMapper">

    <select id="selectMovementStores"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaMovementStoreDto$SearchRes">
        SELECT STR_IZ.STR_TP_CD   /*입고유형코드*/
             , STR_IZ.STR_WARE_NO /*입고창고번호*/
             , STR_IZ.STR_SN /*입고일련번호*/
             , STR_IZ.STR_RGST_DT /*입고등록일자*/
             , STR_IZ.DLVG_DLPNR_NO /*납품거래처번호*/
             , STR_IZ.ITM_STR_NO /*품목입고번호*/
             , STR_IZ.OSTR_TP_CD /*출고유형코드*/
             , STR_IZ.OSTR_WARE_NO /*출고창고번호*/
             , STR_IZ.OSTR_DT /*출고일자*/
             , STR_IZ.OSTR_SN /*출고일련번호*/
             , STR_IZ.ITM_OSTR_NO /*품목출고번호*/
             , WARE_IZ.WARE_NM /*창고명*/
          FROM TB_SVST_ITM_STR_IZ STR_IZ --품목입고내역
         INNER JOIN TB_SVST_ITM_OSTR_IZ OSTR_IZ --품목출고내역
            ON OSTR_IZ.ITM_OSTR_NO = STR_IZ.ITM_OSTR_NO
           AND OSTR_IZ.OSTR_SN = STR_IZ.OSTR_SN
         LEFT OUTER JOIN TB_SVST_MCBY_WARE_IZ WARE_IZ --월별창고
            ON STR_IZ.OSTR_WARE_NO = WARE_IZ.WARE_NO
           AND WARE_IZ.WARE_USE_YN = 'Y'
           AND WARE_IZ.APY_YM BETWEEN SUBSTR(#{stStrDt},1,6) AND SUBSTR(#{edStrDt},1,6)
         WHERE 1 = 1
           AND STR_IZ.STR_WARE_NO = #{strOjWareNo}
           AND STR_IZ.STR_CONF_DT IS NOT NULL
           AND STR_IZ.STR_RGST_DT BETWEEN #{stStrDt} AND #{edStrDt}
        <if test="@MybatisUtils@isNotEmpty(wareDvCd)">
           AND WARE_IZ.WARE_DV_CD = #{wareDvCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(strTpCd)">
           AND STR_IZ.STR_TP_CD = #{strTpCd}
        </if>
        <if test="@MybatisUtils@isEmpty(strTpCd)">
           AND STR_IZ.STR_TP_CD IN ('121','122','123','162','161')
        </if>
        GROUP BY STR_IZ.STR_TP_CD
                ,STR_IZ.STR_WARE_NO
                ,STR_IZ.STR_SN
                ,STR_IZ.STR_RGST_DT
                ,STR_IZ.DLVG_DLPNR_NO
                ,STR_IZ.ITM_STR_NO
                ,STR_IZ.OSTR_TP_CD
                ,STR_IZ.OSTR_WARE_NO
                ,STR_IZ.OSTR_DT
                ,STR_IZ.OSTR_SN
                ,STR_IZ.ITM_OSTR_NO
                ,WARE_IZ.WARE_NM
        ORDER BY STR_IZ.STR_TP_CD, STR_IZ.STR_WARE_NO, STR_IZ.STR_RGST_DT, STR_IZ.ITM_STR_NO


    </select>

    <select id="selectMoveMentStrIzs" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaMovementStoreDto$MovementRes">
       SELECT T1.STR_RGST_DT /*입고일자*/
            , T1.STR_TP_CD /*입고유형코드*/
            , T1.ITM_STR_NO /*품목입고번호*/
            , T1.ITM_PD_CD
            , T3.SVPD_NM_ABBR1 || ' 외' AS ITM_PD_NM
            , T1.STR_SN
            , T1.STR_WARE_NO /*입고창고번호*/
            , T2.WARE_NM  /*창고번호*/
         FROM TB_SVST_ITM_STR_IZ T1 /* 품목입고내역 */
       LEFT OUTER JOIN TB_SVST_MCBY_WARE_IZ T2
           ON T1.STR_WARE_NO = T2.WARE_NO
       INNER JOIN (<include refid="com.kyowon.sms.wells.web.service.common.BASE.selectPartMaster"/>) T3
           ON T3.SVPD_PD_CD = T1.ITM_PD_CD
        WHERE 1 = 1
          AND T1.STR_WARE_NO = #{strOjWareNo}
        <if test="@MybatisUtils@isNotEmpty(wareDvCd)">
          AND T2.WARE_DV_CD = #{wareDvCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(strTpCd)">
          AND T1.STR_TP_CD = #{strTpCd}
        </if>
        <if test="@MybatisUtils@isEmpty(strTpCd)">
          AND T1.STR_TP_CD IN ('121','122','123','162','161')
        </if>
          AND T2.APY_YM BETWEEN SUBSTR(#{stStrDt},1,6) AND SUBSTR(#{edStrDt},1,6)
          AND T1.STR_RGST_DT BETWEEN #{stStrDt} AND #{edStrDt}
          AND T1.STR_CONF_DT IS NULL
         ORDER BY STR_TP_CD, ITM_STR_NO ,STR_SN
    </select>

    <select id="selectMovementStoresMngt" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaMovementStoreDto$MovementOstrRes">
        SELECT T1.ITM_OSTR_NO
             , T1.WARE_MNGT_PRTNR_NO
             , T1.OSTR_TP_CD
             , T1.OSTR_WARE_NO
             , T1.OSTR_DT
             , T1.STR_WARE_NO
             , T1.ITM_STR_NO
             , T1.ACB_DT
             , T1.EVID_DV_CD
             , T1.STR_HOP_DT
             , T2.WARE_NM AS OSTR_WARE_NM
             , T4.WARE_NM AS STR_WARE_NM
             , T3.PD_NM || ' 외' AS PD_NM
          FROM TB_SVST_ITM_OSTR_IZ T1
         INNER JOIN TB_SVST_MCBY_WARE_IZ T2
            ON T1.OSTR_WARE_NO = T2.WARE_NO
         INNER JOIN TB_PDBS_PD_BAS T3
            ON T1.ITM_PD_CD = T3.PD_CD
         INNER JOIN TB_SVST_MCBY_WARE_IZ T4
            ON T1.STR_WARE_NO = T4.WARE_NO
         WHERE T2.APY_YM BETWEEN SUBSTR(#{stOstrDt}, 1, 6) AND SUBSTR(#{edOstrDt}, 1, 6)
           AND T1.STR_WARE_NO = #{strWareNo}
           AND T1.STR_CONF_DT IS NULL
           AND T1.OSTR_DT BETWEEN #{stOstrDt} AND #{edOstrDt}
           AND T1.OSTR_TP_CD IN ('221','222','223','261','262')
         <if test="@MybatisUtils@isNotEmpty(ostrTpCd)">
           AND T1.OSTR_TP_CD = #{ostrTpCd}
         </if>
         GROUP BY T1.ITM_OSTR_NO
             , T1.OSTR_TP_CD
             , T1.OSTR_WARE_NO
             , T1.OSTR_DT
             , T1.STR_WARE_NO
             , T1.ACB_DT
             , T1.EVID_DV_CD
             , T1.WARE_MNGT_PRTNR_NO
             , T1.ITM_STR_NO
             , T1.STR_HOP_DT
             , T2.WARE_NM
             , T4.WARE_NM
             , T3.PD_NM
         ORDER BY T1.OSTR_TP_CD, T1.OSTR_WARE_NO, T1.OSTR_DT
    </select>

    <select id="selectMovementStoresReg"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaMovementStoreDto$MovementOstrMngtRes">
        SELECT '1' AS CHK
             , 'I' AS FLAG
             , T1.ITM_OSTR_NO
             , T1.OSTR_TP_CD
             , T1.OSTR_WARE_NO
             , T1.OSTR_DT
             , T1.OSTR_SN
             , T1.ITM_PD_CD
             , T3.PD_NM
             , (SELECT F_CMZ_CD_NM('TNT_WELLS', 'LCT_ANGLE_CD', S2.ITM_LCT_ANGLE_VAL) || ' '
                     || F_CMZ_CD_NM('TNT_WELLS', 'LCT_COF_CD', S2.ITM_LCT_COF_VAL) || ' '
                     || F_CMZ_CD_NM('TNT_WELLS', 'LCT_FLOR_NO_CD', S2.ITM_LCT_FLOR_NO_VAL) || ' '
                     || F_CMZ_CD_NM('TNT_WELLS', 'LCT_MAT_GRP_CD', S2.ITM_LCT_MAT_GRP_CD)
                  FROM TB_SVST_CST_SV_ITM_LCT_IZ S2
                 WHERE S2.WARE_NO = CASE WHEN SUBSTR(T1.OSTR_AK_NO,1,1) = '2'
                                              AND #{stckStdGb} != '1'
                                         THEN '200012'
                                         ELSE T1.OSTR_AK_NO
                                     END
                   AND S2.ITM_PD_CD = T1.ITM_PD_CD
               ) AS ITEM_LOC /* 위치정보 */
             , T1.ITM_GD_CD
             , NVL((SELECT (CASE T1.ITM_GD_CD
                                 WHEN 'A' THEN S3.PITM_STOC_A_GD_QTY - S3.MMT_STOC_A_GD_QTY
                                 WHEN 'B' THEN S3.PITM_STOC_B_GD_QTY - S3.MMT_STOC_B_GD_QTY
                                 WHEN 'E' THEN S3.PITM_STOC_E_GD_QTY - S3.MMT_STOC_E_GD_QTY
                                 WHEN 'R' THEN S3.PITM_STOC_R_GD_QTY - S3.MMT_STOC_R_GD_QTY
                                 ELSE 0
                             END)
                      FROM TB_SVST_CST_SV_ITM_STOC_IZ  S3
                     WHERE S3.WARE_NO = T1.STR_WARE_NO
                       AND S3.ITM_PD_CD = T1.ITM_PD_CD)
               ,0) AS ON_QTY
             , T1.MNGT_UNIT_CD
             , T1.BOX_UNIT_QTY
             , NVL(T2.OSTR_AK_QTY,T1.OSTR_QTY) AS REQ_QTY
             , T1.OSTR_DT AS OUT_REG_DT
             , T1.OSTR_QTY
             , T1.OSTR_QTY AS QTY1/* QTY1, QTY2 */
             , T1.OSTR_QTY AS QTY2
             , T1.RMK_CN
             , NVL(T2.OSTR_CNFM_CD,0) AS OSTR_CNFM_CD
             , T1.OSTR_SN AS SER
             , T1.SELL_RCPDT
             , (SELECT NVL(SUM(S1.OSTR_QTY),0)
                  FROM TB_SVST_ITM_OSTR_IZ S1
                 WHERE S1.OSTR_AK_NO = T1.OSTR_AK_NO
                   AND S1.SELL_RCPDT IS NOT NULL
             ) IN_SUM
             , T4.PD_PRP_VAL15 /* ST101_BASE_GB */
             , T4.PD_PRP_VAL16 /* ST101_BASE_COLOR_GB */
             , T3.SAP_MAT_CD
          FROM TB_SVST_ITM_OSTR_IZ T1
          LEFT OUTER JOIN TB_SVST_ITM_OSTR_AK_IZ T2
            ON T1.OSTR_AK_NO = T2.OSTR_AK_NO
          INNER JOIN TB_PDBS_PD_BAS T3
            ON T1.ITM_PD_CD = T3.PD_CD
          INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL T4
            ON T3.PD_CD = T4.PD_CD AND T4.PD_EXTS_PRP_GRP_CD = 'PART'
         WHERE T1.ITM_OSTR_NO = #{itmOstrNo}
           AND T1.OSTR_WARE_NO = #{ostrWareNo}
           AND T1.STR_WARE_NO = #{strWareNo}
           AND T1.STR_CONF_DT IS NULL
         ORDER BY T1.OSTR_SN
    </select>

    <update id="editWareHouseStandardY" parameterType="String">
        UPDATE TB_SVST_MCBY_WARE_IZ
           SET STD_WARE_USE_YN = 'Y'
         WHERE APY_YM = #{baseYm}
           AND WARE_NO = #{wareNo}
    </update>

    <update id="editWareHouseStandardN" parameterType="String">
        UPDATE TB_SVST_MCBY_WARE_IZ
           SET STD_WARE_USE_YN = 'N'
         WHERE APY_YM = #{baseYm}
           AND WARE_NO = #{wareNo}
    </update>
</mapper>
