<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaInstAssignSetMapper">
    <select id="selectInstAssignSet" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaInstAssignSetDto$SearchRes">
      SELECT '0' AS CHK
           , T1.PD_NM
     	   , T1.PD_CD
           , SUBSTR(T1.SAP_MAT_CD,10,9) AS SAP_MAT_CD
           , V1.RSTR_CNDT_ID
           , V1.RSTR_CNDT_SN
           , V1.APY_STRTDT
           , V1.APY_ENDDT
          , V1.RSTR_CNDT_SRN_MARK_CN
          , RSTR_CNDT_VAL2
       FROM TB_SVPD_SV_RSTR_CNDT_BAS V1
 INNER JOIN WSMDBS.TB_PDBS_PD_BAS T1
         ON V1.RSTR_CNDT_VAL1 = T1.PD_CD
 INNER JOIN WSMDBS.TB_PDBS_PD_ECOM_PRP_DTL T3 /*상품각사속성상세*/
         ON T1.PD_CD = T3.PD_CD
        AND T3.PD_EXTS_PRP_GRP_CD = 'PART'
      WHERE RSTR_CNDT_ID = 'TC001'
        AND V1.RSTR_CNDT_SN = (SELECT MAX(SUB1.RSTR_CNDT_SN)
                                 FROM TB_SVPD_SV_RSTR_CNDT_BAS SUB1
                                WHERE SUB1.RSTR_CNDT_VAL1 = T1.PD_CD
                                  AND SUB1.RSTR_CNDT_ID = 'TC001'
                                  )
        <if test='@MybatisUtils@isNotEmpty(pdGrp)'>
        AND T3.PD_PRP_VAL20 = #{pdGrp}
        </if>
        <if test='@MybatisUtils@isNotEmpty(itmPdCd)'>
        AND T1.PD_CD = #{itmPdCd}
        </if>
     ORDER BY T1.PD_CD
    </select>

    <select id="selectInstAssignCnt" resultType="Integer">
        SELECT COUNT(1)
          FROM TB_SVPD_SV_RSTR_CNDT_BAS
         WHERE RSTR_CNDT_ID = 'TC001'
           AND RSTR_CNDT_SN = #{rstrCndtSn}
           AND RSTR_CNDT_VAL1 = #{pdCd}
    </select>

    <select id="selectInstAssignSeq" resultType="Integer">
        SELECT LPAD(NVL(MAX(RSTR_CNDT_SN),'0') + 1, 3, '0') AS RSTR_CNDT_SN
          FROM TB_SVPD_SV_RSTR_CNDT_BAS
         WHERE RSTR_CNDT_ID = 'TC001'
    </select>

    <update id="updateInstAssignBaseSet">
         UPDATE TB_SVPD_SV_RSTR_CNDT_BAS
            SET APY_STRTDT = TO_CHAR(SYSDATE, 'YYYYMMDD')
              , APY_ENDDT = TO_CHAR(TO_DATE(#{rstrCndtVal2},'YYYYMMDD')-1, 'YYYYMMDD')
              , RSTR_CNDT_SRN_MARK_CN = '해당 상품 배정은 '|| SUBSTR(#{rstrCndtVal2},5,2)||'/'||SUBSTR(#{rstrCndtVal2},7,2) ||'부터 접수 가능합니다.'
              , RSTR_CNDT_VAL2 = #{rstrCndtVal2}
              <include refid="COMMON.updateSystemField"/>
          WHERE RSTR_CNDT_ID = 'TC001'
           AND RSTR_CNDT_SN = #{rstrCndtSn}
           AND RSTR_CNDT_VAL1 = #{pdCd}
    </update>

    <insert id="insertInstAssignDtlSet">
        INSERT INTO TB_SVPD_SV_RSTR_CNDT_DTL
           (RSTR_CNDT_ID
          , RSTR_CNDT_SN
          , RSTR_CNDT_DTL_SN
          , CHNL_APY_DV_VAL
          , BIZ_APY_DV_VAL
          , DTA_DL_YN
          <include refid="COMMON.insertSystemField"/>
        )
        SELECT RSTR_CNDT_ID
             , #{rstrCndtSn}
             , RSTR_CNDT_DTL_SN
             , CHNL_APY_DV_VAL
             , BIZ_APY_DV_VAL
             , DTA_DL_YN
           <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_SVPD_SV_RSTR_CNDT_DTL
         WHERE RSTR_CNDT_ID = 'TC001'
           AND RSTR_CNDT_SN = 4
    </insert>

    <insert id="insertInstAssignBaseSet">
         INSERT INTO TB_SVPD_SV_RSTR_CNDT_BAS
              ( RSTR_CNDT_ID
               , RSTR_CNDT_SN
               , APY_STRTDT
               , APY_ENDDT
               , RSTR_CNDT_NM
               , RSTR_CNDT_SRN_MARK_CN
               , RSTR_CNDT_VAL1
               , RSTR_CNDT_VAL2
               , RSTR_CNDT_VAL_EPL1
               , RSTR_CNDT_VAL_EPL2
               , DTA_DL_YN
               <include refid="COMMON.insertSystemField"/>
              )
         VALUES
              ( 'TC001'
              , #{rstrCndtSn}
              ,  TO_CHAR(SYSDATE, 'YYYYMMDD')
              , TO_CHAR(TO_DATE(#{rstrCndtVal2},'YYYYMMDD')-1, 'YYYYMMDD')
              , '상품접수 시작일'
              ,  '해당 상품 배정은 '|| SUBSTR(#{rstrCndtVal2},5,2)||'/'||SUBSTR(#{rstrCndtVal2},7,2) ||'부터 접수 가능합니다.'
              , #{pdCd}
              , #{rstrCndtVal2}
              , '타임테이블 접수 상품코드'
              , '타임테이블 접수 시작일'
              , 'N'
              <include refid="COMMON.insertSystemFieldValue"/>
              )
    </insert>

    <delete id="deleteInstAssignSet">
        DELETE FROM TB_SVPD_SV_RSTR_CNDT_BAS
        WHERE RSTR_CNDT_ID = 'TC001'
          AND RSTR_CNDT_VAL1 =  #{pdCd}
          AND
    </delete>

</mapper>
