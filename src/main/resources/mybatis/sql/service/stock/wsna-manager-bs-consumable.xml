<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaManagerBsConsumableMapper">
    <select id="selectItems" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaManagerBsConsumableDto$SearchItmRes">
        /*SELECT T1.BFSVC_CSMB_DDLV_TP_CD
             , (SELECT Y.CSMB_PD_CD
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL Y
                 WHERE Y.MNGT_YM = T1.MNGT_YM
                   AND Y.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND Y.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND Y.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND Y.BFSVC_CSMB_DDLV_TP_CD = '1'
               ) AS FXN_PD_CD
             , (SELECT X.BOX_UNIT_QTY ||
                       F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', X.MNGT_UNIT_CD, 'ko')
                  FROM TB_SVST_BFSVC_CSMB_BASE_BAS X
                     , TB_SVST_BFSVC_CSMB_BASE_DTL Y
                 WHERE X.MNGT_YM = Y.MNGT_YM
                   AND X.CSMB_PD_CD = Y.CSMB_PD_CD
                   AND Y.MNGT_YM = T1.MNGT_YM
                   AND Y.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND Y.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND Y.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND Y.BFSVC_CSMB_DDLV_TP_CD = '1'
               ) AS FXN_PCKNG_UNIT
             , (SELECT Y.PD_NM
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
                     , TB_PDBS_PD_BAS Y
                 WHERE X.CSMB_PD_CD = Y.PD_CD
                   AND X.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND X.MNGT_YM = T1.MNGT_YM
                   AND X.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND X.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND X.BFSVC_CSMB_DDLV_TP_CD = '1'
               ) AS FXN_PD_NM
             , (SELECT Y.SAP_MAT_CD
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
                     , TB_PDBS_PD_BAS Y
                 WHERE X.CSMB_PD_CD = Y.PD_CD
                   AND X.MNGT_YM = T1.MNGT_YM
                   AND X.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND X.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND X.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND X.BFSVC_CSMB_DDLV_TP_CD = '1'
               ) AS FXN_SAP_MAT_CD
             , (SELECT Y.CSMB_PD_CD
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL Y
                 WHERE Y.MNGT_YM = T1.MNGT_YM
                   AND Y.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND Y.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND Y.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND Y.BFSVC_CSMB_DDLV_TP_CD = '2'
               ) AS APLC_PD_CD
             , (SELECT X.BOX_UNIT_QTY ||
                       F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', X.MNGT_UNIT_CD, 'ko')
                  FROM TB_SVST_BFSVC_CSMB_BASE_BAS X
                     , TB_SVST_BFSVC_CSMB_BASE_DTL Y
                 WHERE X.MNGT_YM = Y.MNGT_YM
                   AND X.CSMB_PD_CD = Y.CSMB_PD_CD
                   AND Y.MNGT_YM = T1.MNGT_YM
                   AND Y.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND Y.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND Y.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND Y.BFSVC_CSMB_DDLV_TP_CD = '2'
               ) AS APLC_PCKNG_UNIT
             , (SELECT Y.PD_NM
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
                     , TB_PDBS_PD_BAS Y
                 WHERE X.CSMB_PD_CD = Y.PD_CD
                   AND X.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND X.MNGT_YM = T1.MNGT_YM
                   AND X.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND X.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND X.BFSVC_CSMB_DDLV_TP_CD = '2'
               ) AS APLC_PD_NM
             , (SELECT Y.SAP_MAT_CD
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
                     , TB_PDBS_PD_BAS Y
                 WHERE X.CSMB_PD_CD = Y.PD_CD
                   AND X.MNGT_YM = T1.MNGT_YM
                   AND X.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND X.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND X.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND X.BFSVC_CSMB_DDLV_TP_CD = '2'
               ) AS APLC_SAP_MAT_CD
             , NULL AS QTY
          FROM TB_SVST_BFSVC_CSMB_BASE_DTL T1
             , TB_PDBS_PD_BAS T2
         WHERE T1.CSMB_PD_CD = T2.PD_CD
           AND T1.BFSVC_CSMB_DDLV_OJ_CD = '2'
           AND T1.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
<!--           AND T1.MNGT_YM = #{mngtYm}-->
         ORDER BY T1.BFSVC_CSMB_DDLV_TP_CD, T1.SORT_ODR

        */

        <!--@TODO TEMP_CODE :: 상품 데이터 정비되면 아래 쿼리 삭제-->
        SELECT T1.BFSVC_CSMB_DDLV_TP_CD
             , (SELECT Y.CSMB_PD_CD
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL Y
                 WHERE Y.MNGT_YM = T1.MNGT_YM
                   AND Y.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND Y.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND Y.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND Y.BFSVC_CSMB_DDLV_TP_CD = '1'
               ) AS FXN_PD_CD
             , (SELECT X.BOX_UNIT_QTY ||
                       F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', X.MNGT_UNIT_CD, 'ko')
                  FROM TB_SVST_BFSVC_CSMB_BASE_BAS X
                     , TB_SVST_BFSVC_CSMB_BASE_DTL Y
                 WHERE X.MNGT_YM = Y.MNGT_YM
                   AND X.CSMB_PD_CD = Y.CSMB_PD_CD
                   AND Y.MNGT_YM = T1.MNGT_YM
                   AND Y.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND Y.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND Y.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND Y.BFSVC_CSMB_DDLV_TP_CD = '1'
               ) AS FXN_PCKNG_UNIT
             , (SELECT Y.ITM_KNM
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
                     , TB_SVST_BFSVC_CSMB_BASE_BAS Y
                 WHERE X.MNGT_YM = Y.MNGT_YM
                   AND X.CSMB_PD_CD = Y.CSMB_PD_CD
                   AND X.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND X.MNGT_YM = T1.MNGT_YM
                   AND X.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND X.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND X.BFSVC_CSMB_DDLV_TP_CD = '1'
               ) AS FXN_PD_NM
             , (SELECT X.CSMB_PD_CD
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
                 WHERE X.MNGT_YM = T1.MNGT_YM
                   AND X.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND X.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND X.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND X.BFSVC_CSMB_DDLV_TP_CD = '1'
               ) AS FXN_SAP_MAT_CD
             , (SELECT Y.CSMB_PD_CD
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL Y
                 WHERE Y.MNGT_YM = T1.MNGT_YM
                   AND Y.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND Y.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND Y.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND Y.BFSVC_CSMB_DDLV_TP_CD = '2'
               ) AS APLC_PD_CD
             , (SELECT X.BOX_UNIT_QTY ||
                       F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', X.MNGT_UNIT_CD, 'ko')
                  FROM TB_SVST_BFSVC_CSMB_BASE_BAS X
                     , TB_SVST_BFSVC_CSMB_BASE_DTL Y
                 WHERE X.MNGT_YM = Y.MNGT_YM
                   AND X.CSMB_PD_CD = Y.CSMB_PD_CD
                   AND Y.MNGT_YM = T1.MNGT_YM
                   AND Y.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND Y.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND Y.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND Y.BFSVC_CSMB_DDLV_TP_CD = '2'
               ) AS APLC_PCKNG_UNIT
             , (SELECT Y.ITM_KNM
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
                     , TB_SVST_BFSVC_CSMB_BASE_BAS Y
                 WHERE X.MNGT_YM = Y.MNGT_YM
                   AND X.CSMB_PD_CD = Y.CSMB_PD_CD
                   AND X.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND X.MNGT_YM = T1.MNGT_YM
                   AND X.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND X.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND X.BFSVC_CSMB_DDLV_TP_CD = '2'
               ) AS APLC_PD_NM
             , (SELECT X.CSMB_PD_CD
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
                 WHERE X.MNGT_YM = T1.MNGT_YM
                   AND X.CSMB_PD_CD = T1.CSMB_PD_CD
                   AND X.BFSVC_CSMB_DDLV_OJ_CD = T1.BFSVC_CSMB_DDLV_OJ_CD
                   AND X.BFSVC_CSMB_DDLV_ORT_YN = T1.BFSVC_CSMB_DDLV_ORT_YN
                   AND X.BFSVC_CSMB_DDLV_TP_CD = '2'
               ) AS APLC_SAP_MAT_CD
             , NULL AS QTY
          FROM TB_SVST_BFSVC_CSMB_BASE_DTL T1
         WHERE T1.BFSVC_CSMB_DDLV_OJ_CD = '2'
           AND T1.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
           AND T1.MNGT_YM = #{mngtYm}
         ORDER BY T1.BFSVC_CSMB_DDLV_TP_CD, T1.SORT_ODR
    </select>

    <select id="selectBuildings" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaManagerBsConsumableDvo">
        SELECT M1.BLD_NM
             , M1.BLD_CD
             , M1.PRTNR_NO
             , M1.OG_CD
             , M1.PRTNR_KNM
             , M1.VST_CST_N
             , NVL(M2.WRFR, 0) AS WRFR
             , NVL(M2.BDT_INDV, 0) AS BDT_INDV
             , NVL(M2.BDT_CRP, 0) AS BDT_CRP
             , NVL(M2.ARCLE_INDV, 0) AS ARCLE_INDV
             , NVL(M2.ARCLE_CRP, 0) AS ARCLE_CRP
             , NVL(M2.WTR_SFTNR, 0) AS WTR_SFTNR
             , NVL(M2.CFF_MCHN, 0) AS CFF_MCHN
             , NVL(M2.MSGCR, 0) AS MSGCR
             , NVL(M2.DRYR, 0) AS DRYR
             , NVL(M2.WASH, 0) AS WASH
             , NVL(M2.ARDRSSR, 0) AS ARDRSSR
             , NVL(M2.SSCLING, 0) AS SSCLING
          FROM (SELECT A.PRTNR_NO
                     , A.PRTNR_KNM
                     , A.OG_CD
                     , B.BLD_CD
                     , B.BLD_NM
                     , COUNT(1) VST_CST_N
                  FROM TB_OGBS_MM_PRTNR_IZ A
                     , TB_OGBS_BLD_BAS B
                     , TB_OGBS_MM_OG_IZ C
                     , TB_SVPD_CST_SV_BFSVC_ASN_IZ D
                     , TB_SVPD_CST_SV_EXCN_IZ E
                 WHERE A.OG_TP_CD = B.OG_TP_CD
                   AND A.DTA_DL_YN = 'N'
                   AND B.CLO_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD')
                   AND A.BASE_YM = C.BASE_YM
                   AND A.OG_ID = C.OG_ID
                   AND B.OG_TP_CD = C.OG_TP_CD
                   AND B.BLD_CD = C.BLD_CD
                   AND C.OG_TP_CD = 'W02'
                   AND C.CLO_YN = 'N'
                   AND A.BASE_YM = D.ASN_OJ_YM
                   AND A.OG_TP_CD = D.CNFM_PSIC_PRTNR_OG_TP_CD
                   AND A.PRTNR_NO = D.CNFM_PSIC_PRTNR_NO
                   AND D.CNTR_NO = E.CNTR_NO
                   AND D.CNTR_SN = E.CNTR_SN
                   AND D.SV_BIZ_DCLSF_CD != '2140'
                   AND E.REQD_DT IS NULL
                   AND E.CPS_DT IS NULL
                   AND E.CNTR_DTL_STAT_CD = '101'
<!--                   AND A.CNTR_DT NOT BETWEEN TO_CHAR(TO_NUMBER('202304') - 1) || '05' AND '202304' || '01'-->
                   AND A.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                 GROUP BY A.PRTNR_NO, A.PRTNR_KNM, A.OG_CD, B.BLD_CD, B.BLD_NM
               ) M1
             , (SELECT T2.MNGT_PRTNR_OG_TP_CD
                     , T2.MNGT_PRTNR_NO
                     , SUM(CASE WHEN T3.PD_PRP_VAL20 = '1' AND T4.COPN_DV_CD = '1' THEN 1 ELSE 0 END) AS BDT_INDV
                     , SUM(CASE WHEN T3.PD_PRP_VAL20 = '1' AND T4.COPN_DV_CD = '2' THEN 1 ELSE 0 END) AS BDT_CRP
                     , SUM(CASE WHEN T3.PD_PRP_VAL20 = '2' THEN 1 ELSE 0 END) AS WRFR
                     , SUM(CASE WHEN T3.PD_PRP_VAL20 = '3' AND T4.COPN_DV_CD = '1' THEN 1 ELSE 0 END) AS ARCLE_INDV
                     , SUM(CASE WHEN T3.PD_PRP_VAL20 = '3' AND T4.COPN_DV_CD = '2' THEN 1 ELSE 0 END) AS ARCLE_CRP
                     , SUM(CASE WHEN T3.PD_PRP_VAL20 = '4' THEN 1 ELSE 0 END) AS WTR_SFTNR
                     , SUM(CASE WHEN T3.PD_PRP_VAL20 = '93' THEN 1 ELSE 0 END) AS MSGCR
                     , SUM(CASE WHEN T3.PD_PRP_VAL20 = '96' THEN 1 ELSE 0 END) AS CFF_MCHN
                     , 0 AS DRYR
                     , 0 AS WASH
                     , 0 AS ARDRSSR
                     , 0 AS SSCLING
<!--                 @TODO TEMP_CODE :: 아래 상품코드 추적 불가.. 해당 제품군 갯수 0개로 임시 처리  -->
<!--                     , SUM(CASE WHEN T2.PDCT_PD_CD IN ('49320000000' , '49321000000' , '49310000000') THEN 1 ELSE 0 END) AS DRYR건조기-->
<!--                     , SUM(CASE WHEN T2.PDCT_PD_CD IN ('49330000000' , '49341000000' , '49340000000') THEN 1 ELSE 0 END) AS WASH세탁기-->
<!--                     , SUM(CASE WHEN T2.PDCT_PD_CD IN ('49387000000' , '49378000000' , '49361000000', '49360000000', '49350000000', '49368000000') THEN 1 ELSE 0 END) AS ARDRSSR에어드레서-->
<!--                     , SUM(CASE WHEN T2.PDCT_PD_CD IN ('49394000000' , '49392000000' , '49393000000') THEN 1 ELSE 0 END) AS SSCLING삼성청소기-->
                     , COUNT(1) CNT
                  FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ T1
                     , TB_SVPD_CST_SV_EXCN_IZ T2
                     , (SELECT X.PD_CD
                             , Y.PD_PRP_VAL20
                          FROM TB_PDBS_PD_BAS X
                             , TB_PDBS_PD_ECOM_PRP_DTL Y
                         WHERE X.PD_CD = Y.PD_CD
                           AND Y.PD_EXTS_PRP_GRP_CD = 'PART'
                       ) T3
                     , TB_SSCT_CNTR_BAS T4
                 WHERE T1.CNTR_NO = T2.CNTR_NO
                   AND T1.CNTR_SN = T2.CNTR_SN
                   AND T2.PDCT_PD_CD = T3.PD_CD
                   AND T1.CNTR_NO = T4.CNTR_NO
                   AND T1.SV_BIZ_DCLSF_CD = '2140'
                   AND T2.REQD_DT IS NULL
                   AND T2.CPS_DT IS NULL
                   AND T2.CNTR_DTL_STAT_CD = '101'
                   AND T3.PD_PRP_VAL20 != '11'
                   AND T1.ASN_OJ_YM = #{mngtYm}
                 GROUP BY T2.MNGT_PRTNR_OG_TP_CD, T2.MNGT_PRTNR_NO
               ) M2
         WHERE M1.PRTNR_NO = M2.MNGT_PRTNR_NO(+)
           <if test='@MybatisUtils@isNotEmpty(bldCds)'>
           AND M1.BLD_CD IN (
                             <foreach collection="bldCds" item="bldCd" separator=", ">
                                #{bldCd}
                             </foreach>
                            )
           </if>
         ORDER BY M1.BLD_NM
    </select>

    <select id="selectItemQtys" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaManagerBsConsumableDvo">
        SELECT T2.SORT_ODR
             , T1.STR_WARE_NO
             , T1.CSMB_PD_CD
             , T1.SAP_MAT_CD
             , T1.BFSVC_CSMB_DDLV_QTY
             , (CASE WHEN T1.BFSVC_CSMB_DDLV_STAT_CD = '10' THEN '신청'
                     WHEN T1.BFSVC_CSMB_DDLV_STAT_CD = '20' THEN '신청확인'
                     WHEN T1.BFSVC_CSMB_DDLV_STAT_CD = '30' THEN '출고요청완료'
                     ELSE '미신청'
                 END
               ) AS REQ_YN
             , T2.BFSVC_CSMB_DDLV_TP_CD
          FROM TB_SVST_BFSVC_CSMB_DDLV_IZ T1
             , TB_SVST_BFSVC_CSMB_BASE_DTL T2
         WHERE T1.DTA_DL_YN = 'N'
           AND T1.BFSVC_CSMB_DDLV_OJ_CD = '2'
           AND T1.MNGT_YM = T2.MNGT_YM
           AND T1.BFSVC_CSMB_DDLV_OJ_CD = T2.BFSVC_CSMB_DDLV_OJ_CD
           AND T1.CSMB_PD_CD = T2.CSMB_PD_CD
           AND T1.MNGT_YM = #{mngtYm}
           AND T1.STR_WARE_NO = #{prtnrNo}
         ORDER BY T2.BFSVC_CSMB_DDLV_TP_CD, T2.SORT_ODR
    </select>

    <select id="selectItemFirstQtys" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaManagerBsConsumableDvo">
        SELECT T1.SORT_ODR
             , T1.BFSVC_CSMB_DDLV_TP_CD
             , '미신청' AS REQ_YN
             , #{prtnrNo} AS STR_WARE_NO
             , T1.CSMB_PD_CD AS FXN_PD_CD
             , T2.SVPD_SAP_CD AS FXN_SAP_CD
             , CASE WHEN T1.BFSVC_CSMB_DDLV_CMPT_BASE_CD = '1' THEN NVL(T1.BFSVC_CSMB_DDLV_UNIT_QTY, 0)
                    WHEN T1.BFSVC_CSMB_DDLV_CMPT_BASE_CD = '2' THEN NVL((CEIL(T2.ACC_CNT/T1.BFSVC_CSMB_DDLV_UNIT_ACC_N) * T1.BFSVC_CSMB_DDLV_UNIT_QTY), 0)
                END AS FXN_DDLV_UNIT_QTY
             , '' AS APLC_PD_CD
             , '' AS APLC_SAP_CD
             , NULL AS APLC_DDLV_UNIT_QTY
          FROM TB_SVST_BFSVC_CSMB_BASE_DTL T1
             , (SELECT A.CSMB_PD_CD
                     , B.SVPD_SAP_CD
                     , A.BFSVC_CSMB_DDLV_OJ_PD_GRP_CD
                     , A.BFSVC_CSMB_DDLV_OJ_ACC_TP_CD
                     , COUNT(1) AS ACC_CNT
                  FROM TB_SVST_BFSVC_CSMB_BASE_DTL A
                     , (SELECT A.SVPD_ITEM_KND
                             , A.SVPD_PD_CD
                             , A.SVPD_SAP_CD
                          FROM (SELECT T1.PD_CD AS SVPD_PD_CD
                                     , T1.SAP_MAT_CD AS SVPD_SAP_CD
                                     , T2.PD_PRP_VAL19 AS SVPD_ITEM_KND
                                  FROM TB_PDBS_PD_BAS T1
                                 INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL T2
                                    ON T1.PD_CD = T2.PD_CD
                                   AND T2.PD_EXTS_PRP_GRP_CD = 'PART'
                                   AND T2.DTA_DL_YN = 'N'
                               ) A
                         WHERE A.SVPD_PD_CD IN (SELECT Z.PDCT_PD_CD
                                                  FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ Y
                                                     , TB_SVPD_CST_SV_EXCN_IZ Z
                                                 WHERE Y.CNTR_NO = Z.CNTR_NO
                                                   AND Y.CNTR_SN = Z.CNTR_SN
                                                 GROUP BY Z.PDCT_PD_CD
                                               )
                       ) B
                     , (SELECT A.CST_SV_ASN_NO
                             , A.ASN_OJ_YM
                             , A.CNTR_NO
                             , B.COPN_DV_CD
                          FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ A
                             , TB_SSCT_CNTR_BAS B
                         WHERE A.CNTR_NO = B.CNTR_NO
                       ) C
                 WHERE A.BFSVC_CSMB_DDLV_OJ_PD_GRP_CD = B.SVPD_ITEM_KND
                   AND A.CSMB_PD_CD = B.SVPD_PD_CD
                   AND A.BFSVC_CSMB_DDLV_OJ_ACC_TP_CD = C.COPN_DV_CD
                   AND A.BFSVC_CSMB_DDLV_TP_CD = '1'
                   AND A.MNGT_YM = #{mngtYm}
                 GROUP BY A.CSMB_PD_CD, B.SVPD_SAP_CD, A.BFSVC_CSMB_DDLV_OJ_PD_GRP_CD, A.BFSVC_CSMB_DDLV_OJ_ACC_TP_CD
               ) T2
         WHERE T1.CSMB_PD_CD = T2.CSMB_PD_CD(+)
           AND T1.BFSVC_CSMB_DDLV_OJ_PD_GRP_CD = T2.BFSVC_CSMB_DDLV_OJ_PD_GRP_CD(+)
           AND T1.BFSVC_CSMB_DDLV_OJ_ACC_TP_CD = T2.BFSVC_CSMB_DDLV_OJ_ACC_TP_CD(+)
           AND T1.BFSVC_CSMB_DDLV_OJ_CD = '2'
           AND T1.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
           AND T1.MNGT_YM = #{mngtYm}
         UNION ALL
        SELECT X.SORT_ODR
             , X.BFSVC_CSMB_DDLV_TP_CD
             , '미신청' AS REQ_YN
             , #{prtnrNo} AS STR_WARE_NO
             , '' AS FXN_PD_CD
             , '' AS FXN_SAP_CD
             , NULL AS FXN_DDLV_UNIT_QTY
             , X.CSMB_PD_CD
             , (SELECT Y.SAP_MAT_CD
                  FROM TB_PDBS_PD_BAS Y
                 WHERE Y.PD_CD = X.CSMB_PD_CD
               ) AS APLC_SAP_CD
             , 0 AS APLC_DDLV_UNIT_QTY
          FROM TB_SVST_BFSVC_CSMB_BASE_DTL X
         WHERE X.BFSVC_CSMB_DDLV_OJ_CD = '2'
           AND X.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
           AND X.BFSVC_CSMB_DDLV_TP_CD = '2'
           AND X.MNGT_YM = #{mngtYm}
         ORDER BY BFSVC_CSMB_DDLV_TP_CD, SORT_ODR
    </select>

    <select id="selectManagerBsConsumableAplcClose" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaManagerBsConsumableDto$FindTmlmRes">
        SELECT BIZ_STRTDT
             , BIZ_STRT_HH
             , BIZ_ENDDT
             , BIZ_END_HH
          FROM TB_SVST_BIZ_CL_BAS
         WHERE CL_MNGT_DV_CD = '6'
           AND DTA_DL_YN = 'N'
           AND MNGT_YM = #{mngtYm}
    </select>

    <select id="selectManagerBsConsumableAplcFirstClose" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaManagerBsConsumableDto$FindTmlmRes">
        SELECT MIN(STNRD_YR||TO_CHAR(TO_DATE(STNRD_MN,'MM'),'MM')||TO_CHAR(TO_DATE(STNRD_DY,'DD'),'DD')) AS BIZ_STRTDT
             , MAX(STNRD_YR||TO_CHAR(TO_DATE(STNRD_MN,'MM'),'MM')||TO_CHAR(TO_DATE(STNRD_DY,'DD'),'DD')) AS BIZ_ENDDT
             , '' AS BIZ_STRT_HH
             , '' AS BIZ_END_HH
          FROM T_CMY_CALR_M
         WHERE TENANT_ID = 'TNT_BASE'
           AND STNRD_YR = SUBSTR(#{mngtYm},1,4)
           AND TO_CHAR(TO_DATE(STNRD_MN,'MM'),'MM') = SUBSTR(#{mngtYm},5,2)
           AND STNRD_YR||TO_CHAR(TO_DATE(STNRD_MN,'MM'),'MM')||TO_CHAR(TO_DATE(STNRD_DY,'DD'),'DD') NOT IN (
               WITH T AS
               (SELECT TO_DATE(SUBSTR(HLDY_APPY_START_DTM,1,8)) AS START_DATE
                     , TO_DATE(SUBSTR(HLDY_APPY_FINS_DTM,1,8)) AS END_DATE
                  FROM T_CMZ_HLDY_M
                 WHERE TENANT_ID = 'TNT_BASE'
                   AND (SUBSTR(HLDY_APPY_START_DTM,1,6) = #{mngtYm} OR SUBSTR(HLDY_APPY_FINS_DTM,1,6) = #{mngtYm})
               )
               SELECT TO_CHAR(START_DATE + LV - 1, 'YYYYMMDD') DT
                 FROM T
                    , (SELECT LEVEL LV
                         FROM DUAL
                      CONNECT BY LEVEL <![CDATA[<=]]> 99)
                WHERE LV <![CDATA[<=]]> END_DATE - START_DATE + 1
           )
    </select>

    <insert id="mergeManagerBsConsumableAplcClose">
         MERGE INTO TB_SVST_BIZ_CL_BAS T1
         USING (SELECT #{mngtYm} AS MNGT_YM
                     , #{bizStrtdt} AS BIZ_STRTDT
                     , #{bizStrtHh} || '00' AS BIZ_STRT_HH
                     , #{bizEnddt} AS BIZ_ENDDT
                     , #{bizEndHh} || '00' AS BIZ_END_HH
                  FROM DUAL
               ) T2
            ON (T1.MNGT_YM = T2.MNGT_YM
                AND T1.CL_MNGT_DV_CD = '6'
               )
          WHEN MATCHED THEN
        UPDATE
           SET T1.BIZ_STRTDT = T2.BIZ_STRTDT
             , T1.BIZ_STRT_HH = T2.BIZ_STRT_HH
             , T1.BIZ_ENDDT = T2.BIZ_ENDDT
             , T1.BIZ_END_HH = T2.BIZ_END_HH
             <include refid="COMMON.updateSystemField"/>
          WHEN NOT MATCHED THEN
        INSERT
             ( T1.MNGT_YM
             , T1.CL_MNGT_DV_CD
             , T1.BIZ_STRTDT
             , T1.BIZ_STRT_HH
             , T1.BIZ_ENDDT
             , T1.BIZ_END_HH
             , T1.DTA_DL_YN
             <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             ( T2.MNGT_YM
             , '6'
             , T2.BIZ_STRTDT
             , T2.BIZ_STRT_HH
             , T2.BIZ_ENDDT
             , T2.BIZ_END_HH
             , 'N'
             <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <insert id="mergeManagerBsConsumables">
         MERGE INTO TB_SVST_BFSVC_CSMB_DDLV_IZ T1
         USING (<foreach collection="list" item="item" separator="UNION ALL">
                SELECT #{item.mngtYm} AS MNGT_YM
                     , #{item.bfsvcCsmbDdlvOjCd} AS BFSVC_CSMB_DDLV_OJ_CD
                     , #{item.strWareNo} AS STR_WARE_NO
                     , #{item.csmbPdCd} AS CSMB_PD_CD
                     , #{item.sapMatCd} AS SAP_MAT_CD
                     , TO_NUMBER(#{item.bfsvcCsmbDdlvQty}) AS BFSVC_CSMB_DDLV_QTY
                     , #{item.bfsvcCsmbDdlvStatCd} AS BFSVC_CSMB_DDLV_STAT_CD
                  FROM DUAL
                </foreach>
               ) T2
            ON ( T1.MNGT_YM = T2.MNGT_YM
                 AND T1.BFSVC_CSMB_DDLV_OJ_CD = T2.BFSVC_CSMB_DDLV_OJ_CD
                 AND T1.STR_WARE_NO = T2.STR_WARE_NO
                 AND T1.CSMB_PD_CD = T2.CSMB_PD_CD
               )
          WHEN MATCHED THEN
        UPDATE
           SET T1.SAP_MAT_CD = T2.SAP_MAT_CD
             , T1.BFSVC_CSMB_DDLV_QTY = T2.BFSVC_CSMB_DDLV_QTY
             , T1.BFSVC_CSMB_DDLV_STAT_CD = T2.BFSVC_CSMB_DDLV_STAT_CD
             <include refid="COMMON.updateSystemField"/>
          WHEN NOT MATCHED THEN
        INSERT
             ( MNGT_YM
             , BFSVC_CSMB_DDLV_OJ_CD
             , STR_WARE_NO
             , CSMB_PD_CD
             , SAP_MAT_CD
             , BFSVC_CSMB_DDLV_QTY
             , BFSVC_CSMB_DDLV_STAT_CD
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             ( T2.MNGT_YM
             , T2.BFSVC_CSMB_DDLV_OJ_CD
             , T2.STR_WARE_NO
             , T2.CSMB_PD_CD
             , T2.SAP_MAT_CD
             , T2.BFSVC_CSMB_DDLV_QTY
             , T2.BFSVC_CSMB_DDLV_STAT_CD
             , 'N'
             <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>
</mapper>
