<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaManagerBsConsumableMapper">

    <select id="selectItems" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaManagerBsConsumableDvo">
        SELECT D1.BFSVC_CSMB_DDLV_TP_CD                               /* 배부유형코드 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '1'
                    THEN D1.CSMB_PD_CD
               END                               AS FXN_PD_CD         /* 고정품목코드 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '1'
                    THEN D3.BOX_UNIT_QTY || F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', D3.MNGT_UNIT_CD, #{session.langId})
               END                               AS FXN_PCKNG_UNIT    /* 고정포장단위 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '1'
                    THEN D2.PD_NM
               END                               AS FXN_PD_NM         /* 고정품목명 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '1'
                    THEN TO_CHAR(TO_NUMBER(D2.SAP_MAT_CD))
               END                               AS FXN_SAP_MAT_CD    /* 고정SAP자재코드 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '2'
                    THEN D1.CSMB_PD_CD
               END                               AS APLC_PD_CD        /* 신청품목코드 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '2'
                    THEN D3.BOX_UNIT_QTY || F_CMZ_CD_NM('TNT_WELLS', 'MNGT_UNIT_CD', D3.MNGT_UNIT_CD, #{session.langId})
               END                               AS APLC_PCKNG_UNIT   /* 신청포장단위 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '2'
                    THEN D2.PD_NM
               END                               AS APLC_PD_NM        /* 신청품목명 */
             , CASE WHEN D1.BFSVC_CSMB_DDLV_TP_CD = '2'
                    THEN TO_CHAR(TO_NUMBER(D2.SAP_MAT_CD))
               END                               AS APLC_SAP_MAT_CD   /* 신청SAP자재코드 */
             , NULL                              AS QTY               /* 수량 */
             , D1.CSMB_PD_CD                                          /* 소모품상품코드 */
             , TO_CHAR(TO_NUMBER(D2.SAP_MAT_CD)) AS SAP_MAT_CD        /* SAP자재코드 */
          FROM TB_SVST_BFSVC_CSMB_BASE_DTL D1
         INNER JOIN TB_PDBS_PD_BAS D2
            ON D2.PD_CD = D1.CSMB_PD_CD
         INNER JOIN TB_SVST_BFSVC_CSMB_BASE_BAS D3
            ON D3.MNGT_YM    = D1.MNGT_YM
           AND D3.CSMB_PD_CD = D1.CSMB_PD_CD
         WHERE D1.DTA_DL_YN              = 'N'
           AND D1.BFSVC_CSMB_DDLV_OJ_CD  = '2'
           AND D1.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
           AND D2.DTA_DL_YN              = 'N'
           AND D2.PD_TP_CD               = 'M'
           AND D3.DTA_DL_YN              = 'N'
           AND D1.MNGT_YM                = #{mngtYm}
           AND D3.MNGT_YM                = #{mngtYm}
         ORDER BY D1.BFSVC_CSMB_DDLV_TP_CD, D1.SORT_ODR, SAP_MAT_CD
    </select>

    <select id="selectManagerBsConsumableAplcClose" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaManagerBsConsumableDto$FindTmlmRes">
        SELECT BIZ_STRTDT
             , SUBSTR(BIZ_STRT_HH, 1, 4) AS BIZ_STRT_HH
             , BIZ_ENDDT
             , SUBSTR(BIZ_END_HH, 1, 4)  AS BIZ_END_HH
          FROM TB_SVST_BIZ_CL_BAS   /* 업무마감기본 */
         WHERE DTA_DL_YN     = 'N'
           AND CL_MNGT_DV_CD = '6'   /* 개인BS소모품신청 */
           AND MNGT_YM       = #{mngtYm}
    </select>

    <select id="selectManagerBsConsumableAplcFirstClose" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaManagerBsConsumableDto$FindTmlmRes">
          WITH T AS
             (
               SELECT TO_DATE(SUBSTR(HLDY_APPY_START_DTM, 1, 8), 'YYYYMMDD') AS START_DATE
                    , TO_DATE(SUBSTR(HLDY_APPY_FINS_DTM, 1, 8), 'YYYYMMDD')  AS END_DATE
                 FROM T_CMZ_HLDY_M   /* 휴일기본 */
                WHERE DEL_YN    = 'N'
                  AND TENANT_ID = 'TNT_WELLS'
                  AND ( HLDY_APPY_START_DTM LIKE #{mngtYm} || '%' OR HLDY_APPY_FINS_DTM LIKE #{mngtYm} || '%' )
             )
        SELECT MIN(STNRD_YR || STNRD_MN || STNRD_DY) AS BIZ_STRTDT
             , MAX(STNRD_YR || STNRD_MN || STNRD_DY) AS BIZ_ENDDT
             , ''                                    AS BIZ_STRT_HH
             , ''                                    AS BIZ_END_HH
          FROM T_CMY_CALR_M   /* 달력기본 */
         WHERE DEL_YN    = 'N'
           AND TENANT_ID = 'TNT_WELLS'
           AND STNRD_YR  = SUBSTR(#{mngtYm}, 1, 4)
           AND STNRD_MN  = SUBSTR(#{mngtYm}, 5, 2)
           AND STNRD_YR || STNRD_MN || STNRD_DY NOT IN ( SELECT TO_CHAR(START_DATE + LV - 1, 'YYYYMMDD') DT
                                                           FROM T
                                                          INNER JOIN
                                                              (
                                                                SELECT LEVEL LV
                                                                  FROM DUAL
                                                               CONNECT BY LEVEL <![CDATA[<=]]> 99
                                                              ) LV
                                                             ON LV.LV <![CDATA[<=]]> END_DATE - START_DATE + 1 )
    </select>

    <insert id="mergeManagerBsConsumableAplcClose">
         MERGE INTO TB_SVST_BIZ_CL_BAS TB_TGT   /* 업무마감기본 */
         USING
             (
               SELECT #{mngtYm}            AS MNGT_YM       /* 관리년월 */
                    , #{bizStrtdt}         AS BIZ_STRTDT    /* 업무시작일자 */
                    , #{bizStrtHh} || '00' AS BIZ_STRT_HH   /* 업무시작시간 */
                    , #{bizEnddt}          AS BIZ_ENDDT     /* 업무종료일자 */
                    , #{bizEndHh} || '00'  AS BIZ_END_HH    /* 업무종료시간 */
                 FROM DUAL
             ) TB_SRC
            ON
             (
                   TB_TGT.MNGT_YM       = TB_SRC.MNGT_YM
               AND TB_TGT.CL_MNGT_DV_CD = '6'   /* 개인BS소모품신청 */
             )
          WHEN MATCHED THEN
        UPDATE
           SET TB_TGT.BIZ_STRTDT  = TB_SRC.BIZ_STRTDT
             , TB_TGT.BIZ_STRT_HH = TB_SRC.BIZ_STRT_HH
             , TB_TGT.BIZ_ENDDT   = TB_SRC.BIZ_ENDDT
             , TB_TGT.BIZ_END_HH  = TB_SRC.BIZ_END_HH
        <include refid="COMMON.updateSystemField"/>
          WHEN NOT MATCHED THEN
        INSERT
             (
               TB_TGT.MNGT_YM         /* 관리년월 */
             , TB_TGT.CL_MNGT_DV_CD   /* 마감관리구분코드 */
             , TB_TGT.BIZ_STRTDT      /* 업무시작일자 */
             , TB_TGT.BIZ_STRT_HH     /* 업무시작시간 */
             , TB_TGT.BIZ_ENDDT       /* 업무종료일자 */
             , TB_TGT.BIZ_END_HH      /* 업무종료시간 */
             , TB_TGT.DTA_DL_YN       /* 데이터삭제여부 */
        <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             (
               TB_SRC.MNGT_YM
             , '6'
             , TB_SRC.BIZ_STRTDT
             , TB_SRC.BIZ_STRT_HH
             , TB_SRC.BIZ_ENDDT
             , TB_SRC.BIZ_END_HH
             , 'N'
        <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <select id="selectApplicationLimitQty" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaManagerBsConsumableDto$SearchLmQtyRes">
        SELECT TO_CHAR(TO_NUMBER(D2.SAP_MAT_CD)) AS SAP_MAT_CD
             , NVL(D1.BFSVC_CSMB_APLC_LM_QTY, 0) AS BFSVC_CSMB_APLC_LM_QTY
          FROM TB_SVST_BFSVC_CSMB_BASE_DTL D1   /* BS소모품기준상세 */
         INNER JOIN TB_PDBS_PD_BAS D2           /* 상품기본 */
            ON D2.PD_CD = D1.CSMB_PD_CD
         WHERE D1.DTA_DL_YN              = 'N'
           AND D1.BFSVC_CSMB_DDLV_OJ_CD  = '2'
           AND D1.BFSVC_CSMB_DDLV_TP_CD  = '2'
           AND D1.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
           AND D2.DTA_DL_YN              = 'N'
           AND D2.PD_TP_CD               = 'M'
           AND D1.MNGT_YM                = #{mngtYm}
    </select>

    <select id="selectManagerBsConsumables" resultType="camelMap">
        SELECT T1.BFSVC_CSMB_DDLV_STAT_CD            /* BS소모품배부상태코드 */
             , T1.REQ_YN                             /* 신청여부 */
             , T1.BLD_NM                             /* 빌딩명 */
             , T1.BLD_CD                             /* 빌딩코드 */
             , T1.PRTNR_NO                           /* 파트너번호 */
             , T1.OG_CD                              /* 조직코드 */
             , T1.PRTNR_KNM                          /* 파트너한글명 */
             , T1.VST_CST_N                          /* 방문계정수 */
             , NVL(T1.BDT_INDV, 0)   AS BDT_INDV     /* 비데(개인) */
             , NVL(T1.BDT_CRP, 0)    AS BDT_CRP      /* 비데(법인) */
             , NVL(T1.WRFR, 0)       AS WRFR         /* 정수기 */
             , NVL(T1.ARCLE_INDV, 0) AS ARCLE_INDV   /* 공기청정기(개인) */
             , NVL(T1.ARCLE_CRP, 0)  AS ARCLE_CRP    /* 공기청정기(법인) */
             , NVL(T1.WTR_SFTNR, 0)  AS WTR_SFTNR    /* 연수기 */
             , NVL(T1.MSGCR, 0)      AS MSGCR        /* 안마의자 */
             , NVL(T1.CFF_MCHN, 0)   AS CFF_MCHN     /* 커피머신 */
             , NVL(T1.DRYR, 0)       AS DRYR         /* 건조기 */
             , NVL(T1.WASH, 0)       AS WASH         /* 세탁기 */
             , NVL(T1.ARDRSSR, 0)    AS ARDRSSR      /* 에어드레서 */
             , NVL(T1.SSCLING, 0)    AS SSCLING      /* 삼성청소기 */
             , ${pivotColumns}                       /* PIVOT 컬럼 */
          FROM
             (
               SELECT /*+ USE_HASH(D1 D2 D4) NO_MERGE(D4) */
                      D5.BFSVC_CSMB_DDLV_STAT_CD
                    , CASE WHEN D5.BFSVC_CSMB_DDLV_STAT_CD IS NULL THEN ( SELECT MLNG_CNTN
                                                                            FROM T_CMZ_MLNG_D
                                                                           WHERE MLNG_ID   = 'MSG_TXT_NAPC'   /* 미신청 */
                                                                             AND TENANT_ID = 'TNT_BASE'
                                                                             AND LNG_ID    = #{session.langId} )
                           ELSE F_CMZ_CD_NM('TNT_WELLS', 'BFSVC_CSMB_DDLV_STAT_CD', D5.BFSVC_CSMB_DDLV_STAT_CD, #{session.langId})
                      END                  AS REQ_YN
                    , D1.PRTNR_NO
                    , D1.PRTNR_KNM
                    , D2.OG_CD
                    , D3.BLD_CD
                    , D3.BLD_NM
                    , NVL(D4.VST_CST_N, 0) AS VST_CST_N   /* 방문계정수 */
                    , D4.BDT_INDV                         /* 비데(개인) */
                    , D4.BDT_CRP                          /* 비데(법인) */
                    , D4.WRFR                             /* 정수기 */
                    , D4.ARCLE_INDV                       /* 공기청정기(개인) */
                    , D4.ARCLE_CRP                        /* 공기청정기(법인) */
                    , D4.WTR_SFTNR                        /* 연수기 */
                    , D4.MSGCR                            /* 안마의자 */
                    , D4.CFF_MCHN                         /* 커피머신 */
                    , D4.DRYR                             /* 건조기 */
                    , D4.WASH                             /* 세탁기 */
                    , D4.ARDRSSR                          /* 에어드레서 */
                    , D4.SSCLING                          /* 삼성청소기 */
                 FROM TB_OGBS_MM_PRTNR_IZ D1     /* 월파트너내역 */
                INNER JOIN TB_OGBS_MM_OG_IZ D2   /* 월조직내역 */
                   ON D2.BASE_YM  = D1.BASE_YM
                  AND D2.OG_TP_CD = D1.OG_TP_CD
                  AND D2.OG_ID    = D1.OG_ID
                INNER JOIN TB_OGBS_BLD_BAS D3    /* 빌딩기본 */
                   ON D3.OG_TP_CD = D2.OG_TP_CD
                  AND D3.BLD_CD   = D2.BLD_CD
                 LEFT OUTER JOIN
                    (
                      SELECT /*+ USE_HASH(S1 S2 S3) */
                             S1.CNFM_PSIC_PRTNR_NO
                           , S1.CNFM_PSIC_PRTNR_OG_TP_CD
                           , COUNT(1)                                                                                                                     AS VST_CST_N
                           , COUNT(CASE WHEN S5.PD_PRP_VAL20 = '1' AND S4.COPN_DV_CD = '1' THEN 1 END)                                                    AS BDT_INDV     /* 비데(개인) */
                           , COUNT(CASE WHEN S5.PD_PRP_VAL20 = '1' AND S4.COPN_DV_CD = '2' THEN 1 END)                                                    AS BDT_CRP      /* 비데(법인) */
                           , COUNT(CASE WHEN S5.PD_PRP_VAL20 = '2' THEN 1 END)                                                                            AS WRFR         /* 정수기 */
                           , COUNT(CASE WHEN S5.PD_PRP_VAL20 = '3' AND S4.COPN_DV_CD = '1' THEN 1 END)                                                    AS ARCLE_INDV   /* 공기청정기(개인) */
                           , COUNT(CASE WHEN S5.PD_PRP_VAL20 = '3' AND S4.COPN_DV_CD = '2' THEN 1 END)                                                    AS ARCLE_CRP    /* 공기청정기(법인) */
                           , COUNT(CASE WHEN S5.PD_PRP_VAL20 = '4' THEN 1 END)                                                                            AS WTR_SFTNR    /* 연수기 */
                           , COUNT(CASE WHEN S5.PD_PRP_VAL20 = '93' THEN 1 END)                                                                           AS MSGCR        /* 안마의자 */
                           , COUNT(CASE WHEN S5.PD_PRP_VAL20 = '96' THEN 1 END)                                                                           AS CFF_MCHN     /* 커피머신 */
                           , COUNT(CASE WHEN S5.PD_CD IN ('WM04100121' , 'WM04100152' , 'WM04100153') THEN 1 END)                                         AS DRYR         /* 건조기 */
                           , COUNT(CASE WHEN S5.PD_CD IN ('WM04100127' , 'WM04100155' , 'WM04100156') THEN 1 END)                                         AS WASH         /* 세탁기 */
                           , COUNT(CASE WHEN S5.PD_CD IN ('WM04100164', 'WM04100166', 'WM04100192', 'WM04100193', 'WM04100194', 'WM07101222') THEN 1 END) AS ARDRSSR      /* 에어드레서 */
                           , COUNT(CASE WHEN S5.PD_CD IN ('WM04100200', 'WM04100201', 'WM04100202') THEN 1 END)                                           AS SSCLING      /* 삼성청소기 */
                        FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ S1       /* 고객서비스BS배정내역 */
                       INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ S2   /* 고객서비스BS대상내역 */
                          ON S2.ASN_OJ_YM     = S1.ASN_OJ_YM
                         AND S2.CST_SV_ASN_NO = S1.CST_SV_ASN_NO
                       INNER JOIN TB_SVPD_CST_SV_EXCN_IZ S3       /* 고객서비스수행내역 */
                          ON S3.CNTR_NO = S1.CNTR_NO
                         AND S3.CNTR_SN = S1.CNTR_SN
                       INNER JOIN TB_SSCT_CNTR_BAS S4             /* 계약기본 */
                          ON S4.CNTR_NO = S1.CNTR_NO
                       INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S5      /* 상품각사속성상세 */
                          ON S5.PD_CD = S2.PDCT_PD_CD
                       WHERE S1.DTA_DL_YN                = 'N'
                         AND S1.CNFM_PSIC_PRTNR_OG_TP_CD = 'W02'
                         AND S1.VST_PRGS_STAT_CD IN ('00', '20')
                         AND S1.SV_BIZ_DCLSF_CD <![CDATA[<>]]> '2140'   /* 필터배송 제외 */
                         AND S2.DTA_DL_YN                = 'N'
                         AND S3.DTA_DL_YN                = 'N'
                         AND S4.DTA_DL_YN                = 'N'
                         AND S5.DTA_DL_YN                = 'N'
                         AND S5.PD_EXTS_PRP_GRP_CD       = 'PART'
                         AND S5.PD_PRP_VAL20 <![CDATA[<>]]> '11'   /* 모종제외 */
                         AND (    S1.VST_PRGS_STAT_CD = '20'
                               OR ( S1.VST_PRGS_STAT_CD = '00' AND S3.CNTR_DTL_STAT_CD = '101' )
                             )   /* 작업완료이거나 정상인 작업대기 건 */
                         AND S1.ASN_OJ_YM                = #{mngtYm}
                         AND S2.ASN_OJ_YM                = #{mngtYm}
                       GROUP BY S1.CNFM_PSIC_PRTNR_NO, S1.CNFM_PSIC_PRTNR_OG_TP_CD
                    ) D4
                   ON D4.CNFM_PSIC_PRTNR_NO       = D1.PRTNR_NO
                  AND D4.CNFM_PSIC_PRTNR_OG_TP_CD = D1.OG_TP_CD
                 LEFT OUTER JOIN
                    (
                      SELECT STR_WARE_NO
                           , MAX(BFSVC_CSMB_DDLV_STAT_CD) AS BFSVC_CSMB_DDLV_STAT_CD
                        FROM TB_SVST_BFSVC_CSMB_DDLV_IZ   /* BS소모품배부내역 */
                       WHERE DTA_DL_YN             = 'N'
                         AND BFSVC_CSMB_DDLV_OJ_CD = '2'
                         AND MNGT_YM               = #{mngtYm}
                       GROUP BY STR_WARE_NO
                    ) D5
                   ON D5.STR_WARE_NO = D1.PRTNR_NO
                INNER JOIN TB_OGBS_PRTNR_DTL D6
                   ON D6.PRTNR_NO = D1.PRTNR_NO
                  AND D6.OG_TP_CD = D1.OG_TP_CD
                WHERE D1.DTA_DL_YN = 'N'
                  AND D1.OG_TP_CD  = 'W02'
                  AND D2.DTA_DL_YN = 'N'
                  AND D2.OG_TP_CD  = 'W02'
                  AND D3.DTA_DL_YN = 'N'
                  AND D3.OG_TP_CD  = 'W02'
                  AND D6.DTA_DL_YN = 'N'
                  AND D6.OG_TP_CD  = 'W02'
                  AND D6.PSTN_DV_CD IN ('7', '10', '15')   /* 지점장, 팀장, 매니저 */
                  AND D1.BASE_YM   = #{mngtYm}
                  AND D2.BASE_YM   = #{mngtYm}
            <if test="@MybatisUtils@isNotEmpty(bldCds)">
                  AND D3.BLD_CD IN
                            <foreach collection="bldCds" item="item" open="(" close=")" separator=",">
                                    #{item}
                            </foreach>
            </if>
             ) T1
          LEFT OUTER JOIN
             (
               SELECT *
                 FROM
                    (
                      SELECT NVL(S2.STR_WARE_NO, S1.STR_WARE_NO)                      AS STR_WARE_NO
                           , TO_CHAR(TO_NUMBER(NVL(S2.SAP_MAT_CD, S1.SAP_MAT_CD)))    AS SAP_MAT_CD
                           , NVL(S2.BFSVC_CSMB_DDLV_QTY, S1.BFSVC_CSMB_DDLV_UNIT_QTY) AS BFSVC_CSMB_DDLV_UNIT_QTY
                        FROM
                           (
                             SELECT /*+ USE_HASH(D1 D2 D4) NO_MERGE(D4) */
                                    D2.PRTNR_NO AS STR_WARE_NO
                                  , D1.CSMB_PD_CD
                                  , D3.SAP_MAT_CD
                                  , CASE WHEN D1.BFSVC_CSMB_DDLV_CMPT_BASE_CD = '2'
                                         THEN NVL(D1.BFSVC_CSMB_DDLV_UNIT_QTY, 0)
                                         WHEN D1.BFSVC_CSMB_DDLV_CMPT_BASE_CD = '1'
                                          AND D1.BFSVC_CSMB_DDLV_UNIT_ACC_N <![CDATA[<>]]> 0
                                         THEN NVL( CEIL( SUM(D4.CNT) / D1.BFSVC_CSMB_DDLV_UNIT_ACC_N * D1.BFSVC_CSMB_DDLV_UNIT_QTY), 0)
                                         ELSE 0
                                    END       AS BFSVC_CSMB_DDLV_UNIT_QTY
                               FROM TB_SVST_BFSVC_CSMB_BASE_DTL D1   /* BS소모품기준상세 */
                              INNER JOIN TB_OGBS_MM_PRTNR_IZ D2      /* 월파트너내역 */
                                 ON D2.BASE_YM = D1.MNGT_YM
                              INNER JOIN TB_PDBS_PD_BAS D3           /* 상품기본 */
                                 ON D3.PD_CD = D1.CSMB_PD_CD
                               LEFT OUTER JOIN
                                  (
                                    SELECT /*+ USE_HASH(S1 S2 S3 O1)  */
                                           O1.PRTNR_NO
                                         , S4.COPN_DV_CD
                                         , S5.PD_PRP_VAL20
                                         , COUNT(1) AS CNT
                                      FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ S1       /* 고객서비스BS배정내역 */
                                     INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ S2   /* 고객서비스BS대상내역 */
                                        ON S2.ASN_OJ_YM     = S1.ASN_OJ_YM
                                       AND S2.CST_SV_ASN_NO = S1.CST_SV_ASN_NO
                                     INNER JOIN TB_SVPD_CST_SV_EXCN_IZ S3       /* 고객서비스수행내역 */
                                        ON S3.CNTR_NO = S1.CNTR_NO
                                       AND S3.CNTR_SN = S1.CNTR_SN
                                     INNER JOIN TB_SSCT_CNTR_BAS S4             /* 계약기본 */
                                        ON S4.CNTR_NO = S1.CNTR_NO
                                     INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S5      /* 상품각사속성상세 */
                                        ON S5.PD_CD = S2.PDCT_PD_CD
                                     INNER JOIN TB_OGBS_MM_PRTNR_IZ O1          /* 월파트너내역 */
                                        ON O1.BASE_YM  = S1.ASN_OJ_YM
                                       AND O1.OG_TP_CD = S1.CNFM_PSIC_PRTNR_OG_TP_CD
                                       AND O1.PRTNR_NO = S1.CNFM_PSIC_PRTNR_NO
                                     WHERE S1.DTA_DL_YN                = 'N'
                                       AND S1.CNFM_PSIC_PRTNR_OG_TP_CD = 'W02'
                                       AND S1.VST_PRGS_STAT_CD        IN ('00', '20')
                                       AND S2.DTA_DL_YN                = 'N'
                                       AND S3.DTA_DL_YN                = 'N'
                                       AND S4.DTA_DL_YN                = 'N'
                                       AND S5.DTA_DL_YN                = 'N'
                                       AND S5.PD_EXTS_PRP_GRP_CD       = 'PART'
                                       AND O1.DTA_DL_YN                = 'N'
                                       AND O1.OG_TP_CD                 = 'W02'
                                       AND (    S1.VST_PRGS_STAT_CD = '20'
                                             OR ( S1.VST_PRGS_STAT_CD = '00' AND S3.CNTR_DTL_STAT_CD = '101' )
                                           )   /* 작업완료이거나 정상인 작업대기 건 */
                                       AND S1.ASN_OJ_YM                = #{mngtYm}
                                       AND S2.ASN_OJ_YM                = #{mngtYm}
                                       AND O1.BASE_YM                  = #{mngtYm}
                                     GROUP BY O1.PRTNR_NO, S4.COPN_DV_CD, S5.PD_PRP_VAL20
                                  ) D4
                                 ON D4.PRTNR_NO     = D2.PRTNR_NO
                                AND D4.COPN_DV_CD   = NVL(D1.BFSVC_CSMB_DDLV_OJ_ACC_TP_CD, D4.COPN_DV_CD)
                                AND D4.PD_PRP_VAL20 = NVL(D1.BFSVC_CSMB_DDLV_OJ_PD_GRP_CD, D4.PD_PRP_VAL20)
                              WHERE D1.DTA_DL_YN              = 'N'
                                AND D1.BFSVC_CSMB_DDLV_OJ_CD  = '2'
                                AND D1.BFSVC_CSMB_DDLV_TP_CD  = '1'
                                AND D1.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
                                AND D2.DTA_DL_YN              = 'N'
                                AND D2.OG_TP_CD               = 'W02'
                                AND D3.DTA_DL_YN              = 'N'
                                AND D3.PD_TP_CD               = 'M'
                                AND D1.MNGT_YM                = #{mngtYm}
                                AND D2.BASE_YM                = #{mngtYm}
                              GROUP BY D2.PRTNR_NO, D1.CSMB_PD_CD, D3.SAP_MAT_CD, D1.BFSVC_CSMB_DDLV_CMPT_BASE_CD
                                  , NVL(D1.BFSVC_CSMB_DDLV_UNIT_QTY, 0), D1.BFSVC_CSMB_DDLV_UNIT_ACC_N, D1.BFSVC_CSMB_DDLV_UNIT_QTY
                              UNION ALL
                             SELECT D2.PRTNR_NO AS STR_WARE_NO
                                  , D1.CSMB_PD_CD
                                  , D3.SAP_MAT_CD
                                  , 0           AS BFSVC_CSMB_DDLV_UNIT_QTY
                               FROM TB_SVST_BFSVC_CSMB_BASE_DTL D1   /* BS소모품기준상세 */
                              INNER JOIN TB_OGBS_MM_PRTNR_IZ D2      /* 월파트너내역 */
                                 ON D2.BASE_YM = D1.MNGT_YM
                              INNER JOIN TB_PDBS_PD_BAS D3           /* 상품기본 */
                                 ON D3.PD_CD = D1.CSMB_PD_CD
                              WHERE D1.DTA_DL_YN              = 'N'
                                AND D1.BFSVC_CSMB_DDLV_OJ_CD  = '2'
                                AND D1.BFSVC_CSMB_DDLV_TP_CD  = '2'
                                AND D1.BFSVC_CSMB_DDLV_ORT_YN = 'Y'
                                AND D2.DTA_DL_YN              = 'N'
                                AND D2.OG_TP_CD               = 'W02'
                                AND D3.DTA_DL_YN              = 'N'
                                AND D3.PD_TP_CD               = 'M'
                                AND D1.MNGT_YM                = #{mngtYm}
                                AND D2.BASE_YM                = #{mngtYm}
                           ) S1
                        LEFT OUTER JOIN
                           (
                             SELECT STR_WARE_NO
                                  , CSMB_PD_CD
                                  , SAP_MAT_CD
                                  , NVL(BFSVC_CSMB_DDLV_QTY, 0) AS BFSVC_CSMB_DDLV_QTY
                               FROM TB_SVST_BFSVC_CSMB_DDLV_IZ   /* BS소모품배부내역 */
                              WHERE DTA_DL_YN             = 'N'
                                AND BFSVC_CSMB_DDLV_OJ_CD = '2'
                                AND MNGT_YM               = #{mngtYm}
                           ) S2
                          ON S2.CSMB_PD_CD  = S1.CSMB_PD_CD
                         AND S2.STR_WARE_NO = S1.STR_WARE_NO
                    ) DDLV
                PIVOT
                    (
                          SUM(BFSVC_CSMB_DDLV_UNIT_QTY)
                      FOR SAP_MAT_CD IN (${pivotInStr})
                    )
             ) T2
            ON T2.STR_WARE_NO = T1.PRTNR_NO
         ORDER BY T1.BLD_NM, T1.PRTNR_KNM
    </select>

    <insert id="mergeManagerBsConsumables">
         MERGE INTO TB_SVST_BFSVC_CSMB_DDLV_IZ TB_TGT   /* BS소모품배부내역 */
         USING
             (
               SELECT #{mngtYm}                  AS MNGT_YM
                    , #{bfsvcCsmbDdlvOjCd}       AS BFSVC_CSMB_DDLV_OJ_CD
                    , #{strWareNo}               AS STR_WARE_NO
                    , #{csmbPdCd}                AS CSMB_PD_CD
                    , LPAD(#{sapMatCd}, 18, '0') AS SAP_MAT_CD
                    , #{bfsvcCsmbDdlvQty}        AS BFSVC_CSMB_DDLV_QTY
                    , #{bfsvcCsmbDdlvStatCd}     AS BFSVC_CSMB_DDLV_STAT_CD
                 FROM DUAL
             ) TB_SRC
            ON
             (
                   TB_TGT.MNGT_YM               = TB_SRC.MNGT_YM
               AND TB_TGT.BFSVC_CSMB_DDLV_OJ_CD = TB_SRC.BFSVC_CSMB_DDLV_OJ_CD
               AND TB_TGT.STR_WARE_NO           = TB_SRC.STR_WARE_NO
               AND TB_TGT.CSMB_PD_CD            = TB_SRC.CSMB_PD_CD
             )
          WHEN MATCHED THEN
        UPDATE
           SET TB_TGT.SAP_MAT_CD              = TB_SRC.SAP_MAT_CD
             , TB_TGT.BFSVC_CSMB_DDLV_QTY     = TB_SRC.BFSVC_CSMB_DDLV_QTY
             , TB_TGT.BFSVC_CSMB_DDLV_STAT_CD = TB_SRC.BFSVC_CSMB_DDLV_STAT_CD
        <include refid="COMMON.updateSystemField"/>
          WHEN NOT MATCHED THEN
        INSERT
             (
               TB_TGT.MNGT_YM
             , TB_TGT.BFSVC_CSMB_DDLV_OJ_CD
             , TB_TGT.STR_WARE_NO
             , TB_TGT.CSMB_PD_CD
             , TB_TGT.SAP_MAT_CD
             , TB_TGT.BFSVC_CSMB_DDLV_QTY
             , TB_TGT.BFSVC_CSMB_DDLV_STAT_CD
             , TB_TGT.DTA_DL_YN
        <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             (
               TB_SRC.MNGT_YM
             , TB_SRC.BFSVC_CSMB_DDLV_OJ_CD
             , TB_SRC.STR_WARE_NO
             , TB_SRC.CSMB_PD_CD
             , TB_SRC.SAP_MAT_CD
             , TB_SRC.BFSVC_CSMB_DDLV_QTY
             , TB_SRC.BFSVC_CSMB_DDLV_STAT_CD
             , 'N'
        <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <select id="selectBfsvcCsmbDdlvIzByMngtYm" resultType="com.kyowon.sms.wells.web.service.stock.dvo.WsnaManagerBsConsumableDvo">
        SELECT D1.MNGT_YM
             , D1.BFSVC_CSMB_DDLV_OJ_CD
             , D1.STR_WARE_NO
             , D1.CSMB_PD_CD
             , D1.SAP_MAT_CD
             , D1.BFSVC_CSMB_DDLV_QTY
             , D1.BFSVC_CSMB_DDLV_STAT_CD
             , D1.OSTR_AK_NO
             , D1.OSTR_AK_SN
             , D3.BLD_CD
          FROM TB_SVST_BFSVC_CSMB_DDLV_IZ D1   /* BS소모품배부내역 */
         INNER JOIN TB_OGBS_MM_PRTNR_IZ D2     /* 월파트너내역 */
            ON D2.BASE_YM  = D1.MNGT_YM
           AND D2.PRTNR_NO = D1.STR_WARE_NO
         INNER JOIN TB_OGBS_MM_OG_IZ D3        /* 월조직내역 */
            ON D3.BASE_YM  = D2.BASE_YM
           AND D3.OG_TP_CD = D2.OG_TP_CD
           AND D3.OG_ID    = D2.OG_ID
         WHERE D1.DTA_DL_YN               = 'N'
           AND D1.BFSVC_CSMB_DDLV_OJ_CD   = '2'
           AND D1.BFSVC_CSMB_DDLV_STAT_CD = '20'   /* 신청확인 */
           AND D1.BFSVC_CSMB_DDLV_QTY <![CDATA[>]]> 0
           AND D2.DTA_DL_YN               = 'N'
           AND D2.OG_TP_CD                = 'W02'
           AND D3.DTA_DL_YN               = 'N'
           AND D3.OG_TP_CD                = 'W02'
           AND D1.MNGT_YM                 = #{mngtYm}
           AND D1.STR_WARE_NO             = #{strWareNo}
           AND D2.BASE_YM                 = #{mngtYm}
           AND D3.BASE_YM                 = #{mngtYm}
    </select>

    <select id="selectNewOstrAkNo" resultType="String">
        SELECT #{ostrAkTpCd} || #{ostrAkRgstDt} || LPAD(SQ_SVST_ITM_OSTR_AK_IZ$OSTR_AK_NO.NEXTVAL,7,'0') AS OSTR_AK_NO
          FROM DUAL
    </select>

    <update id="updateBfsvcCsmbDdlvIzOstrAkNoSn">
        UPDATE TB_SVST_BFSVC_CSMB_DDLV_IZ
           SET OSTR_AK_NO = #{ostrAkNo}
             , OSTR_AK_SN = #{ostrAkSn}
        <include refid="COMMON.updateSystemField"/>
         WHERE MNGT_YM               = #{mngtYm}
           AND BFSVC_CSMB_DDLV_OJ_CD = #{bfsvcCsmbDdlvOjCd}
           AND STR_WARE_NO           = #{strWareNo}
           AND CSMB_PD_CD            = #{csmbPdCd}
    </update>

    <update id="updateBfsvcCsmbDdlvIzDdlvStatCd">
        UPDATE TB_SVST_BFSVC_CSMB_DDLV_IZ
           SET BFSVC_CSMB_DDLV_STAT_CD = '30'
        <include refid="COMMON.updateSystemField"/>
         WHERE MNGT_YM               = #{mngtYm}
           AND BFSVC_CSMB_DDLV_OJ_CD = '2'
           AND STR_WARE_NO IN <foreach collection='strWareNos' item='strWareNo' open="(" close=")" separator=',' >
                                   #{strWareNo}
                              </foreach>
    </update>


</mapper>
