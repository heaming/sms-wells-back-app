<?xml version="1.0" encoding="UTF-8"?>
<!---
 ****************************************************************************************************
 * 프로그램 개요
 ****************************************************************************************************
 1. 모듈 : SNA (재고관리)
 2. 프로그램 ID : W-SV-U-0117M01 AS 출고요청 관리
 3. 작성자 : gs.piit130
 4. 작성일 : 2022.11.25
 ****************************************************************************************************
 * 프로그램 설명
 ****************************************************************************************************
 - 출고요청 관리 (http://localhost:3000/#/service/wwsna-out-of-storage-ask-mgt)
 ****************************************************************************************************
-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaOutOfStorageAskMngtMapper">

    <select id="selectOutOfStorageAsks"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaOutOfStorageAskMngtDto$SearchRes">
        SELECT OSTR_AK_TP_CD AS OSTR_AK_TP_CD /*출고요청번호*/
             , STR_OJ_WARE_NO AS STR_OJ_WARE_NO /*입고대상창고번호*/
             , OSTR_AK_NO AS OSTR_AK_NO /*출고요청번호*/
             , OSTR_AK_RGST_DT AS OSTR_AK_RGST_DT /*출고요청등록일자*/
             , STR_HOP_DT AS STR_HOP_DT /*입고희망일자*/
             , MAX(RECT_OSTR_DT) AS RECT_OSTR_DT /*최근출고일자*/
             , WARE_NM AS WARE_NM /*창고명*/
             , OSTR_OJ_WARE_NO /*출고대상창고번호*/
          FROM TB_SVST_ITM_OSTR_AK_IZ
             , TB_SVST_MCBY_WARE_IZ
         WHERE STR_OJ_WARE_NO = #{strOjWareNo} /*입고대상창고번호*/
           AND WARE_USE_YN='Y'
        <if test="@MybatisUtils@isEmpty(ostrAkTpCd)">
           AND OSTR_AK_TP_CD IN ('310','320','330')
        </if>
        <if test="@MybatisUtils@isNotEmpty(ostrAkTpCd)">
           AND OSTR_AK_TP_CD = #{ostrAkTpCd}
        </if>
           AND STR_HOP_DT BETWEEN #{startStrHopDt} AND #{endStrHopDt}
           AND OSTR_OJ_WARE_NO = WARE_NO
           AND APY_YM = SUBSTR(#{startStrHopDt},1,6)
           AND WARE_DV_CD = #{wareDvCd}
         GROUP BY OSTR_AK_TP_CD,STR_OJ_WARE_NO,OSTR_AK_RGST_DT,OSTR_AK_NO,STR_HOP_DT,OSTR_OJ_WARE_NO,WARE_NM
         ORDER BY OSTR_AK_TP_CD,STR_OJ_WARE_NO,OSTR_AK_RGST_DT,OSTR_AK_NO ASC
    </select>

    <select id="selectOutOfStorageAskItms"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaOutOfStorageAskMngtDto$FindRes">
        SELECT I1.OSTR_AK_NO
             , I1.OSTR_AK_TP_CD
             , I1.STR_OJ_WARE_NO AS STR_OJ_WARE_NO
             , W1.WARE_NM AS STR_OJ_WARE_NM
             , W1.WARE_MNGT_PRTNR_NO AS STR_OJ_STCK_MGR
             , I1.OSTR_AK_RGST_DT
             , I1.STR_HOP_DT
             , I1.OSTR_OJ_WARE_NO AS OSTR_OJ_WARE_NO
             , W2.WARE_NM AS OSTR_OJ_WARE_NM
             , W2.WARE_MNGT_PRTNR_NO AS OSTR_OJ_STCK_MGR
             , I1.RECT_OSTR_DT
             , NVL(I1.OVIV_TP_CD, '0') AS OVIV_TP_CD
             , P1.PD_PRP_VAL19 AS OSTR_ITM_NO
          FROM TB_SVST_ITM_OSTR_AK_IZ I1
         INNER JOIN TB_SVST_MCBY_WARE_IZ W1
            ON W1.APY_YM      = SUBSTR(I1.STR_HOP_DT,1,6)
           AND W1.WARE_NO     = I1.STR_OJ_WARE_NO
           AND W1.WARE_USE_YN = 'Y'
         INNER JOIN T_CMZ_CD_D C1
            ON C1.CD_VLD_VAL = I1.OSTR_AK_TP_CD
         INNER JOIN TB_SVST_MCBY_WARE_IZ W2
            ON W2.APY_YM      = SUBSTR(I1.STR_HOP_DT,1,6)
           AND W2.WARE_NO     = I1.STR_OJ_WARE_NO
           AND W2.WARE_USE_YN = 'Y'
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL P1
            ON I1.ITM_PD_CD          = P1.PD_CD
           AND P1.PD_EXTS_PRP_GRP_CD = 'PART'
         WHERE 1=1
           AND C1.CD_ID = 'OSTR_AK_TP_CD'
        <if test="@MybatisUtils@isNotEmpty(ostrAkNo)">
         AND I1.OSTR_AK_NO = #{ostrAkNo}
        </if>
           AND ROWNUM = 1
    </select>


    <select id="selectOutOfStorageItms"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaOutOfStorageAskMngtDto$OutOfRes">
        SELECT P1.SAP_MAT_CD
             , I1.ITM_PD_CD
             , I1.OSTR_AK_NO
             , I1.OSTR_AK_SN
             , I1.FST_RGST_DTM
             , I1.STR_HOP_DT
             , I1.ITM_CD
             , D1.PD_PRP_VAL19 AS ITEM_KND
             , P1.PD_ABBR_NM AS ITEM_NM
             , I1.OSTR_AK_WARE_DV_CD
             , I1.WARE_MNGT_PRTNR_NO
             , I1.OSTR_OJ_WARE_DV_CD
             , I1.OSTR_OJ_WARE_NO
             , I1.OSTR_WARE_MNGT_PRTNR_NO
             , I1.MNGT_UNIT_CD
             , I1.BOX_UNIT_QTY
             , I1.ITM_GD_CD
             , (SELECT NVL((SELECT DECODE(I1.ITM_GD_CD,'A',PITM_STOC_A_GD_QTY,'B',PITM_STOC_B_GD_QTY,'E',PITM_STOC_E_GD_QTY,'R',PITM_STOC_R_GD_QTY,0)
                                   - DECODE(I1.ITM_GD_CD,'A',MMT_STOC_A_GD_QTY,'B',MMT_STOC_B_GD_QTY,'E',MMT_STOC_E_GD_QTY,'R',MMT_STOC_R_GD_QTY,0)
                              FROM TB_SVST_CST_SV_ITM_STOC_IZ
                             WHERE 1=1
                               AND WARE_NO   = I1.STR_OJ_WARE_NO
                               AND ITM_PD_CD = I1.ITM_PD_CD
                           ),0
                          )
                  FROM DUAL
               ) AS ON_QTY
             , I1.OSTR_AK_QTY
             , I1.OSTR_CNFM_QTY
             , I1.RMK_CN
             , I1.RECT_OSTR_DT
             , I1.OSTR_AGG_QTY
             , T1.WAREHOUSE_QTY
             , S1.BASE_STOC_QTY
             , S1.SFT_STOC_QTY
             , T3.USE_QTY
             , T1.CENTER_QTY
             , T2.INDI_QTY
             , P1.IMG_APN_FILE_ID
             , NVL((SELECT SUM(DECODE(B3.SV_CNR_OG_ID,'',0,1)) AS CFRM_CNT
                      FROM TB_SVPD_CST_SVAS_IST_ASN_IZ A3
                      LEFT OUTER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ B3
                        ON A3.CST_SV_ASN_NO = B3.CST_SV_ASN_NO
                     INNER JOIN TB_SVST_MCBY_WARE_IZ C3
                        ON B3.SV_CNR_OG_ID = C3.OG_ID
                     INNER JOIN (SELECT MIN(BASE_DT) AS STRTDT
                                      , MAX(BASE_DT) AS ENDDT
                                   FROM (SELECT BASE_Y||BASE_MM||BASE_D AS BASE_DT
                                              , RANK() OVER (ORDER BY BASE_Y||BASE_MM||BASE_D) AS RN
                                           FROM TB_SVPD_SV_CLND_BAS
                                          WHERE 1=1
                                            AND BASE_Y||BASE_MM||BASE_D > TO_CHAR(SYSDATE,'YYYYMM')
                                            AND DF_YN IS NULL
                                            AND PHLD_YN IS NULL
                                            AND DOW_DV_CD IN ('2','3','4','5','6')
                                        )
                                  WHERE RN <![CDATA[<=]]> 5
                                )
                        ON VST_CNFMDT BETWEEN STRTDT AND ENDDT
                     WHERE 1=1
                       AND B3.MTR_STAT_CD IN ('1','2')
                       AND A3.WK_PRGS_STAT_CD IN ('00','10')
                       AND SUBSTR(B3.SV_BIZ_DCLSF_CD,1,1) = '1'
                       AND B3.SV_BIZ_DCLSF_CD NOT LIKE '13%'
                       AND B3.SV_BIZ_HCLSF_CD   = '1'
                       AND A3.SV_BIZ_HCLSF_CD   = '1'
                       AND C3.WARE_NO           = #{strOjWareNo}
                       AND A3.SITE_AW_PD_GRP_CD = D1.PD_PRP_VAL20
                       AND B3.PD_CD             = I1.ITM_PD_CD
                     GROUP BY C3.WARE_NO
                   ),0) AS CFRM_CNT
          FROM TB_SVST_ITM_OSTR_AK_IZ I1
         INNER JOIN TB_PDBS_PD_BAS P1
            ON I1.ITM_PD_CD = P1.PD_CD
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D1
            ON I1.ITM_PD_CD          = D1.PD_CD
           AND D1.PD_EXTS_PRP_GRP_CD = 'PART'
          LEFT OUTER JOIN (SELECT ITM_PD_CD
                                , SUM(DECODE(WARE_NO, #{ostrOjWareNo}, PITM_STOC_A_GD_QTY)) AS WAREHOUSE_QTY
                                , SUM(DECODE(WARE_NO, #{strOjWareNo}, PITM_STOC_A_GD_QTY)) AS CENTER_QTY
                             FROM TB_SVST_CST_SV_ITM_STOC_IZ
                            WHERE 1=1
                              AND WARE_NO IN (#{ostrOjWareNo}, #{strOjWareNo})
                            GROUP BY ITM_PD_CD
                          ) T1
             ON P1.PD_CD = T1.ITM_PD_CD
           LEFT OUTER JOIN TB_SVST_MCITM_BASE_SFT_STOC_IZ S1
             ON P1.PD_CD  = S1.PD_CD
            AND S1.APY_YM = TO_CHAR(SYSDATE,'YYYYMM')
           LEFT OUTER JOIN (SELECT A1.ITM_PD_CD
                                 , SUM(A1.PITM_STOC_A_GD_QTY) AS INDI_QTY
                              FROM TB_SVST_CST_SV_ITM_STOC_IZ A1
                             INNER JOIN TB_SVST_MCBY_WARE_IZ B1
                                ON A1.WARE_NO = B1.WARE_NO
                             WHERE 1=1
                               AND B1.APY_YM       = TO_CHAR(SYSDATE, 'YYYYMM')
                               AND B1.HGR_WARE_NO  = #{strOjWareNo}
                               AND B1.WARE_DV_CD   = '2'
                               AND B1.WARE_ICHR_NO != '000'
                             GROUP BY A1.ITM_PD_CD
                           ) T2
             ON P1.PD_CD = T2.ITM_PD_CD
           LEFT OUTER JOIN (SELECT A2.ITM_PD_CD
                                 , SUM(A2.USE_QTY) AS USE_QTY
                              FROM TB_SVST_SV_WK_OSTR_IZ A2
                             INNER JOIN TB_SVST_MCBY_WARE_IZ B2
                                ON A2.WK_WARE_NO = B2.WARE_NO
                             WHERE 1=1
                               AND SUBSTR(A2.FNL_VST_FSH_DT,1,6) = TO_CHAR(SYSDATE, 'YYYYMM')
                               AND B2.APY_YM       = TO_CHAR(SYSDATE, 'YYYYMM')
                               AND B2.HGR_WARE_NO  = #{strOjWareNo}
                               AND B2.WARE_DV_CD   = '2'
                             GROUP BY A2.ITM_PD_CD
                           ) T3
             ON P1.PD_CD = T3.ITM_PD_CD
          WHERE 1=1
            AND I1.OSTR_AK_NO = #{ostrAkNo}
            AND ( CASE WHEN TO_CHAR(SYSDATE,'YYYYMMDD') BETWEEN P1.SV_STRTDT AND P1.SV_ENDDT THEN 'Y'
                       ELSE 'N' END
                ) = 'Y'
            AND S1.WARE_NO = #{strOjWareNo}
          ORDER BY I1.OSTR_AK_SN
    </select>
    <select id="selectOstrObjectWarehouses"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaOutOfStorageAskMngtDto$SearchOstrObjectWarehouseRes">
        SELECT WARE_NO AS CODE_ID
             , WARE_NM AS CODE_NAME
             , WARE_MNGT_PRTNR_NO
          FROM TB_SVST_MCBY_WARE_IZ
         WHERE 1=1
           AND APY_YM = SUBSTR(#{apyYm},1,6)
           AND WARE_DV_CD = #{wareDvCd}
           AND WARE_ICHR_NO = #{wareIchrNo}
           AND WARE_USE_YN = 'Y'
        <if test="@MybatisUtils@equals(wareDvCd,'3')">
           ORDER BY WARE_NM
        </if>
        <if test="!@MybatisUtils@equals(wareDvCd,'3')">
           ORDER BY SORT_DV_VAL
        </if>

    </select>
    <delete id="deleteOutOfStorageAskItems">
        SELECT 1 FROM DUAL
<!--        DELETE FROM TB_SVST_ITM_OSTR_AK_IZ-->
<!--           WHERE 1=1-->
<!--             AND OSTR_AK_NO = #{ostrAkNo}-->
<!--             AND OSTR_AK_SN = #{ostrAkSn}-->
    </delete>
</mapper>
