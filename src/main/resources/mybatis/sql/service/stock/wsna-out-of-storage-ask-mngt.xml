<?xml version="1.0" encoding="UTF-8"?>
<!---
 ****************************************************************************************************
 * 프로그램 개요
 ****************************************************************************************************
 1. 모듈 : SNA (재고관리)
 2. 프로그램 ID : W-SV-U-0117M01 AS 출고요청 관리
 3. 작성자 : gs.piit130
 4. 작성일 : 2022.11.25
 ****************************************************************************************************
 * 프로그램 설명
 ****************************************************************************************************
 - 출고요청 관리 (http://localhost:3000/#/service/wwsna-out-of-storage-ask-mgt)
 ****************************************************************************************************
-->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaOutOfStorageAskMngtMapper">

    <select id="selectOutOfStorageAsks"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaOutOfStorageAskMngtDto$SearchRes">
        SELECT OSTR_AK_TP_CD AS OSTR_AK_TP_CD /*출고요청번호*/
             , STR_OJ_WARE_NO AS STR_OJ_WARE_NO /*입고대상창고번호*/
             , OSTR_AK_NO AS OSTR_AK_NO /*출고요청번호*/
             , OSTR_AK_RGST_DT AS OSTR_AK_RGST_DT /*출고요청등록일자*/
             , STR_HOP_DT AS STR_HOP_DT /*입고희망일자*/
             , MAX(RECT_OSTR_DT) AS RECT_OSTR_DT /*최근출고일자*/
             , WARE_NM AS WARE_NM /*창고명*/
             , OSTR_OJ_WARE_NO /*출고대상창고번호*/
          FROM TB_SVST_ITM_OSTR_AK_IZ
             , TB_SVST_MCBY_WARE_IZ
         WHERE STR_OJ_WARE_NO = #{strOjWareNo} /*입고대상창고번호*/
           AND WARE_USE_YN='Y'
        <if test="@MybatisUtils@isEmpty(ostrAkTpCd)">
           AND OSTR_AK_TP_CD IN ('310','320','330')
        </if>
        <if test="@MybatisUtils@isNotEmpty(ostrAkTpCd)">
           AND OSTR_AK_TP_CD = #{ostrAkTpCd}
        </if>
           AND STR_HOP_DT BETWEEN #{startStrHopDt} AND #{endStrHopDt}
           AND OSTR_OJ_WARE_NO = WARE_NO
           AND APY_YM = SUBSTR(#{startStrHopDt},1,6)
           AND WARE_DV_CD = #{wareDvCd}
         GROUP BY OSTR_AK_TP_CD,STR_OJ_WARE_NO,OSTR_AK_RGST_DT,OSTR_AK_NO,STR_HOP_DT,OSTR_OJ_WARE_NO,WARE_NM
         ORDER BY OSTR_AK_TP_CD,STR_OJ_WARE_NO,OSTR_AK_RGST_DT,OSTR_AK_NO ASC
    </select>

    <select id="selectOutOfStorageAskItms"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaOutOfStorageAskMngtDto$FindRes">
        SELECT I1.OSTR_AK_NO
             , I1.OSTR_AK_TP_CD
             , I1.STR_OJ_WARE_NO AS STR_OJ_WARE_NO
             , W1.WARE_NM AS STR_OJ_WARE_NM
             , W1.WARE_MNGT_PRTNR_NO AS STR_OJ_STCK_MGR
             , I1.OSTR_AK_RGST_DT
             , I1.STR_HOP_DT
             , I1.OSTR_OJ_WARE_NO AS OSTR_OJ_WARE_NO
             , W2.WARE_NM AS OSTR_OJ_WARE_NM
             , W2.WARE_MNGT_PRTNR_NO AS OSTR_OJ_STCK_MGR
             , I1.RECT_OSTR_DT
             , NVL(I1.OVIV_TP_CD, '0') AS OVIV_TP_CD
             , P1.PD_PRP_VAL19 AS OSTR_ITM_NO
          FROM TB_SVST_ITM_OSTR_AK_IZ I1
         INNER JOIN TB_SVST_MCBY_WARE_IZ W1
            ON W1.APY_YM      = SUBSTR(I1.STR_HOP_DT,1,6)
           AND W1.WARE_NO     = I1.STR_OJ_WARE_NO
           AND W1.WARE_USE_YN = 'Y'
         INNER JOIN T_CMZ_CD_D C1
            ON C1.CD_VLD_VAL = I1.OSTR_AK_TP_CD
         INNER JOIN TB_SVST_MCBY_WARE_IZ W2
            ON W2.APY_YM      = SUBSTR(I1.STR_HOP_DT,1,6)
           AND W2.WARE_NO     = I1.OSTR_OJ_WARE_NO
           AND W2.WARE_USE_YN = 'Y'
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL P1
            ON I1.ITM_PD_CD          = P1.PD_CD
           AND P1.PD_EXTS_PRP_GRP_CD = 'PART'
         WHERE 1=1
           AND C1.CD_ID = 'OSTR_AK_TP_CD'
        <if test="@MybatisUtils@isNotEmpty(ostrAkNo)">
         AND I1.OSTR_AK_NO = #{ostrAkNo}
        </if>
           AND ROWNUM = 1
    </select>


    <select id="selectOutOfStorageItms"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaOutOfStorageAskMngtDto$OutOfRes">
        SELECT B.SVPD_SAP_CD AS SAP_CD /*SAP코드*/
             , A.ITM_PD_CD AS ITM_PD_CD /*품목상품코드*/
             , B.SVPD_NM_KOR AS ITM_PD_NM /*품목상품명*/
             , A.OSTR_AK_NO AS OSTR_AK_NO /*출고요청번호*/
             , A.OSTR_AK_SN AS OSTR_AK_SN /*출고요청순번*/
             , A.OSTR_AK_TP_CD AS OSTR_AK_TP_CD /*출고요청유형코드*/
             , A.STR_HOP_DT AS STR_HOP_DT /*입고희망일자*/
             , A.MNGT_UNIT_CD AS MNGT_UNIT_CD /*관리단위코드*/
             , A.BOX_UNIT_QTY AS BOX_UNIT_QTY /*박스단위수량*/
             , A.ITM_GD_CD AS ITM_GD_CD /*품목등급코드*/
             , A.OSTR_AK_QTY AS OSTR_AK_QTY /*출고요청수량*/
             , A.OSTR_CNFM_QTY AS OSTR_CNFM_QTY /*출고확정수량*/
             , A.RMK_CN AS RMK_CN /*비고*/
             , A.RECT_OSTR_DT AS RECT_OSTR_DT /*최근출고일자*/
             , A.OSTR_WARE_MNGT_PRTNR_NO AS OSTR_WARE_MNGT_PRTNR_NO /*출고창고관리파트너번호*/
             , A.OSTR_OJ_WARE_NO AS OSTR_OJ_WARE_NO /*출고대상창고번호*/
             , A.STR_OJ_WARE_NO AS STR_OJ_WARE_NO /*입고대상창고번호*/
             <!-- TODO: 방문확정수량 쿼리 수정예정 -->
             , '0' AS CFRM_CNT /*방묵확정수량*/
             , B.SVPD_ITEM_KND AS ITM_KND
             , B.SVPD_ITEM_KND_NM AS ITM_KND_NM
             , B.SVPD_IMG_URL AS IMG_URL
             , A.OSTR_AK_WARE_DV_CD AS OSTR_AK_WARE_DV_CD
             , A.WARE_MNGT_PRTNR_NO AS WARE_MNGT_PRTNR_NO
             , NVL(T1.WAREHOUSE_QTY,0) AS WAREHOUSE_QTY
             , NVL(T1.CENTER_QTY,0) AS CENTER_QTY
             , NVL(T2.INDI_QTY,0) AS INDI_QTY
             , NVL(T3.USE_QTY , 0) AS USE_QTY
             , NVL(T4.BASE_STOC_QTY,0) AS BASE_STOC_QTY
             , NVL(T4.SFT_STOC_QTY,0) AS SFT_STOC_QTY
          FROM TB_SVST_ITM_OSTR_AK_IZ A
         INNER JOIN (<include refid="com.kyowon.sms.wells.web.service.common.BASE.selectPartMaster"/>) B
            ON B.SVPD_PD_CD = A.ITM_PD_CD
          LEFT OUTER JOIN (SELECT ITM_PD_CD
                                , SUM(DECODE(WARE_NO, #{ostrOjWareNo}, PITM_STOC_A_GD_QTY)) AS WAREHOUSE_QTY
                                , SUM(DECODE(WARE_NO, #{strOjWareNo}, PITM_STOC_A_GD_QTY)) AS CENTER_QTY
                             FROM TB_SVST_CST_SV_ITM_STOC_IZ
                            WHERE 1=1
                              AND WARE_NO IN (#{ostrOjWareNo}, #{strOjWareNo})
                            GROUP BY ITM_PD_CD
                          ) T1
           ON T1.ITM_PD_CD = B.SVPD_PD_CD
           LEFT OUTER JOIN (SELECT A1.ITM_PD_CD
                                 , SUM(A1.PITM_STOC_A_GD_QTY) AS INDI_QTY
                              FROM TB_SVST_CST_SV_ITM_STOC_IZ A1
                             INNER JOIN TB_SVST_MCBY_WARE_IZ B1
                                ON A1.WARE_NO = B1.WARE_NO
                             WHERE 1=1
                               AND B1.APY_YM       = TO_CHAR(SYSDATE, 'YYYYMM')
                               AND B1.HGR_WARE_NO  = #{strOjWareNo}
                               AND B1.WARE_DV_CD   = '2'
                               AND B1.WARE_DTL_DV_CD NOT IN ('20,30')
                               /*AND B1.WARE_ICHR_NO != '000'*/
                             GROUP BY A1.ITM_PD_CD
                           ) T2
             ON B.SVPD_PD_CD = T2.ITM_PD_CD
            LEFT OUTER JOIN (SELECT A2.ITM_PD_CD
                                  , SUM(A2.USE_QTY) AS USE_QTY
                              FROM TB_SVST_SV_WK_OSTR_IZ A2
                             INNER JOIN TB_SVST_MCBY_WARE_IZ B2
                                ON A2.WK_WARE_NO = B2.WARE_NO
                             WHERE 1=1
                               AND SUBSTR(A2.FNL_VST_FSH_DT,1,6) LIKE TO_CHAR(SYSDATE, 'YYYYMM')||'%'
                               AND B2.APY_YM       = TO_CHAR(SYSDATE, 'YYYYMM')
                               AND B2.HGR_WARE_NO  = #{strOjWareNo}
                               AND B2.WARE_DV_CD   = '2'
                             GROUP BY A2.ITM_PD_CD
                           ) T3
                     ON B.SVPD_PD_CD = T3.ITM_PD_CD
            LEFT OUTER JOIN TB_SVST_MCITM_BASE_SFT_STOC_IZ T4
              ON B.SVPD_PD_CD  = T4.PD_CD
             AND T4.APY_YM = TO_CHAR(SYSDATE,'YYYYMM')
             AND T4.WARE_NO = #{strOjWareNo}
           WHERE 1=1
             AND A.OSTR_AK_NO = #{ostrAkNo}
            ORDER BY A.OSTR_AK_SN
    </select>
    <select id="selectOstrObjectWarehouses"
            resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaOutOfStorageAskMngtDto$SearchOstrObjectWarehouseRes">
        SELECT WARE_NO AS CODE_ID
             , WARE_NM AS CODE_NAME
             , WARE_MNGT_PRTNR_NO
          FROM TB_SVST_MCBY_WARE_IZ
         WHERE 1=1
           AND APY_YM = SUBSTR(#{apyYm},1,6)
           AND WARE_DV_CD = #{wareDvCd}
           AND WARE_ICHR_NO = #{wareIchrNo}
           AND WARE_USE_YN = 'Y'
        <if test="@MybatisUtils@equals(wareDvCd,'3')">
           ORDER BY WARE_NM
        </if>
        <if test="!@MybatisUtils@equals(wareDvCd,'3')">
           ORDER BY SORT_DV_VAL
        </if>

    </select>
    <delete id="deleteOutOfStorageAskItems">
        UPDATE TB_SVST_ITM_OSTR_AK_IZ
           SET DTA_DL_YN = 'Y'
         WHERE 1 = 1
           AND OSTR_AK_NO = #{ostrAkNo}
           AND OSTR_AK_SN = #{ostrAkSn}
    </delete>

    <select id="selectNewOstrAkNo" resultType="java.lang.String">
        SELECT #{ostrAkTpCd} || #{ostrAkRgstDt} || LPAD(SQ_SVST_ITM_OSTR_AK_IZ$OSTR_AK_NO.NEXTVAL,7,'0') AS OSTR_AK_NO
          FROM DUAL
    </select>

    <insert id="insertOutOfStorageAskItems">
        INSERT INTO TB_SVST_ITM_OSTR_AK_IZ (  /* 품목출고요청내역 */
                  OSTR_AK_NO                    /* 출고요청번호 */
                , OSTR_AK_SN                    /* 출고요청일련번호 */
                , OSTR_AK_TP_CD                 /* 출고요청유형코드 */
                , STR_OJ_WARE_NO                /* 입고대상창고번호 */
                , OSTR_OJ_WARE_NO               /* 출고대상창고번호 */
                , OSTR_AK_RGST_DT               /* 출고요청등록일자 */
                , STR_HOP_DT                    /* 입고희망일자 */
                , OSTR_AK_WARE_DV_CD            /* 출고요청창고구분코드 */
                , WARE_MNGT_PRTNR_NO            /* 창고관리파트너번호 */
                , WARE_MNGT_PRTNR_OG_TP_CD      /* 창고관리파트너조직유형코드 */
                , OSTR_OJ_WARE_DV_CD            /* 출고대상창고구분코드 */
                , OSTR_WARE_MNGT_PRTNR_NO       /* 출고창고관리파트너번호 */
                , OSTR_WARE_MNGT_PRTNR_OG_TP_CD /* 출고창고관리파트너조직유형코드 */
                , ITM_PD_CD                     /* 품목상품코드 */
                , ITM_CD                        /* 품목코드 */
                , MNGT_UNIT_CD                  /* 관리단위코드 */
                , BOX_UNIT_QTY                  /* 박스단위수량 */
                , ITM_GD_CD                     /* 품목등급코드 */
                , OSTR_AK_QTY                   /* 출고요청수량 */
                , OSTR_CNFM_QTY                 /* 출고확정수량 */
                , RECT_OSTR_DT                  /* 최근출고일자 */
                , OSTR_AGG_QTY                  /* 출고누계수량 */
                , OVIV_TP_CD                    /* 배차유형코드 */
                , OSTR_CNFM_CD                  /* 출고확정코드 */
                , RMK_CN                        /* 비고내용 */
                , DTA_DL_YN                     /* 데이터삭제여부 */
                <include refid="COMMON.insertSystemField" />)
            VALUES (
                  #{ostrAkNo}
                , #{ostrAkSn}
                , #{ostrAkTpCd}
                , #{strOjWareNo}
                , #{ostrOjWareNo}
                , TO_CHAR(SYSDATE,'YYYYMMDD')
                , #{strHopDt}
                , (SELECT WARE_DV_CD
                     FROM TB_SVST_MCBY_WARE_IZ
                     WHERE 1 = 1
                      AND WARE_NO = #{strOjWareNo}
                      AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
                , (SELECT WARE_MNGT_PRTNR_NO
                     FROM TB_SVST_MCBY_WARE_IZ
                    WHERE 1 = 1
                      AND WARE_NO = #{strOjWareNo}
                      AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
                , (SELECT OG_TP_CD
                     FROM TB_SVST_MCBY_WARE_IZ
                    WHERE 1 = 1
                      AND WARE_NO = #{strOjWareNo}
                      AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
                , (SELECT WARE_DV_CD
                     FROM TB_SVST_MCBY_WARE_IZ
                     WHERE 1 = 1
                      AND WARE_NO = #{ostrOjWareNo}
                      AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
                , (SELECT WARE_MNGT_PRTNR_NO
                     FROM TB_SVST_MCBY_WARE_IZ
                    WHERE 1 = 1
                      AND WARE_NO = #{ostrOjWareNo}
                      AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
                , (SELECT OG_TP_CD
                     FROM TB_SVST_MCBY_WARE_IZ
                    WHERE 1 = 1
                      AND WARE_NO = #{ostrOjWareNo}
                      AND APY_YM = TO_CHAR(SYSDATE,'YYYYMM'))
                , #{itmPdCd}
                , #{itmCd}
                , #{mngtUnitCd}
                , #{boxUnitQty}
                , #{itmGdCd}
                , #{ostrAkQty}
                , #{ostrCnfmQty}
                , #{rectOstrDt}
                , #{ostrAggQty}
                , #{ovivTpCd}
                , #{ostrCnfmCd}
                , #{rmkCn}
                , 'N'
                <include refid="COMMON.insertSystemFieldValue" /> )


    </insert>

    <update id="updateOutOfStorageAskItmes">
        UPDATE TB_SVST_ITM_OSTR_AK_IZ
           SET OSTR_AK_QTY = #{ostrAkQty}
             , OSTR_CNFM_QTY = #{ostrCnfmQty}
             , RMK_CN = #{rmkCn}
             , BOX_UNIT_QTY = #{boxUnitQty}
        <include refid="COMMON.updateSystemField"/>
         WHERE OSTR_AK_NO = #{ostrAkNo}
           AND OSTR_AK_SN = #{ostrAkSn}
    </update>
</mapper>
