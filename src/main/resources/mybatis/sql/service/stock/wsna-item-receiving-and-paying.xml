<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaItemReceivingAndPayingMapper">

    <select id="selectReceiptsAndPaymentsPages" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaItemReceivingAndPayingDto$SearchRes" fetchSize="1000">
          WITH PD AS
             (
               SELECT T1.PD_CD
                    , T1.PD_ABBR_NM AS PD_NM
                    , T1.SAP_MAT_CD
                 FROM TB_PDBS_PD_BAS T1                     /* 상품기본 */
        <choose>
            <when test='@MybatisUtils@equals(strWareDvCd, "1")'>
                 LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL T2 /* 상품각사속성상세 */
                   ON T2.PD_CD              = T1.PD_CD
                  AND T2.PD_EXTS_PRP_GRP_CD = 'PART'
                  AND T2.DTA_DL_YN          = 'N'
            </when>
            <otherwise>
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL T2       /* 상품각사속성상세 */
                   ON T2.PD_CD              = T1.PD_CD
                  AND T2.PD_EXTS_PRP_GRP_CD = 'PART'
                  AND T2.DTA_DL_YN          = 'N'
            </otherwise>
        </choose>
                WHERE T1.PD_TP_CD     = 'M'
                  AND T1.DTA_DL_YN    = 'N'
                <if test="@MybatisUtils@isNotEmpty(itmPdCdFrom)">
                  AND T1.PD_CD        = #{itmPdCdFrom}
                </if>
	            <if test="@MybatisUtils@isNotEmpty(itmKnd)">
                  AND T2.PD_PRP_VAL19 = #{itmKnd}
                </if>
                <if test="@MybatisUtils@isNotEmpty(svMatGrpCd)">
                  AND T2.PD_PRP_VAL36 = #{svMatGrpCd}
                </if>
                <if test='@MybatisUtils@equals(useYn, "Y")'>
                  AND ( T2.PD_PRP_VAL32 IS NULL OR T2.PD_PRP_VAL32 = 'Y' )
                </if>
                <if test='@MybatisUtils@equals(useYn, "N")'>
                  AND T2.PD_PRP_VAL32 <![CDATA[<>]]> 'Y'
                </if>
                <if test="@MybatisUtils@isNotEmpty(sapMatCdFrom)">
                  AND T1.SAP_MAT_CD <![CDATA[>=]]> LPAD(#{sapMatCdFrom}, 18, '0')
                </if>
                <if test="@MybatisUtils@isNotEmpty(sapMatCdTo)">
                  AND T1.SAP_MAT_CD <![CDATA[<=]]> LPAD(#{sapMatCdTo}, 18, '0')
                </if>
                <if test="@MybatisUtils@isNotEmpty(sapMatCdFrom) or @MybatisUtils@isNotEmpty(sapMatCdTo)">
                  AND T1.SAP_MAT_CD IS NOT NULL
                </if>
                <if test='@MybatisUtils@isNotEmpty(sapMatDpcts)'>
                  AND T1.SAP_MAT_CD IS NOT NULL
                  AND T1.SAP_MAT_CD IN
                   <foreach collection="sapMatDpcts" item="sapMatDpct" open="(" close=")" separator=",">
                        LPAD(TRIM(#{sapMatDpct}), 18, '0')
                   </foreach>
                </if>
                <if test='@MybatisUtils@isNotEmpty(itmPdCds)'>
                  AND T1.PD_CD IN
                                <foreach collection="itmPdCds" item="itmPdCd" separator=", " open="(" close=")">
                                   #{itmPdCd}
                                </foreach>
                </if>
                <if test="@MybatisUtils@isNotEmpty(itmGrp)">
                  AND (    T2.PD_PRP_VAL20 = #{itmGrp}
                        OR EXISTS ( SELECT 1
                                      FROM TB_PDBS_PD_REL S1
                                     INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL S2
                                        ON S2.PD_CD = S1.BASE_PD_CD
                                     WHERE S1.DTA_DL_YN          = 'N'
                                       AND S1.PD_REL_TP_CD       = '14'   /* AS부품 */
                                       AND S2.DTA_DL_YN          = 'N'
                                       AND S2.PD_EXTS_PRP_GRP_CD = 'PART'
                                       AND S1.OJ_PD_CD           = T1.PD_CD
                                       AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN S1.VL_STRT_DTM AND S1.VL_END_DTM
                                       AND S2.PD_PRP_VAL20       = #{itmGrp} )
                      )
                </if>
             )
             , WARE AS
             (
               SELECT /*+ INLINE INDEX(TB_SVST_MCBY_WARE_IZ PK_SVST_MCBY_WARE_IZ) */
                      WARE_NO
                    , APY_YM
                 FROM TB_SVST_MCBY_WARE_IZ
                WHERE DTA_DL_YN      = 'N'
                  AND APY_YM         = SUBSTR(#{stFromYmd}, 1,6)
                  AND WARE_DV_CD     = #{strWareDvCd}
                  AND WARE_NO LIKE #{strWareDvCd} || '%'
              <if test="@MybatisUtils@isNotEmpty(strWareNoM)">
                  AND ( HGR_WARE_NO = #{strWareNoM} OR WARE_NO = #{strWareNoM} )
                  </if>
              <if test="@MybatisUtils@isNotEmpty(strWareNoD)">
                  AND WARE_NO        = #{strWareNoD}
              </if>
              <if test="@MybatisUtils@isNotEmpty(wareDtlDvCd)">
                  AND WARE_DTL_DV_CD = #{wareDtlDvCd}
              </if>
             )
        SELECT /*+ USE_NL(T1 T2 T3 T4 T5 T6 T7 T8 T9) */
               T1.PD_CD                                                             AS ITM_PD_CD               /* 품목코드 */
             , TO_CHAR(TO_NUMBER(T1.SAP_MAT_CD))                                    AS SAP_MAT_CD              /* SAP코드 */
             , T1.PD_NM                                                             AS ITM_PD_NM               /* 품목명 */
             , NVL(T2.BTD_STOC_A_GD_QTY, 0) + NVL(T2.BTD_STOC_B_GD_QTY, 0) + NVL(T2.BTD_STOC_E_GD_QTY, 0) + NVL(T2.BTD_STOC_R_GD_QTY, 0)
               + NVL(T2.STR_QTY, 0) + NVL(T2.RTNGD_STR_OTSD_QTY, 0) + NVL(T2.STR_CTR_QTY, 0)
               - NVL(T2.OSTR_QTY, 0) - NVL(T2.USE_QTY, 0) - NVL(T2.OSTR_CTR_QTY, 0) AS BAS_STOC_QTY            /* 기초재고수량 */
             , NVL(T3.PRCHS_STR_QTY, 0)                                             AS PRCHS_STR_QTY           /* 구매입고수량 */
             , NVL(T3.NOM_STR_QTY, 0)                                               AS NOM_STR_QTY             /* 정상입고수량 */
             , NVL(T3.QOM_ASN_STR_QTY, 0)                                           AS QOM_ASN_STR_QTY         /* 물량배정입고수량 */
             , NVL(T3.QOM_MMT_STR_QTY, 0)                                           AS QOM_MMT_STR_QTY         /* 물량이동입고수량 */
             , NVL(T3.RTNGD_STR_INSD_QTY, 0)                                        AS RTNGD_STR_INSD_QTY      /* 반품입고내부수량 */
             , NVL(T3.RTNGD_STR_OTSD_QTY, 0) + NVL(T6.RTNGD_STR_OTSD_QTY, 0)        AS RTNGD_STR_OTSD_QTY      /* 반품입고외부수량 */
             , NVL(T3.ETC_STR_QTY, 0)                                               AS ETC_STR_QTY             /* 기타입고수량 */
             , NVL(T9.STR_CTR_QTY, 0)                                               AS STR_CTR_QTY             /* 등급조정입고수량 */
             , NVL(T5.CNFM_PITM_STR_GAP_QTY, 0)                                     AS CNFM_PITM_STR_GAP_QTY   /* 재고실사입고수량 */
             , NVL(T3.STR_QTY, 0) + NVL(T6.RTNGD_STR_OTSD_QTY, 0)
               + NVL(T9.STR_CTR_QTY, 0) + NVL(T5.CNFM_PITM_STR_GAP_QTY, 0)          AS STR_QTY                 /* 입고수량 합계 */
             , NVL(T4.NOM_OSTR_QTY, 0)                                              AS NOM_OSTR_QTY            /* 정상출고수량 */
             , NVL(T4.SVC_NOM_OSTR_QTY, 0)                                          AS SVC_NOM_OSTR_QTY        /* 서비스센터 정상출고수량 */
             , NVL(T4.SELL_NOM_OSTR_QTY, 0)                                         AS SELL_NOM_OSTR_QTY       /* 영업센터 정상출고수량 */
             , NVL(T4.QOM_ASN_OSTR_QTY, 0)                                          AS QOM_ASN_OSTR_QTY        /* 물량배정출고수량 */
             , NVL(T4.QOM_MMT_OSTR_QTY, 0)                                          AS QOM_MMT_OSTR_QTY        /* 물량이동출고수량 */
             , NVL(T4.RTNGD_OSTR_INSD_QTY, 0)                                       AS RTNGD_OSTR_INSD_QTY     /* 반품출고내부수량 */
             , NVL(T4.RTNGD_OSTR_OTSD_QTY, 0)                                       AS RTNGD_OSTR_OTSD_QTY     /* 반품출고외부수량 */
             , NVL(T6.USE_QTY, 0)                                                   AS USE_QTY                 /* 작업출고수량 */
             , NVL(T7.YEAR_IN_USE_QTY, 0)                                           AS YEAR_IN_USE_QTY         /* 1년내 작업출고수량 */
             , NVL(T8.YEAR_OUT_USE_QTY, 0)                                          AS YEAR_OUT_USE_QTY        /* 1년후 작업출고수량 */
             , NVL(T4.REFR_OSTR_QTY, 0)                                             AS REFR_OSTR_QTY           /* 리퍼출고수량 */
             , NVL(T4.SELL_OSTR_QTY, 0)                                             AS SELL_OSTR_QTY           /* 판매출고수량 */
             , NVL(T4.DSU_OSTR_QTY, 0)                                              AS DSU_OSTR_QTY            /* 폐기출고수량 */
             , NVL(T4.ETC_OSTR_QTY, 0)                                              AS ETC_OSTR_QTY            /* 기타출고수량 */
             , NVL(T9.OSTR_CTR_QTY, 0)                                              AS OSTR_CTR_QTY            /* 등급조정출고수량 */
             , NVL(T5.CNFM_PITM_OSTR_GAP_QTY, 0)                                    AS CNFM_PITM_OSTR_GAP_QTY  /* 재고실사출고수량 */
             , NVL(T4.OSTR_QTY, 0) + NVL(T6.USE_QTY, 0)
               + NVL(T9.OSTR_CTR_QTY, 0) + NVL(T5.CNFM_PITM_OSTR_GAP_QTY, 0)        AS OSTR_QTY                /* 출고수량 합계 */
             , ( NVL(T2.BTD_STOC_A_GD_QTY, 0) + NVL(T2.BTD_STOC_B_GD_QTY, 0) + NVL(T2.BTD_STOC_E_GD_QTY, 0) + NVL(T2.BTD_STOC_R_GD_QTY, 0)
                 + NVL(T2.STR_QTY, 0) + NVL(T2.RTNGD_STR_OTSD_QTY, 0) + NVL(T2.STR_CTR_QTY, 0)
                 - NVL(T2.OSTR_QTY, 0) - NVL(T2.USE_QTY, 0) - NVL(T2.OSTR_CTR_QTY, 0) )
               + NVL(T3.STR_QTY, 0) + NVL(T6.RTNGD_STR_OTSD_QTY, 0) + NVL(T9.STR_CTR_QTY, 0) + NVL(T5.CNFM_PITM_STR_GAP_QTY, 0)
               - ( NVL(T4.OSTR_QTY, 0) + NVL(T6.USE_QTY, 0)
                   + NVL(T9.OSTR_CTR_QTY, 0) + NVL(T5.CNFM_PITM_OSTR_GAP_QTY, 0) )  AS EOT_STOC_QTY            /* 기말재고수량 */
             , NVL(T4.MMT_STOC_QTY, 0)                                              AS MMT_STOC_QTY            /* 이동재고수량 */
          FROM PD T1   /* WITH절 상품 */
          LEFT OUTER JOIN
             (
               SELECT T.ITM_PD_CD                                       /* 품목상품코드 */
                    , SUM(T.BTD_STOC_A_GD_QTY)  AS BTD_STOC_A_GD_QTY    /* 기초재고 A등급 수량 */
                    , SUM(T.BTD_STOC_B_GD_QTY)  AS BTD_STOC_B_GD_QTY    /* 기초재고 B등급 수량 */
                    , SUM(T.BTD_STOC_E_GD_QTY)  AS BTD_STOC_E_GD_QTY    /* 기초재고 E등급 수량 */
                    , SUM(T.BTD_STOC_R_GD_QTY)  AS BTD_STOC_R_GD_QTY    /* 기초재고 R등급 수량 */
                    , SUM(T.STR_QTY)            AS STR_QTY              /* 입고수량 */
                    , SUM(T.RTNGD_STR_OTSD_QTY) AS RTNGD_STR_OTSD_QTY   /* 반품입고외부 수량 */
                    , SUM(T.STR_CTR_QTY)        AS STR_CTR_QTY          /* 등급조정(입고) 수량 */
                    , SUM(T.OSTR_QTY)           AS OSTR_QTY             /* 출고수량 */
                    , SUM(T.USE_QTY)            AS USE_QTY              /* 사용수량 */
                    , SUM(T.OSTR_CTR_QTY)       AS OSTR_CTR_QTY         /* 등급조정(출고) 수량 */
                 FROM
                    (
                      SELECT /*+ LEADING(D1) INDEX(D1 IX_SVST_MCITM_STOC_IZ_01) */
                             D1.ITM_PD_CD               /* 품목상품코드 */
                           , CASE WHEN #{itmGdCd} IS NULL
                                    OR #{itmGdCd} = 'A' THEN D1.BTD_STOC_A_GD_QTY
                                  ELSE 0
                             END AS BTD_STOC_A_GD_QTY   /* 기초재고 A등급 수량 */
                           , CASE WHEN #{itmGdCd} IS NULL
                                    OR #{itmGdCd} = 'B' THEN D1.BTD_STOC_B_GD_QTY
                                  ELSE 0
                             END AS BTD_STOC_B_GD_QTY   /* 기초재고 B등급 수량 */
                           , CASE WHEN #{itmGdCd} IS NULL
                                    OR #{itmGdCd} = 'E' THEN D1.BTD_STOC_E_GD_QTY
                                  ELSE 0
                             END AS BTD_STOC_E_GD_QTY   /* 기초재고 E등급 수량 */
                           , CASE WHEN #{itmGdCd} IS NULL
                                    OR #{itmGdCd} = 'R' THEN D1.BTD_STOC_R_GD_QTY
                                  ELSE 0
                             END AS BTD_STOC_R_GD_QTY   /* 기초재고 R등급 수량 */
                           , 0 AS STR_QTY               /* 입고수량 */
                           , 0 AS RTNGD_STR_OTSD_QTY    /* 반품입고외부 수량 */
                           , 0 AS STR_CTR_QTY           /* 등급조정(입고) 수량 */
                           , 0 AS OSTR_QTY              /* 출고수량 */
                           , 0 AS USE_QTY               /* 사용수량 */
                           , 0 AS OSTR_CTR_QTY          /* 등급조정(출고) 수량 */
                        FROM TB_SVST_MCITM_STOC_IZ D1   /* 월별품목재고내역 */
                       INNER JOIN WARE D2               /* WITH절 창고 */
                          ON D2.APY_YM  = D1.BASE_YM
                         AND D2.WARE_NO = D1.WARE_NO
                       WHERE D1.DTA_DL_YN = 'N'
                         AND D1.BASE_YM   = SUBSTR(#{stFromYmd}, 1, 6)
                         AND D1.WARE_NO LIKE #{strWareDvCd} || '%'
                       UNION ALL
                      SELECT D1.ITM_PD_CD
                           , 0               AS BTD_STOC_A_GD_QTY
                           , 0               AS BTD_STOC_B_GD_QTY
                           , 0               AS BTD_STOC_E_GD_QTY
                           , 0               AS BTD_STOC_R_GD_QTY
                           , SUM(D1.STR_QTY) AS STR_QTY
                           , 0               AS RTNGD_STR_OTSD_QTY
                           , 0               AS STR_CTR_QTY
                           , 0               AS OSTR_QTY
                           , 0               AS USE_QTY
                           , 0               AS OSTR_CTR_QTY
                        FROM TB_SVST_ITM_STR_IZ D1   /* 품목입고내역 */
                       INNER JOIN WARE D2            /* WITH절 창고 */
                          ON D2.WARE_NO = D1.STR_WARE_NO
                       WHERE D1.DTA_DL_YN = 'N'
                         AND D1.STR_RGST_DT <![CDATA[>=]]> SUBSTR(#{stFromYmd}, 1, 6) || '01'
                         AND D1.STR_RGST_DT <![CDATA[<]]> #{stFromYmd}
                    <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                         AND D1.ITM_GD_CD = #{itmGdCd}
                    </if>
                       GROUP BY D1.ITM_PD_CD
                       UNION ALL
                      SELECT /*+ INDEX(D1 IX_SVST_SV_WK_OSTR_IZ_01) */
                             D1.ITM_PD_CD
                           , 0        AS BTD_STOC_A_GD_QTY
                           , 0        AS BTD_STOC_B_GD_QTY
                           , 0        AS BTD_STOC_E_GD_QTY
                           , 0        AS BTD_STOC_R_GD_QTY
                           , 0        AS STR_QTY
                           , SUM(CASE WHEN D1.SV_BIZ_HCLSF_CD = '6' THEN D1.USE_QTY
                                      ELSE 0
                                 END) AS RTNGD_STR_OTSD_QTY
                           , 0        AS STR_CTR_QTY
                           , 0        AS OSTR_QTY
                           , SUM(CASE WHEN D1.SV_BIZ_HCLSF_CD <![CDATA[<>]]> '6' THEN D1.USE_QTY
                                      ELSE 0
                                 END) AS USE_QTY
                           , 0        AS OSTR_CTR_QTY
                        FROM TB_SVST_SV_WK_OSTR_IZ D1   /* 서비스작업출고내역 */
                       INNER JOIN WARE D2               /* WITH절 창고 */
                          ON D2.WARE_NO = D1.WK_WARE_NO
                       WHERE D1.DTA_DL_YN        = 'N'
                         AND D1.SV_BIZ_HCLSF_CD IN ('1', '2', '3', '4', '6')
                         AND D1.FNL_VST_FSH_DT <![CDATA[>=]]> SUBSTR(#{stFromYmd}, 1, 6) || '01'
                         AND D1.FNL_VST_FSH_DT <![CDATA[<]]> #{stFromYmd}
                    <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                         AND D1.FNL_ITM_GD_CD    = #{itmGdCd}
                    </if>
                       GROUP BY D1.ITM_PD_CD
                       UNION ALL
                      SELECT D1.PD_CD AS ITM_PD_CD
                           , 0        AS BTD_STOC_A_GD_QTY
                           , 0        AS BTD_STOC_B_GD_QTY
                           , 0        AS BTD_STOC_E_GD_QTY
                           , 0        AS BTD_STOC_R_GD_QTY
                           , 0        AS STR_QTY
                           , 0        AS RTNGD_STR_OTSD_QTY
                           , SUM(CASE WHEN #{itmGdCd} IS NULL             THEN D1.CTR_QTY
                                      WHEN D1.AFCT_ITM_GD_CD = #{itmGdCd} THEN D1.CTR_QTY
                                      ELSE 0
                                 END) AS STR_CTR_QTY
                           , 0        AS OSTR_QTY
                           , 0        AS USE_QTY
                           , SUM(CASE WHEN #{itmGdCd} IS NULL             THEN D1.CTR_QTY
                                      WHEN D1.BFCT_ITM_GD_CD = #{itmGdCd} THEN D1.CTR_QTY
                                      ELSE 0
                                 END) AS OSTR_CTR_QTY
                        FROM TB_SVST_ITM_GD_CTR_IZ D1   /* 품목등급조정내역 */
                       INNER JOIN WARE D2               /* WITH절 창고 */
                          ON D2.WARE_NO = D1.WARE_NO
                       WHERE D1.DTA_DL_YN = 'N'
                         AND D1.STAT_CTR_APY_DT <![CDATA[>=]]> SUBSTR(#{stFromYmd}, 1, 6) || '01'
                         AND D1.STAT_CTR_APY_DT <![CDATA[<]]> #{stFromYmd}
                       GROUP BY D1.PD_CD
                       UNION ALL
                      SELECT D1.ITM_PD_CD
                           , 0                AS BTD_STOC_A_GD_QTY
                           , 0                AS BTD_STOC_B_GD_QTY
                           , 0                AS BTD_STOC_E_GD_QTY
                           , 0                AS BTD_STOC_R_GD_QTY
                           , 0                AS STR_QTY
                           , 0                AS RTNGD_STR_OTSD_QTY
                           , 0                AS STR_CTR_QTY
                           , SUM(D1.OSTR_QTY) AS OSTR_QTY
                           , 0                AS USE_QTY
                           , 0                AS OSTR_CTR_QTY
                        FROM TB_SVST_ITM_OSTR_IZ D1   /* 품목출고내역 */
                       INNER JOIN WARE D2             /* WITH절 창고 */
                          ON D2.WARE_NO = D1.OSTR_WARE_NO
                       WHERE D1.DTA_DL_YN = 'N'
                         AND D1.OSTR_DT <![CDATA[>=]]> SUBSTR(#{stFromYmd}, 1, 6) || '01'
                         AND D1.OSTR_DT <![CDATA[<]]> #{stFromYmd}
                    <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                         AND D1.ITM_GD_CD = #{itmGdCd}
                    </if>
                       GROUP BY D1.ITM_PD_CD
                    ) T
                GROUP BY T.ITM_PD_CD
             ) T2   /* 기초재고 */
            ON T2.ITM_PD_CD = T1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT D1.ITM_PD_CD                                                                    /* 품목상품코드 */
                    , SUM(D1.STR_QTY)                                         AS STR_QTY              /* 입고수량 */
                    , SUM(CASE WHEN D1.STR_TP_CD = '110' THEN D1.STR_QTY END) AS PRCHS_STR_QTY        /* 구매입고 수량 */
                    , SUM(CASE WHEN D1.STR_TP_CD = '121' THEN D1.STR_QTY END) AS NOM_STR_QTY          /* 정상입고 수량 */
                    , SUM(CASE WHEN D1.STR_TP_CD = '122' THEN D1.STR_QTY END) AS QOM_ASN_STR_QTY      /* 물량배정입고 수량 */
                    , SUM(CASE WHEN D1.STR_TP_CD = '123' THEN D1.STR_QTY END) AS QOM_MMT_STR_QTY      /* 물량이동입고 수량 */
                    , SUM(CASE WHEN D1.STR_TP_CD = '161' THEN D1.STR_QTY END) AS RTNGD_STR_INSD_QTY   /* 반품입고내부 수량 */
                    , SUM(CASE WHEN D1.STR_TP_CD = '162' THEN D1.STR_QTY END) AS RTNGD_STR_OTSD_QTY   /* 반품입고외부 수량 */
                    , SUM(CASE WHEN D1.STR_TP_CD = '117' THEN D1.STR_QTY END) AS ETC_STR_QTY          /* 기타입고 수량 */
                 FROM TB_SVST_ITM_STR_IZ D1   /* 품목입고내역 */
                INNER JOIN WARE D2            /* WITH절 창고 */
                   ON D2.WARE_NO = D1.STR_WARE_NO
                WHERE D1.DTA_DL_YN = 'N'
                  AND D1.STR_RGST_DT BETWEEN #{stFromYmd} AND #{edToYmd}
            <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                  AND D1.ITM_GD_CD = #{itmGdCd}
            </if>
                GROUP BY D1.ITM_PD_CD
             ) T3   /* 입고정보 */
            ON T3.ITM_PD_CD = T1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT D1.ITM_PD_CD                                                                       /* 품목상품코드 */
                    , SUM(D1.OSTR_QTY)                                          AS OSTR_QTY              /* 출고수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD = '221' THEN D1.OSTR_QTY END) AS NOM_OSTR_QTY          /* 정상출고 수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD = '221'
                                AND D1.OSTR_WARE_DV_CD = '2' THEN D1.OSTR_QTY
                          END)                                                  AS SVC_NOM_OSTR_QTY      /* 정상출고 서비스센터 수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD = '221'
                                AND D1.OSTR_WARE_DV_CD = '3' THEN D1.OSTR_QTY
                          END)                                                  AS SELL_NOM_OSTR_QTY     /* 정상출고 영업센터 수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD = '222' THEN D1.OSTR_QTY END) AS QOM_ASN_OSTR_QTY      /* 물량배정출고 수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD = '223' THEN D1.OSTR_QTY END) AS QOM_MMT_OSTR_QTY      /* 물량이동출고 수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD = '261' THEN D1.OSTR_QTY END) AS RTNGD_OSTR_INSD_QTY   /* 반품출고내부 수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD = '262' THEN D1.OSTR_QTY END) AS RTNGD_OSTR_OTSD_QTY   /* 반품출고외부 수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD = '218' THEN D1.OSTR_QTY END) AS REFR_OSTR_QTY         /* 리퍼출고 수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD = '211' THEN D1.OSTR_QTY END) AS SELL_OSTR_QTY         /* 판매출고 수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD = '212' THEN D1.OSTR_QTY END) AS DSU_OSTR_QTY          /* 폐기출고 수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD = '217' THEN D1.OSTR_QTY END) AS ETC_OSTR_QTY          /* 기타출고 수량 */
                    , SUM(CASE WHEN D1.OSTR_TP_CD NOT IN ('211', '217')
                                AND D1.STR_CONF_DT IS NULL
                                AND D1.OSTR_QTY <![CDATA[>]]> 0 THEN D1.OSTR_QTY
                          END)                                                 AS MMT_STOC_QTY           /* 이동재고 수량 */
                 FROM TB_SVST_ITM_OSTR_IZ D1   /* 품목출고내역 */
                INNER JOIN WARE D2             /* WITH절 창고 */
                   ON D2.WARE_NO = D1.OSTR_WARE_NO
                WHERE D1.DTA_DL_YN = 'N'
                  AND D1.OSTR_DT BETWEEN #{stFromYmd} AND #{edToYmd}
            <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                  AND D1.ITM_GD_CD = #{itmGdCd}
            </if>
                GROUP BY D1.ITM_PD_CD
             ) T4   /* 출고정보 */
            ON T4.ITM_PD_CD = T1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ LEADING(D1) */
                      D1.PD_CD                       AS ITM_PD_CD
                    , SUM(D1.CNFM_PITM_STR_GAP_QTY)  AS CNFM_PITM_STR_GAP_QTY
                    , SUM(D1.CNFM_PITM_OSTR_GAP_QTY) AS CNFM_PITM_OSTR_GAP_QTY
                 FROM TB_SVST_MCBY_STOC_ACINSP_IZ D1   /* 월별재고실사내역 */
                INNER JOIN WARE D2                     /* WITH절 창고 */
                   ON D2.APY_YM  = D1.BASE_YM
                  AND D2.WARE_NO = D1.WARE_NO
                WHERE D1.DTA_DL_YN = 'N'
                  AND D1.IOST_RFDT BETWEEN #{stFromYmd} AND #{edToYmd}
            <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                  AND 'A'          = #{itmGdCd}
            </if>
                GROUP BY D1.PD_CD
             ) T5   /* 재고실사정보 */
            ON T5.ITM_PD_CD = T1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ INDEX(D1 IX_SVST_SV_WK_OSTR_IZ_01) */
                      D1.ITM_PD_CD
                    , SUM(CASE WHEN D1.SV_BIZ_HCLSF_CD = '6' THEN D1.USE_QTY END)                   AS RTNGD_STR_OTSD_QTY
                    , SUM(CASE WHEN D1.SV_BIZ_HCLSF_CD IN ('1', '2', '3', '4') THEN D1.USE_QTY END) AS USE_QTY
                 FROM TB_SVST_SV_WK_OSTR_IZ D1   /* 서비스작업출고내역 */
                INNER JOIN WARE D2               /* WITH절 창고 */
                   ON D2.WARE_NO = D1.WK_WARE_NO
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D1.SV_BIZ_HCLSF_CD IN ('1', '2', '3', '4', '6')
                  AND D1.FNL_MDFC_USR_ID NOT LIKE 'CONV%'
                  AND D1.FNL_VST_FSH_DT BETWEEN #{stFromYmd} AND #{edToYmd}
            <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                  AND D1.FNL_ITM_GD_CD    = #{itmGdCd}
            </if>
                GROUP BY D1.ITM_PD_CD
             ) T6   /* 작업출고정보 */
            ON T6.ITM_PD_CD = T1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ INDEX(D1 IX_SVST_SV_WK_OSTR_IZ_01) */
                      D1.ITM_PD_CD
                    , SUM(D1.USE_QTY) AS YEAR_IN_USE_QTY
                 FROM TB_SVST_SV_WK_OSTR_IZ D1         /* 서비스작업출고내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                INNER JOIN WARE D3                     /* WITH절 창고 */
                   ON D3.WARE_NO = D1.WK_WARE_NO
                WHERE D1.DTA_DL_YN        = 'N'
                  AND D2.DTA_DL_YN        = 'N'
                  AND D1.SV_BIZ_HCLSF_CD IN ('1', '2', '3', '4')
                  AND D1.FNL_MDFC_USR_ID NOT LIKE 'CONV%'
                  AND D1.FNL_VST_FSH_DT BETWEEN #{stFromYmd} AND #{edToYmd}
                  AND D1.FNL_VST_FSH_DT <![CDATA[<]]> TO_CHAR(ADD_MONTHS( NVL(TO_DATE(D2.IST_DT, 'YYYYMMDD'), SYSDATE ), 12), 'YYYYMMDD')   /* 설치후 1년 전 */
            <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                  AND D1.FNL_ITM_GD_CD    = #{itmGdCd}
            </if>
                GROUP BY D1.ITM_PD_CD
             ) T7   /* 작업출고(1년 전) 정보 */
            ON T7.ITM_PD_CD = T1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT /*+ INDEX(D1 IX_SVST_SV_WK_OSTR_IZ_01) */
                      D1.ITM_PD_CD
                    , SUM(D1.USE_QTY) AS YEAR_OUT_USE_QTY
                 FROM TB_SVST_SV_WK_OSTR_IZ D1         /* 서비스작업출고내역 */
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D2   /* 고객서비스수행내역 */
                   ON D2.CNTR_NO = D1.CNTR_NO
                  AND D2.CNTR_SN = D1.CNTR_SN
                INNER JOIN WARE D3                     /* WITH절 창고 */
                   ON D3.WARE_NO = D1.WK_WARE_NO
                WHERE D1.DTA_DL_YN = 'N'
                  AND D2.DTA_DL_YN = 'N'
                  AND D1.SV_BIZ_HCLSF_CD IN ('1', '2', '3', '4')
                  AND D1.FNL_MDFC_USR_ID NOT LIKE 'CONV%'
                  AND D1.FNL_VST_FSH_DT BETWEEN #{stFromYmd} AND #{edToYmd}
                  AND D1.FNL_VST_FSH_DT <![CDATA[>=]]> TO_CHAR(ADD_MONTHS( NVL(TO_DATE(D2.IST_DT, 'YYYYMMDD'), SYSDATE ), 12), 'YYYYMMDD')   /* 설치후 1년 이후 */
            <if test="@MybatisUtils@isNotEmpty(itmGdCd)">
                  AND D1.FNL_ITM_GD_CD = #{itmGdCd}
            </if>
                GROUP BY D1.ITM_PD_CD
             ) T8   /* 작업출고(1년 이후) 정보 */
            ON T8.ITM_PD_CD = T1.PD_CD
          LEFT OUTER JOIN
             (
               SELECT D1.PD_CD AS ITM_PD_CD
                    , SUM(CASE WHEN #{itmGdCd} IS NULL             THEN D1.CTR_QTY
                               WHEN D1.AFCT_ITM_GD_CD = #{itmGdCd} THEN D1.CTR_QTY
                          END) AS STR_CTR_QTY
                    , SUM(CASE WHEN #{itmGdCd} IS NULL             THEN D1.CTR_QTY
                               WHEN D1.BFCT_ITM_GD_CD = #{itmGdCd} THEN D1.CTR_QTY
                          END) AS OSTR_CTR_QTY
                 FROM TB_SVST_ITM_GD_CTR_IZ D1   /* 품목등급조정내역 */
                INNER JOIN WARE D2               /* WITH절 창고 */
                   ON D2.WARE_NO = D1.WARE_NO
                WHERE D1.DTA_DL_YN = 'N'
                  AND D1.STAT_CTR_APY_DT BETWEEN #{stFromYmd} AND #{edToYmd}
                GROUP BY D1.PD_CD
             ) T9   /* 등급조정 정보 */
            ON T9.ITM_PD_CD = T1.PD_CD
         ORDER BY T1.PD_CD
    <if test="@MybatisUtils@isNotEmpty(offset)">
        OFFSET ${offset} ROW FETCH NEXT ${size} ROW ONLY
    </if>
    </select>

    <select id="selectDateReceivingAndPayings" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaItemReceivingAndPayingDto$SearchDateRes">
          WITH BASE_DATE AS
             (
               SELECT TO_CHAR(TO_DATE(#{strRgstFrom}, 'YYYYMMDD') + (LEVEL - 1), 'YYYYMMDD') AS YMD
                 FROM DUAL
              CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(#{strRgstTo}, 'YYYYMMDD') - TO_DATE(#{strRgstFrom}, 'YYYYMMDD') + 1
             )
             , BTD_STOC AS   /* 기초재고(월초) */
             (
               SELECT BASE_YM
                    , NVL(BTD_STOC_A_GD_QTY, 0) AS BTD_STOC_A_GD_QTY
                    , NVL(BTD_STOC_B_GD_QTY, 0) AS BTD_STOC_B_GD_QTY
                    , NVL(BTD_STOC_E_GD_QTY, 0) AS BTD_STOC_E_GD_QTY
                    , NVL(BTD_STOC_R_GD_QTY, 0) AS BTD_STOC_R_GD_QTY
                 FROM TB_SVST_MCITM_STOC_IZ   /* 월별품목재고내역 */
                WHERE DTA_DL_YN = 'N'
                  AND WARE_NO   = #{wareNo}
                  AND ITM_PD_CD = #{itmPdCd}
                  AND BASE_YM BETWEEN SUBSTR(#{strRgstFrom}, 1, 6) AND SUBSTR(#{strRgstTo}, 1, 6)
             )
             , BASIC_STOC AS   /* 기초재고 */
             (
               SELECT T.YMD                                                     /* 일자 */
                    , NVL(SUM(T.STR_QTY), 0)            AS STR_QTY              /* 입고수량 */
                    , NVL(SUM(T.RTNGD_STR_OTSD_QTY), 0) AS RTNGD_STR_OTSD_QTY   /* 반품입고외부 수량 */
                    , NVL(SUM(T.OSTR_QTY), 0)           AS OSTR_QTY             /* 출고수량 */
                    , NVL(SUM(T.USE_QTY), 0)            AS USE_QTY              /* 작업출고수량 */
                 FROM
                    (
                      SELECT STR_RGST_DT  AS YMD
                           , SUM(STR_QTY) AS STR_QTY
                           , 0            AS RTNGD_STR_OTSD_QTY
                           , 0            AS OSTR_QTY
                           , 0            AS USE_QTY
                        FROM TB_SVST_ITM_STR_IZ   /* 품목입고내역 */
                       WHERE DTA_DL_YN   = 'N'
                         AND STR_WARE_NO = #{wareNo}
                         AND ITM_PD_CD   = #{itmPdCd}
                         AND STR_RGST_DT <![CDATA[>=]]> SUBSTR(#{strRgstFrom}, 1, 6) || '01'
                         AND STR_RGST_DT <![CDATA[<]]> #{strRgstTo}
                       GROUP BY STR_RGST_DT
                       UNION ALL
                      SELECT /*+ INDEX(TB_SVST_SV_WK_OSTR_IZ IX_SVST_SV_WK_OSTR_IZ_01) */
                             FNL_VST_FSH_DT AS YMD
                           , 0              AS STR_QTY
                           , SUM(CASE WHEN SV_BIZ_HCLSF_CD = '6' THEN USE_QTY
                                      ELSE 0
                                 END)       AS RTNGD_STR_OTSD_QTY
                           , 0              AS OSTR_QTY
                           , SUM(CASE WHEN SV_BIZ_HCLSF_CD <![CDATA[<>]]> '6' THEN USE_QTY
                                      ELSE 0
                                 END)       AS USE_QTY
                        FROM TB_SVST_SV_WK_OSTR_IZ   /* 서비스작업출고내역 */
                       WHERE DTA_DL_YN  = 'N'
                         AND SV_BIZ_HCLSF_CD IN ('1', '2', '3', '4', '6')
                         AND WK_WARE_NO = #{wareNo}
                         AND ITM_PD_CD  = #{itmPdCd}
                         AND FNL_VST_FSH_DT <![CDATA[>=]]> SUBSTR(#{strRgstFrom}, 1, 6) || '01'
                         AND FNL_VST_FSH_DT <![CDATA[<]]> #{strRgstTo}
                       GROUP BY FNL_VST_FSH_DT
                       UNION ALL
                      SELECT OSTR_DT       AS YMD
                           , 0             AS STR_QTY
                           , 0             AS RTNGD_STR_OTSD_QTY
                           , SUM(OSTR_QTY) AS OSTR_QTY
                           , 0             AS USE_QTY
                        FROM TB_SVST_ITM_OSTR_IZ   /* 품목출고내역 */
                       WHERE DTA_DL_YN    = 'N'
                         AND OSTR_WARE_NO = #{wareNo}
                         AND ITM_PD_CD    = #{itmPdCd}
                         AND OSTR_DT <![CDATA[>=]]> SUBSTR(#{strRgstFrom}, 1, 6) || '01'
                         AND OSTR_DT <![CDATA[<]]> #{strRgstTo}
                       GROUP BY OSTR_DT
                    ) T
                GROUP BY T.YMD
             )
        SELECT A1.YMD                                                                                         /* 일자 */
             , A1.BAS_STOC_QTY                                                                                /* 기초재고수량 */
             , A1.PRCHS_STR_QTY                                                                               /* 구매입고수량 */
             , A1.NOM_STR_QTY                                                                                 /* 정상입고수량 */
             , A1.QOM_ASN_STR_QTY                                                                             /* 물량배정입고수량 */
             , A1.QOM_MMT_STR_QTY                                                                             /* 물량이동입고수량 */
             , A1.RTNGD_STR_INSD_QTY                                                                          /* 반품입고내부수량 */
             , A1.RTNGD_STR_OTSD_QTY                                                                          /* 반품입고외부수량 */
             , A1.ETC_STR_QTY                                                                                 /* 기타입고수량 */
             , A1.STR_CTR_QTY                                                                                 /* 등급조정입고수량 */
             , A1.CNFM_PITM_STR_GAP_QTY                                                                       /* 재고실사입고수량 */
             , A1.NOM_OSTR_QTY                                                                                /* 정상출고수량 */
             , A1.SVC_NOM_OSTR_QTY                                                                            /* 서비스센터 정상출고수량 */
             , A1.SELL_NOM_OSTR_QTY                                                                           /* 영업센터 정상출고수량 */
             , A1.QOM_ASN_OSTR_QTY                                                                            /* 물량배정출고수량 */
             , A1.QOM_MMT_OSTR_QTY                                                                            /* 물량이동출고수량 */
             , A1.RTNGD_OSTR_INSD_QTY                                                                         /* 반품출고내부수량 */
             , A1.RTNGD_OSTR_OTSD_QTY                                                                         /* 반품출고외부수량 */
             , A1.USE_QTY                                                                                     /* 작업출고수량 */
             , A1.REFR_OSTR_QTY                                                                               /* 리퍼출고수량 */
             , A1.SELL_OSTR_QTY                                                                               /* 판매출고수량 */
             , A1.DSU_OSTR_QTY                                                                                /* 폐기출고수량 */
             , A1.ETC_OSTR_QTY                                                                                /* 기타출고수량 */
             , A1.OSTR_CTR_QTY                                                                                /* 등급조정출고수량 */
             , A1.CNFM_PITM_OSTR_GAP_QTY                                                                      /* 재고실사출고수량 */
             , A1.BAS_STOC_QTY + A1.STR_QTY + A1.STR_CTR_QTY + A1.CNFM_PITM_STR_GAP_QTY
               - ( A1.OSTR_QTY + A1.USE_QTY + A1.OSTR_CTR_QTY + A1.CNFM_PITM_OSTR_GAP_QTY ) AS EOT_STOC_QTY   /* 기말재고수량 */
             , A1.MMT_STOC_QTY                                                                                /* 이동재고수량 */
          FROM
             (
               SELECT T1.YMD                                                                                   /* 일자 */
                    , NVL(T7.BTD_STOC_A_GD_QTY, 0) + NVL(T7.BTD_STOC_B_GD_QTY, 0) + NVL(T7.BTD_STOC_E_GD_QTY, 0) + NVL(T7.BTD_STOC_R_GD_QTY, 0)
                      + ( SELECT NVL(SUM(STR_QTY + RTNGD_STR_OTSD_QTY - OSTR_QTY - USE_QTY), 0)
                            FROM BASIC_STOC
                           WHERE YMD <![CDATA[>=]]> SUBSTR(T1.YMD, 1, 6) || '01'
                             AND YMD <![CDATA[<]]> T1.YMD )                         AS BAS_STOC_QTY            /* 기초재고수량 */
                    , NVL(T2.PRCHS_STR_QTY, 0)                                      AS PRCHS_STR_QTY           /* 구매입고수량 */
                    , NVL(T2.NOM_STR_QTY, 0)                                        AS NOM_STR_QTY             /* 정상입고수량 */
                    , NVL(T2.QOM_ASN_STR_QTY, 0)                                    AS QOM_ASN_STR_QTY         /* 물량배정입고수량 */
                    , NVL(T2.QOM_MMT_STR_QTY, 0)                                    AS QOM_MMT_STR_QTY         /* 물량이동입고수량 */
                    , NVL(T2.RTNGD_STR_INSD_QTY, 0)                                 AS RTNGD_STR_INSD_QTY      /* 반품입고내부수량 */
                    , NVL(T2.RTNGD_STR_OTSD_QTY, 0) + NVL(T4.RTNGD_STR_OTSD_QTY, 0) AS RTNGD_STR_OTSD_QTY      /* 반품입고외부수량 */
                    , NVL(T2.ETC_STR_QTY, 0)                                        AS ETC_STR_QTY             /* 기타입고수량 */
                    , NVL(T6.STR_CTR_QTY, 0)                                        AS STR_CTR_QTY             /* 등급조정입고수량 */
                    , NVL(T5.CNFM_PITM_STR_GAP_QTY, 0)                              AS CNFM_PITM_STR_GAP_QTY   /* 재고실사입고수량 */
                    , NVL(T3.NOM_OSTR_QTY, 0)                                       AS NOM_OSTR_QTY            /* 정상출고수량 */
                    , NVL(T3.SVC_NOM_OSTR_QTY, 0)                                   AS SVC_NOM_OSTR_QTY        /* 서비스센터 정상출고수량 */
                    , NVL(T3.SELL_NOM_OSTR_QTY, 0)                                  AS SELL_NOM_OSTR_QTY       /* 영업센터 정상출고수량 */
                    , NVL(T3.QOM_ASN_OSTR_QTY, 0)                                   AS QOM_ASN_OSTR_QTY        /* 물량배정출고수량 */
                    , NVL(T3.QOM_MMT_OSTR_QTY, 0)                                   AS QOM_MMT_OSTR_QTY        /* 물량이동출고수량 */
                    , NVL(T3.RTNGD_OSTR_INSD_QTY, 0)                                AS RTNGD_OSTR_INSD_QTY     /* 반품출고내부수량 */
                    , NVL(T3.RTNGD_OSTR_OTSD_QTY, 0)                                AS RTNGD_OSTR_OTSD_QTY     /* 반품출고외부수량 */
                    , NVL(T4.USE_QTY, 0)                                            AS USE_QTY                 /* 작업출고수량 */
                    , NVL(T3.REFR_OSTR_QTY, 0)                                      AS REFR_OSTR_QTY           /* 리퍼출고수량 */
                    , NVL(T3.SELL_OSTR_QTY, 0)                                      AS SELL_OSTR_QTY           /* 판매출고수량 */
                    , NVL(T3.DSU_OSTR_QTY, 0)                                       AS DSU_OSTR_QTY            /* 폐기출고수량 */
                    , NVL(T3.ETC_OSTR_QTY, 0)                                       AS ETC_OSTR_QTY            /* 기타출고수량 */
                    , NVL(T6.OSTR_CTR_QTY, 0)                                       AS OSTR_CTR_QTY            /* 등급조정출고수량 */
                    , NVL(T5.CNFM_PITM_OSTR_GAP_QTY, 0)                             AS CNFM_PITM_OSTR_GAP_QTY  /* 재고실사출고수량 */
                    , NVL(T3.MMT_STOC_QTY, 0)                                       AS MMT_STOC_QTY            /* 이동재고수량 */
                    , NVL(T2.STR_QTY, 0) + NVL(T4.RTNGD_STR_OTSD_QTY, 0)            AS STR_QTY                 /* 입고수량 합계 */
                    , NVL(T3.OSTR_QTY, 0)                                           AS OSTR_QTY                /* 출고수량 합계 */
                 FROM BASE_DATE T1   /* WITH절 기본일자 */
                 LEFT OUTER JOIN
                    (
                      SELECT STR_RGST_DT                                       AS YMD                  /* 일자 */
                           , SUM(STR_QTY)                                      AS STR_QTY              /* 입고수량 */
                           , SUM(CASE WHEN STR_TP_CD = '110' THEN STR_QTY END) AS PRCHS_STR_QTY        /* 구매입고수량 */
                           , SUM(CASE WHEN STR_TP_CD = '121' THEN STR_QTY END) AS NOM_STR_QTY          /* 정상입고수량 */
                           , SUM(CASE WHEN STR_TP_CD = '122' THEN STR_QTY END) AS QOM_ASN_STR_QTY      /* 물량배정입고수량 */
                           , SUM(CASE WHEN STR_TP_CD = '123' THEN STR_QTY END) AS QOM_MMT_STR_QTY      /* 물량이동입고수량 */
                           , SUM(CASE WHEN STR_TP_CD = '161' THEN STR_QTY END) AS RTNGD_STR_INSD_QTY   /* 반품입고내부수량 */
                           , SUM(CASE WHEN STR_TP_CD = '162' THEN STR_QTY END) AS RTNGD_STR_OTSD_QTY   /* 반품입고외부수량 */
                           , SUM(CASE WHEN STR_TP_CD = '117' THEN STR_QTY END) AS ETC_STR_QTY          /* 기타입고수량 */
                        FROM TB_SVST_ITM_STR_IZ   /* 품목입고내역 */
                       WHERE DTA_DL_YN   = 'N'
                         AND STR_WARE_NO = #{wareNo}
                         AND ITM_PD_CD   = #{itmPdCd}
                         AND STR_RGST_DT BETWEEN #{strRgstFrom} AND #{strRgstTo}
                       GROUP BY STR_RGST_DT
                    ) T2   /* 입고정보 */
                   ON T2.YMD = T1.YMD
                 LEFT OUTER JOIN
                    (
                      SELECT OSTR_DT                                             AS YMD                   /* 일자 */
                           , SUM(OSTR_QTY)                                       AS OSTR_QTY              /* 출고수량 */
                           , SUM(CASE WHEN OSTR_TP_CD = '221' THEN OSTR_QTY END) AS NOM_OSTR_QTY          /* 정상출고수량 */
                           , SUM(CASE WHEN OSTR_TP_CD = '221'
                                       AND OSTR_WARE_DV_CD = '2' THEN OSTR_QTY
                                 END)                                            AS SVC_NOM_OSTR_QTY      /* 서비스센터 정상출고수량 */
                           , SUM(CASE WHEN OSTR_TP_CD = '221'
                                       AND OSTR_WARE_DV_CD = '3' THEN OSTR_QTY
                                 END)                                            AS SELL_NOM_OSTR_QTY     /* 영업센터 정상출고수량 */
                           , SUM(CASE WHEN OSTR_TP_CD = '222' THEN OSTR_QTY END) AS QOM_ASN_OSTR_QTY      /* 물량배정출고수량 */
                           , SUM(CASE WHEN OSTR_TP_CD = '223' THEN OSTR_QTY END) AS QOM_MMT_OSTR_QTY      /* 물량이동출고수량 */
                           , SUM(CASE WHEN OSTR_TP_CD = '261' THEN OSTR_QTY END) AS RTNGD_OSTR_INSD_QTY   /* 반품출고내부 수량 */
                           , SUM(CASE WHEN OSTR_TP_CD = '262' THEN OSTR_QTY END) AS RTNGD_OSTR_OTSD_QTY   /* 반품출고외부 수량 */
                           , SUM(CASE WHEN OSTR_TP_CD = '218' THEN OSTR_QTY END) AS REFR_OSTR_QTY         /* 리퍼출고수량 */
                           , SUM(CASE WHEN OSTR_TP_CD = '211' THEN OSTR_QTY END) AS SELL_OSTR_QTY         /* 판매출고수량 */
                           , SUM(CASE WHEN OSTR_TP_CD = '212' THEN OSTR_QTY END) AS DSU_OSTR_QTY          /* 폐기출고수량 */
                           , SUM(CASE WHEN OSTR_TP_CD = '217' THEN OSTR_QTY END) AS ETC_OSTR_QTY          /* 기타출고수량 */
                           , SUM(CASE WHEN OSTR_TP_CD NOT IN ('211', '217')
                                       AND STR_CONF_DT IS NULL
                                       AND OSTR_QTY <![CDATA[>]]> 0 THEN OSTR_QTY
                                 END)                                            AS MMT_STOC_QTY          /* 이동재고수량 */
                        FROM TB_SVST_ITM_OSTR_IZ   /* 품목출고내역 */
                       WHERE DTA_DL_YN    = 'N'
                         AND OSTR_WARE_NO = #{wareNo}
                         AND ITM_PD_CD    = #{itmPdCd}
                         AND OSTR_DT BETWEEN #{strRgstFrom} AND #{strRgstTo}
                       GROUP BY OSTR_DT
                    ) T3   /* 출고정보 */
                   ON T3.YMD = T1.YMD
                 LEFT OUTER JOIN
                    (
                      SELECT /*+ INDEX(TB_SVST_SV_WK_OSTR_IZ IX_SVST_SV_WK_OSTR_IZ_01) */
                             FNL_VST_FSH_DT                                                     AS YMD
                           , SUM(CASE WHEN SV_BIZ_HCLSF_CD = '6' THEN USE_QTY END)              AS RTNGD_STR_OTSD_QTY
                           , SUM(CASE WHEN SV_BIZ_HCLSF_CD <![CDATA[<>]]> '6' THEN USE_QTY END) AS USE_QTY
                        FROM TB_SVST_SV_WK_OSTR_IZ   /* 서비스작업출고내역 */
                       WHERE DTA_DL_YN        = 'N'
                         AND SV_BIZ_HCLSF_CD IN ('1', '2', '3', '4', '6')
                         AND FNL_MDFC_USR_ID NOT LIKE 'CONV%'
                         AND WK_WARE_NO       = #{wareNo}
                         AND ITM_PD_CD        = #{itmPdCd}
                         AND FNL_VST_FSH_DT BETWEEN #{strRgstFrom} AND #{strRgstTo}
                       GROUP BY FNL_VST_FSH_DT
                    ) T4   /* 작업출고정보 */
                   ON T4.YMD = T1.YMD
                 LEFT OUTER JOIN
                    (
                      SELECT CNFMDT                      AS YMD
                           , SUM(CNFM_PITM_STR_GAP_QTY)  AS CNFM_PITM_STR_GAP_QTY
                           , SUM(CNFM_PITM_OSTR_GAP_QTY) AS CNFM_PITM_OSTR_GAP_QTY
                        FROM TB_SVST_MCBY_STOC_ACINSP_IZ   /* 월별재고실사내역 */
                       WHERE DTA_DL_YN = 'N'
                         AND WARE_NO   = #{wareNo}
                         AND PD_CD     = #{itmPdCd}
                         AND IOST_RFDT BETWEEN #{strRgstFrom} AND #{strRgstTo}
                       GROUP BY CNFMDT
                    ) T5   /* 재고실사정보 */
                   ON T5.YMD = T1.YMD
                 LEFT OUTER JOIN
                    (
                      SELECT STAT_CTR_APY_DT AS YMD
                           , SUM(CTR_QTY)    AS STR_CTR_QTY
                           , SUM(CTR_QTY)    AS OSTR_CTR_QTY
                        FROM TB_SVST_ITM_GD_CTR_IZ   /* 품목등급조정내역 */
                       WHERE DTA_DL_YN = 'N'
                         AND WARE_NO   = #{wareNo}
                         AND PD_CD     = #{itmPdCd}
                         AND STAT_CTR_APY_DT BETWEEN #{strRgstFrom} AND #{strRgstTo}
                       GROUP BY STAT_CTR_APY_DT
                    ) T6   /* 등급조정정보 */
                   ON T6.YMD = T1.YMD
                 LEFT OUTER JOIN BTD_STOC T7   /* 기초재고(월초) */
                   ON T7.BASE_YM = SUBSTR(T1.YMD, 1, 6)
             ) A1
         ORDER BY A1.YMD
    </select>





</mapper>
