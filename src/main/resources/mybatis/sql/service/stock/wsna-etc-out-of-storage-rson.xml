<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaEtcOutOfStorageRsonMapper">

    <select id="selectEtcOutOfStorageRsons" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaEtcOutOfStorageRsonDto$SearchRes">
        SELECT PD_BAS.SAP_MAT_CD AS SAP_MAT_CD /*SAP코드*/
             , OSTR_IZ.ITM_PD_CD AS ITM_PD_CD
             , PD_BAS.PD_NM AS ITEM_NM
             , OSTR_IZ.OSTR_WARE_NO AS OSTR_WARE_NO /*출고창고번호*/
             , WARE_IZ.WARE_NM AS WARE_NM /*창고명*/
             , OSTR_IZ.ITM_GD_CD /*품목등급코드*/
             , OSTR_IZ.OSTR_DT AS OSTR_DT /*출고일자*/
             , F_CMZ_CD_NM(#{session.tenantId}, 'BIL_RSON_CD', OSTR_IZ.OSTR_RSON_CD) AS CD_CNTN
             , SUM(OSTR_IZ.OSTR_QTY) AS SUM_QTY
             , SUM(PRC_IZ.CSMR_UPRC_AMT) AS CSMR_UPRC_AMT
             , (SUM(OSTR_IZ.OSTR_QTY) * SUM(PRC_IZ.CSMR_UPRC_AMT)) AS TOTAL_AMT
        --     , (SELECT ISDNA2 FROM KWMART.IS2500P WHERE ISDEPT = ST161_IN_STCK_CD) AS DEPT_NM
             , WARE_IZ.SORT_DV_VAL
          FROM TB_SVST_ITM_OSTR_IZ OSTR_IZ
         INNER JOIN TB_PDBS_PD_BAS PD_BAS
            ON PD_BAS.PD_CD = OSTR_IZ.ITM_PD_CD
     	 INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL PRP_DTL
			ON PD_BAS.PD_CD = PRP_DTL.PD_CD
		   AND PRP_DTL.PD_EXTS_PRP_GRP_CD = 'PART'
         INNER JOIN TB_SVST_MCBY_WARE_IZ WARE_IZ
            ON WARE_IZ.WARE_NO = OSTR_IZ.OSTR_WARE_NO
           AND WARE_IZ.APY_YM = SUBSTR(OSTR_IZ.OSTR_DT,1,6)
         LEFT OUTER JOIN T_CMZ_CD_D CMZ
           ON PRP_DTL.PD_PRP_VAL19 = CMZ.CD_VLD_VAL
         LEFT OUTER JOIN TB_SVPD_RCAS_ITM_PRC_IZ PRC_IZ
            ON PRC_IZ.USE_MAT_PD_CD = OSTR_IZ.ITM_PD_CD
         WHERE OSTR_IZ.OSTR_TP_CD = '217'
           AND OSTR_IZ.OSTR_DT BETWEEN #{stOstrDt} AND #{edOstrDt}
           AND CMZ.TENANT_ID = 'TNT_WELLS'
           AND WARE_IZ.WARE_DV_CD='2'
           AND WARE_IZ.WARE_DTL_DV_CD = '20'
        <if test="@MybatisUtils@isNotEmpty(ostrWareNo)">
           AND OSTR_IZ.OSTR_WARE_NO = #{ostrWareNo}
        </if>
        <if test="@MybatisUtils@isNotEmpty(pdGdCd)">
           AND OSTR_IZ.ITM_GD_CD = #{pdGdCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
           AND PRP_DTL.PD_PRP_VAL19 = #{itmKndCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(startItemCd)">
           AND OSTR_IZ.ITM_PD_CD <![CDATA[>=]]> #{startItemCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(endItemCd)">
           AND OSTR_IZ.ITM_PD_CD <![CDATA[<=]]> #{edItemCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(bilRsonCd)">
           AND OSTR_IZ.OSTR_RSON_CD = #{bilRsonCd}
        </if>
         GROUP BY WARE_IZ.SORT_DV_VAL
                , OSTR_IZ.ITM_PD_CD
                , PD_BAS.SAP_MAT_CD
                , PD_BAS.PD_NM
                , OSTR_IZ.OSTR_WARE_NO
                , WARE_IZ.WARE_NM
                , OSTR_IZ.ITM_GD_CD
                , OSTR_IZ.OSTR_DT
                , OSTR_IZ.OSTR_RSON_CD
                , F_CMZ_CD_NM('TNT_WELLS', 'BIL_RSON_CD', OSTR_IZ.OSTR_RSON_CD)
                /*, STR_WARE_NO*/
         ORDER BY OSTR_IZ.ITM_PD_CD, OSTR_IZ.OSTR_DT, OSTR_IZ.ITM_GD_CD
    </select>

    <select id="selectServiceCenters" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaEtcOutOfStorageRsonDto$CenterRes">
        SELECT WAREIZ.WARE_NO  AS CODE_ID
             , WAREIZ.WARE_NM  AS CODE_NAME
        --     , WAREIZ.OG_ID
             , WAREIZ.WARE_MNGT_PRTNR_NO /*창고관리파트너번호*/
          FROM TB_SVST_MCBY_WARE_IZ WAREIZ
         WHERE APY_YM = SUBSTR(#{stOstrDt},1,6)
           AND WARE_DV_CD = '2'
           AND WARE_ICHR_NO  = '000'
         ORDER BY SORT_DV_VAL
                , CODE_NAME
                , WARE_NO

    </select>

    <select id="selectBusinessCenter" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaEtcOutOfStorageRsonDto$BusinessRes">
        SELECT WARE_NO AS CODE_ID
             , WARE_NM AS CODE_NAME
             , WARE_DV_CD
          FROM TB_SVST_MCBY_WARE_IZ
         WHERE WARE_DV_CD = '3'
           AND WARE_USE_YN ='Y'
           AND APY_YM = TO_CHAR(SYSDATE, 'YYYYMM')
         ORDER BY WARE_NM
    </select>

    <select id="selectEtcOutOfStorageRsonBusiness" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaEtcOutOfStorageRsonDto$SearchRes">
        SELECT OSTR_IZ.ITM_PD_CD AS ITM_PD_CD
             , PD_BAS.PD_NM  AS ITEM_NM
             , OSTR_IZ.OSTR_WARE_NO AS OSTR_WARE_NO
             , WARE_IZ.WARE_NM AS WARE_NM
             , OSTR_IZ.ITM_GD_CD AS ITM_GD_CD
             , OSTR_IZ.OSTR_DT AS OSTR_DT
             , F_CMZ_CD_NM(#{session.tenantId}, 'BIL_RSON_CD', OSTR_IZ.OSTR_RSON_CD) AS CD_CNTN
             , OSTR_IZ.OSTR_QTY AS SUM_QTY
             --, (SELECT ISDNA2 FROM KWMART.IS2500P WHERE ISDEPT = ST161_IN_STCK_CD) AS DEPT_NM
             , WARE_IZ.SORT_DV_VAL AS SORT_DV_VAL
             , OSTR_IZ.RMK_CN AS RMK_CN
             , PD_BAS.SAP_MAT_CD AS SAP_MAT_CD /*SAP코드*/
         FROM TB_SVST_ITM_OSTR_IZ OSTR_IZ
        INNER JOIN TB_PDBS_PD_BAS PD_BAS
           ON PD_BAS.PD_CD = OSTR_IZ.ITM_PD_CD
     	 INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL PRP_DTL
			ON PD_BAS.PD_CD = PRP_DTL.PD_CD
		   AND PRP_DTL.PD_EXTS_PRP_GRP_CD = 'PART'
        INNER JOIN TB_SVST_MCBY_WARE_IZ WARE_IZ
           ON WARE_IZ.WARE_NO = OSTR_IZ.OSTR_WARE_NO
          AND WARE_IZ.APY_YM = SUBSTR(OSTR_IZ.OSTR_DT,1,6)
        LEFT OUTER JOIN T_CMZ_CD_D CMZ
           ON PRP_DTL.PD_PRP_VAL19 = CMZ.CD_VLD_VAL
        WHERE OSTR_IZ.OSTR_TP_CD = '217'
          AND OSTR_IZ.OSTR_DT BETWEEN #{stOstrDt} AND #{edOstrDt}
          AND CMZ.TENANT_ID = 'TNT_WELLS'
          AND WARE_IZ.WARE_DV_CD='3'
          AND WARE_IZ.WARE_DTL_DV_CD = '30'
        <if test="@MybatisUtils@isNotEmpty(ostrWareNo)">
          AND OSTR_IZ.OSTR_WARE_NO = #{ostrWareNo}
        </if>
        <if test="@MybatisUtils@isNotEmpty(pdGdCd)">
          AND OSTR_IZ.ITM_GD_CD = #{pdGdCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
          AND PRP_DTL.PD_PRP_VAL19 = #{itmKndCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(startItemCd)">
          AND OSTR_IZ.ITM_PD_CD <![CDATA[>=]]> #{startItemCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(endItemCd)">
          AND OSTR_IZ.ITM_PD_CD <![CDATA[<=]]> #{edItemCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(bilRsonCd)">
          AND OSTR_IZ.OSTR_RSON_CD = #{bilRsonCd}
        </if>
    </select>

</mapper>
