<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaEtcOutOfStorageRsonMapper">

    <select id="selectEtcOutOfStorageRsons" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaEtcOutOfStorageRsonDto$SearchRes">
        SELECT PD_BAS.SAP_MAT_CD AS SAP_MAT_CD /*SAP코드*/
             , OSTR_IZ.ITM_PD_CD AS ITM_PD_CD
             , PD_BAS.PD_NM AS ITEM_NM
             , OSTR_IZ.OSTR_WARE_NO AS OSTR_WARE_NO /*출고창고번호*/
             , WARE_IZ.WARE_NM AS WARE_NM /*창고명*/
             , OSTR_IZ.ITM_GD_CD /*품목등급코드*/
             , OSTR_IZ.OSTR_DT AS OSTR_DT /*출고일자*/
             , F_CMZ_CD_NM(#{session.tenantId}, 'BIL_RSON_CD', OSTR_IZ.OSTR_RSON_CD) AS CD_CNTN
             , SUM(OSTR_IZ.OSTR_QTY) AS SUM_QTY
             , SUM(PRC_IZ.CSMR_UPRC_AMT) AS CSMR_UPRC_AMT
             , (SUM(OSTR_IZ.OSTR_QTY) * SUM(PRC_IZ.CSMR_UPRC_AMT)) AS TOTAL_AMT
        --     , (SELECT ISDNA2 FROM KWMART.IS2500P WHERE ISDEPT = ST161_IN_STCK_CD) AS DEPT_NM
             , WARE_IZ.SORT_DV_VAL
          FROM TB_SVST_ITM_OSTR_IZ OSTR_IZ
         INNER JOIN TB_PDBS_PD_BAS PD_BAS
            ON PD_BAS.PD_CD = OSTR_IZ.ITM_PD_CD
         INNER JOIN TB_SVST_MCBY_WARE_IZ WARE_IZ
            ON WARE_IZ.WARE_NO = OSTR_IZ.OSTR_WARE_NO AND WARE_IZ.APY_YM = SUBSTR(OSTR_IZ.OSTR_DT,1,6)
         LEFT OUTER JOIN T_CMZ_CD_D CMZ
            ON OSTR_IZ.OSTR_RSON_CD = CMZ.CD_ID
         LEFT OUTER JOIN TB_SVPD_RCAS_ITM_PRC_IZ PRC_IZ
            ON PRC_IZ.USE_MAT_PD_CD = OSTR_IZ.ITM_PD_CD
         WHERE OSTR_IZ.OSTR_TP_CD = '217'
            --AND OSTR_IZ.OSTR_DT BETWEEN #{stOstrDt} AND #{edOstrDt}
           AND CMZ.CD_ID = 'BIL_RSON_CD' -- 청구사유
           AND CMZ.TENANT_ID = 'TNT_WELLS'
           AND WARE_IZ.WARE_DV_CD='2'
           AND WARE_IZ.WARE_ICHR_NO='000'
        <if test="@MybatisUtils@isNotEmpty(pdGdCd)">
           AND ITM_GD_CD = #{pdGdCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
           AND ITM_KND_CD = #{itmKndCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(startItemCd)">
           AND ITM_PD_CD <![CDATA[>=]]> #{startItemCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(endItemCd)">
           AND ITM_PD_CD <![CDATA[<=]]> #{edItemCd}
        </if>
        <if test="@MybatisUtils@isNotEmpty(bilRsonCd)">
           AND OSTR_RSON_CD = #{bilRsonCd}
        </if>

         GROUP BY WARE_IZ.SORT_DV_VAL
                , OSTR_IZ.ITM_PD_CD
                , PD_BAS.SAP_MAT_CD
                , PD_BAS.PD_NM
                , OSTR_IZ.OSTR_WARE_NO
                , WARE_IZ.WARE_NM
                , OSTR_IZ.ITM_GD_CD
                , OSTR_IZ.OSTR_DT
                , OSTR_IZ.OSTR_RSON_CD
                , CD_CNTN
                /*, STR_WARE_NO*/
         ORDER BY OSTR_IZ.ITM_PD_CD, OSTR_IZ.OSTR_DT, OSTR_IZ.ITM_GD_CD
    </select>

</mapper>
