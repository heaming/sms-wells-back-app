<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.stock.mapper.WsnaEtcOutOfStorageRsonMapper">

    <select id="selectEtcOutOfStorageRsons" resultType="com.kyowon.sms.wells.web.service.stock.dto.WsnaEtcOutOfStorageRsonDto$SearchRes">
            SELECT D1.ITM_PD_CD                                                     AS ITM_PD_CD     /* 품목상품코드 */
                 , TO_CHAR(TO_NUMBER(D2.SVPD_SAP_CD))                               AS SAP_MAT_CD    /* SAP자재코드 */
                 , D2.SVPD_NM_ABBR1                                                 AS ITEM_NM       /* 품목명 */
                 , D1.OSTR_WARE_NO                                                  AS OSTR_WARE_NO  /* 출고창고번호 */
                 , D3.WARE_NM                                                       AS WARE_NM       /* 출고창고번호 */
                 , D1.ITM_GD_CD                                                     AS ITM_GD_CD     /* 품목등급코드 */
                 , D1.OSTR_DT                                                       AS OSTR_DT       /* 출고일자 */
                 , F_CMZ_CD_NM(#{session.tenantId}, 'BIL_RSON_CD', D1.OSTR_RSON_CD) AS OSTR_RSON_CD  /* 출고사유코드 */
                 , D3.SORT_DV_VAL                                                   AS SORT_DV_VAL   /* 정렬구분값 */
                 , SUM(D1.OSTR_QTY)                                                 AS OSTR_QTY      /* 수량 */
                 , SUM(D4.CSMR_UPRC_AMT)                                            AS CSMR_UPRC_AMT /* 소비자가 */
                 , (SUM(D1.OSTR_QTY) * SUM(D4.CSMR_UPRC_AMT))                       AS TOTAL_AMT     /* 총금액 */
                 , D1.RMK_CN                                                        AS RMK_CN        /* 비고 */
                 , D6.DEPT_NM2                                                      AS DEPT_NM       /* 부서명 */
              FROM TB_SVST_ITM_OSTR_IZ D1 /* 품목출고내역 */
             INNER JOIN (<include refid="com.kyowon.sms.wells.web.service.common.BASE.selectPartMaster"/>) D2
                ON D2.SVPD_PD_CD = D1.ITM_PD_CD
             INNER JOIN TB_SVST_MCBY_WARE_IZ D3 /* 월별창고내역 */
                ON D3.WARE_NO        = D1.OSTR_WARE_NO
               AND D3.APY_YM         = SUBSTR(#{stOstrDt}, 1,6)
              LEFT OUTER JOIN TB_SVPD_RCAS_ITM_PRC_IZ D4 /* 유상AS품목가격내역 */
                ON D4.USE_MAT_PD_CD  = D1.ITM_PD_CD
               AND D1.OSTR_DT BETWEEN D4.APY_STRTDT AND D4.APY_ENDDT
               AND D4.DTA_DL_YN      = 'N'
              LEFT OUTER JOIN TB_GBCO_DEPT_BAS D6 /* 부서기본 */
                ON D6.DEPT_CD = D1.STR_WARE_NO
               AND D6.DTA_DL_YN      = 'N'
             WHERE D1.OSTR_TP_CD     = '217'
               AND D1.DTA_DL_YN      = 'N'
               AND D3.DTA_DL_YN      = 'N'
               AND D1.OSTR_DT BETWEEN #{stOstrDt} AND #{edOstrDt}
               AND D3.WARE_DV_CD     = #{wareDvCd}
           <if test="@MybatisUtils@isNotEmpty(wareNoM)">
               AND ( D3.HGR_WARE_NO = #{wareNoM} OR D3.WARE_NO = #{wareNoM} )
           </if>
           <if test="@MybatisUtils@isNotEmpty(wareNoD)">
               AND D3.WARE_NO    = #{wareNoD}
           </if>
           <if test="@MybatisUtils@isNotEmpty(pdGdCd)">
               AND D1.ITM_GD_CD = #{pdGdCd}
           </if>
           <if test="@MybatisUtils@isNotEmpty(itmKndCd)">
               AND D2.SVPD_ITEM_KND = #{itmKndCd}
           </if>
           <if test="@MybatisUtils@isNotEmpty(startItemCd)">
               AND D1.ITM_PD_CD <![CDATA[>=]]> #{startItemCd}
           </if>
           <if test="@MybatisUtils@isNotEmpty(endItemCd)">
               AND D1.ITM_PD_CD <![CDATA[<=]]> #{endItemCd}
           </if>
           <if test="@MybatisUtils@isNotEmpty(bilRsonCd)">
               AND D1.OSTR_RSON_CD = #{bilRsonCd}
           </if>
               AND D6.DEPT_DV_VAL = '1'
               AND D6.USE_YN = 'Y'
             GROUP BY D3.SORT_DV_VAL
                    , D1.ITM_PD_CD
                    , D2.SVPD_SAP_CD
                    , D2.SVPD_NM_ABBR1
                    , D1.OSTR_WARE_NO
                    , D3.WARE_NM
                    , D1.ITM_GD_CD
                    , D1.OSTR_DT
                    , D1.OSTR_RSON_CD
                    , D1.RMK_CN
                    , D6.DEPT_NM2
             ORDER BY D1.ITM_PD_CD, D1.OSTR_DT, D1.ITM_GD_CD
    </select>





</mapper>
