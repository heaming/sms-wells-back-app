<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.orgcode.mapper.WsndBusinessVehiclesOperationJrnlMgtMapper">
    <select id="selectBusinessVehiclesOperationJrnl" resultType="com.kyowon.sms.wells.web.service.orgcode.dto.WsndBusinessVehiclesOperationJrnlMgtDto$SearchRes">
        WITH HIST AS ( SELECT *
                         FROM ( SELECT CARNO
                                     , FUEL_CSM_RT
                                     , BSPD_TMS
                                     , SDPD_TMS
                                     , OPRTN_HH
                                     , SUBSTR(OPRTN_STRTT,1,8) AS OPRTN_STRTT
                                     , RANK() OVER (PARTITION BY CARNO, SUBSTR(OPRTN_STRTT,1,8) ORDER BY OPRTN_STRTT DESC) AS RN
                                  FROM TB_SVPD_OPRTN_HIST
                                 WHERE SUBSTR(OPRTN_STRTT,1,8) BETWEEN '20231101' AND '20231130'
                         )
                        WHERE RN = 1
        )

        SELECT P1.OG_NM /* 소속 */
             , P1.PRTNR_KNM
             , C1.VHC_MNGT_PRTNR_NO
             , F_CMZ_CD_NM('TNT_WELLS', 'HIR_FOM_CD', P1.HIR_FOM_CD , 'ko') AS HIR_FOM_CD
             , P1.CNTR_DT
             , '' AS CARNM -- ***
             , C1.CARNO
             , C1.VHC_OPRTN_DT
             , C1.VHC_OPRTN_SN
             , C1.DPTU_ACU_DSTN
             , C1.ARV_ACU_DSTN
             , C1.OPRTN_DSTN
             , HIST.OPRTN_HH
             , C1.LBRCQ_VAL /*주유량값*/
             , 0 AS LBRCQ_PR /* 데이터 확인 불가로 임시 - 주유비용 */
             , FUEL_CSM_RT /* 연비 */
             , 0 AS OPRTN_CT --/* 운행건수 */ *****
             , BSPD_TMS --/* 급가속횟수 */ ****
             , SDPD_TMS-- /* 급감속횟수 */ ****
             , HIST.BSPD_TMS / 1 AS AVG_BSPD_TMS --HIST.BSPD_TMS / OPRTN_CNT /* 평균가속률 */ ***
             , 0 AS AV_SFT_IDXT /* 평균안전지수 - 데이터 없음 */
        FROM TB_SVPD_VHC_OPRTN_DTL C1 /* 차량운행상세 */
                 INNER JOIN TB_SVPD_VHC_DSB_IZ C3 /* 차량지급내역 */
                            ON C1.VHC_MNGT_NO = C3.VHC_MNGT_NO
                                AND C1.VHC_MNGT_SN = C3.VHC_MNGT_SN
                                AND C1.VHC_OPRTN_DT BETWEEN C3.VHC_PYMDT AND C3.DSB_ENDDT
                 INNER JOIN TB_OGBS_MM_PRTNR_IZ P1
                            ON P1.BASE_YM = '202311'
                                AND C1.VHC_MNGT_OG_TP_CD = P1.OG_TP_CD
                                AND C1.VHC_MNGT_PRTNR_NO = P1.PRTNR_NO
                 INNER JOIN HIST
                            ON C1.CARNO = HIST.CARNO
        WHERE 1=1
        <if test="@MybatisUtils@isNotEmpty(rgstYn)">
            <choose>
                <when test='@MybatisUtils@equals(rgstYn, "Y")'>
        AND C1.VHC_MNGT_NO IS NOT NULL
                </when>
                <when test='@MybatisUtils@equals(rgstYn, "N")'>
        AND C1.VHC_MNGT_NO IS NULL
                </when>
            </choose>
        </if>
        <if test="@MybatisUtils@isNotEmpty(ogId)">
        AND P1.OG_ID = #{ogId}
        </if>
        <if test="@MybatisUtils@isNotEmpty(prtnrNo)">
            AND P1.PRTNR_NO = #{prtnrNo}
        </if>
        AND C1.VHC_OPRTN_DT BETWEEN #{startDt} AND #{endDt}
   ORDER BY P1.OG_NM , P1.PRTNR_NO, C1.VHC_OPRTN_DT DESC
    </select>
</mapper>
