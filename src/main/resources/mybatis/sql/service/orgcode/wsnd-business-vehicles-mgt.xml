<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.orgcode.mapper.WsndBusinessVehiclesMgtMapper">
    <select id="selectBusinessVehicles" resultType="com.kyowon.sms.wells.web.service.orgcode.dto.WsndBusinessVehiclesMgtDto$SearchRes">
        /*SELECT T1.OG_CD
             , T1.OG_TP_CD
             , T1.OG_NM
             , T1.PRTNR_NO
             , T1.PRTNR_KNM
             , T1.CNTR_DT
             , T3.CARNO
             , (SELECT A.CARNM
                  FROM TB_IFIN_SAP_EGBVC_DSB_RCV_ETXT A
                 WHERE A.CARSEQ = T3.VHC_MNGT_NO) AS CARNM
             , T3.VHC_MNGT_TP_CD
             , T3.VHC_PYMDT
             , T3.DSB_ENDDT
             , T3.INSR_AGE_CD
             , T3.RFLNG_CDNO_ENCR
             , T3.HIPS_CDNO_ENCR
             , T3.VHC_MNGT_NO
             , T3.VHC_MNGT_SN
             , T3.VHC_MNGT_PRTNR_NO
          FROM TB_OGBS_MM_PRTNR_IZ T1
          LEFT OUTER JOIN TB_OGBS_MM_OG_IZ T2
            ON T2.OG_CD = T1.OG_CD
          LEFT OUTER JOIN TB_SVPD_VHC_DSB_IZ T3
            ON T3.VHC_MNGT_PRTNR_NO = T1.PRTNR_NO
         WHERE T1.DTA_DL_YN = 'N'
           AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN T1.CNTR_DT AND T1.CLTN_DT
           AND (T1.PRTNR_CLSF_CD = '1' OR (T1.PRTNR_CLSF_CD = '2' AND (T1.OG_CD IN (
                                                                                    SELECT A.OG_CD
                                                                                      FROM TB_OGBS_MM_OG_IZ A
                                                                                     WHERE A.OG_CD IN ('71314', '71356')
                                                                                   )
                                                                      )
                                                                   OR T1.OG_CD IN (
                                                                                    SELECT B.OG_CD
                                                                                      FROM TB_OGBS_MM_OG_IZ B
                                                                                     WHERE B.OG_CD IN ('71314', '71356')
                                                                                  )
                                          )
                                       OR (T1.PRTNR_CLSF_CD = '2' AND T1.PRTNR_CLSF_CD = '71414')
               )
           <if test='@MybatisUtils@isNotEmpty(ogCd)'>
           AND T1.OG_CD = #{ogCd}
           </if>
           <if test='@MybatisUtils@isNotEmpty(hgrOgId)'>
           AND T2.HGR_OG_ID = #{hgrOgId}
           </if>
           <if test='@MybatisUtils@isNotEmpty(prtnrNo)'>
           AND T1.PRTNR_NO = #{prtnrNo}
           </if>
           <if test='@MybatisUtils@isNotEmpty(findGb) and findGb == "1"'>
           AND T3.VHC_MNGT_NO IS NULL
           </if>
         ORDER BY T1.OG_CD, T1.PRTNR_NO*/
        SELECT 'H937140 지점' AS OG_NM, '1305670' AS PRTNR_NO, '이창남' AS PRTNR_KNM, '매니저' AS ROL, '20180813' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '12345' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'B912060 지점' AS OG_NM, '1644128' AS PRTNR_NO, '유정혜' AS PRTNR_KNM, '매니저' AS ROL, '20180402' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'F953010 지점' AS OG_NM, '1682742' AS PRTNR_NO, '주성신' AS PRTNR_KNM, '매니저' AS ROL, '20191209' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'G971040 지점' AS OG_NM, '1726187' AS PRTNR_NO, '김은주' AS PRTNR_KNM, '매니저' AS ROL, '20210401' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'B912020 지점' AS OG_NM, '1747765' AS PRTNR_NO, '박미진' AS PRTNR_KNM, '매니저' AS ROL, '20220404' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'F917110 지점' AS OG_NM, '1748813' AS PRTNR_NO, '백서윤' AS PRTNR_KNM, '매니저' AS ROL, '20220511' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'D933040 지점' AS OG_NM, '1635038' AS PRTNR_NO, '이민주' AS PRTNR_KNM, '지점장' AS ROL, '20171211' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'E923030 지점' AS OG_NM, '1402128' AS PRTNR_NO, '양희숙' AS PRTNR_KNM, '매니저' AS ROL, '20160317' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'G961050 지점' AS OG_NM, '1664907' AS PRTNR_NO, '이성남' AS PRTNR_KNM, '매니저' AS ROL, '20210409' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'C932100 지점' AS OG_NM, '972936' AS PRTNR_NO, '전선자' AS PRTNR_KNM, '지점장' AS ROL, '20070401' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT '광주지점' AS OG_NM, '36754' AS PRTNR_NO, '강훈' AS PRTNR_KNM, '직무1급' AS ROL, '20120109' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'D933040 지점' AS OG_NM, '1367427' AS PRTNR_NO, '박고은' AS PRTNR_KNM, '매니저' AS ROL, '20220503' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'F952030 지점' AS OG_NM, '1466521' AS PRTNR_NO, '이순옥' AS PRTNR_KNM, '매니저' AS ROL, '20130726' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'H961050 지점' AS OG_NM, '1103394' AS PRTNR_NO, '최명숙' AS PRTNR_KNM, '지점장' AS ROL, '20170106' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL UNION ALL
        SELECT 'D925100 지점' AS OG_NM, '1427788' AS PRTNR_NO, '추은하' AS PRTNR_KNM, '매니저' AS ROL, '20201105' AS ENTCO_DT, '' AS CARNO, '' AS VHC_KND_CD, '' AS VHC_MNGT_TP_CD, '' AS VHC_PYM_DT, '' AS DSB_END_DT, '' AS INSR_AGE_CD, '' AS RFLNG_CDNO_ENCR, '' AS HIPS_CDNO_ENCR, '' AS VHC_DSB_RMK_CN, '' AS OG_CD, '' AS VHC_MNGT_NO, '' AS VHC_MNGT_SN, '' AS VHC_MNGT_PRTNR_NO FROM DUAL
    </select>

    <select id="selectBusinessVehicle"
            resultType="com.kyowon.sms.wells.web.service.orgcode.dto.WsndBusinessVehiclesMgtDto$FindRes">
        SELECT T1.VHC_MNGT_NO
             , T1.VHC_MNGT_PRTNR_NO
             , T1.VHC_MNGT_SN
             , T1.CARNO
             , T1.VHC_MNGT_OG_TP_CD
             , T1.VHC_PYMDT
             , T1.DSB_ENDDT
             , T1.VHC_KND_CD
             , T1.VHC_MNGT_TP_CD
             , T1.INSR_AGE_CD
             , T1.RFLNG_CDNO_ENCR
             , T1.HIPS_CDNO_ENCR
             , T1.VHC_DSB_RMK_CN
          FROM TB_SVPD_VHC_DSB_IZ T1
         WHERE T1.VHC_MNGT_NO = #{vhcMngtNo}
           AND T1.VHC_MNGT_SN = (CASE WHEN T1.VHC_MNGT_SN = 00 THEN (SELECT TO_NUMBER(MAX(T2.VHC_MNGT_SN))
                                                                       FROM TB_SVPD_VHC_DSB_IZ T2
                                                                      WHERE T2.VHC_MNGT_PRTNR_NO = #{vhcMngtNo})
                                      ELSE TO_NUMBER(#{vhcMngtSn})
                                  END)
           AND T1.DTA_DL_YN = 'N'
    </select>

    <update id="mergeBusinessVehicle">
        MERGE
         INTO TB_SVPD_VHC_DSB_IZ T1
        USING (
               SELECT #{vhcMngtNo} AS VHC_MNGT_NO
                    , (CASE WHEN #{vhcMngtSn} IS NULL THEN (SELECT MAX(A.VHC_MNGT_SN)
                                                              FROM TB_SVPD_VHC_DSB_IZ A
                                                             WHERE A.VHC_MNGT_NO = #{vhcMngtNo})
                                                      ELSE #{vhcMngtSn}
                       END) AS VHC_MNGT_SN
                    , #{carno} AS CARNO
                    , #{vhcMngtOgTpCd} AS VHC_MNGT_OG_TP_CD
                    , #{vhcMngtPrtnrNo} AS VHC_MNGT_PRTNR_NO
                    , #{vhcPymdt} AS VHC_PYMDT
                    , #{dsbEnddt} AS DSB_ENDDT
                    , #{vhcMngtTpCd} AS VHC_MNGT_TP_CD
                    , #{insrAgeCd} AS INSR_AGE_CD
                    , #{rflngCdnoEncr} AS RFLNG_CDNO_ENCR
                    , #{hipsCdnoEncr} AS HIPS_CDNO_ENCR
                    , #{vhcDsbRmkCn} AS VHC_DSB_RMK_CN
                    , #{vhcKndCd} AS VHC_KND_CD
                 FROM DUAL
              ) T2
           ON (
               T2.VHC_MNGT_NO = T1.VHC_MNGT_NO
           AND T2.VHC_MNGT_SN = T1.VHC_MNGT_SN
              )
        WHEN MATCHED THEN
      UPDATE
         SET T1.CARNO = T2.CARNO
           , T1.VHC_PYMDT = T2.VHC_PYMDT
           , T1.DSB_ENDDT = T2.DSB_ENDDT
           , T1.VHC_MNGT_TP_CD = T2.VHC_MNGT_TP_CD
           , T1.INSR_AGE_CD = T2.INSR_AGE_CD
           , T1.RFLNG_CDNO_ENCR = T2.RFLNG_CDNO_ENCR
           , T1.HIPS_CDNO_ENCR = T2.HIPS_CDNO_ENCR
           , T1.VHC_DSB_RMK_CN = T2.VHC_DSB_RMK_CN
           <include refid="COMMON.updateSystemField"/>
        WHEN NOT MATCHED THEN
      INSERT
           ( T1.VHC_MNGT_NO
           , T1.VHC_MNGT_SN
           , T1.CARNO
           , T1.VHC_MNGT_OG_TP_CD
           , T1.VHC_MNGT_PRTNR_NO
           , T1.VHC_PYMDT
           , T1.DSB_ENDDT
           , T1.VHC_MNGT_TP_CD
           , T1.INSR_AGE_CD
           , T1.RFLNG_CDNO_ENCR
           , T1.HIPS_CDNO_ENCR
           , T1.VHC_DSB_RMK_CN
           , T1.DTA_DL_YN
           <include refid="COMMON.insertSystemField"/>
           )
      VALUES
           ( T2.VHC_MNGT_NO
           , T2.VHC_MNGT_SN
           , T2.CARNO
           , T2.VHC_MNGT_OG_TP_CD
           , T2.VHC_MNGT_PRTNR_NO
           , T2.VHC_PYMDT
           , T2.DSB_ENDDT
           , T2.VHC_MNGT_TP_CD
           , T2.INSR_AGE_CD
           , T2.RFLNG_CDNO_ENCR
           , T2.HIPS_CDNO_ENCR
           , T2.VHC_DSB_RMK_CN
           , 'N'
           <include refid="COMMON.insertSystemFieldValue"/>
           )
    </update>

    <select id="selectAllVehicles"
            resultType="com.kyowon.sms.wells.web.service.orgcode.dto.WsndBusinessVehiclesMgtDto$SearchVehiclesRes">
        SELECT T1.CARSEQ
             , T1.OWSTAT
             , T1.CARNO
             , T1.CARNM
             , T1.CARDNO1
             , T1.CARDNO2
          FROM TB_IFIN_SAP_EGBVC_DSB_RCV_ETXT T1
         WHERE 1=1
           AND (TRIM(DDATE) IS NULL OR TRIM(DDATE) = '00000000')
         ORDER BY TRIM(CARNO)
    </select>
</mapper>
