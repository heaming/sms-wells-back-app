<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.interfaces.mapper.WsniCapsulepkgChSppinfMapper">

    <select id="selectCapsulepkgChSppinfs" resultType="com.kyowon.sms.wells.web.service.interfaces.dto.WsniCapsulepkgChSppinfDto$SearchRes">
        SELECT T.VST_DT                                             AS SPP_DUEDT          /* 배송예정일자 */
             , T.PD_CD                                                                    /* 상품코드 */
             , T.PD_NM                                                                    /* 상품명 */
             , T.AFCH_PD_CD                                                               /* 변경 후 상품코드 */
             , T.AFCH_PD_NM                                                               /* 변경 후 상품명 */
             , LISTAGG(PART_NM, '/') WITHIN GROUP(ORDER BY PART_NM) AS DT_INFO            /* 패키지구성정보 */
             , T.SELL_AMT                                                                 /* 판매금액 */
             , CASE WHEN T.WK_DT IS NOT NULL                                                             THEN '70'   /* 배송완료 */
                    WHEN T.WK_DT IS NULL
                     AND SUBSTR(T.VST_DT, 1, 6) = TO_CHAR(SYSDATE, 'YYYYMM')                             THEN '60'   /* 배송진행 */
                    WHEN T.WK_DT IS NULL
                     AND SUBSTR(T.VST_DT, 1, 6) <![CDATA[>=]]> TO_CHAR(ADD_MONTHS(SYSDATE, 1), 'YYYYMM') THEN '50'   /* 배송예정 */
               END                                                  AS SPP_PRGS_STAT_CD   /* 배송진행상태코드 */
             , T.IST_ADDR                                                                 /* 설치주소 */
          FROM
             (
               SELECT ( SELECT MIN(BASE_Y || BASE_MM || BASE_D)
                          FROM TB_SVPD_SV_CLND_BAS   /* 서비스달력기본 */
                         WHERE DTA_DL_YN = 'N'
                           AND ( PHLD_YN IS NULL OR PHLD_YN = 'N' )
                           AND BASE_Y  = SUBSTR(D1.VST_DUEDT, 1, 4)
                           AND BASE_MM = SUBSTR(D1.VST_DUEDT, 5, 2)
                           AND BASE_D <![CDATA[>=]]> '10' )              AS VST_DT
                    , D3.BASE_PD_CD                                      AS PD_CD
                    , ( SELECT PD_NM
                          FROM TB_PDBS_PD_BAS
                         WHERE PD_CD = D3.BASE_PD_CD )                   AS PD_NM
                    , NVL(D8.OJ_PD_CD, D9.PDCT_PD_CD)                    AS AFCH_PD_CD
                    , ( SELECT PD_NM
                          FROM TB_PDBS_PD_BAS
                         WHERE PD_CD = NVL(D8.OJ_PD_CD, D9.PDCT_PD_CD) ) AS AFCH_PD_NM
                    , D1.PART_PD_CD
                    , D1.PART_USE_QTY
                    , ( SELECT PD_NM || D1.PART_USE_QTY || '건'
                          FROM TB_PDBS_PD_BAS
                         WHERE PD_CD = D1.PART_PD_CD )                   AS PART_NM
                    , D4.FNL_VAL                                         AS SELL_AMT
                    , D1.WK_DT
                    , D7.RNADR || ' ' || D7.RDADR                        AS IST_ADDR
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1            /* 고객서비스정기BS주기내역 */
                 LEFT OUTER JOIN TB_SVPD_HCF_AS_AK_IZ D2     /* 홈카페AS요청내역 */
                   ON D2.CNTR_NO               = D1.CNTR_NO
                  AND D2.CNTR_SN               = D1.CNTR_SN
                  AND SUBSTR(D2.AK_CHDT, 1, 6) = SUBSTR(D1.VST_DUEDT, 1, 6)
                  AND D2.DTA_DL_YN             = 'N'
                INNER JOIN TB_SSCT_CNTR_DTL D3               /* 계약상세 */
                   ON D3.CNTR_NO = D1.CNTR_NO
                  AND D3.CNTR_SN = D1.CNTR_SN
                INNER JOIN
                    (
                      SELECT DISTINCT S1.PD_CD
                           , S1.PD_NM
                           , S1.SELL_STRTDT
                           , S1.SELL_ENDDT
                           , S4.FNL_VAL
                        FROM TB_PDBS_PD_BAS S1                      /* 상품기본 */
                       INNER JOIN TB_PDBS_PD_REL S2                 /* 상품관계 */
                          ON S2.BASE_PD_CD = S1.PD_CD
                        LEFT OUTER JOIN TB_PDBS_PD_PRC_BAS S3       /* 상품가격기본 */
                          ON S3.PD_CD        = S1.PD_CD
                         AND S3.DTA_DL_YN    = 'N'
                         AND S3.HIST_END_DTM = '99991231235959'
                         AND TO_CHAR(SYSDATE, 'YYYYYMMDDHH24MISS') BETWEEN S3.VL_STRT_DTM AND S3.VL_END_DTM
                        LEFT OUTER JOIN TB_PDBS_PD_PRC_FNL_DTL S4   /* 상품가격최종상세 */
                          ON S4.PD_PRC_ID = S3.PD_PRC_ID
                         AND S4.VER_SN    = S3.VER_SN
                         AND S4.DTA_DL_YN = 'N'
                         AND TO_CHAR(SYSDATE, 'YYYYYMMDDHH24MISS') BETWEEN S4.VL_STRT_DTM AND S4.VL_END_DTM
                       WHERE S1.DTA_DL_YN    = 'N'
                         AND S1.PD_TP_CD     = 'P'
                         AND S1.SELL_TP_CD   = '6'
                         AND S2.DTA_DL_YN    = 'N'
                         AND S2.PD_REL_TP_CD = '05'
                         AND TO_CHAR(SYSDATE, 'YYYYYMMDDHH24MISS') BETWEEN S2.VL_STRT_DTM AND S2.VL_END_DTM
                    ) D4                                     /* 정기배송 패키지 */
                   ON D4.PD_CD = NVL(D2.AFCH_PD_CD, D3.BASE_PD_CD)
                  AND SUBSTR(D1.VST_DUEDT, 1, 6) || '10' BETWEEN D4.SELL_STRTDT AND D4.SELL_ENDDT
                 LEFT OUTER JOIN TB_SSCT_CNTR_ADR_REL D5     /* 계약주소관계 */
                   ON D5.DTL_CNTR_NO = D1.CNTR_NO
                  AND D5.DTL_CNTR_SN = D1.CNTR_SN
                  AND D5.DTA_DL_YN   = 'N'
                  AND D5.ADRPC_TP_CD IN ('2', '3')
                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN D5.VL_STRT_DTM AND D5.VL_END_DTM
                 LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS D6   /* 계약주소지기본 */
                   ON D6.CNTR_ADRPC_ID = D5.CNTR_ADRPC_ID
                  AND D6.DTA_DL_YN     = 'N'
                 LEFT OUTER JOIN TB_GBCO_ADR_BAS D7          /* 주소기본 */
                   ON D7.ADR_ID    = D6.ADR_ID
                  AND D7.DTA_DL_YN = 'N'
                 LEFT OUTER JOIN TB_PDBS_PD_REL D8           /* 상품관계 */
                   ON D8.BASE_PD_CD   = D2.AFCH_PD_CD
                  AND D8.DTA_DL_YN    = 'N'
                  AND D8.PD_REL_TP_CD = '18'   /* 정기배송 제품명(BS) */
                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN D8.VL_STRT_DTM AND D8.VL_END_DTM
                INNER JOIN TB_SVPD_CST_SV_EXCN_IZ D9         /* 고객서비스수행내역 */
                   ON D9.CNTR_NO = D1.CNTR_NO
                  AND D9.CNTR_SN = D1.CNTR_SN
                WHERE D1.DTA_DL_YN = 'N'
                  AND D3.DTA_DL_YN = 'N'
                  AND D9.DTA_DL_YN = 'N'
                  AND D1.VST_DUEDT <![CDATA[<]]> CASE WHEN TO_CHAR(SYSDATE, 'DD') <![CDATA[<=]]> '20'
                                                      THEN TO_CHAR(ADD_MONTHS(SYSDATE, 1), 'YYYYMM') || '99'
                                                      ELSE TO_CHAR(ADD_MONTHS(SYSDATE, 2), 'YYYYMM') || '99'
                                                 END
                  AND D1.CNTR_NO   = #{cntrNo}
                  AND D1.CNTR_SN   = #{cntrSn}
               ) T
         GROUP BY T.VST_DT, T.PD_CD, T.PD_NM, T.AFCH_PD_CD, T.AFCH_PD_NM, T.SELL_AMT, T.WK_DT, T.IST_ADDR
         ORDER BY T.VST_DT
    </select>

</mapper>
