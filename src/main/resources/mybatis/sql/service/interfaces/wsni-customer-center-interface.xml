<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.interfaces.mapper.WsniCustomerCenterInterfaceMapper">
    <select id="selectEngineerContactPs" resultType="com.kyowon.sms.wells.web.service.interfaces.dto.WsniCustomerCenterInterfaceDto$SearchContactRes">
        SELECT I1.AS_AK_ID
             , I1.SYS_DV_CD
             , T2.CST_SV_ASN_NO
             , T2.CNTC_DT
             , T2.CNTC_HH
             , T2.ABSNC_RSON_CD
             , T2.OG_TP_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'OG_TP_CD', T2.OG_TP_CD) OG_TP_CD_NM
             , O1.PRTNR_NO
             , O1.PRTNR_KNM
          FROM TB_IFIN_CST_CNR_AS_AK_RCV_ETXT I1
         INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ T1
            ON I1.CST_SV_ASN_NO = T1.CST_SV_ASN_NO
         INNER JOIN TB_SVPD_CST_SV_CNTC_IZ T2
            ON T1.CST_SV_ASN_NO = T2.CST_SV_ASN_NO
         INNER JOIN TB_OGBS_PRTNR_BAS O1
            ON T2.OG_TP_CD = O1.OG_TP_CD
           AND T2.PRTNR_NO = O1.PRTNR_NO
         WHERE T1.AS_AK_ID = #{asAkId}
           AND T1.CST_SV_ASN_NO = #{cstSvAsnNo}
    </select>

    <select id="selectEngineerPromChHist" resultType="com.kyowon.sms.wells.web.service.interfaces.dto.WsniCustomerCenterInterfaceDto$SearchPromChRes">
        SELECT I1.AS_AK_ID
             , I1.SYS_DV_CD
             , T1.SV_BIZ_HCLSF_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_HCLSF_CD', T1.SV_BIZ_HCLSF_CD) AS SV_BIZ_HCLSF_CD_NM
             , T1.SV_BIZ_DCLSF_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_DCLSF_CD', T1.SV_BIZ_DCLSF_CD) AS SV_BIZ_DCLSF_CD_NM
             , T2.AS_IST_OJ_NO
             , T1.CNTR_NO
             , T1.CNTR_SN
             , S1.SELL_TP_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'PRD_MNGT_TP_CD', S1.SELL_TP_CD) AS SELL_TP_CD_NM
             , T1.FST_RGST_USR_ID
             , (SELECT X1.USR_NM FROM T_CMP_USR_ACO_M X1 WHERE X1.USR_ID = T1.FST_RGST_USR_ID) FST_RGST_USR_NM
             , T2.MTR_STAT_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'MTR_STAT_CD', T2.MTR_STAT_CD) AS MTR_STAT_CD_NM
             , T1.WK_EXCN_DT
             , T1.WK_EXCN_HH
             , T1.WK_PRGS_STAT_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'WK_PRGS_STAT_CD', T1.WK_PRGS_STAT_CD) AS WK_PRGS_STAT_CD_NM
             , T1.WK_CAN_RSON_CD
             , T1.WK_CAN_MO_CN
             , I1.URGT_YN
             , T2.VST_RQDT
             , T2.VST_AK_HH
             , T2.CNSL_TP_HCLSF_CD
             , (SELECT X1.CNSL_CLSF_NM FROM TB_IFIN_CNSL_HCLSF_CRCV_ETXT X1 WHERE T2.CNSL_TP_HCLSF_CD = X1.CNSL_TP_HCLSF_CD) CNSL_TP_HCLSF_CD_NM
             , T2.CNSL_TP_MCLSF_CD
             , (SELECT X1.CNSL_CLSF_NM FROM TB_IFIN_CNSL_MCLSF_CRCV_ETXT X1 WHERE T2.CNSL_TP_HCLSF_CD = X1.CNSL_TP_HCLSF_CD AND T2.CNSL_TP_MCLSF_CD = X1.CNSL_TP_MCLSF_CD) CNSL_TP_MCLSF_CD_NM
             , T2.CNSL_TP_LCLSF_CD
             , (SELECT X1.CNSL_CLSF_NM
                  FROM TB_IFIN_CNSL_LCLSF_CRCV_ETXT X1
                 WHERE T2.CNSL_TP_HCLSF_CD = X1.CNSL_TP_HCLSF_CD
                   AND T2.CNSL_TP_MCLSF_CD = X1.CNSL_TP_MCLSF_CD
                   AND T2.CNSL_TP_LCLSF_CD = X1.CNSL_TP_LCLSF_CD) CNSL_TP_LCLSF_CD_NM
             , T2.CNSL_DTLP_TP_CD
             , T2.SMS_FW_YN
             , T2.DP_DV_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'DP_DV_CD', T2.DP_DV_CD) DP_DV_CD_NM
             , T2.SV_ET_AMT
             , T1.SV_CNR_OG_ID
             , O1.OG_NM SV_CNR_OG_NM
             , T1.WK_PRTNR_NO
             , O2.PRTNR_KNM AS WK_PRTNR_KNM
          FROM TB_IFIN_CST_CNR_AS_AK_RCV_ETXT I1
         INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ T1
            ON I1.CST_SV_ASN_NO = T1.CST_SV_ASN_NO
         INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ T2
            ON T1.CST_SV_ASN_NO = T2.CST_SV_ASN_NO
         INNER JOIN TB_SSCT_CNTR_DTL S1
            ON T1.CNTR_NO = S1.CNTR_NO
           AND T1.CNTR_SN = S1.CNTR_SN
         INNER JOIN TB_OGBS_OG_BAS O1
            ON T1.SV_CNR_OG_ID = O1.OG_ID
         INNER JOIN TB_OGBS_PRTNR_BAS O2
            ON T1.WK_PRTNR_OG_TP_CD = O2.OG_TP_CD
           AND T1.WK_PRTNR_NO = O2.PRTNR_NO
         WHERE 1 = 1
           AND I1.AS_AK_ID = #{asAkId}
           AND I1.RCP_COSLR_ID = #{wkPrtnrNo}
           AND I1.RCPDT = #{wkdT}
    </select>

    <select id="selectEngineerCancels" resultType="com.kyowon.sms.wells.web.service.interfaces.dto.WsniCustomerCenterInterfaceDto$SearchCancelRes">
        SELECT I1.AS_AK_ID
             , I1.SYS_DV_CD
             , T1.SV_BIZ_HCLSF_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_HCLSF_CD', T1.SV_BIZ_HCLSF_CD) AS SV_BIZ_HCLSF_CD_NM
             , T1.SV_BIZ_DCLSF_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_DCLSF_CD', T1.SV_BIZ_DCLSF_CD) AS SV_BIZ_DCLSF_CD_NM
             , T2.AS_IST_OJ_NO
             , T1.CNTR_NO
             , T1.CNTR_SN
             , S1.SELL_TP_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'PRD_MNGT_TP_CD', S1.SELL_TP_CD) AS SELL_TP_CD_NM
             , T1.FST_RGST_USR_ID
             , (SELECT X1.USR_NM FROM T_CMP_USR_ACO_M X1 WHERE X1.USR_ID = T1.FST_RGST_USR_ID) FST_RGST_USR_NM
             , T2.MTR_STAT_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'MTR_STAT_CD', T2.MTR_STAT_CD) AS MTR_STAT_CD_NM
             , T1.WK_EXCN_DT
             , T1.WK_EXCN_HH
             , T1.WK_PRGS_STAT_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'WK_PRGS_STAT_CD', T1.WK_PRGS_STAT_CD) AS WK_PRGS_STAT_CD_NM
             , T1.WK_CAN_RSON_CD
             , T1.WK_CAN_MO_CN
             , I1.URGT_YN
             , T2.VST_RQDT
             , T2.VST_AK_HH
             , T2.CNSL_TP_HCLSF_CD
             , (SELECT X1.CNSL_CLSF_NM FROM TB_IFIN_CNSL_HCLSF_CRCV_ETXT X1 WHERE T2.CNSL_TP_HCLSF_CD = X1.CNSL_TP_HCLSF_CD) CNSL_TP_HCLSF_CD_NM
             , T2.CNSL_TP_MCLSF_CD
             , (SELECT X1.CNSL_CLSF_NM FROM TB_IFIN_CNSL_MCLSF_CRCV_ETXT X1 WHERE T2.CNSL_TP_HCLSF_CD = X1.CNSL_TP_HCLSF_CD AND T2.CNSL_TP_MCLSF_CD = X1.CNSL_TP_MCLSF_CD) CNSL_TP_MCLSF_CD_NM
             , T2.CNSL_TP_LCLSF_CD
             , (SELECT X1.CNSL_CLSF_NM
                  FROM TB_IFIN_CNSL_LCLSF_CRCV_ETXT X1
                 WHERE T2.CNSL_TP_HCLSF_CD = X1.CNSL_TP_HCLSF_CD
                   AND T2.CNSL_TP_MCLSF_CD = X1.CNSL_TP_MCLSF_CD
                   AND T2.CNSL_TP_LCLSF_CD = X1.CNSL_TP_LCLSF_CD) CNSL_TP_LCLSF_CD_NM
             , T2.CNSL_DTLP_TP_CD
             , T2.SMS_FW_YN
             , T2.DP_DV_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'DP_DV_CD', T2.DP_DV_CD) DP_DV_CD_NM
             , T2.SV_ET_AMT
             , T1.SV_CNR_OG_ID
             , O1.OG_NM SV_CNR_OG_NM
             , T1.WK_PRTNR_NO
             , O2.PRTNR_KNM AS WK_PRTNR_KNM
          FROM TB_IFIN_CST_CNR_AS_AK_RCV_ETXT I1
         INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ T1
            ON I1.CST_SV_ASN_NO = T1.CST_SV_ASN_NO
         INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ T2
            ON T1.CST_SV_ASN_NO = T2.CST_SV_ASN_NO
         INNER JOIN TB_SSCT_CNTR_DTL S1
            ON T1.CNTR_NO = S1.CNTR_NO
           AND T1.CNTR_SN = S1.CNTR_SN
         INNER JOIN TB_OGBS_OG_BAS O1
            ON T1.SV_CNR_OG_ID = O1.OG_ID
         INNER JOIN TB_OGBS_PRTNR_BAS O2
            ON T1.WK_PRTNR_OG_TP_CD = O2.OG_TP_CD
           AND T1.WK_PRTNR_NO = O2.PRTNR_NO
         WHERE 1 = 1
           AND I1.AS_AK_ID = #{asAkId}
           AND I1.RCP_COSLR_ID = #{wkPrtnrNo}
           AND I1.RCPDT = #{wkdT}
    </select>

    <select id="selectSeedingRegularShippingPdct" resultType="com.kyowon.sms.wells.web.service.interfaces.dto.WsniCustomerCenterInterfaceDto$SearchSppPdctRes">
        SELECT T1.CNTR_NO
             , T1.CNTR_SN
             , T1.SV_BIZ_HCLSF_CD
             , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_HCLSF_CD', T1.SV_BIZ_HCLSF_CD) AS SV_BIZ_HCLSF_NM
             , T1.SPP_ORD_NO
             , T1.SPP_SN
             , T1.SDING_PD_CD1
             , P1.PD_NM AS SDING_PD_NM1
             , T1.SDING_QTY1
             , T1.SDING_PD_CD2
             , P2.PD_NM AS SDING_PD_NM2
             , T1.SDING_QTY2
             , T1.SDING_PD_CD3
             , P3.PD_NM AS SDING_PD_NM3
             , T1.SDING_QTY3
             , T1.SDING_PD_CD4
             , P4.PD_NM AS SDING_PD_NM4
             , T1.SDING_QTY4
             , T1.SDING_PD_CD5
             , P5.PD_NM AS SDING_PD_NM5
             , T1.SDING_QTY5
             , T1.VST_DT
          FROM TB_SVPD_SDING_SPP_CNFM_IZ T1
         INNER JOIN TB_PDBS_PD_BAS P1
            ON T1.SDING_PD_CD1 = P1.PD_CD
         INNER JOIN TB_PDBS_PD_BAS P2
            ON T1.SDING_PD_CD2 = P2.PD_CD
         INNER JOIN TB_PDBS_PD_BAS P3
            ON T1.SDING_PD_CD3 = P3.PD_CD
         INNER JOIN TB_PDBS_PD_BAS P4
            ON T1.SDING_PD_CD4 = P4.PD_CD
         INNER JOIN TB_PDBS_PD_BAS P5
            ON T1.SDING_PD_CD5 = P5.PD_CD
         WHERE 1 = 1
           AND T1.CNTR_NO = #{cntrNo}
           AND T1.CNTR_SN = #{cntrSn}
    </select>

    <select id="selectSeedingRegularShippingVst" resultType="com.kyowon.sms.wells.web.service.interfaces.dto.WsniCustomerCenterInterfaceDto$SearchSppVstRes">
        WITH BASE AS (
            SELECT T1.CNTR_NO
                 , T1.CNTR_SN
                 , T1.PDCT_PD_CD
                 , TO_CHAR(SYSDATE, 'YYYYMMDD') TODAY
                 , TO_CHAR(SYSDATE + 40, 'YYYYMMDD') TODAY_PLUS_40_DAY
                 , TO_CHAR(ADD_MONTHS(TO_DATE(T1.IST_DT), 2), 'YYYYMMDD') IST_PLUS_2_MONTH_DT
                 , TO_CHAR(ADD_MONTHS(TO_DATE(T1.IST_DT), 4), 'YYYYMMDD') IST_PLUS_4_MONTH_DT
                 , (SELECT GREATEST(SUBSTR(MAX(X1.MTR_CAN_DT), 1, 4) || '1231', TO_CHAR(SYSDATE + 40, 'YYYYMMDD'))
                      FROM TB_SVPD_CST_SV_RGBSPR_IZ X1
                     WHERE T1.CNTR_NO = X1.CNTR_NO
                       AND T1.CNTR_SN = X1.CNTR_SN
                       AND X1.MTR_CAN_DT <![CDATA[<=]]> TO_CHAR(SYSDATE, 'YYYYMMDD')) LAST_MTR_CAN_DT
            FROM TB_SVPD_CST_SV_EXCN_IZ T1
           WHERE T1.CNTR_NO = #{cntrNo}
             AND T1.CNTR_SN = #{cntrSn}
        )
        SELECT Y1.CNTR_NO
             , Y1.CNTR_SN
             , Y1.VST_DUEDT
             , TO_CHAR(TO_DATE(Y1.VST_DUEDT) - 41, 'YYYYMMDD') CH_VST_CL_DT
             , Y1.STP_DUEDT
             , TO_CHAR(TO_DATE(Y1.STP_DUEDT) - 41, 'YYYYMMDD') STP_CL_DT
             , Y1.LAST_STP_DT
             , Y1.GDC_CD
             , Y1.GDC_NM
             , Y1.SALE_CD
          FROM (SELECT T1.CNTR_NO
                     , T1.CNTR_SN
                     , T1.PDCT_PD_CD GDC_CD
                     , P1.PD_NM GDC_NM
                     , S1.BASE_PD_CD SALE_CD
                     -- 패키지 변경 가능일자
                     --1. 방문 스케쥴표상에 금일 기준 + 40일 한 날짜 보다 큰 일정 중 제일 작은 날짜를 선택
                     --2. 스케쥴표가 없다면 설치 일자 기준으로 2달 뒤에 날짜가 금일 기준 + 40일 한 날짜 보다 크면 그 날짜를 아니면 4달 뒤에 날짜를 선택
                     , NVL( (SELECT MIN(X1.VST_DUEDT)
                               FROM TB_SVPD_CST_SV_RGBSPR_IZ X1
                              WHERE T1.CNTR_NO = X1.CNTR_NO
                                AND T1.CNTR_SN = X1.CNTR_SN
                                AND X1.VST_DUEDT > T1.TODAY_PLUS_40_DAY),
                              (CASE WHEN T1.TODAY_PLUS_40_DAY <![CDATA[<]]> T1.IST_PLUS_2_MONTH_DT THEN T1.IST_PLUS_2_MONTH_DT ELSE T1.IST_PLUS_4_MONTH_DT END) )  AS VST_DUEDT
                     -- 2019.05.13 이충관 수정 - 모종중지 내역이 있는 고객의 경우 12개월 이후 중지 가능에서 연도 별 1회 모종중지신청 가능하도록 쿼리 수정(이난영과장님요청)
                     , NVL( (SELECT MIN(X1.VST_DUEDT)
                               FROM TB_SVPD_CST_SV_RGBSPR_IZ X1
                              WHERE T1.CNTR_NO = X1.CNTR_NO
                                AND T1.CNTR_SN = X1.CNTR_SN
                                AND X1.VST_DUEDT > NVL(T1.LAST_MTR_CAN_DT, T1.TODAY_PLUS_40_DAY)),
                              (CASE WHEN T1.TODAY_PLUS_40_DAY <![CDATA[<]]> T1.IST_PLUS_2_MONTH_DT THEN T1.IST_PLUS_2_MONTH_DT ELSE T1.IST_PLUS_4_MONTH_DT END) )  AS STP_DUEDT
                     , (SELECT MAX(X1.MTR_CAN_DT)
                          FROM TB_SVPD_CST_SV_RGBSPR_IZ X1
                         WHERE T1.CNTR_NO = X1.CNTR_NO
                           AND T1.CNTR_SN = X1.CNTR_SN
                           AND X1.MTR_CAN_DT <![CDATA[<=]]> T1.TODAY ) LAST_STP_DT
                  FROM BASE T1
                 INNER JOIN TB_SSCT_CNTR_DTL S1
                    ON T1.CNTR_NO = S1.CNTR_NO
                   AND T1.CNTR_SN = S1.CNTR_SN
                 INNER JOIN TB_PDBS_PD_BAS P1
                    ON T1.PDCT_PD_CD = P1.PD_CD
                ) Y1
    </select>

    <select id="selectAfterServiceBusinessInf" resultType="com.kyowon.sms.wells.web.service.interfaces.dto.WsniCustomerCenterInterfaceDto$SearchAsRes">
        WITH WK_GRP AS (
            SELECT Z1.*
              FROM TB_SVPD_BPD_BIZ_TP_WK_GRP_IZ Z1
             WHERE 1 = 1
               AND Z1.SV_BIZ_DCLSF_CD IN ('3110', '3310', '3320')
               AND Z1.DTA_DL_YN = 'N'
               AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN Z1.APY_STRTDT AND Z1.APY_ENDDT
               AND Z1.IZ_SN = (SELECT MAX(Y1.IZ_SN)
                                 FROM TB_SVPD_BPD_BIZ_TP_WK_GRP_IZ Y1
                                WHERE Z1.PD_CD = Y1.PD_CD
                                  AND Z1.SV_BIZ_DCLSF_CD = Y1.SV_BIZ_DCLSF_CD
                                  AND Y1.DTA_DL_YN = 'N'
                                  AND TO_CHAR(SYSDATE, 'YYYYMMDD') BETWEEN Y1.APY_STRTDT AND Y1.APY_ENDDT)
        )
        SELECT T1.CNTR_NO
             , W1.WK_GRP_CD AS WK_GRP_CD1
             , F_CMZ_CD_NM('TNT_WELLS', 'WK_GRP_CD', W1.WK_GRP_CD) AS WK_GRP_NM1
             , W2.WK_GRP_CD AS WK_GRP_CD2
             , F_CMZ_CD_NM('TNT_WELLS', 'WK_GRP_CD', W2.WK_GRP_CD) AS WK_GRP_NM2
             , W3.WK_GRP_CD AS WK_GRP_CD3
             , F_CMZ_CD_NM('TNT_WELLS', 'WK_GRP_CD', W3.WK_GRP_CD) AS WK_GRP_NM3
          FROM TB_SVPD_CST_SV_EXCN_IZ T1
          LEFT JOIN WK_GRP W1
            ON T1.PDCT_PD_CD = W1.PD_CD
           AND W1.SV_BIZ_DCLSF_CD = '3110'
          LEFT JOIN WK_GRP W2
            ON T1.PDCT_PD_CD = W2.PD_CD
           AND W2.SV_BIZ_DCLSF_CD = '3310'
          LEFT JOIN WK_GRP W3
            ON T1.PDCT_PD_CD = W3.PD_CD
           AND W3.SV_BIZ_DCLSF_CD = '3320'
         WHERE T1.CNTR_NO = #{cntrNo}
           AND T1.CNTR_SN = #{cntrSn}
    </select>

    <insert id="insertFilterShippingAddress">
        INSERT INTO TB_SVPD_CST_SV_SPP_ADR_IZ
             ( CNTR_NO
             , CNTR_SN
             , SPP_TCNT
             , CRAL_LOCARA_TNO
             , MEXNO_ENCR
             , CRAL_IDV_TNO
             , LOCARA_TNO
             , EXNO_ENCR
             , IDV_TNO
             , SPP_ZIP
             , SPP_BAS_ADR
             , SPP_DTL_ADR
             , REF_ADR
             , ADR_DV_CD
             , SPP_DPTU_DT
             , SPP_FSH_DT
             , USE_YN
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             ( #{cntrNo}
             , #{cntrSn}
             , #{sppTcnt}
             , #{cralLocaraTno}
             , #{mexnoEncr}
             , #{cralIdvTno}
             , #{locaraTno}
             , #{exnoEncr}
             , #{idvTno}
             , #{sppZip}
             , #{sppBasAdr}
             , #{sppDtlAdr}
             , #{refAdr}
             , #{adrDvCd}
             , #{sppDptuDt}
             , #{sppFshDt}
             , #{useYn}
             , 'N'
             <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <update id="updateFilterShippingAddress">
        UPDATE TB_SVPD_CST_SV_SPP_ADR_IZ
           SET SPP_FSH_DT = #{sppFshDt}
            <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </update>
</mapper>
