<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.interfaces.mapper.WsnbRegularShippingChangeMapper">

    <insert id="insertRegularShippingChangeHist">
        INSERT INTO TB_SSSO_SPP_CH_RCCH_HIST /* 배송변경접수변경이력 LD3300H */
             ( CNTR_NO
             , CH_RCP_DTM
             , SPP_CH_TP_CD
             , CH_APY_STRTDT /* LCCHGY-LCCHGM-LCCHGD 변경적용시작일자 */
             , DTA_DL_YN
             <include refid="COMMON.insertSystemField"/>
             )
        SELECT CNTR_NO
             , CH_RCP_DTM
             , SPP_CH_TP_CD
             , CH_APY_STRTDT /* LCCHGY-LCCHGM-LCCHGD 변경적용시작일자 */
             , 'Y' /* 삭제여부 */
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_SSSO_SPP_CH_RCP_BAS /* 배송변경접수기본 LD3200P */
         WHERE DTA_DL_YN = 'N'
           AND CNTR_NO = #{cntrNo}
           AND SPP_CH_TP_CD = #{reqGb}
           AND CH_APY_STRTDT = #{reqDt} /* LCCHGY-LCCHGM-LCCHGD 변경적용시작일자 */
    </insert>

    <delete id="deleteRegularShippingChangeDtl">
        /* 배송변경접수상세 삭제 */
        UPDATE TB_SSSO_SPP_CH_RCP_DTL /* 배송변경접수상세 */
           SET DTA_DL_YN = 'Y'
             <include refid="COMMON.updateSystemField"/>
         WHERE SPP_CH_RCP_ID = (SELECT SPP_CH_RCP_ID
                                  FROM TB_SSSO_SPP_CH_RCP_BAS /* 배송변경접수기본 LD3200P */
                                 WHERE CNTR_NO = #{cntrNo})
    </delete>

    <delete id="deleteRegularShippingChangeBase">
        /* 배송변경접수기본 삭제 */
        UPDATE TB_SSSO_SPP_CH_RCP_BAS /* 배송변경접수기본 LD3200P */
           SET DTA_DL_YN = 'Y'
             <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_NO = #{cntrNo}
           AND SPP_CH_TP_CD = #{reqGb} /* P_REQ_GB */
           AND CH_APY_STRTDT = #{reqDt} /* LCCHGY-LCCHGM-LCCHGD 변경적용시작일자 */
    </delete>

    <select id="selectRegularShippingChangeCount" resultType="Integer">
        /* 배송변경접수기본(TB_SSSO_SPP_CH_RCP_BAS)에 처리되지 않은 동일 요청이 있는지 체크 */
        SELECT COUNT(1) AS CNT
          FROM TB_SSSO_SPP_CH_RCP_BAS /* 배송변경접수기본 LD3200P */
         WHERE DTA_DL_YN = 'N'
           AND CNTR_NO = #{cntrNo}
           AND SPP_CH_TP_CD = #{reqGb}
           AND CH_APY_STRTDT = #{reqDt} /* LCCHGY-LCCHGM-LCCHGD 변경적용시작일자 */
    </select>

    <select id="selectRegularShippingChangeMaxSn" resultType="Integer">
        SELECT NVL(MAX(SPP_CH_SN), 0) + 1 AS SEQ
          FROM TB_SSSO_SPP_CH_RCP_DTL /* 배송변경접수상세 */
         WHERE SPP_CH_RCP_ID = (SELECT SPP_CH_RCP_ID
                                  FROM TB_SSSO_SPP_CH_RCP_BAS /* 배송변경접수기본 LD3200P */
                                 WHERE CNTR_NO = #{cntrNo})
    </select>

    <insert id="insertRegularShippingChangeBase">
        INSERT INTO TB_SSSO_SPP_CH_RCP_BAS /* 배송변경접수기본 LD3200P */
             ( CNTR_NO
             , CH_RCP_DTM
             , SPP_CH_TP_CD
             , CH_APY_STRTDT /* LCCHGY-LCCHGM-LCCHGD 변경적용시작일자 */
             <include refid="COMMON.insertSystemField"/>
             )
        SELECT #{cntrNo} AS CNTR_NO
             , TO_CHAR(SYSDATE, 'yyyyMMdd') AS CH_RCP_DTM
             , #{reqGb} AS SPP_CH_TP_CD
             , #{reqDt} AS CH_APY_STRTDT /*LCCHGY-LCCHGM-LCCHGD 변경적용시작일자 */
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM DUAL
    </insert>

    <insert id="insertRegularShippingChangeDtl">
        INSERT INTO TB_SSSO_SPP_CH_RCP_DTL /* 배송변경접수상세 */
             ( SPP_CH_RCP_ID
             <include refid="COMMON.insertSystemField"/>
             )
        SELECT SPP_CH_RCP_ID
             <include refid="COMMON.insertSystemFieldValue"/>
          FROM TB_SSSO_SPP_CH_RCP_BAS /* LD3200P */
         WHERE CNTR_NO = #{cntrNo}
           AND SPP_CH_TP_CD = #{reqGb}
           AND CH_APY_STRTDT = #{reqDt} /* LCCHGY-LCCHGM-LCCHGD 변경적용시작일자 */
    </insert>

    <update id="updateRegularShippingChangeBase">
        UPDATE TB_SSSO_SPP_CH_RCP_BAS /* 배송변경접수기본 LD3200P */
           SET CH_RCP_DTM = TO_CHAR(SYSDATE, 'YYYYMMDD')
             <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_NO = #{cntrNo}
           AND SPP_CH_TP_CD = #{reqGb}
           AND CH_APY_STRTDT = #{reqDt} /* LCCHGY-LCCHGM-LCCHGD 변경적용시작일자 */
    </update>

    <insert id="insertTbSvpdHcfAsAkHist">
        INSERT INTO TB_SVPD_HCF_AS_AK_HIST ( /* 홈카페AS요청이력 */
               CNTR_NO
             , CNTR_SN
             , AK_SN
             , HIST_CH_DTM
             , AS_AK_DV_CD
             , RGST_DT
             , AK_CHDT
             , BFCH_PD_CD
             , AFCH_PD_CD
             , CHO_CAPSL_CN
             , MTR_PROCS_STAT_CD
             , CNFMDT
             <include refid="COMMON.insertSystemField"/>
        ) VALUES (
               #{cntrNo}
             , #{cntrSn}
             , (SELECT NVL(MAX(AK_SN), 0) + 1 AS MAX_AK_SN
                  FROM TB_SVPD_HCF_AS_AK_IZ
                 WHERE DTA_DL_YN = 'N'
                   AND CNTR_NO = #{cntrNo}
                   AND CNTR_SN = #{cntrSn})
             , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') + ${histChDtm}
             , #{asAkDvCd}
             , TO_CHAR(SYSDATE, 'YYYYMMDD')
             , #{akChdt}
             , #{bfchPdCd}
             , #{afchPdCd}
             , NULL
             , #{mtrProcsStatCd}
             , NULL
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
             , NVL(#{rcpIchrPrtnrNo}, #{session.userId})
             , #{session.pageId}
             , NVL((SELECT OG_ID /* 조직ID */
                      FROM TB_OGBS_MM_PRTNR_IZ /* 월파트너내역 */
                     WHERE BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                       AND PRTNR_NO = #{rcpIchrPrtnrNo}
                       AND OG_TP_CD = #{rcpOgTpCd}), NVL(#{session.ogId}, 'NULL'))
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
             , #{session.userId}
             , #{session.pageId}
             , NVL(#{session.ogId}, 'NULL')
        )
    </insert>

    <delete id="deleteTbSvpdHcfAsAkIz">
        UPDATE TB_SVPD_HCF_AS_AK_IZ /* 홈카페AS요청내역 */
           SET DTA_DL_YN = 'Y'
             <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND AK_SN = #{akSn}
           AND SUBSTR(AK_CHDT, 1, 6) = SUBSTR(#{akChdt}, 1, 6)
           AND CNFMDT IS NULL
    </delete>

    <select id="countTbSvpdHcfAsAkIz" resultType="java.lang.Integer">
        SELECT COUNT(*) AS COUNT
          FROM TB_SVPD_HCF_AS_AK_IZ SVPD1 /* 홈카페AS요청내역 */
         WHERE DTA_DL_YN = 'N'
           AND SVPD1.CNTR_NO = #{cntrNo}
           AND SVPD1.CNTR_SN = #{cntrSn}
           AND AK_SN = #{akSn}
    </select>

    <update id="updateTbSvpdHcfAsAkIz">
        UPDATE TB_SVPD_HCF_AS_AK_IZ /* 홈카페AS요청내역 */
           SET AK_CHDT = #{akChdt}
             , BFCH_PD_CD = #{bfchPdCd}
             , AFCH_PD_CD = #{afchPdCd}
             , CHO_CAPSL_CN = #{choCapslCn}
             , MTR_PROCS_STAT_CD = #{mtrProcsStatCd}
             <include refid="COMMON.updateSystemField" />
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND AK_SN = #{akSn}
           AND AS_AK_DV_CD = #{asAkDvCd}
           AND SUBSTR(AK_CHDT, 1, 6) = SUBSTR(#{akChdt}, 1, 6)
           AND CNFMDT IS NULL
    </update>

    <select id="selectAkSnMax" resultType="java.lang.String">
        SELECT NVL(MAX(AK_SN), 0) + 1 AS MAX_AK_SN
          FROM TB_SVPD_HCF_AS_AK_IZ /* 홈카페AS요청내역 */
         WHERE DTA_DL_YN = 'N'
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
    </select>

    <insert id="insertTbSvpdHcfAsAkIz">
        INSERT INTO TB_SVPD_HCF_AS_AK_IZ ( /* 홈카페AS요청내역 */
               CNTR_NO
             , CNTR_SN
             , AK_SN
             , AS_AK_DV_CD
             , RGST_DT
             , AK_CHDT
             , PD_TP_CD
             , BFCH_PD_CD
             , AFCH_PD_CD
             , CHO_CAPSL_CN
             , MTR_PROCS_STAT_CD
             <include refid="COMMON.insertSystemField" />
        ) VALUES (
               #{cntrNo}
             , #{cntrSn}
             , (SELECT NVL(MAX(AK_SN), 0) + 1 AS MAX_AK_SN
                  FROM TB_SVPD_HCF_AS_AK_IZ
                 WHERE DTA_DL_YN = 'N'
                   AND CNTR_NO = #{cntrNo}
                   AND CNTR_SN = #{cntrSn})
             , #{asAkDvCd}
             , TO_CHAR(SYSDATE, 'YYYYMMDD')
             , #{akChdt}
             , 'P'
             , #{bfchPdCd}
             , #{afchPdCd}
             , #{choCapslCn}
             , #{mtrProcsStatCd}
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
             , NVL(#{rcpIchrPrtnrNo}, #{session.userId})
             , #{session.pageId}
             , NVL((SELECT OG_ID /* 조직ID */
                      FROM TB_OGBS_MM_PRTNR_IZ /* 월파트너내역 */
                     WHERE BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                       AND PRTNR_NO = #{rcpIchrPrtnrNo}
                       AND OG_TP_CD = #{rcpOgTpCd}), NVL(#{session.ogId}, 'NULL'))
             , TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
             , #{session.userId}
             , #{session.pageId}
             , NVL(#{session.ogId}, 'NULL')
        )
    </insert>

    <update id="updateStopNextSiding">
        UPDATE TB_SVPD_CST_SV_RGBSPR_IZ /* 고객서비스정기BS주기내역 */
           SET MTR_CAN_DT = (CASE WHEN #{mtrProcsStatCd} = '3' THEN '' ELSE #{akChdt} END) /* 취소요청일자 */
             , MTR_CAN_RSON_CD = (CASE WHEN #{mtrProcsStatCd} = '3' THEN '' ELSE '10' END) /* 고객요청 */
             <include refid="COMMON.updateSystemField"/>
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND SUBSTR (VST_DUEDT, 1, 6) = SUBSTR (#{akChdt}, 1, 6)
    </update>

    <select id="selectPdctPdCds" resultType="java.lang.String">
        SELECT PDCT_PD_CD /* WM05100886,3|WM05100888,3 */
          FROM TB_SVPD_CST_SV_EXCN_IZ /* 고객서비스수행배정내역 */
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
           AND DTA_DL_YN = 'N'
    </select>

</mapper>
