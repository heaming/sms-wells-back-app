<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.interfaces.mapper.WsniSeedingShippingMapper">

    <select id="selectSeedingShippings" resultType="com.kyowon.sms.wells.web.service.interfaces.dto.WsniSeedingShippingDto$SearchRes">
        SELECT #{cntrNo}                         AS CNTR_NO   /* 계약번호 */
             , #{cntrSn}                         AS CNTR_SN   /* 계약일련번호 */
             , T.DT_INFO                         AS PERF_CT   /* 실적건수 */
             , T.SELL_AMT                        AS SEL_AMT   /* 판매금액 */
             , T.VST_DT                                       /* 방문일자 */
             , TO_CHAR(SYSDATE + 40, 'YYYYMMDD') AS PLS_40    /* 플러스40일 */
             , ( SELECT MIN(VST_DUEDT)
                   FROM TB_SVPD_CST_SV_RGBSPR_IZ
                  WHERE DTA_DL_YN = 'N'
                    AND WK_DT IS NULL
                    AND VST_DUEDT <![CDATA[>]]> TO_CHAR(SYSDATE + 40, 'YYYYMMDD')
                    AND CNTR_NO   = #{cntrNo}
                    AND CNTR_SN   = #{cntrSn} )  AS CHNG_DT   /* 교체일자 */
             , T.SPP_PRGS_STAT_CD                             /* 배송진행상태코드 */
             , T.SPP_ADR                                      /* 설치주소 */
             , ( SELECT PD_NM
                   FROM TB_PDBS_PD_BAS
                  WHERE PD_CD = T.PKG_CD )       AS ITM_KNM   /* 품목한글명 */
          FROM
             (
               SELECT LISTAGG(D2.PD_NM || '(' || D1.USE_QTY || ')', ', ') WITHIN GROUP (ORDER BY D1.WK_OSTR_SN) AS DT_INFO
                    , D1.FNL_VST_FSH_DT                                                                         AS VST_DT
                    , D4.BASE_PD_CD                                                                             AS PKG_CD
                    , '70'                                                                                      AS SPP_PRGS_STAT_CD   /* 배송완료 */
                    , D7.RNADR || ' ' || D7.RDADR                                                               AS SPP_ADR
                    , D4.SELL_AMT
                 FROM TB_SVST_SV_WK_OSTR_IZ D1               /* 서비스작업출고내역 */
                INNER JOIN TB_PDBS_PD_BAS D2                 /* 상품기본 */
                   ON D2.PD_CD = D1.ITM_PD_CD
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D3        /* 상품각사속성상세 */
                   ON D3.PD_CD = D2.PD_CD
                INNER JOIN TB_SSCT_CNTR_DTL D4               /* 계약상세 */
                   ON D4.CNTR_NO = D1.CNTR_NO
                  AND D4.CNTR_SN = D1.CNTR_SN
                 LEFT OUTER JOIN TB_SSCT_CNTR_ADR_REL D5     /* 계약주소관계 */
                   ON D5.DTL_CNTR_NO = D1.CNTR_NO
                  AND D5.DTL_CNTR_SN = D1.CNTR_SN
                  AND D5.DTA_DL_YN   = 'N'
                  AND D5.ADRPC_TP_CD IN ('2', '3')
                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN D5.VL_STRT_DTM AND D5.VL_END_DTM
                 LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS D6   /* 계약주소지기본 */
                   ON D6.CNTR_ADRPC_ID = D5.CNTR_ADRPC_ID
                  AND D6.DTA_DL_YN     = 'N'
                 LEFT OUTER JOIN TB_GBCO_ADR_BAS D7          /* 주소기본 */
                   ON D7.ADR_ID    = D6.ADR_ID
                  AND D7.DTA_DL_YN = 'N'
                WHERE D1.DTA_DL_YN          = 'N'
                  AND D2.DTA_DL_YN          = 'N'
                  AND D2.PD_TP_CD           = 'M'
                  AND D2.PD_NM NOT LIKE '%POT%'
                  AND D3.DTA_DL_YN          = 'N'
                  AND D3.PD_EXTS_PRP_GRP_CD = 'PART'
                  AND NOT(D3.PD_PRP_VAL20 = '11' AND D3.PD_PRP_VAL19 = '6')   /* 배양액 제외 */
                  AND D4.DTA_DL_YN          = 'N'
                  AND D1.CNTR_NO            = #{cntrNo}
                  AND D1.CNTR_SN            = #{cntrSn}
                GROUP BY D1.FNL_VST_FSH_DT, D4.BASE_PD_CD, D7.RNADR, D7.RDADR, D4.SELL_AMT
                UNION ALL
               SELECT LISTAGG(D2.PD_NM || '(' || D1.PART_USE_QTY || ')', ', ') WITHIN GROUP (ORDER BY D1.FILT_CHNG_LV_CD) AS DT_INFO
                    , D1.VST_DUEDT                                                                                        AS VST_DT
                    , NVL(D5.AFCH_PD_CD, D4.BASE_PD_CD)                                                                   AS PKG_CD
                    , CASE WHEN D7.SPP_CNFMDT IS NOT NULL                               THEN '60'
                           WHEN D1.VST_DUEDT <![CDATA[>]]> TO_CHAR(SYSDATE, 'YYYYMMDD') THEN '50'
                      END                                                                                                 AS SPP_PRGS_STAT_CD
                    , D10.RNADR || ' ' || D10.RDADR                                                                       AS SPP_ADR
                    , D4.SELL_AMT
                 FROM TB_SVPD_CST_SV_RGBSPR_IZ D1               /* 고객서비스정기BS주기내역 */
                INNER JOIN TB_PDBS_PD_BAS D2                    /* 상품기본 */
                   ON D2.PD_CD = D1.PART_PD_CD
                INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL D3           /* 상품각사속성상세 */
                   ON D3.PD_CD = D2.PD_CD
                INNER JOIN TB_SSCT_CNTR_DTL D4                  /* 계약상세 */
                   ON D4.CNTR_NO = D1.CNTR_NO
                  AND D4.CNTR_SN = D1.CNTR_SN
                 LEFT OUTER JOIN TB_SVPD_SDING_AS_AK_IZ D5      /* 모종AS요청내역 */
                   ON D5.CNTR_NO     = D1.CNTR_NO
                  AND D5.CNTR_SN     = D1.CNTR_SN
                  AND D5.AK_CHDT     = D1.VST_DUEDT
                  AND D5.DTA_DL_YN   = 'N'
                  AND D5.AS_AK_DV_CD = '1'   /* 패키지변경 */
                  AND D5.CNFMDT IS NULL
                 LEFT OUTER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ D6  /* 고객서비스BS대상내역 */
                   ON D6.CNTR_NO         = D1.CNTR_NO
                  AND D6.CNTR_SN         = D1.CNTR_SN
                  AND D6.SV_BIZ_MCLSF_CD = D1.SV_BIZ_MCLSF_CD
                  AND D6.SV_BIZ_DCLSF_CD = D1.SV_BIZ_DCLSF_CD
                  AND D6.WK_SN           = D1.WK_SN
                  AND D6.DTA_DL_YN       = 'N'
                  AND D6.VST_DUEDT BETWEEN TO_CHAR(SYSDATE, 'YYYYMMDD') AND TO_CHAR(ADD_MONTHS(SYSDATE, 3),'YYYYMMDD')
                 LEFT OUTER JOIN TB_SVPD_SDING_SPP_CNFM_IZ D7   /* 모종배송확정내역 */
                   ON D7.CNTR_NO         = D6.CNTR_NO
                  AND D7.CNTR_SN         = D6.CNTR_SN
                  AND D7.SV_BIZ_DCLSF_CD = D6.SV_BIZ_DCLSF_CD
                  AND D7.SDING_SPP_NO    = D6.CST_SV_ASN_NO
                  AND D7.DTA_DL_YN       = 'N'
                  AND D7.SV_BIZ_HCLSF_CD = '2'
                 LEFT OUTER JOIN TB_SSCT_CNTR_ADR_REL D8        /* 계약주소관계 */
                   ON D8.DTL_CNTR_NO = D1.CNTR_NO
                  AND D8.DTL_CNTR_SN = D1.CNTR_SN
                  AND D8.DTA_DL_YN   = 'N'
                  AND D8.ADRPC_TP_CD IN ('2', '3')
                  AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN D8.VL_STRT_DTM AND D8.VL_END_DTM
                 LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS D9      /* 계약주소지기본 */
                   ON D9.CNTR_ADRPC_ID = D8.CNTR_ADRPC_ID
                  AND D9.DTA_DL_YN     = 'N'
                 LEFT OUTER JOIN TB_GBCO_ADR_BAS D10            /* 주소기본 */
                   ON D10.ADR_ID    = D9.ADR_ID
                  AND D10.DTA_DL_YN = 'N'
                WHERE D1.DTA_DL_YN          = 'N'
                  AND D1.WK_DT IS NULL
                  AND D2.DTA_DL_YN          = 'N'
                  AND D2.PD_TP_CD           = 'M'
                  AND D2.PD_NM NOT LIKE '%POT%'
                  AND D3.DTA_DL_YN          = 'N'
                  AND D3.PD_EXTS_PRP_GRP_CD = 'PART'
                  AND NOT(D3.PD_PRP_VAL20 = '11' AND D3.PD_PRP_VAL19 = '6')   /* 배양액 제외 */
                  AND D4.DTA_DL_YN          = 'N'
                  AND D1.VST_DUEDT BETWEEN TO_CHAR(SYSDATE, 'YYYYMMDD') AND TO_CHAR(ADD_MONTHS(SYSDATE, 3),'YYYYMMDD')
                  AND D1.CNTR_NO            = #{cntrNo}
                  AND D1.CNTR_SN            = #{cntrSn}
                GROUP BY D1.VST_DUEDT, NVL(D5.AFCH_PD_CD, D4.BASE_PD_CD), D7.SPP_CNFMDT, D10.RNADR, D10.RDADR, D4.SELL_AMT
             ) T
         ORDER BY T.VST_DT DESC
    </select>

</mapper>
