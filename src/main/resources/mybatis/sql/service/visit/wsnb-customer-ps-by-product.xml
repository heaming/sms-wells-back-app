<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.visit.mapper.WsnbCustomerPsByProductMapper">
    <select id="selectSvVstPrdCd" resultType="com.kyowon.sms.wells.web.service.visit.dto.WsnbCustomerPsByProductDto$SvVstPrdCd">
        SELECT DISTINCT  '방문 ' || NVL(F_CMZ_CD_NM('TNT_WELL', 'SV_VST_PRD_CD', V1.PD_PRP_VAL02), '주기없음') AS CODE_NAME
                      , (CASE WHEN NVL(F_CMZ_CD_NM('TNT_WELL', 'SV_VST_PRD_CD', V1.PD_PRP_VAL02), '주기없음') = '주기없음' THEN 0 ELSE TO_NUMBER(PD_PRP_VAL02) END) AS CODE
        FROM (SELECT DISTINCT P1.PD_PRP_VAL02 AS PD_PRP_VAL02
              FROM TB_PDBS_PD_ECOM_PRP_DTL P1
              WHERE 1=1
                AND P1.PD_EXTS_PRP_GRP_CD = 'SCHD'
                AND P1.DTA_DL_YN = 'N'
             ) V1
        ORDER BY CODE
    </select>

    <select id="selectCustomerPsByProduct" resultType="com.kyowon.sms.wells.web.service.visit.dto.WsnbCustomerPsByProductDto$SearchRes">
        WITH PD_INF AS ( SELECT T1.PD_CD
                              , T1.PD_ABBR_NM AS PD_NM
                              , T2.PD_PRP_VAL19 AS ITM_KND_CD
                              , T2.PD_PRP_VAL20 AS PD_GRP_CD
                              , T2.PD_PRP_VAL04	AS LP_USE_YN
                              /* , T2.PD_PRP_VAL17 AS MAT_MNGT_DV_CD */
                              , F_CMZ_CD_NM('TNT_WELLS', 'MAT_MNGT_DV_CD', T2.PD_PRP_VAL17, 'ko') AS MAT_MNGT_DV_CD
                              , T1.SAP_MAT_CD
                              , T2.PD_PRP_VAL30 AS TRNOVR_RT_OJ_YN
                              , T2.PD_PRP_VAL21 AS CMN_PART_DV_CD /* 중수리 01 */
                              , T2.PD_PRP_VAL15 AS ORDNY_HV_MAT_YN /* 기초자재 Y 상시보유 */
                           FROM WSMDBS.TB_PDBS_PD_BAS T1                    /*상품기본*/
                LEFT OUTER JOIN WSMDBS.TB_PDBS_PD_ECOM_PRP_DTL T2  /*상품각사속성상세*/
                             ON T1.PD_CD = T2.PD_CD
                            AND T2.PD_EXTS_PRP_GRP_CD IN ('PART')     /*상품확장속성그룹코드 CMN 공통, AFS AS, PRC 가격, STLM 결제, CNTR 계약, EXCH 교환/반품, ETC 기타, SL 매출, GO 발주, SPP 배송, ANA 분석, FEE 영업수수료, HIST 이력, SCHD 일정관리, COCN 전집, LRNN 학습/외국어, LV 학습단계, PART AS부품, FINC 재무, PDCT 판매제품*/
                          WHERE 1=1
                            AND T2.PD_PRP_VAL19 = '4'
                            AND T2.DTA_DL_YN = 'N'
                            <if test="@MybatisUtils@isNotEmpty(pdGrpCd)">
                            AND T2.PD_PRP_VAL20 = #{pdGrpCd}/* 상품그룹 */
                            </if>
                            <if test="@MybatisUtils@isNotEmpty(pdCd)">
                            AND T1.PD_CD = #{pdCd} /* 상품코드 */
                            </if>
        )
        SELECT S1.CNTR_NO
             , S1.CNTR_SN
             , C4.RCGVP_KNM         /*수령자한글명*/
             , TO_NUMBER(P1.SAP_MAT_CD) AS SAP_MAT_CD
             , P1.PD_CD
             , P1.PD_NM
             , C5.NEW_ADR_ZIP       /*신주소우편번호*/
             , S2.BRCH_OG_ID        /*조직ID*/
             , O1.OG_NM AS BRCH_OG_NM
             , O1.OG_CD             /*영업조직코드*/
             --, WSMDBS.FN_SVPD_LOCARA_PRTNR_01(C5.NEW_ADR_ZIP, P1.PD_CD, '1110', TO_CHAR(SYSDATE, 'YYYYMMDD'))  /*서비스조직코드 찾아오는 방법에 대해서 고민 필요, 사업부에게도 이슈 제기 필요, 일단 그전까지 보류, 속도가 안 나옴*/
             , C5.RNADR||' '||C5.RDADR AS ADDR             /*도로명주소*/
             , C4.ADR_DV_CD         /*주소구분코드 : 1 도로명, 2 지번*/
             , C4.ADR_ID            /*주소ID*/
             , C4.CRAL_LOCARA_TNO   /*휴대지역전화번호*/
             , C4.MEXNO_ENCR        /*휴대전화국번호암호화*/
             , C4.CRAL_IDV_TNO      /*휴대개별전화번호*/
             , C4.LOCARA_TNO        /*지역전화번호*/
             , C4.EXNO_ENCR         /*전화국번호암호화*/
             , C4.IDV_TNO           /*개별전화번호*/
             , C6.RSG_FSH_DT        /*해지완료일자*/
             , SUBSTR(C2.CNTR_CAN_DTM, 1,8) AS CNTR_CAN_DTM
             , S1.IST_DT            /*설치일자*/
             , S1.REQD_DT           /*철거일자*/
             , C1.SELL_TP_CD        /*판매유형, 현재 모두 이값을 쓰고 있는데 사업부에게 이게 정말 맞는지 상세가 맞는지 확인이 필요 */
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', C1.SELL_TP_CD, 'ko') AS SELL_TP_NM
             , C1.SELL_TP_DTL_CD        /*판매유형*/
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_DTL_CD', C1.SELL_TP_DTL_CD, 'ko') AS SELL_TP_DTL_NM
             ,  '택배 ' || F_CMZ_CD_NM('TNT_WELL', 'SV_VST_PRD_CD', P2.PD_PRP_VAL03) || '|' ||'방문 ' || NVL(F_CMZ_CD_NM('TNT_WELL', 'SV_VST_PRD_CD', P2.PD_PRP_VAL02), '주기없음') AS PRD_NM /*택배 주기| 방문 주기, 용도구분에 대해서는 협의가 필요 함. 개인별서비스 현황에서 표현해주는 방식 이진성프로에게 문의*/
             , S1.BC_NO             /*제품시리얼, 화면상에서도 변경 필요 조혜미 매니저*/
             , (CASE WHEN C1.CNTR_DTL_STAT_CD = '202' THEN (SELECT TO_CHAR(ADD_MONTHS(TO_DATE(CC1.HIST_STRT_DTM, 'YYYYMMDDHH24MISS'), 1), 'YYYYMM') || '01'    /*연체로 계약상태가 변경 된 익월부터 서비스는 중지됨. 이것도 이렇게 하는게 맞는지 의문이 들긴함.*/
                                                              FROM WSMDBS.TB_SSCT_CNTR_DTL_STAT_CH_HIST CC1
                                                             WHERE 1=1
                                                               AND CC1.CNTR_NO = C1.CNTR_NO
                                                               AND CC1.CNTR_SN = C1.CNTR_SN
                                                               AND CC1.CNTR_DTL_STAT_CD = C1.CNTR_DTL_STAT_CD
                                                               AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN CC1.HIST_STRT_DTM AND CC1.HIST_END_DTM
                                                               AND CC1.DTA_DL_YN = 'N')
                     ELSE ''
                END) AS SV_STP_DT   /*현재 계약상태가(CNTR_DTL_STAT_CD)  = 202 일 경우만 조회 */
             , C1.STPL_PTRM         /*의무사용일수*/
             , C8.FRISU_AS_PTRM_N       /*무상AS기간*/
             , C8.FRISU_BFSVC_PTRM_N    /*무상BS기간*/
             , NVL((SELECT NVL(TO_CHAR(DD1.DLQ_ACU_MCN), 'N')
                      FROM WSMDBS.TB_CBCL_DLQ_BAS DD1    /*연체기본*/
                     WHERE DD1.CNTR_NO = C1.CNTR_NO
                       AND DD1.CNTR_SN = C1.CNTR_SN
                       AND DD1.EOT_DLQ_ADD_AMT > 0
                       AND DD1.PERF_YM = TO_CHAR(SYSDATE,'YYYYMM')),'0') AS DLQ_ACU_MCN /* 연체여부 */
             , O2.OG_NM            /*최근처리 BS 담당자 소속명*/
             , O2.PRTNR_NO         /*최근처리 BS 담당자 사번*/
             , O2.PRTNR_KNM        /*최근처리 BS 담당자 성명*/
          FROM WSMDBS.TB_SVPD_CST_SV_EXCN_IZ S1             /*고객서비스수행내역, AC201TB*/
    INNER JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ S4
            ON MNGT_YM = TO_CHAR(SYSDATE, 'YYYYMM')
           AND S1.CNTR_NO = S4.CNTR_NO
           AND S1.CNTR_SN = S4.CNTR_SN
    INNER JOIN PD_INF P1                         /*상품*/
            ON P1.PD_CD = S1.PDCT_PD_CD
    INNER JOIN WSMDBS.TB_SSCT_CNTR_DTL C1        /*계약상세*/
            ON C1.CNTR_NO = S1.CNTR_NO
           AND C1.CNTR_SN = S1.CNTR_SN
           AND (C1.CNTR_DTL_STAT_CD LIKE '1%' OR C1.CNTR_DTL_STAT_CD LIKE '2%') --24.03.05 봉희정매니저님 협의, 서비스 되는 고객만
           AND C1.DTA_DL_YN = 'N'
    INNER JOIN WSMDBS.TB_SSCT_CNTR_BAS C2        /*계약기본*/
            ON C2.CNTR_NO = C1.CNTR_NO
           AND C2.DTA_DL_YN = 'N'
    INNER JOIN WSMDBS.TB_SSCT_CNTR_ADR_REL C3    /*계약주소관계*/
            ON C3.DTL_CNTR_NO = C1.CNTR_NO
           AND C3.DTL_CNTR_SN = C1.CNTR_SN
           AND C3.ADRPC_TP_CD IN ('2', '3')    /*1 계약주소, 2 배달주소,3 설치주소*/
           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN C3.VL_STRT_DTM AND C3.VL_END_DTM
           AND C3.DTA_DL_YN = 'N'
    INNER JOIN WSMDBS.TB_SSCT_CNTR_ADRPC_BAS C4  /*계약주소지기본*/
            ON C4.CNTR_ADRPC_ID = C3.CNTR_ADRPC_ID
           AND C4.DTA_DL_YN = 'N'
LEFT OUTER JOIN GBSDBS.TB_GBCO_ADR_BAS C5
                 ON C5.ADR_ID = C4.ADR_ID
                AND C5.DTA_DL_YN = 'N'
    LEFT OUTER JOIN WSMDBS.TB_SSCT_CNTR_RSG_PROCS_IZ C6  /*계약해지처리내역*/
                 ON C6.CNTR_NO = C1.CNTR_NO
                AND C6.CNTR_SN = C1.CNTR_SN
                AND C6.DTA_DL_YN = 'N'
    INNER JOIN WSMDBS.TB_SSCT_CNTR_WELLS_DTL C8  /*계약WELLS상세*/
            ON C8.CNTR_NO = C1.CNTR_NO
           AND C8.CNTR_SN = C1.CNTR_SN
           AND C8.DTA_DL_YN = 'N'
    INNER JOIN WSMDBS.TB_SVPD_LOCARA_BFSVC_OGMGR_IZ S2  /*지역별BS조직매니저내역, AC110TB*/
            ON S2.NEW_ADR_ZIP = C5.NEW_ADR_ZIP
    INNER JOIN WSMDBS.TB_OGBS_OG_BAS O1
            ON O1.OG_ID = S2.BRCH_OG_ID
           AND O1.DTA_DL_YN = 'N'
LEFT OUTER JOIN LATERAL (SELECT S3.OG_TP_CD
                                  , S3.PRTNR_NO
                                  , S3.VST_FSH_DT
                               FROM WSMDBS.TB_SVPD_CST_SV_WK_RS_IZ S3    /*고객서비스작업결과내역, 마지막BS처리자를 조회하기위해*/
                              WHERE 1=1
                                AND S3.CNTR_NO = S1.CNTR_NO
                                AND S3.CNTR_SN = S1.CNTR_SN
                                AND S3.VST_FSH_DT = (SELECT MAX(SS3.VST_FSH_DT)
                                                       FROM WSMDBS.TB_SVPD_CST_SV_WK_RS_IZ SS3
                                                      WHERE 1=1
                                                        AND SS3.CNTR_NO = S1.CNTR_NO
                                                        AND SS3.CNTR_SN = S1.CNTR_SN
                                                        AND SS3.SV_BIZ_HCLSF_CD = '2'
                                                        AND SS3.DTA_DL_YN = 'N')
                                AND S3.SV_BIZ_HCLSF_CD = '2'
                                AND S3.DTA_DL_YN = 'N'
                            ) S3
           ON 1=1
INNER JOIN LATERAL (SELECT *
                          FROM WSMDBS.TB_OGBS_MM_PRTNR_IZ O2 /*월파트너내역, 마지막처리자, 없다면 현재 관리 담당자*/
                         WHERE 1=1
                           AND O2.BASE_YM = NVL(SUBSTR(S3.VST_FSH_DT,1,6), TO_CHAR(SYSDATE, 'YYYYMM'))
                           AND O2.OG_TP_CD = NVL(S3.OG_TP_CD, S1.MNGT_PRTNR_OG_TP_CD)
                           AND O2.PRTNR_NO = NVL(S3.PRTNR_NO, S1.MNGT_PRTNR_NO)
                       ) O2
           ON 1=1
LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL P2
           ON P2.PD_CD = S1.SV_PD_CD
          AND P2.PD_EXTS_PRP_GRP_CD = 'SCHD'
          AND P2.DTA_DL_YN = 'N'
        WHERE 1=1
        <if test="@MybatisUtils@isNotEmpty(instOver)">
        AND S4.IST_NMN_N = #{instOver} /* 설치차월 */
        </if>
        <if test="@MybatisUtils@isNotEmpty(sellTpCd)">
        AND C1.SELL_TP_CD = #{sellTpCd} /* 판매유형 */
        </if>
        <if test='@MybatisUtils@isNotEmpty(bfsvcPrdCd) and !@MybatisUtils@equals(bfsvcPrdCd,"0")'>
        AND P2.PD_PRP_VAL02 =  #{bfsvcPrdCd} /* 주기 */
        </if>
        <if test='@MybatisUtils@equals(bfsvcPrdCd,"0")'>
        AND (P2.PD_PRP_VAL02 = '0' OR P2.PD_PRP_VAL02 IS NULL)
        </if>
        <if test="@MybatisUtils@isNotEmpty(cancelOrReqd)">
        AND (C2.CNTR_CAN_DTM IS NOT NULL OR S1.REQD_DT IS NOT NULL OR C6.RSG_FSH_DT IS NOT NULL)
        </if>
    </select>
</mapper>
