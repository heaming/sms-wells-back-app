<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.visit.mapper.WsnbNewPdctMThreeAcuAfSvRtMapper">
    <select id="selectNewPdctMThreeAcuAfSvRts" resultType="com.kyowon.sms.wells.web.service.visit.dto.WsnbNewPdctMThreeAcuAfSvRtDto$SearchRes">
        SELECT '0' AS CHK
             , ST108.PD_CD       /* 상품코드 */
             , ST108.PD_CD AS CODE    /* 상품코드 */
             , ST108.PD_CD ||' '||T2.PD_NM AS CODE_NAME  /* 상품코드  + 상품명 */
             , T2.PD_NM AS NM_KOR   /* 상품명 */
             , ST108.ITM_KND_CD   /* 품목종류코드 */
             , ST108.PD_GRP_CD    /* 상품그룹코드 */
             , ST108.LNC_STRTDT   /* 출시시작일자 */
             , ST108.LNC_EXDT     /* 출시만기일자 */
          FROM TB_SVST_NWPRD_M3_LNC_IZ ST108
         INNER JOIN WSMDBS.TB_PDBS_PD_BAS T2          /*상품기본*/
            ON ST108.PD_CD = T2.PD_CD
         INNER JOIN WSMDBS.TB_PDBS_PD_ECOM_PRP_DTL T3 /*상품각사속성상세*/
            ON T2.PD_CD = T3.PD_CD
           AND T3.PD_EXTS_PRP_GRP_CD = 'PART'
         WHERE 1=1
           AND ST108.ITM_KND_CD = '4'
           AND ST108.USE_YN = 'Y'
           AND T3.PD_PRP_VAL32 = 'Y'
           AND ST108.PD_CD = T2.PD_CD
         ORDER BY ST108.PD_CD
    </select>

    <select id="selectPdResults" resultType="com.kyowon.sms.wells.web.service.visit.dto.WsnbNewPdctMThreeAcuAfSvRtDto$PdListRes">
        SELECT '0' AS CHK
             , T2.PD_CD
             , T2.PD_CD AS CODE
             , T2.PD_CD ||' '|| T2.PD_NM AS CODE_NAME
             , T2.PD_NM AS NM_KOR
             , T3.PD_PRP_VAL19 AS ITM_KND_CD /* 품목종류코드 */
             , T3.PD_PRP_VAL20 AS PD_GRP_CD  /* 상품그룹코드 */
             , T2.PD_HCLSF_ID
             , T2.PD_TP_CD
             , ST108.LNC_STRTDT   /* 출시시작일자 */
             , ST108.LNC_EXDT     /* 출시만기일자 */
           FROM WSMDBS.TB_PDBS_PD_BAS T2          /*상품기본*/
     INNER JOIN WSMDBS.TB_PDBS_PD_ECOM_PRP_DTL T3 /*상품각사속성상세*/
             ON T2.PD_CD = T3.PD_CD
            AND T3.PD_EXTS_PRP_GRP_CD = 'PART'
     INNER JOIN TB_SVST_NWPRD_M3_LNC_IZ ST108 /*상품각사속성상세*/
             ON T2.PD_CD = ST108.PD_CD
          WHERE 1=1
            AND T3.PD_PRP_VAL19 = '4'
            AND T3.PD_PRP_VAL32 = 'Y'
          ORDER BY T2.PD_CD
    </select>

    <update id="deleteNewPdctMThreeAcuAfSvRtInfo">
        DELETE
          FROM TB_SVST_NWPRD_M3_LNC_IZ /* 신상품M3 출시내역 */
         WHERE PD_CD = #{pdCd}  /* 상품코드 */
    </update>

    <insert id="insertNewPdctMThreeAcuAfSvRtInfo">
        INSERT
          INTO TB_SVST_NWPRD_M3_LNC_IZ
             (
               PD_CD        /* 상품코드 */
             , ITM_KND_CD   /* 품목종류코드 */
             , PD_GRP_CD    /* 상품그룹코드 */
             , LNC_STRTDT   /* 출시시작일자 */
             , LNC_EXDT     /* 출시만기일자 */
             , USE_YN       /* 사용여부  */
             , DTA_DL_YN    /* 데이터 삭제여부 */
             <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             (
               #{pdCd}
             , '4'
             , #{pdGrpCd}
             , #{lncStrtdt}
             , #{lncExdt}
             , 'Y'       /* 사용여부  */
             , 'N'    /* 데이터 삭제여부 */
             <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <update id="updateNewPdctMThreeAcuAfSvRtInfo">
        UPDATE TB_SVST_NWPRD_M3_LNC_IZ
           SET LNC_STRTDT = #{lncStrtdt} /*출시시작일자 */
             , LNC_EXDT = #{lncExdt}     /*출시만기일자 */
         <include refid="COMMON.updateSystemField"/>
         WHERE PD_CD = #{pdCd}
    </update>

    <select id="selectPdDtls" resultType="com.kyowon.sms.wells.web.service.visit.dto.WsnbNewPdctMThreeAcuAfSvRtDto$PdDtlListRes">
        SELECT T1.PD_CD                             AS CD
             , TRIM(T1.PD_ABBR_NM)                  AS CD_NM
             , T2.PD_PRP_VAL20                      AS SVPD_ITEM_GR
             , T1.PD_HCLSF_ID                       AS PD_HCLSF_ID   /* 상품대분류 */
          FROM TB_PDBS_PD_BAS T1
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL T2
            ON T1.PD_CD = T2.PD_CD
           AND T2.PD_EXTS_PRP_GRP_CD = 'PART'
           AND T2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN T_CMD_ATTH_FILE_D T3
            ON T1.IMG_APN_FILE_ID = T3.ATTH_DOC_ID
           AND T3.TENANT_ID = 'TNT_WELLS'
           AND T3.DEL_YN = 'N'
         WHERE T1.PD_TP_CD = 'M'
           AND T1.DTA_DL_YN = 'N'
           AND T2.PD_PRP_VAL20 IS NOT NULL
         ORDER BY T1.PD_CD ASC
    </select>
</mapper>

