<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.visit.mapper.WsnbInstallLocationMgtMapper">

    <select id="selectInstallLocationPages" resultType="com.kyowon.sms.wells.web.service.visit.dvo.WsnbInstallLocationDvo">
        SELECT I1.CNTR_NO
             , I1.CNTR_SN
             , I1.IST_DT
             , B1.RCGVP_KNM AS CUST_NM
        	 , F_CMZ_CD_NM(#{session.tenantId}, 'PRD_MNGT_TP_CD', D2.SELL_TP_CD, #{session.langId}) AS SELL_TP_NM
             , D2.BASE_PD_CD
             , (SELECT SAP_MAT_CD
                  FROM TB_PDBS_PD_BAS
                 WHERE 1=1
                   AND DTA_DL_YN = 'N'
                   AND PD_CD = D2.BASE_PD_CD
               ) AS SAP_MAP_CD
             , (SELECT PD_ABBR_NM
                  FROM TB_PDBS_PD_BAS
                 WHERE 1=1
                   AND DTA_DL_YN = 'N'
                   AND PD_CD = D2.BASE_PD_CD
               ) AS PD_NM
             , B1.LOCARA_TNO /* 지역전화번호 */
             , B1.EXNO_ENCR /* 전화국번호암호화 (복호화필요) */
             , B1.IDV_TNO  /* 개별전화번호 */
             , B1.CRAL_LOCARA_TNO /* 휴대지역전화번호 */
             , B1.MEXNO_ENCR  /* 휴대전화국번호암호화 */
             , B1.CRAL_IDV_TNO  /* 휴대개별전화번호 */
             , B2.NEW_ADR_ZIP AS ZIP
             , B2.RNADR || ' ' || B2.RDADR AS ADR
             , D4.IST_LCT_DTL_CN
             , P1.OG_NM
             , D4.WK_PRTNR_NO /* 작업파트너번호 */
             , P1.PRTNR_KNM
             , TO_CHAR(TO_DATE(D4.FST_RGST_DTM, 'YYYYMMDDHH24MISS'),'YYYY-MM-DD HH24:MI:SS') AS REG_DTM
          FROM TB_SVPD_CST_SV_EXCN_IZ I1
         INNER JOIN (SELECT D1.CNTR_NO AS CNTR_NO
                                , D1.CNTR_SN AS CNTR_SN
                                , D1.SELL_TP_CD AS SELL_TP_CD
                                , D1.BASE_PD_CD AS BASE_PD_CD
                            FROM TB_SSCT_CNTR_DTL D1
                           WHERE D1.CNTR_SN = (SELECT MAX(CNTR_SN)
                                               FROM TB_SSCT_CNTR_DTL
                                              WHERE D1.CNTR_NO = CNTR_NO
                                                AND DTA_DL_YN = 'N'
                                            )
                              AND D1.DTA_DL_YN = 'N'
                           ) D2
            ON I1.CNTR_NO = D2.CNTR_NO
           AND I1.CNTR_SN = D2.CNTR_SN
          LEFT OUTER JOIN TB_PDBS_PD_ECOM_PRP_DTL PD1
            ON D2.BASE_PD_CD = PD1.PD_CD
           AND PD1.PD_EXTS_PRP_GRP_CD = 'PART'
           AND PD1.DTA_DL_YN = 'N'
           AND PD1.PD_PRP_VAL19 = '4'
         INNER JOIN TB_SSCT_CNTR_ADRPC_BAS B1 /* 계약주소지 기본 */
            ON I1.CNTR_NO = B1.CNTR_NO
           AND B1.DTA_DL_YN = 'N'
         INNER JOIN TB_GBCO_ADR_BAS B2
            ON B1.ADR_ID = B2.ADR_ID
           AND B2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN (SELECT D3.CNTR_NO AS CNTR_NO
                                , D3.CNTR_SN AS CNTR_SN
                                , D3.IST_LCT_DTL_CN AS IST_LCT_DTL_CN
                                , D3.WK_PRTNR_NO AS WK_PRTNR_NO
                                , D3.FST_RGST_DTM
                             FROM TB_SVPD_CNTR_PDCT_IST_LCT_DTL D3
                            WHERE D3.DTL_SN = (SELECT MAX(DTL_SN)
                                                  FROM TB_SVPD_CNTR_PDCT_IST_LCT_DTL
                                                 WHERE D3.CNTR_NO = CNTR_NO
                                                   AND DTA_DL_YN = 'N'
                                            )
                          ) D4
            ON I1.CNTR_NO = D4.CNTR_NO
         INNER JOIN TB_OGBS_MM_PRTNR_IZ P1
            ON P1.DTA_DL_YN = 'N'
           AND P1.BASE_YM   = TO_CHAR(SYSDATE, 'YYYYMM')
           AND P1.OG_TP_CD  = I1.MNGT_PRTNR_OG_TP_CD
           AND P1.PRTNR_NO  = I1.MNGT_PRTNR_NO
         WHERE I1.IST_DT IS NOT NULL
           AND I1.DTA_DL_YN = 'N'
         <if test="@MybatisUtils@isNotEmpty(ogId)">
           AND P1.OG_ID = #{ogId}
         </if>
         <if test="@MybatisUtils@isNotEmpty(egerId)">
           AND P1.PRTNR_NO = #{egerId}
         </if>
         <if test="@MybatisUtils@isNotEmpty(istDtFrom)">
           AND I1.IST_DT <![CDATA[>=]]> #{istDtFrom}
         </if>
         <if test="@MybatisUtils@isNotEmpty(istDtTo)">
           AND I1.IST_DT <![CDATA[<=]]> #{istDtTo}
         </if>
         <if test="@MybatisUtils@isNotEmpty(pdGrpCd)">
           AND PD1.PD_PRP_VAL20 = #{pdGrpCd}
         </if>
         <if test="@MybatisUtils@isNotEmpty(pdCd)">
           AND D2.BASE_PD_CD = #{pdCd}
         </if>
         <if test="@MybatisUtils@isNotEmpty(cstNm)">
           AND B1.RCGVP_KNM = #{cstNm}
         </if>
         <if test="@MybatisUtils@isNotEmpty(cntrNo)">
           AND I1.CNTR_NO LIKE '%'||#{cntrNo}||'%'
         </if>
    </select>

    <insert id="insertInstallLocation">
        INSERT INTO TB_SVPD_CNTR_PDCT_IST_LCT_DTL
             ( CNTR_NO
             , CNTR_SN
             , DTL_SN
             , IST_LCT_DTL_CN
             , WK_PRTNR_NO
             , DTA_DL_YN
              <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             ( #{cntrNo}
             , #{cntrSn}
             , (SELECT LPAD(NVL(MAX(DTL_SN),0)+1,3,'0')
                 FROM (SELECT MAX(DTL_SN) AS DTL_SN
                         FROM TB_SVPD_CNTR_PDCT_IST_LCT_DTL
                        WHERE CNTR_NO = #{cntrNo}
                          AND CNTR_SN = #{cntrSn}
                        GROUP BY CNTR_NO
                               , CNTR_SN)
               )
             , #{istLctDtlCn}
             , #{wkPrtnrNo}
             , 'N'
              <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>
    <select id="selectSerialNumberByPk" resultType="String">
        SELECT LPAD(NVL(MAX(DTL_SN),0),3,'0')
          FROM (SELECT MAX(DTL_SN) AS DTL_SN
                  FROM TB_SVPD_CNTR_PDCT_IST_LCT_DTL
                 WHERE CNTR_NO = #{cntrNo}
                   AND CNTR_SN = '00'
                 GROUP BY CNTR_NO, CNTR_SN
               )
    </select>

    <select id="selectInstallLocationContentLength" resultType="int">
        SELECT NVL(LENGTH(TRIM(IST_LCT_DTL_CN)),0)
          FROM TB_SVPD_CNTR_PDCT_IST_LCT_DTL
         WHERE CNTR_NO = #{cntrNo}
           AND CNTR_SN = '00'
           AND DTL_SN  = #{dtlSn}
    </select>

    <insert id="insertInitializeInstallLocation">
        INSERT INTO TB_SVPD_CNTR_PDCT_IST_LCT_DTL
             ( CNTR_NO
             , CNTR_SN
             , DTL_SN
             , IST_LCT_DTL_CN
             , WK_PRTNR_NO
             , DTA_DL_YN
              <include refid="COMMON.insertSystemField"/>
             )
        VALUES
             ( #{cntrNo}
             , '00'
             , #{dtlSn}
             , ''
             , #{wkPrtnrNo}
             , 'N'
              <include refid="COMMON.insertSystemFieldValue"/>
             )
    </insert>

    <select id="selectProducts" resultType="com.kyowon.sms.wells.web.service.visit.dto.WsnbInstallLocationMgtDto$Product">
        SELECT T1.PD_CD AS CODE_ID
             , T1.PD_ABBR_NM  || '(' || T1.PD_CD || ')' AS CODE_NAME
             , T1.PD_NM  AS ABBR_NAME
             , T2.PD_PRP_VAL20 AS PD_GRP_CD
          FROM TB_PDBS_PD_BAS T1
         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL T2
            ON T1.PD_CD = T2.PD_CD
           AND T2.PD_EXTS_PRP_GRP_CD = 'PART'
           AND T2.DTA_DL_YN = 'N'
           AND T2.PD_PRP_VAL19 = '4'
    </select>
</mapper>
