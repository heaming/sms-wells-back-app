<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.visit.mapper.WsnbIndividualServicePsMapper">

    <select id="selectIndividualServicePs" resultType="com.kyowon.sms.wells.web.service.visit.dto.WsnbIndividualServicePsDto$SearchRes">
        SELECT SV1.CNTR_NO || '-' || SV1.CNTR_SN                      AS CNTR_NO_DTL /*계약상세번호*/
             , SA2.RCGVP_KNM || (CASE WHEN (SC3.INSI_CST_TP_CD IS NOT NULL
                                          AND SC3.CNTRT_REL_CD = '01'
                                          AND (SP.CLTN_DT IS NULL OR SP.CLTN_DT <![CDATA[<=]]> NVL(SP.RCNTR_DT, '00000000')))
                                      OR SC2.SELL_DSC_DV_CD = '2' THEN '(직원구매)'
                                    ELSE '' END )                      AS CST_NM /*고객성명*/
             , (SELECT F_CMZ_CD_NM('TNT_WELLS', 'CST_GD_CD', NVL(X.CST_GD_CD,0))
                  FROM TB_CUBS_CST_DTL X
                 WHERE X.CST_NO = CST.CST_NO)                          AS CST_GD_NM /*고객등급*/
             , (SELECT T1.PRTNR_KNM||'('||T1.PRTNR_NO||')'
                  FROM TB_OGBS_MM_PRTNR_IZ T1
                 INNER JOIN TB_SVPD_CNTR_FXN_PRTNR_IZ T2
                    ON T2.CNTR_NO = SC2.CNTR_NO
                   AND T2.CNTR_SN = SC2.CNTR_SN
                   AND T2.CH_SN = (SELECT MAX(T3.CH_SN) FROM TB_SVPD_CNTR_FXN_PRTNR_IZ T3 WHERE T3.CNTR_NO = SC2.CNTR_NO AND T3.CNTR_SN = SC2.CNTR_SN)
                 WHERE T1.BASE_YM = SUBSTR(T2.FST_RGST_DTM,1,6)
                   AND T1.OG_TP_CD = T2.FXN_PRTNR_OG_TP_CD
                   AND T1.PRTNR_NO = T2.FXN_PRTNR_NO
                   AND T1.DTA_DL_YN = 'N') AS FXN_PRTNR_NM /*고정방문자명*/
             , NVL2(SA2.LOCARA_TNO, SA2.LOCARA_TNO, '') AS LOCARA_TNO /*전화번호(지역전화번호)*/
             , NVL2(SA2.LOCARA_TNO, SA2.EXNO_ENCR, '')         AS EXNO_ENCR /*전화번호(전화국번호암호화)*/
             , NVL2(SA2.LOCARA_TNO, SA2.IDV_TNO, '')           AS IDV_TNO /*전화번호(개별전화번호)*/
             , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_LOCARA_TNO, '')   AS CRAL_LOCARA_TNO /*휴대전화번호(휴대지역전화번호)*/
             , NVL2(SA2.CRAL_LOCARA_TNO, SA2.MEXNO_ENCR, '')   AS MEXNO_ENCR /*휴대전화번호(휴대전화국번호암호화)*/
             , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_IDV_TNO, '') AS CRAL_IDV_TNO /*휴대전화번호(휴대개별전화번호)*/
             , '('|| NVL(ADR.NEW_ADR_ZIP, ADR.OLD_ADR_ZIP)
                  ||')' || NVL(ADR.RNADR, ADR.LTN_ADR)
                  || ' ' || NVL(ADR.RDADR, ADR.LTN_DTL_ADR)AS ADDR  /*주소*/
             , SV3.CST_UNUITM_CN /*고객특이사항내용*/
             , (SELECT X.PRTNR_KNM||'('||X.PRTNR_NO||')'
                  FROM TB_OGBS_MM_PRTNR_IZ X
                 WHERE X.BASE_YM = SUBSTR(SV3.FST_RGST_DTM,1,6)
                   AND X.OG_TP_CD = SV3.OG_TP_CD
                   AND X.PRTNR_NO = SV3.WK_PRTNR_NO
                   AND X.DTA_DL_YN = 'N') AS WK_PRTNR_NM /*작성자명*/
             , (SELECT X.PRTNR_NO
                  FROM TB_OGBS_MM_PRTNR_IZ X
                 WHERE X.BASE_YM = SUBSTR(SV3.FST_RGST_DTM,1,6)
                   AND X.OG_TP_CD = SV3.OG_TP_CD
                   AND X.PRTNR_NO = SV3.WK_PRTNR_NO
                   AND X.DTA_DL_YN = 'N') AS WK_PRTNR_NO /*작성자*/
             , (SELECT X.OG_TP_CD
                  FROM TB_OGBS_MM_PRTNR_IZ X
                 WHERE X.BASE_YM = SUBSTR(SV3.FST_RGST_DTM,1,6)
                   AND X.OG_TP_CD = SV3.OG_TP_CD
                   AND X.PRTNR_NO = SV3.WK_PRTNR_NO
                   AND X.DTA_DL_YN = 'N') AS WK_OG_TP_CD /*작성자소속*/
             , SV3.FST_RGST_DTM AS WRTE_DT /*작성일시*/
             , (SELECT T1.PD_NM
                 FROM TB_PDBS_PD_BAS T1
                 WHERE T1.PD_CD = SC6.BASE_PD_CD ) AS BASE_PD_NM /*계약상품*/
             , (SELECT X.PD_NM FROM TB_PDBS_PD_BAS X WHERE X.PD_CD = SV1.PDCT_PD_CD) AS PD_NM  /*현재상품*/
             , NVL(SC4.FRISU_AS_PTRM_N, 0) AS  FRISU_AS_PTRM_N/*무상AS개월수*/
             , NVL(SC4.FRISU_BFSVC_PTRM_N, 0) AS  FRISU_BFSVC_PTRM_N/*무상BS개월수*/
             , F_CMZ_CD_NM('TNT_WELLS', 'PD_USWY_CD', NVL(SV2.PD_USWY_CD,0)) AS PD_USWY  /*용도구분*/
             , F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', NVL(SC2.SELL_TP_CD,0)) AS SELL_TP_NM  /*판매유형*/
             , (SELECT F_CMZ_CD_NM('TNT_WELLS', 'SELL_TP_CD', NVL(T1.SELL_TP_CD,0))
                  FROM TB_SSCT_CNTR_DTL T1
                 INNER JOIN TB_SSCT_CNTR_REL T2
                    ON T2.BASE_DTL_CNTR_NO = T1.CNTR_NO
                   AND T2.BASE_DTL_CNTR_SN = T1.CNTR_SN
                   AND T2.CNTR_REL_DTL_CD = '212'
                   AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN T2.VL_STRT_DTM AND T2.VL_END_DTM
                 WHERE T2.OJ_DTL_CNTR_NO = SC2.CNTR_NO
                   AND T2.OJ_DTL_CNTR_SN = SC2.CNTR_SN
                   AND T2.VL_STRT_DTM = (SELECT MAX(X.VL_STRT_DTM)
                                           FROM TB_SSCT_CNTR_REL X
                                          WHERE X.OJ_DTL_CNTR_NO = SC2.CNTR_NO
                                            AND X.OJ_DTL_CNTR_SN = SC2.CNTR_SN)) AS SV_TP_NM  /*관리유형*/
             , SUBSTR(SC1.CNTR_CNFM_DTM,1,8) AS CNTR_DT /*계약일자*/
             , (SELECT NVL2(X.HOO_PRTNR_NO, X.OG_CD, '')
                  FROM TB_OGBS_MM_OG_IZ X
                 WHERE X.BASE_YM = SP.BASE_YM
                   AND X.OG_ID = SP.OG_ID) AS OG_CD/*지점코드*/
             , (SELECT NVL2(X.HOO_PRTNR_NO, X.HOO_PRTNR_NO, '')
                  FROM TB_OGBS_MM_OG_IZ X
                 WHERE X.BASE_YM = SP.BASE_YM
                   AND X.OG_ID = SP.OG_ID) AS BRMGR_PRTNR_NO /*지점장사번*/
             , (SELECT NVL2(X.HOO_PRTNR_NO, X.HOO_PRTNR_NM, '')
                  FROM TB_OGBS_MM_OG_IZ X
                 WHERE X.BASE_YM = SP.BASE_YM
                   AND X.OG_ID = SP.OG_ID) AS BRMGR_PRTNR_NM /*지점장*/
             , (SELECT MAX(DECODE(T1.SV_BIZ_HCLSF_CD,'1', T1.ASN_DT, ''))
                  FROM TB_SVPD_CST_SVAS_IST_ASN_IZ T1
                 WHERE T1.CNTR_NO = SV1.CNTR_NO
                   AND T1.CNTR_SN = SV1.CNTR_SN
                   AND T1.DTA_DL_YN = 'N')  AS ASN_DT /*배정일자*/
             , (SELECT F_CMZ_CD_NM('TNT_WELLS', 'SELL_CHNL_DV_CD', NVL(X.SELL_CHNL_DV_CD,0))
                  FROM TB_OGBS_PRTNR_BAS X
                 WHERE X.OG_TP_CD = SP.OG_TP_CD
                   AND X.PRTNR_NO = SP.PRTNR_NO) AS SELL_CHNL /*판매채널*/
             , SP.PRTNR_NO /*판매자사번*/
             , SP.PRTNR_KNM /*판매자*/
<!--             , (SELECT X.OJ_CNTR_NO ||'-'|| X.OJ_CNTR_SN-->
<!--                  FROM TB_SSCT_MCHN_CH_IZ X-->
<!--                 WHERE X.BASE_CNTR_NO = SV1.CNTR_NO-->
<!--                   AND X.BASE_CNTR_SN = SV1.CNTR_SN-->
<!--                   AND X.DTA_DL_YN = 'N'-->
<!--                   AND SV1.CNTR_DTL_STAT_CD != '303') AS BF_CNTR_NO /*전상대코드*/-->
             , (SELECT X.BASE_DTL_CNTR_NO || '-' || X.BASE_DTL_CNTR_SN
                  FROM TB_SSCT_CNTR_REL X
                 WHERE X.OJ_DTL_CNTR_NO = SV1.CNTR_NO
                   AND X.OJ_DTL_CNTR_SN = SV1.CNTR_SN
                   AND X.CNTR_REL_DTL_CD = '212'
                   AND X.DTA_DL_YN = 'N') AS BF_CNTR_NO /*전상대코드*/
<!--             , (SELECT X.BASE_CNTR_NO ||'-'|| X.BASE_CNTR_SN-->
<!--                  FROM TB_SSCT_MCHN_CH_IZ X-->
<!--                 WHERE X.BASE_CNTR_NO = SV1.CNTR_NO-->
<!--                   AND X.BASE_CNTR_SN = SV1.CNTR_SN-->
<!--                   AND X.DTA_DL_YN = 'N'-->
<!--                   AND SV1.CNTR_DTL_STAT_CD != '303') AS AF_CNTR_NO /*후상대코드*/-->
             , (SELECT MAX(X.OJ_DTL_CNTR_NO || '-' || X.OJ_DTL_CNTR_SN)
                  FROM TB_SSCT_CNTR_REL X
                 WHERE X.BASE_DTL_CNTR_NO = SV1.CNTR_NO
                   AND X.BASE_DTL_CNTR_SN = SV1.CNTR_SN
                   AND X.CNTR_REL_DTL_CD = '212'
                   AND X.DTA_DL_YN = 'N') AS AF_CNTR_NO /*후상대코드*/
             , SV1.IST_DT /*설치일자*/
             , SV1.CHNG_DT /*교체일자*/
             , (SELECT MAX(DECODE(X.CNTR_DTL_STAT_CD, '303', SUBSTR(X.HIST_STRT_DTM,1,8), ''))
                  FROM TB_SSCT_CNTR_DTL_STAT_CH_HIST X /* 계약상세상태변경이력 */
                 WHERE SV1.CNTR_NO = X.CNTR_NO
                   AND SV1.CNTR_SN = X.CNTR_SN
                   AND SUBSTR(X.HIST_END_DTM,1,8) = '99991231'
                   AND X.DTA_DL_YN = 'N') AS CAN_DT /*취소일자*/
             , (SELECT MAX(DECODE(X.CNTR_DTL_STAT_CD, '202', SUBSTR(X.HIST_STRT_DTM,1,8), ''))
                  FROM TB_SSCT_CNTR_DTL_STAT_CH_HIST X /* 계약상세상태변경이력 */
                 WHERE SV1.CNTR_NO = X.CNTR_NO
                   AND SV1.CNTR_SN = X.CNTR_SN
                   AND SUBSTR(X.HIST_END_DTM,1,8) = '99991231'
                   AND X.DTA_DL_YN = 'N') AS SV_STP_DT /*중지일자*/
<!--             , CASE WHEN SC5.CNTR_DTL_STAT_CD = '303' THEN SUBSTR(SC5.HIST_STRT_DTM,1,8) ELSE '' END AS CAN_DT /*취소일자*/-->
<!--             , CASE WHEN SC5.CNTR_DTL_STAT_CD = '202' THEN SUBSTR(SC5.HIST_STRT_DTM,1,8) ELSE '' END AS SV_STP_DT /*중지일자*/-->
             , (CASE WHEN SV1.IST_DT IS NOT NULL AND TO_NUMBER(SV1.IST_DT) != 0
                     THEN TO_CHAR(ADD_MONTHS(SV1.IST_DT,SC4.FRISU_AS_PTRM_N),'YYYYMMDD')
                     ELSE ''
                 END) AS AS_EXPR_DT /*AS만기*/
             , (CASE WHEN SV1.IST_DT IS NOT NULL AND TO_NUMBER(SV1.IST_DT) != 0
                     THEN DECODE(SC4.FRISU_BFSVC_PTRM_N,0,'',TO_CHAR(ADD_MONTHS(SV1.IST_DT,SC4.FRISU_BFSVC_PTRM_N),'YYYYMMDD'))
                     ELSE ''
                 END) AS BS_EXPR_DT /*BS만기*/
             , SV1.CPS_DT /*기변일자 - 보상일자*/
             , SV1.REQD_DT /*철거일자*/
<!--             /*TODO: 멤버십 조회쿼리 변경*/-->
	         , (SELECT MIN(T2.CNTR_PD_STRTDT)
                  FROM TB_SSCT_CNTR_REL T1
                 INNER JOIN TB_SSCT_CNTR_DTL T2
                    ON T2.CNTR_NO = T1.BASE_DTL_CNTR_NO
                   AND T2.CNTR_SN = T1.BASE_DTL_CNTR_SN
                   AND T2.SELL_TP_CD = '3'
                 WHERE T1.OJ_DTL_CNTR_NO = SC2.CNTR_NO
                   AND T1.OJ_DTL_CNTR_SN = SC2.CNTR_SN
                   AND T1.CNTR_REL_DTL_CD = '212') AS MSH_J_DT /*멤버십시작일*/ -- 계약에서 찾기
             , (SELECT MAX(T2.CNTR_PD_ENDDT)
                  FROM TB_SSCT_CNTR_REL T1
                 INNER JOIN TB_SSCT_CNTR_DTL T2
                    ON T2.CNTR_NO = T1.BASE_DTL_CNTR_NO
                   AND T2.CNTR_SN = T1.BASE_DTL_CNTR_SN
                   AND T2.SELL_TP_CD = '3'
                   AND SUBSTR(T2.CNTR_DTL_STAT_CD,1,1) IN ('3','4') -- 해약,종료인 것만
                 WHERE T1.OJ_DTL_CNTR_NO = SC2.CNTR_NO
                   AND T1.OJ_DTL_CNTR_SN = SC2.CNTR_SN
                   AND T1.CNTR_REL_DTL_CD = '212') AS MSH_WDWAL_DT /*멤버십종료일*/ -- 계약에서 찾기
<!--             , (SELECT T1.MSH_J_DT-->
<!--                  FROM TB_SVPD_MCBY_CST_SV_OJ_IZ T1-->
<!--                 WHERE T1.CNTR_NO = SC2.CNTR_NO-->
<!--                   AND T1.CNTR_SN = SC2.CNTR_SN-->
<!--                   AND T1.MNGT_YM = TO_CHAR(SYSDATE,'YYYYMM')-->
<!--                ) AS MSH_J_DT /*멤버십시작일*/-->
<!--             , (SELECT T1.MSH_WDWAL_DT-->
<!--                  FROM TB_SVPD_MCBY_CST_SV_OJ_IZ T1-->
<!--                 WHERE T1.CNTR_NO = SC2.CNTR_NO-->
<!--                   AND T1.CNTR_SN = SC2.CNTR_SN-->
<!--                   AND T1.MNGT_YM = TO_CHAR(SYSDATE,'YYYYMM')-->
<!--                ) AS MSH_WDWAL_DT /*멤버십종료일*/-->
             , SV1.BC_NO /*바코드*/
             , SV2.BC_NO AS PBL_BC_NO /*발행바코드*/
             , SV1.QRS_RDM_NO /*맞춤가이드 - 랜덤QR번호*/
             , SV1.SS_PDCT_BC_NO /*삼성제조번호*/
             , (SELECT MAX(T1.SPP_IVC_NO)
                  FROM TB_SVPD_CST_SV_WK_RS_IZ T1
                 WHERE T1.CNTR_NO = SV1.CNTR_NO
                   AND T1.CNTR_SN = SV1.CNTR_SN
                   AND T1.DTA_DL_YN = 'N') AS IVC_NO /*송장번호*/
             , (SELECT  F_CMZ_CD_NM('TNT_WELL', 'SV_VST_PRD_CD',X.PD_PRP_VAL02)
                  FROM TB_PDBS_PD_ECOM_PRP_DTL X
                 WHERE X.PD_CD = SV1.SV_PD_CD
                   AND X.PD_EXTS_PRP_GRP_CD = 'SCHD'
                   AND X.DTA_DL_YN = 'N') AS VST_PRD_NM /* 방문주기1 */
             , (SELECT  F_CMZ_CD_NM('TNT_WELL', 'SV_VST_PRD_CD',X.PD_PRP_VAL03)
                  FROM TB_PDBS_PD_ECOM_PRP_DTL X
                 WHERE X.PD_CD = SV1.SV_PD_CD
                   AND X.PD_EXTS_PRP_GRP_CD = 'SCHD'
                   AND X.DTA_DL_YN = 'N') AS PRD_NM /* 방문주기2 */
          FROM TB_SVPD_CST_SV_EXCN_IZ SV1 /*고객서비스 수행내역*/
          LEFT OUTER JOIN TB_SVPD_PD_BC_RPBL_CST_IZ SV2 /*상품바코드재발행고객내역*/
            ON SV2.CNTR_NO = SV1.CNTR_NO
           AND SV2.CNTR_SN = SV1.CNTR_SN
           AND SV2.DTA_DL_YN = 'N'
           AND SV2.PBL_DT = (SELECT MAX(X.PBL_DT)
                               FROM TB_SVPD_PD_BC_RPBL_CST_IZ X
                              WHERE X.CNTR_NO = SV1.CNTR_NO
                                AND X.CNTR_SN = SV1.CNTR_SN
                                AND X.DTA_DL_YN = 'N')
          LEFT OUTER JOIN TB_SVPD_CNTR_CST_UNUITM_DTL SV3 /*계약고객특이사항상세*/
            ON SV3.CNTR_NO = SV1.CNTR_NO
           AND SV3.CNTR_SN = SV1.CNTR_SN
           AND SV3.DTL_SN = (SELECT MAX(X.DTL_SN)
                               FROM TB_SVPD_CNTR_CST_UNUITM_DTL X
                              WHERE X.CNTR_NO = SV1.CNTR_NO
                                AND X.CNTR_SN = SV1.CNTR_SN
                                AND X.DTA_DL_YN = 'N')
           AND SV3.DTA_DL_YN = 'N'
         INNER JOIN TB_SSCT_CNTR_BAS SC1 /*계약기본*/
            ON SC1.CNTR_NO = SV1.CNTR_NO
           AND SC1.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_DTL SC2 /*계약상세*/
            ON SC2.CNTR_NO = SV1.CNTR_NO
           AND SC2.CNTR_SN = SV1.CNTR_SN
           AND SC2.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_CST_REL SC3 /*계약고객관계*/
            ON SC3.DTL_CNTR_NO = SC2.CNTR_NO
           AND SC3.DTL_CNTR_SN = SC2.CNTR_SN
           AND SC3.CNTR_CST_REL_TP_CD = '10' /* 계약자 */
           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN SC3.VL_STRT_DTM AND SC3.VL_END_DTM
           AND SC3.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_WELLS_DTL SC4 /*계약WELLS상세*/
            ON SC4.CNTR_NO = SV1.CNTR_NO
           AND SC4.CNTR_SN = SV1.CNTR_SN
           AND SC4.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_CUBS_CST_BAS CST /*고객기본*/
            ON CST.CST_NO = SC3.CST_NO
          LEFT OUTER JOIN TB_SSCT_CNTR_ADR_REL SA1 /*계약주소관계 - 계약주소*/
            ON SA1.DTL_CNTR_NO = SC2.CNTR_NO
           AND SA1.DTL_CNTR_SN = SC2.CNTR_SN
           AND SA1.ADRPC_TP_CD IN ('2','3')
           AND TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS') BETWEEN SA1.VL_STRT_DTM AND SA1.VL_END_DTM
           AND SA1.DTA_DL_YN = 'N'
          LEFT OUTER JOIN TB_SSCT_CNTR_ADRPC_BAS SA2 /*계약주소지기본*/
            ON SA2.CNTR_ADRPC_ID = SA1.CNTR_ADRPC_ID
          LEFT OUTER JOIN TB_GBCO_ADR_BAS ADR /*주소기본*/
            ON ADR.ADR_ID = SA2.ADR_ID
<!--          LEFT OUTER JOIN TB_SSCT_CNTR_DTL_STAT_CH_HIST SC5 /* 계약상세상태변경이력 */-->
<!--            ON SV1.CNTR_NO = SC5.CNTR_NO-->
<!--           AND SV1.CNTR_SN = SC5.CNTR_SN-->
<!--           AND SUBSTR(SC5.HIST_END_DTM,1,8) = '99991231'-->
<!--           AND SC5.DTA_DL_YN = 'N'-->
          LEFT OUTER JOIN TB_SSCT_CNTR_PD_REL SC6 /*계약상품관계*/
            ON SC6.CNTR_PD_REL_ID = (SELECT MAX(X.CNTR_PD_REL_ID)
                                       FROM TB_SSCT_CNTR_PD_REL X
                                      WHERE X.CNTR_NO = SC2.CNTR_NO
                                        AND X.CNTR_SN = SC2.CNTR_SN)
          LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ SP  /* 월파트너내역 -판매파트너*/
            ON SP.BASE_YM = SUBSTR(SC1.CNTR_RCP_FSH_DTM,1,6)
           AND SP.OG_TP_CD = SC1.SELL_OG_TP_CD
           AND SP.PRTNR_NO = SC1.SELL_PRTNR_NO
           AND SP.DTA_DL_YN = 'N'
         WHERE 1=1
        <if test="@MybatisUtils@isNotEmpty(cntrNo) and @MybatisUtils@isNotEmpty(cntrSn)">
           AND SV1.CNTR_NO = #{cntrNo}
           AND SV1.CNTR_SN = #{cntrSn}
        </if>
        <if test="@MybatisUtils@isNotEmpty(bcNo)">
          AND SV1.CNTR_NO = (SELECT MAX(T1.CNTR_NO)
                               FROM TB_SVPD_CST_SV_EXCN_IZ T1
                              WHERE T1.BC_NO = #{bcNo}
                                AND T1.DTA_DL_YN = 'N')
          AND SV1.CNTR_SN = (SELECT MAX(T1.CNTR_SN)
                               FROM TB_SVPD_CST_SV_EXCN_IZ T1
                              WHERE T1.BC_NO = #{bcNo}
                                AND T1.DTA_DL_YN = 'N')

        </if>
        <if test="@MybatisUtils@isNotEmpty(sppIvcNo)">
          AND SV1.CNTR_NO = (SELECT MAX(T1.CNTR_NO)
                               FROM TB_SVPD_CST_SV_WK_RS_IZ T1
                              WHERE T1.BC_NO = #{sppIvcNo}
                                AND T1.DTA_DL_YN = 'N')
          AND SV1.CNTR_SN = (SELECT MAX(T1.CNTR_SN)
                               FROM TB_SVPD_CST_SV_WK_RS_IZ T1
                              WHERE T1.BC_NO = #{sppIvcNo}
                                AND T1.DTA_DL_YN = 'N')
        </if>
    </select>

    <select id="selectIndividualServiceHousehold" resultType="com.kyowon.sms.wells.web.service.visit.dvo.WsnbIndividualServicePsDvo">
        SELECT SV1.SV_HSHD_NO /*가구화코드*/
             , SV1.CNTR_NO || '-' || SV1.CNTR_SN AS CNTR_DTL /*계약상세번호*/
             , SA2.RCGVP_KNM AS CST_NM /*고객명*/
             , (SELECT X.PD_ABBR_NM FROM TB_PDBS_PD_BAS X WHERE X.PD_CD = SV1.PDCT_PD_CD) AS PD_NM /*상품명*/
             , NVL2(SA2.LOCARA_TNO, SA2.LOCARA_TNO, '') AS LOCARA_TNO /*전화번호(지역전화번호)*/
             , NVL2(SA2.LOCARA_TNO, SA2.EXNO_ENCR, '')         AS EXNO_ENCR /*전화번호(전화국번호암호화)*/
             , NVL2(SA2.LOCARA_TNO, SA2.IDV_TNO, '')           AS IDV_TNO /*전화번호(개별전화번호)*/
             , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_LOCARA_TNO, '')   AS CRAL_LOCARA_TNO /*휴대전화번호(휴대지역전화번호)*/
             , NVL2(SA2.CRAL_LOCARA_TNO, SA2.MEXNO_ENCR, '')   AS MEXNO_ENCR /*휴대전화번호(휴대전화국번호암호화)*/
             , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_IDV_TNO, '') AS CRAL_IDV_TNO /*휴대전화번호(휴대개별전화번호)*/
          FROM TB_SVPD_CST_SV_EXCN_IZ SV1/*서비스수행내역*/
         INNER JOIN TB_SSCT_CNTR_ADR_REL SA1 /*계약주소관계*/
            ON SV1.CNTR_NO = SA1.DTL_CNTR_NO
           AND SV1.CNTR_SN = SA1.DTL_CNTR_SN
           AND SA1.ADRPC_TP_CD = '3'
         INNER JOIN TB_SSCT_CNTR_ADRPC_BAS SA2 /*계약주소지기본*/
            ON SA1.CNTR_ADRPC_ID = SA2.CNTR_ADRPC_ID
         LEFT OUTER JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ SV2
           ON SV1.CNTR_NO = SV2.CNTR_NO
          AND SV1.CNTR_SN = SV2.CNTR_SN
          AND SV2.MNGT_YM = TO_CHAR(SYSDATE, 'YYYYMM')
         WHERE SV1.SV_HSHD_NO = (SELECT X.SV_HSHD_NO
                                   FROM TB_SVPD_CST_SV_EXCN_IZ X
                                  WHERE X.CNTR_NO = #{cntrNo}
                                    AND X.CNTR_SN = #{cntrSn})
           AND SV1.REQD_DT IS NULL
           AND SV1.CPS_DT IS NULL
           AND SV2.MSH_WDWAL_DT IS NULL
           AND SV2.CAN_DT IS NULL
           AND SV1.SV_HSHD_NO IS NOT NULL
         ORDER BY SV1.CNTR_NO, SV1.CNTR_SN
    </select>
    <select id="selectIndividualServiceContact" resultType="com.kyowon.sms.wells.web.service.visit.dto.WsnbIndividualServicePsDto$SearchContactRes">
<!--        SELECT GUBUN /*구분*/-->
<!--             , CNTC_DT/*등록일시*/-->
<!--             , ABSNC_RSON_KIND/*컨택그룹*/-->
<!--             , ABSNC_RSON/*컨택구분*/-->
<!--             , OG_TP_CD/*소속*/-->
<!--             , PRTNR_NO/*사번*/-->
<!--             , PRTNR_NM/*성명*/-->
<!--             , CNTC_CN/*컨택상세*/-->
<!--             , CST_SV_ASN_NO /*배정번호*/-->
<!--             , RCP_DT /*접수일자*/-->
<!--             , CNTR_NO-->
<!--             , CNTR_SN-->
<!--          FROM (-->
<!--                (SELECT 'AS' GUBUN /*구분*/-->
<!--                      , S1.CNTC_DT || S1.CNTC_HH AS CNTC_DT/*등록일시*/-->
<!--                      , DECODE(SUBSTR(S1.ABSNC_RSON_CD,1,1), '0', '컨택완료'-->
<!--                                                           , '1', '고객부재'-->
<!--                                                           , '2', '방문불가'-->
<!--                                                           , '3', '고객이관'-->
<!--                                                           , '') AS ABSNC_RSON_KIND /*컨택그룹*/-->
<!--                       , F_CMZ_CD_NM('TNT_WELLS', 'ABSNC_RSON_CD', NVL(S1.ABSNC_RSON_CD,0)) AS ABSNC_RSON /*컨택구분*/-->
<!--                       , DECODE (P1.OG_TP_CD, 'W06', P1.OG_NM, P1.OG_CD) AS OG_TP_CD /*소속*/-->
<!--                       , NVL(P1.PRTNR_NO, S1.PRTNR_NO) AS PRTNR_NO /*사번*/-->
<!--                       , P1.PRTNR_KNM AS PRTNR_NM /*성명*/-->
<!--                       , S1.CNTC_CN /*컨택상세*/-->
<!--                       , S1.CST_SV_ASN_NO /*배정번호*/-->
<!--                       , S2.WK_ACPTE_DT || '' || S2.WK_ACPTE_HH AS RCP_DT /*접수일자*/-->
<!--                       , S2.CNTR_NO-->
<!--                       , S2.CNTR_SN-->
<!--                    FROM TB_SVPD_CST_SV_CNTC_IZ S1 /*고객서비스접톡내역*/-->
<!--                   INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ S2 /*고객서비스AS설치배정내역*/-->
<!--                      ON S1.CST_SV_ASN_NO = S2.CST_SV_ASN_NO-->
<!--                     AND S1.CNTC_DT = S2.ASN_DT-->
<!--                   INNER JOIN TB_OGBS_MM_PRTNR_IZ P1-->
<!--                      ON P1.PRTNR_NO = S2.WK_PRTNR_NO-->
<!--                     AND P1.OG_TP_CD = S2.WK_PRTNR_OG_TP_CD-->
<!--                     AND P1.BASE_YM = SUBSTR(S2.CST_SV_ASN_NO, 2,6)-->
<!--                     AND P1.DTA_DL_YN = 'N'-->
<!--                   WHERE 1=1-->
<!--                     AND S2.SV_BIZ_HCLSF_CD IN ('1','3')-->
<!--                 )-->
<!--                 UNION ALL-->
<!--                 (SELECT 'BS' GUBUN /*구분*/-->
<!--                       , S1.CNTC_DT || S1.CNTC_HH AS CNTC_DT/*등록일시*/-->
<!--                       , DECODE(SUBSTR(S1.ABSNC_RSON_CD,1,1), '0', '컨택완료'-->
<!--                                                            , '1', '고객부재'-->
<!--                                                            , '2', '방문불가'-->
<!--                                                            , '3', '고객이관'-->
<!--                                                            , '') AS ABSNC_RSON_KIND /*컨택그룹*/-->
<!--                        , F_CMZ_CD_NM('TNT_WELLS', 'ABSNC_RSON_CD', NVL(S1.ABSNC_RSON_CD,0)) AS ABSNC_RSON /*컨택구분*/-->
<!--                        , DECODE (P1.OG_TP_CD, 'W06', P1.OG_NM, P1.OG_CD) AS OG_TP_CD /*소속*/-->
<!--                        , NVL(P1.PRTNR_NO, S1.PRTNR_NO) AS PRTNR_NO /*사번*/-->
<!--                        , P1.PRTNR_KNM AS PRTNR_NM /*성명*/-->
<!--                        , S1.CNTC_CN /*컨택상세*/-->
<!--                        , S1.CST_SV_ASN_NO /*배정번호*/-->
<!--                        , S2.CNFM_PSIC_ASN_DT || '' || S2.CNFM_PSIC_ASN_HH AS RCP_DT /*접수일자*/-->
<!--                        , S2.CNTR_NO-->
<!--                        , S2.CNTR_SN-->
<!--                    FROM TB_SVPD_CST_SV_CNTC_IZ S1 /*고객서비스접톡내역*/-->
<!--                   INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ S2 /*고객서비스BS설치배정내역*/-->
<!--                      ON S1.CST_SV_ASN_NO = S2.CST_SV_ASN_NO-->
<!--                     AND S1.CNTC_DT = S2.CST_CNTC_DT-->
<!--                   INNER JOIN TB_OGBS_MM_PRTNR_IZ P1-->
<!--                      ON P1.PRTNR_NO = S2.CNFM_PSIC_PRTNR_NO-->
<!--                     AND P1.OG_TP_CD = S2.CNFM_PSIC_PRTNR_OG_TP_CD-->
<!--                     AND P1.BASE_YM = S2.ASN_OJ_YM-->
<!--                     AND P1.DTA_DL_YN = 'N'-->
<!--                   WHERE 1=1-->
<!--                     AND SUBSTR( S2.CST_SV_ASN_NO, 0, 1)  IN ('2')-->
<!--                 )-->
<!--            )-->
<!--            WHERE 1=1-->
<!--              AND CNTR_NO = #{cntrNo}-->
<!--              AND CNTR_SN = #{cntrSn}-->
<!--            ORDER BY RCP_DT DESC, CST_SV_ASN_NO DESC-->
        SELECT GUBUN /*구분*/
             , CNTC_DT/*등록일시*/
             , ABSNC_RSON_KIND/*컨택그룹*/
             , ABSNC_RSON/*컨택구분*/
             , OG_TP_CD/*소속*/
             , PRTNR_NO/*사번*/
             , PRTNR_NM/*성명*/
             , CNTC_CN/*컨택상세*/
             , CST_SV_ASN_NO /*배정번호*/
             , RCP_DT /*접수일자*/
             , CNTR_NO
             , CNTR_SN
          FROM (
                (SELECT 'AS' GUBUN /*구분*/
                      , S1.CNTC_DT || S1.CNTC_HH AS CNTC_DT/*등록일시*/
                      , DECODE(SUBSTR(S1.ABSNC_RSON_CD,1,1), '0', '컨택완료'
                                                           , '1', '고객부재'
                                                           , '2', '방문불가'
                                                           , '3', '고객이관'
                                                           , '') AS ABSNC_RSON_KIND /*컨택그룹*/
                       , F_CMZ_CD_NM('TNT_WELLS', 'ABSNC_RSON_CD', NVL(S1.ABSNC_RSON_CD,0)) AS ABSNC_RSON /*컨택구분*/
                       , DECODE (P1.OG_TP_CD, 'W06', P1.OG_NM, P1.OG_CD) AS OG_TP_CD /*소속*/
                       , NVL(P1.PRTNR_NO, S1.PRTNR_NO) AS PRTNR_NO /*사번*/
                       , P1.PRTNR_KNM AS PRTNR_NM /*성명*/
                       , S1.CNTC_CN /*컨택상세*/
                       , S1.CST_SV_ASN_NO /*배정번호*/
                       , S2.WK_ACPTE_DT || '' || S2.WK_ACPTE_HH AS RCP_DT /*접수일자*/
                       , S2.CNTR_NO
                       , S2.CNTR_SN
                    FROM TB_SVPD_CST_SV_CNTC_IZ S1 /*고객서비스접톡내역*/
                   INNER JOIN (SELECT WK_ACPTE_DT
                                    , WK_ACPTE_HH
                                    , CST_SV_ASN_NO
                                    , WK_PRTNR_NO
                                    , WK_PRTNR_OG_TP_CD
                                    , CNTR_NO
                                    , CNTR_SN
                                    , ASN_DT
                                 FROM TB_SVPD_CST_SVAS_IST_ASN_IZ )S2
                      ON S1.CST_SV_ASN_NO = S2.CST_SV_ASN_NO
                     AND S1.CNTC_DT = S2.ASN_DT
                   INNER JOIN TB_OGBS_MM_PRTNR_IZ P1
                      ON P1.PRTNR_NO = S2.WK_PRTNR_NO
                     AND P1.OG_TP_CD = S2.WK_PRTNR_OG_TP_CD
                     AND P1.BASE_YM = SUBSTR(S2.CST_SV_ASN_NO, 2,6)
                     AND P1.DTA_DL_YN = 'N'
                   WHERE 1=1
                     AND SUBSTR( S2.CST_SV_ASN_NO, 0, 1) IN ('1','3')
                 )
                 UNION ALL
                 (SELECT 'BS' GUBUN /*구분*/
                       , S1.CNTC_DT || S1.CNTC_HH AS CNTC_DT/*등록일시*/
                       , DECODE(SUBSTR(S1.ABSNC_RSON_CD,1,1), '0', '컨택완료'
                                                            , '1', '고객부재'
                                                            , '2', '방문불가'
                                                            , '3', '고객이관'
                                                            , '') AS ABSNC_RSON_KIND /*컨택그룹*/
                        , F_CMZ_CD_NM('TNT_WELLS', 'ABSNC_RSON_CD', NVL(S1.ABSNC_RSON_CD,0)) AS ABSNC_RSON /*컨택구분*/
                        , DECODE (P1.OG_TP_CD, 'W06', P1.OG_NM, P1.OG_CD) AS OG_TP_CD /*소속*/
                        , NVL(P1.PRTNR_NO, S1.PRTNR_NO) AS PRTNR_NO /*사번*/
                        , P1.PRTNR_KNM AS PRTNR_NM /*성명*/
                        , S1.CNTC_CN /*컨택상세*/
                        , S1.CST_SV_ASN_NO /*배정번호*/
                        , S2.CNFM_PSIC_ASN_DT || '' || S2.CNFM_PSIC_ASN_HH AS RCP_DT /*접수일자*/
                        , S2.CNTR_NO
                        , S2.CNTR_SN
                    FROM TB_SVPD_CST_SV_CNTC_IZ S1 /*고객서비스접톡내역*/
                   INNER JOIN (SELECT CNFM_PSIC_ASN_DT
                                    , CNFM_PSIC_ASN_HH
                                    , CST_SV_ASN_NO
                                    , CNTC_ICHR_PRTNR_NO
                                    , CNTC_ICHR_PRTNR_OG_TP_CD
                                    , ASN_OJ_YM
                                    , CNTR_NO
                                    , CNTR_SN
                                    , CST_CNTC_DT
                                 FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ ) S2
                      ON S1.CST_SV_ASN_NO = S2.CST_SV_ASN_NO
                     AND S1.CNTC_DT = S2.CST_CNTC_DT
                   INNER JOIN TB_OGBS_MM_PRTNR_IZ P1
                      ON P1.PRTNR_NO = S2.CNTC_ICHR_PRTNR_NO
                     AND P1.OG_TP_CD = S2.CNTC_ICHR_PRTNR_OG_TP_CD
                     AND P1.BASE_YM = S2.ASN_OJ_YM
                     AND P1.DTA_DL_YN = 'N'
                   WHERE 1=1
                     AND SUBSTR( S2.CST_SV_ASN_NO, 1, 1) = '2'
                 )
            )
            WHERE 1=1
              AND CNTR_NO = #{cntrNo}
              AND CNTR_SN = #{cntrSn}
            ORDER BY RCP_DT DESC, CST_SV_ASN_NO DESC
    </select>

    <select id="selectIndividualProcessState" resultType="com.kyowon.sms.wells.web.service.visit.dvo.WsnbIndividualServicePsDvo">
        SELECT GUBUN
             , SV_TP /*유형*/
             , RCP_DT /*접수(배정)일자*/
             , SV_BIZ_DCLSF /*접수(배정)내역*/
             , REQ_DT /*요청약속일자*/
             , (CASE WHEN PROC_STUS = '20' THEN VST_FSH_DT ELSE '' END) AS VST_FSH_DT /*처리일자*/
             , WK_PRGS_STAT /*처리결과*/
             , AS_CAUS /*처리내역*/
             , RTNGD_PROCS_TP /*반품처리정보*/
             , FST_VST_FSH_DT /*폐기일자:출고확인일자*/
             , ZIP_NO /*우편번호*/
             , OG_TP /*구분(담당자)*/
             , OG_NM /*소속(담당자)*/
             , PRTNR_NO /*사번(담당자)*/
             , PRTNR_NM /*성명(담당자)*/
             , CRAL_LOCARA_TNO /*휴대지역전화번호(담당자)*/
             , MEXNO_ENCR /*휴대전화국번호암호화(담당자)*/
             , CRAL_IDV_TNO /*휴대개별전화번호(담당자)*/
             , BLD_NM /*소속빌딩(담당자)*/
             , BC_NO /*작업시바코드*/
             , IMG_YN /*사진*/
             , IST_ENVR_PHO_PH_DOC_ID /*설치환경사진경로*/
             , IST_KIT_PHO_PH_DOC_ID /*설치키드사진경로*/
             , IST_CELNG_PHO_PH_DOC_ID /*설치천장사진경로*/
             , ASN_DT /*배정일자*/
             , CST_SV_ASN_NO /*배정번호*/
             , PROC_STUS /*작업진행상태*/
             , CNTR_NO
             , CNTR_SN
             , SV_HSHD_NO
             , SV_HSHD_NO_CNT
             , SV_BIZ_HCLSF_CD
             , SV_BIZ_DCLSF_CD
          FROM (
                (/*A/S작업완료 건*/
                 SELECT /*+ LEADING(S1) USE_NL(S1 S2 S4 P1) INDEX(S4 PK_SVPD_MCBY_CST_SV_OJ_IZ) */
                       'AD' GUBUN
                     , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_HCLSF_CD', DECODE(S1.SV_BIZ_HCLSF_CD,'9',1,S1.SV_BIZ_HCLSF_CD)) AS SV_TP /*유형*/
                     , S2.ASN_DT ||'000000' AS RCP_DT /*접수(배정)일자*/
                     , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_DCLSF_CD', S1.SV_BIZ_DCLSF_CD)  AS SV_BIZ_DCLSF /*접수(배정)내역*/
                     , S2.VST_CNFMDT || S2.VST_CNFM_HH AS REQ_DT /*요청약속일자*/
                     , S1.VST_FSH_DT || S1.VST_FSH_HH  AS VST_FSH_DT /*처리일자*/
                     , F_CMZ_CD_NM('TNT_WELLS', 'WK_PRGS_STAT_CD', S1.WK_PRGS_STAT_CD) AS WK_PRGS_STAT /*처리결과*/
                     , F_CMZ_CD_NM('TNT_WELLS', 'AS_CAUS_CD', S1.AS_CAUS_CD) AS AS_CAUS /*처리내역*/
                     , F_CMZ_CD_NM('TNT_WELLS', 'RTNGD_PROCS_TP_CD', S3.RTNGD_PROCS_TP_CD) AS RTNGD_PROCS_TP /*반품처리정보*/
                     , S3.OSTR_CONF_DT AS FST_VST_FSH_DT/*폐기일자:출고확인일자*/
                     , (SELECT NVL(X.NEW_ADR_ZIP, X.OLD_ADR_ZIP)
                          FROM TB_GBCO_ADR_BAS X
                         WHERE X.ADR_ID = S4.ADR_ID) AS ZIP_NO /*우편번호*/
                     , F_CMZ_CD_NM('TNT_WELLS', 'MNGR_DV_CD', DECODE(P1.OG_TP_CD, 'W06', '2','1')) AS OG_TP /*구분(담당자)*/
                     , DECODE(P1.OG_TP_CD, 'W06', P1.OG_NM, P1.OG_CD) AS OG_NM /*소속(담당자)*/
                     , NVL(P1.PRTNR_NO, S1.PRTNR_NO) AS PRTNR_NO/*사번(담당자)*/
                     , P1.PRTNR_KNM AS PRTNR_NM /*성명(담당자)*/
                     , (SELECT X.CRAL_LOCARA_TNO
                          FROM TB_OGBS_PRTNR_BAS X
                         WHERE X.OG_TP_CD = P1.OG_TP_CD
                           AND X.PRTNR_NO = P1.PRTNR_NO) AS CRAL_LOCARA_TNO /*휴대지역전화번호(담당자)*/
                     , (SELECT X.MEXNO_ENCR
                          FROM TB_OGBS_PRTNR_BAS X
                         WHERE X.OG_TP_CD = P1.OG_TP_CD
                           AND X.PRTNR_NO = P1.PRTNR_NO)  AS MEXNO_ENCR /*휴대전화국번호암호화(담당자)*/
                     , (SELECT X.CRAL_IDV_TNO
                          FROM TB_OGBS_PRTNR_BAS X
                         WHERE X.OG_TP_CD = P1.OG_TP_CD
                           AND X.PRTNR_NO = P1.PRTNR_NO)  AS CRAL_IDV_TNO /*휴대개별전화번호(담당자)*/
                     , '' AS BLD_NM /*소속빌딩(담당자)*/
                     , S1.BC_NO /*작업시바코드*/
                     , (CASE WHEN S1.IST_ENVR_PHO_PH_DOC_ID IS NOT NULL
                               OR S1.IST_KIT_PHO_PH_DOC_ID IS NOT NULL
                               OR S1.IST_CELNG_PHO_PH_DOC_ID IS NOT NULL
                             THEN 'Y'
<!--                             ELSE 'N'-->
                         END) AS IMG_YN /*사진*/
                     , NVL(S1.IST_ENVR_PHO_PH_DOC_ID, '') AS IST_ENVR_PHO_PH_DOC_ID /*설치환경사진경로*/
                     , NVL(S1.IST_KIT_PHO_PH_DOC_ID, '') AS IST_KIT_PHO_PH_DOC_ID /*설치키드사진경로*/
                     , NVL(S1.IST_CELNG_PHO_PH_DOC_ID, '') AS IST_CELNG_PHO_PH_DOC_ID /*설치천장사진경로*/
                     , '' AS ASN_DT /*배정일자*/
                     , S1.CST_SV_ASN_NO /*배정번호*/
                     , '20' AS PROC_STUS /*작업진행상태*/
                     , S1.CNTR_NO
                     , S1.CNTR_SN
                     , T4.SV_HSHD_NO
                     , (SELECT COUNT(*)
                          FROM TB_SVPD_CST_SV_EXCN_IZ z1 /*고객서비스수행내역*/
                         INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ z2 /*고객서비스AS설치배정내역*/
                            ON z1.CNTR_NO = z2.CNTR_NO
                           AND z1.CNTR_SN = z2.CNTR_SN
                         INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ z3 /*고객서비스AS설치대상내역*/
                            ON z2.CST_SV_ASN_NO = z3.CST_SV_ASN_NO
                         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL z4
                            ON z1.PDCT_PD_CD = z4.PD_CD
                           AND z4.PD_EXTS_PRP_GRP_CD = 'PART'
                           AND z4.DTA_DL_YN = 'N'
                         WHERE (WK_EXCN_DT IS NULL OR WK_EXCN_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD'))
                           AND PD_PRP_VAL19 = '4'
                           AND WK_PRGS_STAT_CD IN ('00', '10', '20')
                           AND z1.SV_HSHD_NO = t4.SV_HSHD_NO)
                     + (SELECT COUNT(*)
                          FROM TB_SVPD_CST_SV_EXCN_IZ T1 /*고객서비스수행내역*/
                         INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ T2 /*고객서비스BS배정내역*/
                            ON T1.CNTR_NO = T2.CNTR_NO
                           AND T1.CNTR_SN = T2.CNTR_SN
                         INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ T3 /*고객서비스BS대상내역*/
                            ON T2.CST_SV_ASN_NO = T3.CST_SV_ASN_NO
                         INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL PDBS1
                            ON T1.PDCT_PD_CD = PDBS1.PD_CD
                           AND PDBS1.PD_EXTS_PRP_GRP_CD = 'PART'
                           AND PDBS1.DTA_DL_YN = 'N'
                         WHERE PD_PRP_VAL19 = '4'
                           AND PD_PRP_VAL20 != '11'
                           AND T3.ASN_OJ_YM || '01' > TO_CHAR(SYSDATE, 'YYYYMM') || '00'
                           AND T1.REQD_DT IS NULL
                           AND T1.SV_HSHD_NO = T4.SV_HSHD_NO) AS SV_HSHD_NO_CNT
                     , S1.SV_BIZ_HCLSF_CD
                     , S1.SV_BIZ_DCLSF_CD
                  FROM TB_SVPD_CST_SV_WK_RS_IZ S1/*고객서비스작업결과내역*/
                 INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ S2 /*고객서비스AS설치배정내역*/
                    ON S1.CST_SV_ASN_NO = S2.CST_SV_ASN_NO
                  LEFT OUTER JOIN TB_SVST_SV_WK_OSTR_IZ S3 /*서비스작업출고내역*/
                    ON S1.CST_SV_ASN_NO = S3.CST_SV_ASN_NO
                   AND S3.WK_OSTR_SN = (SELECT MAX(X.WK_OSTR_SN)
                                          FROM TB_SVST_SV_WK_OSTR_IZ X
                                         WHERE X.CNTR_NO = S1.CNTR_NO
                                           AND X.CNTR_SN = S1.CNTR_SN)
                  LEFT OUTER JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ S4 /*월별고객서비스대상내역*/
                    ON S1.CNTR_NO = S4.CNTR_NO
                   AND S1.CNTR_SN = S4.CNTR_SN
                   AND SUBSTR(S1.VST_FSH_DT, 1, 6) =  S4.MNGT_YM
                  LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ P1
                    ON P1.PRTNR_NO = S2.WK_PRTNR_NO
                   AND P1.OG_TP_CD = S2.WK_PRTNR_OG_TP_CD
                   AND P1.BASE_YM = SUBSTR(S1.CST_SV_ASN_NO,2,6)
                 INNER JOIN TB_SVPD_CST_SV_EXCN_IZ T4 /*고객서비스수행내역*/
                    ON S1.CNTR_NO = T4.CNTR_NO
                   AND S1.CNTR_SN = T4.CNTR_SN
                 WHERE 1=1
                   AND (CASE WHEN S1.SV_BIZ_HCLSF_CD = '9' THEN '1'
                             ELSE S1.SV_BIZ_HCLSF_CD
                         END) = S2.SV_BIZ_HCLSF_CD
                   AND S1.SV_BIZ_HCLSF_CD IN ('1','3','4', '9')
                   AND (S1.URGT_DV_CD !='9' OR S1.URGT_DV_CD IS NULL)
                   AND S1.DTA_DL_YN = 'N'
                )
            UNION ALL
            (/*B/S작업완료 건*/
            SELECT /*+ LEADING(S1) USE_NL(S1 S2 S4 P1) INDEX(S4 PK_SVPD_MCBY_CST_SV_OJ_IZ) */
                   'BD' GUBUN
                   , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_HCLSF_CD', S1.SV_BIZ_HCLSF_CD) AS SV_TP /*유형*/
                   , S2.CNFM_PSIC_ASN_DT || S2.CNFM_PSIC_ASN_HH AS RCP_DT /*접수(배정)일자*/
                   , TO_NUMBER(SUBSTR(S2.ASN_OJ_YM,5,2)) || '월BS' || F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_DCLSF_CD', S1.SV_BIZ_DCLSF_CD)  AS SV_BIZ_DCLSF /*접수(배정)내역*/
                   , S2.VST_CNFMDT || S2.VST_CNFM_HH AS REQ_DT /*요청약속일자*/
                   , S1.VST_FSH_DT || S1.VST_FSH_HH  AS VST_FSH_DT /*처리일자*/
                   , F_CMZ_CD_NM('TNT_WELLS', 'WK_PRGS_STAT_CD', S1.WK_PRGS_STAT_CD) AS WK_PRGS_STAT /*처리결과*/
                   , F_CMZ_CD_NM('TNT_WELLS', 'AS_CAUS_CD', S1.AS_CAUS_CD) AS AS_CAUS /*처리내역*/
                   , F_CMZ_CD_NM('TNT_WELLS', 'RTNGD_PROCS_TP_CD', S3.RTNGD_PROCS_TP_CD) AS RTNGD_PROCS_TP /*반품처리정보*/
                   , S3.OSTR_CONF_DT  AS FST_VST_FSH_DT/*폐기일자:출고확인일자*/
                   , (SELECT NVL(X.NEW_ADR_ZIP, X.OLD_ADR_ZIP)
                        FROM TB_GBCO_ADR_BAS X
                       WHERE X.ADR_ID = S4.ADR_ID) AS ZIP_NO /*우편번호*/
                   , F_CMZ_CD_NM('TNT_WELLS', 'MNGR_DV_CD', DECODE(P1.OG_TP_CD, 'W06', '2','1')) AS OG_TP /*구분(담당자)*/
                   , DECODE(P1.OG_TP_CD, 'W06', P1.OG_NM, P1.OG_CD) AS OG_NM /*소속(담당자)*/
                   , DECODE( P1.OG_CD, '71321', '', P1.PRTNR_NO) AS PRTNR_NO /*사번(담당자)*/
                   , DECODE( P1.OG_CD, '71321', '택배발송', P1.PRTNR_KNM) AS PRTNR_NM /*성명(담당자)*/
                   , (SELECT DECODE( P1.OG_CD, '71321', '1588-4113', X.CRAL_LOCARA_TNO)
                        FROM TB_OGBS_PRTNR_BAS X
                       WHERE X.OG_TP_CD = P1.OG_TP_CD
                         AND X.PRTNR_NO = P1.PRTNR_NO) AS CRAL_LOCARA_TNO /*휴대지역전화번호(담당자)*/
                   , (SELECT DECODE( P1.OG_CD, '71321', '', X.MEXNO_ENCR)
                        FROM TB_OGBS_PRTNR_BAS X
                       WHERE X.OG_TP_CD = P1.OG_TP_CD
                         AND X.PRTNR_NO = P1.PRTNR_NO)  AS MEXNO_ENCR /*휴대전화국번호암호화(담당자)*/
                   , (SELECT DECODE( P1.OG_CD, '71321', '', X.CRAL_IDV_TNO)
                        FROM TB_OGBS_PRTNR_BAS X
                       WHERE X.OG_TP_CD = P1.OG_TP_CD
                         AND X.PRTNR_NO = P1.PRTNR_NO)  AS CRAL_IDV_TNO /*휴대개별전화번호(담당자)*/
                   , (SELECT X.BLD_NM
                        FROM TB_OGBS_MM_OG_IZ X
                       WHERE X.OG_TP_CD = P1.OG_TP_CD
                         AND X.OG_CD = P1.OG_CD
                         AND X.BASE_YM = S2.ASN_OJ_YM ) AS BLD_NM /*소속빌딩(담당자)*/
                   , S1.BC_NO /*작업시바코드*/
                   , (CASE WHEN S1.IST_ENVR_PHO_PH_DOC_ID IS NOT NULL
                             OR S1.IST_KIT_PHO_PH_DOC_ID IS NOT NULL
                             OR S1.IST_CELNG_PHO_PH_DOC_ID IS NOT NULL
                           THEN 'Y'
<!--                           ELSE 'N'-->
                       END) AS IMG_YN /*사진*/
                   , NVL(S1.IST_ENVR_PHO_PH_DOC_ID, '') AS IST_ENVR_PHO_PH_DOC_ID /*설치환경사진경로*/
                   , NVL(S1.IST_KIT_PHO_PH_DOC_ID, '') AS IST_KIT_PHO_PH_DOC_ID /*설치키드사진경로*/
                   , NVL(S1.IST_CELNG_PHO_PH_DOC_ID, '') AS IST_CELNG_PHO_PH_DOC_ID /*설치천장사진경로*/
                   , S1.ASN_DT AS ASN_DT /*배정일자*/
                   , S1.CST_SV_ASN_NO /*배정번호*/
                   , S2.VST_PRGS_STAT_CD AS PROC_STUS /*작업진행상태*/
                   , S1.CNTR_NO
                   , S1.CNTR_SN
                   , T4.SV_HSHD_NO
                   , (SELECT COUNT(*)
                        FROM TB_SVPD_CST_SV_EXCN_IZ z1 /*고객서비스수행내역*/
                       INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ z2 /*고객서비스AS설치배정내역*/
                          ON z1.CNTR_NO = z2.CNTR_NO
                         AND z1.CNTR_SN = z2.CNTR_SN
                       INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ z3 /*고객서비스AS설치대상내역*/
                          ON z2.CST_SV_ASN_NO = z3.CST_SV_ASN_NO
                       INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL z4
                          ON z1.PDCT_PD_CD = z4.PD_CD
                         AND z4.PD_EXTS_PRP_GRP_CD = 'PART'
                         AND z4.DTA_DL_YN = 'N'
                       WHERE (WK_EXCN_DT IS NULL OR WK_EXCN_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD'))
                         AND PD_PRP_VAL19 = '4'
                         AND WK_PRGS_STAT_CD IN ('00', '10', '20')
                         AND z1.SV_HSHD_NO = t4.SV_HSHD_NO)
                   + (SELECT COUNT(*)
                        FROM TB_SVPD_CST_SV_EXCN_IZ T1 /*고객서비스수행내역*/
                       INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ T2 /*고객서비스BS배정내역*/
                          ON T1.CNTR_NO = T2.CNTR_NO
                         AND T1.CNTR_SN = T2.CNTR_SN
                       INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ T3 /*고객서비스BS대상내역*/
                          ON T2.CST_SV_ASN_NO = T3.CST_SV_ASN_NO
                        INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL PDBS1
                           ON T1.PDCT_PD_CD = PDBS1.PD_CD
                          AND PDBS1.PD_EXTS_PRP_GRP_CD = 'PART'
                          AND PDBS1.DTA_DL_YN = 'N'
                        WHERE PD_PRP_VAL19 = '4'
                          AND PD_PRP_VAL20 != '11'
                          AND T3.ASN_OJ_YM || '01' > TO_CHAR(SYSDATE, 'YYYYMM') || '00'
                          AND T1.REQD_DT IS NULL
                          AND T1.SV_HSHD_NO = T4.SV_HSHD_NO) AS SV_HSHD_NO_CNT
                   , S1.SV_BIZ_HCLSF_CD
                   , S1.SV_BIZ_DCLSF_CD
                FROM TB_SVPD_CST_SV_WK_RS_IZ S1/*고객서비스작업결과내역*/
               INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ S2 /*고객서비스BS배정내역*/
                  ON S1.CST_SV_ASN_NO = S2.CST_SV_ASN_NO
                LEFT OUTER JOIN TB_SVST_SV_WK_OSTR_IZ S3 /*서비스작업출고내역*/
                  ON S1.CST_SV_ASN_NO = S3.CST_SV_ASN_NO
                 AND S3.WK_OSTR_SN = (SELECT MAX(X.WK_OSTR_SN)
                                        FROM TB_SVST_SV_WK_OSTR_IZ X
                                       WHERE X.CNTR_NO = S1.CNTR_NO
                                         AND X.CNTR_SN = S1.CNTR_SN)
                LEFT OUTER JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ S4 /*월별고객서비스대상내역*/
                  ON S1.CNTR_NO = S4.CNTR_NO
                 AND S1.CNTR_SN = S4.CNTR_SN
                 AND SUBSTR(S1.VST_FSH_DT, 1, 6) =  S4.MNGT_YM
                LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ P1
                  ON P1.PRTNR_NO = S2.CNFM_PSIC_PRTNR_NO
                 AND P1.OG_TP_CD = S2.CNFM_PSIC_PRTNR_OG_TP_CD
                 AND P1.BASE_YM = S2.ASN_OJ_YM
               INNER JOIN TB_SVPD_CST_SV_EXCN_IZ T4 /*고객서비스수행내역*/
                  ON S1.CNTR_NO = T4.CNTR_NO
                 AND S1.CNTR_SN = T4.CNTR_SN
               WHERE 1=1
                 AND S1.DTA_DL_YN = 'N'
              )
          UNION ALL
          (/*A/S작업 미완료 건*/
          SELECT /*+ LEADING(S2) USE_NL(S2 S4 P1) INDEX(S4 IX_SVPD_CST_SVAS_IST_OJ_IZ_02) */
                 'AY' GUBUN
                , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_HCLSF_CD', S2.SV_BIZ_HCLSF_CD) AS SV_TP /*유형*/
                , S2.ASN_DT ||'000000' AS RCP_DT /*접수(배정)일자*/
                , (CASE WHEN S4.CNSL_DTLP_TP_CD IS NULL THEN F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_DCLSF_CD', S2.SV_BIZ_DCLSF_CD)
                        ELSE S4.CNSL_DTLP_TP_CD
                    END) AS SV_BIZ_DCLSF /*접수(배정)내역*/
                , S2.VST_DUEDT || S2.VST_EXP_HH AS REQ_DT /*요청약속일자*/
                , (CASE WHEN S2.WK_PRGS_STAT_CD IN ('71', '72', '73') THEN S2.WK_EXCN_DT || S2.WK_EXCN_HH
                        ELSE ''
                    END) AS VST_FSH_DT /*처리일자*/
                , F_CMZ_CD_NM('TNT_WELLS', 'WK_PRGS_STAT_CD', S2.WK_PRGS_STAT_CD) AS WK_PRGS_STAT /*처리결과*/
                , (CASE WHEN S2.WK_PRGS_STAT_CD IN ('71', '72', '73') THEN S2.WK_CAN_MO_CN
                        ELSE ''
                    END) AS AS_CAUS /*처리내역*/
                , F_CMZ_CD_NM('TNT_WELLS', 'RTNGD_PROCS_TP_CD', S3.RTNGD_PROCS_TP_CD) AS RTNGD_PROCS_TP /*반품처리정보*/
                , S3.OSTR_CONF_DT AS FST_VST_FSH_DT/*폐기일자:출고확인일자*/
                , (SELECT NVL(X.NEW_ADR_ZIP, X.OLD_ADR_ZIP)
                     FROM TB_GBCO_ADR_BAS X
                    WHERE X.ADR_ID = S4.ADR_ID) AS ZIP_NO /*우편번호*/
                , NVL2(P1.PRTNR_NO, F_CMZ_CD_NM('TNT_WELLS', 'MNGR_DV_CD', DECODE(P1.OG_TP_CD, 'W06', '2','1')), '') AS OG_TP /*구분(담당자)*/
                , DECODE(P1.OG_TP_CD, 'W06', P1.OG_NM, P1.OG_CD) AS OG_NM /*소속(담당자)*/
                , P1.PRTNR_NO AS PRTNR_NO /*사번(담당자)*/
                , P1.PRTNR_KNM  AS PRTNR_NM /*성명(담당자)*/
                , (SELECT X.CRAL_LOCARA_TNO
                     FROM TB_OGBS_PRTNR_BAS X
                    WHERE X.OG_TP_CD = P1.OG_TP_CD
                      AND X.PRTNR_NO = P1.PRTNR_NO) AS CRAL_LOCARA_TNO /*휴대지역전화번호(담당자)*/
                , (SELECT X.MEXNO_ENCR
                     FROM TB_OGBS_PRTNR_BAS X
                    WHERE X.OG_TP_CD = P1.OG_TP_CD
                      AND X.PRTNR_NO = P1.PRTNR_NO)  AS MEXNO_ENCR /*휴대전화국번호암호화(담당자)*/
                , (SELECT X.CRAL_IDV_TNO
                     FROM TB_OGBS_PRTNR_BAS X
                    WHERE X.OG_TP_CD = P1.OG_TP_CD
                      AND X.PRTNR_NO = P1.PRTNR_NO)  AS CRAL_IDV_TNO /*휴대개별전화번호(담당자)*/
                , (SELECT X.BLD_NM
                     FROM TB_OGBS_MM_OG_IZ X
                    WHERE X.OG_ID = P1.OG_ID
                      AND X.BASE_YM = SUBSTR(S2.CST_SV_ASN_NO,2,6)) AS BLD_NM /*소속빌딩(담당자)*/
                , '' AS BC_NO /*작업시바코드*/
                , '' AS IMG_YN /*사진*/
                , '' AS IST_ENVR_PHO_PH_DOC_ID /*설치환경사진경로*/
                , '' AS IST_KIT_PHO_PH_DOC_ID /*설치키드사진경로*/
                , '' AS IST_CELNG_PHO_PH_DOC_ID /*설치천장사진경로*/
                , '' AS ASN_DT /*배정일자*/
                , S2.CST_SV_ASN_NO /*배정번호*/
                , S2.WK_PRGS_STAT_CD AS PROC_STUS /*작업진행상태*/
                , S2.CNTR_NO
                , S2.CNTR_SN
                , T4.SV_HSHD_NO
                , (SELECT COUNT(*)
                     FROM TB_SVPD_CST_SV_EXCN_IZ z1 /*고객서비스수행내역*/
                    INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ z2 /*고객서비스AS설치배정내역*/
                       ON z1.CNTR_NO = z2.CNTR_NO
                      AND z1.CNTR_SN = z2.CNTR_SN
                    INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ z3 /*고객서비스AS설치대상내역*/
                       ON z2.CST_SV_ASN_NO = z3.CST_SV_ASN_NO
                    INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL z4
                       ON z1.PDCT_PD_CD = z4.PD_CD
                      AND z4.PD_EXTS_PRP_GRP_CD = 'PART'
                      AND z4.DTA_DL_YN = 'N'
                    WHERE (WK_EXCN_DT IS NULL OR WK_EXCN_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD'))
                      AND PD_PRP_VAL19 = '4'
                      AND WK_PRGS_STAT_CD IN ('00', '10', '20')
                      AND z1.SV_HSHD_NO = t4.SV_HSHD_NO)
                + (SELECT COUNT(*)
                     FROM TB_SVPD_CST_SV_EXCN_IZ T1 /*고객서비스수행내역*/
                    INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ T2 /*고객서비스BS배정내역*/
                       ON T1.CNTR_NO = T2.CNTR_NO
                      AND T1.CNTR_SN = T2.CNTR_SN
                    INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ T3 /*고객서비스BS대상내역*/
                       ON T2.CST_SV_ASN_NO = T3.CST_SV_ASN_NO
                    INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL PDBS1
                       ON T1.PDCT_PD_CD = PDBS1.PD_CD
                      AND PDBS1.PD_EXTS_PRP_GRP_CD = 'PART'
                      AND PDBS1.DTA_DL_YN = 'N'
                    WHERE PD_PRP_VAL19 = '4'
                      AND PD_PRP_VAL20 != '11'
                      AND T3.ASN_OJ_YM || '01' > TO_CHAR(SYSDATE, 'YYYYMM') || '00'
                      AND T1.REQD_DT IS NULL
                      AND T1.SV_HSHD_NO = T4.SV_HSHD_NO) AS SV_HSHD_NO_CNT
                , S2.SV_BIZ_HCLSF_CD
                , S2.SV_BIZ_DCLSF_CD
             FROM TB_SVPD_CST_SVAS_IST_ASN_IZ S2 /*고객서비스AS배정내역*/
             LEFT OUTER JOIN TB_SVST_SV_WK_OSTR_IZ S3 /*서비스작업출고내역*/
               ON S2.CST_SV_ASN_NO = S3.CST_SV_ASN_NO
              AND S3.WK_OSTR_SN = (SELECT MAX(X.WK_OSTR_SN)
                                     FROM TB_SVST_SV_WK_OSTR_IZ X
                                    WHERE X.CNTR_NO = S2.CNTR_NO
                                      AND X.CNTR_SN = S2.CNTR_SN)
            INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ S4 /*고객서비스AS설치대상내역*/
               ON S2.CST_SV_ASN_NO = S4.CST_SV_ASN_NO
             LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ P1
               ON P1.PRTNR_NO = DECODE(S2.WK_PRGS_STAT_CD, '20', S2.WK_PRTNR_NO, S2.ICHR_PRTNR_NO)
              AND P1.OG_TP_CD = DECODE(S2.WK_PRGS_STAT_CD, '20', S2.WK_PRTNR_OG_TP_CD, S2.ICHR_OG_TP_CD)
              AND P1.BASE_YM = SUBSTR(S2.CST_SV_ASN_NO,2,6)
            INNER JOIN TB_SVPD_CST_SV_EXCN_IZ T4 /*고객서비스수행내역*/
               ON S2.CNTR_NO = T4.CNTR_NO
              AND S2.CNTR_SN = T4.CNTR_SN
            WHERE 1=1
              AND S2.WK_PRGS_STAT_CD != '20'
              AND S2.DTA_DL_YN = 'N'
             )
             UNION ALL
             (/*B/S작업 미완료 건*/
              SELECT /*+ LEADING(S2) USE_NL(S2 S4 P1) INDEX(S4 PK_SVPD_MCBY_CST_SV_OJ_IZ) */
                    'BY' GUBUN
                   , F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_HCLSF_CD',SUBSTR(S2.CST_SV_ASN_NO, 0,1)) AS SV_TP /*유형*/
                   , S2.CNFM_PSIC_ASN_DT || S2.CNFM_PSIC_ASN_HH AS RCP_DT /*접수(배정)일자*/
                   , TO_NUMBER(SUBSTR(S2.ASN_OJ_YM,5,2)) || '월BS' || F_CMZ_CD_NM('TNT_WELLS', 'SV_BIZ_DCLSF_CD', S2.SV_BIZ_DCLSF_CD)  AS SV_BIZ_DCLSF /*접수(배정)내역*/
                   , NVL2(S2.VST_CNFMDT, S2.VST_CNFMDT || S2.VST_CNFM_HH, '') AS REQ_DT /*요청약속일자*/
                   , (CASE WHEN S2.VST_PRGS_STAT_CD NOT IN ('00','01') THEN S2.ARV_DT || S2.ARV_HH ELSE '' END) AS VST_FSH_DT /*처리일자*/
                   , F_CMZ_CD_NM('TNT_WELLS', 'WK_PRGS_STAT_CD', S2.VST_PRGS_STAT_CD) AS WK_PRGS_STAT /*처리결과*/
                   , '' AS AS_CAUS /*처리내역*/
                   , F_CMZ_CD_NM('TNT_WELLS', 'RTNGD_PROCS_TP_CD', S3.RTNGD_PROCS_TP_CD) AS RTNGD_PROCS_TP /*반품처리정보*/
                   , S3.OSTR_CONF_DT  AS FST_VST_FSH_DT/*폐기일자:출고확인일자*/
                   , (SELECT NVL(X.NEW_ADR_ZIP, X.OLD_ADR_ZIP)
                        FROM TB_GBCO_ADR_BAS X
                       WHERE X.ADR_ID = S4.ADR_ID) AS ZIP_NO /*우편번호*/
                   , NVL2(P1.PRTNR_NO, F_CMZ_CD_NM('TNT_WELLS', 'MNGR_DV_CD', DECODE(P1.OG_TP_CD, 'W06', '2','1')), '') AS OG_TP /*구분(담당자)*/
                   , DECODE(P1.OG_TP_CD, 'W06', P1.OG_NM, P1.OG_CD) AS OG_NM /*소속(담당자)*/
                   , DECODE(P1.OG_CD, '71321', '', P1.PRTNR_NO) AS PRTNR_NO /*사번(담당자)*/
                   , DECODE(P1.OG_CD, '71321', '택배발송', P1.PRTNR_KNM) AS PRTNR_NM /*성명(담당자)*/
                   , (SELECT DECODE( P1.OG_CD, '71321', '1588-4113', X.CRAL_LOCARA_TNO)
                        FROM TB_OGBS_PRTNR_BAS X
                       WHERE X.OG_TP_CD = P1.OG_TP_CD
                         AND X.PRTNR_NO = P1.PRTNR_NO) AS CRAL_LOCARA_TNO /*휴대지역전화번호(담당자)*/
                   , (SELECT DECODE( P1.OG_CD, '71321', '', X.MEXNO_ENCR)
                        FROM TB_OGBS_PRTNR_BAS X
                       WHERE X.OG_TP_CD = P1.OG_TP_CD
                         AND X.PRTNR_NO = P1.PRTNR_NO)  AS MEXNO_ENCR /*휴대전화국번호암호화(담당자)*/
                   , (SELECT DECODE( P1.OG_CD, '71321', '', X.CRAL_IDV_TNO)
                        FROM TB_OGBS_PRTNR_BAS X
                       WHERE X.OG_TP_CD = P1.OG_TP_CD
                         AND X.PRTNR_NO = P1.PRTNR_NO)  AS CRAL_IDV_TNO /*휴대개별전화번호(담당자)*/
                   , (SELECT X.BLD_NM
                        FROM TB_OGBS_MM_OG_IZ X
                       WHERE X.OG_ID = P1.OG_ID
                         AND X.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')) AS BLD_NM /*소속빌딩(담당자)*/
                   , '' AS BC_NO /*작업시바코드*/
                   , '' AS IMG_YN /*사진*/
                   , '' AS IST_ENVR_PHO_PH_DOC_ID /*설치환경사진경로*/
                   , '' AS IST_KIT_PHO_PH_DOC_ID /*설치키드사진경로*/
                   , '' AS IST_CELNG_PHO_PH_DOC_ID /*설치천장사진경로*/
                   , '' AS ASN_DT /*배정일자*/
                   , S2.CST_SV_ASN_NO /*배정번호*/
                   , S2.VST_PRGS_STAT_CD AS PROC_STUS /*작업진행상태*/
                   , S2.CNTR_NO
                   , S2.CNTR_SN
                   , T4.SV_HSHD_NO
                   , (SELECT COUNT(*)
                        FROM TB_SVPD_CST_SV_EXCN_IZ z1 /*고객서비스수행내역*/
                       INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ z2 /*고객서비스AS설치배정내역*/
                          ON z1.CNTR_NO = z2.CNTR_NO
                         AND z1.CNTR_SN = z2.CNTR_SN
                       INNER JOIN TB_SVPD_CST_SVAS_IST_OJ_IZ z3 /*고객서비스AS설치대상내역*/
                          ON z2.CST_SV_ASN_NO = z3.CST_SV_ASN_NO
                       INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL z4
                          ON z1.PDCT_PD_CD = z4.PD_CD
                         AND z4.PD_EXTS_PRP_GRP_CD = 'PART'
                         AND z4.DTA_DL_YN = 'N'
                       WHERE (WK_EXCN_DT IS NULL OR WK_EXCN_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD'))
                         AND PD_PRP_VAL19 = '4'
                         AND WK_PRGS_STAT_CD IN ('00', '10', '20')
                         AND z1.SV_HSHD_NO = t4.SV_HSHD_NO)
                   + (SELECT COUNT(*)
                        FROM TB_SVPD_CST_SV_EXCN_IZ T1 /*고객서비스수행내역*/
                       INNER JOIN TB_SVPD_CST_SV_BFSVC_ASN_IZ T2 /*고객서비스BS배정내역*/
                          ON T1.CNTR_NO = T2.CNTR_NO
                         AND T1.CNTR_SN = T2.CNTR_SN
                       INNER JOIN TB_SVPD_CST_SV_BFSVC_OJ_IZ T3 /*고객서비스BS대상내역*/
                          ON T2.CST_SV_ASN_NO = T3.CST_SV_ASN_NO
                       INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL PDBS1
                          ON T1.PDCT_PD_CD = PDBS1.PD_CD
                         AND PDBS1.PD_EXTS_PRP_GRP_CD = 'PART'
                         AND PDBS1.DTA_DL_YN = 'N'
                       WHERE PD_PRP_VAL19 = '4'
                         AND PD_PRP_VAL20 != '11'
                         AND T3.ASN_OJ_YM || '01' > TO_CHAR(SYSDATE, 'YYYYMM') || '00'
                         AND T1.REQD_DT IS NULL
                         AND T1.SV_HSHD_NO = T4.SV_HSHD_NO) AS SV_HSHD_NO_CNT
                   , SUBSTR(S2.CST_SV_ASN_NO, 0,1) AS SV_BIZ_HCLSF_CD
                   , S2.SV_BIZ_DCLSF_CD
                FROM TB_SVPD_CST_SV_BFSVC_ASN_IZ S2 /*고객서비스BS배정내역*/
                LEFT OUTER JOIN TB_SVST_SV_WK_OSTR_IZ S3 /*서비스작업출고내역*/
                  ON S2.CST_SV_ASN_NO = S3.CST_SV_ASN_NO
                 AND S3.WK_OSTR_SN = (SELECT MAX(X.WK_OSTR_SN)
                                        FROM TB_SVST_SV_WK_OSTR_IZ X
                                       WHERE X.CNTR_NO = S2.CNTR_NO
                                         AND X.CNTR_SN = S2.CNTR_SN)
                LEFT OUTER JOIN TB_SVPD_MCBY_CST_SV_OJ_IZ S4 /*월별고객서비스대상내역*/
                  ON S2.CNTR_NO = S4.CNTR_NO
                 AND S2.CNTR_SN = S4.CNTR_SN
                 AND SUBSTR(S2.ARV_DT, 1, 6) =  S4.MNGT_YM
                LEFT OUTER JOIN TB_OGBS_MM_PRTNR_IZ P1
                  ON P1.PRTNR_NO = S2.CNFM_PSIC_PRTNR_NO
                 AND P1.OG_TP_CD = S2.CNFM_PSIC_PRTNR_OG_TP_CD
                 AND P1.BASE_YM = TO_CHAR(SYSDATE,'YYYYMM')
               INNER JOIN TB_SVPD_CST_SV_EXCN_IZ T4 /*고객서비스수행내역*/
                  ON S2.CNTR_NO = T4.CNTR_NO
                 AND S2.CNTR_SN = T4.CNTR_SN
                WHERE 1=1
                  AND S2.VST_PRGS_STAT_CD != '20'
                  AND S2.DTA_DL_YN = 'N'
               )
         )
        WHERE 1=1
          AND CNTR_NO = #{cntrNo}
          AND CNTR_SN = #{cntrSn}
        ORDER BY RCP_DT DESC, NVL(VST_FSH_DT,NVL(RCP_DT, ASN_DT)) DESC, CST_SV_ASN_NO DESC
    </select>
    <select id="selectIndividualFarm" resultType="com.kyowon.sms.wells.web.service.visit.dto.WsnbIndividualServicePsDto$SearchFarmRes">
        WITH T AS (
           SELECT /*+ MATERIALIZE */ FN_SVPD_WELSF_DVC_CD_01( #{cntrNo}, #{cntrSn}) AS D_CNTR_NO
             FROM DUAL
        )
        SELECT GUBUN /*구분*/
             , CNTR_DTL /*계약상세번호*/
             , CST_NM /*고객명*/
             , PD_NM /*상품명*/
             , SDING_CNTR_DTL /*상대고객*/
             , ADR_ZIP /*우편번호*/
             , LOCARA_TNO /*전화번호 - 지역전화번호*/
             , EXNO_ENCR/*전화번호 - 전화국번호암호화*/
             , IDV_TNO/*전화번호 - 개별전화번호*/
             , CRAL_LOCARA_TNO /*휴대전화번호 - 휴대지역전화번호*/
             , MEXNO_ENCR /*휴대전화번호 - 휴대전화국번호암호화*/
             , CRAL_IDV_TNO /*휴대전화번호 - 휴대개별전화번호*/
          FROM (
               SELECT DISTINCT GUBUN /*구분*/
                    , CNTR_DTL /*계약상세번호*/
                    , CST_NM /*고객명*/
                    , PD_NM /*상품명*/
                    , SDING_CNTR_DTL /*상대고객*/
                    , ADR_ZIP /*우편번호*/
                    , LOCARA_TNO /*전화번호 - 지역전화번호*/
                    , EXNO_ENCR/*전화번호 - 전화국번호암호화*/
                    , IDV_TNO/*전화번호 - 개별전화번호*/
                    , CRAL_LOCARA_TNO /*휴대전화번호 - 휴대지역전화번호*/
                    , MEXNO_ENCR /*휴대전화번호 - 휴대전화국번호암호화*/
                    , CRAL_IDV_TNO /*휴대전화번호 - 휴대개별전화번호*/
                 FROM (
        		       /*웰스팜*/
        		       SELECT (CASE WHEN P1.PD_NM LIKE '%새싹%' THEN '새싹재배기' ELSE '웰스팜' END) AS GUBUN /*구분*/
        		            , SV1.CNTR_NO || '-' || SV1.CNTR_SN AS CNTR_DTL /*계약상세번호*/
        		            , SA2.RCGVP_KNM AS CST_NM /*고객명*/
        		            , P1.PD_NM /*상품명*/
        		            , SUBSTR(FN_SVPD_WELSF_CD_01(SV1.CNTR_NO, SV1.CNTR_SN),1,12) || '-'
        		              || SUBSTR(FN_SVPD_WELSF_CD_01(SV1.CNTR_NO, SV1.CNTR_SN),13,14) AS SDING_CNTR_DTL /*상대고객*/
        		            , NVL(ADR.NEW_ADR_ZIP, ADR.OLD_ADR_ZIP) AS ADR_ZIP /*우편번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.LOCARA_TNO, '') AS LOCARA_TNO /*전화번호 - 지역전화번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.EXNO_ENCR, '') AS EXNO_ENCR/*전화번호 - 전화국번호암호화*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.IDV_TNO, '') AS IDV_TNO/*전화번호 - 개별전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_LOCARA_TNO, '') AS CRAL_LOCARA_TNO /*휴대전화번호 - 휴대지역전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.MEXNO_ENCR, '') AS MEXNO_ENCR /*휴대전화번호 - 휴대전화국번호암호화*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_IDV_TNO, '') AS CRAL_IDV_TNO /*휴대전화번호 - 휴대개별전화번호*/
        		         FROM TB_SVPD_CST_SV_EXCN_IZ SV1 /*고객서비스수행내역*/
        		        INNER JOIN TB_PDBS_PD_BAS P1 /*상품기본*/
        		           ON SV1.PDCT_PD_CD = P1.PD_CD
        		        INNER JOIN TB_SSCT_CNTR_REL SC1 /*계약관계*/
        		           ON SV1.CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SV1.CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		        INNER JOIN TB_SSCT_CNTR_ADR_REL SA1 /*계약주소관계 - 계약주소*/
        		           ON SA1.DTL_CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SA1.DTL_CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		          AND SA1.ADRPC_TP_CD IN ('2', '3')
        		          AND SA1.DTA_DL_YN = 'N'
        		          AND SA1.VL_STRT_DTM = SC1.VL_STRT_DTM
        		          AND SA1.VL_END_DTM = SC1.VL_END_DTM
        		        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS SA2 /*계약주소지기본*/
        		           ON SA2.CNTR_ADRPC_ID = SA1.CNTR_ADRPC_ID
        		        INNER JOIN TB_GBCO_ADR_BAS ADR /*주소기본*/
        		           ON ADR.ADR_ID = SA2.ADR_ID
        		        INNER JOIN T
        		           ON SV1.CNTR_NO = SUBSTR(T.D_CNTR_NO, 1, 12)
        		          AND SV1.CNTR_SN = SUBSTR(T.D_CNTR_NO, 13, 1)
        		        UNION ALL
        		       /*모종*/
        		       SELECT (CASE WHEN P1.PD_NM LIKE '%새싹%' THEN '새싹씨앗' ELSE '웰스팜모종' END) AS GUBUN /*구분*/
        		            , SV2.CNTR_NO || '-' || SV2.CNTR_SN AS CNTR_DTL /*계약상세번호*/
        		            , SA2.RCGVP_KNM AS CST_NM /*고객명*/
        		            , P1.PD_NM /*상품명*/
        		            , SUBSTR(FN_SVPD_WELSF_CD_01(SV2.CNTR_NO, SV2.CNTR_SN),1,12) || '-'
        		              || SUBSTR(FN_SVPD_WELSF_CD_01(SV2.CNTR_NO, SV2.CNTR_SN),13,14) AS SDING_CNTR_DTL /*상대고객*/
        		            , NVL(ADR.NEW_ADR_ZIP, ADR.OLD_ADR_ZIP) AS ADR_ZIP /*우편번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.LOCARA_TNO, '') AS LOCARA_TNO /*전화번호 - 지역전화번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.EXNO_ENCR, '') AS EXNO_ENCR/*전화번호 - 전화국번호암호화*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.IDV_TNO, '') AS IDV_TNO/*전화번호 - 개별전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_LOCARA_TNO, '') AS CRAL_LOCARA_TNO /*휴대전화번호 - 휴대지역전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.MEXNO_ENCR, '') AS MEXNO_ENCR /*휴대전화번호 - 휴대전화국번호암호화*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_IDV_TNO, '') AS CRAL_IDV_TNO /*휴대전화번호 - 휴대개별전화번호*/
        		         FROM TB_SVPD_CST_SV_EXCN_IZ SV1 /*고객서비스수행내역*/
        		        INNER JOIN TB_SVPD_CST_SV_EXCN_IZ SV2 /*고객서비스수행내역*/
        		           ON SV2.CNTR_NO = SUBSTR(FN_SVPD_WELSF_CD_01(SV1.CNTR_NO, SV1.CNTR_SN),1,12)
        		          AND SV2.CNTR_SN = SUBSTR(FN_SVPD_WELSF_CD_01(SV1.CNTR_NO, SV1.CNTR_SN),13,14)
        		        INNER JOIN TB_PDBS_PD_BAS P1 /*상품기본*/
        		           ON SV2.PDCT_PD_CD = P1.PD_CD
        		        INNER JOIN TB_SSCT_CNTR_REL SC1 /*계약관계*/
        		           ON SV2.CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SV2.CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		        INNER JOIN TB_SSCT_CNTR_ADR_REL SA1 /*계약주소관계 - 계약주소*/
        		           ON SA1.DTL_CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SA1.DTL_CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		          AND SA1.ADRPC_TP_CD IN ('2', '3')
        		          AND SA1.DTA_DL_YN = 'N'
        		          AND SA1.VL_STRT_DTM = SC1.VL_STRT_DTM
        		          AND SA1.VL_END_DTM = SC1.VL_END_DTM
        		        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS SA2 /*계약주소지기본*/
        		           ON SA2.CNTR_ADRPC_ID = SA1.CNTR_ADRPC_ID
        		        INNER JOIN TB_GBCO_ADR_BAS ADR /*주소기본*/
        		           ON ADR.ADR_ID = SA2.ADR_ID
        		        INNER JOIN T
        		           ON SV1.CNTR_NO = SUBSTR(T.D_CNTR_NO, 1, 12)
        		          AND SV1.CNTR_SN = SUBSTR(T.D_CNTR_NO, 13, 1)
        		        UNION ALL
        		       /*재배기 1+1*/
        		       SELECT '1+1 디바이스' AS GUBUN /*구분*/
        		            , SV2.CNTR_NO || '-' || SV2.CNTR_SN AS CNTR_DTL /*계약상세번호*/
        		            , SA2.RCGVP_KNM AS CST_NM /*고객명*/
        		            , P1.PD_NM /*상품명*/
        		            , SUBSTR(FN_SVPD_WELSF_CD_01(SV2.CNTR_NO, SV2.CNTR_SN),1,12) || '-'
        		              || SUBSTR(FN_SVPD_WELSF_CD_01(SV2.CNTR_NO, SV2.CNTR_SN),13,14) AS SDING_CNTR_DTL /*상대고객*/
        		            , NVL(ADR.NEW_ADR_ZIP, ADR.OLD_ADR_ZIP) AS ADR_ZIP /*우편번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.LOCARA_TNO, '') AS LOCARA_TNO /*전화번호 - 지역전화번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.EXNO_ENCR, '') AS EXNO_ENCR/*전화번호 - 전화국번호암호화*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.IDV_TNO, '') AS IDV_TNO/*전화번호 - 개별전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_LOCARA_TNO, '') AS CRAL_LOCARA_TNO /*휴대전화번호 - 휴대지역전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.MEXNO_ENCR, '') AS MEXNO_ENCR /*휴대전화번호 - 휴대전화국번호암호화*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_IDV_TNO, '') AS CRAL_IDV_TNO /*휴대전화번호 - 휴대개별전화번호*/
        		         FROM TB_SVPD_CST_SV_EXCN_IZ SV1 /*고객서비스수행내역*/
        		        INNER JOIN TB_SSCT_CNTR_REL SC2 /*계약관계*/
        		           ON SC2.OJ_DTL_CNTR_NO = SV1.CNTR_NO
        		          AND SC2.OJ_DTL_CNTR_SN = SV1.CNTR_SN
        		        INNER JOIN TB_SVPD_CST_SV_EXCN_IZ SV2 /*고객서비스수행내역*/
        		           ON SV2.CNTR_NO = SC2.BASE_DTL_CNTR_NO
        		          AND SV2.CNTR_SN = SC2.BASE_DTL_CNTR_SN
        		        INNER JOIN TB_PDBS_PD_BAS P1 /*상품기본*/
        		           ON SV2.PDCT_PD_CD = P1.PD_CD
        		        INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL P2 /*상품각사속성상세*/
        		           ON P1.PD_CD = P2.PD_CD
        		          AND P2.DTA_DL_YN = 'N'
        		          AND P2.PD_EXTS_PRP_GRP_CD = 'PART'
        		        INNER JOIN TB_SSCT_CNTR_REL SC1 /*계약관계*/
        		           ON SV2.CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SV2.CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		        INNER JOIN TB_SSCT_CNTR_ADR_REL SA1 /*계약주소관계 - 계약주소*/
        		           ON SA1.DTL_CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SA1.DTL_CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		          AND SA1.ADRPC_TP_CD IN ('2', '3')
        		          AND SA1.DTA_DL_YN = 'N'
        		          AND SA1.VL_STRT_DTM = SC1.VL_STRT_DTM
        		          AND SA1.VL_END_DTM = SC1.VL_END_DTM
        		        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS SA2 /*계약주소지기본*/
        		           ON SA2.CNTR_ADRPC_ID = SA1.CNTR_ADRPC_ID
        		        INNER JOIN TB_GBCO_ADR_BAS ADR /*주소기본*/
        		           ON ADR.ADR_ID = SA2.ADR_ID
        		        INNER JOIN T
        		           ON SV1.CNTR_NO = SUBSTR(T.D_CNTR_NO, 1, 12)
        		          AND SV1.CNTR_SN = SUBSTR(T.D_CNTR_NO, 13, 1)
        		        WHERE P2.PD_PRP_VAL19 = '4'
        		          AND P1.PD_NM LIKE '%새싹재배기%'
        		        UNION ALL
        		       /*재배기 1+1 씨앗*/
        		       SELECT '1+1 씨앗' AS GUBUN /*구분*/
        		            , SV3.CNTR_NO || '-' || SV3.CNTR_SN AS CNTR_DTL /*계약상세번호*/
        		            , SA2.RCGVP_KNM AS CST_NM /*고객명*/
        		            , P1.PD_NM /*상품명*/
        		            , SUBSTR(FN_SVPD_WELSF_CD_01(SV3.CNTR_NO, SV3.CNTR_SN),1,12) || '-'
        		              || SUBSTR(FN_SVPD_WELSF_CD_01(SV3.CNTR_NO, SV3.CNTR_SN),13,14) AS SDING_CNTR_DTL /*상대고객*/
        		            , NVL(ADR.NEW_ADR_ZIP, ADR.OLD_ADR_ZIP) AS ADR_ZIP /*우편번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.LOCARA_TNO, '') AS LOCARA_TNO /*전화번호 - 지역전화번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.EXNO_ENCR, '') AS EXNO_ENCR/*전화번호 - 전화국번호암호화*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.IDV_TNO, '') AS IDV_TNO/*전화번호 - 개별전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_LOCARA_TNO, '') AS CRAL_LOCARA_TNO /*휴대전화번호 - 휴대지역전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.MEXNO_ENCR, '') AS MEXNO_ENCR /*휴대전화번호 - 휴대전화국번호암호화*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_IDV_TNO, '') AS CRAL_IDV_TNO /*휴대전화번호 - 휴대개별전화번호*/
        		         FROM TB_SVPD_CST_SV_EXCN_IZ SV1 /*고객서비스수행내역*/
        		        INNER JOIN TB_SSCT_CNTR_REL SC2 /*계약관계*/
        		           ON SC2.OJ_DTL_CNTR_NO = SV1.CNTR_NO
        		          AND SC2.OJ_DTL_CNTR_SN = SV1.CNTR_SN
        		        INNER JOIN TB_SVPD_CST_SV_EXCN_IZ SV2 /*고객서비스수행내역*/
        		           ON SV2.CNTR_NO = SC2.BASE_DTL_CNTR_NO
        		          AND SV2.CNTR_SN = SC2.BASE_DTL_CNTR_SN
        		        INNER JOIN TB_PDBS_PD_BAS P1 /*상품기본*/
        		           ON SV2.PDCT_PD_CD = P1.PD_CD
        		        INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL P2 /*상품각사속성상세*/
        		           ON P1.PD_CD = P2.PD_CD
        		          AND P2.DTA_DL_YN = 'N'
        		          AND P2.PD_EXTS_PRP_GRP_CD = 'PART'
        		        INNER JOIN TB_SSCT_CNTR_REL SC1 /*계약관계*/
        		           ON SV2.CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SV2.CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		        INNER JOIN TB_SSCT_CNTR_ADR_REL SA1 /*계약주소관계 - 계약주소*/
        		           ON SA1.DTL_CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SA1.DTL_CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		          AND SA1.ADRPC_TP_CD IN ('2', '3')
        		          AND SA1.DTA_DL_YN = 'N'
        		          AND SA1.VL_STRT_DTM = SC1.VL_STRT_DTM
        		          AND SA1.VL_END_DTM = SC1.VL_END_DTM
        		        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS SA2 /*계약주소지기본*/
        		           ON SA2.CNTR_ADRPC_ID = SA1.CNTR_ADRPC_ID
        		        INNER JOIN TB_GBCO_ADR_BAS ADR /*주소기본*/
        		           ON ADR.ADR_ID = SA2.ADR_ID
        		        INNER JOIN TB_SVPD_CST_SV_EXCN_IZ SV3 /*고객서비스수행내역*/
        		           ON SV3.CNTR_NO = SUBSTR(FN_SVPD_WELSF_CD_01(SV2.CNTR_NO, SV2.CNTR_SN),1,12)
        		          AND SV3.CNTR_SN = SUBSTR(FN_SVPD_WELSF_CD_01(SV2.CNTR_NO, SV2.CNTR_SN),13,14)
        		        INNER JOIN T
        		           ON SV1.CNTR_NO = SUBSTR(T.D_CNTR_NO, 1, 12)
        		          AND SV1.CNTR_SN = SUBSTR(T.D_CNTR_NO, 13, 1)
        		        WHERE P2.PD_PRP_VAL19 = '4'
        		          AND P1.PD_NM LIKE '%새싹재배기%'
        		        UNION ALL
        		       /*재배기 패키지상품*/
        		       SELECT '패키지디바이스' AS GUBUN /*구분*/
        		            , SV1.CNTR_NO || '-' || SV1.CNTR_SN AS CNTR_DTL /*계약상세번호*/
        		            , SA2.RCGVP_KNM AS CST_NM /*고객명*/
        		            , P1.PD_NM /*상품명*/
        		            , SUBSTR(FN_SVPD_WELSF_CD_01(SV1.CNTR_NO, SV1.CNTR_SN),1,12) || '-'
        		              || SUBSTR(FN_SVPD_WELSF_CD_01(SV1.CNTR_NO, SV1.CNTR_SN),13,14) AS SDING_CNTR_DTL /*상대고객*/
        		            , NVL(ADR.NEW_ADR_ZIP, ADR.OLD_ADR_ZIP) AS ADR_ZIP /*우편번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.LOCARA_TNO, '') AS LOCARA_TNO /*전화번호 - 지역전화번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.EXNO_ENCR, '') AS EXNO_ENCR/*전화번호 - 전화국번호암호화*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.IDV_TNO, '') AS IDV_TNO/*전화번호 - 개별전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_LOCARA_TNO, '') AS CRAL_LOCARA_TNO /*휴대전화번호 - 휴대지역전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.MEXNO_ENCR, '') AS MEXNO_ENCR /*휴대전화번호 - 휴대전화국번호암호화*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_IDV_TNO, '') AS CRAL_IDV_TNO /*휴대전화번호 - 휴대개별전화번호*/
        		         FROM TB_SVPD_CST_SV_EXCN_IZ SV1 /*고객서비스수행내역*/
        		        INNER JOIN TB_PDBS_PD_BAS P1 /*상품기본*/
        		           ON SV1.PDCT_PD_CD = P1.PD_CD
        		        INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL P2 /*상품각사속성상세*/
        		           ON P1.PD_CD = P2.PD_CD
        		          AND P2.DTA_DL_YN = 'N'
        		          AND P2.PD_EXTS_PRP_GRP_CD = 'PART'
        		        INNER JOIN TB_SSCT_CNTR_REL SC1 /*계약관계*/
        		           ON SV1.CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SV1.CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		        INNER JOIN TB_SSCT_CNTR_ADR_REL SA1 /*계약주소관계 - 계약주소*/
        		           ON SA1.DTL_CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SA1.DTL_CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		          AND SA1.ADRPC_TP_CD IN ('2', '3')
        		          AND SA1.DTA_DL_YN = 'N'
        		          AND SA1.VL_STRT_DTM = SC1.VL_STRT_DTM
        		          AND SA1.VL_END_DTM = SC1.VL_END_DTM
        		        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS SA2 /*계약주소지기본*/
        		           ON SA2.CNTR_ADRPC_ID = SA1.CNTR_ADRPC_ID
        		        INNER JOIN TB_GBCO_ADR_BAS ADR /*주소기본*/
        		           ON ADR.ADR_ID = SA2.ADR_ID
        		        INNER JOIN TB_SSCT_CNTR_REL SC2 /*계약관계*/
        		           ON SC2.BASE_DTL_CNTR_NO = SV1.CNTR_NO
        		          AND SC2.BASE_DTL_CNTR_SN = SV1.CNTR_SN
        		        INNER JOIN T
        		           ON SC2.BASE_DTL_CNTR_NO = SUBSTR(T.D_CNTR_NO, 1, 12)
        		          AND SC2.BASE_DTL_CNTR_NO = SUBSTR(T.D_CNTR_NO, 13, 1)
        		        WHERE P2.PD_PRP_VAL19 = '4'
        		          AND P1.PD_NM LIKE '%새싹재배기%'
        		          AND SC2.CNTR_REL_DTL_CD = '22W'
        		        UNION ALL
        		       /*재배기 패키지상품 씨앗패키지*/
        		       SELECT '패키지씨앗' AS GUBUN /*구분*/
        		            , SV2.CNTR_NO || '-' || SV2.CNTR_SN AS CNTR_DTL /*계약상세번호*/
        		            , SA2.RCGVP_KNM AS CST_NM /*고객명*/
        		            , P1.PD_NM /*상품명*/
        		            , SUBSTR(FN_SVPD_WELSF_CD_01(SV2.CNTR_NO, SV2.CNTR_SN),1,12) || '-'
        		              || SUBSTR(FN_SVPD_WELSF_CD_01(SV2.CNTR_NO, SV2.CNTR_SN),13,14) AS SDING_CNTR_DTL /*상대고객*/
        		            , NVL(ADR.NEW_ADR_ZIP, ADR.OLD_ADR_ZIP) AS ADR_ZIP /*우편번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.LOCARA_TNO, '') AS LOCARA_TNO /*전화번호 - 지역전화번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.EXNO_ENCR, '') AS EXNO_ENCR/*전화번호 - 전화국번호암호화*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.IDV_TNO, '') AS IDV_TNO/*전화번호 - 개별전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_LOCARA_TNO, '') AS CRAL_LOCARA_TNO /*휴대전화번호 - 휴대지역전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.MEXNO_ENCR, '') AS MEXNO_ENCR /*휴대전화번호 - 휴대전화국번호암호화*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_IDV_TNO, '') AS CRAL_IDV_TNO /*휴대전화번호 - 휴대개별전화번호*/
        		         FROM TB_SVPD_CST_SV_EXCN_IZ SV1 /*고객서비스수행내역*/
        		        INNER JOIN TB_SVPD_CST_SV_EXCN_IZ SV2 /*고객서비스수행내역*/
        		           ON SV2.CNTR_NO = SUBSTR(FN_SVPD_WELSF_CD_01(SV1.CNTR_NO, SV1.CNTR_SN),1,12)
        		          AND SV2.CNTR_SN = SUBSTR(FN_SVPD_WELSF_CD_01(SV1.CNTR_NO, SV1.CNTR_SN),13,14)
        		        INNER JOIN TB_PDBS_PD_BAS P1 /*상품기본*/
        		           ON SV2.PDCT_PD_CD = P1.PD_CD
        		        INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL P2 /*상품각사속성상세*/
        		           ON P1.PD_CD = P2.PD_CD
        		          AND P2.DTA_DL_YN = 'N'
        		          AND P2.PD_EXTS_PRP_GRP_CD = 'PART'
        		        INNER JOIN TB_SSCT_CNTR_REL SC1 /*계약관계*/
        		           ON SV2.CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SV2.CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		        INNER JOIN TB_SSCT_CNTR_ADR_REL SA1 /*계약주소관계 - 계약주소*/
        		           ON SA1.DTL_CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SA1.DTL_CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		          AND SA1.ADRPC_TP_CD IN ('2', '3')
        		          AND SA1.DTA_DL_YN = 'N'
        		          AND SA1.VL_STRT_DTM = SC1.VL_STRT_DTM
        		          AND SA1.VL_END_DTM = SC1.VL_END_DTM
        		        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS SA2 /*계약주소지기본*/
        		           ON SA2.CNTR_ADRPC_ID = SA1.CNTR_ADRPC_ID
        		        INNER JOIN TB_GBCO_ADR_BAS ADR /*주소기본*/
        		           ON ADR.ADR_ID = SA2.ADR_ID
        		        INNER JOIN TB_SSCT_CNTR_REL SC2 /*계약관계*/
        		           ON SC2.BASE_DTL_CNTR_NO = SV1.CNTR_NO
        		          AND SC2.BASE_DTL_CNTR_SN = SV1.CNTR_SN
        		        INNER JOIN T
        		           ON SC2.BASE_DTL_CNTR_NO = SUBSTR(T.D_CNTR_NO, 1, 12)
        		          AND SC2.BASE_DTL_CNTR_NO = SUBSTR(T.D_CNTR_NO, 13, 1)
        		        WHERE P2.PD_PRP_VAL19 = '4'
        		          AND P1.PD_NM LIKE '%새싹재배기%'
        		          AND SC2.CNTR_REL_DTL_CD = '22W'
        		        UNION ALL
        		       /*그외*/
        		       SELECT (CASE WHEN P1.PD_NM LIKE '%새싹씨앗%' THEN '새싹씨앗'
        		                   WHEN P1.PD_NM LIKE '%새싹%' THEN '새싹재배기'
        		                   ELSE F_CMZ_CD_NM('TNT_WELLS', 'PD_GRP_CD', P2.PD_PRP_VAL20, 'ko')
        		               END) AS GUBUN /*구분*/
        		            , SV1.CNTR_NO || '-' || SV1.CNTR_SN AS CNTR_DTL /*계약상세번호*/
        		            , SA2.RCGVP_KNM AS CST_NM /*고객명*/
        		            , P1.PD_NM /*상품명*/
        		            , SC2.BASE_DTL_CNTR_NO ||'-'||SC2.BASE_DTL_CNTR_SN AS SDING_CNTR_DTL /*상대고객*/
        		            , NVL(ADR.NEW_ADR_ZIP, ADR.OLD_ADR_ZIP) AS ADR_ZIP /*우편번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.LOCARA_TNO, '') AS LOCARA_TNO /*전화번호 - 지역전화번호*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.EXNO_ENCR, '') AS EXNO_ENCR/*전화번호 - 전화국번호암호화*/
        		            , NVL2(SA2.LOCARA_TNO, SA2.IDV_TNO, '') AS IDV_TNO/*전화번호 - 개별전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_LOCARA_TNO, '') AS CRAL_LOCARA_TNO /*휴대전화번호 - 휴대지역전화번호*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.MEXNO_ENCR, '') AS MEXNO_ENCR /*휴대전화번호 - 휴대전화국번호암호화*/
        		            , NVL2(SA2.CRAL_LOCARA_TNO, SA2.CRAL_IDV_TNO, '') AS CRAL_IDV_TNO /*휴대전화번호 - 휴대개별전화번호*/
        		         FROM TB_SVPD_CST_SV_EXCN_IZ SV1 /*고객서비스수행내역*/
        		        INNER JOIN TB_PDBS_PD_BAS P1 /*상품기본*/
        		           ON SV1.PDCT_PD_CD = P1.PD_CD
        		        INNER JOIN TB_PDBS_PD_ECOM_PRP_DTL P2 /*상품각사속성상세*/
        		           ON P1.PD_CD = P2.PD_CD
        		          AND P2.DTA_DL_YN = 'N'
        		          AND P2.PD_EXTS_PRP_GRP_CD = 'PART'
        		        INNER JOIN TB_SSCT_CNTR_REL SC1 /*계약관계*/
        		           ON SV1.CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SV1.CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		        INNER JOIN TB_SSCT_CNTR_ADR_REL SA1 /*계약주소관계 - 계약주소*/
        		           ON SA1.DTL_CNTR_NO = SC1.BASE_DTL_CNTR_NO
        		          AND SA1.DTL_CNTR_SN = SC1.BASE_DTL_CNTR_SN
        		          AND SA1.ADRPC_TP_CD IN ('2', '3')
        		          AND SA1.DTA_DL_YN = 'N'
        		          AND SA1.VL_STRT_DTM = SC1.VL_STRT_DTM
        		          AND SA1.VL_END_DTM = SC1.VL_END_DTM
        		        INNER JOIN TB_SSCT_CNTR_ADRPC_BAS SA2 /*계약주소지기본*/
        		           ON SA2.CNTR_ADRPC_ID = SA1.CNTR_ADRPC_ID
        		        INNER JOIN TB_GBCO_ADR_BAS ADR /*주소기본*/
        		           ON ADR.ADR_ID = SA2.ADR_ID
        		        INNER JOIN TB_SSCT_CNTR_REL SC2 /*계약관계*/
        		           ON SC2.OJ_DTL_CNTR_NO = SV1.CNTR_NO
        		          AND SC2.OJ_DTL_CNTR_SN = SV1.CNTR_SN
        		        WHERE 1=1
        		          AND SC2.BASE_DTL_CNTR_NO = #{cntrNo}
        		          AND SC2.BASE_DTL_CNTR_SN = #{cntrSn}
                  )
             ORDER BY GUBUN
          )
        ORDER BY CNTR_DTL
    </select>

    <select id="selectIndividualCounsel" resultType="com.kyowon.sms.wells.web.service.visit.dto.WsnbIndividualServicePsDto$SearchCounselRes">
        SELECT (SELECT X.CD_VAL_NM
                  FROM CCSDBS.TB_CODE X
                 WHERE X.CDSET_ID='CSEL_STS_CD'
                   AND X.USE_FG='Y'
                   AND X.CD_VAL = CC.CSEL_STS_CD) AS CSEL_STS /*처리상태*/
             , CC.CNSL_DT  AS CNSL_ST_DT /*접수일자*/
             , CC.CNSL_ED_DT AS CNSL_ED_DT /*처리일자*/
             , (SELECT X.CNSL_TP_HCSF_CD_NM
                  FROM CCSDBS.TB_CLASS_A X
                 WHERE X.CNSL_TP_HCSF_CD = CC.CNSL_TP_HCSF_CD
                   AND X.JOB_CD = CC.JOB_CD) AS CNSL_TP_HCSF_CD /*상담분류(대)*/
             , (SELECT X.CNSL_TP_MCSF_CD_NM
                  FROM CCSDBS.TB_CLASS_B X
                 WHERE X.CNSL_TP_HCSF_CD = CC.CNSL_TP_HCSF_CD
                   AND X.CNSL_TP_MCSF_CD = CC.CNSL_TP_MCSF_CD
                   AND X.JOB_CD = CC.JOB_CD) AS CNSL_TP_MCSF_CD /*상담분류(중)*/
             , (SELECT X.CNSL_TP_LCSF_CD_NM
                  FROM CCSDBS.TB_CLASS_C X
                 WHERE X.CNSL_TP_HCSF_CD = CC.CNSL_TP_HCSF_CD
                   AND X.CNSL_TP_MCSF_CD = CC.CNSL_TP_MCSF_CD
                   AND X.CNSL_TP_LCSF_CD = CC.CNSL_TP_LCSF_CD
                   AND X.JOB_CD = CC.JOB_CD ) AS CNSL_TP_LCSF_CD /*상담분류(소)*/
             , (SELECT X.USER_NM
                  FROM CCSDBS.TB_USER X
                 WHERE X.USER_ID = CC.MOD_USER_ID) AS PCP_NM /*처리자*/
             , (SELECT X.CD_VAL_NM
                  FROM CCSDBS.TB_CODE X
                 WHERE X.CDSET_ID='CSEL_RST_CD'
                   AND X.USE_FG='Y'
                   AND X.CD_VAL = CC.CSEL_RST_CD) AS CSEL_RST_CD /*처리구분*/
             , (SELECT X.CD_VAL_NM
                  FROM CCSDBS.TB_CODE X
                 WHERE X.CDSET_ID='CUST_RESP_CD'
                   AND X.USE_FG='Y'
                   AND X.CD_VAL = CC.CUST_RESP_CD) AS CUST_RESP /*고객반응*/
             , (SELECT X.CD_VAL_NM
                  FROM CCSDBS.TB_CODE X
                 WHERE X.CDSET_ID='CLNT_DV_CD'
                   AND X.USE_FG='Y'
                   AND X.CD_VAL = CC.CLNT_DV_CD) AS CLNT_DV_NM /*의뢰자*/
             , CNSL_CN /*상담내용*/
          FROM CCSDBS.TB_WELLS_COUNSEL CC
         WHERE 1=1
           AND CNTR_NO = #{cntrNo}
           AND CNTR_SN = #{cntrSn}
         ORDER BY CC.CNSL_DT DESC
    </select>

    <select id="selectIndividualDelinquent" resultType="com.kyowon.sms.wells.web.service.visit.dto.WsnbIndividualServicePsDto$SearchDelinquentRes">
        SELECT TA.PSUMINAMT /*입금액(전월)*/
             , TB.CSUMINAMT /*입금액(당월)*/
             , TA.PSUMINAMT+TB.CSUMINAMT AS TSUMINAMT /*입금액(합계)*/
             , TC.PDLYAMT AS PDLYAMT /*연체금액(전월)*/
             , TC.CDLYAMT AS CDLYAMT /*연체금액(당월)*/
             , TC.TLCMAMT AS TDLYAMT /*연체금액(합계)*/
          FROM (SELECT COALESCE(SUM(CASE WHEN DP_DV_CD = '1' THEN RVE_AMT ELSE -RVE_AMT END), 0) PSUMINAMT
                  FROM TB_RVDW_RVE_DTL /*수납상세 KWMART.LC3300P*/
                 WHERE 1=1
                   AND CNTR_NO = #{cntrNo}
                   AND CNTR_SN = #{cntrSn}
                   AND SUBSTR(RVE_DT,1,6) = TO_NUMBER(TO_CHAR(ADD_MONTHS(SYSDATE, -1), 'YYYYMM'))
                   AND RVE_DV_CD = '03' /*월납입액(할부금, 렌탈료)*/
               ) TA,
               (SELECT COALESCE(SUM(CASE WHEN DP_DV_CD = '1' THEN RVE_AMT ELSE -RVE_AMT END), 0) CSUMINAMT
                  FROM TB_RVDW_RVE_DTL /*수납상세 KWMART.LC3300P*/
                 WHERE 1=1
                   AND CNTR_NO = #{cntrNo}
                   AND CNTR_SN = #{cntrSn}
                   AND SUBSTR(RVE_DT,1,6) = TO_NUMBER(TO_CHAR(SYSDATE, 'YYYYYMM'))
                   AND RVE_DV_CD = '03' /*월납입액(할부금, 렌탈료)*/
               ) TB,
               (SELECT COALESCE(SUM(BTD_DLQ_AMT), 0) PDLYAMT
                     , COALESCE(SUM(THM_OC_DLQ_AMT-THM_DLQ_DP_SUM_AMT+THM_DLQ_RFND_SUM_AMT), 0) CDLYAMT
                     , COALESCE(SUM(EOT_DLQ_AMT), 0) TLCMAMT
                  FROM TB_CBCL_DLQ_BAS /**연체기본 KWMART.LC5000P*/
                 WHERE 1=1
                   AND CNTR_NO = #{cntrNo}
                   AND CNTR_SN = #{cntrSn}
                   AND PERF_YM = TO_NUMBER(TO_CHAR(SYSDATE, 'YYYYYMM'))
               ) TC
    </select>

    <insert id="insertUnusualItem">
      INSERT INTO TB_SVPD_CNTR_CST_UNUITM_DTL (
             CNTR_NO
           , CNTR_SN
           , DTL_SN
           , OG_TP_CD
           , WK_PRTNR_NO
           , CST_UNUITM_CN
           <include refid="COMMON.insertSystemField"/>
      )VALUES (
          #{cntrNo}
        , #{cntrSn}
        , (SELECT NVL(MAX(DTL_SN), 0) +1
             FROM TB_SVPD_CNTR_CST_UNUITM_DTL
            WHERE CNTR_NO = #{cntrNo}
              AND CNTR_SN = #{cntrSn}
          )
        , #{ogTpCd}
        , #{wkPrtnrNo}
        , #{cstUnuitmCn}
        <include refid="COMMON.insertSystemFieldValue"/>
      )
    </insert>
</mapper>
