<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kyowon.sms.wells.web.service.visit.mapper.WsnbVisitGuideSmsMapper">

    <select id="selectCustomers" resultType="com.kyowon.sms.wells.web.service.visit.dvo.WsnbVisitGuideSmsDvo">
        <![CDATA[
        WITH TEMP1 AS (
            SELECT V1.CST_SV_ASN_NO
                 , V1.CNTR_NO
                 , V1.ISTLL_KNM
                 , V1.CRAL_LOCARA_TNO
                 , V1.MEXNO_ENCR
                 , V1.CRAL_IDV_TNO
                 , V1.VST_CNFMDT
                 , V1.VST_CNFM_HH
                 , V1.WK_PRTNR_NO
                 , V1.PD_CD
                 , V1.T_CNT
                 , V1.VST_RN
              FROM (SELECT T1.CST_SV_ASN_NO /* 고객서비스배정번호 */
                         , T1.CNTR_NO /* 계약번호 */
                         , T1.CNTR_SN /* 계약일련번호 */
                         , (CASE WHEN T1.ISTLL_KNM IS NULL THEN C1.RCGVP_KNM
                                 ELSE T1.ISTLL_KNM
                            END) AS ISTLL_KNM /* 설치자한글명 */
                         , C1.CRAL_LOCARA_TNO /* 휴대지역전화번호 */
                         , C1.MEXNO_ENCR /* 휴대전화국번호암호화 */
                         , C1.CRAL_IDV_TNO /* 휴대개별전화번호 */
                         , T2.VST_CNFMDT /* 방문확정일자 */
                         , T2.VST_CNFM_HH /* 방문확정시간 */
                         , T2.WK_PRTNR_NO /* 작업파트너번호 */
                         , T1.PD_CD /* 상품코드 */
                         , COUNT(1) OVER (PARTITION BY T1.ISTLL_KNM, (C1.CRAL_LOCARA_TNO || C1.MEXNO_ENCR || C1.CRAL_IDV_TNO), T2.VST_CNFMDT) AS T_CNT
                         , RANK() OVER (PARTITION BY T1.ISTLL_KNM, (C1.CRAL_LOCARA_TNO || C1.MEXNO_ENCR || C1.CRAL_IDV_TNO), T2.VST_CNFMDT ORDER BY T2.VST_CNFMDT, T2.VST_CNFM_HH, T2.WK_PRTNR_NO, T1.CNTR_NO ASC) AS VST_RN
                      FROM TB_SVPD_CST_SVAS_IST_OJ_IZ T1 /* 고객서비스AS설치대상내역 */
                     INNER JOIN (SELECT V1.DTL_CNTR_NO, V1.DTL_CNTR_SN, TRIM(V2.RCGVP_KNM) AS RCGVP_KNM, V2.CRAL_LOCARA_TNO, V2.MEXNO_ENCR, V2.CRAL_IDV_TNO
                                   FROM TB_SSCT_CNTR_ADR_REL V1 /* 계약주소관계 */
                                  INNER JOIN TB_SSCT_CNTR_ADRPC_BAS V2 /* 계약주소지기본 */
                                     ON V2.CNTR_ADRPC_ID = V1.CNTR_ADRPC_ID
                                    AND V2.DTA_DL_YN = 'N'
                                  WHERE V1.DTA_DL_YN = 'N'
                                    AND V1.ADRPC_TP_CD = '3' /* 설치처 */
                                    AND V1.VL_STRT_DTM <= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                                    AND V1.VL_END_DTM >= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                         ) C1
                        ON C1.DTL_CNTR_NO = T1.CNTR_NO
                       AND C1.DTL_CNTR_SN = T1.CNTR_SN
                     INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ T2 /* 고객서비스AS설치배정내역 */
                        ON T2.CST_SV_ASN_NO = T1.CST_SV_ASN_NO
                       AND T2.DTA_DL_YN = 'N'
                     INNER JOIN TB_OGBS_MM_PRTNR_IZ T3 /* 월파트너내역 */
                        ON T3.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                       AND T3.OG_TP_CD = T1.RCP_OG_TP_CD
                       AND T3.PRTNR_NO = T1.RCP_ICHR_PRTNR_NO
                       AND T3.DTA_DL_YN = 'N'
                     WHERE 1 = 1
                       /* A/S 발송 상세서비스유형
                          [3110 제품A/S, 3310 분리, 3320 재설치, 3121 필터B/S, 3330 위치변경, 3311 자사이동_분리, 3321 자사이동_재설치]
                          그 외 업무 유형은 알림톡 발송 X, 동일 제품 동시 방문(분리 재설치)은 1건만 발송 */
                       AND T1.SV_BIZ_DCLSF_CD IN ('3110','3310','3320','3121','3330','3311','3321')
                       AND T2.VST_CNFMDT = TO_CHAR(SYSDATE + 1, 'YYYYMMDD')  /* 익일 AS, 설치 배정 건 알림톡 발송 */
                       AND T1.RCPDT != TO_CHAR(SYSDATE, 'YYYYMMDD') /* 알림톡 발송 당일 AS, 설치 접수(배정)건 발송 X */
                       AND ((T1.IN_CHNL_DV_CD = '1' AND T3.OG_CD = '71309') OR (T1.IN_CHNL_DV_CD != '1')) /* 접수채널이 고객센터일 경우 Wells상담파트만, 그외 모든 채널 */
                       AND T2.WK_PRTNR_NO NOT IN ('99010', '99020') /* 성우메디텍, BMB 제외 */
                       AND T2.WK_PRGS_STAT_CD IN ('00')
                       AND C1.CRAL_LOCARA_TNO IS NOT NULL
                       AND C1.MEXNO_ENCR IS NOT NULL
                       AND C1.CRAL_IDV_TNO IS NOT NULL
                       AND T2.VST_CNFM_HH >= '090000'
                       AND T2.VST_DUEDT = T2.VST_CNFMDT /* 21.06.17 정희은매니저님요청, 최초 약속된 시간이 변경 되지 않은 경우만 대상 */
                     UNION ALL
                    SELECT T1.CST_SV_ASN_NO /* 고객서비스배정번호 */
                         , T1.CNTR_NO /* 계약번호 */
                         , T1.CNTR_SN /* 계약일련번호 */
                         , (CASE WHEN T1.ISTLL_KNM IS NULL THEN C1.RCGVP_KNM
                                 ELSE T1.ISTLL_KNM
                            END) AS ISTLL_KNM /* 설치자한글명 */
                         , C1.CRAL_LOCARA_TNO /* 휴대지역전화번호 */
                         , C1.MEXNO_ENCR /* 휴대전화국번호암호화 */
                         , C1.CRAL_IDV_TNO /* 휴대개별전화번호 */
                         , T2.VST_CNFMDT /* 방문확정일자 */
                         , T2.VST_CNFM_HH /* 방문확정시간 */
                         , T2.WK_PRTNR_NO /* 작업파트너번호 */
                         , T1.PD_CD /* 상품코드 */
                         , COUNT(1) OVER (PARTITION BY T1.ISTLL_KNM, (C1.CRAL_LOCARA_TNO || C1.MEXNO_ENCR || C1.CRAL_IDV_TNO), T2.VST_CNFMDT) AS T_CNT
                         , RANK() OVER (PARTITION BY T1.ISTLL_KNM, (C1.CRAL_LOCARA_TNO || C1.MEXNO_ENCR || C1.CRAL_IDV_TNO), T2.VST_CNFMDT ORDER BY T2.VST_CNFMDT, T2.VST_CNFM_HH, T2.WK_PRTNR_NO, T1.CNTR_NO ASC) AS VST_RN
                      FROM TB_SVPD_CST_SVAS_IST_OJ_IZ T1 /* 고객서비스AS설치대상내역 */
                     INNER JOIN (SELECT V1.DTL_CNTR_NO, V1.DTL_CNTR_SN, TRIM(V2.RCGVP_KNM) AS RCGVP_KNM, V2.CRAL_LOCARA_TNO, V2.MEXNO_ENCR, V2.CRAL_IDV_TNO
                                   FROM TB_SSCT_CNTR_ADR_REL V1 /* 계약주소관계 */
                                  INNER JOIN TB_SSCT_CNTR_ADRPC_BAS V2 /* 계약주소지기본 */
                                     ON V2.CNTR_ADRPC_ID = V1.CNTR_ADRPC_ID
                                    AND V2.DTA_DL_YN = 'N'
                                  WHERE V1.DTA_DL_YN = 'N'
                                    AND V1.ADRPC_TP_CD = '3' /* 설치처 */
                                    AND V1.VL_STRT_DTM <= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                                    AND V1.VL_END_DTM >= TO_CHAR(SYSDATE, 'YYYYMMDDHH24MISS')
                         ) C1
                        ON C1.DTL_CNTR_NO = T1.CNTR_NO
                       AND C1.DTL_CNTR_SN = T1.CNTR_SN
                     INNER JOIN TB_SVPD_CST_SVAS_IST_ASN_IZ T2 /* 고객서비스AS설치배정내역 */
                        ON T2.CST_SV_ASN_NO = T1.CST_SV_ASN_NO
                       AND T2.DTA_DL_YN = 'N'
                     INNER JOIN TB_OGBS_MM_PRTNR_IZ T3 /* 월파트너내역 */
                        ON T3.BASE_YM = TO_CHAR(SYSDATE, 'YYYYMM')
                       AND T3.OG_TP_CD = T1.RCP_OG_TP_CD
                       AND T3.PRTNR_NO = T1.RCP_ICHR_PRTNR_NO
                       AND T3.DTA_DL_YN = 'N'
                     WHERE 1 = 1
                       AND T1.SV_BIZ_DCLSF_CD LIKE '11%' /* 설치 - 필터판매(방문) 제외 13% */
                       AND T1.PD_CD NOT LIKE '60%' /* 웰스팜 모종 제외 */
                       AND T2.VST_CNFMDT = TO_CHAR(SYSDATE + 1, 'YYYYMMDD') /* 익일 AS, 설치 배정 건 알림톡 발송 */
                       AND T1.RCPDT != TO_CHAR(SYSDATE, 'YYYYMMDD') /* 알림톡 발송 당일 AS, 설치 접수(배정)건 발송 X */
                       AND T2.WK_PRTNR_NO NOT IN ('99010', '99020') /* 성우메디텍, BMB 제외 */
                       AND T2.WK_PRGS_STAT_CD IN ('00')
                       AND C1.CRAL_LOCARA_TNO IS NOT NULL
                       AND C1.MEXNO_ENCR IS NOT NULL
                       AND C1.CRAL_IDV_TNO IS NOT NULL
                       AND T2.VST_CNFM_HH >= '090000'
                       AND T2.VST_DUEDT = T2.VST_CNFMDT /* 21.06.17 정희은매니저님요청, 최초 약속된 시간이 변경 되지 않은 경우만 대상 */
                  ) V1
            WHERE 1 = 1
            ORDER BY V1.ISTLL_KNM, V1.VST_RN, V1.CST_SV_ASN_NO
        ), TEMP2 AS (
            SELECT V1.VST_CNFMDT
                 , V1.VST_CNFM_HH
                 , V1.CRAL_LOCARA_TNO
                 , V1.MEXNO_ENCR
                 , V1.CRAL_IDV_TNO
                 , V1.ISTLL_KNM
                 , V1.WK_PRTNR_NO AS USER_ID
                 , V1.PD_NM
                 , (CASE WHEN SUBSTR(V1.CST_SV_ASN_NO, 1, 1) = '1' AND TO_CHAR(SYSDATE, 'YYYYMMDD') < '20210621' THEN 'TMP_SNB_WELLS18084' --'Wells18084'  --Wells18056 /*21.06.17 정희은매니저님요청 템플릿 변경*/
                         WHEN SUBSTR(V1.CST_SV_ASN_NO, 1, 1) = '1' AND TO_CHAR(SYSDATE, 'YYYYMMDD') >= '20210621' THEN 'TMP_SNB_WELLS18106' --'Wells18084'  --Wells18056 /*21.06.17 정희은매니저님요청 템플릿 변경*/
                         WHEN SUBSTR(V1.CST_SV_ASN_NO, 1, 1) = '3' AND TO_CHAR(SYSDATE, 'YYYYMMDD') < '20210621' THEN 'TMP_SNB_WELLS18086' --'Wells18086'  --Wells18055 /*21.06.17 정희은매니저님요청 템플릿 변경*/
                         WHEN SUBSTR(V1.CST_SV_ASN_NO, 1, 1) = '3' AND TO_CHAR(SYSDATE, 'YYYYMMDD') >= '20210621' AND TO_CHAR(SYSDATE, 'YYYYMMDD') <'20210816' THEN 'TMP_SNB_WELLS18105' --'Wells18086'  --Wells18055 /*21.06.17 정희은매니저님요청 템플릿 변경*/
                         WHEN SUBSTR(V1.CST_SV_ASN_NO, 1, 1) = '3' AND TO_CHAR(SYSDATE, 'YYYYMMDD') >= '20210816' THEN 'TMP_SNB_WELLS_18135' --'Wells18105'  --Wells18135 /*21.08.12 정희은매니저님요청 템플릿 변경*/
                     END) AS TEMPLATE_ID
                 , V1.CST_SV_ASN_NO
              FROM (
                    SELECT T1.CST_SV_ASN_NO
                         , T1.ISTLL_KNM
                         , T1.CRAL_LOCARA_TNO
                         , T1.MEXNO_ENCR
                         , T1.CRAL_IDV_TNO
                         , T1.VST_CNFMDT
                         , (SELECT E1.VST_CNFM_HH
                              FROM TEMP1 E1
                             WHERE E1.VST_RN = 1
                               AND E1.ISTLL_KNM = T1.ISTLL_KNM
                               AND E1.CRAL_LOCARA_TNO = T1.CRAL_LOCARA_TNO
                               AND E1.MEXNO_ENCR = T1.MEXNO_ENCR
                               AND E1.CRAL_IDV_TNO = T1.CRAL_IDV_TNO
                               AND E1.VST_CNFMDT = T1.VST_CNFMDT
                               AND ROWNUM = 1) AS VST_CNFM_HH /* 해당일 첫번째 방문 시간 */
                         , (SELECT E1.WK_PRTNR_NO
                              FROM TEMP1 E1
                             WHERE E1.VST_RN = 1
                               AND E1.ISTLL_KNM = T1.ISTLL_KNM
                               AND E1.CRAL_LOCARA_TNO = T1.CRAL_LOCARA_TNO
                               AND E1.MEXNO_ENCR = T1.MEXNO_ENCR
                               AND E1.CRAL_IDV_TNO = T1.CRAL_IDV_TNO
                               AND E1.VST_CNFMDT = T1.VST_CNFMDT
                               AND ROWNUM = 1) AS WK_PRTNR_NO /* 해당일 첫번째 방문의 담당자 */
                         , MAX(T_CNT) AS M_T_CNT
                         , (SELECT REPLACE(REGEXP_REPLACE(LISTAGG(S1.PD_NM, ',')
                                   WITHIN GROUP (ORDER BY (CASE WHEN S1.PD_CD LIKE '42%' THEN '1'
                                                                WHEN S1.PD_CD LIKE '43%' THEN '2'
                                                                WHEN S1.PD_CD LIKE '41%' THEN '3'
                                                                WHEN S1.PD_CD LIKE '44%' THEN '4'
                                                                ELSE '5'
                                                           END) ASC, E1.CST_SV_ASN_NO), '([^,]+)(,\1)*(,|$)', '\1\3')
                                   , ','
                                   , CHR(10))
                              FROM TEMP1 E1
                             INNER JOIN TB_PDBS_PD_BAS S1 /* 상품기본 */
                                ON E1.PD_CD = S1.PD_CD
                             WHERE 1 = 1
                               AND E1.ISTLL_KNM = T1.ISTLL_KNM
                               AND E1.CRAL_LOCARA_TNO = T1.CRAL_LOCARA_TNO
                               AND E1.MEXNO_ENCR = T1.MEXNO_ENCR
                               AND E1.CRAL_IDV_TNO = T1.CRAL_IDV_TNO
                               AND E1.VST_CNFMDT = T1.VST_CNFMDT) AS PD_NM
                         , (SELECT REGEXP_REPLACE(LISTAGG(E1.CST_SV_ASN_NO, ',')
                                   WITHIN GROUP (ORDER BY (CASE WHEN E1.PD_CD LIKE '42%' THEN '1'
                                                                WHEN E1.PD_CD LIKE '43%' THEN '2'
                                                                WHEN E1.PD_CD LIKE '41%' THEN '3'
                                                                WHEN E1.PD_CD LIKE '44%' THEN '4'
                                                                ELSE '5'
                                                           END) ASC, E1.CST_SV_ASN_NO), '([^,]+)(,\1)*(,|$)', '\1\3')
                              FROM TEMP1 E1
                             WHERE 1 = 1
                               AND E1.ISTLL_KNM = T1.ISTLL_KNM
                               AND E1.CRAL_LOCARA_TNO = T1.CRAL_LOCARA_TNO
                               AND E1.MEXNO_ENCR = T1.MEXNO_ENCR
                               AND E1.CRAL_IDV_TNO = T1.CRAL_IDV_TNO
                               AND E1.VST_CNFMDT = T1.VST_CNFMDT) AS CST_SV_ASN_NO_LIST
                      FROM TEMP1 T1
                     GROUP BY T1.CST_SV_ASN_NO, T1.ISTLL_KNM, T1.CRAL_LOCARA_TNO, T1.MEXNO_ENCR, T1.CRAL_IDV_TNO, T1.VST_CNFMDT
                     ORDER BY T1.ISTLL_KNM
                    ) V1
        )
        SELECT DISTINCT
               T2.VST_CNFMDT
             , T2.VST_CNFM_HH
             , T2.ISTLL_KNM
             , T2.CRAL_LOCARA_TNO
             , T2.MEXNO_ENCR
             , T2.CRAL_IDV_TNO
             , T2.PD_NM
             , '[웰스] 엔지니어 방문 안내' AS SUBJECT
             , T2.TEMPLATE_ID
             , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') AS NOW_DATE
             , TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') AS SEND_DATETIME
             , T2.USER_ID
             , '15884113' AS CALLBACK
          FROM TEMP2 T2
         WHERE 1 = 1
         ]]>
    </select>

</mapper>
